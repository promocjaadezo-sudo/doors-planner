<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Worker split — szybki widok</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:12px}
.card{background:#1f2937;padding:12px;border-radius:10px;margin-bottom:12px}
.row{display:flex;justify-content:space-between;align-items:center}
.btn{border:0;padding:6px 10px;border-radius:8px;background:#334155;color:#e5e7eb;cursor:pointer}
.btn.green{background:#16a34a}
.btn.gray{background:#475569}
.table{max-height:55vh;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #223044;padding:6px;text-align:left}
.muted{color:#94a3b8;font-size:13px}
.status-text{display:inline-block}
.sync-badge{display:inline-block;min-width:1em;margin-left:6px;font-size:12px;opacity:.95}
.sync-badge.pending{color:#d97706}
.sync-badge.error{color:#dc2626}
.sync-badge.ok{color:#16a34a}
select,input{background:#0b1222;border:1px solid #223044;color:#e5e7eb;border-radius:8px;padding:6px}
</style>
</head>
<body>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
    <h2 style="margin:0">Listy pracowników (szybki tryb)</h2>
    <div class="row" style="gap:8px">
      <label class="muted" for="flt-status">Status</label>
      <select id="flt-status"><option value="">Wszystkie</option><option value="todo">todo</option><option value="run">run</option><option value="done">done</option></select>
      <button id="export-all" class="btn">Eksport wszyscy (CSV)</button>
      <button id="reload" class="btn">Przeładuj z localStorage</button>
    </div>
  </div>
  <div id="container"></div>
<script>
(function(){
  const uid = ()=>Math.random().toString(36).slice(2,10);
  const storeKey='door_v5627_state';
  let state = {employees:[],orders:[],processes:[],tasks:[]};
  let filterStatus = '';
  function load(){ try{ const raw=localStorage.getItem(storeKey); if(raw) Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn('load err',e); } }
  function save(){ try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(e){ console.warn('save err',e); } }
  function q(s){ return document.querySelector(s); }
  function render(){ const container = q('#container'); container.innerHTML=''; const empLookup = new Map((state.employees||[]).map(e=>[e.id,e]));
    // build map: empId -> tasks
    const map = new Map();
    (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ const aid = op.assignee && (op.assignee.id || op.assignee); if(aid){ if(!map.has(aid)) map.set(aid,[]); map.get(aid).push({id:'',orderId:null,opName:op.name,estMin:op.time||0,_synth:true,procName:proc.name}); } }); });
    (state.tasks||[]).forEach(t=>{ const as = t.assignees || (t.assignee? [t.assignee]:[]); if(Array.isArray(as)) as.forEach(a=>{ const id = a.id||a; if(!map.has(id)) map.set(id,[]); map.get(id).push(Object.assign({}, t)); }); });
    if(map.size===0){ container.innerHTML='<div class="muted card">Brak przypisań</div>'; return; }
    Array.from(map.entries()).forEach(([empId,tasks])=>{
      const emp = (state.employees||[]).find(e=>e.id===empId) || {id:empId,name:empId};
      const tasksFiltered = tasks.filter(t=>{ const st=(t.status||'todo'); return !filterStatus || st===filterStatus; });
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="row"><div><b>${emp.name}</b><div class="muted">Zadań: ${tasksFiltered.length} ${filterStatus?`(filtr: ${filterStatus})`:''}</div></div><div><button class="btn" data-export-emp="${empId}">CSV</button> <button class="btn" data-send-emp="${empId}">Wyślij</button></div></div>`;
      const tblWrap = document.createElement('div'); tblWrap.className='table';
      const tbl = document.createElement('table'); tbl.innerHTML='<thead><tr><th>Nr zlecenia</th><th>Operacja</th><th>Status</th><th>Akcje</th></tr></thead><tbody></tbody>';
      const tbody = tbl.querySelector('tbody');
      if(tasksFiltered.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4"><span class="muted">Brak zadań dla wybranego filtra</span></td>'; tbody.appendChild(tr); }
      tasksFiltered.forEach(t=>{
        const tr = document.createElement('tr');
        const orderName = t.orderId ? (state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId : (t._synth? (t.procName || '(proces)') : '(brak)');
        const status = t.status || 'todo';
        const id = t.id || '';
        const startDisabled = (status==='run' || !id) ? 'disabled' : '';
        const doneDisabled = (status==='done' || !id) ? 'disabled' : '';
        tr.dataset.taskId = id;
        const syncSym = t._syncPending ? '⏳' : (t._syncError ? '⚠️' : (t._lastSync ? '✔️' : ''));
        const syncTitle = t._syncPending ? 'Zapisywanie…' : (t._syncError ? 'Błąd zapisu' : (t._lastSync ? 'Zapisano (lokalnie)' : ''));
        const syncClass = t._syncPending ? 'sync-badge pending' : (t._syncError ? 'sync-badge error' : (t._lastSync ? 'sync-badge ok' : 'sync-badge'));
        tr.innerHTML = `<td>${orderName}</td><td>${t.opName}</td><td class="status"><span class="status-text">${status}</span> <span class="${syncClass}" title="${syncTitle}">${syncSym}</span></td><td>
          <button class="btn start ${status==='run'?'green':'gray'}" data-task-start="${id}">${status==='run'?'W toku':'Start'}</button>
          <button class="btn done ${status==='done'?'green':'gray'}" data-task-done="${id}">Zamknij</button>
        </td>`;
        tbody.appendChild(tr);
      });
      tblWrap.appendChild(tbl); card.appendChild(tblWrap); container.appendChild(card);
    });
  }
  function buildEmployeeText(empId){ const emp=(state.employees||[]).find(e=>e.id===empId)||{id:empId,name:empId}; const rows=[]; (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ const aid = op.assignee && (op.assignee.id || op.assignee); if(aid===empId){ rows.push({opName:op.name, orderName:proc.name, time:op.time||0}); } }); }); (state.tasks||[]).forEach(t=>{ const as=t.assignees || (t.assignee? [t.assignee]:[]); if(Array.isArray(as) && as.some(a=> (a.id||a)===empId)){ const orderName=(state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId || '(proces)'; rows.push({opName:t.opName, orderName, time:t.estMin||t.elapsedMin||0}); } }); if(rows.length===0) return `Brak zadań przypisanych do ${emp.name}.`; const lines=[`Zadania dla: ${emp.name}`, `Data: ${new Date().toISOString().slice(0,10)}`, '---']; rows.forEach((r,i)=>lines.push(`${i+1}. ${r.opName} — ${r.orderName} — ${r.time}m`)); lines.push('---'); lines.push('Powodzenia!'); return lines.join('\n'); }
  function copyToClipboard(text){ if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text); return new Promise((res,rej)=>{ try{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); res(); }catch(e){ rej(e); } }); }
  function exportCSVForEmployee(empId){ const emp=(state.employees||[]).find(e=>e.id===empId)||{id:empId,name:empId}; const rows=[]; (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ const aid=op.assignee && (op.assignee.id || op.assignee); if(aid===empId){ rows.push({employee:emp.name, process:proc.name, opName:op.name, time:op.time||0}); } }); }); (state.tasks||[]).forEach(t=>{ const as=t.assignees || (t.assignee? [t.assignee]:[]); if(Array.isArray(as) && as.some(a=> (a.id||a)===empId)){ rows.push({employee:emp.name, process:(state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId, opName:t.opName, time:t.estMin||t.elapsedMin||0}); } }); if(rows.length===0){ alert('Brak zadań dla '+emp.name); return; } const csv=['employee,process,operation,timeMin'].concat(rows.map(r=>`"${(r.employee||'').replace(/"/g,'""')}","${(r.process||'').replace(/"/g,'""')}","${(r.opName||'').replace(/"/g,'""')}",${r.time||0}`)).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tasks_'+(emp.name||empId).replace(/\s+/g,'_')+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  function exportCSVAllByWorker(){ const map=new Map(); const empLookup=new Map((state.employees||[]).map(e=>[e.id,e])); (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ const aid=op.assignee && (op.assignee.id || op.assignee); if(aid){ const name=(empLookup.get(aid)||{}).name || aid; if(!map.has(aid)) map.set(aid,[]); map.get(aid).push({employee:name, process:proc.name, opName:op.name, time:op.time||0}); } }); }); (state.tasks||[]).forEach(t=>{ const as=t.assignees || (t.assignee? [t.assignee]:[]); if(Array.isArray(as)) as.forEach(a=>{ const id=a.id||a; const name=(empLookup.get(id)||{}).name || id; if(!map.has(id)) map.set(id,[]); map.get(id).push({employee:name, process:(state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId, opName:t.opName, time:t.estMin||t.elapsedMin||0}); }); }); if(map.size===0){ alert('Brak przypisań do eksportu.'); return; } const rows=[]; map.forEach(arr=>arr.forEach(x=>rows.push(x))); const csv=['employee,process,operation,timeMin'].concat(rows.map(r=>`"${(r.employee||'').replace(/"/g,'""')}","${(r.process||'').replace(/"/g,'""')}","${(r.opName||'').replace(/"/g,'""')}",${r.time||0}`)).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tasks_by_employee.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  function findTaskByRow(row){ const rawId = row.dataset.taskId; if(rawId) return state.tasks.find(t=>t.id===rawId); return null; }
  // Delegated click handler
  document.body.addEventListener('click', function(e){ const b = e.target.closest && e.target.closest('button'); if(!b) return; if(b.dataset.taskStart!==undefined || b.dataset.taskDone!==undefined){ const action = b.dataset.taskStart!==undefined ? 'start' : 'done'; const id = b.getAttribute(action==='start'? 'data-task-start':'data-task-done')||''; let task = state.tasks.find(t=>t.id===id);
      // if synthetic (no id) create real task
      if(!task){ try{ const tr = b.closest('tr'); const empRow = b.closest('.card'); const empName = empRow && empRow.querySelector('b') && empRow.querySelector('b').innerText; const empId = (b.closest('.card') && b.closest('.card').querySelector('[data-export-emp]') && b.closest('.card').querySelector('[data-export-emp]').getAttribute('data-export-emp')) || null; const opName = tr && tr.cells && tr.cells[1] && tr.cells[1].innerText || '(op)'; const orderId = ''; const newId = uid(); task = { id:newId, orderId:orderId, opName:opName, status:'todo', estMin:0, assignees: empId ? [{id:empId}] : [] }; state.tasks.push(task); save(); // update dataset on buttons
          // set dataset on clicked button
          try{ b.setAttribute('data-task-start', newId); if(b.dataset) b.dataset.taskStart = newId; const sib = b.closest('td') && b.closest('td').querySelector('button[data-task-done]'); if(sib){ sib.setAttribute('data-task-done', newId); if(sib.dataset) sib.dataset.taskDone = newId; } }catch(_){}}
        catch(e){ console.warn('synth->real failed', e); }
      }
      if(!task) return;
      if(action==='start'){ task.status='run'; task.startedAt = new Date().toISOString(); }
      else { task.status='done'; task.closedAt = new Date().toISOString(); }
      // mark local sync indicator
      task._syncPending = false; task._syncError = false; task._lastSync = Date.now();
      save(); // update only the row in DOM
      try{ const tr = b.closest('tr'); if(tr){ const statusCell = tr.querySelector('.status'); const statusTextEl = statusCell && statusCell.querySelector('.status-text'); const badge = statusCell && statusCell.querySelector('.sync-badge'); if(statusCell && !statusTextEl){ // fallback to plain text cell
            statusCell.textContent = task.status;
          } else {
            if(statusTextEl) statusTextEl.textContent = task.status;
          }
          if(badge){ badge.textContent = '✔️'; badge.className = 'sync-badge ok'; badge.setAttribute('title','Zapisano (lokalnie)'); }
          const startBtn = tr.querySelector('button.start'); const doneBtn = tr.querySelector('button.done'); if(startBtn){ startBtn.disabled = (task.status==='run'); startBtn.className = 'btn start ' + (task.status==='run'?'green':'gray'); startBtn.textContent = task.status==='run'?'W toku':'Start'; } if(doneBtn){ doneBtn.disabled = (task.status==='done'); doneBtn.className = 'btn done ' + (task.status==='done'?'green':'gray'); } }
      }catch(e){ console.warn('dom update err',e); }
      return; }
    if(b.id==='export-all'){ exportCSVAllByWorker(); return; }
    if(b.id==='reload'){ load(); render(); return; }
    if(b.dataset && b.dataset.exportEmp!==undefined){ const id=b.getAttribute('data-export-emp'); exportCSVForEmployee(id); return; }
    if(b.dataset && b.dataset.sendEmp!==undefined){ const id=b.getAttribute('data-send-emp'); const txt=buildEmployeeText(id); copyToClipboard(txt).then(()=>alert('Skopiowano listę zadań dla pracownika.')).catch(()=>alert('Nie udało się skopiować.')); return; }
  });
  const flt = q('#flt-status'); if(flt){ flt.addEventListener('change', ()=>{ filterStatus = flt.value || ''; render(); }); }
  // initial load
  load(); render();
  q('#reload').addEventListener('click', ()=>{ load(); render(); });
  const expAll = q('#export-all'); if(expAll){ expAll.addEventListener('click', ()=> exportCSVAllByWorker()); }
  if(q('#flt-status')){ filterStatus = q('#flt-status').value || ''; }
})();
</script>
</body>
</html>