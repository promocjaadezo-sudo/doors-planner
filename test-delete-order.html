<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test usuwania zlecenia</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #333; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-success { background: #16a34a; color: white; }
    #log { background: #1f2937; color: #10b981; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
    .info { background: #e0f2fe; padding: 10px; border-left: 4px solid #0284c7; margin: 10px 0; }
    .warning { background: #fef3c7; padding: 10px; border-left: 4px solid #f59e0b; margin: 10px 0; }
    .error { background: #fee2e2; padding: 10px; border-left: 4px solid #dc2626; margin: 10px 0; }
    .success { background: #d1fae5; padding: 10px; border-left: 4px solid #10b981; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 Test usuwania zlecenia z Firestore</h1>
    
    <div class="info">
      <strong>Instrukcja:</strong><br>
      1. Otwórz aplikację w osobnej zakładce (http://127.0.0.1:5500)<br>
      2. Upewnij się, że tryb Firebase jest włączony w Ustawieniach<br>
      3. Dodaj testowe zlecenie w aplikacji<br>
      4. Skopiuj ID zlecenia<br>
      5. Wklej ID tutaj i kliknij "Test Delete"<br>
      6. Sprawdź logi poniżej<br>
      7. Odśwież aplikację i sprawdź czy zlecenie wróciło
    </div>

    <div class="section">
      <h3>Konfiguracja Firebase</h3>
      <label>App ID:</label>
      <input type="text" id="appId" value="doors-demo" style="width: 100%; padding: 8px; margin: 5px 0;">
      <label>User ID:</label>
      <input type="text" id="userId" value="hala-1" style="width: 100%; padding: 8px; margin: 5px 0;">
      <button class="btn-primary" onclick="initFirebase()">🔌 Połącz z Firebase</button>
      <div id="connectionStatus" style="margin-top: 10px;"></div>
    </div>

    <div class="section">
      <h3>Test usuwania</h3>
      <label>ID zlecenia do usunięcia:</label>
      <input type="text" id="orderId" placeholder="np. mgxxxxxxxxxx" style="width: 100%; padding: 8px; margin: 5px 0;">
      <button class="btn-danger" onclick="testDeleteOrder()">🗑️ Test Delete</button>
      <button class="btn-success" onclick="checkOrderExists()">🔍 Sprawdź czy istnieje</button>
      <button class="btn-primary" onclick="listAllOrders()">📋 Lista wszystkich zleceń</button>
    </div>

    <div class="section">
      <h3>Console Log:</h3>
      <button onclick="document.getElementById('log').textContent = '';" style="float: right;">🧹 Wyczyść</button>
      <div id="log"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const fbConfig = {
      apiKey: "AIzaSyD93UqqsHWoAUBV7g8OVKAnajIfGDX_ZdY",
      authDomain: "doors-planner.firebaseapp.com",
      projectId: "doors-planner",
      storageBucket: "doors-planner.appspot.com",
      messagingSenderId: "513098608067",
      appId: "1:513098608067:web:1fe3855b3470ca7ef22176"
    };

    function log(msg, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('pl-PL');
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
      logDiv.textContent += `[${timestamp}] ${prefix} ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${timestamp}] ${msg}`);
    }

    async function initFirebase() {
      try {
        log('Inicjalizacja Firebase...', 'info');
        
        if (!firebase.apps.length) {
          firebase.initializeApp(fbConfig);
          log('Firebase app zainicjalizowany', 'success');
        }

        log('Logowanie anonimowe...', 'info');
        const cred = await firebase.auth().signInAnonymously();
        log(`Zalogowano: ${cred.user.uid}`, 'success');

        const status = document.getElementById('connectionStatus');
        status.innerHTML = '<div class="success">✅ Połączono z Firebase</div>';
        
        return true;
      } catch(err) {
        log(`Błąd Firebase: ${err.message}`, 'error');
        const status = document.getElementById('connectionStatus');
        status.innerHTML = `<div class="error">❌ Błąd: ${err.message}</div>`;
        return false;
      }
    }

    function fbRoot() {
      const appId = document.getElementById('appId').value || 'doors-demo';
      const userId = document.getElementById('userId').value || 'hala-1';
      return firebase.firestore()
        .collection('planner')
        .doc(appId)
        .collection('users')
        .doc(userId);
    }

    async function testDeleteOrder() {
      const orderId = document.getElementById('orderId').value.trim();
      if (!orderId) {
        alert('Podaj ID zlecenia!');
        return;
      }

      try {
        log(`\n=== ROZPOCZĘCIE TESTU USUWANIA ===`, 'info');
        log(`Order ID: ${orderId}`, 'info');

        const root = fbRoot();
        const db = firebase.firestore();
        const batch = db.batch();

        // 1. Sprawdź czy zlecenie istnieje
        log('1. Sprawdzanie czy zlecenie istnieje...', 'info');
        const orderDoc = await root.collection('orders').doc(orderId).get();
        if (!orderDoc.exists) {
          log(`Zlecenie ${orderId} NIE ISTNIEJE w Firestore`, 'warning');
          return;
        }
        log(`Zlecenie znalezione: ${JSON.stringify(orderDoc.data())}`, 'success');

        // 2. Znajdź powiązane zadania
        log('2. Wyszukiwanie powiązanych zadań...', 'info');
        const tasksSnap = await root.collection('tasks').where('orderId', '==', orderId).get();
        log(`Znaleziono ${tasksSnap.size} zadań`, 'info');
        const taskIds = [];
        tasksSnap.forEach(doc => {
          taskIds.push(doc.id);
          log(`  - Task: ${doc.id}`, 'info');
        });

        // 3. Znajdź powiązane montaże
        log('3. Wyszukiwanie powiązanych montaży...', 'info');
        const afterSnap = await root.collection('after').where('order', '==', orderId).get();
        log(`Znaleziono ${afterSnap.size} montaży`, 'info');
        const afterIds = [];
        afterSnap.forEach(doc => {
          afterIds.push(doc.id);
          log(`  - After: ${doc.id}`, 'info');
        });

        // 4. Usuń wszystko w batch
        log('4. Przygotowanie batch delete...', 'info');
        batch.delete(root.collection('orders').doc(orderId));
        log(`  - Dodano do batch: orders/${orderId}`, 'info');

        taskIds.forEach(taskId => {
          batch.delete(root.collection('tasks').doc(taskId));
          log(`  - Dodano do batch: tasks/${taskId}`, 'info');
        });

        afterIds.forEach(afterId => {
          batch.delete(root.collection('after').doc(afterId));
          log(`  - Dodano do batch: after/${afterId}`, 'info');
        });

        log('5. Wykonywanie batch.commit()...', 'info');
        await batch.commit();
        log('✅ BATCH COMMIT ZAKOŃCZONY POMYŚLNIE', 'success');

        // 6. Weryfikacja
        log('6. Weryfikacja usunięcia...', 'info');
        const checkDoc = await root.collection('orders').doc(orderId).get();
        if (!checkDoc.exists) {
          log('✅ ZLECENIE USUNIĘTE - weryfikacja OK', 'success');
        } else {
          log('❌ ZLECENIE NADAL ISTNIEJE - weryfikacja FAILED', 'error');
        }

        log(`\n=== TEST ZAKOŃCZONY ===\n`, 'success');

      } catch(err) {
        log(`\n❌ BŁĄD: ${err.message}`, 'error');
        log(`Stack: ${err.stack}`, 'error');
      }
    }

    async function checkOrderExists() {
      const orderId = document.getElementById('orderId').value.trim();
      if (!orderId) {
        alert('Podaj ID zlecenia!');
        return;
      }

      try {
        log(`Sprawdzanie zlecenia ${orderId}...`, 'info');
        const doc = await fbRoot().collection('orders').doc(orderId).get();
        
        if (doc.exists) {
          log(`✅ Zlecenie ISTNIEJE w Firestore`, 'success');
          log(`Dane: ${JSON.stringify(doc.data(), null, 2)}`, 'info');
        } else {
          log(`❌ Zlecenie NIE ISTNIEJE w Firestore`, 'warning');
        }
      } catch(err) {
        log(`Błąd: ${err.message}`, 'error');
      }
    }

    async function listAllOrders() {
      try {
        log('Pobieranie listy wszystkich zleceń...', 'info');
        const snap = await fbRoot().collection('orders').get();
        log(`\nZnaleziono ${snap.size} zleceń:`, 'info');
        
        snap.forEach(doc => {
          const data = doc.data();
          log(`  📋 ${doc.id}: ${data.name || '(brak nazwy)'}`, 'info');
        });
        
        log('', 'info'); // pusty wiersz
      } catch(err) {
        log(`Błąd: ${err.message}`, 'error');
      }
    }

    // Auto-init przy załadowaniu
    window.addEventListener('load', () => {
      log('Strona testowa załadowana', 'info');
      log('Kliknij "Połącz z Firebase" aby rozpocząć', 'info');
    });
  </script>
</body>
</html>
