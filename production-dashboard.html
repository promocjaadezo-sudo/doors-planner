<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Dashboard Monitoringu Produkcyjnego</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      color: #667eea;
    }

    .header .subtitle {
      color: #666;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card .label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-card .value.success {
      color: #10b981;
    }

    .stat-card .value.warning {
      color: #f59e0b;
    }

    .stat-card .value.error {
      color: #ef4444;
    }

    .stat-card .trend {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .section h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .history-table thead {
      background: #f3f4f6;
    }

    .history-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid #e5e7eb;
    }

    .history-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    .history-table tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.info {
      background: #dbeafe;
      color: #1e40af;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-group label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 18px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .filter-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üìä Dashboard Monitoringu Produkcyjnego</h1>
      <p class="subtitle">Centralny Magazyn Stanu - Analiza i Monitoring w Czasie Rzeczywistym</p>
    </div>

    <!-- Alerts -->
    <div id="alerts-container"></div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">üöÄ Czas dzia≈Çania</div>
        <div class="value" id="uptime-value">-</div>
        <div class="trend" id="uptime-trend">≈Åadowanie...</div>
      </div>

      <div class="stat-card">
        <div class="label">‚úÖ Health Checks</div>
        <div class="value success" id="checks-value">-</div>
        <div class="trend" id="checks-trend">Ostatni: -</div>
      </div>

      <div class="stat-card">
        <div class="label">‚ùå B≈Çƒôdy</div>
        <div class="value error" id="errors-value">-</div>
        <div class="trend" id="errors-trend">-</div>
      </div>

      <div class="stat-card">
        <div class="label">‚ö†Ô∏è Ostrze≈ºenia</div>
        <div class="value warning" id="warnings-value">-</div>
        <div class="trend" id="warnings-trend">-</div>
      </div>

      <div class="stat-card">
        <div class="label">üíæ Zapis stanu (≈õr.)</div>
        <div class="value" id="save-time-value">-</div>
        <div class="trend" id="save-time-trend">-</div>
      </div>

      <div class="stat-card">
        <div class="label">üß† U≈ºycie pamiƒôci</div>
        <div class="value" id="memory-value">-</div>
        <div class="trend" id="memory-trend">-</div>
      </div>

      <div class="stat-card">
        <div class="label">üìù Wpisy w historii</div>
        <div class="value" id="history-value">-</div>
        <div class="trend" id="history-trend">-</div>
      </div>

      <div class="stat-card">
        <div class="label">üìä Operacje</div>
        <div class="value" id="operations-value">-</div>
        <div class="trend" id="operations-trend">Ostatnie 5 min</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="section">
      <h2>üéõÔ∏è Kontrola</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="refreshData()">üîÑ Od≈õwie≈º dane</button>
        <button class="btn btn-success" onclick="runHealthCheck()">‚úÖ Health Check</button>
        <button class="btn btn-success" onclick="takeSnapshot()">üì∏ Snapshot</button>
        <button class="btn btn-secondary" onclick="exportHistory()">üíæ Eksport JSON</button>
        <button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Wyczy≈õƒá historiƒô</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="section">
      <h2>üîç Historia Operacji</h2>
      <div class="controls">
        <div class="filter-group">
          <label>Typ:</label>
          <select id="filter-type" onchange="filterHistory()">
            <option value="">Wszystkie</option>
            <option value="SYSTEM_SAVE">SYSTEM_SAVE</option>
            <option value="TASK_SAVED">TASK_SAVED</option>
            <option value="HEALTH_CHECK">HEALTH_CHECK</option>
            <option value="ERROR">B≈Çƒôdy (wszystkie)</option>
            <option value="DATA_CHANGE">DATA_CHANGE</option>
            <option value="FORM_SUBMIT">FORM_SUBMIT</option>
            <option value="USER_CLICK">USER_CLICK</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Szukaj:</label>
          <input type="text" id="search-input" placeholder="Wpisz frazƒô..." oninput="filterHistory()">
        </div>
        <div class="filter-group">
          <label>Limit:</label>
          <select id="limit-select" onchange="filterHistory()">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="0">Wszystkie</option>
          </select>
        </div>
      </div>

      <div id="history-container" style="margin-top: 20px; overflow-x: auto;">
        <div class="loading">≈Åadowanie historii</div>
      </div>
    </div>
  </div>

  <script>
    // Globalny stan dashboardu
    const dashboardState = {
      historia: [],
      refreshInterval: null,
      lastUpdate: null
    };

    // Inicjalizacja
    window.addEventListener('load', () => {
      console.log('üìä Dashboard: Inicjalizacja...');
      
      // Sprawd≈∫ czy magazyn jest dostƒôpny
      if (!window.opener || !window.opener.centralnyMagazyn) {
        showAlert('error', 'Magazyn niedostƒôpny', 'Dashboard musi byƒá otwarty z g≈Ç√≥wnej aplikacji (index.html)');
        return;
      }

      // Za≈Çaduj dane
      refreshData();

      // Auto-refresh co 5 sekund
      dashboardState.refreshInterval = setInterval(refreshData, 5000);

      console.log('‚úÖ Dashboard: Gotowy');
    });

    // Od≈õwie≈ºanie danych
    function refreshData() {
      try {
        const magazyn = window.opener.centralnyMagazyn;
        const monitor = window.opener.productionMonitor;
        const integration = window.opener.magazynIntegration;

        if (!magazyn || !monitor || !integration) {
          showAlert('error', 'B≈ÇƒÖd', 'Modu≈Çy magazynu nie sƒÖ dostƒôpne');
          return;
        }

        // Pobierz dane
        dashboardState.historia = magazyn.pobierzHistorie();
        const monitorStats = monitor.getStats();
        const integrationStats = integration.getStats();

        // Aktualizuj statystyki
        updateStats(monitorStats, integrationStats);

        // Aktualizuj historiƒô
        filterHistory();

        dashboardState.lastUpdate = Date.now();

      } catch (error) {
        console.error('‚ùå Dashboard: B≈ÇƒÖd od≈õwie≈ºania:', error);
        showAlert('error', 'B≈ÇƒÖd od≈õwie≈ºania', error.message);
      }
    }

    // Aktualizacja statystyk
    function updateStats(monitorStats, integrationStats) {
      // Uptime
      const uptimeSeconds = monitorStats.uptime_seconds || 0;
      const uptimeStr = formatDuration(uptimeSeconds);
      document.getElementById('uptime-value').textContent = uptimeStr;
      document.getElementById('uptime-trend').textContent = `Od: ${new Date(Date.now() - uptimeSeconds * 1000).toLocaleTimeString('pl-PL')}`;

      // Health Checks
      document.getElementById('checks-value').textContent = monitorStats.checks || 0;
      const lastCheck = dashboardState.historia.filter(h => h.typ === 'HEALTH_CHECK').pop();
      document.getElementById('checks-trend').textContent = lastCheck 
        ? `Ostatni: ${new Date(lastCheck.timestamp).toLocaleTimeString('pl-PL')}`
        : 'Brak danych';

      // B≈Çƒôdy
      const errorCount = monitorStats.errors || 0;
      document.getElementById('errors-value').textContent = errorCount;
      document.getElementById('errors-trend').textContent = errorCount === 0 ? '‚úÖ Brak b≈Çƒôd√≥w' : '‚ùå Wymaga uwagi';

      // Ostrze≈ºenia
      const warningCount = monitorStats.warnings || 0;
      document.getElementById('warnings-value').textContent = warningCount;
      document.getElementById('warnings-trend').textContent = warningCount === 0 ? '‚úÖ OK' : '‚ö†Ô∏è Sprawd≈∫';

      // ≈öredni czas save()
      const saves = dashboardState.historia.filter(h => h.typ === 'SYSTEM_SAVE');
      if (saves.length > 0) {
        const avgTime = saves.reduce((sum, s) => sum + (s.dane?.czas_ms || 0), 0) / saves.length;
        document.getElementById('save-time-value').textContent = Math.round(avgTime) + 'ms';
        document.getElementById('save-time-trend').textContent = avgTime < 100 ? '‚úÖ Szybko' : avgTime < 500 ? '‚ö†Ô∏è ≈örednio' : '‚ùå Wolno';
      }

      // Pamiƒôƒá
      const healthChecks = dashboardState.historia.filter(h => h.typ === 'HEALTH_CHECK');
      const lastHealth = healthChecks[healthChecks.length - 1];
      if (lastHealth && lastHealth.dane.memory_mb) {
        document.getElementById('memory-value').textContent = lastHealth.dane.memory_mb + 'MB';
        document.getElementById('memory-trend').textContent = lastHealth.dane.memory_status === 'OK' ? '‚úÖ Dobry' : '‚ö†Ô∏è ' + lastHealth.dane.memory_status;
      }

      // Historia
      document.getElementById('history-value').textContent = integrationStats.total_entries || 0;
      document.getElementById('history-trend').textContent = `Rozmiar: ${Math.round(JSON.stringify(dashboardState.historia).length / 1024)}KB`;

      // Operacje (ostatnie 5 min)
      const fiveMinAgo = Date.now() - 5 * 60 * 1000;
      const recentOps = dashboardState.historia.filter(h => h.timestamp >= fiveMinAgo);
      document.getElementById('operations-value').textContent = recentOps.length;
      document.getElementById('operations-trend').textContent = `${Math.round(recentOps.length / 5)}/min`;
    }

    // Filtrowanie historii
    function filterHistory() {
      const typeFilter = document.getElementById('filter-type').value;
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      const limit = parseInt(document.getElementById('limit-select').value) || 0;

      let filtered = [...dashboardState.historia];

      // Filtr typu
      if (typeFilter) {
        if (typeFilter === 'ERROR') {
          filtered = filtered.filter(h => h.typ.includes('ERROR'));
        } else {
          filtered = filtered.filter(h => h.typ === typeFilter);
        }
      }

      // Filtr wyszukiwania
      if (searchQuery) {
        filtered = filtered.filter(h => {
          const json = JSON.stringify(h).toLowerCase();
          return json.includes(searchQuery);
        });
      }

      // Sortuj od najnowszych
      filtered.sort((a, b) => b.timestamp - a.timestamp);

      // Limit
      if (limit > 0) {
        filtered = filtered.slice(0, limit);
      }

      renderHistory(filtered);
    }

    // Renderowanie historii
    function renderHistory(entries) {
      const container = document.getElementById('history-container');

      if (entries.length === 0) {
        container.innerHTML = '<div class="no-data">Brak wpis√≥w pasujƒÖcych do filtr√≥w</div>';
        return;
      }

      let html = `
        <table class="history-table">
          <thead>
            <tr>
              <th>Czas</th>
              <th>Typ</th>
              <th>Dane</th>
            </tr>
          </thead>
          <tbody>
      `;

      entries.forEach(entry => {
        const time = new Date(entry.timestamp).toLocaleString('pl-PL');
        const typ = entry.typ;
        const badge = getBadgeClass(typ);
        const daneStr = JSON.stringify(entry.dane, null, 2);

        html += `
          <tr>
            <td style="white-space: nowrap;">${time}</td>
            <td><span class="badge ${badge}">${typ}</span></td>
            <td><details><summary>Zobacz dane</summary><pre style="font-size: 12px; margin-top: 10px;">${daneStr}</pre></details></td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Klasa badge na podstawie typu
    function getBadgeClass(typ) {
      if (typ.includes('ERROR')) return 'error';
      if (typ.includes('WARNING')) return 'warning';
      if (typ.includes('SUCCESS') || typ === 'HEALTH_CHECK') return 'success';
      return 'info';
    }

    // Formatowanie czasu
    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      
      if (h > 0) return `${h}h ${m}m ${s}s`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }

    // Alerty
    function showAlert(type, title, message) {
      const container = document.getElementById('alerts-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<strong>${title}</strong>: ${message}`;
      container.appendChild(alertDiv);

      setTimeout(() => alertDiv.remove(), 5000);
    }

    // Kontrolki
    function runHealthCheck() {
      try {
        const monitor = window.opener.productionMonitor;
        const result = monitor.healthCheck();
        showAlert('success', 'Health Check', 'Sprawdzenie zako≈Ñczone pomy≈õlnie');
        refreshData();
      } catch (error) {
        showAlert('error', 'B≈ÇƒÖd', error.message);
      }
    }

    function takeSnapshot() {
      try {
        const monitor = window.opener.productionMonitor;
        monitor.takeSnapshot();
        showAlert('success', 'Snapshot', 'Snapshot utworzony');
        refreshData();
      } catch (error) {
        showAlert('error', 'B≈ÇƒÖd', error.message);
      }
    }

    function exportHistory() {
      try {
        const magazyn = window.opener.centralnyMagazyn;
        const json = magazyn.exportujDoJSON();
        
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `magazyn-historia-${Date.now()}.json`;
        a.click();
        
        showAlert('success', 'Eksport', 'Historia wyeksportowana do pliku JSON');
      } catch (error) {
        showAlert('error', 'B≈ÇƒÖd eksportu', error.message);
      }
    }

    function clearHistory() {
      if (!confirm('Czy na pewno chcesz wyczy≈õciƒá ca≈ÇƒÖ historiƒô? Ta operacja jest nieodwracalna!')) {
        return;
      }

      try {
        const integration = window.opener.magazynIntegration;
        integration.clearHistory();
        showAlert('success', 'Historia wyczyszczona', 'Wszystkie wpisy zosta≈Çy usuniƒôte');
        refreshData();
      } catch (error) {
        showAlert('error', 'B≈ÇƒÖd', error.message);
      }
    }

    // Czyszczenie przy zamkniƒôciu
    window.addEventListener('beforeunload', () => {
      if (dashboardState.refreshInterval) {
        clearInterval(dashboardState.refreshInterval);
      }
    });
  </script>
</body>
</html>
