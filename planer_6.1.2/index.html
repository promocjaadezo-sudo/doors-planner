<!DOCTYPE html>
<html lang="pl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0, post-check=0, pre-check=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="last-modified" content="2025-11-27">
<title>Planner Produkcji Drzwi ‚Äî v6.1.1 (2025-11-27)</title>
<style>
:root{--bg:#0f172a;--panel:#1f2937;--muted:#94a3b8;--b:#374151;--acc:#2563eb;--ok:#16a34a;--warn:#d97706;--err:#dc2626;--text:#ffffff;--text-secondary:#ffffff}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#ffffff;line-height:1.5}
header{position:sticky;top:0;z-index:60;background:rgba(15,23,42,.95);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid #1e293b}
h3{color:#ffffff;font-size:18px;font-weight:700;margin:0 0 12px 0;text-shadow:0 1px 3px rgba(0,0,0,0.7)}
h4{color:#ffffff;font-size:16px;font-weight:700;margin:8px 0;text-shadow:0 1px 2px rgba(0,0,0,0.6)}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:var(--panel);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.35);margin:0 0 12px;border:1px solid rgba(255,255,255,0.1)}
.btn{border:0;border-radius:10px;padding:8px 12px;background:#334155;color:#ffffff;cursor:pointer;border:1px solid rgba(255,255,255,0.1);font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.5);transition:all 0.2s;user-select:none}
.btn:hover{background:#475569;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.3)}
.btn:active{transform:translateY(0);box-shadow:0 1px 2px rgba(0,0,0,0.2)}
.btn.gray{background:#475569;color:#ffffff;border:1px solid rgba(255,255,255,0.15)}
.btn.primary{background:var(--acc);color:#fff;border:1px solid rgba(59,130,246,0.5)}.btn.red{background:var(--err);border:1px solid rgba(220,38,38,0.5)}.btn.green{background:var(--ok);border:1px solid rgba(22,163,74,0.5)}.btn.amber{background:var(--warn);border:1px solid rgba(217,119,6,0.5)}.btn.blue{background:#3b82f6;border:1px solid rgba(59,130,246,0.5)}.btn.orange{background:#f59e0b;color:#000;border:1px solid rgba(245,158,11,0.5)}.btn.small{padding:6px 12px;font-size:13px;color:#fff;background:#475569;border:1px solid rgba(255,255,255,0.15)}
.hidden{display:none!important}
input,select,textarea{background:#111827;color:#e5e7eb;border:1px solid var(--b);border-radius:10px;padding:8px 10px;width:100%;transition:all 0.2s}
input:hover,select:hover,textarea:hover{border-color:#475569}
input:focus,select:focus,textarea:focus{border-color:var(--acc);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,0.2);transform:translateY(-1px)}
label{font-size:12px;color:#ffffff;font-weight:500}.list{display:flex;flex-direction:column;gap:8px}.muted{color:#ffffff;font-size:12px}
#set-info{color:#ffffff !important;font-weight:600 !important;font-size:14px !important;background:#1a2332 !important;padding:4px 8px !important;border-radius:4px !important;border:1px solid #334155 !important;display:block !important;min-height:20px !important;}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.table{overflow:auto; max-height:55vh} table{width:100%;border-collapse:collapse;border:1px solid rgba(255,255,255,0.1);border-radius:8px;overflow:hidden}
th,td{border-bottom:1px solid #2b3a59;padding:8px;text-align:left;background:#1f2937} th{background:#111827;position:sticky;top:0;border-bottom:2px solid var(--acc);font-weight:700;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.6)}
.pill{display:inline-block;background:#0b1222;border:1px solid #2b3a59;border-radius:999px;padding:2px 8px;font-size:11px;color:#ffffff;font-weight:500}
.oktxt{color:#ffffff}.err{color:#ffffff}

/* Deadline Alerts Styles */
.deadline-alert { padding: 12px; border-radius: 6px; border-left: 4px solid; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.deadline-alert.warning { background: rgba(245, 158, 11, 0.15); border-left-color: #f59e0b; color: #92400e; border: 1px solid rgba(245, 158, 11, 0.3); }
.deadline-alert.danger { background: rgba(239, 68, 68, 0.15); border-left-color: #ef4444; color: #991b1b; border: 1px solid rgba(239, 68, 68, 0.3); }
.deadline-alert.overdue { background: rgba(220, 38, 38, 0.15); border-left-color: #dc2626; color: #7f1d1d; border: 1px solid rgba(220, 38, 38, 0.3); animation: pulse 2s infinite; }
.deadline-alert .alert-icon { font-size: 18px; flex-shrink: 0; }
.deadline-alert .alert-content { flex: 1; }
.deadline-alert .alert-message { font-weight: 700; margin-bottom: 4px; color: inherit; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
.deadline-alert .alert-date { font-size: 12px; opacity: 0.9; font-weight: 500; }
.no-alerts { color: #ffffff; font-style: italic; padding: 16px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }
@keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } 50% { opacity: 0.8; box-shadow: 0 2px 8px rgba(0,0,0,0.2); } }

/* Validation error styles */
.validation-error { background: var(--err); color: white; border: 1px solid #b91c1c; animation: fadeIn 0.3s ease-in; }
.validation-error h4 { margin: 0 0 8px 0; color: #ffffff; }
.validation-error ul { margin: 0; padding-left: 20px; }
.validation-error li { margin-bottom: 4px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* Search styles */
.search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel); border: 1px solid var(--b); border-radius: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,.5); }
.search-result-item { padding: 12px; border-bottom: 1px solid var(--b); cursor: pointer; transition: background 0.2s; }
.search-result-item:hover { background: rgba(255,255,255,0.05); }
.search-result-item:last-child { border-bottom: none; }
.search-result-category { font-size: 11px; color: var(--acc); text-transform: uppercase; margin-bottom: 4px; }
.search-result-title { font-weight: 600; color: #ffffff; margin-bottom: 2px; }
.search-result-details { font-size: 12px; color: #ffffff; }
.search-no-results { padding: 20px; text-align: center; color: #ffffff; }

/* Gantt Chart styles */
.gantt-container { border: 1px solid var(--b); border-radius: 8px; overflow: hidden; max-height: 70vh; background: var(--panel); }
.gantt-header { display: flex; background: #1f2937; border-bottom: 1px solid var(--b); position: sticky; top: 0; z-index: 10; }
.gantt-resource-column { width: 200px; padding: 12px; font-weight: 600; color: #ffffff; border-right: 1px solid var(--b); background: #111827; }
.gantt-timeline { flex: 1; display: flex; position: relative; }
.gantt-time-slot { flex: 1; padding: 8px 4px; text-align: center; font-size: 11px; color: #ffffff; border-right: 1px solid rgba(148, 163, 184, 0.2); min-width: 60px; }
.gantt-body { max-height: calc(70vh - 50px); overflow-y: auto; }
.gantt-row { display: flex; border-bottom: 1px solid rgba(148, 163, 184, 0.1); }
.gantt-row:hover { background: rgba(255,255,255,0.02); }
.gantt-resource-cell { width: 200px; padding: 12px; border-right: 1px solid var(--b); background: #111827; color: #ffffff; font-weight: 500; }
.gantt-task-cell { flex: 1; position: relative; min-height: 50px; }
.gantt-task { position: absolute; height: 30px; background: var(--acc); border-radius: 4px; cursor: pointer; display: flex; align-items: center; padding: 0 8px; font-size: 11px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 80px; max-width: 200px; transition: all 0.2s; }
.gantt-task:hover { border-color: #60a5fa; transform: translateY(-1px); }
.gantt-task.selected { border: 3px solid #fbbf24 !important; box-shadow: 0 0 12px rgba(251, 191, 36, 0.6), 0 2px 4px rgba(0,0,0,0.2) !important; transform: scale(1.05); z-index: 10; }
.gantt-task.todo { background: #f59e0b; }
.gantt-task.run { background: #3b82f6; }
.gantt-task.done { background: #10b981; }
.gantt-task.overdue { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
.gantt-current-time { position: absolute; top: 0; width: 2px; background: #ef4444; z-index: 10; pointer-events: none; }
.gantt-current-time::after { content: ''; position: absolute; top: -4px; left: -4px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; }

/* Drag & Drop styles */
.gantt-task.dragging { opacity: 0.5; transform: rotate(5deg); z-index: 1000; }
.gantt-task.drag-over { border-color: #10b981; background: rgba(16, 185, 129, 0.2); }
.gantt-drop-zone { position: absolute; height: 30px; background: rgba(16, 185, 129, 0.1); border: 2px dashed #10b981; border-radius: 4px; pointer-events: none; z-index: 999; }
.gantt-drop-zone.valid { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
.gantt-drop-zone.invalid { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

/* Dependencies visualization */
.gantt-dependency { position: absolute; pointer-events: none; z-index: 10; overflow: visible; }
.gantt-dependency-line { stroke: #3b82f6; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; }
.gantt-dependency-arrow { fill: #3b82f6; stroke: #3b82f6; stroke-width: 2; }
.gantt-dependency.manual { stroke: #10b981; stroke-width: 4; }
.gantt-dependency-arrow.manual { fill: #10b981; stroke: #10b981; }

/* Dependency creation mode */
.gantt-task.dependency-from { border-color: #3b82f6 !important; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6) !important; }
.gantt-task.dependency-target { border-color: #10b981 !important; box-shadow: 0 0 8px rgba(16, 185, 129, 0.6) !important; }

/* Critical path highlighting */
.gantt-task.critical-path { background: linear-gradient(45deg, #ef4444, #dc2626); border: 2px solid #b91c1c; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
.gantt-dependency.critical { stroke: #ef4444; stroke-width: 3; }
.gantt-dependency-arrow.critical { fill: #ef4444; stroke: #ef4444; }

/* Float indicators */
.gantt-float-indicator { position: absolute; top: -20px; right: 2px; font-size: 10px; color: #ffffff; background: rgba(15, 23, 42, 0.8); padding: 2px 4px; border-radius: 2px; white-space: nowrap; }
.gantt-float-indicator.positive { color: #10b981; }
.gantt-float-indicator.zero { color: #ef4444; font-weight: bold; }
.gantt-float-indicator.negative { color: #f59e0b; }

/* Sync Status Indicator Styles */
.sync-status {
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.sync-status.sync-ok {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.sync-status.sync-pending {
  background: rgba(251, 191, 36, 0.15);
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
  animation: pulse 2s infinite;
}

.sync-status.sync-error {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.sync-status.sync-disconnected {
  background: rgba(148, 163, 184, 0.15);
  color: #94a3b8;
  border: 1px solid rgba(148, 163, 184, 0.3);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Conflict Warning Styles */
.conflict-warnings-container {
  margin: 12px 0;
  padding: 0;
}

.conflict-warning {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  border-left: 4px solid;
  margin-bottom: 8px;
  background: var(--panel);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.2s;
}

.conflict-warning:hover {
  transform: translateX(2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.conflict-warning.critical {
  background: rgba(220, 38, 38, 0.15);
  border-left-color: #dc2626;
}

.conflict-warning.high {
  background: rgba(239, 68, 68, 0.15);
  border-left-color: #ef4444;
}

.conflict-warning.medium {
  background: rgba(245, 158, 11, 0.15);
  border-left-color: #f59e0b;
}

.conflict-warning.low {
  background: rgba(59, 130, 246, 0.15);
  border-left-color: #3b82f6;
}

.conflict-icon {
  font-size: 20px;
  flex-shrink: 0;
  width: 24px;
  text-align: center;
}

.conflict-content {
  flex: 1;
}

.conflict-message {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 4px;
  font-size: 14px;
}

.conflict-details {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.8);
  line-height: 1.4;
}

.conflict-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

/* Alternative Employees Dialog */
.alternatives-dialog {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s;
}

.alternatives-content {
  background: var(--panel);
  border-radius: 12px;
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.alternatives-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.alternatives-title {
  font-size: 18px;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
}

.alternatives-close {
  background: transparent;
  border: none;
  font-size: 24px;
  color: rgba(255, 255, 255, 0.6);
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.2s;
}

.alternatives-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
}

.alternatives-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.alternative-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
}

.alternative-item:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--acc);
  transform: translateX(4px);
}

.alternative-info {
  flex: 1;
}

.alternative-name {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 4px;
  font-size: 15px;
}

.alternative-meta {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
}

.alternative-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
}

.alternative-badge.full {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.alternative-badge.limited {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.alternative-score {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(37, 99, 235, 0.2);
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #3b82f6;
}

.no-alternatives {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.6);
  font-style: italic;
}

/* Conflict Report Styles */
.conflict-report {
  background: var(--panel);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.report-section {
  margin-bottom: 20px;
}

.report-section:last-child {
  margin-bottom: 0;
}

.report-header {
  font-size: 16px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.report-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.report-stat {
  background: rgba(255, 255, 255, 0.05);
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}

.report-stat-value {
  font-size: 24px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 4px;
}

.report-stat-label {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.report-stat.danger .report-stat-value {
  color: #ef4444;
}

.report-stat.warning .report-stat-value {
  color: #f59e0b;
}

.report-stat.success .report-stat-value {
  color: #10b981;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  setWarehouseStaffFormMode('create');
  }
}

/* Capacity Analysis Styles */
.capacity-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--b); border-radius: 6px; margin-bottom: 8px; background: var(--panel); }
.capacity-employee { font-weight: 600; color: var(--text); }
.capacity-metrics { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
.capacity-bar { position: relative; width: 120px; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.capacity-bar span { color: white; font-size: 11px; font-weight: 600; z-index: 1; }
.capacity-fill { position: absolute; left: 0; top: 0; height: 100%; transition: width 0.3s ease; }
.capacity-fill.low { background: #10b981; }
.capacity-fill.normal { background: #3b82f6; }
.capacity-fill.high { background: #f59e0b; }
.capacity-fill.overloaded { background: #ef4444; }

.bottleneck-item { padding: 12px; border: 1px solid #ef4444; border-radius: 6px; margin-bottom: 8px; background: rgba(239, 68, 68, 0.1); }
.bottleneck-name { font-weight: 600; color: #ef4444; margin-bottom: 4px; }
.bottleneck-metrics { font-size: 13px; color: var(--text-secondary); }

.efficiency-metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(148, 163, 184, 0.1); }
.efficiency-metric:last-child { border-bottom: none; }
.metric-label { color: var(--text-secondary); }
.metric-value { font-weight: 600; color: var(--text); }

.empty { text-align: center; color: var(--text-secondary); padding: 20px; font-style: italic; }

/* Mobile responsiveness */
@media (max-width: 768px) {
  .grid3 { grid-template-columns: 1fr; }
  .grid2 { grid-template-columns: 1fr; }
  .row { flex-direction: column; align-items: stretch; }
  .wrap { padding: 8px; }
  .card { padding: 10px; margin-bottom: 8px; }
  .btn { padding: 10px 16px; font-size: 16px; }
  input, select, textarea { font-size: 16px; padding: 12px 14px; }
  label { font-size: 14px; }
  .gantt-resource-column, .gantt-resource-cell { width: 120px; font-size: 12px; }
  .gantt-time-slot { font-size: 10px; min-width: 40px; }
  .table { max-height: 40vh; }
  h3 { font-size: 16px; }
  h4 { font-size: 14px; }
  .pill { font-size: 10px; }
}

/* FIX: Wymuszenie kursora w modalach i checklistach */
#custom-modal, #custom-modal * {
  cursor: default !important;
}
#custom-modal [onclick],
#custom-modal button,
#custom-modal .btn {
  cursor: pointer !important;
}
#custom-modal input:not([disabled]) {
  cursor: pointer !important;
}

/* Map view styles */
#map-view { display: flex; flex-direction: column; gap: 12px; }
#map-canvas { display: flex; flex-direction: column; gap: 12px; }
.map-card { background: var(--panel); border-radius: 14px; padding: 16px; border: 1px solid rgba(148, 163, 184, 0.18); box-shadow: 0 14px 32px rgba(15, 23, 42, 0.45); }
.map-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
.map-card-title { font-size: 18px; font-weight: 700; color: #ffffff; margin: 0; }
.map-card-subtitle { color: rgba(148, 163, 184, 0.9); font-size: 13px; }
.map-card-meta { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; color: rgba(209, 231, 255, 0.9); font-size: 12px; }
.map-chip { display: inline-flex; align-items: center; gap: 6px; background: rgba(37, 99, 235, 0.18); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 999px; padding: 4px 10px; font-weight: 600; color: #bfdbfe; }
.map-section { margin-top: 12px; }
.map-section-title { font-weight: 600; color: #ffffff; margin-bottom: 6px; font-size: 14px; }
.map-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 6px; }
.map-list li { background: rgba(148, 163, 184, 0.08); border: 1px solid rgba(148, 163, 184, 0.08); border-radius: 10px; padding: 10px 12px; color: #e2e8f0; font-size: 13px; line-height: 1.4; }
.map-order-meta { display: block; margin-top: 4px; font-size: 12px; color: rgba(148, 163, 184, 0.9); }
.map-stat { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(148, 163, 184, 0.18); border-radius: 12px; padding: 14px 16px; min-width: 140px; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.5); }
.map-stat-value { display: block; font-size: 22px; font-weight: 700; color: #ffffff; }
.map-stat-label { font-size: 12px; color: rgba(148, 163, 184, 0.9); text-transform: uppercase; letter-spacing: 0.05em; }
.map-empty { text-align: center; padding: 40px; color: rgba(148, 163, 184, 0.9); border: 1px dashed rgba(148, 163, 184, 0.3); border-radius: 12px; background: rgba(148, 163, 184, 0.06); font-style: italic; }

@media (max-width: 768px) {
  .map-card-header { flex-direction: column; align-items: flex-start; }
  .map-card-meta { width: 100%; }
}

/* Console Panel Styles */
#debug-console-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 600px;
  max-height: 400px;
  background: #1a1a2e;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  font-family: 'Courier New', monospace;
}

#debug-console-panel.hidden {
  display: none;
}

#debug-console-header {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  padding: 12px 16px;
  border-radius: 10px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  cursor: move;
}

#debug-console-header .title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

#debug-console-header .controls {
  display: flex;
  gap: 6px;
}

#debug-console-header button {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.2s;
}

#debug-console-header button:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

#debug-console-content {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  background: #0d0d1a;
  max-height: 320px;
}

#debug-console-logs {
  font-size: 12px;
  line-height: 1.6;
  color: #e5e7eb;
}

.console-log {
  padding: 6px 8px;
  margin-bottom: 4px;
  border-left: 3px solid #6b7280;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 4px;
  word-break: break-all;
}

.console-log.info {
  border-left-color: #3b82f6;
  color: #93c5fd;
}

.console-log.warn {
  border-left-color: #f59e0b;
  color: #fbbf24;
}

.console-log.error {
  border-left-color: #ef4444;
  color: #fca5a5;
  background: rgba(239, 68, 68, 0.1);
}

.console-log.success {
  border-left-color: #10b981;
  color: #6ee7b7;
}

.console-log .timestamp {
  color: #6b7280;
  font-size: 10px;
  margin-right: 8px;
}

#debug-console-footer {
  padding: 8px 12px;
  background: #16213e;
  border-top: 1px solid #374151;
  display: flex;
  gap: 6px;
  border-radius: 0 0 10px 10px;
}

#debug-console-footer button {
  flex: 1;
  padding: 8px 12px;
  background: #374151;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: all 0.2s;
}

#debug-console-footer button:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

#debug-console-footer button.primary {
  background: #3b82f6;
}

#debug-console-footer button.primary:hover {
  background: #2563eb;
}

/* Toggle Button */
#debug-console-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

#debug-console-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
}

#debug-console-toggle.hidden {
  display: none;
}

@media (max-width: 768px) {
  #debug-console-panel {
    width: calc(100vw - 40px);
    right: 20px;
    bottom: 20px;
  }
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script></head>
<body style="">
<header class="wrap">
  <div class="row" style="gap:8px">
    <button class="btn" data-nav="dash">Strona g≈Ç√≥wna</button>
    <button class="btn" data-nav="tasks">Listy</button>
    <button class="btn" data-nav="order">Zlecenia</button>
    <button class="btn" data-nav="proc">Procesy</button>
    <button class="btn" data-nav="opcat">Katalog operacji</button>
    <button class="btn" data-nav="emp">Pracownicy</button>
    <button class="btn" data-nav="as">Monta≈º/Reklamacje</button>
    <button class="btn" data-nav="gantt">Harmonogram</button>
    <button class="btn" data-nav="capacity">Analiza</button>
    <button class="btn" data-nav="reports">Raporty</button>
    <button class="btn" data-nav="map">Mapy</button>
    <button class="btn" data-nav="monitor">Monitoring</button>
    <button class="btn" data-nav="mrp">MRP</button>
    <button class="btn" data-nav="wh">Magazyn</button>
    <button class="btn" data-nav="sync">üîÑ Sync</button>
    <button class="btn" data-nav="backup">Backup</button>
    <button class="btn" data-nav="settings">Ustawienia</button>
    
    <!-- NOWY: Sync Status Indicator -->
    <div id="sync-status" class="sync-status sync-disconnected" title="Status synchronizacji Firebase">
      üîå Roz≈ÇƒÖczono
    </div>
  </div>
  <div class="row" style="gap:8px;margin-top:8px">
    <input type="text" id="global-search" placeholder="Szukaj zam√≥wie≈Ñ, pracownik√≥w, zada≈Ñ..." style="flex:1;max-width:400px" spellcheck="true" lang="pl">
    <button class="btn" id="search-btn">üîç Szukaj</button>
    <a href="worker-app.html" target="_blank" class="btn blue" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px" title="Otw√≥rz panel pracownika">
      <span>üë∑</span>
      <span>Panel pracownika</span>
    </a>
    <div id="search-results" class="search-results" style="display:none"></div>
  </div>
</header>

<!-- Banner ostrzegawczy o r√≥≈ºnych portach -->
<div id="port-warning-banner" style="display: block; background: rgb(22, 163, 74); color: white; padding: 12px 20px; text-align: center; font-size: 14px; font-weight: 600; border-bottom: 3px solid rgb(21, 128, 61);">
  üü¢ WERSJA 6.0.9 - NAPRAWIONE SZABLONY + USUWANIE OPERACJI: <span id="port-warning-detail">Dodano pe≈ÇnƒÖ obs≈Çugƒô szablon√≥w i naprawiono usuwanie operacji z Firebase.</span>
  <button onclick="window.showPortInfo()" style="background:white;color:#dc2626;border:none;padding:4px 12px;border-radius:4px;margin-left:12px;cursor:pointer;font-weight:600">üìä Poka≈º info</button>
  <button onclick="window.exportDataToFile()" style="background:#10b981;color:white;border:none;padding:4px 12px;border-radius:4px;margin-left:8px;cursor:pointer;font-weight:600">üíæ Eksport</button>
  <button onclick="window.importDataFromFile()" style="background:#3b82f6;color:white;border:none;padding:4px 12px;border-radius:4px;margin-left:8px;cursor:pointer;font-weight:600">üìÅ Import</button>
  <button onclick="document.getElementById('port-warning-banner').style.display='none'" style="background:transparent;color:white;border:1px solid white;padding:4px 12px;border-radius:4px;margin-left:8px;cursor:pointer">‚úï Zamknij</button>
</div>

<div class="wrap">
  <div class="row" style="justify-content:space-between"><h1>Planner Produkcji Drzwi ‚Äî v6.1.1</h1></div>

  <div class="card hidden" id="p-dash">
    <h3>Panel</h3>
    <div class="grid3" style="margin-top:12px;gap:12px">
      <div style="background:rgba(37,99,235,0.18);border:1px solid rgba(59,130,246,0.35);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:6px;box-shadow:0 4px 14px rgba(15,23,42,0.45)">
        <span style="font-size:13px;color:#cbd5f5;text-transform:uppercase;letter-spacing:0.08em">Zlecenia</span>
        <span id="dash-orders" style="font-size:28px;font-weight:700;color:#ffffff">1</span>
      </div>
      <div style="background:rgba(16,185,129,0.18);border:1px solid rgba(16,185,129,0.35);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:6px;box-shadow:0 4px 14px rgba(15,23,42,0.45)">
        <span style="font-size:13px;color:#bbf7d0;text-transform:uppercase;letter-spacing:0.08em">Procesy</span>
        <span id="dash-proc" style="font-size:28px;font-weight:700;color:#ffffff">3</span>
      </div>
      <div style="background:rgba(249,115,22,0.18);border:1px solid rgba(249,115,22,0.35);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:6px;box-shadow:0 4px 14px rgba(15,23,42,0.45)">
        <span style="font-size:13px;color:#fed7aa;text-transform:uppercase;letter-spacing:0.08em">Operacje</span>
        <span id="dash-ops" style="font-size:28px;font-weight:700;color:#ffffff">44</span>
      </div>
      <div style="background:rgba(168,85,247,0.18);border:1px solid rgba(168,85,247,0.35);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:6px;box-shadow:0 4px 14px rgba(15,23,42,0.45)">
        <span style="font-size:13px;color:#e9d5ff;text-transform:uppercase;letter-spacing:0.08em">Magazyn</span>
        <span id="dash-warehouse" style="font-size:28px;font-weight:700;color:#ffffff">4</span>
      </div>
    </div>

    <div id="deadline-alerts" style="margin-top:16px"><div class="deadline-alert warning">
      <div class="alert-icon">üü°</div>
      <div class="alert-content">
        <div class="alert-message">Zam√≥wienie "5003" (Brak klienta) - termin za 4 dni</div>
        <div class="alert-date">Termin: 13.11.2025</div>
      </div>
    </div></div>

    <!-- Przycisk do panelu pracownika -->
    <div style="margin-top:16px;text-align:center">
      <a href="worker-app.html" target="_blank" class="btn blue" style="display:inline-flex;align-items:center;gap:8px;padding:12px 24px;font-size:16px;text-decoration:none">
        <span style="font-size:20px">üë∑</span>
        <span>Panel pracownika</span>
      </a>
      <div class="muted" style="margin-top:8px;font-size:12px">Otw√≥rz aplikacjƒô dla pracownik√≥w magazynu i produkcji</div>
    </div>
  </div>

  <div class="card hidden" id="p-order">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap">
      <h3>Zlecenia</h3>
      <div class="row" style="gap:8px">
        <button class="btn" type="button" onclick="window.exportDataToFile()">üíæ Eksport</button>
        <button class="btn" type="button" onclick="window.importDataFromFile()">üìÅ Import</button>
      </div>
    </div>
    <form class="grid3" id="order-form">
      <input type="hidden" id="o-id" value="">
      <div><label>Nazwa zlecenia</label><input id="o-name" placeholder="np. Zam√≥wienie #123" required="" spellcheck="true" lang="pl"></div>
      <div><label>Klient</label><input id="o-client" placeholder="Nazwa klienta" spellcheck="true" lang="pl"></div>
      <div><label>Model</label><input id="o-model" placeholder="Model / wariant" spellcheck="true" lang="pl"></div>
      <div><label>Ilo≈õƒá</label><input id="o-qty" type="number" min="1" value="1" spellcheck="true" lang="pl"></div>
      <div><label>Data przyjƒôcia</label><input id="o-start" type="date" onchange="calcEndDate()" spellcheck="true" lang="pl"></div>
      <div><label>Czas realizacji</label>
        <select id="o-weeks" onchange="calcEndDate()">
          <option value="">‚Äî wybierz tygodnie ‚Äî</option>
          <option value="2">2 tygodnie</option>
          <option value="3">3 tygodnie</option>
          <option value="4">4 tygodnie</option>
          <option value="5">5 tygodni</option>
          <option value="6">6 tygodni</option>
          <option value="7">7 tygodni</option>
          <option value="8">8 tygodni</option>
          <option value="9">9 tygodni</option>
          <option value="10">10 tygodni</option>
          <option value="11">11 tygodni</option>
          <option value="12">12 tygodni</option>
        </select>
      </div>
      <div><label>Termin ko≈Ñca produkcji</label><input id="o-end" type="date" onchange="calcInstallDate()" spellcheck="true" lang="pl"></div>
      <div style="grid-column:1/-1"><label>Uwagi</label><textarea id="o-notes" rows="2" placeholder="Dodatkowe informacje, wymagania, kontakt..." spellcheck="true" lang="pl"></textarea></div>
      <div><label>Termin monta≈ºu</label><input id="o-install" type="date" spellcheck="true" lang="pl"></div>
      <div><label>Adres monta≈ºu</label><input id="o-addr" placeholder="ulica nr, miejscowo≈õƒá" spellcheck="true" lang="pl"></div>
      <div><label>Kod monta≈ºu</label><input id="o-post" placeholder="kod miejsca / 00-000" spellcheck="true" lang="pl"></div>
      <div><label>Telefon</label><input id="o-phone" placeholder="+48 600 000 000" pattern="\+?[0-9\s]{6,}" title="Minimum 6 cyfr, opcjonalny '+' na poczƒÖtku" spellcheck="true" lang="pl"></div>
      <div><label>Proces</label><select id="o-proc"><option value="">Brak</option><option value="mg9t6hiieyao">Proces: Futryna</option><option value="mg9t6hiiffge">Proces: Skrzyd≈Ço</option><option value="mg9t6hiiuztd">Proces: Drzwi kompletne</option></select></div>
      <div><label>Pracownik prowadzƒÖcy</label><select id="o-lead"><option value="">‚Äî wybierz pracownika ‚Äî</option><option value="id-mhqk06bsnq8n">PIOTR</option><option value="id-mhqmea04frcw">TOMASZ</option><option value="id-mhqnovqwkchl">BOGDAN</option><option value="id-mhqnp31ihfrw">MALINA</option></select></div>
      <div style="grid-column:1/-1;text-align:right"><button class="btn primary" type="submit">Zapisz zlecenie</button></div>
    </form>
    <div class="table" style="margin-top:12px">
      <table>
        <thead>
          <tr>
            <th>Nr zlecenia</th>
            <th>Klient</th>
            <th>Model</th>
            <th>Ilo≈õƒá</th>
            <th>Data przyjƒôcia</th>
            <th>Termin</th>
            <th>Monta≈º</th>
            <th>Kod monta≈ºu</th>
            <th>Postƒôp</th>
            <th>Lead time (h)</th>
            <th>Materia≈Çy</th>
            <th>Akcje</th>
          </tr>
        </thead>
        <tbody id="ord-tb"><tr><td>5003</td><td>-</td><td>-</td><td>1</td>
                    <td>2025-11-09</td><td>2025-11-13</td><td>2025-11-23</td><td>-</td>
                    <td><div style="background:#0b1222;border:1px solid #223044;border-radius:6px;height:12px;width:120px;overflow:hidden"><div style="height:100%;width:0%;background:linear-gradient(90deg,#16a34a,#a3e635);"></div></div> <div class="muted" style="font-size:12px;margin-top:4px">0% (0/9)</div></td>
                    <td>346.8</td>
                    <td>-<br></td>
  <td style="min-width: 200px"><div class="row"><button class="btn" data-oed="id-mhrm6hh8a28m">Edytuj</button><button class="btn blue" data-checklist="id-mhrm6hh8a28m" title="Poka≈º checklistƒô materia≈Ç√≥w">üìã Checklist</button><button class="btn amber" data-replan-order="id-mhrm6hh8a28m" title="Resetuj i przelicz tylko zadania tego zlecenia">Replan</button><button class="btn red" data-od="id-mhrm6hh8a28m">Usu≈Ñ</button></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card hidden" id="p-tasks">
    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
      <div>
        <h3>Zadania</h3>
        <div class="muted">Wy≈õwietlane zadania: <span id="tasks-count">9</span></div>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <select id="tasks-group-by" style="min-width:180px" title="Grupuj zadania wg...">
          <option value="">Bez grupowania</option>
          <option value="order">Grupuj wg zlecenia</option>
          <option value="status">Grupuj wg statusu</option>
          <option value="assignee">Grupuj wg przypisanego</option>
        </select>
        <select id="tasks-filter-order" style="min-width:180px"><option value="">Wszystkie zlecenia</option><option value="id-mhrm6hh8a28m">5003</option></select>
        <select id="tasks-filter-status" style="min-width:160px">
          <option value="">Wszystkie statusy</option>
          <option value="todo">Do zrobienia</option>
          <option value="run">W realizacji</option>
          <option value="done">Zamkniƒôte</option>
        </select>
        <button class="btn" id="tasks-gen-by-emp" type="button">Zbuduj raport</button>
        <button class="btn" id="tasks-export-csv-by-emp" type="button">Eksport CSV</button>
        <button class="btn" id="tasks-show-by-emp" type="button">Poka≈º podzia≈Ç</button>
        <button class="btn green" id="tasks-auto-assign-all" type="button" title="Automatycznie przypisz wszystkie nieprzypisane zadania">ü§ñ Auto-assign wszystkie</button>
        <button class="btn amber" id="tasks-rebalance" type="button" title="Rebalansuj obciƒÖ≈ºenie pracownik√≥w">‚öñÔ∏è Rebalansuj</button>
      </div>
    </div>
    <div class="muted" style="margin-bottom:8px">U≈ºyj filtr√≥w, aby zawƒôziƒá listƒô i szybko przygotowaƒá raporty dla brygad.</div>
    
    <!-- NOWY: Conflict Warnings Container -->
    <div id="conflict-warnings" class="conflict-warnings-container" style="display:none"></div>
    
    <div class="list" id="tasks-list"><div class="row" style="justify-content: flex-end; margin-bottom: 12px;">
      <button class="btn red" id="mass-delete-tasks">
        Usu≈Ñ wszystkie wy≈õwietlone zadania (9)
      </button>
      
    </div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Monta≈º: 5003 <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ PIOTR   </span></div>
          <div class="muted">Status: planned ‚Ä¢ Plan: 900m ‚Ä¢ Real: 0m  </div>
        <div class="muted">StartP: 23.11.2025, 08:00:00 ‚Ä¢ EndP: 23.11.2025, 23:00:00</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="id-mhrm78jblv5y">Start</button>
          <button class="btn" data-task-pause="id-mhrm78jblv5y" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="id-mhrm78jblv5y">Powt√≥rz</button>
          <button class="btn gray" data-task-done="id-mhrm78jblv5y">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Monta≈º: 5003 <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ TOMASZ   </span></div>
          <div class="muted">Status: planned ‚Ä¢ Plan: 900m ‚Ä¢ Real: 0m  </div>
        <div class="muted">StartP: 23.11.2025, 08:00:00 ‚Ä¢ EndP: 23.11.2025, 23:00:00</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="id-mhrm78jfpxry">Start</button>
          <button class="btn" data-task-pause="id-mhrm78jfpxry" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="id-mhrm78jfpxry">Powt√≥rz</button>
          <button class="btn gray" data-task-done="id-mhrm78jfpxry">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Malowanie (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ TOMASZ   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 30m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 8m </div>
        <div class="muted">StartP: 9.11.2025, 13:49:30 ‚Ä¢ EndP: 9.11.2025, 14:19:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hha4bet">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hha4bet" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hha4bet">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hha4bet">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Szczotkowanie (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ PIOTR   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 12m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 38m </div>
        <div class="muted">StartP: 9.11.2025, 13:37:30 ‚Ä¢ EndP: 9.11.2025, 13:49:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hha6xw1">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hha6xw1" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hha6xw1">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hha6xw1">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Kontrola wymiar√≥w (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ BOGDAN   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 10m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 65m </div>
        <div class="muted">StartP: 9.11.2025, 13:12:30 ‚Ä¢ EndP: 9.11.2025, 13:22:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hha8eqp">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hha8eqp" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hha8eqp">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hha8eqp">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Okuwanie (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ BOGDAN   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 8m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 0m ‚Ä¢ CRITICAL</div>
        <div class="muted">StartP: 9.11.2025, 14:19:30 ‚Ä¢ EndP: 9.11.2025, 14:27:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hhaakd5">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hhaakd5" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hhaakd5">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hhaakd5">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Sklejanie belek (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ TOMASZ   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 20m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 75m </div>
        <div class="muted">StartP: 9.11.2025, 12:52:30 ‚Ä¢ EndP: 9.11.2025, 13:12:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hhabb1m">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hhabb1m" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hhabb1m">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hhabb1m">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Szlifowanie (futryna) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ MALINA   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 15m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 50m </div>
        <div class="muted">StartP: 9.11.2025, 13:22:30 ‚Ä¢ EndP: 9.11.2025, 13:37:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hhac91d">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hhac91d" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hhac91d">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hhac91d">Zamknij</button>
          
        </div></div></div><div class="card"><div class="row" style="justify-content:space-between">
        <div>
          <b>Frezowanie na CNC (belki futryny) <span class="task-sync-status ok" title="Ostatnia synchronizacja: 9.11.2025, 12:18:54">‚úîÔ∏è</span></b> 
          <span class="muted">
            5003
            
          </span>
          <div><span style="font-size:12px">üë§ PIOTR   </span></div>
          <div class="muted">Status: todo ‚Ä¢ Plan: 40m ‚Ä¢ Real: 0m ‚Ä¢ Slack: 95m </div>
        <div class="muted">StartP: 9.11.2025, 12:12:30 ‚Ä¢ EndP: 9.11.2025, 12:52:30</div>
        <div class="muted">  </div></div>
        <div class="row">
          
          <button class="btn gray" data-task-start="task-mhrm6hhazcrw">Start</button>
          <button class="btn" data-task-pause="task-mhrm6hhazcrw" disabled="">Pauza</button>
          <button class="btn amber" data-task-repeat="task-mhrm6hhazcrw">Powt√≥rz</button>
          <button class="btn gray" data-task-done="task-mhrm6hhazcrw">Zamknij</button>
          
        </div></div></div></div>
    <div id="tasks-by-worker" class="list" style="margin-top:16px"></div>
  </div>

  <div class="card hidden" id="p-opcat">
    <div class="row" style="justify-content:space-between">
      <h3>Katalog operacji</h3><span class="pill" id="op-count">0</span>
      <div class="row">
          <button class="btn" id="op-normalize">PorzƒÖdkuj</button>
          <button class="btn" id="op-sort-az">Sortuj A‚ÜíZ</button>
          <select id="op-comp-select" style="min-width:160px;margin-left:8px"><option value="">‚Äî wybierz komponent ‚Äî</option></select>
          <button class="btn" id="op-sort-comp" style="margin-left:6px">Sortuj po komponencie</button>
          <button class="btn green" id="op-save-db" style="margin-left:6px">Zapisz do DB</button>
        </div>
    </div>
    <form class="grid3" id="op-form">
      <input type="hidden" id="op-id">
      <div><label>Nr (kolejno≈õƒá)</label><input id="op-no" type="number" min="1" value="1" spellcheck="true" lang="pl"></div>
      <div><label>Nazwa</label><input id="op-name" required="" spellcheck="true" lang="pl"></div>
      <div><label>Czas [min] (‚â•1)</label><input id="op-time" type="number" min="1" value="10" spellcheck="true" lang="pl"></div>
      <div><label>Domy≈õlna liczba prac. (‚â•1)</label><input id="op-workers" type="number" min="1" value="1" spellcheck="true" lang="pl"></div>
      <div style="grid-column:1/-1"><label>Komponenty (;)</label>
        <input id="op-skills" placeholder="np. pi≈Ça; wkrƒôty; listwa" spellcheck="true" lang="pl">
      </div>
      <div style="grid-column:1/-1"><label>Domy≈õlni pracownicy (multi)</label>
        <select id="op-emp" multiple="" size="5" style="height:140px"></select>
      </div>
      <div class="card" id="op-checklist-card" style="grid-column:1/-1;margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px">
          <div>
            <label style="display:block;margin-bottom:4px">Checklisty operacji</label>
            <div class="muted" style="font-size:12px">Dodaj punkty listy kontrolnej, kt√≥re bƒôdƒÖ kopiowane do proces√≥w i zada≈Ñ</div>
          </div>
          <div id="op-checklist-summary" class="muted" style="font-size:12px">0 punkt√≥w</div>
        </div>
        <div class="row" style="gap:8px;margin:12px 0;flex-wrap:wrap">
          <input id="op-checklist-new-label" placeholder="Tre≈õƒá punktu" style="flex:2;min-width:200px">
          <select id="op-checklist-new-type" style="flex:1;min-width:140px">
            <option value="checkbox">‚òëÔ∏è Pole wyboru</option>
            <option value="confirm">‚úì Potwierdzenie</option>
            <option value="text">üìù Tekst</option>
            <option value="number">üî¢ Liczba</option>
            <option value="photo">üì∑ Zdjƒôcie</option>
            <option value="measure">üìè Pomiary</option>
          </select>
          <label class="muted" style="font-size:12px"><input type="checkbox" id="op-checklist-new-required"> Wymagane</label>
          <label class="muted" style="font-size:12px"><input type="checkbox" id="op-checklist-new-default"> Domy≈õlnie ‚úîÔ∏è</label>
          <input id="op-checklist-new-hint" placeholder="Podpowied≈∫ / instrukcja" style="flex:2;min-width:200px">
          <div style="flex:2;min-width:250px;display:flex;gap:4px;">
            <input id="op-checklist-new-image" placeholder="üñºÔ∏è URL zdjƒôcia / schematu (opcjonalnie)" style="flex:1;">
            <input type="file" id="op-checklist-image-file" accept="image/*" style="display:none" onchange="handleChecklistImageUpload(this)">
            <button class="btn" type="button" onclick="document.getElementById('op-checklist-image-file').click()" title="Prze≈õlij zdjƒôcie z komputera">üì§ Upload</button>
          </div>
          <button class="btn" type="button" id="op-checklist-add-btn">‚ûï Dodaj punkt</button>
        </div>
        <div id="op-checklist-items" class="list" style="gap:8px"></div>
        <div class="row" style="gap:16px;margin-top:12px;flex-wrap:wrap">
          <label><input type="checkbox" id="op-checklist-required"> Lista wymagana przed zamkniƒôciem</label>
          <label><input type="checkbox" id="op-checklist-propagate" checked> Automatycznie dodawaj do zada≈Ñ</label>
          <label><input type="checkbox" id="op-checklist-allow-add" checked> Pracownik mo≈ºe dopisywaƒá punkty</label>
        </div>
      </div>
      <div style="grid-column:1/-1;text-align:right">
        <button class="btn primary" type="submit">Dodaj / Zapisz</button>
      </div>
      <div class="muted" id="op-msg"></div>
    </form>
    <div class="table" style="margin-top:8px">
      <table>
        <thead>
          <tr><th>Nr</th><th>Nazwa</th><th>min</th><th>prac.</th><th>komponenty</th><th>domy≈õlni prac.</th><th>Akcje</th></tr>
        </thead>
        <tbody id="op-tb"></tbody>
      </table>
    </div>
  </div>

  <div class="card hidden" id="p-proc">
    <div class="row" style="justify-content:space-between"><h3>Procesy</h3><span class="pill" id="proc-count">0</span></div>
    
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleProcForm()">
        <h4 style="margin:0">‚ûï Dodaj nowy proces</h4>
        <span id="proc-form-toggle" style="font-size:20px">‚ñº</span>
      </div>
      
      <form id="proc-form" class="hidden" style="margin-top:16px">
        <input type="hidden" id="proc-id">
        
        <div style="margin-bottom:16px">
          <label>üìù Nazwa procesu *</label>
          <input id="proc-name" required="" spellcheck="true" lang="pl" placeholder="np. SZABLON 1">
        </div>
        
        <div style="display:grid;grid-template-columns:2fr auto;gap:12px;margin-bottom:16px">
          <div>
            <label>‚ûï Dodaj operacjƒô z katalogu</label>
            <select id="proc-op-select"></select>
          </div>
          <div style="display:flex;align-items:end">
            <button class="btn primary" id="proc-add-op" type="button">Dodaj</button>
          </div>
        </div>
        
        <div style="margin-bottom:16px">
          <label>üìë Szablon materia≈Çowy (opcjonalne)</label>
          <select id="proc-template-select">
            <option value="">Brak</option>
          </select>
        </div>
        
        <div class="row" style="gap:8px">
          <button class="btn primary" type="submit">üíæ Zapisz proces</button>
          <button class="btn" type="button" onclick="cancelProcForm()">‚úï Anuluj</button>
        </div>
      </form>
    </div>
    
    <div class="card">
      <b>üìã Operacje w procesie</b>
      <div class="list" id="proc-ops"></div>
    </div>
    
    <div>
      <b>üìö Zapisane procesy</b>
      <div class="list" id="proc-list"></div>
    </div>
  </div>

  <div class="card hidden" id="p-emp">
    <div class="row" style="justify-content:space-between">
      <h3>Pracownicy</h3>
      <div class="row" style="gap:8px">
        <button class="btn" style="background:#8b5cf6;color:white" id="emp-manage-pin">üî¢ ZarzƒÖdzaj PIN</button>
        <button class="btn" id="emp-add">Dodaj</button>
      </div>
    </div>
    
    <!-- Formularz dodawania/edycji pracownika -->
    <div id="emp-form-container" class="hidden" style="margin:16px 0;padding:16px;background:#f0f9ff;border:2px solid #3b82f6;border-radius:8px">
      <div style="font-weight:600;font-size:16px;color:#1e40af;margin-bottom:12px">‚ûï Nowy pracownik</div>
      <input type="hidden" id="emp-form-id">
      <div style="display:grid;grid-template-columns:1fr 1fr 100px 100px 1fr;gap:12px;align-items:end">
        <div>
          <label for="emp-form-name" style="display:block;font-size:13px;color:#475569;margin-bottom:4px">Imiƒô i nazwisko *</label>
          <input type="text" id="emp-form-name" placeholder="np. Jan Kowalski" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px" spellcheck="true" lang="pl">
        </div>
        <div>
          <label for="emp-form-role" style="display:block;font-size:13px;color:#475569;margin-bottom:4px">Rola / Stanowisko</label>
          <select id="emp-form-role" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px">
            <option value="">‚Äî Wybierz rolƒô ‚Äî</option>
            <option value="Magazynier">üì¶ Magazynier</option>
            <option value="Produkcja">üîß Produkcja</option>
            <option value="Monta≈º">üèóÔ∏è Monta≈º</option>
            <option value="Handlowiec">üíº Handlowiec</option>
            <option value="Kierownik">üëî Kierownik</option>
            <option value="Inne">‚ûï Inne</option>
          </select>
        </div>
        <div>
          <label for="emp-form-cap" style="display:block;font-size:13px;color:#475569;margin-bottom:4px">Cap %</label>
          <input type="number" id="emp-form-cap" value="100" min="0" max="100" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px" spellcheck="true" lang="pl">
        </div>
        <div>
          <label for="emp-form-hours" style="display:block;font-size:13px;color:#475569;margin-bottom:4px">h/d</label>
          <input type="number" id="emp-form-hours" value="8" min="1" max="24" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px" spellcheck="true" lang="pl">
        </div>
        <div>
          <label for="emp-form-phone" style="display:block;font-size:13px;color:#475569;margin-bottom:4px">Telefon</label>
          <input type="tel" id="emp-form-phone" placeholder="np. 123-456-789" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px" spellcheck="true" lang="pl">
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn green" id="emp-form-save">‚úì Zapisz</button>
        <button class="btn" id="emp-form-cancel">‚úï Anuluj</button>
      </div>
    </div>
    
    <div class="table"><table><thead><tr><th>Imiƒô i nazwisko</th><th>Rola</th><th>Telefon</th><th>cap%</th><th>h/d</th><th>Akcje</th></tr></thead><tbody id="emp-tb"></tbody></table></div>
  </div>

  <div class="card hidden" id="p-as">
    <div class="row" style="justify-content:space-between">
      <h3>Monta≈º / Reklamacje</h3>
      <div class="row" style="gap:8px">
        <button class="btn green" id="as-add-task">‚ûï Nowe zadanie monta≈ºowe</button>
        <button class="btn" data-refresh-as="">Od≈õwie≈º z bazy</button>
      </div>
    </div>
    <form class="grid3" id="as-form">
      <input type="hidden" id="as-id">
      
      <!-- Podstawowe informacje -->
      <div><label>Typ</label><select id="as-type"><option>monta≈º</option><option>reklamacja</option><option>pomiar</option><option>inne</option></select></div>
      <div><label>Status</label><select id="as-status"><option>nowe</option><option>w toku</option><option>zamkniƒôte</option></select></div>
      <div><label>Zlecenie</label><select id="as-order"></select></div>
      
      <!-- Klient i Pracownik prowadzƒÖcy -->
      <div>
        <label style="color:#64748b;font-size:12px;font-weight:600">KLIENT</label>
        <input id="as-client" readonly="" placeholder="Automatycznie z zlecenia" spellcheck="true" lang="pl" style="background:#1e293b;color:#fff;border:2px solid #334155;font-weight:600;font-size:14px;padding:10px">
      </div>
      <div>
        <label style="color:#64748b;font-size:12px;font-weight:600">PRACOWNIK PROWADZƒÑCY</label>
        <input id="as-lead" readonly="" spellcheck="true" lang="pl" style="background:#1e293b;color:#fff;border:2px solid #334155;font-weight:600;font-size:14px;padding:10px">
      </div>
      <div style="grid-column:3/4"></div>
      <div style="grid-column:1/-1"><label>Pracownicy monta≈ºowi (Ctrl+klik = wiele)</label><select id="as-employees" multiple="" size="6" style="width:100%;"></select></div>
      
      <!-- Dane kontaktowe i lokalizacja -->
      <div style="grid-column:1/-1"><label>Adres monta≈ºu</label><input id="as-address" placeholder="ulica nr, miejscowo≈õƒá" spellcheck="true" lang="pl"></div>
      <div><label>Kod pocztowy</label><input id="as-placecode" placeholder="00-000" spellcheck="true" lang="pl"></div>
      <div><label>Telefon</label><input id="as-phone" placeholder="+48 123 456 789" spellcheck="true" lang="pl"></div>
      
      <!-- Terminy i czas -->
      <div><label>Termin monta≈ºu</label><input id="as-install" type="date" spellcheck="true" lang="pl"></div>
      <div><label>Godzina wyjazdu</label><input id="as-go" type="time" spellcheck="true" lang="pl"></div>
      <div><label>Godzina wizyty</label><input id="as-visit" type="time" spellcheck="true" lang="pl"></div>
      <div><label>Liczba godzin monta≈ºu</label><input id="as-hours" type="number" step="0.5" min="0" placeholder="np. 2.5" spellcheck="true" lang="pl"></div>
      <div style="grid-column:2/4"></div>
      
      <!-- Notatki -->
      <div style="grid-column:1/-1"><label>Opis / Notatki</label><textarea id="as-desc" rows="3" spellcheck="true" lang="pl" placeholder="Dodatkowe informacje o monta≈ºu..."></textarea></div>
      <div style="grid-column:1/-1;text-align:right"><button class="btn primary" type="submit">Zapisz</button></div>
    </form>
    
    <!-- Formularz dodatkowego zadania monta≈ºowego -->
    <div id="as-task-form-container" class="hidden card" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:#1e293b;border:2px solid #334155;box-shadow:0 8px 32px rgba(0,0,0,0.6);max-width:900px;width:90%;max-height:90vh;overflow-y:auto">
      <div style="background:#0f172a;padding:16px;border-bottom:2px solid #475569;margin:-1px -1px 20px -1px">
        <h4 style="margin:0;color:#fff;font-size:18px">‚ûï Dodatkowe zadanie</h4>
      </div>
      
      <form class="grid3" style="padding:0 16px 16px 16px">
        <!-- Podstawowe informacje -->
        <div><label>Numer zadania (auto)</label>
          <input id="as-task-number" disabled style="background:#e2e8f0;cursor:not-allowed" placeholder="Generowany automatycznie">
        </div>
        <div><label>Typ zadania</label>
          <select id="as-task-type">
            <option value="pomiar">üìè Pomiar</option>
            <option value="monta≈º">üîß Monta≈º</option>
            <option value="naprawa">üî® Naprawa</option>
            <option value="regulacja">‚öôÔ∏è Regulacja</option>
            <option value="dostawa">üöö Dostawa</option>
            <option value="pr√≥bka-koloru">üé® Pr√≥bka koloru</option>
            <option value="inne">üìã Inne</option>
          </select>
        </div>
        <div><label>Nazwa zadania</label><input id="as-task-name" placeholder="np. Pomiar okna kuchnia" spellcheck="true" lang="pl"></div>
        
        <!-- Kolorowa belka separatora -->
        <div style="grid-column:1/-1;height:3px;background:linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);margin:16px 0;border-radius:2px"></div>
        
        <div style="grid-column:1/-1"><label>Zlecenie (opcjonalne)</label><select id="as-task-order"><option value="">‚Äî Brak powiƒÖzania ‚Äî</option></select></div>
        
        <!-- Klient (pole do rƒôcznego wpisania) -->
        <div style="grid-column:1/3">
          <label style="color:#e2e8f0;font-size:12px;font-weight:600">KLIENT *</label>
          <input id="as-task-client" placeholder="Wpisz nazwisko klienta" spellcheck="true" lang="pl" style="background:#fff;color:#1e293b;border:2px solid #cbd5e1;font-weight:600;font-size:14px;padding:10px;width:100%">
        </div>
        <div style="grid-column:3/4"></div>
        
        <!-- Pracownicy -->
        <div style="grid-column:1/-1"><label>Przypisz pracownik√≥w (Ctrl+klik = wiele)</label>
          <select id="as-task-employees" multiple="" size="5" style="width:100%;"></select>
        </div>
        
        <!-- Dane kontaktowe i lokalizacja -->
        <div style="grid-column:1/-1"><label>Adres</label><input id="as-task-address" placeholder="ulica nr, miejscowo≈õƒá" spellcheck="true" lang="pl"></div>
        <div><label>Kod pocztowy</label><input id="as-task-postal" placeholder="00-000" spellcheck="true" lang="pl"></div>
        <div><label>Telefon</label><input id="as-task-phone" placeholder="+48 123 456 789" spellcheck="true" lang="pl"></div>
        
        <!-- Terminy i czas -->
        <div><label>Data realizacji</label><input id="as-task-date" type="date" spellcheck="true" lang="pl"></div>
        <div><label>Godzina wyjazdu</label><input id="as-task-depart" type="time" spellcheck="true" lang="pl"></div>
        <div><label>Godzina wizyty</label><input id="as-task-visit" type="time" spellcheck="true" lang="pl"></div>
        <div><label>Szacowany czas (godz.)</label><input id="as-task-hours" type="number" step="0.5" min="0.5" value="2" placeholder="np. 2.5" spellcheck="true" lang="pl"></div>
        <div><label>Priorytet</label>
          <select id="as-task-priority">
            <option value="normal">Normalny</option>
            <option value="high">Wysoki</option>
            <option value="urgent">Pilny</option>
          </select>
        </div>
        <div style="grid-column:3/4"></div>
        
        <!-- Opis -->
        <div style="grid-column:1/-1"><label>Opis / Notatki</label><textarea id="as-task-notes" rows="3" placeholder="Dodatkowe informacje o zadaniu..." spellcheck="true" lang="pl"></textarea></div>
        
        <div style="grid-column:1/-1;text-align:right;margin-top:12px">
          <button class="btn green" id="as-task-save" type="button">‚úì Zapisz</button>
          <button class="btn" id="as-task-cancel" type="button" style="margin-left:8px">‚úï Anuluj</button>
        </div>
      </form>
    </div>
    
    <div class="list" id="as-list"></div>
  </div>

  <div class="card hidden" id="p-map">
    <div class="row" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h3 style="margin:0">Mapy Model‚ÜîProces</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn" id="map-export-json">üìÑ Eksport JSON</button>
        <button class="btn" id="map-export-png">üñºÔ∏è Eksport PNG</button>
      </div>
    </div>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:12px">
      <select id="map-filter-model" style="min-width:180px;padding:8px;border-radius:8px;background:#111827;color:#e2e8f0;border:1px solid rgba(148,163,184,0.3)">
        <option value="__ALL__">Wszystkie modele</option>
      </select>
      <select id="map-filter-process" style="min-width:180px;padding:8px;border-radius:8px;background:#111827;color:#e2e8f0;border:1px solid rgba(148,163,184,0.3)">
        <option value="__ALL__">Wszystkie procesy</option>
      </select>
      <select id="map-filter-status" style="min-width:180px;padding:8px;border-radius:8px;background:#111827;color:#e2e8f0;border:1px solid rgba(148,163,184,0.3)">
        <option value="__ALL__">Wszystkie statusy</option>
      </select>
    </div>
    <div id="map-stats" class="row" style="gap:12px;flex-wrap:wrap;margin-top:16px"></div>
    <div id="map-view" style="margin-top:16px">
      <div id="map-canvas" class="list">
        <div class="map-empty">≈Åadowanie danych mapy...</div>
      </div>
    </div>
  </div>
  <div class="card hidden" id="p-monitor"><div class="row" style="justify-content: space-between;"><div><h3>Monitoring postƒôp√≥w</h3></div><div class="row"><input id="monitor-filter-input" placeholder="Filtruj operacje..." style="width: 220px; margin-left: 8px;" spellcheck="true" lang="pl"><button class="btn">Od≈õwie≈º</button><button class="btn" style="margin-left: 6px;">Eksport CSV</button></div></div><div class="grid3" style="margin-top: 8px;"><div class="card"><div><b>Zlecenia</b></div><div class="pill">1</div></div><div class="card"><div><b>Zadania</b></div><div class="pill">9</div></div><div class="card"><div><b>W toku / oczekujƒÖce</b></div><div class="muted">run: 0 ‚Ä¢ todo: 7</div></div></div><div class="table" style="margin-top: 12px;"><table><thead><tr><th>Operacja</th><th>W kolejce</th><th>W toku</th><th>Est. sum</th><th>≈ör. elapsed [m]</th></tr></thead><tbody><tr style="cursor: pointer;"><td>Monta≈º: 5003</td><td>2</td><td>0</td><td>0</td><td>0</td></tr><tr style="cursor: pointer;"><td>Malowanie (futryna)</td><td>1</td><td>0</td><td>30</td><td>0</td></tr><tr style="cursor: pointer;"><td>Sklejanie belek (futryna)</td><td>1</td><td>0</td><td>20</td><td>0</td></tr><tr style="cursor: pointer;"><td>Okuwanie (futryna)</td><td>1</td><td>0</td><td>8</td><td>0</td></tr><tr style="cursor: pointer;"><td>Szczotkowanie (futryna)</td><td>1</td><td>0</td><td>12</td><td>0</td></tr><tr style="cursor: pointer;"><td>Kontrola wymiar√≥w (futryna)</td><td>1</td><td>0</td><td>10</td><td>0</td></tr><tr style="cursor: pointer;"><td>Szlifowanie (futryna)</td><td>1</td><td>0</td><td>15</td><td>0</td></tr><tr style="cursor: pointer;"><td>Frezowanie na CNC (belki futryny)</td><td>1</td><td>0</td><td>40</td><td>0</td></tr></tbody></table></div><div style="margin-top: 10px;"><div class="card"><div class="muted">Brak wyra≈∫nych wƒÖskich garde≈Ç (brak operacji z ‚â•5 zadaniami).</div></div></div></div>
  <div class="card hidden" id="p-mrp">
    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <h3>üõí Zakupy / MRP</h3>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="window.showShoppingList()" style="background:#f59e0b;position:relative">
          üõí Lista zakup√≥w
          <span id="mrp-shopping-badge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:bold"></span>
        </button>
        <button class="btn blue" onclick="exportMRPToCSV()" id="mrp-export-btn">üìä Eksport CSV</button>
        <button class="btn green" onclick="createPurchaseOrderModal()" id="mrp-new-order-btn">‚ûï Nowe zam√≥wienie</button>
      </div>
    </div>
    
    <!-- Podzak≈Çadki MRP -->
    <div class="row" style="gap:8px;margin-bottom:16px;border-bottom:2px solid #e2e8f0;padding-bottom:8px">
      <button class="btn amber" id="mrp-tab-analysis" onclick="switchMRPTab('analysis')">üìä Analiza</button>
      <button class="btn" id="mrp-tab-orders" onclick="switchMRPTab('orders')">üìù Zam√≥wienia <span id="mrp-orders-badge" class="pill" style="margin-left:4px;display:none">0</span></button>
      <button class="btn" id="mrp-tab-suppliers" onclick="switchMRPTab('suppliers')">üë• Dostawcy <span id="mrp-suppliers-badge" class="pill" style="margin-left:4px;display:none">0</span></button>
    </div>
    
    <!-- Widok: Analiza zapotrzebowania -->
    <div id="mrp-view-analysis">
      <!-- Dashboard -->
      <div id="mrp-dashboard" class="grid3" style="margin-bottom:24px"></div>
      
      <!-- Analiza zapotrzebowania -->
      <div id="mrp-analysis">
        <div style="margin-bottom:12px;padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:4px">
          <div style="font-weight:600;font-size:16px;color:#1e40af;margin-bottom:4px">üìä Analiza zapotrzebowania materia≈Çowego</div>
          <div style="font-size:14px;color:#64748b">System analizuje stany magazynowe wzglƒôdem zarezerwowanych materia≈Ç√≥w w zleceniach</div>
        </div>
        <div class="list" id="mrp-list"></div>
      </div>
    </div>
    
    <!-- Widok: Zam√≥wienia zakupowe -->
    <div id="mrp-view-orders" class="hidden">
      <div style="margin-bottom:16px;padding:12px;background:#dcfce7;border-left:4px solid #16a34a;border-radius:4px">
        <div style="font-weight:600;font-size:16px;color:#166534;margin-bottom:4px">üìù Zam√≥wienia zakupowe</div>
        <div style="font-size:14px;color:#64748b">ZarzƒÖdzaj zam√≥wieniami materia≈Ç√≥w od dostawc√≥w</div>
      </div>
      
      <!-- Dashboard zam√≥wie≈Ñ -->
      <div id="po-dashboard" class="grid3" style="margin-bottom:24px"></div>
      
      <!-- Filtry zam√≥wie≈Ñ -->
      <div class="row" style="gap:8px;margin-bottom:16px">
        <button class="btn" onclick="filterPurchaseOrders('all')">Wszystkie</button>
        <button class="btn" onclick="filterPurchaseOrders('draft')">üìù Robocze</button>
        <button class="btn" onclick="filterPurchaseOrders('sent')">üì§ Wys≈Çane</button>
        <button class="btn" onclick="filterPurchaseOrders('confirmed')">‚úÖ Potwierdzone</button>
        <button class="btn" onclick="filterPurchaseOrders('received')">üì¶ Odebrane</button>
      </div>
      
      <!-- Lista zam√≥wie≈Ñ -->
      <div class="list" id="purchase-orders-list"></div>
    </div>
    
    <!-- Widok: Dostawcy -->
    <div id="mrp-view-suppliers" class="hidden">
      <div style="margin-bottom:16px;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:4px">
        <div style="font-weight:600;font-size:16px;color:#92400e;margin-bottom:4px">üë• Baza dostawc√≥w</div>
        <div style="font-size:14px;color:#64748b">ZarzƒÖdzaj kontaktami do dostawc√≥w materia≈Ç√≥w</div>
      </div>
      
      <!-- Panel Telegram Bota -->
      <div class="card" style="margin-bottom:16px;background:linear-gradient(135deg,#0088cc,#00a0e4);color:white">
        <h4 style="margin:0 0 12px 0">üí¨ Telegram Bot - Powiadomienia</h4>
        <div style="font-size:14px;opacity:0.9;margin-bottom:12px">
          Bezp≈Çatne powiadomienia dla dostawc√≥w przez Telegram (nielimitowane)
        </div>
        <div id="telegram-bot-status" style="font-size:13px;background:rgba(255,255,255,0.2);padding:8px;border-radius:4px;margin-bottom:12px">
          ‚öôÔ∏è ≈Åadowanie statusu...
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" style="background:white;color:#0088cc" onclick="setupTelegramBot()">‚öôÔ∏è Konfiguruj</button>
          <button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="testTelegramBot()">üß™ Test</button>
          <button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="showTelegramChatIds()">üìã Chat ID</button>
        </div>
      </div>
      
      <div style="margin-bottom:16px;text-align:right">
        <button class="btn green" onclick="createSupplierModal()">‚ûï Dodaj dostawcƒô</button>
      </div>
      
      <!-- Lista dostawc√≥w -->
      <div class="list" id="suppliers-list"></div>
    </div>
  </div>
  
  <div class="card hidden" id="p-wh">
    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <h3>üì¶ Magazyn</h3>
      <div class="row" style="gap:8px">
        <button class="btn orange" onclick="toggleOrderFilter()">üî¥ Do zam√≥wienia</button>
        <button class="btn blue" onclick="exportWarehouseToCSV()">üìä Eksportuj CSV</button>
        <button class="btn green" id="wh-add" onclick="addWarehouseItem()">‚ûï Dodaj pozycjƒô</button>
      </div>
    </div>
    
    <!-- Zak≈Çadki magazynu -->
    <div class="row" style="gap:8px;margin-bottom:16px;border-bottom:1px solid var(--b);padding-bottom:8px">
      <button class="btn" id="wh-tab-items" onclick="switchWarehouseTab('items')">üìã Pozycje</button>
      <button class="btn" id="wh-tab-work" onclick="switchWarehouseTab('work')" style="position:relative">
        üì¶ Praca magazyniera
        <span id="work-badge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:bold;min-width:20px;text-align:center"></span>
      </button>
      <button class="btn" id="wh-tab-obligations" onclick="switchWarehouseTab('obligations')" style="position:relative">
        ‚öñÔ∏è ObciƒÖ≈ºenia
        <span id="obligations-badge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:bold;min-width:20px;text-align:center"></span>
      </button>
      <button class="btn" id="wh-tab-transactions" onclick="switchWarehouseTab('transactions')">üìù Przych√≥d/Rozch√≥d</button>
      <button class="btn" id="wh-tab-templates" onclick="switchWarehouseTab('templates')">üìë Szablony materia≈Çowe</button>
      <button class="btn primary" id="shopping-list-btn" onclick="window.showShoppingList()" style="background:#f59e0b;margin-left:auto;position:relative">
        üõí Lista zakup√≥w
        <span id="shopping-badge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:bold;min-width:20px;text-align:center"></span>
      </button>
    </div>
    
    <!-- Widok: Pozycje magazynowe -->
    <div id="wh-view-items">
      <div class="row" style="gap:16px;margin-bottom:16px">
        <input type="text" id="wh-search" placeholder="üîç Szukaj pozycji..." style="flex:1" spellcheck="true" lang="pl">
      </div>
      <div class="list" id="wh-list"></div>
    </div>
    
    <!-- Widok: Praca magazyniera (ZUNIFIKOWANY) -->
    <div id="wh-view-work" class="hidden">
      <div style="margin-bottom:16px;padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:4px">
        <div style="font-weight:600;font-size:16px;color:#1e40af;margin-bottom:4px">üì¶ Praca magazyniera</div>
        <div style="font-size:14px;color:#64748b">Kompletuj materia≈Çy dla zlece≈Ñ produkcyjnych i zarzƒÖdzaj dodatkowymi zadaniami magazynowymi.</div>
      </div>
      
      <!-- Panel wyboru aktywnego magazyniera -->
      <div class="card" style="margin-bottom:16px;padding:14px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <div style="font-size:12px;opacity:0.9;margin-bottom:4px">üë§ Aktywny magazynier:</div>
            <div id="active-warehouseman-display" style="font-size:18px;font-weight:700">
              <span id="active-warehouseman-name">Nie wybrano</span>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="active-warehouseman-select" onchange="setActiveWarehouseman()" style="padding:10px 14px;border-radius:8px;border:2px solid white;background:white;color:#0f172a;font-weight:600;font-size:14px;min-width:200px">
              <option value="">‚Äî Wybierz magazyniera ‚Äî</option>
            </select>
            <button class="btn" onclick="clearActiveWarehouseman()" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;padding:10px 16px">‚úï Wyczy≈õƒá</button>
          </div>
        </div>
        <div id="active-warehouseman-stats" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.3)">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;font-size:13px">
            <div>
              <div style="opacity:0.8">üìã Przypisanych zada≈Ñ:</div>
              <div style="font-size:20px;font-weight:700" id="active-wh-task-count">0</div>
            </div>
            <div>
              <div style="opacity:0.8">‚è≥ Do wykonania:</div>
              <div style="font-size:20px;font-weight:700" id="active-wh-pending-count">0</div>
            </div>
            <div>
              <div style="opacity:0.8">‚úÖ Uko≈Ñczonych:</div>
              <div style="font-size:20px;font-weight:700" id="active-wh-completed-count">0</div>
            </div>
            <div>
              <div style="opacity:0.8">üìû Telefon:</div>
              <div style="font-size:16px;font-weight:600" id="active-wh-phone">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filtry -->
      <div class="row" style="gap:8px;margin-bottom:16px">
        <button class="btn" onclick="filterWarehouseWork('orders')">üì¶ Kompletacja zlece≈Ñ</button>
        <button class="btn" onclick="filterWarehouseWork('tasks')">‚úì Zadania dodatkowe</button>
        <button class="btn" onclick="filterWarehouseWork('all')">Wszystkie</button>
        <button class="btn red" onclick="manualCleanupWarehouseTasks()" title="Usu≈Ñ puste i niewa≈ºne zadania">
          üßπ Wyczy≈õƒá puste
        </button>
        <button class="btn green" onclick="assignTaskToActiveWarehouseman()" id="assign-task-btn" style="margin-left:auto">
          ‚ûï Nowe zadanie
        </button>
      </div>
      
      <!-- Sekcja zada≈Ñ dla aktywnego magazyniera -->
      <div id="active-warehouseman-tasks-section" style="display:none;margin-bottom:24px">
        <div class="card" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:16px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:14px;opacity:0.9;margin-bottom:4px">üìã Zadania dla:</div>
              <div style="font-size:20px;font-weight:700" id="tasks-section-warehouseman-name">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:28px;font-weight:700" id="tasks-section-count">0</div>
              <div style="font-size:13px;opacity:0.9">aktywnych zada≈Ñ</div>
            </div>
          </div>
        </div>
        <div id="active-warehouseman-tasks-list"></div>
      </div>
      
      <!-- G≈Ç√≥wna lista -->
      <div class="list" id="wh-work-list"></div>
    </div>
    
    <!-- Widok: ObciƒÖ≈ºenia magazynu i zam√≥wienia -->
    <div id="wh-view-obligations" class="hidden">
      <div style="margin-bottom:16px;padding:12px;background:#fef2f2;border-left:4px solid #dc2626;border-radius:4px">
        <div style="font-weight:600;font-size:16px;color:#991b1b;margin-bottom:4px">‚öñÔ∏è ObciƒÖ≈ºenia magazynu</div>
        <div style="font-size:14px;color:#64748b">Aktywne zlecenia obciƒÖ≈ºajƒÖ magazyn. Stany ujemne wymagajƒÖ zam√≥wie≈Ñ.</div>
      </div>
      
      <!-- Podsumowanie stan√≥w -->
      <div id="obligations-summary" style="margin-bottom:16px"></div>
      
      <!-- Filtry -->
      <div class="row" style="gap:8px;margin-bottom:16px">
        <button class="btn" onclick="filterObligations('all')">Wszystkie</button>
        <button class="btn red" onclick="filterObligations('negative')">‚ö†Ô∏è Stany ujemne</button>
        <button class="btn orange" onclick="filterObligations('low')">üìâ Niskie stany</button>
        <button class="btn green" onclick="filterObligations('ok')">‚úÖ OK</button>
        <button class="btn blue" onclick="generateOrderProposals()" style="margin-left:auto">üìã Wygeneruj propozycje zam√≥wie≈Ñ</button>
      </div>
      
      <!-- Lista obciƒÖ≈ºe≈Ñ -->
      <div class="list" id="obligations-list"></div>
    </div>
    
    <!-- Widok: Przych√≥d/Rozch√≥d -->
    <div id="wh-view-transactions" class="hidden">
      <div class="row" style="gap:8px;margin-bottom:16px">
        <button class="btn green" onclick="showTransactionModal('in')">üì• Przyjƒôcie (PZ)</button>
        <button class="btn orange" onclick="showTransactionModal('out')">üì§ Wydanie (WZ)</button>
        <select id="wh-transaction-filter" onchange="renderTransactions()" style="margin-left:auto">
          <option value="">Wszystkie</option>
          <option value="in">Tylko przyjƒôcia</option>
          <option value="out">Tylko wydania</option>
        </select>
      </div>
      <div class="list" id="wh-transactions-list"></div>
    </div>
    

    
    <!-- Widok: Szablony materia≈Çowe -->
    <div id="wh-view-templates" class="hidden">
      <div class="row" style="gap:8px;margin-bottom:16px">
        <button class="btn green" onclick="showTemplateModal()">üìë Nowy szablon</button>
        <button class="btn orange" onclick="window.migrateTemplateIds(); alert('Sprawd≈∫ konsolƒô (F12) po wyniki migracji')">üîß Napraw stare szablony</button>
        <button class="btn red" onclick="refreshAllChecklists()">‚ôªÔ∏è Od≈õwie≈º wszystkie checklisty</button>
        <button class="btn" onclick="diagnoseShablon()">üîç Diagnoza szablon√≥w</button>
      </div>
      <div class="list" id="wh-templates-list"></div>
    </div>
  </div>

  <div class="card hidden" id="p-sync">
    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <h3>üîÑ Synchronizacja z pracownikami</h3>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
      <div class="card" style="text-align: center;">
        <h4>üì§ Eksport zada≈Ñ</h4>
        <p style="color: #94a3b8; font-size: 14px; margin: 8px 0;">
          Wyeksportuj zadania produkcyjne dla aplikacji pracownik√≥w
        </p>
        <button class="btn green" onclick="exportTasksForWorkers()">üì§ Eksportuj zadania</button>
      </div>
      <div class="card" style="text-align: center;">
        <h4>üì• Import potwierdze≈Ñ</h4>
        <p style="color: #94a3b8; font-size: 14px; margin: 8px 0;">
          Zaimportuj potwierdzenia wykonania zada≈Ñ od pracownik√≥w
        </p>
        <button class="btn blue" onclick="importWorkerConfirmations()">üì• Importuj potwierdzenia</button>
      </div>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: rgba(37, 99, 235, 0.1); border-radius: 8px; border-left: 4px solid #2563eb;">
      <h4 style="margin: 0 0 8px 0; color: #2563eb;">üì± Instrukcja u≈ºycia:</h4>
      <ol style="margin: 0; padding-left: 20px; color: #94a3b8; font-size: 14px;">
        <li>Otw√≥rz aplikacjƒô <code>worker-app.html</code> na urzƒÖdzeniu pracownika</li>
        <li>Wyeksportuj zadania i prze≈õlij plik na urzƒÖdzenie</li>
        <li>Pracownik potwierdza wykonanie zada≈Ñ w aplikacji</li>
        <li>Zaimportuj potwierdzenia z powrotem do systemu g≈Ç√≥wnego</li>
      </ol>
    </div>
  </div>

  <div class="card hidden" id="p-backup">
    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <h3>üíæ Backup i Odzyskiwanie</h3>
      <div class="row" style="gap:8px">
        <button class="btn green" id="backup-create">üì¶ Utw√≥rz backup</button>
        <button class="btn blue" id="export-data">üíæ Eksportuj dane do pliku</button>
        <button class="btn amber" id="import-data">üìÅ Importuj dane z pliku</button>
        <button class="btn" id="backup-refresh">üîÑ Od≈õwie≈º listƒô</button>
        <button class="btn" id="backup-cleanup">üßπ Wyczy≈õƒá stare</button>
      </div>
    </div>

    <!-- Statystyki backup√≥w -->
    <div class="card" style="margin-bottom:16px">
      <h4>üìä Statystyki backup√≥w</h4>
      <div class="grid3" id="backup-stats">
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--acc)" id="backup-count">5</div>
          <div style="color:var(--text-secondary)">Liczba backup√≥w</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--ok)" id="backup-latest">9.11.2025, 12:14:24</div>
          <div style="color:var(--text-secondary)">Najnowszy backup</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--warn)" id="backup-size">0 KB</div>
          <div style="color:var(--text-secondary)">Ca≈Çkowity rozmiar</div>
        </div>
      </div>
    </div>

    <!-- Lista backup√≥w -->
    <div class="card" style="margin-bottom:16px">
      <h4>üìÅ Dostƒôpne backupy</h4>
      <div id="backup-list" class="list" style="max-height:300px;overflow-y:auto">
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>auto-save</strong>
              <div class="muted" style="font-size: 12px;">9.11.2025, 12:14:24</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              N/A 
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• 0</div>
            <div>üîß 0</div>
            <div>üìã 0</div>
            <div>üì¶ 0</div>
            <div>‚úÖ 0</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('door_backup_1762686864876')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('door_backup_1762686864876')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('door_backup_1762686864876')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>auto-save</strong>
              <div class="muted" style="font-size: 12px;">9.11.2025, 12:09:22</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              N/A 
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• 0</div>
            <div>üîß 0</div>
            <div>üìã 0</div>
            <div>üì¶ 0</div>
            <div>‚úÖ 0</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('door_backup_1762686562914')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('door_backup_1762686562914')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('door_backup_1762686562914')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>auto-save</strong>
              <div class="muted" style="font-size: 12px;">9.11.2025, 12:08:48</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              N/A 
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• 0</div>
            <div>üîß 0</div>
            <div>üìã 0</div>
            <div>üì¶ 0</div>
            <div>‚úÖ 0</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('door_backup_1762686528332')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('door_backup_1762686528332')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('door_backup_1762686528332')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>auto-save-forced</strong>
              <div class="muted" style="font-size: 12px;">9.11.2025, 12:08:28</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              N/A 
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• 0</div>
            <div>üîß 0</div>
            <div>üìã 0</div>
            <div>üì¶ 0</div>
            <div>‚úÖ 0</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('door_backup_1762686508177')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('door_backup_1762686508177')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('door_backup_1762686508177')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>auto-save</strong>
              <div class="muted" style="font-size: 12px;">9.11.2025, 12:04:39</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              N/A 
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• 0</div>
            <div>üîß 0</div>
            <div>üìã 0</div>
            <div>üì¶ 0</div>
            <div>‚úÖ 0</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('door_backup_1762686279715')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('door_backup_1762686279715')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('door_backup_1762686279715')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Opcje backupu -->
    <div class="card">
      <h4>‚öôÔ∏è Opcje backupu</h4>
      <div class="grid2" style="margin-top:12px">
        <div>
          <label><input type="checkbox" id="backup-include-settings" checked="" spellcheck="true" lang="pl"> Do≈ÇƒÖcz ustawienia aplikacji</label>
        </div>
        <div>
          <label><input type="checkbox" id="backup-include-logs" checked="" spellcheck="true" lang="pl"> Do≈ÇƒÖcz historiƒô operacji</label>
        </div>
        <div>
          <label><input type="checkbox" id="backup-compress" checked="" spellcheck="true" lang="pl"> Kompresuj backup (ZIP)</label>
        </div>
        <div>
          <label><input type="checkbox" id="backup-auto-cleanup" spellcheck="true" lang="pl"> Automatyczne czyszczenie starych backup√≥w</label>
        </div>
      </div>

      <div style="margin-top:16px">
        <label>Maksymalna liczba backup√≥w do przechowywania:</label>
        <select id="backup-max-count" style="margin-left:8px;padding:4px">
          <option value="5">5</option>
          <option value="10" selected="">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="unlimited">Bez limitu</option>
        </select>
      </div>

      <div style="margin-top:16px;text-align:right">
        <button class="btn" id="backup-settings-save">üíæ Zapisz ustawienia</button>
      </div>
    </div>

    <!-- Informacje o bezpiecze≈Ñstwie -->
    <div class="card" style="margin-top:16px;background:#1a2332;border:1px solid #334155">
      <h4>üîí Bezpiecze≈Ñstwo danych</h4>
      <ul style="margin:8px 0;padding-left:20px">
        <li>Backupy sƒÖ przechowywane lokalnie w przeglƒÖdarce</li>
        <li>Dane sƒÖ kompresowane i zabezpieczone</li>
        <li>Mo≈ºna eksportowaƒá backupy jako pliki do zewnƒôtrznego przechowywania</li>
        <li>Zaleca siƒô regularne tworzenie backup√≥w przed wa≈ºnymi zmianami</li>
      </ul>
    </div>
  </div>

  <div class="card hidden" id="p-gantt">
    <div class="row" style="justify-content:space-between">
      <h3>Harmonogram Produkcji (Gantt)</h3>
      <div class="row">
        <button class="btn" id="gantt-prev-period" title="Poprzedni tydzie≈Ñ/miesiƒÖc">‚óÑ Wstecz</button>
        <button class="btn" id="gantt-today" title="Dzisiaj">Dzisiaj</button>
        <button class="btn" id="gantt-next-period" title="Nastƒôpny tydzie≈Ñ/miesiƒÖc">Dalej ‚ñ∫</button>
        <select id="gantt-view">
          <option value="week">Widok tygodniowy</option>
          <option value="month">Widok miesiƒôczny</option>
        </select>
  <button class="btn" id="gantt-refresh">Od≈õwie≈º</button>
  <button class="btn amber" id="gantt-replan-all" title="Resetuj i przelicz wszystkie zadania z uwzglƒôdnieniem aktualnej konfiguracji">Przelicz harmonogram</button>
        <button class="btn" id="gantt-auto-assign">Auto-przypisz</button>
        <button class="btn" id="gantt-generate-test">Generuj dane testowe</button>
        <button class="btn" id="gantt-export">Eksport PNG</button>
        <button class="btn" id="gantt-show-dependencies" title="Poka≈º/ukryj zale≈ºno≈õci miƒôdzy zadaniami">üìä Zale≈ºno≈õci</button>
        <button class="btn" id="gantt-create-dependency" title="Utw√≥rz zale≈ºno≈õƒá miƒôdzy zadaniami">üîó Utw√≥rz zale≈ºno≈õƒá</button>
        <button class="btn" id="gantt-manage-dependencies" title="ZarzƒÖdzaj zale≈ºno≈õciami">üìã ZarzƒÖdzaj</button>
        <button class="btn" id="gantt-show-critical-path" title="Poka≈º/ukryj ≈õcie≈ºkƒô krytycznƒÖ">üéØ ≈öcie≈ºka krytyczna</button>
      </div>
    </div>
    <div class="row" style="padding:8px;gap:8px;align-items:center;background:#f1f5f9;border-radius:4px;margin-bottom:8px">
      <span style="font-size:12px;color:#64748b">Zaznaczone zadanie:</span>
      <span id="gantt-selected-task-info" style="font-size:12px;font-weight:600;color:#1e293b;flex:1">Brak</span>
      <button class="btn" id="gantt-move-task-back" title="Przesu≈Ñ zadanie o 1 dzie≈Ñ wstecz" disabled="">‚óÑ -1 dzie≈Ñ</button>
      <button class="btn" id="gantt-move-task-forward" title="Przesu≈Ñ zadanie o 1 dzie≈Ñ do przodu" disabled="">+1 dzie≈Ñ ‚ñ∫</button>
      <button class="btn amber" id="gantt-clear-selection" title="Odznacz zadanie" disabled="">Odznacz</button>
    </div>
    <div id="gantt-container" class="gantt-container" style="">
      <div class="gantt-header">
        <div class="gantt-resource-column">Zas√≥b</div>
        <div class="gantt-timeline" id="gantt-timeline"><div class="gantt-time-slot" style="background: rgba(239, 68, 68, 0.1); border-right: 2px solid rgb(239, 68, 68);"><div style="font-size:10px">niedz.</div><div style="font-weight:600">9 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">pon.</div><div style="font-weight:600">10 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">wt.</div><div style="font-weight:600">11 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">≈õr.</div><div style="font-weight:600">12 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">czw.</div><div style="font-weight:600">13 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">pt.</div><div style="font-weight:600">14 lis</div></div><div class="gantt-time-slot"><div style="font-size:10px">sob.</div><div style="font-weight:600">15 lis</div></div></div>
      </div>
      <div class="gantt-body" id="gantt-body"><svg id="gantt-dependencies" style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></svg><div class="gantt-row"><div class="gantt-resource-cell">PIOTR</div><div class="gantt-task-cell" data-employee-id="id-mhqk06bsnq8n"><div class="gantt-task planned" data-task-id="id-mhrm78jblv5y" style="font-size: 11px; width: 104.286px; position: absolute; left: 1605px;" title="Monta≈º: 5003
Status: planned
Czas: 60min
Pracownik: PIOTR" draggable="true">Monta≈º: 5003</div><div class="gantt-task todo" data-task-id="task-mhrm6hha6xw1" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Szczotkowanie (futryna)
Status: todo
Czas: 12min
Pracownik: PIOTR" draggable="true">Szczotkowanie...</div><div class="gantt-task todo" data-task-id="task-mhrm6hhazcrw" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Frezowanie na CNC (belki futryny)
Status: todo
Czas: 40min
Pracownik: PIOTR" draggable="true">Frezowanie na...</div></div></div><div class="gantt-row"><div class="gantt-resource-cell">TOMASZ</div><div class="gantt-task-cell" data-employee-id="id-mhqmea04frcw"><div class="gantt-task planned" data-task-id="id-mhrm78jfpxry" style="font-size: 11px; width: 104.286px; position: absolute; left: 1605px;" title="Monta≈º: 5003
Status: planned
Czas: 60min
Pracownik: TOMASZ" draggable="true">Monta≈º: 5003</div><div class="gantt-task todo" data-task-id="task-mhrm6hha4bet" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Malowanie (futryna)
Status: todo
Czas: 30min
Pracownik: TOMASZ" draggable="true">Malowanie (fu...</div><div class="gantt-task todo" data-task-id="task-mhrm6hhabb1m" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Sklejanie belek (futryna)
Status: todo
Czas: 20min
Pracownik: TOMASZ" draggable="true">Sklejanie bel...</div></div></div><div class="gantt-row"><div class="gantt-resource-cell">BOGDAN</div><div class="gantt-task-cell" data-employee-id="id-mhqnovqwkchl"><div class="gantt-task todo" data-task-id="task-mhrm6hha8eqp" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Kontrola wymiar√≥w (futryna)
Status: todo
Czas: 10min
Pracownik: BOGDAN" draggable="true">Kontrola wymi...</div><div class="gantt-task todo" data-task-id="task-mhrm6hhaakd5" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Okuwanie (futryna)
Status: todo
Czas: 8min
Pracownik: BOGDAN" draggable="true">Okuwanie (fut...</div></div></div><div class="gantt-row"><div class="gantt-resource-cell">MALINA</div><div class="gantt-task-cell" data-employee-id="id-mhqnp31ihfrw"><div class="gantt-task todo" data-task-id="task-mhrm6hhac91d" style="font-size: 10px; width: 104.286px; position: absolute; left: 5px;" title="Szlifowanie (futryna)
Status: todo
Czas: 15min
Pracownik: MALINA" draggable="true">Szlifowanie (...</div></div></div><div class="gantt-current-time" style="left: 258.571px; height: 100%; pointer-events: none;"></div></div>
    </div>
  </div>

  <div class="card hidden" id="p-capacity">
    <div class="row" style="justify-content:space-between">
      <h3>Analiza Przepustowo≈õci Produkcji</h3>
      <div class="row">
        <select id="capacity-period">
          <option value="day">Dzie≈Ñ</option>
          <option value="week" selected="">Tydzie≈Ñ</option>
          <option value="month">MiesiƒÖc</option>
        </select>
        <button class="btn" id="capacity-refresh">Od≈õwie≈º</button>
        <button class="btn" id="capacity-optimize">üîÑ Optymalizuj obciƒÖ≈ºenie</button>
        <button class="btn" id="capacity-export">Eksport CSV</button>
      </div>
    </div>

    <div class="grid2" style="margin-top: 16px;">
      <div class="card">
        <h4>Wykorzystanie Zasob√≥w</h4>
        <div id="capacity-resources" class="list"></div>
      </div>

      <div class="card">
        <h4>WƒÖskie Gard≈Ça</h4>
        <div id="capacity-bottlenecks" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h4>Efektywno≈õƒá Produkcji</h4>
      <div id="capacity-efficiency" class="list"></div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h4>üí° Sugestie optymalizacji obciƒÖ≈ºenia</h4>
      <div id="capacity-optimization" class="list"></div>
    </div>

    <!-- Raport konflikt√≥w zasob√≥w -->
    <div id="conflict-report" style="margin-top: 16px; display: none;"></div>
  </div>

  <div class="card" id="p-settings">
    <div class="row" style="justify-content:space-between"><h3>Ustawienia</h3></div>
    
    <div id="high-contrast-toggle-wrapper">
      <label><input type="checkbox" id="toggle-high-contrast" spellcheck="true" lang="pl"> Wysoki kontrast ostrze≈ºe≈Ñ</label>
    </div>
    
    <div class="grid3">
      <div><label>Tryb</label><select id="set-mode"><option value="local">localStorage</option><option value="firebase" selected="">Firebase</option></select></div>
	<div><label>PoczƒÖtek dnia (h)</label><input id="sched-start" type="number" min="0" max="23" value="7" spellcheck="true" lang="pl"></div>
	<div><label>D≈Çugo≈õƒá dnia (h)</label><input id="sched-len" type="number" min="1" max="16" value="8" spellcheck="true" lang="pl"></div>
      <div><label>App ID</label><input id="set-appid" value="doors-demo" spellcheck="true" lang="pl"></div>
      <div><label>User ID</label><input id="set-userid" value="hala-1" spellcheck="true" lang="pl"></div>
      <div style="grid-column:1/4;margin-top:8px">
        <fieldset style="border:1px solid #334155;padding:8px;border-radius:4px">
          <legend style="padding:0 6px;font-size:13px">Dni wolne tygodnia</legend>
          <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:13px">
            <label><input type="checkbox" class="sched-offday" value="1" spellcheck="true" lang="pl"> Poniedzia≈Çek (1)</label>
            <label><input type="checkbox" class="sched-offday" value="2" spellcheck="true" lang="pl"> Wtorek (2)</label>
            <label><input type="checkbox" class="sched-offday" value="3" spellcheck="true" lang="pl"> ≈öroda (3)</label>
            <label><input type="checkbox" class="sched-offday" value="4" spellcheck="true" lang="pl"> Czwartek (4)</label>
            <label><input type="checkbox" class="sched-offday" value="5" spellcheck="true" lang="pl"> PiƒÖtek (5)</label>
            <label><input type="checkbox" class="sched-offday" value="6" spellcheck="true" lang="pl"> Sobota (6)</label>
            <label><input type="checkbox" class="sched-offday" value="0" spellcheck="true" lang="pl"> Niedziela (0)</label>
          </div>
          <div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn tiny" id="btn-offdays-weekend">Weekend</button>
            <button type="button" class="btn tiny" id="btn-offdays-workweek">Tylko weekend</button>
            <button type="button" class="btn tiny" id="btn-offdays-clear">Wyczy≈õƒá</button>
            <span style="font-size:11px;color:#94a3b8">Zaznaczone dni sƒÖ POMIJANE w planowaniu (Date.getDay(): Niedziela=0 ... Sobota=6)</span>
          </div>
        </fieldset>
      </div>
      <div style="grid-column:1/4;margin-top:8px">
        <label style="display:block;font-size:13px;margin-bottom:4px">≈öwiƒôta / dodatkowe dni wolne (YYYY-MM-DD, po przecinku)</label>
        <textarea id="sched-holidays" rows="2" placeholder="2025-11-01,2025-12-25" style="width:100%;resize:vertical" spellcheck="true" lang="pl"></textarea>
      </div>
    </div>
  <div class="list" style="margin-top:8px">
      <label>Firebase config (JSON)</label>
      <textarea id="set-fb" rows="8" spellcheck="true" lang="pl">{
  "apiKey": "AIzaSyD93UqqsHWoAUBV7g8OVKAnajIfGDX_ZdY",
  "authDomain": "doors-planner.firebaseapp.com",
  "projectId": "doors-planner",
  "storageBucket": "doors-planner.appspot.com",
  "messagingSenderId": "513098608067",
  "appId": "1:513098608067:web:1fe3855b3470ca7ef22176"
}</textarea>
      <div class="row">
        <button class="btn primary" id="set-test">Test &amp; Connect</button>
        <button class="btn green" id="set-save">Zapisz do DB</button>
        <button class="btn" id="set-load">Wczytaj z DB</button>
      </div>
      <div class="row" style="margin-top:8px">
  <label style="font-size:13px"><input type="checkbox" id="set-autosave-assign" checked="" spellcheck="true" lang="pl"> Auto-save do Firebase przy wa≈ºnych zmianach (np. przypisania)</label>
      </div>
    <div class="row" style="margin-top:8px">
  <label style="font-size:13px"><input type="checkbox" id="set-autoload-db" spellcheck="true" lang="pl"> Automatycznie wczytaj z Firebase przy starcie (je≈õli tryb = Firebase)</label>
    </div>
      <div class="row" style="margin-top:8px">
        <label style="font-size:13px">Threshold wƒÖskich garde≈Ç: <input id="set-monitor-threshold" type="number" min="1" value="5" style="width:80px;margin-left:8px" spellcheck="true" lang="pl"></label>
      </div>
      <div class="row" style="margin-top:8px">
        <label style="font-size:13px"><input type="checkbox" id="set-monitor-alerts" checked="" spellcheck="true" lang="pl"> W≈ÇƒÖcz alerty monitoringu (baner gdy threshold przekroczony)</label>
      </div>
    <div class="row" style="margin-top:8px">
      <label style="font-size:13px"><input type="checkbox" id="set-auto-cleanup" spellcheck="true" lang="pl"> Automatyczne czyszczenie zlece≈Ñ (usu≈Ñ zadania po zamkniƒôciu wszystkich)</label>
    </div>
    <div class="row" style="margin-top:8px">
  <label style="font-size:13px"><input type="checkbox" id="set-spellcheck-enforce" spellcheck="true" lang="pl"> Wymuszaj sprawdzanie pisowni (PL) dla wszystkich p√≥l</label>
    </div>
      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn" id="export-tasks">Eksport zada≈Ñ (.json)</button>
        <input type="file" id="import-tasks-file" accept=".json" style="display:none" spellcheck="true" lang="pl">
        <button class="btn" id="import-tasks">Import zada≈Ñ</button>
        <button class="btn green" id="force-load-firebase" title="Wymu≈õ pobranie danych z Firebase (nadpisze lokalne)">‚¨áÔ∏è Pobierz z Firebase</button>
        <button class="btn orange" id="save-version-btn" title="Zapisz kopiƒô aplikacji do folderu backups">üíæ Zapisz wersjƒô</button>
        <button class="btn red" id="restore-authentic-data" title="Przywr√≥ƒá autentyczne dane z backupu">üîÑ Przywr√≥ƒá dane</button>
        <button class="btn blue" id="restore-click-delegation" title="Przywr√≥ƒá normalnƒÖ obs≈Çugƒô klikniƒôƒá">üîß Napraw klikniƒôcia</button>
      </div>
      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn green" id="gen-test-data">Zaktualizuj dane testowe</button>
        <button class="btn blue" id="gen-deadline-test">Dodaj zam√≥wienia testowe</button>
        <button class="btn red" id="clear-test-employees" title="Usu≈Ñ wszystkie testowe dane z Firebase (pracownicy, zlecenia, zadania/listy)">üóëÔ∏è Wyczy≈õƒá testowe listy Firebase</button>
        <button class="btn" id="export-data">Eksportuj dane</button>
        <button class="btn" id="import-data">Importuj dane</button>
        <button class="btn red" id="clear-data">Wyczy≈õƒá dane</button>
        <button class="btn orange" id="cleanup-operations" title="Usu≈Ñ duplikaty operacji z Firebase i zsynchronizuj">üßπ Wyczy≈õƒá duplikaty operacji</button>
      </div>
      <div id="set-info" style="color: rgb(255, 255, 255); font-weight: 600; font-size: 14px; background: rgb(5, 150, 105); padding: 4px 8px; border-radius: 4px; border: 1px solid rgb(51, 65, 85);">‚úÖ Zapisano kolekcje do DB.</div>
    </div>
  </div>
</div>

<!-- Raporty produkcyjne -->
<div class="card hidden" id="p-reports">
  <div class="row" style="justify-content:space-between;margin-bottom:16px">
    <h3>Raporty produkcyjne</h3>
    <div class="row" style="gap:8px">
      <select id="report-period" style="padding:6px 8px;border-radius:6px;border:1px solid var(--b)">
        <option value="week">Tydzie≈Ñ</option>
        <option value="month">MiesiƒÖc</option>
        <option value="quarter">Kwarta≈Ç</option>
        <option value="year">Rok</option>
      </select>
      <button class="btn" id="report-generate-test">Generuj dane testowe</button>
      <button class="btn" id="report-generate">üìä Generuj raport</button>
      <button class="btn" id="report-export">üìÑ Eksport PDF</button>
    </div>
  </div>

  <div id="reports-content">
    <!-- Progress bar -->
    <div id="reports-progress" class="card hidden" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <span id="reports-progress-text">Generowanie raportu...</span>
        <span id="reports-progress-percent">0%</span>
      </div>
      <div style="width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden">
        <div id="reports-progress-bar" style="width:0%;height:100%;background:linear-gradient(90deg,#3b82f6,#1d4ed8);transition:width 0.3s ease"></div>
      </div>
    </div>

    <!-- Statystyki og√≥lne -->
    <div class="card" style="margin-bottom:16px">
      <h4>üìà Statystyki produkcji</h4>
      <div class="grid3" id="report-stats">
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--acc)" id="stat-total-orders">0</div>
          <div style="color:var(--text-secondary)">Zlece≈Ñ</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--ok)" id="stat-completed-tasks">0</div>
          <div style="color:var(--text-secondary)">Uko≈Ñczonych zada≈Ñ</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:24px;font-weight:bold;color:var(--warn)" id="stat-efficiency">0%</div>
          <div style="color:var(--text-secondary)">Efektywno≈õƒá</div>
        </div>
      </div>
    </div>

    <!-- Wykresy wydajno≈õci -->
    <div class="card" style="margin-bottom:16px">
      <h4>üìä Wydajno≈õƒá pracownik√≥w</h4>
      <div id="report-employee-performance" style="height:300px">
        <div class="empty">Wybierz okres i kliknij "Generuj raport"</div>
      </div>
    </div>

    <!-- Raport koszt√≥w -->
    <div class="card" style="margin-bottom:16px">
      <h4>üí∞ Koszty produkcji</h4>
      <div id="report-costs">
        <div class="empty">Wybierz okres i kliknij "Generuj raport"</div>
      </div>
    </div>

    <!-- Szczeg√≥≈Çowe statystyki -->
    <div class="card">
      <h4>üìã Szczeg√≥≈Çowe statystyki</h4>
      <div id="report-details" class="table">
        <div class="empty">Wybierz okres i kliknij "Generuj raport"</div>
      </div>
    </div>
  </div>
</div>

<div id="client-window" class="hidden">
  <!-- Szczeg√≥≈Çy klienta bƒôdƒÖ renderowane dynamicznie -->
</div>

<!-- Wczytanie podstawowych utili oraz UI zanim g≈Ç√≥wny skrypt inline uruchomi diagnostykƒô -->
<script src="js/backup-manager.js?v=20251101-0100"></script>
<script src="js/base-utils.js?v=20251005-1400"></script>
<script src="js/store.js?v=20251005-1400"></script>
<script src="js/ui.js?v=20251005-1415"></script>
<script src="js/schedule.js?v=20251116-2050"></script>
<script src="js/app-helpers.js?v=20251005-1400"></script>
<script src="js/map.js?v=20251019-01"></script>
<script src="js/auto-save.js?v=20251106-0900"></script>
<!-- Centralny Magazyn Stanu -->
<script src="state/CentralnyMagazynStanu.js"></script>
<script>
// === INICJALIZACJA CENTRALNEGO MAGAZYNU STANU ===
console.log('üöÄ Inicjalizacja Centralnego Magazynu Stanu...');
const centralnyMagazyn = CentralnyMagazynStanu.getInstance();
window.centralnyMagazyn = centralnyMagazyn; // Dostƒôp globalny
console.log('üìä Aktualny stan aplikacji:', centralnyMagazyn.getStan());
</script>
<!-- Integracja Magazynu z Procesami Biznesowymi -->
<script src="state/integration.js"></script>
<!-- Monitoring Produkcyjny -->
<script src="state/production-monitor.js"></script>
<script>
// === MAGAZYN - NAJWY≈ªSZY PRIORYTET ===
// System magazynowy zostanie zainicjalizowany p√≥≈∫niej w kodzie
console.log('Magazyn: Inicjalizacja systemu zarzƒÖdzania magazynem...');

// Kod automatycznego renderowania magazynu usuniƒôty

(function(){
  // create on-page developer log panel with visible toggle so user can read logs without DevTools
  try{
    const initDevLog = ()=>{
      const devLogEl = document.createElement('div');
      devLogEl.id = 'dev-log';
      Object.assign(devLogEl.style, {
        position: 'fixed', right: '12px', bottom: '48px', maxWidth: '420px', maxHeight: '40vh', overflow: 'auto',
        background: 'rgba(8,8,12,0.95)', color: '#cbd5e1', padding: '8px', borderRadius: '8px', fontSize: '12px', zIndex: '99999', boxShadow: '0 6px 18px rgba(0,0,0,.5)', border: '1px solid rgba(255,255,255,0.04)'
      });
      devLogEl.innerHTML = '<b style="display:block;margin-bottom:6px">Dev log</b>';

      const toggle = document.createElement('button');
      toggle.type = 'button'; toggle.id = 'dev-log-toggle'; toggle.textContent = 'DevLog';
      Object.assign(toggle.style, { position:'fixed', right:'12px', bottom:'12px', zIndex:'100000', padding:'8px 10px', borderRadius:'8px', border:'1px solid rgba(0,0,0,0.2)', background:'#f59e0b', color:'#071019', fontWeight:'700', cursor:'pointer', boxShadow:'0 6px 18px rgba(245,158,11,0.12)' });
      toggle.addEventListener('click', ()=>{
        if(document.body.contains(devLogEl)){ document.body.removeChild(devLogEl); toggle.textContent='DevLog'; } else { document.body.appendChild(devLogEl); toggle.textContent='Hide'; }
      });

      // ensure we don't append duplicates
      if(!document.getElementById('dev-log-toggle')) document.body.appendChild(toggle);
      if(!document.getElementById('dev-log')) document.body.appendChild(devLogEl);

      window.logDev = function(){
        try{
          // Respect runtime flag: state.storage.devLogEnabled === false disables dev logging
          const enabled = !(window.state && window.state.storage && window.state.storage.devLogEnabled === false);
          if(!enabled) return;
          const args = Array.from(arguments).map(a=> (typeof a==='object'?JSON.stringify(a):String(a)) );
          const line = document.createElement('div');
          line.textContent = args.join(' ');
          devLogEl.appendChild(line);
          devLogEl.scrollTop = devLogEl.scrollHeight;
          console.log.apply(console, arguments);
        }catch(_){ try{ console.log.apply(console, arguments); }catch(__){} }
      };
      // alias for simpler calls
      window.plog = window.logDev;
    };
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initDevLog); else initDevLog();
  }catch(_){/* ignore */}

  const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));

  // Emergency focus unlock function - make it available immediately
  window.unlockFocus = function(){
    console.log('Attempting to unlock focus...');
    
    // Hide any visible modals
    ['app-confirm-modal', 'app-preview-modal', '__scroll_debug_overlay'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = 'none';
        console.log('Hidden modal:', id);
      }
    });
    
    // Remove any focus locks
    document.body.style.pointerEvents = '';
    document.body.style.userSelect = '';
    
    // Try to focus on a safe element
    try {
      const safeElement = document.querySelector('input, button, [tabindex]');
      if (safeElement) {
        safeElement.focus();
        console.log('Focused on safe element');
      }
    } catch (e) {
      console.warn('Could not focus on safe element:', e);
    }
    
    console.log('Focus unlock attempt completed');
  };

  // Emergency click diagnostics & recovery
  window.diagnoseClicks = function(){
    try{
      const report = [];
      // 1. Sprawd≈∫ globalne style blokujƒÖce interakcje
      const bodyPE = getComputedStyle(document.body).pointerEvents;
      const bodyUS = getComputedStyle(document.body).userSelect;
      if(bodyPE === 'none') report.push('[!] body ma pointer-events:none');
      if(bodyUS === 'none') report.push('[!] body ma user-select:none');

      // 2. Poszukaj du≈ºych, potencjalnie zas≈ÇaniajƒÖcych element√≥w z pointer-events:auto
      const vw = window.innerWidth, vh = window.innerHeight;
      const blockers = [];
      document.querySelectorAll('body *').forEach(el=>{
        try{
          const st = getComputedStyle(el);
            if(st.display==='none' || st.visibility==='hidden' || st.opacity==='0') return;
            if(st.pointerEvents==='none') return;
            const r = el.getBoundingClientRect();
            if(r.width > vw*0.8 && r.height > vh*0.8 && r.top <= 0 && r.left <= 0){
              blockers.push({tag:el.tagName, cls:el.className, id:el.id, w:Math.round(r.width), h:Math.round(r.height), z:st.zIndex});
            }
        }catch(_){/* ignore */}
      });
      if(blockers.length) report.push('[!] Mo≈ºliwe elementy zas≈ÇaniajƒÖce: '+ blockers.map(b=>`${b.tag}#${b.id}.${b.cls} ${b.w}x${b.h} z=${b.z}`).join('; '));

      // 3. Test elementFromPoint
      const midEl = document.elementFromPoint(vw/2, vh/2);
      if(midEl) report.push('[i] elementFromPoint(≈õrodek): '+ midEl.tagName + (midEl.id?('#'+midEl.id):''));

      // 4. Szybki test czy listener dzia≈Ça (syntetyczny click)
      let syntheticOk = false;
      const testBtn = document.createElement('button');
      testBtn.textContent='__test_click__';
      testBtn.style.position='fixed'; testBtn.style.top='4px'; testBtn.style.left='4px'; testBtn.style.zIndex=999999; testBtn.style.opacity='0.4';
      testBtn.addEventListener('click', ()=>{ syntheticOk = true; console.log('[diagnoseClicks] Syntetyczny click dotar≈Ç do listenera.'); setTimeout(()=>testBtn.remove(), 50); });
      document.body.appendChild(testBtn);
      testBtn.click();
      setTimeout(()=>{ if(!syntheticOk){ console.warn('[diagnoseClicks] WyglƒÖda jakby eventy click nie by≈Çy obs≈Çugiwane (brak reakcji listenera).'); } }, 100);

      if(!report.length) report.push('[OK] Nie znaleziono oczywistych blokad.');
      console.log('[diagnoseClicks] Raport:', report.join('\n'));
      return report;
    }catch(e){ console.error('[diagnoseClicks] B≈ÇƒÖd', e); return ['error:'+e.message]; }
  };

  window.recoverClicks = function(){
    try{
      console.log('[recoverClicks] Pr√≥ba odblokowania zdarze≈Ñ...');
      // NAJWA≈ªNIEJSZE: Przywr√≥ƒá normalnƒÖ delegacjƒô klikniƒôƒá
      window.restoreNormalClickDelegation();
      document.body.style.pointerEvents='auto';
      document.body.style.userSelect='auto';
      // Usu≈Ñ ewentualne pe≈Çnoekranowe warstwy debug / modal z atrybutem data-block-ui
      document.querySelectorAll('[data-block-ui]')?.forEach(el=>{ el.remove(); });
      // Schowaj potencjalne modale
      ['app-confirm-modal','app-preview-modal','__scroll_debug_overlay'].forEach(id=>{ const el = document.getElementById(id); if(el){ el.style.display='none'; } });
      // Wyczy≈õƒá style inline blokujƒÖce pointer events dla .hidden (czasem nadpisane przez b≈Çƒôdny CSS)
      document.querySelectorAll('.hidden').forEach(el=>{ el.style.pointerEvents='none'; });
      // Dodaj delikatny znacznik powodzenia
      const tag = document.createElement('div');
      tag.textContent='[clicks recovered]';
      Object.assign(tag.style,{position:'fixed',bottom:'4px',right:'6px',background:'#059669',color:'#fff',padding:'4px 8px',borderRadius:'6px',fontSize:'11px',zIndex:999999});
      document.body.appendChild(tag); setTimeout(()=>tag.remove(), 2500);
      console.log('[recoverClicks] Zako≈Ñczono');
    }catch(e){ console.error('[recoverClicks] B≈ÇƒÖd', e); }
  };

  // Skr√≥t klawiszowy: Ctrl+Alt+K -> diagnoza, Ctrl+Alt+R -> pr√≥ba naprawy
  window.addEventListener('keydown', (ev)=>{
    if(ev.ctrlKey && ev.altKey && ev.key.toLowerCase()==='k'){ diagnoseClicks(); }
    if(ev.ctrlKey && ev.altKey && ev.key.toLowerCase()==='r'){ recoverClicks(); }
  });

  // Validation functions
  function validateOrderForm() {
    const errors = [];
    const name = qs('#o-name').value.trim();
    const qty = parseInt(qs('#o-qty').value) || 0;
    const startDate = qs('#o-start').value;
    const endDate = qs('#o-end').value;

    if (!name) errors.push('Nazwa zam√≥wienia jest wymagana');
    if (name.length < 3) errors.push('Nazwa zam√≥wienia musi mieƒá co najmniej 3 znaki');
    if (qty <= 0) errors.push('Ilo≈õƒá musi byƒá wiƒôksza od 0');
    if (qty > 1000) errors.push('Ilo≈õƒá nie mo≈ºe przekraczaƒá 1000');

    if (startDate && endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      if (start > end) errors.push('Data rozpoczƒôcia nie mo≈ºe byƒá p√≥≈∫niejsza ni≈º data zako≈Ñczenia');
    }

    // Check for duplicate names (optional)
    const existingOrder = state.orders.find(o => o.name.toLowerCase() === name.toLowerCase() && o.id !== qs('#o-id').value);
    if (existingOrder) errors.push('Zam√≥wienie o tej nazwie ju≈º istnieje');

    return errors;
  }

  function validateEmployeeForm() {
    const errors = [];
    const name = qs('#emp-name').value.trim();
    const capacity = parseInt(qs('#emp-cap').value) || 0;
    const hoursPerDay = parseInt(qs('#emp-hours').value) || 0;

    if (!name) errors.push('Imiƒô i nazwisko pracownika jest wymagane');
    if (name.length < 2) errors.push('Imiƒô i nazwisko musi mieƒá co najmniej 2 znaki');
    if (capacity <= 0 || capacity > 100) errors.push('Wydajno≈õƒá musi byƒá miƒôdzy 1 a 100');
    if (hoursPerDay <= 0 || hoursPerDay > 24) errors.push('Godziny pracy dziennie muszƒÖ byƒá miƒôdzy 1 a 24');

    // Check for duplicate names
    const existingEmp = state.employees.find(e => e.name.toLowerCase() === name.toLowerCase() && e.id !== qs('#emp-id').value);
    if (existingEmp) errors.push('Pracownik o tym imieniu i nazwisku ju≈º istnieje');

    return errors;
  }

  function showValidationErrors(errors) {
    // Remove existing error messages
    const existingErrors = document.querySelectorAll('.validation-error');
    existingErrors.forEach(el => el.remove());

    if (errors.length === 0) return;

    // Create error message container
    const errorDiv = document.createElement('div');
    errorDiv.className = 'validation-error card error';
    errorDiv.innerHTML = '<h4>B≈Çƒôdy walidacji:</h4><ul>' + errors.map(err => `<li>${err}</li>`).join('') + '</ul>';

    // Insert at the top of the current panel
    const currentPanel = document.querySelector('.card:not(.hidden)');
    if (currentPanel) {
      currentPanel.insertBefore(errorDiv, currentPanel.firstChild);
    }

    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.remove();
      }
    }, 5000);
  }

  // Global search functions
  function performGlobalSearch(query) {
    if (!query || query.trim().length < 2) {
      hideSearchResults();
      return;
    }

    const results = [];
    const searchTerm = query.toLowerCase().trim();

    // Search orders
    (state.orders || []).forEach(order => {
      if (order.name && order.name.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'order',
          id: order.id,
          title: order.name,
          details: `Klient: ${order.client || 'Brak'} ‚Ä¢ Ilo≈õƒá: ${order.quantity || 0}`,
          navTarget: 'order'
        });
      }
      if (order.client && order.client.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'order',
          id: order.id,
          title: `Zam√≥wienie: ${order.name}`,
          details: `Klient: ${order.client} ‚Ä¢ Ilo≈õƒá: ${order.quantity || 0}`,
          navTarget: 'order'
        });
      }
    });

    // Search employees
    (state.employees || []).forEach(emp => {
      if (emp.name && emp.name.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'employee',
          id: emp.id,
          title: emp.name,
          details: `Wydajno≈õƒá: ${emp.cap || 100}% ‚Ä¢ Godziny: ${emp.hoursPerDay || 8}/dzie≈Ñ`,
          navTarget: 'emp'
        });
      }
    });

    // Search tasks
    (state.tasks || []).forEach(task => {
      if (task.opName && task.opName.toLowerCase().includes(searchTerm)) {
        const orderName = task.orderId ? (state.orders.find(o => o.id === task.orderId)?.name || task.orderId) : 'Brak zam√≥wienia';
        results.push({
          type: 'task',
          id: task.id,
          title: task.opName,
          details: `Zam√≥wienie: ${orderName} ‚Ä¢ Status: ${task.status || 'todo'}`,
          navTarget: 'tasks'
        });
      }
    });

    // Search processes
    (state.processes || []).forEach(proc => {
      if (proc.name && proc.name.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'process',
          id: proc.id,
          title: proc.name,
          details: `Operacji: ${(proc.operations || []).length}`,
          navTarget: 'proc'
        });
      }
    });

    // Search operations catalog
    (state.operationsCatalog || []).forEach(op => {
      if (op.name && op.name.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'operation',
          id: op.id,
          title: op.name,
          details: `Czas: ${op.time || 0}min ‚Ä¢ Nr: ${op.no || 0}`,
          navTarget: 'opcat'
        });
      }
    });

    displaySearchResults(results.slice(0, 20)); // Limit to 20 results
  }

  function displaySearchResults(results) {
    const container = qs('#search-results');
    if (!container) return;

    if (results.length === 0) {
      container.innerHTML = '<div class="search-no-results">Brak wynik√≥w wyszukiwania</div>';
      container.style.display = 'block';
      return;
    }

    const typeLabels = {
      order: 'Zam√≥wienie',
      employee: 'Pracownik',
      task: 'Zadanie',
      process: 'Proces',
      operation: 'Operacja'
    };

    container.innerHTML = results.map(result => `
      <div class="search-result-item" data-type="${result.type}" data-id="${result.id}" data-nav="${result.navTarget}">
        <div class="search-result-category">${typeLabels[result.type] || result.type}</div>
        <div class="search-result-title">${result.title}</div>
        <div class="search-result-details">${result.details}</div>
      </div>
    `).join('');

    container.style.display = 'block';
  }

  function hideSearchResults() {
    const container = qs('#search-results');
    if (container) {
      container.style.display = 'none';
    }
  }

  const storeKey='door_v50_state';
  let hasLocalStateData = false;
  const DEFAULT_FIREBASE_CONFIG = {
    "apiKey": "AIzaSyD93UqqsHWoAUBV7g8OVKAnajIfGDX_ZdY",
    "authDomain": "doors-planner.firebaseapp.com",
    "projectId": "doors-planner",
    "storageBucket": "doors-planner.appspot.com",
    "messagingSenderId": "513098608067",
    "appId": "1:513098608067:web:1fe3855b3470ca7ef22176"
  };

  let state={storage:{mode:'firebase',appId:'doors-demo',userId:'hala-1',fbConfig:JSON.parse(JSON.stringify(DEFAULT_FIREBASE_CONFIG))},
    employees:[],operationsCatalog:[],processes:[],orders:[],tasks:[],after:[],deletedOrders:[],deletedProcesses:[],PROC_TMP:[],page:'dash',_timers:{}};
  state.uiShowTasksByEmpTable = false;
  
  // Natychmiast przypisz state do window
  window.state = state;

  const CHECKLIST_ITEM_ALLOWED_TYPES = ['checkbox','confirm','text','number','photo','measure'];
  const CHECKLIST_ITEM_DEFAULT_TYPE = 'checkbox';

  function normalizeChecklistItem(raw){
    if(typeof raw === 'string'){
      raw = { label: raw };
    }
    const base = raw && typeof raw === 'object' ? raw : {};
    const typeCandidate = typeof base.type === 'string' ? base.type.trim().toLowerCase() : '';
    const finalType = CHECKLIST_ITEM_ALLOWED_TYPES.includes(typeCandidate) ? typeCandidate : CHECKLIST_ITEM_DEFAULT_TYPE;
    const metadata = (base.metadata && typeof base.metadata === 'object') ? {...base.metadata} : {};
    return {
      id: base.id || uid('chk'),
      label: typeof base.label === 'string' ? base.label.trim() : '',
      required: !!base.required,
      type: finalType,
      defaultDone: base.defaultDone === true,
      notes: typeof base.notes === 'string' ? base.notes.trim() : '',
      hint: typeof base.hint === 'string' ? base.hint.trim() : '',
      metadata
    };
  }

  function normalizeChecklistItems(collection){
    if(!Array.isArray(collection)) return [];
    return collection.map(item => normalizeChecklistItem(item));
  }

  function createChecklistTemplate(rawTemplate, opContext){
    const base = rawTemplate && typeof rawTemplate === 'object' ? rawTemplate : {};
    const template = {
      id: base.id || uid('chk_tpl'),
      version: Number.isFinite(base.version) ? base.version : parseInt(base.version, 10) || 1,
      label: typeof base.label === 'string' ? base.label : (opContext && opContext.name) || '',
      source: base.source || 'operation',
      sourceOperationId: base.sourceOperationId || (opContext && opContext.id) || null,
      updatedAt: base.updatedAt || Date.now(),
      updatedBy: base.updatedBy || null,
      items: normalizeChecklistItems(base.items),
      metadata: (base.metadata && typeof base.metadata === 'object') ? {...base.metadata} : {}
    };
    return template;
  }

  function ensureOperationChecklist(op){
    if(!op || typeof op !== 'object') return op;
    op.checklistTemplate = createChecklistTemplate(op.checklistTemplate, op);
    const currentSettings = op.checklistSettings && typeof op.checklistSettings === 'object' ? op.checklistSettings : {};
    op.checklistSettings = {
      required: currentSettings.required === true,
      propagateToTasks: currentSettings.propagateToTasks === undefined ? true : !!currentSettings.propagateToTasks,
      allowWorkerAdditions: currentSettings.allowWorkerAdditions === undefined ? true : !!currentSettings.allowWorkerAdditions
    };
    return op;
  }

  function ensureOperationsCatalogChecklists(list){
    if(!Array.isArray(list)) return [];
    for(let i=0;i<list.length;i++){
      ensureOperationChecklist(list[i]);
    }
    return list;
  }

  try{
    window.normalizeChecklistItem = normalizeChecklistItem;
    window.normalizeChecklistItems = normalizeChecklistItems;
    window.createChecklistTemplate = createChecklistTemplate;
    window.ensureOperationChecklist = ensureOperationChecklist;
    window.ensureOperationsCatalogChecklists = ensureOperationsCatalogChecklists;
  }catch(_){ }

  ensureOperationsCatalogChecklists(state.operationsCatalog);
  
  // üîí FLAGA SYNCHRONIZACJI - Blokuje loadFromDB() podczas usuwania danych
  window._isSyncingDelete = false;
  window._syncDeleteTimeout = null;
  
  // Wy≈ÇƒÖcz tryb debug - za du≈ºo log√≥w
  window.debugMode = false;
  // migracja istniejƒÖcych task√≥w (dodanie nowych p√≥l je≈õli brak)
  try{ if(window.scheduleCore){ window.scheduleCore.migrateTasks(state); } }catch(e){ console.warn('migrateTasks warn', e.message); }
  // migracja order√≥w - pole tasksGenerated
  try{ (state.orders||[]).forEach(o=>{ if(typeof o.tasksGenerated==='undefined') o.tasksGenerated=false; }); }catch(e){ console.warn('migrateOrders warn', e.message); }
  
  // Funkcja do sprawdzania i ≈Çadowania stanu
  function checkAndLoadState(){
    console.log('Sprawdzam stan aplikacji...');
    
    // Sprawd≈∫ czy stan istnieje
    if(!window.state){
      console.error('Stan aplikacji nie istnieje!');
      alert('B≈ÇƒÖd: Stan aplikacji nie zosta≈Ç za≈Çadowony!');
      return false;
    }
    
    // Sprawd≈∫ kluczowe w≈Ça≈õciwo≈õci stanu
    const requiredProps = ['storage', 'employees', 'operationsCatalog', 'processes', 'orders', 'tasks'];
    const missing = requiredProps.filter(prop => !state.hasOwnProperty(prop));
    if(missing.length > 0){
      console.error('BrakujƒÖce w≈Ça≈õciwo≈õci stanu:', missing);
      alert('B≈ÇƒÖd stanu aplikacji! BrakujƒÖce w≈Ça≈õciwo≈õci: ' + missing.join(', '));
      return false;
    }
    
    // Sprawd≈∫ tryb storage
    console.log('Aktualny tryb storage:', state.storage.mode);
    console.log('Czy localhost:', window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
    
    console.log('Stan aplikacji za≈Çadowany poprawnie');
    return true;
  }
  
  // Sprawd≈∫ czy aplikacja zosta≈Ça poprawnie za≈Çadowana
  window.addEventListener('load', function(){
    console.log('Aplikacja za≈Çadowana, sprawdzam stan...');
    
    // Sprawd≈∫ czy aplikacja jest otwierana z w≈Ça≈õciwego protoko≈Çu
    if(window.location.protocol === 'file:'){
      console.warn('‚ö†Ô∏è Aplikacja otwarta z file:// - niekt√≥re funkcje mogƒÖ nie dzia≈Çaƒá');
      // NIE przerywamy - u≈ºytkownik zg≈Çosi≈Ç ≈ºe file:// DZIA≈ÅA POPRAWNIE
      // alert('‚ö†Ô∏è UWAGA: Aplikacja zosta≈Ça otwarta z pliku lokalnego (file://).\n\nDla prawid≈Çowego dzia≈Çania otw√≥rz jƒÖ przez serwer HTTP:\nhttp://localhost:5500\n\nW VS Code u≈ºyj "Open with Live Server" lub uruchom:\npython -m http.server 5500');
      // return;  // USUNIƒòTE - to blokowa≈Ço dzia≈Çanie aplikacji
    }
    
    // Sprawd≈∫ stan aplikacji
    if(!checkAndLoadState()){
      console.error('Stan aplikacji nieprawid≈Çowy - od≈õwie≈ºam stronƒô');
      setTimeout(() => forceRefresh(), 1000);
      return;
    }
    
    // Sprawd≈∫ czy localStorage dzia≈Ça
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      console.log('localStorage dzia≈Ça poprawnie');
    } catch(e) {
      console.error('localStorage nie dzia≈Ça:', e);
      alert('localStorage nie dzia≈Ça! Aplikacja mo≈ºe nie dzia≈Çaƒá poprawnie.');
    }
    
    // Sprawd≈∫ czy wszystkie funkcje sƒÖ dostƒôpne
    const requiredFunctions = ['qs', 'save', 'renderDash', 'updateConnectionStatus'];
    const missing = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
    if(missing.length > 0){
      console.error('BrakujƒÖce funkcje:', missing);
      alert('B≈ÇƒÖd ≈Çadowania aplikacji! BrakujƒÖce funkcje: ' + missing.join(', '));
    } else {
      console.log('Wszystkie funkcje za≈Çadowane poprawnie');
    }
    
    // Wymu≈õ aktualizacjƒô statusu
    if(typeof updateConnectionStatus === 'function'){
      updateConnectionStatus();
    }

    // Inicjalizacja prze≈ÇƒÖcznika wysokiego kontrastu ostrze≈ºe≈Ñ
    try{
      const toggle = document.getElementById('toggle-high-contrast');
      const callout = document.getElementById('startup-warning');
      if(toggle && callout){
        // wczytaj poprzedniƒÖ preferencjƒô
        const prefRaw = localStorage.getItem('highContrastWarnings');
        const pref = prefRaw === '1';
        toggle.checked = pref;
        if(pref){ callout.classList.add('high-contrast'); }
        toggle.addEventListener('change', ()=>{
          if(toggle.checked){ callout.classList.add('high-contrast'); localStorage.setItem('highContrastWarnings','1'); }
          else { callout.classList.remove('high-contrast'); localStorage.setItem('highContrastWarnings','0'); }
        });
      }
    }catch(e){ console.warn('HC toggle init error', e && e.message); }
    
    // Wymu≈õ renderowanie dashboard
    if(typeof renderDash === 'function'){
  renderDash(); renderGantt();
  if(typeof initOffdaysQuickButtons==='function') initOffdaysQuickButtons();
    }
  });
  
  // === UWAGA: Seedowanie operacji i proces√≥w przeniesione PO wczytaniu localStorage ===
  // (Zobacz linie ~1540-1600)
  
  // ensure all requested operations exist (no duplicates by lowercased name)
  const ensureOp = (name, time=10, skills=[])=>{
    if(!name) return;
    const normalizedName = name.trim();
    const catalog = state.operationsCatalog || (state.operationsCatalog = []);
    const exists = catalog.some(o=> (o.name||'').toLowerCase() === normalizedName.toLowerCase());
    if(exists) return;
    const newId = uid();
    const op = {
      id: newId,
      no: catalog.length + 1,
      name: normalizedName,
      time,
      workers: 1,
      skills,
      defaultAssignees: []
    };
    ensureOperationChecklist(op);
    catalog.push(op);
  };

  function normalizeOperationKey(name){
    return (name || '').replace(/\s+/g, ' ').trim().toLowerCase();
  }

  function dedupeOperationsCatalog(list, contextLabel){
    if(!Array.isArray(list) || list.length < 2){ return list || []; }
    let removed = 0;
    const seen = new Set();
    for(let i = 0; i < list.length; i++){
      const op = list[i];
      if(!op || typeof op !== 'object'){ continue; }
      const key = normalizeOperationKey(op.name);
      if(!key){ continue; }
      if(seen.has(key)){
        removed++;
        console.warn(`[operationsCatalog][dedupe] Usuwam duplikat '${op.name || '(bez nazwy)'}' (${op.id || 'brak-id'})${contextLabel ? ' podczas ' + contextLabel : ''}`);
        list.splice(i, 1);
        i--;
        continue;
      }
      seen.add(key);
    }
    list.forEach((op, idx)=>{ if(op && typeof op === 'object'){ op.no = idx + 1; ensureOperationChecklist(op); } });
    if(removed && (window.logDev || Math.random() < 0.2)){
      console.log(`[operationsCatalog][dedupe] Usuniƒôto ${removed} duplikat√≥w${contextLabel ? ' (' + contextLabel + ')' : ''}. Pozosta≈Ço ${list.length}.`);
    }
    return list;
  }
  // operations from user list
  [
    'Wyciƒôcie belek pod futrynƒô', 'Frezowanie na CNC 40 m', 'Sklejanie belek', 'Kontrola wymiar√≥w', 'Szlifowanie', 'Szczotkowanie', 'Malowanie', 'Okuwanie',
    'Wyciƒôcie belek pod skrzyd≈Ço', 'Sklejenie belek', 'Wyciƒôcie sklejki', 'Przygotowanie forniru zgodnie z zam√≥wieniem', 'Fornirowanie', 'Przygotowanie rurek pod elektronikƒô', 'Monta≈º rurek pod elektronikƒô',
    'Przyciƒôcie poprzeczek', 'Monta≈º poprzeczek', 'Przyciƒôcie styropianu', 'Monta≈º styropianu', 'Przyciƒôcie naciƒÖgu', 'Monta≈º naciƒÖgu', 'Sklejanie w prasie', 'Frezowanie na CNC',
    'Przygotowanie zestawu do drzwi', 'Przygotowanie antaby', 'Zam√≥wienie szyb', 'Malowanie szyb', 'Klejenie szyb', 'Polerowanie zamk√≥w i wypalenie logo', 'Wymiary szyby (szer, H)'
  ].forEach(n=>ensureOp(n, 10, []));
  // --- STORAGE HELPERS (zdefiniowane przed pierwszym u≈ºyciem) ---
  let autoSaveTimeout;
  let saveDebounceTimeout;
  let lastSaveTime = 0;
  const SAVE_DEBOUNCE_MS = 100; // Minimum 100ms miƒôdzy zapisami
  let skipAutoSaveUntil = (typeof window !== 'undefined' && typeof window.skipAutoSaveUntil === 'number') ? window.skipAutoSaveUntil : 0;
  window.skipAutoSaveUntil = skipAutoSaveUntil;
  const WAREHOUSE_COLLECTION = 'pozycjeMagazynu';
  const LEGACY_WAREHOUSE_COLLECTION = 'warehouseItems';
  const WAREHOUSE_LOCAL_KEY = 'pozycjeMagazynu';
  const LEGACY_WAREHOUSE_LOCAL_KEY = 'warehouseItems';
  const USER_COLLECTION_ALIASES = ['users', 'u≈ºytkownik√≥w', 'uzytkownikow'];
  if(typeof window !== 'undefined'){
    window._pendingLegacyWarehouseCleanup = Array.isArray(window._pendingLegacyWarehouseCleanup) ? window._pendingLegacyWarehouseCleanup : [];
    try { window.WAREHOUSE_COLLECTION = WAREHOUSE_COLLECTION; } catch(_){ }
    try { window.LEGACY_WAREHOUSE_COLLECTION = LEGACY_WAREHOUSE_COLLECTION; } catch(_){ }
    try { window.WAREHOUSE_LOCAL_KEY = WAREHOUSE_LOCAL_KEY; } catch(_){ }
    try { window.LEGACY_WAREHOUSE_LOCAL_KEY = LEGACY_WAREHOUSE_LOCAL_KEY; } catch(_){ }
    if(!Array.isArray(window.USER_COLLECTION_ALIASES)){ try { window.USER_COLLECTION_ALIASES = USER_COLLECTION_ALIASES.slice(); } catch(_){ } }
  }
  function getSkipAutoSaveUntil(){
    if(typeof skipAutoSaveUntil !== 'undefined') return skipAutoSaveUntil;
    if(typeof window !== 'undefined'){
      if(typeof window.skipAutoSaveUntil === 'number') return window.skipAutoSaveUntil;
      if(typeof window._plannerSkipAutoSaveUntil === 'number') return window._plannerSkipAutoSaveUntil;
    }
    return 0;
  }
  try{ window.getSkipAutoSaveUntil = getSkipAutoSaveUntil; }catch(_){ }

  function resolveSkipAutoSaveGuard(){
    if(typeof getSkipAutoSaveUntil === 'function'){
      try{ return getSkipAutoSaveUntil(); }catch(_){ }
    }
    if(typeof window !== 'undefined'){
      if(typeof window.getSkipAutoSaveUntil === 'function'){
        try{ return window.getSkipAutoSaveUntil(); }catch(_){ }
      }
      if(typeof window.skipAutoSaveUntil === 'number') return window.skipAutoSaveUntil;
      if(typeof window._plannerSkipAutoSaveUntil === 'number') return window._plannerSkipAutoSaveUntil;
    }
    return 0;
  }
  try{ window.resolveSkipAutoSaveGuard = resolveSkipAutoSaveGuard; }catch(_){ }

  function getUserCollectionCandidates(){
    const storage = (state && state.storage) || (window.state && window.state.storage) || {};
    const candidates = [];
    if(storage && typeof storage.userCollection === 'string') candidates.push(storage.userCollection);
    if(storage && typeof storage.usersCollection === 'string') candidates.push(storage.usersCollection);
    if(storage && storage.collectionMappings && typeof storage.collectionMappings.users === 'string') {
      candidates.push(storage.collectionMappings.users);
    }
    if(storage && storage.collectionAliases){
      const alias = storage.collectionAliases.users;
      if(Array.isArray(alias)) {
        alias.forEach(name => candidates.push(name));
      } else if(typeof alias === 'string') {
        candidates.push(alias);
      }
    }
    if(storage && Array.isArray(storage.userCollectionAliases)){
      storage.userCollectionAliases.forEach(name => candidates.push(name));
    }
    if(Array.isArray(window.USER_COLLECTION_ALIASES)){
      window.USER_COLLECTION_ALIASES.forEach(name => candidates.push(name));
    }
    USER_COLLECTION_ALIASES.forEach(name => candidates.push(name));
    return [...new Set(candidates.filter(Boolean))];
  }

  async function detectUserCollectionName(force){
    const storage = (state && state.storage) || (window.state && window.state.storage) || {};
    const appId = storage && storage.appId;
    if(!force && window._activeUserCollection){
      if(!appId || window._activeUserCollectionApp === appId){
        return window._activeUserCollection;
      }
    }
    if(typeof firebase === 'undefined' || !firebase.firestore){
      const fallback = getUserCollectionCandidates()[0] || 'users';
      window._activeUserCollection = fallback;
      window._activeUserCollectionApp = appId || null;
      return fallback;
    }
    if(!appId){
      const fallback = getUserCollectionCandidates()[0] || 'users';
      window._activeUserCollection = fallback;
      window._activeUserCollectionApp = null;
      return fallback;
    }
    const userId = storage && storage.userId;
    const candidates = getUserCollectionCandidates();
    const db = firebase.firestore();
    for(const candidate of candidates){
      try {
        if(userId){
          const docSnap = await db.collection('planner').doc(appId).collection(candidate).doc(userId).get();
          if(docSnap.exists){
            window._activeUserCollection = candidate;
            window._activeUserCollectionApp = appId;
            if(storage) storage.userCollection = candidate;
            return candidate;
          }
        }
        const snapshot = await db.collection('planner').doc(appId).collection(candidate).limit(1).get();
        if(snapshot && !snapshot.empty){
          window._activeUserCollection = candidate;
          window._activeUserCollectionApp = appId;
          if(storage) storage.userCollection = candidate;
          return candidate;
        }
      } catch(checkErr){
        console.warn(`[firebase] Kolekcja '${candidate}' niedostƒôpna:`, checkErr && checkErr.message);
      }
    }
    const fallback = candidates[0] || 'users';
    window._activeUserCollection = fallback;
    window._activeUserCollectionApp = appId;
    if(storage && !storage.userCollection) storage.userCollection = fallback;
    return fallback;
  }

  function getUserCollectionNameSync(){
    const storage = (state && state.storage) || (window.state && window.state.storage) || {};
    const appId = storage && storage.appId;
    if(window._activeUserCollection){
      if(!appId || window._activeUserCollectionApp === appId){
        return window._activeUserCollection;
      }
    }
    if(storage && typeof storage.userCollection === 'string'){
      window._activeUserCollection = storage.userCollection;
      window._activeUserCollectionApp = appId || null;
      return storage.userCollection;
    }
    const candidates = getUserCollectionCandidates();
    const fallback = candidates[0] || 'users';
    window._activeUserCollection = fallback;
    window._activeUserCollectionApp = appId || null;
    if(storage && !storage.userCollection){
      storage.userCollection = fallback;
    }
    return fallback;
  }
  try{ window.detectUserCollectionName = detectUserCollectionName; }catch(_){ }
  try{ window.getUserCollectionCandidates = getUserCollectionCandidates; }catch(_){ }
  try{ window.getUserCollectionNameSync = getUserCollectionNameSync; }catch(_){ }
  let isApplyingRemoteUpdate = false;
  const taskStatusBaseline = window._taskStatusBaseline || new Map();
  window._taskStatusBaseline = taskStatusBaseline;
  const taskStatusSnapshot = window._taskStatusSnapshot || new Map();
  window._taskStatusSnapshot = taskStatusSnapshot;

  function enqueueFirebaseDelete(collection, documentId, priority = 25){
    if(!collection || !documentId) return;
    try{
      if(window.FirebaseSyncQueue && typeof window.FirebaseSyncQueue.enqueue === 'function'){
        window.FirebaseSyncQueue.enqueue('delete', { collection, documentId }, priority);
      }
    }catch(err){
      console.warn('enqueueFirebaseDelete error', err && err.message);
    }
  }
  
  function autoSaveDebounced(){
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(()=>{
      const guardValue = resolveSkipAutoSaveGuard();
      if(guardValue && Date.now() < guardValue){
        if(window.logDev || Math.random() < 0.1){ console.log('Auto-save skipped due to recent remote sync'); }
        return;
      }
      try{ saveToDB(); }catch(e){ /* ignore at startup */ }
    }, 500);
  }
  function safeStringifyState(data){
    const seen = new WeakSet();
    return JSON.stringify(data, (key, value) => {
      if (typeof value === 'function') {
        return undefined;
      }
      if (typeof Node !== 'undefined' && value instanceof Node) {
        return undefined;
      }
      if (typeof value === 'object' && value !== null) {
        if (value === window) {
          return undefined;
        }
        if (seen.has(value)) {
          return undefined;
        }
        seen.add(value);
      }
      if (typeof value === 'number' && !Number.isFinite(value)) {
        return null;
      }
      return value;
    });
  }

  function save(){
    // Debounce: Prevent save from being called too frequently
    const now = Date.now();
    if (now - lastSaveTime < SAVE_DEBOUNCE_MS) {
      clearTimeout(saveDebounceTimeout);
      saveDebounceTimeout = setTimeout(save, SAVE_DEBOUNCE_MS);
      return;
    }
    lastSaveTime = now;
    const remoteSave = !!isApplyingRemoteUpdate;
    
    try{ 
      // FILTROWANIE: Usu≈Ñ testowe ID z state PRZED zapisem
      const testTasksInState = (state.tasks || []).filter(t => /^task\d+$/.test(t.id) || (t.id && t.id.startsWith('task_test_')));
      if(testTasksInState.length > 0){
        console.warn(`üö´ [save] USUWAM ${testTasksInState.length} testowych zada≈Ñ przed zapisem:`, testTasksInState.map(t => t.id));
        state.tasks = (state.tasks || []).filter(t => !/^task\d+$/.test(t.id) && !(t.id && t.id.startsWith('task_test_')));
      }
      
      const testOrdersInState = (state.orders || []).filter(o => o.id === 'order1' || (o.id && o.id.startsWith('order_test_')));
      if(testOrdersInState.length > 0){
        console.warn(`üö´ [save] USUWAM ${testOrdersInState.length} testowych zlece≈Ñ przed zapisem:`, testOrdersInState.map(o => o.id));
        state.orders = (state.orders || []).filter(o => o.id !== 'order1' && !(o.id && o.id.startsWith('order_test_')));
      }
      
      const testEmpsInState = (state.employees || []).filter(e => /^emp\d+$/.test(e.id) || (e.id && e.id.startsWith('emp_test_')));
      if(testEmpsInState.length > 0){
        console.warn(`üö´ [save] USUWAM ${testEmpsInState.length} testowych pracownik√≥w przed zapisem:`, testEmpsInState.map(e => e.id));
        state.employees = (state.employees || []).filter(e => !/^emp\d+$/.test(e.id) && !(e.id && e.id.startsWith('emp_test_')));
      }

      ensureOperationsCatalogChecklists(state.operationsCatalog);

      if(Array.isArray(state.operationsCatalog) && state.operationsCatalog.length > 1){
        const beforeOps = state.operationsCatalog.length;
        dedupeOperationsCatalog(state.operationsCatalog, 'save()');
        if(state.operationsCatalog.length !== beforeOps){
          console.warn(`[operationsCatalog][dedupe] save(): zredukowano operacje z ${beforeOps} do ${state.operationsCatalog.length}`);
        }
      }
      
      if(!remoteSave){
        state.lastModified = Date.now();
      }
      
      // Reduce logging verbosity - only log every 5th save or if debug enabled
      const shouldLog = window.debugMode || (Math.random() < 0.2);
      if (shouldLog) {
        console.log('üíæ SAVE: Zapisujƒô dane...', {
          employees: state.employees?.length || 0,
          operations: state.operationsCatalog?.length || 0,
          processes: state.processes?.length || 0,
          orders: state.orders?.length || 0,
          tasks: state.tasks?.length || 0,
          timestamp: new Date(state.lastModified).toLocaleString('pl-PL')
        });
        // DIAGNOSTYKA PRACOWNIK√ìW
        if (state.employees && state.employees.length > 0) {
          console.log('üë∑ PRACOWNICY w state.employees:', state.employees.map(e => ({id: e.id, name: e.name})));
        } else {
          console.warn('‚ö†Ô∏è state.employees jest PUSTE!');
        }
      }
      if(Array.isArray(state.tasks)){
        const isoNow = new Date().toISOString();
        state.tasks.forEach(task => {
          if(!task || !task.id) return;
          const snapshot = taskStatusSnapshot.get(task.id);
          const previousStatus = snapshot ? snapshot.status : undefined;
          if(previousStatus !== task.status){
            if(!remoteSave){
              task.lastStatusChange = isoNow;
            } else if(!task.lastStatusChange){
              task.lastStatusChange = isoNow;
            }
          }
        });
      }

      const dataToSave = safeStringifyState(state);
      if (shouldLog) {
        console.log('üíæ SAVE: Klucz:', storeKey, '| Wielko≈õƒá:', dataToSave.length, 'znak√≥w');
      }
      localStorage.setItem(storeKey, dataToSave); 
      
      // Weryfikacja zapisu (tylko w debug mode)
      if (shouldLog) {
        const saved = localStorage.getItem(storeKey);
        if (saved) {
          try {
            const savedData = JSON.parse(saved);
            console.log('‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage:', savedData.orders?.length || 0);
          } catch(verifyErr) {
            console.warn('‚ö†Ô∏è SAVE: Nie uda≈Ço siƒô zweryfikowaƒá danych po zapisie:', verifyErr);
          }
        } else {
          console.error('‚ùå SAVE: Dane NIE zosta≈Çy zapisane do localStorage!');
        }
      }

      if (window.store && typeof window.store.set === 'function') {
        try {
          window.store.set(state);
        } catch(storeErr) {
          console.warn('‚ö†Ô∏è SAVE: synchronizacja store.set nie powiod≈Ça siƒô:', storeErr);
        }
      }

      if (typeof window.state === 'undefined' || window.state !== state) {
        window.state = state;
      }
      
      // Automatyczna synchronizacja z Firebase je≈õli tryb Firebase jest aktywny
      if (!remoteSave && state.storage && state.storage.mode === 'firebase' && typeof window.saveToDB === 'function') {
        // Debounce Firebase save (max 1x na 5 sekund)
        clearTimeout(window._firebaseSaveTimeout);
        window._firebaseSaveTimeout = setTimeout(() => {
          const guardValue = getSkipAutoSaveUntil();
          if(guardValue && Date.now() < guardValue){
            if(window.logDev || Math.random() < 0.1){ console.log('Auto-sync skipped due to recent remote sync'); }
            return;
          }
          if (shouldLog) {
            console.log('üîÑ Auto-sync: Synchronizujƒô z Firebase...');
          }
          window.saveToDB().then(() => {
            if (shouldLog) {
              console.log('‚úÖ Auto-sync: Zsynchronizowano z Firebase');
            }
          }).catch(err => {
            console.warn('‚ö†Ô∏è Auto-sync: B≈ÇƒÖd synchronizacji z Firebase:', err.message);
          });
        }, 2000); // 2 sekundy po ostatnim save
      }
      if(Array.isArray(state.tasks)){
        taskStatusSnapshot.clear();
        state.tasks.forEach(task => {
          if(task && task.id){
            taskStatusSnapshot.set(task.id, {status: task.status, lastStatusChange: task.lastStatusChange});
          }
        });
      }
    }catch(e){ 
      console.error('‚ùå SAVE: B≈ÇƒÖd zapisu:', e);
    }
    if(!remoteSave){
      autoSaveDebounced();
    }
  }
  try{ window.save = save; }catch(_){ }

  // === NARZƒòDZIE DO SYNCHRONIZACJI DANYCH MIƒòDZY PORTAMI ===
  window.exportDataToFile = function() {
    try {
      const dataStr = localStorage.getItem(storeKey);
      if (!dataStr) {
        alert('‚ùå Brak danych do eksportu!');
        return;
      }
      
      const data = JSON.parse(dataStr);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `planner-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('‚úÖ Dane wyeksportowane do pliku');
      alert('‚úÖ Dane wyeksportowane!\n\nPobrano plik: ' + a.download);
    } catch(e) {
      console.error('‚ùå B≈ÇƒÖd eksportu:', e);
      alert('‚ùå B≈ÇƒÖd eksportu danych: ' + e.message);
    }
  };
  
  window.importDataFromFile = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const importedData = JSON.parse(ev.target.result);
          
          // Sprawd≈∫ czy to sƒÖ poprawne dane
          if (!importedData.orders || !importedData.employees) {
            alert('‚ùå Nieprawid≈Çowy format danych!');
            return;
          }
          
          const currentData = localStorage.getItem(storeKey);
          const currentState = currentData ? JSON.parse(currentData) : null;
          
          const msg = `üìä IMPORT DANYCH\n\n` +
            `Aktualny stan:\n` +
            `  ‚Ä¢ Zlecenia: ${currentState?.orders?.length || 0}\n` +
            `  ‚Ä¢ Pracownicy: ${currentState?.employees?.length || 0}\n` +
            `  ‚Ä¢ Procesy: ${currentState?.processes?.length || 0}\n\n` +
            `Importowane dane:\n` +
            `  ‚Ä¢ Zlecenia: ${importedData.orders?.length || 0}\n` +
            `  ‚Ä¢ Pracownicy: ${importedData.employees?.length || 0}\n` +
            `  ‚Ä¢ Procesy: ${importedData.processes?.length || 0}\n\n` +
            `‚ö†Ô∏è UWAGA: To NADPISZE wszystkie aktualne dane!\n\n` +
            `Czy na pewno chcesz kontynuowaƒá?`;
          
          if (!confirm(msg)) {
            console.log('Import anulowany');
            return;
          }
          
          if(Array.isArray(importedData.operationsCatalog) && importedData.operationsCatalog.length > 1){
            const beforeOps = importedData.operationsCatalog.length;
            dedupeOperationsCatalog(importedData.operationsCatalog, 'importDataFromFile');
            if(importedData.operationsCatalog.length !== beforeOps){
              console.warn(`[operationsCatalog][dedupe] import: ${beforeOps} -> ${importedData.operationsCatalog.length}`);
            }
          }

          // Zapisz dane
          localStorage.setItem(storeKey, JSON.stringify(importedData));
          Object.assign(state, importedData);
          ensureOperationsCatalogChecklists(state.operationsCatalog);
          if(Array.isArray(state.operationsCatalog) && state.operationsCatalog.length > 1){
            dedupeOperationsCatalog(state.operationsCatalog, 'import-apply');
          }
          window.state = state;
          
          console.log('‚úÖ Dane zaimportowane pomy≈õlnie');
          alert('‚úÖ Dane zaimportowane!\n\nOd≈õwie≈ºam stronƒô...');
          
          setTimeout(() => window.location.reload(), 500);
        } catch(e) {
          console.error('‚ùå B≈ÇƒÖd importu:', e);
          alert('‚ùå B≈ÇƒÖd importu danych: ' + e.message);
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };
  
  window.showPortInfo = function() {
    const info = `üìä INFORMACJE O APLIKACJI\n\n` +
      `Port/URL: ${window.location.origin}\n` +
      `Klucz localStorage: ${storeKey}\n\n` +
      `Za≈Çadowane dane:\n` +
      `  ‚Ä¢ Zlecenia: ${state.orders?.length || 0}\n` +
      `  ‚Ä¢ Pracownicy: ${state.employees?.length || 0}\n` +
      `  ‚Ä¢ Procesy: ${state.processes?.length || 0}\n` +
      `  ‚Ä¢ Operacje: ${state.operationsCatalog?.length || 0}\n` +
      `  ‚Ä¢ Zadania: ${state.tasks?.length || 0}\n\n` +
      `üí° WA≈ªNE:\n` +
      `Ka≈ºdy port (5500, 8000) ma OSOBNƒÑ bazƒô danych!\n\n` +
      `Aby przenie≈õƒá dane miƒôdzy portami:\n` +
      `1. Wywo≈Çaj: exportDataToFile()\n` +
      `2. Otw√≥rz aplikacjƒô na drugim porcie\n` +
      `3. Wywo≈Çaj: importDataFromFile()\n\n` +
      `Dostƒôpne komendy:\n` +
      `  ‚Ä¢ exportDataToFile() - eksport do pliku\n` +
      `  ‚Ä¢ importDataFromFile() - import z pliku\n` +
      `  ‚Ä¢ showPortInfo() - poka≈º te informacje`;
    
    console.log(info);
    alert(info);
  };

  // Najpierw spr√≥buj wczytaƒá poprzedni stan (je≈õli istnieje) ZANIM wymusimy zapis seed√≥w
  try{
    const raw=localStorage.getItem(storeKey); 
    console.log('üîç LOAD: Sprawdzam localStorage (klucz: ' + storeKey + ')...');
    if(raw) {
      hasLocalStateData = true;
      const loadedData = JSON.parse(raw);
      console.log('üì¶ LOAD: Dane z localStorage (d≈Çugo≈õƒá):', raw.length, 'znak√≥w');
      Object.assign(state, loadedData);
      ensureOperationsCatalogChecklists(state.operationsCatalog);
      if(Array.isArray(state.operationsCatalog) && state.operationsCatalog.length > 1){
        const beforeOps = state.operationsCatalog.length;
        dedupeOperationsCatalog(state.operationsCatalog, 'localStorage-load');
        if(state.operationsCatalog.length !== beforeOps){
          console.warn(`[operationsCatalog][dedupe] localStorage: ${beforeOps} -> ${state.operationsCatalog.length}`);
        }
      }
      console.log('‚úÖ LOAD: Dane za≈Çadowane z localStorage:', {
        employees: state.employees?.length || 0,
        operations: state.operationsCatalog?.length || 0,
        processes: state.processes?.length || 0,
        orders: state.orders?.length || 0,
        tasks: state.tasks?.length || 0,
        deletedOperations: state.deletedOperations?.length || 0,
        deletedProcesses: state.deletedProcesses?.length || 0
      });
      // üîß DIAGNOSTYKA: Poka≈º usuniƒôte operacje z localStorage
      if(Array.isArray(state.deletedOperations) && state.deletedOperations.length > 0){
        console.log('üóëÔ∏è [localStorage] Wczytano deletedOperations:', state.deletedOperations);
      }
      // üîÅ Je≈õli brak deletedOperations w g≈Ç√≥wnym stanie, spr√≥buj z kopii awaryjnej
      if((!Array.isArray(state.deletedOperations) || state.deletedOperations.length === 0)){
        try {
          const backup = localStorage.getItem('deletedOperations_backup');
          if(backup){
            const parsed = JSON.parse(backup);
            if(Array.isArray(parsed) && parsed.length){
              state.deletedOperations = parsed.slice();
              console.log('üóÇÔ∏è [localStorage] Przywr√≥cono deletedOperations z kopii awaryjnej:', state.deletedOperations);
            }
          }
        } catch(e) {
          console.warn('‚ö†Ô∏è [localStorage] Nie uda≈Ço siƒô odczytaƒá kopii deletedOperations:', e && e.message);
        }
      }
    } else {
      console.log('‚ö†Ô∏è LOAD: Brak danych w localStorage (klucz: ' + storeKey + '), u≈ºywam domy≈õlne');
    }
  }catch(e){ 
    console.error('‚ùå LOAD: B≈ÇƒÖd ≈Çadowania danych:', e);
  }
  
  // === SEEDOWANIE DANYCH (PO WCZYTANIU localStorage) ===
  // Je≈õli po wczytaniu localStorage nadal brak proces√≥w/operacji, generuj domy≈õlne dane
  
  // Seed operationsCatalog if empty
  if(!hasLocalStateData && !(state.operationsCatalog && state.operationsCatalog.length)){
    console.log('üå± SEED: Tworzƒô domy≈õlne operacje...');
    state.operationsCatalog = [];
    let i = 1;
    const addOp = (name, time=10, skills=[])=>{
      const op = {id: uid(), no: i++, name, time, workers:1, skills, defaultAssignees:[]};
      ensureOperationChecklist(op);
      state.operationsCatalog.push(op);
    };
    // FUTRYNA
    addOp('Frezowanie na CNC (belki futryny)', 40, ['CNC','belki']);
    addOp('Sklejanie belek (futryna)', 20, ['sklejanie','belki']);
    addOp('Kontrola wymiar√≥w (futryna)', 10, ['kontrola']);
    addOp('Szlifowanie (futryna)', 15, ['szlifowanie']);
    addOp('Szczotkowanie (futryna)', 12, ['szczotkowanie']);
    addOp('Malowanie (futryna)', 30, ['malowanie']);
    addOp('Okuwanie (futryna)', 8, ['okucia']);
    // SKRZYD≈ÅO
    addOp('Wyciƒôcie belek pod skrzyd≈Ço', 35, ['CNC','belki']);
    addOp('Sklejenie belek (skrzyd≈Ço)', 20, ['sklejanie','belki']);
    addOp('Wyciƒôcie sklejki', 25, ['sklejka']);
    addOp('Przygotowanie forniru', 18, ['fornir']);
    addOp('Fornirowanie', 30, ['fornirowanie']);
    addOp('Przygotowanie rurek pod elektronikƒô', 12, ['elektronika']);
    addOp('Monta≈º rurek pod elektronikƒô', 18, ['elektronika']);
    addOp('Przyciƒôcie poprzeczek', 10, ['poprzeczki']);
    addOp('Monta≈º poprzeczek', 12, ['poprzeczki']);
    addOp('Przyciƒôcie styropianu', 5, ['styropian']);
    addOp('Monta≈º styropianu', 8, ['styropian']);
    addOp('Przyciƒôcie naciƒÖgu', 6, ['naciag']);
    addOp('Monta≈º naciƒÖgu', 8, ['naciag']);
    addOp('Sklejanie w prasie', 25, ['prasa']);
    addOp('Frezowanie na CNC (skrzyd≈Ço)', 40, ['CNC']);
    addOp('Szlifowanie (skrzyd≈Ço)', 15, ['szlifowanie']);
    addOp('Szczotkowanie (skrzyd≈Ço)', 12, ['szczotkowanie']);
    addOp('Malowanie (skrzyd≈Ço)', 30, ['malowanie']);
    addOp('Okuwanie (skrzyd≈Ço)', 8, ['okucia']);
    // DODATKOWE
    addOp('Przygotowanie zestawu do drzwi', 10, ['zestaw']);
    addOp('Przygotowanie antaby', 8, ['antaba']);
    addOp('Zam√≥wienie szyb', 5, ['szyby']);
    addOp('Malowanie szyb', 15, ['szyby','malowanie']);
    addOp('Klejenie szyb', 20, ['szyby','klejenie']);
    addOp('Polerowanie zamk√≥w i wypalenie logo', 12, ['zamki','polerowanie']);
    addOp('Wymiary szyby (szer, H)', 4, ['szyby','wymiary']);
    console.log('‚úÖ SEED: Utworzono', state.operationsCatalog.length, 'operacji');
    ensureOperationsCatalogChecklists(state.operationsCatalog);
  }
  
  // Seed processes if empty (MUSI BYƒÜ PO operationsCatalog!)
  if(!hasLocalStateData && !(state.processes && state.processes.length)){
    console.log('üå± SEED: Tworzƒô domy≈õlne procesy...');
    const procAdd = (name, opNames)=>{
      const ops = (opNames||[]).map(n=>{ const o = state.operationsCatalog.find(x=>x.name===n); return o?{id:o.id,name:o.name,time:o.time||0}:{name:n,time:0}; });
      state.processes.push({id:uid(), name, operations: ops});
    };
    procAdd('Proces: Futryna', ['Frezowanie na CNC (belki futryny)','Sklejanie belek (futryna)','Kontrola wymiar√≥w (futryna)','Szlifowanie (futryna)','Szczotkowanie (futryna)','Malowanie (futryna)','Okuwanie (futryna)']);
    procAdd('Proces: Skrzyd≈Ço', ['Wyciƒôcie belek pod skrzyd≈Ço','Sklejenie belek (skrzyd≈Ço)','Wyciƒôcie sklejki','Fornirowanie','Frezowanie na CNC (skrzyd≈Ço)','Szlifowanie (skrzyd≈Ço)','Malowanie (skrzyd≈Ço)','Okuwanie (skrzyd≈Ço)']);
    procAdd('Proces: Drzwi kompletne', ['Frezowanie na CNC (belki futryny)','Sklejanie belek (futryna)','Wyciƒôcie belek pod skrzyd≈Ço','Sklejenie belek (skrzyd≈Ço)','Sklejanie w prasie','Fornirowanie','Malowanie (skrzyd≈Ço)','Okuwanie (skrzyd≈Ço)']);
    console.log('‚úÖ SEED: Utworzono', state.processes.length, 'proces√≥w');
  }
  
  // Je≈õli wygenerowali≈õmy seedy, zapisz je do localStorage
  if((state.processes && state.processes.length) || (state.operationsCatalog && state.operationsCatalog.length)){
    try{ save(); console.log('üíæ SEED: Zapisano seedy do localStorage'); }catch(e){ console.warn('seed save error', e && e.message); }
  }
  
  // NIE dodawaj testowych pracownik√≥w - u≈ºytkownik dodaje swoich
  // ensure stored autosave preference exists
  state.storage.autoSaveAssign = state.storage.autoSaveAssign === undefined ? true : !!state.storage.autoSaveAssign;

  // safeguard: przywr√≥ƒá domy≈õlnƒÖ konfiguracjƒô Firebase, je≈õli w lokalnym stanie jej brakuje
  if (!state.storage.fbConfig || !state.storage.fbConfig.apiKey) {
    console.warn('[init] Brak pe≈Çnej konfiguracji Firebase w localStorage ‚Äì przywracam warto≈õci domy≈õlne.');
    state.storage.fbConfig = JSON.parse(JSON.stringify(DEFAULT_FIREBASE_CONFIG));
    try {
      const fbInput = qs('#set-fb');
      if (fbInput) {
        fbInput.value = JSON.stringify(state.storage.fbConfig, null, 2);
      }
    } catch (restoreErr) {
      console.warn('[init] Nie uda≈Ço siƒô zsynchronizowaƒá formularza konfiguracji Firebase:', restoreErr && restoreErr.message);
    }
  }

  // ensure stored autoload preference exists (domy≈õlnie TRUE w trybie Firebase, aby po od≈õwie≈ºeniu zaciƒÖgaƒá dane zdalne)
  const autoLoadDefault = state.storage.mode === 'firebase';
  console.log('[init] Konfiguracja autoLoad:', {
    mode: state.storage.mode,
    autoLoadDefault,
    currentAutoLoad: state.storage.autoLoadFromDB,
    migrated: state.storage._autoLoadMigrated
  });

  state.storage.autoLoadFromDB = state.storage.autoLoadFromDB === undefined ? autoLoadDefault : !!state.storage.autoLoadFromDB;

  if(state.storage.mode === 'firebase' && !state.storage._autoLoadMigrated){
    const wasEnabled = !!state.storage.autoLoadFromDB;
    console.log('[init] Uruchamiam migracjƒô autoLoad. Obecnie:', wasEnabled);
    if(!wasEnabled){
      state.storage.autoLoadFromDB = true;
      try{ 
        save(); 
        console.log('‚öôÔ∏è AUTO-LOAD: Wymuszono automatyczne wczytywanie danych z Firebase po migracji.'); 
      }
      catch(e){ console.warn('AUTO-LOAD migrate save error', e && e.message); }
    }
    state.storage._autoLoadMigrated = true;
    try{ save(); console.log('[init] Zapisano flagƒô _autoLoadMigrated'); }
    catch(e){ console.warn('[init] B≈ÇƒÖd zapisu _autoLoadMigrated', e && e.message); }
  }

  console.log('[init] Ostateczna warto≈õƒá autoLoadFromDB:', state.storage.autoLoadFromDB);
  // track ostatniƒÖ udanƒÖ synchronizacjƒô zdalnƒÖ (0 = brak)
  state.storage.lastRemoteSync = state.storage.lastRemoteSync || 0;
  // ensure stored spellcheck enforce preference exists (default: true)
  state.storage.spellcheckEnforce = state.storage.spellcheckEnforce === undefined ? true : !!state.storage.spellcheckEnforce;
  // ensure lastModified timestamp exists for smart sync
  if(!state.lastModified) state.lastModified = Date.now();
  // (przeniesione wy≈ºej ‚Äì odczyt localStorage przed seedingiem)
  // ensure settings object exists and default autoCleanup = true
  state.settings = state.settings || {};
  if (typeof state.settings.autoCleanup === 'undefined') state.settings.autoCleanup = true;
  state.deletedOrders = Array.isArray(state.deletedOrders) ? state.deletedOrders : [];
  state.deletedProcesses = Array.isArray(state.deletedProcesses) ? state.deletedProcesses : [];
  // expose state for debugging and console access
  try{ window.state = state; }catch(e){console.warn('unable to expose state', e);}

  // AUTO-CONNECT AND AUTO-LOAD FROM FIREBASE ON STARTUP
  // Automatyczne ≈ÇƒÖczenie z Firebase i ≈Çadowanie danych przy starcie
  if (state.storage && state.storage.mode === 'firebase') {
    console.log('üîÑ INIT: Tryb Firebase - ≈ÇƒÖczƒô siƒô z bazƒÖ...');
    
    // Funkcja automatycznego ≈ÇƒÖczenia
    async function autoConnectFirebase() {
      try {
        // 1. Sprawd≈∫ konfiguracjƒô
        const cfg = state.storage.fbConfig || {};
        if (!cfg.apiKey) {
          console.warn('‚ö†Ô∏è INIT: Brak konfiguracji Firebase (apiKey)');
          console.log('üí° INIT: Przejd≈∫ do zak≈Çadki "Synchronizacja" aby skonfigurowaƒá Firebase');
          return false;
        }
        
        console.log('üîë INIT: Konfiguracja Firebase znaleziona');
        
        // 2. Za≈Çaduj Firebase SDK i zainicjalizuj
        const firebaseOk = await ensureFirebase();
        if (!firebaseOk) {
          console.warn('‚ö†Ô∏è INIT: Nie uda≈Ço siƒô za≈Çadowaƒá Firebase SDK');
          return false;
        }
        
        console.log('üì¶ INIT: Firebase SDK za≈Çadowany');
        
        // 3. Zaloguj siƒô anonimowo
        console.log('üîê INIT: Logujƒô siƒô anonimowo...');
        const cred = await firebase.auth().signInAnonymously();
        const uid = cred.user && cred.user.uid;
        
        console.log('‚úÖ INIT: Po≈ÇƒÖczono z Firebase! UID:', uid);
        
        // 4. Zaktualizuj status po≈ÇƒÖczenia
        if (typeof updateConnectionStatus === 'function') {
          updateConnectionStatus();
        }
        
        // 5. Za≈Çaduj dane z Firebase (ZAWSZE przy inicjalizacji)
        console.log('üì• INIT: ≈Åadujƒô dane z Firebase...');
        if (typeof loadFromDB === 'function') {
          const result = await loadFromDB({ forceLoad: true, reason: 'init' });
          
          if (result && result.skipped) {
            console.log('‚ö†Ô∏è INIT: ≈Åadowanie z Firebase pominiƒôte (lokalne dane nowsze)');
          } else {
            console.log('‚úÖ INIT: Dane za≈Çadowane z Firebase');
            
            // Od≈õwie≈º widoki po za≈Çadowaniu
            try {
              renderOrderPage(window.state||state);
              renderTasks();
              renderDash(window.state||state);
              console.log('üé® INIT: Widoki od≈õwie≈ºone');
            } catch(err) {
              console.warn('‚ö†Ô∏è INIT: Nie uda≈Ço siƒô od≈õwie≈ºyƒá widok√≥w:', err.message);
            }
          }
        }
        
        return true;
        
      } catch(err) {
        console.error('‚ùå INIT: B≈ÇƒÖd automatycznego ≈ÇƒÖczenia z Firebase:', err.message);
        console.log('üì¶ INIT: U≈ºywam danych z localStorage');
        return false;
      }
    }
    
    // Uruchom automatyczne ≈ÇƒÖczenie natychmiast po inicjalizacji
    (async () => {
      // KROK 1: W≈ÇƒÖcz kolejkƒô PRZED jakimkolwiek po≈ÇƒÖczeniem z Firebase
      if (window.FirebaseSyncQueue) {
        window.FirebaseSyncQueue.enable();
        console.log('üîÑ INIT: Kolejka synchronizacji w≈ÇƒÖczona (pre-connect)');
      }

      // KROK 2: Teraz po≈ÇƒÖcz z Firebase
      const success = await autoConnectFirebase();
      if (success) {
        console.log('üéâ INIT: Automatyczne ≈ÇƒÖczenie z Firebase zako≈Ñczone sukcesem!');
      } else {
        console.log('‚ö†Ô∏è INIT: Automatyczne ≈ÇƒÖczenie z Firebase nie powiod≈Ço siƒô - sprawd≈∫ konfiguracjƒô');
      }
    })();
    
  } else {
    console.log('üì¶ INIT: Tryb localStorage - u≈ºywam lokalnych danych');
  }

  // DEFINICJA FUNKCJI PRZED JEJ WYWOLANIEM
  window.restoreNormalClickDelegation = function(){
    window.disableGlobalClickDelegation = false;
    console.log('[rescue] Normal click delegation RESTORED');
    // Zapobiegaj ponownemu w≈ÇƒÖczeniu - nadpisz funkcjƒô awaryjnƒÖ
    window.enableNoDelegateMode = function(){
      console.warn('[rescue] No-delegation mode BLOCKED - normal delegation required');
      return false;
    };
  };

  // NATYCHMIAST przywr√≥ƒá normalnƒÖ delegacjƒô klikniƒôƒá - NAJWY≈ªSZY PRIORYTET
  window.restoreNormalClickDelegation();
  console.log('INIT: Normalna delegacja klikniƒôƒá przywr√≥cona na starcie');

  // AWARYJNE: Sprawdzaj i przywracaj delegacjƒô co 5 sekund
  setInterval(() => {
    if (window.disableGlobalClickDelegation) {
      window.restoreNormalClickDelegation();
      console.log('AUTO-RESTORE: Delegacja klikniƒôƒá przywr√≥cona automatycznie');
    }
  }, 5000);

  // (stara definicja save/autoSaveDebounced usuniƒôta ‚Äì przeniesiona wy≈ºej)

  // call this to trigger optional immediate Firebase save when enabled in settings
  function maybeAutoSave(reason){
    try{
      const enabled = !!state.storage.autoSaveAssign;
      if(enabled){ saveToDB(); setInfoText('Auto-save: ' + (reason||'sync'), 'default'); }
    }catch(e){ console.warn('maybeAutoSave error', e); }
  }
  try{ window.maybeAutoSave = maybeAutoSave; }catch(_){ }
  
  function nav(p){
    // AWARYJNE: Przy ka≈ºdej nawigacji przywracaj normalnƒÖ delegacjƒô klikniƒôƒá
    if (window.disableGlobalClickDelegation) {
      window.restoreNormalClickDelegation();
      console.log('[nav] Emergency delegation restore for page:', p);
    }
    const map={dash:'p-dash',tasks:'p-tasks',order:'p-order',proc:'p-proc',opcat:'p-opcat',emp:'p-emp',as:'p-as',
               map:'p-map',monitor:'p-monitor',mrp:'p-mrp',wh:'p-wh',sync:'p-sync',backup:'p-backup',migr:'p-migr',settings:'p-settings',gantt:'p-gantt',capacity:'p-capacity',reports:'p-reports'};
    qsa('[id^="p-"]').forEach(el=>el.classList.add('hidden'));
    qs('#'+(map[p]||'p-dash')).classList.remove('hidden');
    state.page=p; save();
    if(p==='order') renderOrderPage(window.state||state);
    if(p==='tasks') renderTasks();
    if(p==='opcat') renderOps();
    if(p==='proc') renderProcPage();
    if(p==='emp') renderEmployees(window.state||state);
    if(p==='as') renderASPage();
    if(p==='mrp') renderMRPPage();
    if(p==='gantt') renderGantt();
    if(p==='capacity') renderCapacityAnalysis();
    if(p==='reports') renderReports();
    if(p==='monitor') try{ renderMonitor(); }catch(_){ /* no-op if monitor renderer missing */ }
    if(p==='wh') {
      try { 
        // Przywracamy normalnƒÖ delegacjƒô klikniƒôƒá przy wej≈õciu do magazynu
        window.restoreNormalClickDelegation();
        initWarehouse(); 
      } catch(e){ console.warn('[warehouse] init error', e); }
    }
  renderDash(window.state||state); renderGantt();
  }
  window.nav=nav;

  const handleEvents = async (e) => {
    let t = e.target;
    // AWARYJNE: Ignoruj flagƒô disableGlobalClickDelegation dla przycisk√≥w nawigacji i podstawowych kontrolek
    const isNavigationButton = t.closest && (t.closest('[data-nav]') || t.closest('button') && t.closest('header'));
    const isBasicControl = t.closest && (t.closest('#restore-click-delegation') || t.closest('#set-save') || t.closest('#set-load'));
    
    if (window.disableGlobalClickDelegation && !isNavigationButton && !isBasicControl) {
      return;
    }
    while(t && t !== document.body) {
      if(e.type === 'click') {
        // Je≈õli element ma atrybut data-no-global, przerywamy delegacjƒô (pozwalamy lokalnym listenerom dzia≈Çaƒá bez wp≈Çywu globalnego handlera)
        if(t.hasAttribute && t.hasAttribute('data-no-global')) break;
        if(t.dataset.nav) { nav(t.dataset.nav); break; }
        if(t.dataset.od) {
          const id = t.dataset.od;
          
          console.log('üóëÔ∏è Usuwanie zlecenia:', id);
          
          // KROK 1: Usu≈Ñ z lokalnego state (localStorage)
          const removedOrder = state.orders.find(x => x.id === id);
          const orderTasks = Array.isArray(state.tasks) ? state.tasks.filter(task => task && task.orderId === id) : [];
          const taskIdsToDelete = orderTasks.map(task => task && task.id).filter(Boolean);
          const removedTasksCount = taskIdsToDelete.length;
          
          state.orders = state.orders.filter(x => x.id !== id); 
          state.tasks = state.tasks.filter(t => t.orderId !== id); 
          state.after = state.after.filter(a => a.order !== id); 
          state.deletedOrders = Array.isArray(state.deletedOrders) ? state.deletedOrders : [];
          if (!state.deletedOrders.includes(id)) {
            state.deletedOrders.push(id);
            if (state.deletedOrders.length > 200) {
              state.deletedOrders = state.deletedOrders.slice(-200);
            }
          }
          
          console.log(`  Usuniƒôto: zlecenie ${removedOrder?.name || id}, ${removedTasksCount} zada≈Ñ`);

          if(taskIdsToDelete.length){
            taskIdsToDelete.forEach(taskId => {
              if(taskStatusBaseline && typeof taskStatusBaseline.delete === 'function') taskStatusBaseline.delete(taskId);
              if(taskStatusSnapshot && typeof taskStatusSnapshot.delete === 'function') taskStatusSnapshot.delete(taskId);
              if(window.pendingFirebaseUpdates && typeof window.pendingFirebaseUpdates.delete === 'function') window.pendingFirebaseUpdates.delete(taskId);
              if(window.taskOperationInProgress && typeof window.taskOperationInProgress.delete === 'function') window.taskOperationInProgress.delete(taskId);
            });
          }

          // Usu≈Ñ powiƒÖzane dane magazynowe (rezerwacje, zadania)
          let warehouseDataChanged = false;
          let warehouseTasksChanged = false;
          if (Array.isArray(window.warehouseReservations)) {
            const before = window.warehouseReservations.length;
            window.warehouseReservations = window.warehouseReservations.filter(res => res && res.orderId !== id);
            const removedReservations = before - window.warehouseReservations.length;
            if (removedReservations > 0) {
              warehouseDataChanged = true;
              console.log(`  üßπ Usuniƒôto ${removedReservations} rezerwacji magazynowych dla ${removedOrder?.name || id}`);
            }
          }
          if (Array.isArray(window.warehouseTasks)) {
            const beforeTasks = window.warehouseTasks.length;
            window.warehouseTasks = window.warehouseTasks.filter(task => task && task.orderId !== id);
            const removedWarehouseTasks = beforeTasks - window.warehouseTasks.length;
            if (removedWarehouseTasks > 0) {
              warehouseTasksChanged = true;
              console.log(`  üßπ Usuniƒôto ${removedWarehouseTasks} zada≈Ñ magazynowych dla ${removedOrder?.name || id}`);
            }
          }
          if (warehouseDataChanged && typeof window.saveWarehouseToStorage === 'function') {
            try {
              window.saveWarehouseToStorage();
            } catch (warehouseErr) {
              console.warn('  ‚ö†Ô∏è saveWarehouseToStorage error po usuniƒôciu zlecenia', warehouseErr);
            }
          }
          if (warehouseTasksChanged) {
            try {
              localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks || []));
            } catch (warehouseTasksErr) {
              console.warn('  ‚ö†Ô∏è Nie uda≈Ço siƒô zaktualizowaƒá localStorage dla zada≈Ñ magazynowych', warehouseTasksErr);
            }
          }
          
          // KROK 2: Zaktualizuj timestamp i WYMU≈ö kolejne wczytanie z Firebase
          state.lastModified = Date.now();
          state.storage.lastRemoteSync = 0; // WYMUSZAMY nastƒôpne wczytanie z Firebase!
          
          // Zaktualizuj window.state
          window.state = state;
          
          // KROK 3: Zapisz do localStorage
          save();
          console.log('  ‚úÖ Zapisano do localStorage');

          enqueueFirebaseDelete('orders', id, 40);
          taskIdsToDelete.forEach(taskId => enqueueFirebaseDelete('tasks', taskId, 35));
          
          // üîí KROK 4: USTAW FLAGƒò SYNCHRONIZACJI - Blokuje loadFromDB()
          window._isSyncingDelete = true;
          console.log('  üîí Flaga _isSyncingDelete = true (blokujƒô loadFromDB)');
          
          // Wyczy≈õƒá stary timeout je≈õli istnieje
          if (window._syncDeleteTimeout) {
            clearTimeout(window._syncDeleteTimeout);
          }
          
          // KROK 5: Synchronizuj z Firebase - saveToDB automatycznie usuwa z Firebase to czego nie ma lokalnie
          if (state.storage && state.storage.mode === 'firebase' && typeof window.saveToDB === 'function') {
            console.log('  üîÑ Synchronizujƒô usuniƒôcie z Firebase...');
            window.saveToDB().then(async () => {
              console.log('  ‚úÖ Zlecenie i zadania usuniƒôte z Firebase');

              if (typeof window.purgeOrderFromFirebase === 'function') {
                try {
                  await window.purgeOrderFromFirebase(id);
                } catch (purgeErr) {
                  console.warn('  ‚ö†Ô∏è purgeOrderFromFirebase: problem z bezpo≈õrednim czyszczeniem Firebase', purgeErr);
                }
              }

              // üîì WZN√ìW FLAGE PO POMY≈öLNYM ZAPISANIU
              // Poczekaj 2s na pewno≈õƒá ≈ºe Firebase siƒô zsynchronizuje
              window._syncDeleteTimeout = setTimeout(() => {
                window._isSyncingDelete = false;
                console.log('  üîì Flaga _isSyncingDelete = false (odblokujƒô loadFromDB)');
              }, 2000);
            }).catch(err => {
              console.error('  ‚ùå B≈ÇƒÖd synchronizacji:', err);
              // Nawet przy b≈Çƒôdzie, odblokuj po 3s
              window._syncDeleteTimeout = setTimeout(() => {
                window._isSyncingDelete = false;
                console.log('  üîì Flaga _isSyncingDelete = false (b≈ÇƒÖd - odblokujƒô loadFromDB)');
              }, 3000);
            });
          } else {
            // Nie mamy Firebase, wy≈ÇƒÖcz flagƒô natychmiast
            window._isSyncingDelete = false;
          }
          
          // Wymuszenie od≈õwie≈ºenia wszystkich widok√≥w
          setTimeout(() => {
            renderOrderPage(); 
            renderTasks(); 
            renderASPage(); 
            renderDash(window.state||state); 
            renderGantt();
            updateTasksBadge();
            if (typeof renderWarehouse === 'function') { try { renderWarehouse(); } catch (warehouseRenderErr) { console.warn('[order-delete] renderWarehouse error', warehouseRenderErr); } }
            if (typeof renderWarehouseWork === 'function') { try { renderWarehouseWork(); } catch (warehouseWorkErr) { console.warn('[order-delete] renderWarehouseWork error', warehouseWorkErr); } }
            if (typeof renderReservations === 'function') { try { renderReservations(); } catch (reservationsErr) { console.warn('[order-delete] renderReservations error', reservationsErr); } }
            if (typeof updateWarehouseWorkBadge === 'function') { try { updateWarehouseWorkBadge(); } catch (badgeErr) { console.warn('[order-delete] updateWarehouseWorkBadge error', badgeErr); } }
          }, 50);
          break;
        }
        if(t.dataset.oed) {
          const id = t.dataset.oed;
          const o = state.orders.find(x => x.id === id);
          if (!o) return;
          qs('#o-id').value = o.id || '';
          qs('#o-name').value = o.name || '';
          qs('#o-client').value = o.client || '';
          qs('#o-model').value = o.model || '';
          qs('#o-qty').value = o.quantity || 1;
          qs('#o-start').value = o.startDate || '';
          qs('#o-end').value = o.endDate || '';
          qs('#o-notes').value = o.notes || '';
          qs('#o-install').value = o.installDate || '';
          qs('#o-addr').value = o.address || '';
          qs('#o-post').value = o.postalCode || '';
          qs('#o-phone').value = o.phone || '';
          qs('#o-proc').value = o.processId || '';
          qs('#o-lead').value = o.leadEmployeeId || '';
          window.scrollTo({top: 0, behavior: 'smooth'});
          break;
        }
        if(t.dataset.checklist) {
          const orderId = t.dataset.checklist;
          showMaterialChecklist(orderId);
          break;
        }
        if(t.dataset.ogen) {
          const id = t.dataset.ogen; const o = state.orders.find(x => x.id === id); if (!o) return;
          qs('#o-id').value = o.id || '';
          qs('#o-name').value = o.name || '';
          qs('#o-client').value = o.client || '';
          qs('#o-model').value = o.model || '';
          qs('#o-qty').value = o.quantity || 1;
          qs('#o-start').value = o.startDate || '';
          qs('#o-end').value = o.endDate || '';
          qs('#o-notes').value = o.notes || '';
          qs('#o-install').value = o.installDate || '';
          qs('#o-addr').value = o.address || '';
          if(qs('#o-post')) qs('#o-post').value = o.postalCode || o.post || '';
          qs('#o-post').value = o.postalCode || '';
          qs('#o-phone').value = o.phone || '';
          qs('#o-name').value = o.name || o.number || o.orderNumber || '';
          qs('#o-proc').value = o.processId || '';
          // Sprawd≈∫ czy zlecenie ma przypisany proces
          if (!o.processId) {
            alert('To zlecenie nie ma przypisanego procesu. Najpierw wybierz proces w edycji zlecenia.');
            break;
          }
          
          // Znajd≈∫ przypisany proces
          let p = state.processes.find(x => x.id === o.processId);
          if (!p) {
            alert('Nie znaleziono przypisanego procesu (ID: ' + o.processId + '). Wybierz inny proces.');
            break;
          }
          
          // Sprawd≈∫ czy proces ma operacje
          if (!p.operations || !p.operations.length) {
            alert('Wybrany proces nie zawiera ≈ºadnych operacji. Wybierz inny proces lub dodaj operacje do obecnego.');
            break;
          }
          
          // Sprawd≈∫ czy zam√≥wienie ju≈º ma zadania
          const existingOrderTasks = (state.tasks || []).filter(t => t.orderId === o.id);
          if (existingOrderTasks.length > 0) {
            alert('To zam√≥wienie ju≈º ma wygenerowane zadania. Je≈õli chcesz wygenerowaƒá ponownie, najpierw usu≈Ñ istniejƒÖce zadania.');
            break;
          }
          
          console.log('Przed generowaniem zada≈Ñ:', {
            currentTasks: state.tasks ? state.tasks.length : 0,
            currentOrderId: o.id
          });
          
          // Zachowaj istniejƒÖce zadania niezwiƒÖzane z tym zleceniem
          const existingTasks = Array.isArray(state.tasks) ? state.tasks : [];
          const otherTasks = existingTasks.filter(t => t.orderId !== o.id);
          const newTasks = [];
          
          console.log('Generowanie zada≈Ñ z procesu:', {
            processId: p.id,
            processName: p.name,
            operations: p.operations.length
          });
          
          // Dodaj nowe zadania z procesu wybranego dla zlecenia
          (p.operations || []).forEach(op => {
            // Znajd≈∫ definicjƒô operacji w katalogu
            const catalogOp = (state.operationsCatalog || []).find(co => co.name === op.name);
            
            // U≈ºyj przypisa≈Ñ z procesu, a je≈õli brak to z katalogu operacji
            const assignees = op.assignee ? [op.assignee] : 
                            (catalogOp && catalogOp.defaultAssignees ? catalogOp.defaultAssignees : []);
            
            // U≈ºyj czasu z operacji w procesie, a je≈õli nie ma to z katalogu operacji
            const opTime = op.time || (catalogOp && catalogOp.time) || 0;
            
            newTasks.push({
              id: uid(), 
              orderId: o.id,
              processId: p.id, // Dodajemy ID procesu
              opName: op.name,
              status: 'todo',
              elapsedMin: 0,
              estMin: opTime,
              assignees: assignees,
              processName: p.name, // Dodajemy nazwƒô procesu
              opIndex: p.operations.indexOf(op) // Dodajemy indeks operacji w procesie
            });
          });
          
          // Po≈ÇƒÖcz istniejƒÖce zadania z nowymi
          state.tasks = [...otherTasks, ...newTasks];
          
          console.log('Po dodaniu nowych zada≈Ñ:', {
            newTasks: newTasks.length,
            finalTasks: state.tasks.length,
            sample: state.tasks.slice(0, 3)
          });
          
          // Upewnij siƒô ≈ºe state.tasks jest tablicƒÖ
          if (!Array.isArray(state.tasks)) {
            console.error('state.tasks nie jest tablicƒÖ!', state.tasks);
            state.tasks = [];
          }
          
          save(); try{ updateOrderProgress(o.id); }catch(_){ } nav('tasks'); break;
        }
        if(t.dataset.opEd) {
          const id = t.dataset.opEd; const o = (state.operationsCatalog || []).find(x => x.id === id); if (!o) return;
          qs('#op-id').value = o.id || ''; qs('#op-no').value = o.no || 1; qs('#op-name').value = o.name || '';
          qs('#op-time').value = o.time || 10; qs('#op-workers').value = o.workers || 1;
          qs('#op-skills').value = (o.skills || []).join(';'); populateOpEmployees();
          const sel = qs('#op-emp'); const set = new Set((o.defaultAssignees || []).map(a => a.id));
          Array.from(sel.options || []).forEach(opt => opt.selected = set.has(opt.value));
          loadOpChecklistDraftFromOperation(o);
          qs('#op-msg').textContent = ''; break;
        }
        if(t.dataset.opDel) {
          const id = t.dataset.opDel; if (!confirm('UsunƒÖƒá operacjƒô?')) return;
          console.log('üóëÔ∏è [DELETE] Usuwam operacjƒô:', id);
          state.operationsCatalog = (state.operationsCatalog || []).filter(x => x.id !== id);
          ensureOperationsCatalogChecklists(state.operationsCatalog);
          // Dodaj do listy usuniƒôtych operacji (podobnie jak deletedProcesses)
          state.deletedOperations = Array.isArray(state.deletedOperations) ? state.deletedOperations : [];
          if (!state.deletedOperations.includes(id)) {
            state.deletedOperations.push(id);
            if (state.deletedOperations.length > 200) {
              state.deletedOperations = state.deletedOperations.slice(-200);
            }
          }
          console.log('üóëÔ∏è [DELETE] Lista usuniƒôtych operacji:', state.deletedOperations);
          // üîß OSOBNY ZAPIS do localStorage - zabezpieczenie przed utratƒÖ
          try {
            localStorage.setItem('deletedOperations_backup', JSON.stringify(state.deletedOperations));
            console.log('üíæ [DELETE] Zapisano deletedOperations do backup:', state.deletedOperations);
          } catch(e) { console.warn('Nie uda≈Ço siƒô zapisaƒá deletedOperations backup:', e); }
          
          save(); renderOps();
          // Usu≈Ñ z Firebase
          if(state.storage && state.storage.mode === 'firebase'){
            (async () => {
              try {
                if (await ensureFirebase()) {
                  console.log('üî• [DELETE] Usuwam z Firebase:', id);
                  await fbRoot().collection('operationsCatalog').doc(id).delete();
                  console.log('‚úÖ [DELETE] Usuniƒôto z Firebase:', id);
                  console.log(`‚úÖ Operacja '${id}' usuniƒôta z Firebase`);
                }
              } catch (e) {
                console.warn('B≈ÇƒÖd usuwania operacji z Firebase:', e.message);
              }
            })();
          }
          break;
        }
        if(t.dataset.opUp) { moveOp(t.dataset.opUp, 'up'); break; }
        if(t.dataset.opDown) { moveOp(t.dataset.opDown, 'down'); break; }
        if(t.dataset.pup) { const i = +t.dataset.pup; const a = state.PROC_TMP; if (i > 0) { [a[i - 1], a[i]] = [a[i], a[i - 1]]; renderProcOps(); } break; }
        if(t.dataset.pdown) { const i = +t.dataset.pdown; const a = state.PROC_TMP; if (i < a.length - 1) { [a[i + 1], a[i]] = [a[i], a[i + 1]]; renderProcOps(); } break; }
        if(t.dataset.pdel) { const i = +t.dataset.pdel; state.PROC_TMP.splice(i, 1); renderProcOps(); break; }
        if(t.dataset.ped) {
          const p = state.processes.find(x => x.id === t.dataset.ped); if (!p) return; qs('#proc-id').value = p.id;
          qs('#proc-name').value = p.name;
          // Za≈Çaduj szablon materia≈Çowy
          const templateSel = qs('#proc-template-select');
          if (templateSel) templateSel.value = p.materialTemplateId || '';
          // preserve assignee and dependsOn when loading for edit
          state.PROC_TMP = (p.operations || []).map(x => ({id: x.id || uid('op'), name: x.name, time: x.time || 0, assignee: x.assignee || null, dependsOn: x.dependsOn}));
          // Rozwi≈Ñ formularz przy edycji
          qs('#proc-form').classList.remove('hidden');
          qs('#proc-form-toggle').textContent = '‚ñ≤';
          renderProcOps(); window.scrollTo({top: 0, behavior: 'smooth'}); break;
        }
        if(t.dataset.pdel2) {
          const id = t.dataset.pdel2;
          console.log('üóëÔ∏è [DELETE PROCESS] Usuwam proces:', id);
          
          // üîí BLOKUJ AUTO-SYNC podczas usuwania
          window._isSyncingDelete = true;
          console.log('üîí [DELETE PROCESS] Blokujƒô auto-sync');
          
          state.processes = state.processes.filter(x => x.id !== id);
          state.deletedProcesses = Array.isArray(state.deletedProcesses) ? state.deletedProcesses : [];
          if (!state.deletedProcesses.includes(id)) {
            state.deletedProcesses.push(id);
            if (state.deletedProcesses.length > 200) {
              state.deletedProcesses = state.deletedProcesses.slice(-200);
            }
          }
          console.log('üóëÔ∏è [DELETE PROCESS] Lista usuniƒôtych proces√≥w:', state.deletedProcesses);
          state.lastModified = Date.now(); // Aktualizuj timestamp
          save();
          renderProcList();
          
          if(state.storage && state.storage.mode === 'firebase'){
            (async () => {
              try {
                if (await ensureFirebase()) {
                  console.log('üî• [DELETE PROCESS] Usuwam z Firebase:', id);
                  
                  // 1. Usu≈Ñ proces z Firebase
                  await fbRoot().collection('processes').doc(id).delete();
                  console.log('‚úÖ [DELETE PROCESS] Usuniƒôto z Firebase:', id);
                  
                  // 2. Zapisz deletedProcesses do Firebase (aby inne karty/domeny wiedzia≈Çy)
                  await fbRoot().collection('metadata').doc('deletedProcesses').set({
                    ids: state.deletedProcesses,
                    updatedAt: Date.now()
                  }, { merge: true });
                  console.log('‚úÖ [DELETE PROCESS] Zapisano deletedProcesses do Firebase');
                  
                  // 3. Aktualizuj metadata timestamp
                  await fbRoot().collection('metadata').doc('sync').set({
                    lastModified: Date.now()
                  }, { merge: true });
                }
              } catch(err) {
                console.error('‚ùå [DELETE PROCESS] B≈ÇƒÖd usuwania z Firebase:', err);
              } finally {
                // üîì ODBLOKUJ AUTO-SYNC po 3 sekundach
                setTimeout(() => {
                  window._isSyncingDelete = false;
                  console.log('üîì [DELETE PROCESS] Odblokowano auto-sync');
                }, 3000);
              }
            })();
          } else {
            // Odblokuj je≈õli nie Firebase
            setTimeout(() => {
              window._isSyncingDelete = false;
            }, 1000);
          }
          break; }
        if(t.dataset.taskStart) {
          const id = t.dataset.taskStart; const task = state.tasks.find(x => x.id === id); if (!task) return;
          task.status = 'run'; state._timers[id] = Date.now(); save(); try{ updateOrderProgress(task.orderId); }catch(_){ } renderTasks(); break;
        }
        if(t.dataset.taskPause) {
          const id = t.dataset.taskPause; const task = state.tasks.find(x => x.id === id); if (!task) return;
          if (state._timers[id]) { task.elapsedMin = (task.elapsedMin || 0) + (Date.now() - state._timers[id]) / 60000; delete state._timers[id]; }
          task.status = 'paused'; save(); try{ updateOrderProgress(task.orderId); }catch(_){ } renderTasks(); maybeAutoSave('task-pause'); break;
        }
        if(t.dataset.taskResume) {
          const id = t.dataset.taskResume; const task = state.tasks.find(x => x.id === id); if (!task) return;
          task.status = 'run'; save(); try{ updateOrderProgress(task.orderId); }catch(_){ } renderTasks(); maybeAutoSave('task-resume'); break;
        }
        if(t.dataset.taskDone) {
          const id = t.dataset.taskDone; const task = state.tasks.find(x => x.id === id); if (!task) return;
          if (state._timers[id]) { task.elapsedMin = (task.elapsedMin || 0) + (Date.now() - state._timers[id]) / 60000; delete state._timers[id]; }
          task.status = 'done'; 
          // Odblokuj zadania kt√≥re czeka≈Çy na to zadanie
          unlockDependentTasks(id);
          save(); try{ updateOrderProgress(task.orderId); }catch(_){ } renderTasks(); break;
        }
        if(t.dataset.taskRepeat) {
          const id = t.dataset.taskRepeat; const task = state.tasks.find(x => x.id === id); if (!task) return;
          if (state._timers[id]) delete state._timers[id];
          task.status = 'todo';
          task.elapsedMin = 0;
          task.startTime = null;
          task.endTime = null;
          task.startedAt = null;
          task.closedAt = null;
          task.startedBy = null;
          task.closedBy = null;
          task._resetAt = Date.now(); // Znacznik resetu dla worker-app
          // Resetuj checklistƒô
          if (Array.isArray(task.checklist)) {
            task.checklist = task.checklist.map(item => ({...item, done: false}));
          }
          save();
          try{ updateOrderProgress(task.orderId); }catch(_){ }
          renderTasks();
          // KLUCZOWE: Zapisz reset do Firebase ≈ºeby worker-app go otrzyma≈Ç
          if(state.storage && state.storage.mode === 'firebase'){
            (async () => {
              try{ await saveTaskToDB(id); console.log('‚úÖ [Powt√≥rz] Zapisano reset zadania do Firebase:', id); }catch(e){ console.warn('taskRepeat saveToDB error', e && e.message); }
            })();
          }
          break;
        }
        if(t.dataset.taskRetry) {
          const id = t.dataset.taskRetry; const task = state.tasks.find(x => x.id === id); if (!task) return;
          task._syncPending = true; task._syncError = false; save(); try{ renderTasks(); }catch(_){ }
          if(state.storage && state.storage.mode === 'firebase'){
            try{ await saveTaskToDB(id); }catch(e){ (window.logDev||console.warn)('taskRetry saveToDB error', e && e.message); }
          }
          break;
        }
        if(t.dataset.taskDel) { const id = t.dataset.taskDel; 
          const ask = state.storage.askBeforeTaskDelete === undefined ? true : !!state.storage.askBeforeTaskDelete;
          const doDelete = await (async ()=>{
            if(!ask) return true;
            try{ return await confirmModal('UsunƒÖƒá zadanie?'); }catch(_){ return false; }
          })();
          if(!doDelete) return; 
          const toDel = (state.tasks||[]).find(x=>x.id===id); 
          state.tasks = (state.tasks||[]).filter(x=>x.id!==id);
          if(taskStatusBaseline && typeof taskStatusBaseline.delete === 'function'){ taskStatusBaseline.delete(id); }
          if(taskStatusSnapshot && typeof taskStatusSnapshot.delete === 'function'){ taskStatusSnapshot.delete(id); }
          save();
          try{ if(toDel) updateOrderProgress(toDel.orderId); }catch(_){ }
          renderTasks();
          maybeAutoSave('task-delete');
          if(state.storage && state.storage.mode === 'firebase' && !state.storage.autoSaveAssign){
            if(window.FirebaseSyncQueue && typeof window.FirebaseSyncQueue.enqueue === 'function'){
              window.FirebaseSyncQueue.enqueue('save', { state: window.state }, 25);
            } else {
              try{ await saveToDB(); }catch(syncErr){ console.warn('task-delete sync error', syncErr && syncErr.message); }
            }
          }
          break; }
        if(t.dataset.empDel) { 
          const empId = t.dataset.empDel;
          state.employees = state.employees.filter(x => x.id !== empId); 
          save(); 
          renderEmployees(); 
          maybeAutoSave('employee-delete');
          break; 
        }
        if(t.dataset.empEd) {
          const e = state.employees.find(x => x.id === t.dataset.empEd); if (!e) return;
          // Wype≈Çnij formularz edycji
          const formContainer = qs('#emp-form-container');
          const formTitle = formContainer?.querySelector('[style*="font-weight:600"]');
          if(formTitle) formTitle.textContent = '‚úèÔ∏è Edycja pracownika';
          qs('#emp-form-id').value = e.id;
          qs('#emp-form-name').value = e.name || '';
          qs('#emp-form-role').value = e.role || '';
          qs('#emp-form-cap').value = e.cap || 100;
          qs('#emp-form-hours').value = e.hoursPerDay || 8;
          qs('#emp-form-phone').value = e.phone || '';
          if(formContainer) formContainer.classList.remove('hidden');
          qs('#emp-form-name')?.focus();
          break;
        }
        if(t.dataset.assign) {
          // Assign task to employee with conflict detection
          const taskId = t.dataset.assign;
          const employeeId = t.dataset.assignEmployee; // ID pracownika z atrybutu data-assign-employee
          
          if(!taskId || !employeeId) {
            console.warn('Assign button missing taskId or employeeId');
            maybeAutoSave('assign');
            break;
          }
          
          const task = (state.tasks || []).find(x => x.id === taskId);
          if(!task) {
            console.warn('Task not found:', taskId);
            break;
          }
          
          // Sprawd≈∫ konflikty przed przypisaniem
          if(window.resourceConflictDetector && window.resourceConflictDetector.validateAssignment) {
            try {
              const isValid = window.resourceConflictDetector.validateAssignment(task, employeeId);
              if(isValid) {
                // Przypisz pracownika
                task.assignees = [employeeId];
                task._manuallyAssigned = true;
                save();
                renderTasks();
                console.log(`‚úÖ Przypisano pracownika ${employeeId} do zadania ${task.opName}`);
              } else {
                console.log('‚ùå Przypisanie anulowane z powodu konflikt√≥w');
              }
            } catch(err) {
              console.error('B≈ÇƒÖd walidacji przypisania:', err);
              // Fallback: przypisz bez walidacji
              task.assignees = [employeeId];
              save();
              renderTasks();
            }
          } else {
            // Brak detektora konflikt√≥w - przypisz bez walidacji
            task.assignees = [employeeId];
            save();
            renderTasks();
          }
          
          maybeAutoSave('assign');
          break;
        }
        if(t.dataset.taskStart){
          const id = t.dataset.taskStart; const task = (state.tasks||[]).find(x=>x.id===id); if(!task) break;
          // mark as running
          task.status = 'run';
          task.startedAt = new Date().toISOString();
          task.startedBy = (state.storage && state.storage.userId) || task.startedBy || null;
          if(typeof task.elapsedMin === 'undefined') task.elapsedMin = 0;
          save(); try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
          maybeAutoSave('task-start');
          break;
        }
        if(t.dataset.taskPause){
          const id = t.dataset.taskPause; const task = (state.tasks||[]).find(x=>x.id===id); if(!task) break;
          task.status = 'paused';
          save(); try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
          maybeAutoSave('task-pause');
          break;
        }
        if(t.dataset.taskResume){
          const id = t.dataset.taskResume; const task = (state.tasks||[]).find(x=>x.id===id); if(!task) break;
          task.status = 'run';
          save(); try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
          maybeAutoSave('task-resume');
          break;
        }
        if(t.dataset.taskDone){
          const id = t.dataset.taskDone; const task = (state.tasks||[]).find(x=>x.id===id); if(!task) break;
          task.status = 'done'; task.closedAt = new Date().toISOString(); task.closedBy = (state.storage && state.storage.userId) || task.closedBy || null;
          try{ if(task.startedAt){ const s = new Date(task.startedAt); const diff = (Date.now() - s.getTime())/60000; task.elapsedMin = Math.round((task.elapsedMin||0) + diff); } }catch(_){ }
          save(); try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
          // after marking a task done, if all tasks for the same order are finished, remove tasks for that order
          try{ if(task.orderId){ cleanupTasksForOrder(task.orderId); } }catch(_){ }
          maybeAutoSave('task-done');
          break;
        }
        if(t.dataset.asDel) { 
          const asId = t.dataset.asDel;
          // Remove from state.after
          state.after = state.after.filter(x => x.id !== asId);
          
          // Remove associated tasks from state.tasks
          const tasksToRemove = (state.tasks || []).filter(x => x.assemblyId === asId);
          if(tasksToRemove.length > 0) {
             console.log('üóëÔ∏è Usuwam powiƒÖzane zadania monta≈ºowe:', tasksToRemove.length);
             state.tasks = state.tasks.filter(x => x.assemblyId !== asId);
             
             // Remove from Firebase if needed
             if(state.storage && state.storage.mode === 'firebase' && typeof ensureFirebase === 'function' && typeof fbRoot === 'function') {
                ensureFirebase().then(async () => {
                   for(const task of tasksToRemove) {
                      try { await fbRoot().collection('tasks').doc(task.id).delete(); } catch(e) { console.warn(e); }
                   }
                });
             }
          }
          
          save(); 
          renderASPage(); 
          if(typeof renderTasks === 'function') renderTasks();
          break; 
        }
        if(t.dataset.asTaskDel) { 
          const taskId = t.dataset.asTaskDel;
          if(confirm('Czy na pewno usunƒÖƒá to zadanie monta≈ºowe?')){
            state.tasks = state.tasks.filter(x => x.id !== taskId); 
            save(); 
            renderASPage();
            if(typeof renderTasks === 'function') renderTasks();
          }
          break; 
        }
        if(t.dataset.asTaskEd) {
          const taskId = t.dataset.asTaskEd;
          const task = state.tasks.find(x => x.id === taskId);
          if(!task) return;
          
          // Otw√≥rz formularz i wype≈Çnij danymi
          const formContainer = qs('#as-task-form-container');
          if(!formContainer) return;
          
          // Wype≈Çnij listƒô zlece≈Ñ
          const orderSelect = qs('#as-task-order');
          if(orderSelect){
            orderSelect.innerHTML = '<option value="">‚Äî Brak powiƒÖzania ‚Äî</option>';
            (state.orders||[]).forEach(o=>{
              const opt = document.createElement('option');
              opt.value = o.id;
              opt.textContent = o.name;
              if(o.id === task.orderId) opt.selected = true;
              orderSelect.appendChild(opt);
            });
          }
          
          // Wype≈Çnij listƒô pracownik√≥w
          const empSelect = qs('#as-task-employees');
          if(empSelect){
            empSelect.innerHTML = '';
            const taskEmpIds = task.assignees || (task.employeeId ? [task.employeeId] : []);
            (state.employees||[]).forEach(e=>{
              const opt = document.createElement('option');
              opt.value = e.id;
              opt.textContent = e.name;
              if(taskEmpIds.includes(e.id)) opt.selected = true;
              empSelect.appendChild(opt);
            });
          }
          
          // Wype≈Çnij formularz
          qs('#as-task-form-container').dataset.editId = task.id;
          qs('#as-task-number').value = task.taskNumber || '';
          qs('#as-task-type').value = task.type || 'monta≈º';
          qs('#as-task-name').value = task.opName || task.name.replace(/^[üìèüîßüî®üööüìã]\s*/, '');
          qs('#as-task-date').value = task.installDate || '';
          qs('#as-task-depart').value = task.departTime || '';
          qs('#as-task-visit').value = task.visitTime || '';
          qs('#as-task-client').value = task.client || '';
          qs('#as-task-address').value = task.address || '';
          qs('#as-task-postal').value = task.postalCode || '';
          qs('#as-task-phone').value = task.phone || '';
          qs('#as-task-hours').value = task.estMin ? (task.estMin/60) : 2;
          qs('#as-task-priority').value = task.priority || 'normal';
          qs('#as-task-notes').value = task.notes || '';
          
          // Zmie≈Ñ tytu≈Ç na nazwƒô klienta lub domy≈õlny tekst
          const formTitle = formContainer.querySelector('h4');
          if(formTitle) {
            const clientDisplay = task.client && task.client !== '-' ? task.client : 'Brak klienta';
            formTitle.textContent = `‚úèÔ∏è ${clientDisplay}`;
          }
          
          formContainer.classList.remove('hidden');
          qs('#as-task-name')?.focus();
          break;
        }
        if(t.dataset.asEd) {
          const a = state.after.find(x => x.id === t.dataset.asEd); if (!a) return; qs('#as-id').value = a.id;
          qs('#as-type').value = a.type; qs('#as-order').value = a.order || ''; qs('#as-status').value = a.status;
          qs('#as-desc').value = a.desc || ''; qs('#as-install').value = a.installDate || '';
          qs('#as-go').value = a.departTime || ''; qs('#as-visit').value = a.visitTime || '';
          // populate phone, placecode and address fields
          qs('#as-phone').value = a.phone || '';
          qs('#as-placecode').value = a.postalCode || a.placeCode || '';
          qs('#as-address').value = a.address || '';
          qs('#as-hours').value = a.hours || '';
          // populate lead employee and client from related order
          const relatedOrder = (state.orders||[]).find(o => o.id === a.order);
          if(relatedOrder) {
            qs('#as-client').value = relatedOrder.client || '';
            if(relatedOrder.leadEmployeeId) {
              const leadEmp = (state.employees||[]).find(e => e.id === relatedOrder.leadEmployeeId);
              qs('#as-lead').value = leadEmp ? leadEmp.name : '';
            } else {
              qs('#as-lead').value = '';
            }
          } else {
            qs('#as-client').value = '';
            qs('#as-lead').value = '';
          }
          // Select appropriate employees in multi-select (support both old and new format)
          const empIds = a.employeeIds || (a.employeeId ? [a.employeeId] : []);
          const empSel = qs('#as-employees');
          if(empSel) {
            Array.from(empSel.options).forEach(opt => {
              opt.selected = empIds.includes(opt.value);
            });
          }
          window.scrollTo({top: 0, behavior: 'smooth'});
          break;
        }
        if(t.dataset.refreshAs) { loadFromDB(); break; }
        if (t.id === 'mrp-generate') { renderMRPPage(); break; }
      } else if (e.type === 'input') {
        if(e.target && (e.target.id === 'o-start' || e.target.id === 'o-weeks' || e.target.id === 'o-end')) {
            if (e.target.id === 'o-start' || e.target.id === 'o-weeks') {
                calcEndDate();
            } else if (e.target.id === 'o-end') {
                calcInstallDate();
            }
            break;
        }
        if (t.parentElement && t.parentElement.id === 'p-settings') {
          state.storage.mode = qs('#set-mode').value;
          state.storage.appId = qs('#set-appid').value.trim();
          state.storage.userId = qs('#set-userid').value.trim();
          try { state.storage.fbConfig = JSON.parse(qs('#set-fb').value || '{}'); } catch(e) {}
          save();
          updateConnectionStatus();
          break;
        }
      }
      t = t.parentElement;
    }
  };
  document.addEventListener('click', handleEvents);

  // Tryb awaryjny: bezpo≈õrednie listenery dla data-nav i krytycznych przycisk√≥w
  window.initDirectNavHandlers = function(){
    try{
      console.log('[rescue] Installing direct nav handlers');
      document.querySelectorAll('[data-nav]').forEach(el=>{
        if(el.__directNavBound) return;
        el.addEventListener('click', (ev)=>{ if(window.disableGlobalClickDelegation){ ev.preventDefault(); ev.stopPropagation(); nav(el.getAttribute('data-nav')); } });
        el.__directNavBound = true;
      });
      // Magazyn przyciski
      // Kod bezpo≈õrednich listener√≥w dla magazynu usuniƒôty
      console.log('[rescue] Direct handlers ready');
    }catch(e){ console.warn('[rescue] direct nav error', e); }
  };
  
  // Funkcja w≈ÇƒÖczajƒÖca tryb awaryjny (wy≈ÇƒÖcza delegacjƒô, dodaje bezpo≈õrednie listenery)
  window.enableNoDelegateMode = function(){
    console.warn('[BLOCKED] No-delegation mode DISABLED - normal delegation required for this app');
    // Automatycznie przywr√≥ƒá normalnƒÖ delegacjƒô
    window.restoreNormalClickDelegation();
    return false;
  };

  // NOWA FUNKCJA: Przywracanie normalnej delegacji klikniƒôƒá - PRZENIESIONA WY≈ªEJ
  // window.restoreNormalClickDelegation = function(){
  //   window.disableGlobalClickDelegation = false;
  //   console.log('[rescue] Normal click delegation RESTORED');
  //   // Zapobiegaj ponownemu w≈ÇƒÖczeniu - nadpisz funkcjƒô awaryjnƒÖ
  //   window.enableNoDelegateMode = function(){
  //     console.warn('[rescue] No-delegation mode BLOCKED - normal delegation required');
  //     return false;
  //   };
  // };

  // Awaryjna funkcja przywracania klikalno≈õci
  window.enableClicksRescue = function(){
    try{
      console.log('[rescue] Starting click rescue...');
      document.body.style.pointerEvents='auto';
      document.body.style.userSelect='auto';
      // Usu≈Ñ potencjalne pe≈Çnoekranowe zas≈Çony (heurystyka)
      const vw=innerWidth, vh=innerHeight;
      let removed=0;
      document.querySelectorAll('body *').forEach(el=>{
        try{
          const st=getComputedStyle(el); if(st.position!=='fixed'&&st.position!=='absolute') return;
          const r=el.getBoundingClientRect();
          if(r.width>vw*0.98 && r.height>vh*0.98){
            if(st.pointerEvents!=='none' && !el.id.includes('dev-log')){
              el.style.pointerEvents='none'; el.style.opacity='0.999'; removed++;
            }
          }
        }catch(_){/* ignore */}
      });
      console.log('[rescue] Processed overlays, modified:', removed);
      // Dodaj testowy przycisk diagnostyczny
      if(!document.getElementById('__click_test_btn')){
        const b=document.createElement('button'); b.id='__click_test_btn'; b.textContent='test click'; b.style.cssText='position:fixed;top:4px;right:4px;z-index:999999;padding:4px 8px;font-size:12px';
        b.addEventListener('click',()=>console.log('[rescue] test button clicked OK'));
        document.body.appendChild(b);
      }
      console.log('[rescue] Click rescue finished.');
    }catch(e){ console.warn('[rescue] error', e); }
  };

  // DEBUG: when Edit buttons are clicked (data-op-ed), log the event and #op-id after population
  (function attachOpEditLog(){
    document.body.addEventListener('click', function(ev){
      const btn = ev.target.closest && ev.target.closest('[data-op-ed]');
      if(!btn) return; const opId = btn.getAttribute('data-op-ed');
      (window.logDev||console.log)('[ui] Edit click', { dataOpEd: opId });
      // schedule a short tick to log #op-id after any population logic runs
      setTimeout(()=>{ const cur = qs('#op-id')?qs('#op-id').value:''; (window.logDev||console.log)('[ui] #op-id after edit click', cur); }, 50);
    }, true);
  })();
  document.addEventListener('input', handleEvents);

  // sync storage mode select UI with state on load
  try{ const sm = qs('#set-mode'); if(sm) sm.value = state.storage.mode || 'firebase'; }catch(e){}
  // sync autosave checkbox UI with state on load
  try{ const cb = qs('#set-autosave-assign'); if(cb) cb.checked = !!state.storage.autoSaveAssign; }catch(e){}
  // sync autoload DB checkbox UI with state on load
  try{ const al = qs('#set-autoload-db'); if(al) al.checked = !!state.storage.autoLoadFromDB; }catch(e){}
  // sync monitor threshold UI with state on load
  try{ const th = qs('#set-monitor-threshold'); if(th) th.value = String(state.storage.monitorThreshold || 5); }catch(e){}
  // sync monitor alerts UI with state on load
  try{ const ma = qs('#set-monitor-alerts'); if(ma) ma.checked = (state.storage.monitorAlertsEnabled !== false); }catch(e){}
  // sync auto-cleanup UI with state on load
  try{ const ac = qs('#set-auto-cleanup'); if(ac) ac.checked = (state.settings && state.settings.autoCleanup !== false); }catch(e){}
  // sync spellcheck enforce checkbox UI with state on load
  try{ const sc = qs('#set-spellcheck-enforce'); if(sc) sc.checked = !!state.storage.spellcheckEnforce; }catch(e){}

  // persist autosave checkbox changes
  const autosaveEl = qs('#set-autosave-assign'); if(autosaveEl){ autosaveEl.addEventListener('change', (ev)=>{ state.storage.autoSaveAssign = !!ev.target.checked; save(); }); }
  // persist autoload checkbox changes
  const autoloadEl = qs('#set-autoload-db'); if(autoloadEl){ autoloadEl.addEventListener('change', (ev)=>{ state.storage.autoLoadFromDB = !!ev.target.checked; save(); }); }
  // persist monitor threshold changes
  const monitorThEl = qs('#set-monitor-threshold'); if(monitorThEl){ monitorThEl.addEventListener('change', (ev)=>{ const v = parseInt(ev.target.value||'5',10) || 5; state.storage.monitorThreshold = Math.max(1, v); save(); }); }
  // persist monitor alerts changes
  const monitorAlertEl = qs('#set-monitor-alerts'); if(monitorAlertEl){ monitorAlertEl.addEventListener('change', (ev)=>{ state.storage.monitorAlertsEnabled = !!ev.target.checked; save(); }); }
  // persist auto-cleanup changes
  const autoCleanupEl = qs('#set-auto-cleanup'); if(autoCleanupEl){ autoCleanupEl.addEventListener('change', (ev)=>{ state.settings.autoCleanup = !!ev.target.checked; save(); }); }
  // persist spellcheck enforce changes
  const spellEl = qs('#set-spellcheck-enforce'); if(spellEl){ spellEl.addEventListener('change', (ev)=>{ state.storage.spellcheckEnforce = !!ev.target.checked; save(); if(ev.target.checked) enableSpellAndLang(); else disableSpellAndLang(); }); }

  // in-page confirmation modal (promise-based)
  function confirmModal(message){
    return new Promise((resolve)=>{
      try{
        const modal = qs('#app-confirm-modal'); const msg = qs('#app-confirm-msg'); const ok = qs('#app-confirm-ok'); const cancel = qs('#app-confirm-cancel'); const close = qs('#app-confirm-close'); const noask = qs('#app-confirm-noask');
        if(!modal || !msg || !ok || !cancel) return resolve(false);
        msg.textContent = String(message||'');
        modal.classList.remove('hidden');
        const cleanup = ()=>{ modal.classList.add('hidden'); ok.removeEventListener('click', onOk); cancel.removeEventListener('click', onCancel); close && close.removeEventListener('click', onCancel); };
        const onOk = ()=>{ const na = !!noask.checked; if(na) state.storage.askBeforeTaskDelete = false; save(); cleanup(); resolve(true); };
        const onCancel = ()=>{ const na = !!noask.checked; if(na) state.storage.askBeforeTaskDelete = false; save(); cleanup(); resolve(false); };
        ok.addEventListener('click', onOk); cancel.addEventListener('click', onCancel); if(close) close.addEventListener('click', onCancel);
      }catch(e){ resolve(false); }
    });
  }

  function addWorkdays(dateString, days) {
    let d = new Date(dateString + 'T00:00:00');
    let count = 0;
    while (count < days) {
      d.setDate(d.getDate() + 1);
      if (d.getDay() !== 0 && d.getDay() !== 6) {
        count++;
      }
    }
    return d.toISOString().slice(0, 10);
  }

  function calcEndDate() {
    const s = qs('#o-start').value;
    const w = +qs('#o-weeks').value || 1;
    if (!s) return;
    const end = addWorkdays(s, w * 5);
    qs('#o-end').value = end;
    calcInstallDate();
  }

  function calcInstallDate() {
    const end = qs('#o-end').value;
    if (!end) return;
    const install = addWorkdays(end, 7);
    qs('#o-install').value = install;
  }

  // Funkcja pomocnicza do ustawiania tekstu z dobrym kontrastem
  function setInfoText(text, type = 'default') {
    const info = qs('#set-info');
    if(!info) return;
    
    info.textContent = text;
    info.style.color = '#ffffff';
    info.style.fontWeight = '600';
    info.style.fontSize = '14px';
    info.style.padding = '4px 8px';
    info.style.borderRadius = '4px';
    info.style.border = '1px solid #334155';
    
    // Kolorystyka wed≈Çug typu wiadomo≈õci
    switch(type) {
      case 'success':
        info.style.background = '#059669'; // Zielone
        break;
      case 'warning':
        info.style.background = '#d97706'; // Pomara≈Ñczowe
        break;
      case 'error':
        info.style.background = '#dc2626'; // Czerwone
        break;
      default:
        info.style.background = '#1a2332'; // Domy≈õlne ciemnoniebieskie
    }
  }

  function updateConnectionStatus(){
    const info = qs('#set-info');
    if(!info) return;
    
    if(state.storage.mode === 'firebase'){
      setInfoText('Tryb Firebase - sprawdzam po≈ÇƒÖczenie...', 'default');
      // Sprawd≈∫ po≈ÇƒÖczenie z Firebase
      ensureFirebase().then(ok => {
        if(ok){
          setInfoText('‚úÖ Po≈ÇƒÖczono z Firebase', 'success');
        } else {
          setInfoText('‚ö†Ô∏è Firebase niedostƒôpny - tryb offline', 'warning');
        }
      }).catch(() => {
        setInfoText('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z Firebase', 'error');
      });
    } else {
      setInfoText('Tryb localStorage (offline)', 'default');
    }
  }
  // Upewnij siƒô ≈ºe funkcja dostƒôpna globalnie do diagnostyki ≈Çadowania
  window.updateConnectionStatus = window.updateConnectionStatus || updateConnectionStatus;
  
  function populateProcessSelect(){
    const sel = qs('#o-proc');
    if (sel) {
      sel.innerHTML = '<option value="">Brak</option>';
      (state.processes || []).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
      });
    }
  }

  function renderOrderPage(){
    populateProcessSelect();
    populateLeadSelect();
    const host=qs('#ord-tb'); if(!host) return; host.innerHTML='';
    // show progress column: percent + counts
    (state.orders||[]).slice().reverse().forEach(o=>{
      const tr=document.createElement('tr');
      const place = o.postalCode || o.post || '';
      const pr = computeOrderProgress(o.id) || (o.progress || {total:0,done:0,run:0,todo:0,pct:0});
      const pct = Math.round((pr.pct||0));
      const barWidth = Math.min(100, Math.max(0, pct));
      const bar = `<div style="background:#0b1222;border:1px solid #223044;border-radius:6px;height:12px;width:120px;overflow:hidden"><div style="height:100%;width:${barWidth}%;background:linear-gradient(90deg,#16a34a,#a3e635);"></div></div>`;
      // Lead time (planned) w godzinach
      const ts = (state.tasks||[]).filter(t=>t.orderId===o.id && t.startPlanned && t.endPlanned);
      let leadH = '-';
      if(ts.length){
        const startMin = Math.min(...ts.map(t=>t.startPlanned));
        const endMax = Math.max(...ts.map(t=>t.endPlanned));
        leadH = ((endMax - startMin)/3600000).toFixed(1);
      }
  const genBtn = o.tasksGenerated ? '' : `<button class=\"btn\" data-ogen=\"${o.id}\">Gen. zadania</button>`;
  const replanOneBtn = `<button class=\"btn amber\" data-replan-order=\"${o.id}\" title=\"Resetuj i przelicz tylko zadania tego zlecenia\">Replan</button>`;
  const checklistBtn = o.processId ? `<button class=\"btn blue\" data-checklist=\"${o.id}\" title=\"Poka≈º checklistƒô materia≈Ç√≥w\">üìã Checklist</button>` : '';
  
  // Oblicz status materia≈Ç√≥w dla zlecenia
  let materialsStatus = '-';
  let materialsBtn = '';
  if (o.materialChecklist && o.materialChecklist.length > 0) {
    const warehouseItems = window.warehouseItems || [];
    const reservations = window.warehouseReservations || [];
    let allAvailable = 0;
    let someShortage = 0;
    let notFound = 0;
    
    o.materialChecklist.forEach(item => {
      const warehouseItem = warehouseItems.find(w => w.id === item.itemId);
      if (!warehouseItem) {
        notFound++;
        return;
      }
      const reserved = reservations.filter(r => r.itemId === item.itemId && r.status === 'active').reduce((sum, r) => sum + (r.quantity || 0), 0);
      const available = warehouseItem.quantity - reserved;
      if (available >= item.quantity) {
        allAvailable++;
      } else if (available > 0) {
        someShortage++;
      } else {
        someShortage++;
      }
    });
    
    if (notFound === o.materialChecklist.length) {
      materialsStatus = '‚ùå Brak';
    } else if (allAvailable === o.materialChecklist.length) {
      materialsStatus = '‚úÖ Dostƒôpne';
    } else {
      materialsStatus = '‚ö†Ô∏è Braki';
    }
    materialsBtn = `<button class=\"btn blue\" onclick=\"window.showOrderMaterials('${o.id}')\" title=\"Poka≈º materia≈Çy i wydaj z magazynu\">üì¶ Materia≈Çy</button>`;
  }
  
  tr.innerHTML=`<td>${o.name||'-'}</td><td>${o.client||'-'}</td><td>${o.model||'-'}</td><td>${o.quantity||'-'}</td>
                    <td>${o.startDate||'-'}</td><td>${o.endDate||'-'}</td><td>${o.installDate||'-'}</td><td>${place||'-'}</td>
                    <td>${bar} <div class="muted" style="font-size:12px;margin-top:4px">${pct}% (${pr.done}/${pr.total})</div></td>
                    <td>${leadH}</td>
                    <td>${materialsStatus}<br>${materialsBtn}</td>
  <td style="min-width: 200px"><div class="row"><button class="btn" data-oed="${o.id}">Edytuj</button>${genBtn}${checklistBtn}${replanOneBtn}<button class="btn red" data-od="${o.id}">Usu≈Ñ</button></div></td>`;
      host.appendChild(tr);
    });
  }

  // Mini-Gantt v1 (z wierszem niezaplanowanych + widoczne dni wolne)
  function renderGantt(){
    const host = qs('#gantt-container'); if(!host) return;
    const all = (state.tasks||[]).slice();
    const scheduled = all.filter(t=>t.startPlanned && t.endPlanned);
    const unplanned = all.filter(t=>!(t.startPlanned && t.endPlanned));
    if(!scheduled.length && !unplanned.length){ host.innerHTML='<div class="muted">Brak zada≈Ñ</div>'; return; }
    const minStart = scheduled.length ? Math.min(...scheduled.map(t=>t.startPlanned)) : Date.now();
    const maxEnd = scheduled.length ? Math.max(...scheduled.map(t=>t.endPlanned)) : (minStart + 8*3600*1000);
    
    // Rozszerz zakres o kilka dni wstecz aby pokazaƒá weekend przed pierwszymi zadaniami
    const expandedStart = minStart - (3 * 24*3600*1000); // 3 dni wstecz
    const expandedEnd = maxEnd + (2 * 24*3600*1000); // 2 dni naprz√≥d
    const dayMs = 24*3600*1000;
    const days = Math.max(1, Math.ceil((expandedEnd - expandedStart)/dayMs));
    
    // Pobierz konfiguracjƒô dni wolnych
    const off = new Set(((state.scheduleConfig&&state.scheduleConfig.offWeekdays)||[]).map(Number));
    const holidays = new Set(((state.scheduleConfig&&state.scheduleConfig.holidays)||[]));
    
    let html = '<div style="position:relative;">';
    html += '<div style="display:flex;margin-bottom:4px">'+Array.from({length:days}).map((_,i)=>{
      const d=new Date(expandedStart + i*dayMs); 
      const y=d.getFullYear(); const m=(d.getMonth()+1+'').padStart(2,'0'); const dayNum=(d.getDate()+'').padStart(2,'0'); const key=`${y}-${m}-${dayNum}`;
      const isOff = off.has(d.getDay()) || holidays.has(key);
      const bgStyle = isOff ? 'background:repeating-linear-gradient(45deg,#2d1b34,#2d1b34 4px,#1e293b 4px,#1e293b 8px);opacity:0.7;' : 'background:#0f172a;';
      const title = isOff ? 'title="Dzie≈Ñ wolny - brak zada≈Ñ"' : '';
      return `<div style=\"flex:0 0 160px;border-right:1px solid #1e293b;padding:2px 4px;${bgStyle}color:#94a3b8\" ${title}>${d.toLocaleDateString()}</div>`; 
    }).join('')+'</div>';
    const byOrder = {};
    scheduled.forEach(t=>{ (byOrder[t.orderId]||(byOrder[t.orderId]=[])).push(t); });
    Object.keys(byOrder).forEach(oid=>{
      const orderName = (state.orders||[]).find(o=>o.id===oid)?.name || oid;
      html += `<div style=\"display:flex;align-items:stretch;margin-bottom:2px;\">`;
      html += `<div style=\"position:sticky;left:0;z-index:2;background:#0b1222;border:1px solid #1e293b;min-width:120px;padding:2px 4px;color:#e2e8f0;font-weight:600\">${orderName}</div>`;
      html += `<div style=\"display:flex;position:relative;\">`;
      const rowTasks = byOrder[oid].sort((a,b)=>a.startPlanned-b.startPlanned);
      rowTasks.forEach(t=>{
        const offsetDays=(t.startPlanned-expandedStart)/dayMs; // U≈ºyj expandedStart zamiast minStart
        const spanDays=(t.endPlanned-t.startPlanned)/dayMs;
        const left=offsetDays*160;
        const width=Math.max(6, spanDays*160 - 4);
        const crit=t.critical?'box-shadow:0 0 0 2px #dc2626 inset;':'';
        const tip=`${t.name||t.opName||''}\n${new Date(t.startPlanned).toLocaleString()} -> ${new Date(t.endPlanned).toLocaleString()}\nStatus: ${t.status||'-'}\nCzas: ${(t.estMin||t.duration||0)} min`;
        html += `<div title=\"${tip}\" style=\"position:absolute;left:${left}px;width:${width}px;height:18px;background:linear-gradient(90deg,#3b82f6,#06b6d4);border-radius:4px;border:1px solid #1e293b;${crit}overflow:hidden;\"></div>`;
      });
      for(let d=0; d<days; d++){ const gx=d*160; html += `<div style=\"position:absolute;left:${gx}px;top:0;bottom:0;width:160px;border-right:1px solid #1e293b;pointer-events:none\"></div>`; }
      html += `</div>`;
      html += `</div>`;
    });
    if(unplanned.length){
      html += `<div style=\"display:flex;align-items:stretch;margin-top:4px;\">`;
      html += `<div style=\"position:sticky;left:0;z-index:2;background:#0b1222;border:1px solid #1e293b;min-width:120px;padding:2px 4px;color:#fbbf24;font-weight:600\">(Niezaplanowane)</div>`;
      html += `<div style=\"display:flex;flex-wrap:wrap;gap:4px;padding:2px 4px;max-width:calc(160px*${days});\">`;
      unplanned.slice(0,200).forEach(t=>{ const label=(t.name||t.opName||'Zadanie').slice(0,24); const tip=`${t.name||t.opName||''}\nStatus: ${t.status||'-'}\nCzas: ${(t.estMin||t.duration||0)} min`; html += `<div title=\"${tip}\" style=\"background:#334155;color:#e2e8f0;font-size:11px;padding:2px 6px;border-radius:4px;border:1px solid #1e293b;\">${label}</div>`; });
      if(unplanned.length>200){ html += `<div style=\"font-size:11px;color:#94a3b8\">+${unplanned.length-200} wiƒôcej...</div>`; }
      html += `</div></div>`;
    }
    html += '</div>';
    host.innerHTML=html;
  }

  function updateScheduleConfigFromUI(){
    try{
      const wh = parseInt(qs('#sched-start')?.value||'8',10);
      const wl = parseInt(qs('#sched-len')?.value||'8',10);
      const offWeekdays = Array.from(document.querySelectorAll('.sched-offday:checked')).map(cb=>Number(cb.value));
      const holidaysRaw = (qs('#sched-holidays')?.value||'').split(/[\,\n]/).map(s=>s.trim()).filter(s=>/^\d{4}-\d{2}-\d{2}$/.test(s));
      state.scheduleConfig = { workdayStartHour: wh, workdayLengthHours: wl, offWeekdays, holidays: holidaysRaw };
      (window.logDev||console.log)('[scheduleConfig] updated', state.scheduleConfig);
    }catch(e){ console.warn('updateScheduleConfigFromUI error', e.message); }
  }

  // Szybkie przyciski wyboru dni wolnych
  function initOffdaysQuickButtons(){
    const weekendBtn = document.getElementById('btn-offdays-weekend');
    const workweekBtn = document.getElementById('btn-offdays-workweek');
    const clearBtn = document.getElementById('btn-offdays-clear');
    if(!weekendBtn) return; // UI nie istnieje jeszcze
    const all = Array.from(document.querySelectorAll('.sched-offday'));
    const setChecked = (values)=>{
      const set = new Set(values);
      all.forEach(cb=>{ cb.checked = set.has(Number(cb.value)); });
      updateScheduleConfigFromUI();
    };
    weekendBtn.addEventListener('click', ()=> setChecked([6,0]));
    workweekBtn.addEventListener('click', ()=> setChecked([])); // Czy≈õƒá dni wolne dla dni roboczych (Pn-Pt)
    clearBtn.addEventListener('click', ()=> setChecked([]));
  }

  function unlockDependentTasks(completedTaskId) {
    // Znajd≈∫ wszystkie zadania kt√≥re czekajƒÖ na uko≈Ñczone zadanie
    const dependentTasks = (state.tasks || []).filter(t => 
      t.status === 'blocked' && 
      t.dependsOn && 
      Array.isArray(t.dependsOn) &&
      t.dependsOn.includes(completedTaskId)
    );
    
    if(dependentTasks.length === 0) return;
    
    dependentTasks.forEach(task => {
      // Sprawd≈∫ czy WSZYSTKIE zale≈ºno≈õci sƒÖ uko≈Ñczone
      const allDone = task.dependsOn.every(depId => {
        const depTask = state.tasks.find(t => t.id === depId);
        return depTask && depTask.status === 'done';
      });
      
      if(allDone) {
        task.status = 'todo';
        console.log('‚úÖ [unlockDependentTasks] Odblokowano:', task.opName || task.name);
        
        // Opcjonalnie: powiadomienie
        try {
          if(typeof showToast === 'function') {
            showToast(`‚úÖ Zadanie odblokowane: ${task.opName || task.name}`, 'success');
          }
        } catch(_) {}
      }
    });
    
    // Zapisz zmiany
    save();
  }

  function computeOrderProgress(orderId){
    const tasks = (state.tasks||[]).filter(t=>t.orderId === orderId);
    const total = tasks.length;
    const done = tasks.filter(t=>t.status === 'done').length;
    const run = tasks.filter(t=>t.status === 'run').length;
    const todo = tasks.filter(t=>t.status === 'todo').length;
    const pct = total ? Math.round((done + run*0.5) / total * 100) : 0;
    return {total, done, run, todo, pct};
  }

  function updateOrderProgress(orderId){
    try{ const o = (state.orders||[]).find(x=>x.id===orderId); if(!o) return; o.progress = computeOrderProgress(orderId); save(); }catch(_){ }
  }
  qs('#order-form').addEventListener('submit',(ev)=>{
    ev.preventDefault();
    const t0 = performance.now();
    try {
      (window.logDev||console.log)('[order-form] submit start');
      const validationErrors = validateOrderForm();
      if (validationErrors.length > 0) {
        (window.logDev||console.log)('[order-form] validation errors', validationErrors);
        showValidationErrors(validationErrors);
        return;
      }
      const id = (qs('#o-id').value || '').trim();
      const nr=(qs('#o-name').value||'').trim(); if(!nr){ (window.logDev||console.log)('[order-form] brak nazwy'); return; }
      const beforeLen = (state.orders||[]).length;
      const orderObj={id:id||uid(),name:nr,client:qs('#o-client').value||'',model:qs('#o-model').value||'',quantity:parseInt(qs('#o-qty').value||'1',10),
        startDate:qs('#o-start').value||'',endDate:qs('#o-end').value||'',installDate:qs('#o-install').value||'',
        address:qs('#o-addr').value||'',postalCode:qs('#o-post').value||'',phone:qs('#o-phone').value||'',notes:qs('#o-notes').value||'',
        processId:qs('#o-proc').value||'',leadEmployeeId:qs('#o-lead').value||''};
      if(id){
        const existing = state.orders.find(x=>x.id===id);
        if(existing){ 
          // Sprawd≈∫ czy zmieni≈Ç siƒô proces
          const processChanged = existing.processId !== orderObj.processId;
          Object.assign(existing, orderObj); 
          (window.logDev||console.log)('[order-form] updated', id, 'processChanged=', processChanged);
          
          // Zaktualizuj lub utw√≥rz wpis monta≈ºu
          try{
            let afterEntry = (state.after||[]).find(a => a.order === id);
            if(!afterEntry){
              // Utw√≥rz nowy wpis monta≈ºu je≈õli nie istnieje
              afterEntry = { 
                id: uid(), 
                type:'monta≈º', 
                order: id, 
                status:'nowe', 
                desc: orderObj.notes || '', 
                installDate: orderObj.installDate || '', 
                departTime:'', 
                visitTime:'',
                phone: orderObj.phone || '',
                postalCode: orderObj.postalCode || '',
                address: orderObj.address || '',
                employeeIds: [],
                hours: 0
              };
              state.after.push(afterEntry);
              (window.logDev||console.log)('[order-form] created after entry for existing order', id);
            } else {
              // Zaktualizuj istniejƒÖcy wpis
              afterEntry.desc = orderObj.notes || '';
              afterEntry.installDate = orderObj.installDate || '';
              afterEntry.phone = orderObj.phone || '';
              afterEntry.postalCode = orderObj.postalCode || '';
              afterEntry.address = orderObj.address || '';
              (window.logDev||console.log)('[order-form] updated after entry', id);
            }
          }catch(e){ console.warn('[order-form] after update error', e.message); }
          
          // Automatyczne pytanie o regeneracjƒô zada≈Ñ
          if(processChanged || confirm('Zlecenie zaktualizowane.\n\nCzy przeliczyƒá zadania ponownie (uwzglƒôdni zmiany w procesie)?')){
            try{
              // Usu≈Ñ stare zadania tego zlecenia
              const oldTasks = (state.tasks||[]).filter(t=>t.orderId === id);
              state.tasks = (state.tasks||[]).filter(t=>t.orderId !== id);
              (window.logDev||console.log)('[order-form] removed', oldTasks.length, 'old tasks');
              
              // Wygeneruj nowe zadania
              if(window.scheduleCore && orderObj.processId){
                const gen = window.scheduleCore.generateTasksForOrder(orderObj, state);
                if(gen && gen.length){
                  state.tasks = (state.tasks||[]).concat(gen);
                  if(typeof updateScheduleConfigFromUI === 'function'){ updateScheduleConfigFromUI(); }
                  window.scheduleCore.generateSchedule(state);
                  orderObj.tasksGenerated = true;
                  (window.logDev||console.log)('[order-form] regenerated', gen.length, 'tasks');
                } else {
                  orderObj.tasksGenerated = false;
                  (window.logDev||console.log)('[order-form] no tasks generated (empty process?)');
                }
              } else {
                // Brak procesu - ustaw flagƒô na false
                orderObj.tasksGenerated = false;
                (window.logDev||console.log)('[order-form] no process selected, tasks cleared');
              }
            }catch(e){ console.warn('[order-form] regenerate tasks error', e.message); }
          }
        }
      } else {
        orderObj.tasksGenerated = false;
        state.orders.push(orderObj);
        (window.logDev||console.log)('[order-form] inserted new order', orderObj.id, 'len=', state.orders.length);
        try{
          const afterEntry = { 
            id: uid(), 
            type:'monta≈º', 
            order: orderObj.id, 
            status:'nowe', 
            desc: orderObj.notes || '', 
            installDate: orderObj.installDate || '', 
            departTime:'', 
            visitTime:'',
            phone: orderObj.phone || '',
            postalCode: orderObj.postalCode || '',
            address: orderObj.address || '',
            employeeIds: [],
            hours: 0
          };
          state.after.push(afterEntry);
        }catch(e){ console.warn('[order-form] after push error', e.message); }
        try{
          if(window.scheduleCore){
            const gen = window.scheduleCore.generateTasksForOrder(orderObj, state);
            if(gen && gen.length){
              state.tasks = (state.tasks||[]).concat(gen);
              if(typeof updateScheduleConfigFromUI === 'function'){ updateScheduleConfigFromUI(); }
              window.scheduleCore.generateSchedule(state);
              orderObj.tasksGenerated = true;
              (window.logDev||console.log)('[order-form] auto tasks', gen.length);
            }
          }
        }catch(e){ console.warn('[order-form] auto generate tasks error', e.message); }
      }
      const afterLen = (state.orders||[]).length;
      if(!id && afterLen === beforeLen){ console.warn('[order-form] liczba zlece≈Ñ nie wzros≈Ça!'); }
      maybeAutoSave('order-save');
      save();
      // Podsumowanie skutk√≥w zapisu
      const genTasksForOrder = (state.tasks||[]).filter(t=>t.orderId === orderObj.id);
      (window.logDev||console.log)('[order-form] summary', {
        orderId: orderObj.id,
        tasksGeneratedFlag: orderObj.tasksGenerated,
        tasksCount: genTasksForOrder.length,
        firstTask: genTasksForOrder[0] && {id:genTasksForOrder[0].id, op:genTasksForOrder[0].operationId, start:genTasksForOrder[0].startPlanned, end:genTasksForOrder[0].endPlanned}
      });
      if(orderObj.tasksGenerated && !genTasksForOrder.length){
        console.warn('[order-form] tasksGenerated=true ale brak task√≥w w state.tasks dla order', orderObj.id);
      }
      // Czy harmonogram ma start/end
      const scheduled = genTasksForOrder.filter(t=>t.startPlanned && t.endPlanned).length;
      if(orderObj.tasksGenerated && scheduled === 0){
        console.warn('[order-form] brak zaplanowanych czas√≥w (startPlanned)');
      }
      ev.target.reset(); const hid = qs('#o-id'); if(hid) hid.value='';
      renderOrderPage(); renderASPage(); renderDash(window.state||state); renderGantt();
      const msg = id ? 'Zlecenie zaktualizowane.' : (orderObj.tasksGenerated ? 'Zlecenie zapisane i wygenerowano '+genTasksForOrder.length+' zada≈Ñ.' : 'Zlecenie zapisane (brak zada≈Ñ ‚Äì sprawd≈∫ katalog operacji).');
      const feed = qs('#order-feedback');
      if(feed){ feed.textContent = msg; feed.className='ok'; setTimeout(()=>{ if(feed.textContent===msg) feed.textContent=''; }, 6000); }
      else { (window.logDev||console.log)('[order-form] feedback', msg); }
      (window.logDev||console.log)('[order-form] done in', (performance.now()-t0).toFixed(1)+'ms');
    } catch(err){
      console.error('[order-form] fatal', err); alert('B≈ÇƒÖd zapisu zlecenia: '+(err.message||err));
    }
  });
  // Delegacja klikniƒôƒá - generowanie zada≈Ñ na ≈ºƒÖdanie
  document.addEventListener('click', (ev)=>{
    const genBtn = ev.target.closest('[data-ogen]');
    const replanBtn = ev.target.closest('[data-replan-order]');
    if(!genBtn && !replanBtn) return;
    if(genBtn){
      const oid = genBtn.getAttribute('data-ogen');
      const order = (state.orders||[]).find(o=>o.id===oid);
      if(!order){ alert('Nie znaleziono zam√≥wienia'); return; }
      if(order.tasksGenerated){ alert('Zadania ju≈º zosta≈Çy wygenerowane dla tego zam√≥wienia.'); return; }
      
      // Use new generateTasks function
      const success = generateTasks(oid);
      if(success){
        order.tasksGenerated = true;
        save();
        renderDash(window.state||state);
        renderGantt();
        renderOrderPage();
        console.log('[order] Tasks generated successfully for order', order.name);
      } else {
        alert('Nie uda≈Ço siƒô wygenerowaƒá zada≈Ñ. Sprawd≈∫ czy zlecenie ma przypisany proces.');
      }
      return;
    }
    if(replanBtn){
      const oid = replanBtn.getAttribute('data-replan-order');
      if(!window.scheduleCore) return;
      if(typeof updateScheduleConfigFromUI==='function') updateScheduleConfigFromUI();
      if(!confirm('Przeliczyƒá od nowa zadania tego zlecenia?')) return;
      window.scheduleCore.generateSchedule(state,{force:true, onlyOrderId: oid});
      save(); renderGantt(); renderOrderPage();
      (window.logDev||console.log)('[replan] single order', oid);
    }
  });
  
  function populateOpEmployees(){
    const sel=qs('#op-emp'); if(!sel) return;
    const keep=new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
    sel.innerHTML='';
    (state.employees||[]).forEach(e=>{const o=document.createElement('option');o.value=e.id;o.textContent=e.name||e.id;if(keep.has(e.id))o.selected=true;sel.appendChild(o);});
  }
  function populateLeadSelect(){
    const sel=qs('#o-lead'); if(!sel) return;
    const current = sel.value;
    sel.innerHTML='<option value="">‚Äî wybierz pracownika ‚Äî</option>';
    (state.employees||[]).forEach(e=>{const o=document.createElement('option');o.value=e.id;o.textContent=e.name||e.id;sel.appendChild(o);});
    if(current) sel.value = current;
  }

  let opChecklistDraft = [];
  let opChecklistDraftTouched = false;
  let opChecklistMeta = { version: 1, sourceOperationId: null, label: '' };
  let opChecklistSettingsDraft = { required: false, propagateToTasks: true, allowWorkerAdditions: true };

  function resetOpChecklistEditor(){
    opChecklistDraft = [];
    opChecklistDraftTouched = false;
    opChecklistMeta = { version: 1, sourceOperationId: null, label: '' };
    opChecklistSettingsDraft = { required: false, propagateToTasks: true, allowWorkerAdditions: true };
    const labelInput = qs('#op-checklist-new-label'); if(labelInput) labelInput.value = '';
    const hintInput = qs('#op-checklist-new-hint'); if(hintInput) hintInput.value = '';
    const requiredInput = qs('#op-checklist-new-required'); if(requiredInput) requiredInput.checked = false;
    const defaultInput = qs('#op-checklist-new-default'); if(defaultInput) defaultInput.checked = false;
    const typeSelect = qs('#op-checklist-new-type'); if(typeSelect) typeSelect.value = CHECKLIST_ITEM_DEFAULT_TYPE;
    renderOpChecklistItems();
    syncOpChecklistSettingsInputs();
  }

  function bindOpChecklistSettingsInputs(){
    const requiredInput = qs('#op-checklist-required');
    if(requiredInput && !requiredInput._bound){
      requiredInput._bound = true;
      requiredInput.addEventListener('change', ()=>{
        opChecklistSettingsDraft.required = !!requiredInput.checked;
        opChecklistDraftTouched = true;
      });
    }
    const propagateInput = qs('#op-checklist-propagate');
    if(propagateInput && !propagateInput._bound){
      propagateInput._bound = true;
      propagateInput.addEventListener('change', ()=>{
        opChecklistSettingsDraft.propagateToTasks = !!propagateInput.checked;
        opChecklistDraftTouched = true;
      });
    }
    const allowInput = qs('#op-checklist-allow-add');
    if(allowInput && !allowInput._bound){
      allowInput._bound = true;
      allowInput.addEventListener('change', ()=>{
        opChecklistSettingsDraft.allowWorkerAdditions = !!allowInput.checked;
        opChecklistDraftTouched = true;
      });
    }
  }

  function syncOpChecklistSettingsInputs(){
    const requiredInput = qs('#op-checklist-required'); if(requiredInput) requiredInput.checked = !!opChecklistSettingsDraft.required;
    const propagateInput = qs('#op-checklist-propagate'); if(propagateInput) propagateInput.checked = !!opChecklistSettingsDraft.propagateToTasks;
    const allowInput = qs('#op-checklist-allow-add'); if(allowInput) allowInput.checked = !!opChecklistSettingsDraft.allowWorkerAdditions;
  }

  function opChecklistCountLabel(cnt){
    if(cnt === 1) return 'punkt';
    if(cnt >= 2 && cnt <= 4) return 'punkty';
    return 'punkt√≥w';
  }

  function updateOpChecklistSummary(){
    const summary = qs('#op-checklist-summary');
    if(!summary) return;
    const count = Array.isArray(opChecklistDraft) ? opChecklistDraft.length : 0;
    if(count === 0){
      summary.textContent = '0 punkt√≥w';
      summary.classList.remove('warn');
      return;
    }
    summary.textContent = `${count} ${opChecklistCountLabel(count)}`;
    summary.classList.toggle('warn', count >= 40);
  }

  let renderOpChecklistItemsTimer = null;
  function renderOpChecklistItems(immediate){
    if(!immediate && renderOpChecklistItemsTimer) return;
    if(!immediate){
      renderOpChecklistItemsTimer = setTimeout(()=>{
        renderOpChecklistItemsTimer = null;
        renderOpChecklistItemsNow();
      }, 100);
    } else {
      if(renderOpChecklistItemsTimer){
        clearTimeout(renderOpChecklistItemsTimer);
        renderOpChecklistItemsTimer = null;
      }
      renderOpChecklistItemsNow();
    }
  }

  function renderOpChecklistItemsNow(){
    const box = qs('#op-checklist-items');
    if(!box) return;
    
    // Zachowaj aktywny element i pozycjƒô scrolla
    const activeElement = document.activeElement;
    const focusedIdx = activeElement && activeElement.dataset ? Object.values(activeElement.dataset)[0] : null;
    const focusedKey = activeElement && activeElement.dataset ? Object.keys(activeElement.dataset)[0] : null;
    const scrollTop = box.scrollTop;
    const parentScroll = box.parentElement ? box.parentElement.scrollTop : 0;
    
    const items = Array.isArray(opChecklistDraft) ? opChecklistDraft : [];
    if(!items.length){
      box.innerHTML = '<div class="muted" style="padding:8px">Brak punkt√≥w checklisty ‚Äì dodaj pierwszy powy≈ºej.</div>';
      updateOpChecklistSummary();
      return;
    }
    box.innerHTML = items.map((item, idx)=>{
      const optionHtml = CHECKLIST_ITEM_ALLOWED_TYPES.map(t=>`<option value="${t}" ${t === (item.type || CHECKLIST_ITEM_DEFAULT_TYPE) ? 'selected' : ''}>${t.charAt(0).toUpperCase()+t.slice(1)}</option>`).join('');
      const label = escapeHtml(item.label || '');
      const hint = escapeHtml(item.hint || '');
      const imageUrl = item.metadata && item.metadata.imageUrl ? escapeHtml(item.metadata.imageUrl) : '';
      return `<div class="card" data-ck-row="${idx}" style="padding:8px">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label class="muted" style="font-size:11px">Tre≈õƒá</label>
            <input type="text" data-ck-label="${idx}" value="${label}" placeholder="Opis punktu">
          </div>
          <div>
            <label class="muted" style="font-size:11px">Typ</label>
            <select data-ck-type="${idx}">${optionHtml}</select>
          </div>
          <div class="col" style="min-width:140px">
            <label style="font-size:12px"><input type="checkbox" data-ck-required="${idx}" ${item.required?'checked':''}> Wymagane</label>
            <label style="font-size:12px"><input type="checkbox" data-ck-default="${idx}" ${item.defaultDone?'checked':''}> Domy≈õlnie ‚úîÔ∏è</label>
          </div>
          <div class="col" style="min-width:160px">
            <button class="btn" type="button" data-ck-up="${idx}" ${idx===0?'disabled':''}>‚Üë</button>
            <button class="btn" type="button" data-ck-down="${idx}" ${idx===items.length-1?'disabled':''}>‚Üì</button>
            <button class="btn red" type="button" data-ck-remove="${idx}">Usu≈Ñ</button>
          </div>
        </div>
        <div style="margin-top:6px">
          <label class="muted" style="font-size:11px">Podpowied≈∫</label>
          <input type="text" data-ck-hint="${idx}" value="${hint}" placeholder="np. wpisz wymiary w mm">
        </div>
        <div style="margin-top:6px">
          <label class="muted" style="font-size:11px">üñºÔ∏è URL zdjƒôcia / schematu (opcjonalnie)</label>
          <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
            ${imageUrl ? `<img src="${imageUrl}" style="max-width:60px;max-height:60px;border:1px solid #ddd;border-radius:4px;cursor:pointer;" onclick="window.open(this.src,'_blank')" title="Kliknij aby powiƒôkszyƒá">` : ''}
            <input type="text" data-ck-image="${idx}" value="${imageUrl && !imageUrl.startsWith('data:image') ? imageUrl : ''}" placeholder="https://... lub kliknij üì§" style="flex:1;min-width:150px;${imageUrl && imageUrl.startsWith('data:image') ? 'display:none;' : ''}">
            <input type="file" id="ck-file-${idx}" accept="image/*" style="display:none" onchange="handleChecklistEditImageUpload(this, ${idx})">
            <button class="btn small" type="button" onclick="document.getElementById('ck-file-${idx}').click()" title="Prze≈õlij zdjƒôcie z komputera">üì§</button>
            ${imageUrl ? `<button class="btn small red" type="button" onclick="handleChecklistRemoveImage(${idx})" title="Usu≈Ñ zdjƒôcie">üóëÔ∏è</button>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
    updateOpChecklistSummary();
    
    // Przywr√≥ƒá focus i scroll position
    if(focusedIdx !== null && focusedKey){
      setTimeout(()=>{
        const targetElement = box.querySelector(`[data-${focusedKey}="${focusedIdx}"]`);
        if(targetElement && typeof targetElement.focus === 'function'){
          targetElement.focus();
          // Przywr√≥ƒá pozycjƒô kursora dla p√≥l tekstowych
          if(targetElement.tagName === 'INPUT' && activeElement && activeElement.selectionStart !== undefined){
            const pos = activeElement.selectionStart;
            targetElement.setSelectionRange(pos, pos);
          }
        }
        box.scrollTop = scrollTop;
        if(box.parentElement) box.parentElement.scrollTop = parentScroll;
      }, 0);
    }
  }

  function handleOpChecklistFieldChange(ev){
    const target = ev.target;
    if(!target || !target.dataset) return;
    const entries = Object.entries(target.dataset);
    if(!entries.length) return;
    const [key, idxStr] = entries[0];
    if(typeof idxStr === 'undefined') return;
    const idx = parseInt(idxStr, 10);
    if(Number.isNaN(idx) || !opChecklistDraft[idx]) return;
    const item = opChecklistDraft[idx];
    switch(key){
      case 'ckLabel': item.label = target.value || ''; break;
      case 'ckHint': item.hint = target.value || ''; break;
      case 'ckType': item.type = target.value || CHECKLIST_ITEM_DEFAULT_TYPE; break;
      case 'ckRequired': item.required = !!target.checked; break;
      case 'ckDefault': item.defaultDone = !!target.checked; break;
      case 'ckImage': 
        if(!item.metadata) item.metadata = {};
        item.metadata.imageUrl = (target.value || '').trim();
        break;
      default: return;
    }
    opChecklistDraftTouched = true;
  }

  function swapOpChecklistItems(i, j){
    if(i<0 || j<0 || i>=opChecklistDraft.length || j>=opChecklistDraft.length) return;
    const temp = opChecklistDraft[i];
    opChecklistDraft[i] = opChecklistDraft[j];
    opChecklistDraft[j] = temp;
    opChecklistDraftTouched = true;
    renderOpChecklistItems(true);
  }

  function handleOpChecklistRowClick(ev){
    const target = ev.target;
    if(!target || !target.dataset) return;
    if(target.dataset.ckRemove){
      const idx = parseInt(target.dataset.ckRemove,10);
      if(!Number.isNaN(idx)){
        opChecklistDraft.splice(idx,1);
        opChecklistDraftTouched = true;
        renderOpChecklistItems();
      }
      return;
    }
    if(target.dataset.ckUp){
      const idx = parseInt(target.dataset.ckUp,10);
      swapOpChecklistItems(idx, idx-1);
      return;
    }
    if(target.dataset.ckDown){
      const idx = parseInt(target.dataset.ckDown,10);
      swapOpChecklistItems(idx, idx+1);
      return;
    }
  }

  function handleChecklistImageUpload(input){
    if(!input || !input.files || !input.files[0]) return;
    const file = input.files[0];
    if(!file.type.startsWith('image/')){
      alert('Proszƒô wybraƒá plik obrazu (jpg, png, gif, itp.)');
      return;
    }
    const maxSize = 2 * 1024 * 1024; // 2MB
    if(file.size > maxSize){
      alert('Zdjƒôcie jest za du≈ºe! Maksymalnie 2MB.\nRozmiar wybranego pliku: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
      return;
    }
    const imageInput = qs('#op-checklist-new-image');
    if(!imageInput) return;
    imageInput.value = '‚è≥ Przetwarzanie zdjƒôcia...';
    imageInput.disabled = true;
    const reader = new FileReader();
    reader.onload = function(e){
      const base64 = e.target.result;
      if(imageInput){
        imageInput.value = base64;
        imageInput.disabled = false;
        imageInput.style.color = '#10b981';
        setTimeout(()=>{ if(imageInput) imageInput.style.color = ''; }, 2000);
      }
      input.value = '';
      alert('‚úÖ Zdjƒôcie za≈Çadowane! Kliknij "‚ûï Dodaj punkt" aby zapisaƒá.');
    };
    reader.onerror = function(){
      alert('‚ùå B≈ÇƒÖd podczas wczytywania zdjƒôcia.');
      if(imageInput){
        imageInput.value = '';
        imageInput.disabled = false;
      }
      input.value = '';
    };
    reader.readAsDataURL(file);
  }
  window.handleChecklistImageUpload = handleChecklistImageUpload;

  function handleChecklistEditImageUpload(input, idx){
    console.log('handleChecklistEditImageUpload wywo≈Çane:', idx, input);
    if(!input || !input.files || !input.files[0]){
      console.log('Brak pliku');
      return;
    }
    const file = input.files[0];
    console.log('Wybrany plik:', file.name, file.size, file.type);
    if(!file.type.startsWith('image/')){
      alert('Proszƒô wybraƒá plik obrazu (jpg, png, gif, itp.)');
      return;
    }
    const maxSize = 2 * 1024 * 1024; // 2MB
    if(file.size > maxSize){
      alert('Zdjƒôcie jest za du≈ºe! Maksymalnie 2MB.\nRozmiar: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
      return;
    }
    const imageInput = document.querySelector(`input[data-ck-image="${idx}"]`);
    if(!imageInput){
      console.error('Nie znaleziono pola input dla idx:', idx);
      alert('‚ùå B≈ÇƒÖd: nie znaleziono pola URL');
      return;
    }
    const originalValue = imageInput.value;
    imageInput.value = '‚è≥ Przetwarzanie...';
    imageInput.disabled = true;
    const reader = new FileReader();
    reader.onload = function(e){
      const base64 = e.target.result;
      if(opChecklistDraft[idx]){
        if(!opChecklistDraft[idx].metadata) opChecklistDraft[idx].metadata = {};
        opChecklistDraft[idx].metadata.imageUrl = base64;
        opChecklistDraftTouched = true;
        renderOpChecklistItems(true);
      }
      input.value = '';
    };
    reader.onerror = function(){
      alert('‚ùå B≈ÇƒÖd podczas wczytywania zdjƒôcia.');
      if(imageInput){
        imageInput.value = originalValue;
        imageInput.disabled = false;
      }
      input.value = '';
    };
    reader.readAsDataURL(file);
  }
  window.handleChecklistEditImageUpload = handleChecklistEditImageUpload;

  function handleChecklistRemoveImage(idx){
    if(!opChecklistDraft[idx]) return;
    if(!confirm('UsunƒÖƒá zdjƒôcie z tego punktu?')) return;
    if(opChecklistDraft[idx].metadata){
      delete opChecklistDraft[idx].metadata.imageUrl;
    }
    opChecklistDraftTouched = true;
    renderOpChecklistItems(true);
  }
  window.handleChecklistRemoveImage = handleChecklistRemoveImage;

  function addOpChecklistItemFromInputs(){
    const labelInput = qs('#op-checklist-new-label');
    const typeSelect = qs('#op-checklist-new-type');
    const requiredInput = qs('#op-checklist-new-required');
    const defaultInput = qs('#op-checklist-new-default');
    const hintInput = qs('#op-checklist-new-hint');
    const imageInput = qs('#op-checklist-new-image');
    if(!labelInput || !typeSelect) return;
    const label = (labelInput.value || '').trim();
    if(!label){
      labelInput.focus();
      return;
    }
    if(opChecklistDraft.length >= 50){
      alert('Limit checklisty to 50 punkt√≥w na operacjƒô.');
      return;
    }
    const imageUrl = imageInput ? (imageInput.value || '').trim() : '';
    const newItem = normalizeChecklistItem({
      label,
      type: typeSelect.value || CHECKLIST_ITEM_DEFAULT_TYPE,
      required: !!(requiredInput && requiredInput.checked),
      defaultDone: !!(defaultInput && defaultInput.checked),
      hint: hintInput ? hintInput.value : '',
      metadata: imageUrl ? { imageUrl } : {}
    });
    opChecklistDraft.push(newItem);
    opChecklistDraftTouched = true;
    labelInput.value = '';
    if(hintInput) hintInput.value = '';
    if(imageInput) imageInput.value = '';
    if(requiredInput) requiredInput.checked = false;
    if(defaultInput) defaultInput.checked = false;
    renderOpChecklistItems(true);
    labelInput.focus();
  }

  function bindOpChecklistControls(){
    const addBtn = qs('#op-checklist-add-btn');
    if(addBtn && !addBtn._bound){
      addBtn._bound = true;
      addBtn.addEventListener('click', addOpChecklistItemFromInputs);
    }
    const labelInput = qs('#op-checklist-new-label');
    if(labelInput && !labelInput._bound){
      labelInput._bound = true;
      labelInput.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ ev.preventDefault(); addOpChecklistItemFromInputs(); } });
    }
    const itemsBox = qs('#op-checklist-items');
    if(itemsBox && !itemsBox._bound){
      itemsBox._bound = true;
      itemsBox.addEventListener('input', handleOpChecklistFieldChange, true);
      itemsBox.addEventListener('change', handleOpChecklistFieldChange, true);
      itemsBox.addEventListener('click', handleOpChecklistRowClick, true);
    }
  }

  function loadOpChecklistDraftFromOperation(op){
    opChecklistDraft = [];
    opChecklistDraftTouched = false;
    const template = op && op.checklistTemplate ? createChecklistTemplate(op.checklistTemplate, op) : createChecklistTemplate({ sourceOperationId: op ? op.id : null, label: op ? op.name : '' }, op || {});
    opChecklistMeta = {
      version: Number.isFinite(template.version) ? template.version : parseInt(template.version, 10) || 1,
      sourceOperationId: template.sourceOperationId || (op ? op.id : null),
      label: template.label || (op ? op.name : '')
    };
    opChecklistSettingsDraft = Object.assign({ required: false, propagateToTasks: true, allowWorkerAdditions: true }, op && op.checklistSettings ? op.checklistSettings : {});
    opChecklistDraft = (template.items || []).map(item => normalizeChecklistItem(item));
    const labelInput = qs('#op-checklist-new-label'); if(labelInput) labelInput.value = '';
    const hintInput = qs('#op-checklist-new-hint'); if(hintInput) hintInput.value = '';
    const imageInput = qs('#op-checklist-new-image'); if(imageInput) imageInput.value = '';
    const requiredInput = qs('#op-checklist-new-required'); if(requiredInput) requiredInput.checked = false;
    const defaultInput = qs('#op-checklist-new-default'); if(defaultInput) defaultInput.checked = false;
    const typeSelect = qs('#op-checklist-new-type'); if(typeSelect) typeSelect.value = CHECKLIST_ITEM_DEFAULT_TYPE;
    renderOpChecklistItems();
    syncOpChecklistSettingsInputs();
  }

  function buildOperationChecklistTemplatePayload(opId, opName, existingTemplate){
    const base = existingTemplate ? createChecklistTemplate(existingTemplate, { id: opId, name: opName }) : createChecklistTemplate({ sourceOperationId: opId, label: opName }, { id: opId, name: opName });
    const prevVersion = Number.isFinite(base.version) ? base.version : parseInt(base.version,10) || 1;
    base.items = (opChecklistDraft || []).map(item => normalizeChecklistItem(item));
    base.version = opChecklistDraftTouched && prevVersion ? prevVersion + 1 : prevVersion || 1;
    base.updatedAt = Date.now();
    base.updatedBy = (state && state.storage && state.storage.userId) || 'planner';
    return base;
  }

  function collectOperationChecklistSettings(){
    return {
      required: !!opChecklistSettingsDraft.required,
      propagateToTasks: opChecklistSettingsDraft.propagateToTasks !== false,
      allowWorkerAdditions: opChecklistSettingsDraft.allowWorkerAdditions !== false
    };
  }

  function ensureOpChecklistEditorReady(){
    bindOpChecklistControls();
    bindOpChecklistSettingsInputs();
    renderOpChecklistItems();
    syncOpChecklistSettingsInputs();
  }
  // Normalize operation numbers (ensure sequential no = 1..N sorted by no)
  function normalizeOpNumbers() {
    state.operationsCatalog = (state.operationsCatalog || []).slice().sort((a,b)=>(a.no||0)-(b.no||0)).map((o,i)=>{ o.no = i+1; return o; });
    ensureOperationsCatalogChecklists(state.operationsCatalog);
  }

  // Move operation by id up/down in the ordered list
  function moveOp(id, dir){
    const arr = (state.operationsCatalog || []).slice().sort((a,b)=>(a.no||0)-(b.no||0));
    const idx = arr.findIndex(x=>x.id===id);
    if(idx === -1) return;
    const newIdx = dir === 'up' ? Math.max(0, idx-1) : Math.min(arr.length-1, idx+1);
    if(newIdx === idx) return;
    const [item] = arr.splice(idx,1);
    arr.splice(newIdx,0,item);
    arr.forEach((o,i)=>o.no = i+1);
    state.operationsCatalog = arr;
    ensureOperationsCatalogChecklists(state.operationsCatalog);
    save(); renderOps();
  }
  function renderOps(){
    populateOpEmployees();
    const tb=qs('#op-tb'); if(!tb) return; tb.innerHTML='';
    // populate component selector with unique components
    const compSel = qs('#op-comp-select'); if(compSel){
      const comps = new Set(); (state.operationsCatalog||[]).forEach(op=>{(op.skills||[]).forEach(s=>comps.add(s.trim()));});
      const prev = compSel.value || '';
      compSel.innerHTML = '<option value="">‚Äî wybierz komponent ‚Äî</option>' + Array.from(comps).filter(Boolean).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
      if(prev) compSel.value = prev;
    }

    (state.operationsCatalog||[]).slice().sort((a,b)=>(a.no||0)-(b.no||0)).forEach((o,idx,arr)=>{
      const ass=(o.defaultAssignees||[]).map(a=>a.name).join(', ')||'-';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${o.no||0}</td><td>${o.name||''}</td><td>${o.time||0}</td><td>${o.workers||1}</td>
                    <td>${(o.skills||[]).join(', ')}</td><td>${ass}</td>
                    <td>
                      <div class="row">
                        <button class="btn" data-op-up="${o.id}" ${idx===0?"disabled":""}>‚Üë</button>
                        <button class="btn" data-op-down="${o.id}" ${idx===arr.length-1?"disabled":""}>‚Üì</button>
                        <button class="btn" data-op-ed="${o.id}">Edytuj</button>
                        <button class="btn red" data-op-del="${o.id}">Usu≈Ñ</button>
                      </div>
                    </td>`;
      tb.appendChild(tr);
    });
    qs('#op-count').textContent=String((state.operationsCatalog||[]).length);
    const sel=qs('#proc-op-select'); if(sel){ sel.innerHTML=''; (state.operationsCatalog||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=(o.no||0)+'. '+o.name+' ('+(o.time||0)+'m)'; sel.appendChild(opt); }); }
  }
  // sort operations by whether they contain a selected component (selected first), then keep rest, normalize numbers
  function sortByComponent(component){
    if(!component) return;
    const ops = (state.operationsCatalog||[]).slice();
    const match = [];
    const rest = [];
    ops.forEach(o=>{ if((o.skills||[]).map(s=>s.toLowerCase()).indexOf(component.toLowerCase())!==-1) match.push(o); else rest.push(o); });
    const res = match.concat(rest);
    res.forEach((o,i)=>o.no = i+1);
    state.operationsCatalog = res; ensureOperationsCatalogChecklists(state.operationsCatalog); save(); renderOps();
  }
  // normalize numbers to 1..N (already provided as normalizeOpNumbers)
  // sort operations alphabetically by name
  function sortOpsAZ(){
    const ops = (state.operationsCatalog||[]).slice().sort((a,b)=>{ const A=(a.name||'').toLowerCase(); const B=(b.name||'').toLowerCase(); return A.localeCompare(B); });
    ops.forEach((o,i)=>o.no = i+1);
    state.operationsCatalog = ops; ensureOperationsCatalogChecklists(state.operationsCatalog); save(); renderOps();
  }

  // wire buttons
  const opNormalizeBtn = qs('#op-normalize'); if(opNormalizeBtn){ opNormalizeBtn.addEventListener('click', ()=>{ normalizeOpNumbers(); save(); renderOps(); }); }
  const opSortBtn = qs('#op-sort-az'); if(opSortBtn){ opSortBtn.addEventListener('click', ()=>{ sortOpsAZ(); }); }
  const opSortCompBtn = qs('#op-sort-comp'); if(opSortCompBtn){ opSortCompBtn.addEventListener('click', ()=>{ const sel = qs('#op-comp-select'); if(sel) sortByComponent(sel.value); }); }
  const opSaveDbBtn = qs('#op-save-db'); if(opSaveDbBtn){ opSaveDbBtn.addEventListener('click', async ()=>{
    try{
      if(!(state.storage.mode==='firebase' && await ensureFirebase())){ alert('Firebase nie jest skonfigurowany/aktywowany. Nie mo≈ºna zapisaƒá do DB.'); return; }
      const col = fbRoot().collection('operationsCatalog');
      for(const op of (state.operationsCatalog||[])){
        try{ await col.doc(op.id).set(JSON.parse(JSON.stringify(op)),{merge:true}); }catch(e){ console.warn('B≈ÇƒÖd zapisu op:', e.message); }
      }
      alert('Zapisano katalog operacji do DB.');
    }catch(e){ console.warn('saveAllOpsToDB error', e); alert('B≈ÇƒÖd: ' + (e.message||e)); }
  }); }
  qs('#op-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const msg=(t,ok=false)=>{const el=qs('#op-msg'); if(el){el.textContent=t||''; el.className='muted '+(ok?'oktxt':'err');}};
    const submitBtn = ev.target.querySelector('button[type="submit"]');
    if(submitBtn) submitBtn.disabled = true;
    try{
      const rawOpId = (qs('#op-id').value||'').trim();
      console.log('[op-form] submit start', { rawOpId });
      const name=(qs('#op-name').value||'').trim();
      const no=toInt(qs('#op-no').value, 1);
      const time=toInt(qs('#op-time').value, 10);
      const workers=toInt(qs('#op-workers').value, 1);
      const skills=(qs('#op-skills').value||'').split(';').map(s=>s.trim()).filter(Boolean);
      const sel=qs('#op-emp'); const assIds=Array.from(sel.selectedOptions||[]).map(o=>o.value);
      const ass=assIds.map(v=>{const e=(state.employees||[]).find(x=>x.id===v); return e?{id:e.id,name:e.name}:null;}).filter(Boolean);
      if(!name){msg('Podaj nazwƒô operacji.'); if(submitBtn) submitBtn.disabled = false; return;}
      if(!(time>=1)){msg('Czas [min] musi byƒá ‚â• 1.'); if(submitBtn) submitBtn.disabled = false; return;}
      if(!(workers>=1)){msg('Domy≈õlna liczba pracownik√≥w musi byƒá ‚â• 1.'); if(submitBtn) submitBtn.disabled = false; return;}

  // use in-memory state snapshot (avoid reading localStorage here to prevent overwriting recent in-memory edits)
  state._inOpEdit = true;

      // operate on a shallow copy
      const ops = (state.operationsCatalog||[]).slice();
      const existingIdx = rawOpId ? ops.findIndex(x=> x.id === rawOpId) : -1;
      const isUpdate = existingIdx >= 0;
      console.log('[op-form] isUpdate?', isUpdate, 'existingIdx', existingIdx);
      const id = isUpdate ? rawOpId : uid();
      const existingOp = isUpdate ? ops[existingIdx] : null;
      const payload = { id, no, name, time, workers, skills, defaultAssignees: ass };
      payload.checklistTemplate = buildOperationChecklistTemplatePayload(id, name, existingOp && existingOp.checklistTemplate);
      payload.checklistSettings = collectOperationChecklistSettings();

      if(isUpdate){
        // update only the specific operation by id (preserve other fields)
        const existingSafe = ops[existingIdx] || {};
        const merged = Object.assign({}, existingSafe, payload);
        ops.splice(existingIdx, 1, merged);
        msg('Zaktualizowano operacjƒô.', true);
      } else {
        // always INSERT when no op-id provided ‚Äî never replace existing items even if names collide
        const insertAt = Math.max(0, Math.min(no-1, ops.length));
        ops.splice(insertAt, 0, payload);
        msg('Dodano nowƒÖ operacjƒô.', true);
      }

      // Persist our ops array directly into state to avoid accidental drops during
      // rapid consecutive inserts. Reindex sequentially and keep the ops order.
      try{
        ops.forEach((o,i)=>o.no = i+1);
        state.operationsCatalog = ops;
      }catch(_){ ops.forEach((o,i)=>o.no=i+1); state.operationsCatalog = ops; }

      ensureOperationsCatalogChecklists(state.operationsCatalog);

      try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(_){ }
      save(); renderOps();
      // DEVLOG: snapshot after submit ‚Äî last 3 operations and total length
      try{
        const all = (state.operationsCatalog||[]).slice().sort((a,b)=>(a.no||0)-(b.no||0));
        const last3 = all.slice(-3).map(o=>({id:o.id,name:o.name,no:o.no}));
        (window.logDev||console.log)('[op-form] post-submit snapshot', { total: all.length, last3 });
        const infoEl = qs('#set-info'); if(infoEl) infoEl.textContent = `Ops:${all.length} last:${ last3.map(x=>x.name).join(', ') }`;
      }catch(e){ (window.logDev||console.log)('[op-form] post-submit debug error', e && e.message); }
      try{ if(state.storage.mode==='firebase' && await ensureFirebase()){ await fbRoot().collection('operationsCatalog').doc(id).set(JSON.parse(JSON.stringify(payload)),{merge:true}); } }catch(e){ console.warn('B≈ÇƒÖd zapisu operacji:', e && e.message); }
  // after save (insert or update): reset form and clear op-id so UI is clean
  try{ ev.target.reset(); }catch(_){ }
  if(qs('#op-id')) qs('#op-id').value = '';
  populateOpEmployees && populateOpEmployees();
  resetOpChecklistEditor();
  state._inOpEdit = false;
    }catch(e){ console.log('[op-form] submit error', e && e.message); if(qs('#op-msg')) qs('#op-msg').textContent='B≈ÇƒÖd zapisu'; state._inOpEdit = false; }
    if(submitBtn) submitBtn.disabled = false;
  });

  ensureOpChecklistEditorReady();
  loadOpChecklistDraftFromOperation(null);

  function renderProcOps(){
    const box=qs('#proc-ops'); box.innerHTML='';
    if(!state.PROC_TMP || state.PROC_TMP.length === 0){
      box.innerHTML = '<div class="muted" style="padding:12px;text-align:center">Brak operacji - dodaj pierwszƒÖ operacjƒô z katalogu</div>';
      return;
    }
    (state.PROC_TMP||[]).forEach((op,i)=>{
      const d=document.createElement('div'); 
      d.className='card';
      const empArr = (state.employees||[]).slice();
      if(op.assignee && op.assignee.id && !empArr.some(e=>e.id===op.assignee.id)){
        empArr.unshift({id:op.assignee.id, name: op.assignee.name || op.assignee.id});
      }
      const empOptions = empArr.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
      
      // Zbuduj opcje dla zale≈ºno≈õci - tylko poprzednie operacje
      const depOptions = state.PROC_TMP.slice(0, i).map((prevOp, prevIdx) => 
        `<option value="${prevIdx}">${prevOp.name}</option>`
      ).join('');
      
  d.innerHTML = '<div style="display:flex;flex-direction:column;gap:12px">'+
        '<div class="row" style="justify-content:space-between">'+
          '<div><b>'+(i+1)+'. '+op.name+'</b></div>'+
          '<div class="row" style="gap:8px">'+
            '<span class="muted">Czas:</span>'+
            '<input type="number" data-time-edit="'+i+'" value="'+(op.time||0)+'" min="0" style="width:70px;text-align:center">'+
            '<span class="muted">min</span>'+
          '</div>'+
        '</div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+
          '<div>'+
            '<label>üë§ Pracownik</label>'+
            '<select data-pass>'+ 
              '<option value="">‚Äî Nieprzypisane ‚Äî</option>'+ empOptions +
            '</select>'+
          '</div>'+
          (i > 0 ? 
            '<div>'+
              '<label>üîó Zale≈ºy od operacji</label>'+
              '<select data-depends="'+i+'">'+
                '<option value="">Brak zale≈ºno≈õci</option>'+ depOptions +
              '</select>'+
            '</div>' 
          : '')+
        '</div>'+
        '<div class="row" style="justify-content:flex-end;gap:4px">'+
          '<button class="btn" data-pup="'+i+'">‚Üë</button>'+
          '<button class="btn" data-pdown="'+i+'">‚Üì</button>'+
          '<button class="btn red" data-pdel="'+i+'">Usu≈Ñ</button>'+
        '</div>'+
      '</div>';
      box.appendChild(d);
      
      // Edycja czasu operacji
      const timeInput = d.querySelector('[data-time-edit]');
      if(timeInput){
        timeInput.addEventListener('change', ()=>{
          const newTime = parseInt(timeInput.value) || 0;
          state.PROC_TMP[i].time = newTime;
          save();
        });
      }
      const sel = d.querySelector('select[data-pass]');
      if(sel){
        if(op.assignee && op.assignee.id) sel.value = op.assignee.id;
        sel.addEventListener('change', ()=>{
          const val = sel.value;
          if(!val) state.PROC_TMP[i].assignee = null;
          else { const emp = (state.employees||[]).find(x=>x.id===val); state.PROC_TMP[i].assignee = emp?{id:emp.id,name:emp.name}:null; }
          save();
        });
        // clear assignment button
        const clr = d.querySelector('[data-clear-ass]'); if(clr){ clr.addEventListener('click', ()=>{ state.PROC_TMP[i].assignee = null; if(sel) sel.value = ''; save(); renderProcOps(); }); }
      }
      
      // Obs≈Çuga zale≈ºno≈õci (dependsOn)
      const depSel = d.querySelector('select[data-depends]');
      if(depSel){
        if(op.dependsOn !== undefined && op.dependsOn !== null) depSel.value = op.dependsOn;
        depSel.addEventListener('change', ()=>{
          const val = depSel.value;
          if(!val) state.PROC_TMP[i].dependsOn = null;
          else state.PROC_TMP[i].dependsOn = parseInt(val);
          save();
          console.log('‚úÖ Zale≈ºno≈õƒá ustawiona:', op.name, '‚Üí wymaga', val ? state.PROC_TMP[val].name : 'brak');
        });
      }
    });
  }
  function renderProcList(){ const box=qs('#proc-list'); box.innerHTML=''; (state.processes||[]).forEach(p=>{ const assigned = Array.from(new Set((p.operations||[]).map(o=>o.assignee && o.assignee.name).filter(Boolean))); const assText = assigned.length?(' ‚Ä¢ pracownicy: '+assigned.join(', ')) : ''; const d=document.createElement('div'); d.className='card'; d.innerHTML='<div class="row" style="justify-content:space-between"><div><b>'+p.name+'</b>'+assText+' ‚Ä¢ operacji: '+((p.operations||[]).length||0)+'</div><div class="row"><button class="btn" data-ped="'+p.id+'">Edytuj</button> <button class="btn red" data-pdel2="'+p.id+'">Usu≈Ñ</button></div></div>'; box.appendChild(d); }); qs('#proc-count').textContent=String((state.processes||[]).length); }
  function renderProcPage(){ 
    const sel=qs('#proc-op-select'); if(sel){ sel.innerHTML=''; (state.operationsCatalog||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=(o.no||0)+'. '+o.name+' ('+(o.time||0)+'m)'; sel.appendChild(opt); }); }
    // Wype≈Çnij dropdown szablon√≥w materia≈Çowych
    const templateSel = qs('#proc-template-select');
    if (templateSel) {
      const currentValue = templateSel.value;
      templateSel.innerHTML = '<option value="">Brak</option>';
      (window.materialTemplates || []).forEach(tmpl => {
        const opt = document.createElement('option');
        opt.value = tmpl.id;
        opt.textContent = tmpl.name;
        templateSel.appendChild(opt);
      });
      if (currentValue) templateSel.value = currentValue;
    }
    renderProcOps(); renderProcList(); 
  }
  qs('#proc-add-op').addEventListener('click',()=>{ const id=qs('#proc-op-select').value; const o=state.operationsCatalog.find(x=>x.id===id); if(o){
    let initialAssignee = null;
    if(Array.isArray(o.defaultAssignees) && o.defaultAssignees.length){ const da = o.defaultAssignees[0]; if(da && (da.id || da.name)){ const emp = (state.employees||[]).find(e=>e.id===da.id); if(emp) initialAssignee = { id: emp.id, name: emp.name }; else if(da.id) initialAssignee = { id: da.id, name: da.name || da.id }; else if(da.name) initialAssignee = { id: uid(), name: da.name }; } }
    state.PROC_TMP.push({id:o.id,name:o.name,time:o.time||0, assignee: initialAssignee}); renderProcOps(); save(); } });
  
  qs('#proc-form').addEventListener('submit',(ev)=>{
    ev.preventDefault(); const id=qs('#proc-id').value||uid(); const name=(qs('#proc-name').value||'').trim(); if(!name||(state.PROC_TMP||[]).length===0) return;
    const templateId = qs('#proc-template-select')?.value || null;
    const payload={id,name,operations:(state.PROC_TMP||[]).map(op=>({id:op.id||uid('op'),name:op.name,time:op.time||0, assignee: op.assignee || null, dependsOn: op.dependsOn})), materialTemplateId: templateId};
    const isNew = !state.processes.find(x=>x.id===id);
    const ex=state.processes.find(x=>x.id===id); if(ex) Object.assign(ex,payload); else state.processes.push(payload);
    state.PROC_TMP=[]; 
    state.lastModified = Date.now();
    save(); 
    ev.target.reset(); 
    // Zwi≈Ñ formularz po zapisie
    qs('#proc-form').classList.add('hidden');
    qs('#proc-form-toggle').textContent = '‚ñº';
    renderProcPage();
    
    // üî• ZAPISZ DO FIREBASE w czasie rzeczywistym
    if(state.storage && state.storage.mode === 'firebase'){
      (async () => {
        try {
          if (await ensureFirebase()) {
            console.log(`üî• [SAVE PROCESS] ${isNew ? 'Dodajƒô' : 'Aktualizujƒô'} proces w Firebase:`, id, name);
            await fbRoot().collection('processes').doc(id).set(JSON.parse(JSON.stringify(payload)), { merge: true });
            console.log('‚úÖ [SAVE PROCESS] Zapisano do Firebase:', id);
            
            // Aktualizuj timestamp
            await fbRoot().collection('metadata').doc('sync').set({
              lastModified: Date.now()
            }, { merge: true });
          }
        } catch(err) {
          console.error('‚ùå [SAVE PROCESS] B≈ÇƒÖd zapisu do Firebase:', err);
        }
      })();
    }
  });

  // Funkcja zwijania/rozwijania formularza procesu
  function toggleProcForm() {
    const form = qs('#proc-form');
    const toggle = qs('#proc-form-toggle');
    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      toggle.textContent = '‚ñ≤';
    } else {
      form.classList.add('hidden');
      toggle.textContent = '‚ñº';
    }
  }

  // Funkcja anulowania formularza procesu
  function cancelProcForm() {
    const form = qs('#proc-form');
    form.reset();
    qs('#proc-id').value = '';
    state.PROC_TMP = [];
    form.classList.add('hidden');
    qs('#proc-form-toggle').textContent = '‚ñº';
    renderProcPage();
  }

  // Eksport funkcji do window
  window.toggleProcForm = toggleProcForm;
  window.cancelProcForm = cancelProcForm;

  function updateTaskFilters(){
    const selOrd=qs('#tasks-filter-order'); 
    if(selOrd){ 
      const previousValue = selOrd.value;
      const optionsHtml = '<option value="">Wszystkie zlecenia</option>'+ (state.orders||[]).map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      selOrd.innerHTML = optionsHtml;
      if(previousValue){
        const match = Array.from(selOrd.options).some(opt => opt.value === previousValue);
        if(match){
          selOrd.value = previousValue;
        }
      }
    }
  }

  function formatTaskAssignmentInfo(task){
    try {
      const ids = [];
      const pushId = (candidate) => {
        if(!candidate) return;
        const id = typeof candidate === 'object' ? candidate.id : candidate;
        if(!id) return;
        if(!ids.includes(id)) ids.push(id);
      };
      if(Array.isArray(task.assignees)){
        task.assignees.forEach(pushId);
      } else if(task.assignee){
        pushId(task.assignee);
      }
      if(ids.length === 0 && task.employeeId){
        pushId(task.employeeId);
      }
      if(ids.length === 0){
        return `<span class="muted" style="font-size:12px">‚ö†Ô∏è Nieprzypisane</span>`;
      }
      const employees = state.employees || [];
      const names = ids.map(id=>{
        const ref = employees.find(e=>e.id===id);
        return ref ? ref.name : id;
      }).filter(Boolean);
      const label = names.join(', ');
      let scoreHtml = '';
      if(typeof task._assignmentScore !== 'undefined'){
        const score = Math.round(task._assignmentScore);
        let scoreColor = '#94a3b8';
        if(score >= 70) scoreColor = '#22c55e';
        else if(score >= 50) scoreColor = '#eab308';
        else if(score >= 30) scoreColor = '#f97316';
        else scoreColor = '#ef4444';
        scoreHtml = `<span style="background:${scoreColor};color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px;font-weight:bold" title="Assignment score">${score}</span>`;
      }
      const autoIcon = task._autoAssigned ? 'ü§ñ' : '';
      const conflictIcon = task._hasConflicts ? '‚ö†Ô∏è' : '';
      return `<span style="font-size:12px">üë§ ${label} ${scoreHtml} ${autoIcon} ${conflictIcon}</span>`;
    } catch(err){
      return '';
    }
  }
  try { window.formatTaskAssignmentInfo = formatTaskAssignmentInfo; } catch(_){ /* ignore */ }

  function renderTasks(){
    const list=qs('#tasks-list'); if(!list) return;
    const orderFilterEl = qs('#tasks-filter-order');
    const prevOrderFilter = (typeof window._lastOrderFilterValue !== 'undefined' && window._lastOrderFilterValue !== null)
      ? window._lastOrderFilterValue
      : (orderFilterEl ? orderFilterEl.value : '');
    if(typeof window._lastOrderFilterValue !== 'undefined'){
      try { delete window._lastOrderFilterValue; } catch(_){ window._lastOrderFilterValue = undefined; }
    }
    list.innerHTML='';

    // Aktualizuj filtry przy ka≈ºdym renderowaniu
    updateTaskFilters();
    if(orderFilterEl){
      const exists = prevOrderFilter && Array.from(orderFilterEl.options||[]).some(opt => opt.value === prevOrderFilter);
      if(exists){ orderFilterEl.value = prevOrderFilter; }
    }

    const fOrd=qs('#tasks-filter-order')?.value||''; const fSt=qs('#tasks-filter-status')?.value||'';
    const groupBy=qs('#tasks-group-by')?.value||'';
    const rows=(state.tasks||[]).filter(t=>(!fOrd||t.orderId===fOrd)&&(!fSt||(t.status||'')===fSt));
    qs('#tasks-count').textContent=String(rows.length);
    
    // Je≈õli wybrano grupowanie, u≈ºyj funkcji renderTasksGrouped
    if(groupBy && typeof window.renderTasksGrouped === 'function') {
      window.renderTasksGrouped(rows, groupBy);
      return;
    }
    
    // Sprawd≈∫ ile zada≈Ñ nie ma zlecenia (orphans)
    const orphanTasks = (state.tasks || []).filter(t => !state.orders.find(o => o.id === t.orderId));
    
    // Dodaj przycisk do masowego usuwania na g√≥rze listy
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'row';
    controlsDiv.style.justifyContent = 'flex-end';
    controlsDiv.style.marginBottom = '12px';
    controlsDiv.innerHTML = `
      <button class="btn red" id="mass-delete-tasks" ${rows.length ? '' : 'disabled'}>
        Usu≈Ñ wszystkie wy≈õwietlone zadania (${rows.length})
      </button>
      ${orphanTasks.length > 0 ? `
        <button class="btn amber" id="clean-orphan-tasks" title="Usu≈Ñ zadania bez przypisanego zlecenia">
          üßπ Wyczy≈õƒá osierocone zadania (${orphanTasks.length})
        </button>
      ` : ''}
    `;
    list.appendChild(controlsDiv);
    
    // Dodaj obs≈Çugƒô przycisku masowego usuwania
    const massDeleteBtn = qs('#mass-delete-tasks');
    if(massDeleteBtn) {
      massDeleteBtn.addEventListener('click', async () => {
        if(confirm(`Czy na pewno chcesz usunƒÖƒá ${rows.length} zada≈Ñ? Ta operacja jest nieodwracalna.`)) {
          const idsToDelete = rows.map(t => t.id);
          const beforeCount = (state.tasks || []).length;
          state.tasks = (state.tasks || []).filter(t => !idsToDelete.includes(t.id));
          state.lastModified = Date.now();
          save();
          if (state.storage && state.storage.mode === 'firebase' && typeof saveToDB === 'function') {
            await saveToDB().catch(err => console.error('B≈ÇƒÖd sync:', err));
          }
          renderTasks();
          renderGantt();
          setInfoText('Usuniƒôto ' + (beforeCount - state.tasks.length) + ' zada≈Ñ', 'success');
        }
      });
    }
    
    // Dodaj obs≈Çugƒô przycisku czyszczenia osieroconych zada≈Ñ
    const cleanOrphanBtn = qs('#clean-orphan-tasks');
    if(cleanOrphanBtn) {
      cleanOrphanBtn.addEventListener('click', async () => {
        const orphans = (state.tasks || []).filter(t => !state.orders.find(o => o.id === t.orderId));
        if(confirm(`üßπ Czy na pewno usunƒÖƒá ${orphans.length} osieroconych zada≈Ñ?\n\nTo zadania bez przypisanego zlecenia.`)) {
          console.log('Czyszczenie osieroconych:', orphans.length);
          const beforeCount = state.tasks.length;
          state.tasks = state.tasks.filter(t => state.orders.find(o => o.id === t.orderId));
          state.lastModified = Date.now();
          save();
          if (state.storage && state.storage.mode === 'firebase' && typeof saveToDB === 'function') {
            console.log('Synchronizuje z Firebase...');
            await saveToDB().catch(err => console.error('B≈ÇƒÖd sync:', err));
          }
          renderTasks();
          renderGantt();
          renderDash(window.state||state);
          setInfoText('Wyczyszczono ' + (beforeCount - state.tasks.length) + ' zada≈Ñ', 'success');
        }
      });
    }
    // helper for sync badge
    const syncBadge = (tt)=>{ try{ if(tt._syncPending) return `<span class="task-sync-status pending" title="Czekaj na synchronizacjƒô">‚è≥</span>`; if(tt._syncError) return `<span class="task-sync-status error" title="B≈ÇƒÖd synchronizacji">‚ö†Ô∏è</span>`; if(tt._lastSync) return `<span class="task-sync-status ok" title="Ostatnia synchronizacja: ${new Date(tt._lastSync).toLocaleString()}">‚úîÔ∏è</span>`; return `<span class="task-sync-status unknown" title="Brak synchronizacji">‚Äî</span>`; }catch(e){return''} };
    
    rows.forEach(t=>{
      const d=document.createElement('div'); d.className='card';
      const sb = syncBadge(t);
      const startP = t.startPlanned ? new Date(t.startPlanned).toLocaleString() : '-';
      const endP = t.endPlanned ? new Date(t.endPlanned).toLocaleString() : '-';
      const plannedDur = (t.startPlanned && t.endPlanned) ? Math.round((t.endPlanned - t.startPlanned)/60000)+'m' : '-';
      d.innerHTML=`<div class="row" style="justify-content:space-between">
        <div>
          <b>${t.opName||t.name||'(zadanie)'} ${sb}</b> 
          <span class="muted">
            ${(state.orders||[]).find(o=>o.id===t.orderId)?.name||'-'}
            ${t.processName ? ` ‚Ä¢ Proces: ${t.processName} (${t.opIndex + 1}/${(state.processes.find(p=>p.id===t.processId)?.operations||[]).length})` : ''}
          </span>
          <div>${formatTaskAssignmentInfo(t)}</div>
          ${t.isAssemblyTask ? `
            <div class="muted">üî¢ Numer zadania: ${t.taskNumber || '-'}</div>
            <div class="muted">üìÖ Data: ${t.installDate || '-'} ‚Ä¢ üöó Wyjazd: ${t.departTime || '-'} ‚Ä¢ üè† Wizyta: ${t.visitTime || '-'}</div>
            <div class="muted">üìç ${t.address || 'Brak adresu'} ‚Ä¢ ${t.postalCode ? t.postalCode + ' ‚Ä¢ ' : ''} üìû ${t.phone || '-'}</div>
          ` : ''}
          <div class="muted">Status: <span style="${t.status==='paused'?'color:#f97316;font-weight:bold':''}">${t.status||'todo'}</span> ‚Ä¢ Plan: ${plannedDur} ‚Ä¢ Real: ${Math.round(t.elapsedMin||0)}m ${typeof t.slackMs==='number'?('‚Ä¢ Slack: '+Math.round(t.slackMs/60000)+'m'):''} ${t.critical?'‚Ä¢ CRITICAL':''}</div>
        <div class="muted">StartP: ${startP} ‚Ä¢ EndP: ${endP}</div>
        <div class="muted">${t.startedBy?('RozpoczƒÖ≈Ç: '+t.startedBy):''} ${t.closedBy?('ZamknƒÖ≈Ç: '+t.closedBy):''} ${t.startedAt?(' ‚Ä¢ start: '+(new Date(t.startedAt)).toLocaleTimeString()):''}</div></div>
        <div class="row">
          ${/* start button green when running */''}
          <button class="${t.status==='run'?'btn green':'btn gray'}" data-task-start="${t.id}" ${t.status==='run'||t.status==='paused'?'disabled':''}>Start</button>
          <button class="${t.status==='paused'?'btn orange':'btn'}" data-task-pause="${t.id}" ${t.status!=='run'?'disabled':''}>Pauza</button>
          <button class="${t.status==='paused'?'btn green':'btn'}" data-task-resume="${t.id}" ${t.status!=='paused'?'disabled':''}>Wzn√≥w</button>
          <button class="btn amber" data-task-repeat="${t.id}">Powt√≥rz</button>
          <button class="${t.status==='done'?'btn green':'btn gray'}" data-task-done="${t.id}" ${t.status==='done'?'disabled':''}>Zamknij</button>
          ${t._syncError?`<button class="btn amber" data-task-retry="${t.id}" title="Pon√≥w synchronizacjƒô">Retry</button>`:''}
        </div></div>`;
      list.appendChild(d);
    });
    const byW = qs('#tasks-by-worker'); if(byW) byW.innerHTML = '';
    // small HTML escape helper for safe insertion into innerHTML - delegate to appHelpers when available
    function escapeHtml(s){
      try{ if(window.appHelpers && typeof window.appHelpers.escapeHtml === 'function') return window.appHelpers.escapeHtml(s); }catch(_){ }
      if(s == null) return '';
      try{ return window.escapeHtml ? window.escapeHtml(s) : String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }catch(_){ return String(s); }
    }
    try{ window.escapeHtml = escapeHtml; }catch(_){ }
  }

  // If an order has no remaining active tasks (todo/run), remove all tasks linked to that order from state.tasks
  function cleanupTasksForOrder(orderId){
    try{
      // respect settings: if autoCleanup explicitly disabled, skip
      if(state.settings && state.settings.autoCleanup === false){ (window.logDev||console.log)('[cleanupTasksForOrder] skipped due to settings.autoCleanup=false for', orderId); return; }
      const tasks = (state.tasks||[]).filter(t=>t.orderId===orderId);
      if(tasks.length===0) return; // nothing to do
      const anyActive = tasks.some(t=> (t.status||'') !== 'done');
      if(!anyActive){
        // remove tasks belonging to this order
        state.tasks = (state.tasks||[]).filter(t=> t.orderId !== orderId);
        save(); try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
        (window.logDev||console.log)('[cleanupTasksForOrder] removed tasks for order', orderId);
      }
    }catch(e){ (window.logDev||console.log)('[cleanupTasksForOrder] error', e && e.message); }
  }

  // Generate tasks for an order based on its process
  function generateTasks(orderId){
    try{
      console.log('[generateTasks] Generating tasks for order:', orderId);
      
      // Find the order
      const order = (state.orders||[]).find(o => o.id === orderId);
      if(!order){
        console.error('[generateTasks] Order not found:', orderId);
        return false;
      }
      
      // Check if order has a process assigned
      if(!order.processId){
        console.warn('[generateTasks] Order has no process assigned:', orderId);
        alert('Zlecenie nie ma przypisanego procesu. Wybierz proces dla tego zlecenia.');
        return false;
      }
      
      // Find the process
      const process = (state.processes||[]).find(p => p.id === order.processId);
      if(!process){
        console.error('[generateTasks] Process not found:', order.processId);
        return false;
      }
      
      // Check if process has operations
      if(!process.operations || process.operations.length === 0){
        console.warn('[generateTasks] Process has no operations:', process.name);
        alert('Proces "' + process.name + '" nie ma zdefiniowanych operacji.');
        return false;
      }
      
      // Remove existing tasks for this order (clean slate)
      const existingTasks = (state.tasks||[]).filter(t => t.orderId === orderId);
      if(existingTasks.length > 0){
        console.log('[generateTasks] Removing', existingTasks.length, 'existing tasks for order', orderId);
        state.tasks = (state.tasks||[]).filter(t => t.orderId !== orderId);
      }
      
      // Generate new tasks from process operations
      let tasksCreated = 0;
      (process.operations||[]).forEach((op, idx) => {
        // Find operation in catalog to get checklist
        console.log('[generateTasks] üîç Przetwarzam operacjƒô:', op.name, 'ID:', op.id);
        const catalogOp = (state.operationsCatalog||[]).find(catOp => catOp.id === op.id);
        console.log('[generateTasks] üìã Znaleziono w katalogu:', catalogOp ? catalogOp.name : 'NIE');
        
        const taskId = uid();
        const task = {
          id: taskId,
          orderId: orderId,
          opId: op.id || op.no,
          opIndex: idx, // ‚≠ê Position in process - needed for dependencies!
          opName: op.name || 'Operacja ' + (idx + 1),
          status: 'todo', // All tasks start as 'todo'
          estMin: op.time || 60, // Estimated time in minutes
          elapsedMin: 0,
          assignees: [], // Will be assigned later
          createdAt: new Date().toISOString()
        };
        console.log('[generateTasks] üìù Utworzone zadanie - opId:', task.opId, 'opName:', task.opName);
        
        // Copy checklist from operation if propagateToTasks is enabled
        if(catalogOp && catalogOp.checklistTemplate && catalogOp.checklistSettings && catalogOp.checklistSettings.propagateToTasks){
          const template = catalogOp.checklistTemplate;
          console.log('[generateTasks] ‚úÖ Warunki spe≈Çnione - kopiujƒô checklistƒô. Items:', template.items?.length);
          if(Array.isArray(template.items) && template.items.length > 0){
            task.checklist = template.items.map(item => ({
              id: item.id || uid('chk_'),
              label: item.label || '',
              done: false,
              required: item.required || false,
              metadata: item.metadata || {}
            }));
            console.log('[generateTasks] ‚úÖ Skopiowano', task.checklist.length, 'punkt√≥w checklisty z operacji', op.name, 'do zadania', taskId);
          } else {
            console.warn('[generateTasks] ‚ö†Ô∏è template.items puste lub nie jest tablicƒÖ');
          }
        } else {
          console.warn('[generateTasks] ‚ùå Warunki NIE spe≈Çnione:', {
            catalogOp: !!catalogOp,
            checklistTemplate: !!catalogOp?.checklistTemplate,
            checklistSettings: !!catalogOp?.checklistSettings,
            propagateToTasks: catalogOp?.checklistSettings?.propagateToTasks
          });
        }
        
        state.tasks = state.tasks || [];
        state.tasks.push(task);
        tasksCreated++;
      });
      
      console.log('[generateTasks] Created', tasksCreated, 'tasks for order', order.name);
      
      // Save and refresh UI
      save();
      try{
        renderTasks();
        renderOrderPage && renderOrderPage();
        renderGantt && renderGantt();
      }catch(e){
        console.error('[generateTasks] Error refreshing UI:', e);
      }
      
      return true;
    }catch(e){
      console.error('[generateTasks] Error:', e && e.message);
      return false;
    }
  }

  // Change task status (todo ‚Üí run ‚Üí done)
  function changeTaskStatus(taskId, newStatus){
    try{
      console.log('[changeTaskStatus] Changing task', taskId, 'to status:', newStatus);
      
      // Validate status
      const validStatuses = ['todo', 'run', 'done'];
      if(!validStatuses.includes(newStatus)){
        console.error('[changeTaskStatus] Invalid status:', newStatus);
        return false;
      }
      
      // Find the task
      const task = (state.tasks||[]).find(t => t.id === taskId);
      if(!task){
        console.error('[changeTaskStatus] Task not found:', taskId);
        return false;
      }
      
      const oldStatus = task.status;
      task.status = newStatus;
      
      // Update timestamp
      task.lastStatusChange = new Date().toISOString();
      
      // If marking as 'run', set start time
      if(newStatus === 'run' && !task.startedAt){
        task.startedAt = new Date().toISOString();
      }
      
      // If marking as 'done', set completion time
      if(newStatus === 'done' && !task.completedAt){
        task.completedAt = new Date().toISOString();
        // Set elapsed time = estimated time if not already set
        if(!task.elapsedMin || task.elapsedMin === 0){
          task.elapsedMin = task.estMin || 0;
        }
      }
      
      console.log('[changeTaskStatus] Task', taskId, 'status changed from', oldStatus, 'to', newStatus);
      
      // Save and refresh UI
      save();
      try{
        renderTasks();
        renderOrderPage && renderOrderPage();
        renderGantt && renderGantt();
        updateOrderProgress && updateOrderProgress(task.orderId);
      }catch(e){
        console.error('[changeTaskStatus] Error refreshing UI:', e);
      }
      
      // Check if order can be auto-completed
      if(newStatus === 'done'){
        setTimeout(() => {
          const order = (state.orders||[]).find(o => o.id === task.orderId);
          if(order){
            const allTasks = (state.tasks||[]).filter(t => t.orderId === task.orderId);
            const allDone = allTasks.length > 0 && allTasks.every(t => t.status === 'done');
            if(allDone){
              console.log('[changeTaskStatus] All tasks done for order', task.orderId, '- consider completing order');
              // Could show notification or auto-complete
            }
          }
        }, 100);
      }
      
      return true;
    }catch(e){
      console.error('[changeTaskStatus] Error:', e && e.message);
      return false;
    }
  }

  // Complete/close an order
  function completeOrder(orderId){
    try{
      console.log('[completeOrder] Completing order:', orderId);
      
      // Find the order
      const order = (state.orders||[]).find(o => o.id === orderId);
      if(!order){
        console.error('[completeOrder] Order not found:', orderId);
        return false;
      }
      
      // Check if all tasks are done
      const orderTasks = (state.tasks||[]).filter(t => t.orderId === orderId);
      if(orderTasks.length === 0){
        console.warn('[completeOrder] Order has no tasks:', orderId);
      }else{
        const incompleteTasks = orderTasks.filter(t => t.status !== 'done');
        if(incompleteTasks.length > 0){
          console.warn('[completeOrder] Order has', incompleteTasks.length, 'incomplete tasks');
          const confirmMsg = 'Zlecenie "' + order.name + '" ma ' + incompleteTasks.length + ' niedoko≈Ñczonych zada≈Ñ.\n\nCzy na pewno chcesz zamknƒÖƒá to zlecenie?';
          if(!confirm(confirmMsg)){
            return false;
          }
        }
      }
      
      // Mark order as completed
      order.status = 'completed';
      order.completedAt = new Date().toISOString();
      
      // Mark all tasks as done (if not already)
      orderTasks.forEach(task => {
        if(task.status !== 'done'){
          task.status = 'done';
          task.completedAt = task.completedAt || new Date().toISOString();
        }
      });
      
      // Release warehouse reservations (optional)
      try{
        if(window.warehouseReservations && Array.isArray(window.warehouseReservations)){
          const orderReservations = window.warehouseReservations.filter(r => r.orderId === orderId);
          if(orderReservations.length > 0){
            console.log('[completeOrder] Releasing', orderReservations.length, 'warehouse reservations');
            // Mark reservations as fulfilled
            orderReservations.forEach(res => {
              res.status = 'fulfilled';
              res.fulfilledAt = new Date().toISOString();
            });
          }
        }
      }catch(e){
        console.warn('[completeOrder] Error releasing reservations:', e);
      }
      
      console.log('[completeOrder] Order', order.name, 'marked as completed');
      
      // Save and refresh UI
      save();
      try{
        renderOrderPage && renderOrderPage();
        renderTasks && renderTasks();
        renderGantt && renderGantt();
        renderDashboard && renderDashboard();
      }catch(e){
        console.error('[completeOrder] Error refreshing UI:', e);
      }
      
      alert('Zlecenie "' + order.name + '" zosta≈Ço zamkniƒôte.');
      return true;
    }catch(e){
      console.error('[completeOrder] Error:', e && e.message);
      return false;
    }
  }

  function generateTasksByWorker(){
    showReportsProgress(true, 'Przetwarzanie danych pracownik√≥w...', 20);
    
    setTimeout(() => {
      const container = qs('#tasks-by-worker'); if(!container) return;
      container.innerHTML = '';
      (window.logDev||console.log)('[generateTasksByWorker] start');
      const map = new Map();
      const empLookup = new Map((state.employees||[]).map(e=>[e.id, e]));
      
      showReportsProgress(true, 'Analizowanie zada≈Ñ...', 40);
      
      setTimeout(() => {
        showReportsProgress(true, 'Przetwarzanie zada≈Ñ...', 60);
        
        setTimeout(() => {
          // Poka≈º tylko aktywne zadania (te kt√≥re sƒÖ w state.tasks)
          (state.tasks||[]).forEach(t=>{
            const order = (state.orders||[]).find(o => o.id === t.orderId);
            // Poka≈º zadanie tylko je≈õli ma przypisanych pracownik√≥w i jest powiƒÖzane z aktywnym zleceniem
            if (order) {
              // Support multiple formats: assignees array, assignee object, or employeeId (for assembly tasks)
              let as = t.assignees || (t.assignee ? [t.assignee] : []);
              // If no assignees, check for employeeId (assembly/monta≈º tasks)
              if ((!Array.isArray(as) || as.length === 0) && t.employeeId) {
                as = [t.employeeId];
              }
              if (Array.isArray(as) && as.length) {
                as.forEach(a => {
                  // Skip null/undefined entries
                  if (!a) return;
                  const id = (typeof a === 'object' && a.id) ? a.id : a;
                  const name = (typeof a === 'object' && a.name) ? a.name : (empLookup.get(id)||{}).name || id;
                  if (!map.has(id)) {
                    map.set(id, {id, name, tasks: []});
                  }
                  map.get(id).tasks.push({
                    orderId: t.orderId,
                    orderName: order.name,
                    opName: t.opName || t.name || 'Zadanie',
                    process: order.name,
                    time: t.hours ? (t.hours * 60) : (t.estMin || t.elapsedMin || 0),
                    status: t.status || 'todo'
                  });
                });
              }
            }
          });
          
          showReportsProgress(true, 'Renderowanie wynik√≥w...', 80);
          
          setTimeout(() => {
            if(map.size===0){ container.innerHTML = '<div class="muted">Brak przypisa≈Ñ do pracownik√≥w (brak assignee). Upewnij siƒô, ≈ºe procesy majƒÖ przypisanych pracownik√≥w.</div>'; showReportsProgress(false); return; }
            (window.logDev||console.log)('[generateTasksByWorker] map keys', Array.from(map.keys()), 'size', map.size);
            Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name)).forEach(w=>{
              (window.logDev||console.log)('[generateTasksByWorker] worker', w.id, w.name, 'tasks:', JSON.parse(JSON.stringify(w.tasks)));
              const card = document.createElement('div'); card.className='card';
              let listItems = '';
              try{
                listItems = w.tasks.map(t=>{
                  const orderLabel = t.orderId ? (t.orderName ? `${t.orderName} (${t.orderId})` : t.orderId) : (t.process || '-');
                  return `<li><strong>${escapeHtml(orderLabel)}</strong> ‚Äî ${escapeHtml(t.opName||'(zadanie)')} <span class="muted">‚Ä¢ ${escapeHtml(t.process||'')}</span> <span class="pill">${t.time}m</span></li>`;
                }).join('');
              }catch(err){ (window.logDev||console.log)('[generateTasksByWorker] listItems render error', err && err.message); listItems = `<li class="err">B≈ÇƒÖd renderowania: ${err && (err.message||err)}</li>`; }
              const ul = `<ul class="emp-tasks-list" style="margin:8px 0;padding-left:18px">${listItems}</ul>`;
              card.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${w.name}</b><div class="muted">Zada≈Ñ: ${w.tasks.length}</div></div><div class="row"><button class="btn" data-export-emp="${w.id}">Eksport CSV</button> <button class="btn blue" data-send-emp="${w.id}">Wy≈õlij</button></div></div>${ul}`;
              container.appendChild(card);
              (window.logDev||console.log)('[generateTasksByWorker] appended card innerText', (container && container.innerText)? container.innerText.slice(0,200) : '<empty>');
            });
            container.querySelectorAll('[data-export-emp]').forEach(btn=>btn.addEventListener('click', ()=>{ const id = btn.getAttribute('data-export-emp'); exportCSVForEmployee(id); }));
            container.querySelectorAll('[data-send-emp]').forEach(btn=>btn.addEventListener('click', ()=>{ const id = btn.getAttribute('data-send-emp'); console.log('Wy≈õlij clicked for emp:', id); const txt = buildEmployeeText(id); copyToClipboard(txt); // also trigger download
              const a=document.createElement('a'); const blob=new Blob([txt],{type:'text/plain'}); const url=URL.createObjectURL(blob); a.href=url; a.download = `tasks_${id}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            }));
            
            showReportsProgress(false);
          }, 100);
        }, 100);
      }, 100);
    }, 50);
  }

  function exportCSVForEmployee(empId){
    const emp = (state.employees||[]).find(e=>e.id===empId) || {id:empId,name:empId};
    const rows = [];
    (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ if(op.assignee && op.assignee.id===empId){ rows.push({employee:emp.name, process:proc.name, opName:op.name, time:op.time||0}); } }); });
    (state.tasks||[]).forEach(t=>{ const as = t.assignees || (t.assignee ? [t.assignee] : []); if(Array.isArray(as) && as.some(a=> (a.id||a) === empId)) rows.push({employee:emp.name, process: (state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId, opName: t.opName, time: t.estMin||t.elapsedMin||0}); });
    if(rows.length===0){ alert('Brak zada≈Ñ dla pracownika: '+emp.name); return; }
    const csv = ['employee,process,operation,timeMin'].concat(rows.map(r=>`"${(r.employee||'').replace(/"/g,'""')}","${(r.process||'').replace(/"/g,'""')}","${(r.opName||'').replace(/"/g,'""')}",${r.time||0}`)).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tasks_'+(emp.name.replace(/\s+/g,'_'))+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function exportCSVAllByWorker(){
    const map = new Map(); const empLookup = new Map((state.employees||[]).map(e=>[e.id,e]));
    (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ if(op.assignee && op.assignee.id){ const id=op.assignee.id; if(!map.has(id)) map.set(id,[]); map.get(id).push({process:proc.name,opName:op.name,time:op.time||0}); } }); });
    (state.tasks||[]).forEach(t=>{ const as = t.assignees || (t.assignee ? [t.assignee] : []); if(Array.isArray(as)) as.forEach(a=>{ const id=a.id||a; if(!map.has(id)) map.set(id,[]); map.get(id).push({process: (state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId, opName:t.opName, time:t.estMin||t.elapsedMin||0}); }); });
    if(map.size===0){ alert('Brak przypisa≈Ñ do eksportu.'); return; }
    const rows=[]; map.forEach((tasks,id)=>{ const name=(state.employees||[]).find(e=>e.id===id)?.name || id; tasks.forEach(t=>rows.push({employee:name,process:t.process,opName:t.opName,time:t.time})); });
    const csv = ['employee,process,operation,timeMin'].concat(rows.map(r=>`"${(r.employee||'').replace(/"/g,'""')}","${(r.process||'').replace(/"/g,'""')}","${(r.opName||'').replace(/"/g,'""')}",${r.time||0}`)).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tasks_by_employee.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  const tasksGenBtn = qs('#tasks-gen-by-emp'); if(tasksGenBtn){ tasksGenBtn.addEventListener('click', ()=>{ generateTasksByWorker(); }); }
  const tasksExportAllBtn = qs('#tasks-export-csv-by-emp'); if(tasksExportAllBtn){ tasksExportAllBtn.addEventListener('click', ()=>{ exportCSVAllByWorker(); }); }
  const tasksShowByEmpBtn = qs('#tasks-show-by-emp'); if(tasksShowByEmpBtn){ tasksShowByEmpBtn.addEventListener('click', ()=>{
    state.uiShowTasksByEmpTable = !state.uiShowTasksByEmpTable;
    if(state.uiShowTasksByEmpTable){ tasksShowByEmpBtn.textContent = 'Ukryj podzia≈Ç'; generateTasksByWorker(); }
    else { tasksShowByEmpBtn.textContent = 'Poka≈º podzia≈Ç'; const byW = qs('#tasks-by-worker'); if(byW) byW.innerHTML = ''; }
  }); }
  const tasksFilterOrder = qs('#tasks-filter-order'); if(tasksFilterOrder){ tasksFilterOrder.addEventListener('change', ()=>{ renderTasks(); }); }
  const tasksGroupBy = qs('#tasks-group-by'); if(tasksGroupBy){ tasksGroupBy.addEventListener('change', ()=>{ renderTasks(); }); }
  const tasksFilterStatus = qs('#tasks-filter-status'); if(tasksFilterStatus){ tasksFilterStatus.addEventListener('change', ()=>{ renderTasks(); }); }

  // Auto-assign event listeners
  const autoAssignAllBtn = qs('#tasks-auto-assign-all');
  if(autoAssignAllBtn) {
    autoAssignAllBtn.addEventListener('click', ()=>{
      if(!window.autoAssignAlgorithm) {
        alert('Modu≈Ç Auto-assign nie jest za≈Çadowany');
        return;
      }
      
      const confirmed = confirm('Czy na pewno chcesz automatycznie przypisaƒá wszystkie nieprzypisane zadania?\n\nAlgorytm wybierze najlepszych pracownik√≥w na podstawie:\n- Dopasowania umiejƒôtno≈õci\n- ObciƒÖ≈ºenia pracownika\n- Dostƒôpno≈õci');
      
      if(!confirmed) return;
      
      console.log('ü§ñ Rozpoczynam auto-assign wszystkich zada≈Ñ...');
      autoAssignAllBtn.disabled = true;
      autoAssignAllBtn.textContent = '‚è≥ Przypisujƒô...';
      
      setTimeout(() => {
        const result = window.autoAssignAlgorithm.autoAssignAll({
          dryRun: false,
          allowConflicts: false,
          minScore: 20,
          sortBy: 'duration'
        });
        
        autoAssignAllBtn.disabled = false;
        autoAssignAllBtn.textContent = 'ü§ñ Auto-assign wszystkie';
        
        if(result.success) {
          const { assigned, failed, conflicts } = result.stats;
          let message = `‚úÖ Przypisano ${assigned} zada≈Ñ`;
          if(failed > 0) message += `\n‚ö†Ô∏è Niepowodzenia: ${failed}`;
          if(conflicts > 0) message += `\n‚ùå Konflikty: ${conflicts}`;
          
          alert(message);
          console.log('Szczeg√≥≈Çy:', result);
          renderTasks();
          renderGantt();
        } else {
          alert('‚ùå B≈ÇƒÖd: ' + result.message);
        }
      }, 100);
    });
  }

  const rebalanceBtn = qs('#tasks-rebalance');
  if(rebalanceBtn) {
    rebalanceBtn.addEventListener('click', ()=>{
      if(!window.autoAssignAlgorithm) {
        alert('Modu≈Ç Auto-assign nie jest za≈Çadowany');
        return;
      }
      
      const confirmed = confirm('Czy na pewno chcesz rebalansowaƒá obciƒÖ≈ºenie pracownik√≥w?\n\nAlgorytm przeniesie zadania od przeciƒÖ≈ºonych pracownik√≥w do mniej obciƒÖ≈ºonych.');
      
      if(!confirmed) return;
      
      console.log('‚öñÔ∏è Rozpoczynam rebalansowanie...');
      rebalanceBtn.disabled = true;
      rebalanceBtn.textContent = '‚è≥ Rebalansowanie...';
      
      setTimeout(() => {
        const result = window.autoAssignAlgorithm.rebalanceWorkload({
          dryRun: false,
          maxIterations: 10,
          targetUtilization: 0.8
        });
        
        rebalanceBtn.disabled = false;
        rebalanceBtn.textContent = '‚öñÔ∏è Rebalansuj';
        
        if(result.success) {
          const { moves, overloaded, underloaded } = result.stats;
          let message = `‚úÖ Przesuniƒôto ${moves} zada≈Ñ`;
          if(overloaded > 0) message += `\nüìä PrzeciƒÖ≈ºeni: ${overloaded}`;
          if(underloaded > 0) message += `\nüìä NiedociƒÖ≈ºeni: ${underloaded}`;
          
          alert(message);
          console.log('Szczeg√≥≈Çy:', result);
          renderTasks();
          renderGantt();
        } else {
          alert('‚ùå B≈ÇƒÖd: ' + result.message);
        }
      }, 100);
    });
  }

  function renderEmployees(){ 
    const tb=qs('#emp-tb'); 
    if(!tb) return;
    tb.innerHTML=''; 
    const employees = Array.isArray(state.employees) ? state.employees : [];
    const uniqueEmployees = [];
    const seenIds = new Set();
    employees.forEach(e=>{
      const empId = e && e.id ? e.id : `emp-${uniqueEmployees.length}`;
      if(seenIds.has(empId)) return;
      seenIds.add(empId);
      uniqueEmployees.push(e);
    });
    console.log('üîç [renderEmployees] unikalnych:', uniqueEmployees.length, 'oryginalnie:', employees.length);
    uniqueEmployees.forEach(e=>{ 
      const tr=document.createElement('tr'); 
      tr.innerHTML='<td>'+(e.name||'‚Äî')+'</td><td>'+(e.role||'‚Äî')+'</td><td>'+(e.phone||'‚Äî')+'</td><td>'+(e.cap||100)+'</td><td>'+(e.hoursPerDay||8)+'</td><td><button class="btn" data-emp-ed="'+(e.id||'')+'">Edytuj</button> <button class="btn red" data-emp-del="'+(e.id||'')+'">Usu≈Ñ</button></td>'; 
      tb.appendChild(tr); 
    }); 
  }

  // Function to open PIN management modal
  function openPINManagementModal() {
    const employees = Array.isArray(state.employees) ? state.employees : [];
    
    if (employees.length === 0) {
      showModal('üî¢ ZarzƒÖdzanie PIN', '<p style="text-align:center;padding:20px">Brak pracownik√≥w do zarzƒÖdzania PIN.</p>', [
        { label: '‚úï Zamknij', onClick: closeModal }
      ]);
      return;
    }

    let contentHTML = '<div style="max-height:500px;overflow-y:auto">';
    contentHTML += '<table style="width:100%;border-collapse:collapse">';
    contentHTML += '<thead><tr style="background:#1e293b;color:#fff;border-bottom:2px solid #334155">';
    contentHTML += '<th style="padding:12px;text-align:left">Pracownik</th>';
    contentHTML += '<th style="padding:12px;text-align:left">Rola</th>';
    contentHTML += '<th style="padding:12px;text-align:center;width:150px">PIN (4 cyfry)</th>';
    contentHTML += '<th style="padding:12px;text-align:center;width:100px">Akcja</th>';
    contentHTML += '</tr></thead><tbody>';

    employees.forEach(emp => {
      contentHTML += `<tr style="border-bottom:1px solid #e2e8f0">`;
      contentHTML += `<td style="padding:12px;font-weight:600;color:#fff">${emp.name || '‚Äî'}</td>`;
      contentHTML += `<td style="padding:12px;color:#94a3b8">${emp.role || '‚Äî'}</td>`;
      contentHTML += `<td style="padding:12px;text-align:center">
        <input type="text" 
               id="pin-input-${emp.id}" 
               value="${emp.pin || ''}" 
               placeholder="0000" 
               maxlength="4" 
               pattern="[0-9]{4}"
               style="width:100px;padding:8px;text-align:center;border:2px solid #334155;border-radius:4px;background:#1e293b;color:#fff;font-weight:bold;font-size:16px">
      </td>`;
      contentHTML += `<td style="padding:12px;text-align:center">
        <button class="btn green" style="padding:6px 12px" onclick="savePINForEmployee('${emp.id}')">‚úì Zapisz</button>
      </td>`;
      contentHTML += `</tr>`;
    });

    contentHTML += '</tbody></table></div>';

    showModal('üî¢ ZarzƒÖdzanie kodami PIN pracownik√≥w', contentHTML, [
      { label: '‚úï Zamknij', onClick: closeModal }
    ]);
  }

  // Function to save PIN for an employee
  function savePINForEmployee(employeeId) {
    const pinInput = document.getElementById(`pin-input-${employeeId}`);
    if (!pinInput) {
      console.error('‚ùå Nie znaleziono pola PIN dla pracownika:', employeeId);
      return;
    }

    const pin = pinInput.value.trim();

    // Walidacja PIN (4 cyfry)
    if (pin && !/^\d{4}$/.test(pin)) {
      alert('‚ùå PIN musi sk≈Çadaƒá siƒô z dok≈Çadnie 4 cyfr (0-9)');
      pinInput.focus();
      return;
    }

    // Znajd≈∫ pracownika
    const employee = state.employees.find(e => e.id === employeeId);
    if (!employee) {
      console.error('‚ùå Nie znaleziono pracownika o ID:', employeeId);
      return;
    }

    // Zapisz lub usu≈Ñ PIN
    if (pin) {
      employee.pin = pin;
      console.log(`‚úÖ Zapisano PIN dla pracownika: ${employee.name} (ID: ${employeeId})`);
    } else {
      delete employee.pin;
      console.log(`üóëÔ∏è Usuniƒôto PIN dla pracownika: ${employee.name} (ID: ${employeeId})`);
    }

    // Zapisz zmiany do localStorage i Firebase
    save();

    // Poka≈º toast z potwierdzeniem
    showToast(pin ? `‚úÖ PIN zapisany dla: ${employee.name}` : `üóëÔ∏è PIN usuniƒôty dla: ${employee.name}`, 'success');

    // Zmie≈Ñ kolor przycisku na chwilƒô
    const saveBtn = pinInput.closest('tr').querySelector('button');
    if (saveBtn) {
      const originalBg = saveBtn.style.background;
      saveBtn.style.background = '#10b981';
      saveBtn.textContent = '‚úì Zapisano';
      setTimeout(() => {
        saveBtn.style.background = originalBg;
        saveBtn.textContent = '‚úì Zapisz';
      }, 1500);
    }
  }

  // Export functions to window for onclick handlers
  window.openPINManagementModal = openPINManagementModal;
  window.savePINForEmployee = savePINForEmployee;

  // Function to restore authentic data
  function restoreAuthenticData() {
    const authenticData = {
      "storage": {
        "mode": "firebase",
        "appId": "doors-demo",
        "userId": "hala-1",
        "fbConfig": {
          "apiKey": "AIzaSyD93UqqsHWoAUBV7g8OVKAnajIfGDX_ZdY",
          "authDomain": "doors-planner.firebaseapp.com",
          "projectId": "doors-planner",
          "storageBucket": "doors-planner.appspot.com",
          "messagingSenderId": "513098608067",
          "appId": "1:513098608067:web:1fe3855b3470ca7ef22176"
        },
        "autoSaveAssign": true,
        "spellcheckEnforce": true
      },
      "employees": [],
      "operationsCatalog": [
        {"id": "mg9t6hiit3at", "no": 1, "name": "Frezowanie na CNC (belki futryny)", "time": 40, "workers": 1, "skills": ["CNC", "belki"], "defaultAssignees": []},
        {"id": "mg9t6hii3w84", "no": 2, "name": "Sklejanie belek (futryna)", "time": 20, "workers": 1, "skills": ["sklejanie", "belki"], "defaultAssignees": []},
        {"id": "mg9t6hiije0t", "no": 3, "name": "Kontrola wymiar√≥w (futryna)", "time": 10, "workers": 1, "skills": ["kontrola"], "defaultAssignees": []},
        {"id": "mg9t6hiinhp6", "no": 4, "name": "Szlifowanie (futryna)", "time": 15, "workers": 1, "skills": ["szlifowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii8h6d", "no": 5, "name": "Szczotkowanie (futryna)", "time": 12, "workers": 1, "skills": ["szczotkowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii22fy", "no": 6, "name": "Malowanie (futryna)", "time": 30, "workers": 1, "skills": ["malowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii8c9m", "no": 7, "name": "Okuwanie (futryna)", "time": 8, "workers": 1, "skills": ["okucia"], "defaultAssignees": []},
        {"id": "mg9t6hii16mh", "no": 8, "name": "Wyciƒôcie belek pod skrzyd≈Ço", "time": 35, "workers": 1, "skills": ["CNC", "belki"], "defaultAssignees": []},
        {"id": "mg9t6hiibhu3", "no": 9, "name": "Sklejenie belek (skrzyd≈Ço)", "time": 20, "workers": 1, "skills": ["sklejanie", "belki"], "defaultAssignees": []},
        {"id": "mg9t6hii82z6", "no": 10, "name": "Wyciƒôcie sklejki", "time": 25, "workers": 1, "skills": ["sklejka"], "defaultAssignees": []},
        {"id": "mg9t6hii6g4a", "no": 11, "name": "Przygotowanie forniru", "time": 18, "workers": 1, "skills": ["fornir"], "defaultAssignees": []},
        {"id": "mg9t6hiibgls", "no": 12, "name": "Fornirowanie", "time": 30, "workers": 1, "skills": ["fornirowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii482o", "no": 13, "name": "Przygotowanie rurek pod elektronikƒô", "time": 12, "workers": 1, "skills": ["elektronika"], "defaultAssignees": []},
        {"id": "mg9t6hiiy42w", "no": 14, "name": "Monta≈º rurek pod elektronikƒô", "time": 18, "workers": 1, "skills": ["elektronika"], "defaultAssignees": []},
        {"id": "mg9t6hiil5zr", "no": 15, "name": "Przyciƒôcie poprzeczek", "time": 10, "workers": 1, "skills": ["poprzeczki"], "defaultAssignees": []},
        {"id": "mg9t6hii01mz", "no": 16, "name": "Monta≈º poprzeczek", "time": 12, "workers": 1, "skills": ["poprzeczki"], "defaultAssignees": []},
        {"id": "mg9t6hii5ucc", "no": 17, "name": "Przyciƒôcie styropianu", "time": 5, "workers": 1, "skills": ["styropian"], "defaultAssignees": []},
        {"id": "mg9t6hiihdry", "no": 18, "name": "Monta≈º styropianu", "time": 8, "workers": 1, "skills": ["styropian"], "defaultAssignees": []},
        {"id": "mg9t6hii55mz", "no": 19, "name": "Przyciƒôcie naciƒÖgu", "time": 6, "workers": 1, "skills": ["naciag"], "defaultAssignees": []},
        {"id": "mg9t6hiiuh2p", "no": 20, "name": "Monta≈º naciƒÖgu", "time": 8, "workers": 1, "skills": ["naciag"], "defaultAssignees": []},
        {"id": "mg9t6hii8dmo", "no": 21, "name": "Sklejanie w prasie", "time": 25, "workers": 1, "skills": ["prasa"], "defaultAssignees": []},
        {"id": "mg9t6hii2y8d", "no": 22, "name": "Frezowanie na CNC (skrzyd≈Ço)", "time": 40, "workers": 1, "skills": ["CNC"], "defaultAssignees": []},
        {"id": "mg9t6hiisdiv", "no": 23, "name": "Szlifowanie (skrzyd≈Ço)", "time": 15, "workers": 1, "skills": ["szlifowanie"], "defaultAssignees": []},
        {"id": "mg9t6hiiz9js", "no": 24, "name": "Szczotkowanie (skrzyd≈Ço)", "time": 12, "workers": 1, "skills": ["szczotkowanie"], "defaultAssignees": []},
        {"id": "mg9t6hiimtpd", "no": 25, "name": "Malowanie (skrzyd≈Ço)", "time": 30, "workers": 1, "skills": ["malowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii642n", "no": 26, "name": "Okuwanie (skrzyd≈Ço)", "time": 8, "workers": 1, "skills": ["okucia"], "defaultAssignees": []},
        {"id": "mg9t6hii5mri", "no": 27, "name": "Przygotowanie zestawu do drzwi", "time": 10, "workers": 1, "skills": ["zestaw"], "defaultAssignees": []},
        {"id": "mg9t6hii942t", "no": 28, "name": "Przygotowanie antaby", "time": 8, "workers": 1, "skills": ["antaba"], "defaultAssignees": []},
        {"id": "mg9t6hiihf4q", "no": 29, "name": "Zam√≥wienie szyb", "time": 5, "workers": 1, "skills": ["szyby"], "defaultAssignees": []},
        {"id": "mg9t6hii6goh", "no": 30, "name": "Malowanie szyb", "time": 15, "workers": 1, "skills": ["szyby", "malowanie"], "defaultAssignees": []},
        {"id": "mg9t6hii6fl4", "no": 31, "name": "Klejenie szyb", "time": 20, "workers": 1, "skills": ["szyby", "klejenie"], "defaultAssignees": []},
        {"id": "mg9t6hii96bh", "no": 32, "name": "Polerowanie zamk√≥w i wypalenie logo", "time": 12, "workers": 1, "skills": ["zamki", "polerowanie"], "defaultAssignees": []},
        {"id": "mg9t6hiidt0v", "no": 33, "name": "Wymiary szyby (szer, H)", "time": 4, "workers": 1, "skills": ["szyby", "wymiary"], "defaultAssignees": []},
        {"id": "mg9t6hiig5mf", "no": 34, "name": "Wyciƒôcie belek pod futrynƒô", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hii5uvr", "no": 35, "name": "Frezowanie na CNC 40 m", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hiilbtt", "no": 36, "name": "Sklejanie belek", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijxejj", "no": 37, "name": "Kontrola wymiar√≥w", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijmycx", "no": 38, "name": "Szlifowanie", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijmp8a", "no": 39, "name": "Szczotkowanie", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijkvs2", "no": 40, "name": "Malowanie", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijdgql", "no": 41, "name": "Okuwanie", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijx585", "no": 42, "name": "Sklejenie belek", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijwq00", "no": 43, "name": "Przygotowanie forniru zgodnie z zam√≥wieniem", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []},
        {"id": "mg9t6hijh68k", "no": 44, "name": "Frezowanie na CNC", "time": 10, "workers": 1, "skills": [], "defaultAssignees": []}
      ],
      "processes": [
        {"id": "mg9t6hiieyao", "name": "Proces: Futryna", "operations": [{"name": "Frezowanie na CNC (belki futryny)", "time": 40}, {"name": "Sklejanie belek (futryna)", "time": 20}, {"name": "Kontrola wymiar√≥w (futryna)", "time": 10}, {"name": "Szlifowanie (futryna)", "time": 15}, {"name": "Szczotkowanie (futryna)", "time": 12}, {"name": "Malowanie (futryna)", "time": 30}, {"name": "Okuwanie (futryna)", "time": 8}]},
        {"id": "mg9t6hiiffge", "name": "Proces: Skrzyd≈Ço", "operations": [{"name": "Wyciƒôcie belek pod skrzyd≈Ço", "time": 35}, {"name": "Sklejenie belek (skrzyd≈Ço)", "time": 20}, {"name": "Wyciƒôcie sklejki", "time": 25}, {"name": "Fornirowanie", "time": 30}, {"name": "Frezowanie na CNC (skrzyd≈Ço)", "time": 40}, {"name": "Szlifowanie (skrzyd≈Ço)", "time": 15}, {"name": "Malowanie (skrzyd≈Ço)", "time": 30}, {"name": "Okuwanie (skrzyd≈Ço)", "time": 8}]},
        {"id": "mg9t6hiiuztd", "name": "Proces: Drzwi kompletne", "operations": [{"name": "Frezowanie na CNC (belki futryny)", "time": 40}, {"name": "Sklejanie belek (futryna)", "time": 20}, {"name": "Wyciƒôcie belek pod skrzyd≈Ço", "time": 35}, {"name": "Sklejenie belek (skrzyd≈Ço)", "time": 20}, {"name": "Sklejanie w prasie", "time": 25}, {"name": "Fornirowanie", "time": 30}, {"name": "Malowanie (skrzyd≈Ço)", "time": 30}, {"name": "Okuwanie (skrzyd≈Ço)", "time": 8}]}
      ],
      "orders": [],
      "tasks": [],
      "after": [],
      "PROC_TMP": [],
      "page": "gantt",
      "_timers": {},
      "uiShowTasksByEmpTable": false,
      "settings": {"autoCleanup": true}
    };

    // Restore the data
    Object.assign(state, authenticData);
    localStorage.setItem(storeKey, JSON.stringify(state));

    // Refresh all views
    renderEmployees();
    renderOps();
    renderProcPage();
    renderOrderPage();
    renderTasks();
    renderGantt();
    renderCapacityAnalysis();

    alert('‚úÖ Przywr√≥cono autentyczne dane!\n\nTwoje dane zosta≈Çy odzyskane z backupu.');
  }

  // Zmienna do przechowywania zaznaczonego zadania
  let selectedGanttTaskId = null;

  function selectGanttTask(taskId, taskData, employeeName) {
    // Odznacz poprzednie zadanie
    const prevSelected = qs('.gantt-task.selected');
    if (prevSelected) {
      prevSelected.classList.remove('selected');
    }

    // Zaznacz nowe zadanie
    selectedGanttTaskId = taskId;
    const taskEl = qs(`.gantt-task[data-task-id="${taskId}"]`);
    if (taskEl) {
      taskEl.classList.add('selected');
    }

    // Aktualizuj informacje o zaznaczonym zadaniu
    const infoEl = qs('#gantt-selected-task-info');
    if (infoEl) {
      const taskName = taskData.opName || taskData.name || 'Zadanie';
      const taskDate = taskData.startPlanned ? new Date(taskData.startPlanned).toLocaleDateString('pl-PL') : 'Brak daty';
      infoEl.textContent = `${taskName} (${employeeName}) - ${taskDate}`;
    }

    // W≈ÇƒÖcz przyciski
    qs('#gantt-move-task-back').disabled = false;
    qs('#gantt-move-task-forward').disabled = false;
    qs('#gantt-clear-selection').disabled = false;
  }

  function clearGanttTaskSelection() {
    selectedGanttTaskId = null;
    const prevSelected = qs('.gantt-task.selected');
    if (prevSelected) {
      prevSelected.classList.remove('selected');
    }

    const infoEl = qs('#gantt-selected-task-info');
    if (infoEl) {
      infoEl.textContent = 'Brak';
    }

    // Wy≈ÇƒÖcz przyciski
    qs('#gantt-move-task-back').disabled = true;
    qs('#gantt-move-task-forward').disabled = true;
    qs('#gantt-clear-selection').disabled = true;
  }

  function moveSelectedTask(days) {
    if (!selectedGanttTaskId) return;

    const task = state.tasks.find(t => t.id === selectedGanttTaskId);
    if (!task || !task.startPlanned) return;

    // Przesu≈Ñ datƒô poczƒÖtkowƒÖ
    const newStart = task.startPlanned + (days * 24 * 60 * 60 * 1000);
    task.startPlanned = newStart;

    // Przesu≈Ñ datƒô ko≈ÑcowƒÖ je≈õli istnieje
    if (task.endPlanned) {
      const duration = task.endPlanned - task.startPlanned;
      task.endPlanned = newStart + duration;
    }

    // Zapisz i od≈õwie≈º
    save();
    renderGantt();

    // Ponownie zaznacz zadanie po przerenderowaniu
    const taskEl = qs(`.gantt-task[data-task-id="${selectedGanttTaskId}"]`);
    if (taskEl) {
      const emp = state.employees?.find(e => {
        const empTasks = state.tasks.filter(t => {
          let a = t.assignees || (t.assignee ? [t.assignee] : []);
          if ((!Array.isArray(a) || a.length === 0) && t.employeeId) {
            a = [t.employeeId];
          }
          return a.some(assignee => assignee && (assignee.id || assignee) === e.id);
        });
        return empTasks.some(t => t.id === selectedGanttTaskId);
      });
      selectGanttTask(selectedGanttTaskId, task, emp?.name || '(Niezaplanowane)');
    }
  }

  function renderGantt(){
    const container = qs('#gantt-container');
    if(!container) {
      console.error('Gantt container not found');
      return;
    }

    console.log('üé® Rendering Gantt chart...');

    // Ensure container is visible for width calculations
    const wasHidden = container.closest('.hidden');
    if(wasHidden) {
      container.style.visibility = 'hidden';
      container.style.position = 'absolute';
      container.style.display = 'block';
    }

    const viewMode = qs('#gantt-view').value || 'week';
    const daysCount = viewMode === 'week' ? 7 : 30;
    
    // Inicjalizuj offset dat je≈õli nie istnieje
    if(typeof state.ganttDateOffset === 'undefined') {
      state.ganttDateOffset = 0;
    }
    
    // Znajd≈∫ bazowƒÖ datƒô (najwcze≈õniejsze zadanie lub dzisiaj)
    const now = new Date(); // Aktualna data z godzinami
    const today = new Date();
    today.setHours(0,0,0,0);
    let baseDate = new Date(today);
    (state.tasks||[]).forEach(t => {
      if(t.startPlanned && t.startPlanned < baseDate.getTime()) {
        baseDate = new Date(t.startPlanned);
        baseDate.setHours(0,0,0,0);
      }
    });
    
    // ZaokrƒÖglij do poczƒÖtku tygodnia (niedziela)
    baseDate.setDate(baseDate.getDate() - baseDate.getDay());
    
    // Zastosuj offset (przesuniƒôcie w dniach)
    const startDate = new Date(baseDate);
    startDate.setDate(baseDate.getDate() + state.ganttDateOffset);
    
    console.log('Gantt: baseDate:', baseDate.toISOString().slice(0,10), 'offset:', state.ganttDateOffset, 'startDate:', startDate.toISOString().slice(0,10));

    // Generate timeline header
    const timelineEl = qs('#gantt-timeline');
    timelineEl.innerHTML = '';

    for(let i = 0; i < daysCount; i++){
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      const dayEl = document.createElement('div');
      dayEl.className = 'gantt-time-slot';
      
      // Format daty z nazwƒÖ miesiƒÖca
      const dayName = date.toLocaleDateString('pl-PL', {weekday: 'short'});
      const dayNumber = date.getDate();
      const monthName = date.toLocaleDateString('pl-PL', {month: 'short'});
      
      // W widoku tygodniowym poka≈º dzie≈Ñ tygodnia + datƒô + miesiƒÖc
      // W widoku miesiƒôcznym poka≈º tylko datƒô + miesiƒÖc
      if (viewMode === 'week') {
        dayEl.innerHTML = `<div style="font-size:10px">${dayName}</div><div style="font-weight:600">${dayNumber} ${monthName}</div>`;
      } else {
        dayEl.innerHTML = `<div style="font-size:10px;font-weight:600">${dayNumber}</div><div style="font-size:9px">${monthName}</div>`;
      }
      
      if(date.toDateString() === now.toDateString()){
        dayEl.style.background = 'rgba(239, 68, 68, 0.1)';
        dayEl.style.borderRight = '2px solid #ef4444';
      }
      timelineEl.appendChild(dayEl);
    }

    // Generate resource rows
    const bodyEl = qs('#gantt-body');
    bodyEl.innerHTML = '';

    // Re-add dependencies SVG layer if not exists
    let svg = qs('#gantt-dependencies');
    if (!svg) {
      svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.id = 'gantt-dependencies';
      svg.className = 'gantt-dependency';
      svg.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;';
      bodyEl.appendChild(svg);
    } else {
      // Clear existing dependencies and ensure correct z-index
      svg.innerHTML = '';
      svg.style.zIndex = '10';
    }

    // Get container width for calculations
    const containerWidth = container.offsetWidth || 1000; // Fallback width
    const timelineWidth = containerWidth - 200;

    console.log('Container width:', containerWidth, 'Timeline width:', timelineWidth);

    // Migracja / uzupe≈Çnienie p√≥l z nowego generatora (je≈õli jeszcze nie zrobiona)
    (state.tasks||[]).forEach(t=>{
      if(typeof t.status === 'undefined') t.status='todo';
      if(!t.opName) t.opName = t.name || t.operationId || 'Zadanie';
      if(typeof t.estMin === 'undefined') t.estMin = t.duration || 0;
      if(!Array.isArray(t.assignees)) t.assignees = [];
    });

    // Nie przeliczaj automatycznie w widoku Gantt

  console.log('[gantt] state.tasks total=', (state.tasks||[]).length);
  // Group tasks by employee (tylko te kt√≥re majƒÖ przypisania)
    const tasksByEmployee = new Map();
    const allTasks = (state.tasks || []).slice();
    allTasks.forEach(task => {
      let assignees = task.assignees || (task.assignee ? [task.assignee] : []);
      // Support employeeId for assembly/monta≈º tasks
      if ((!Array.isArray(assignees) || assignees.length === 0) && task.employeeId) {
        assignees = [task.employeeId];
      }
      if(assignees && assignees.length){
        assignees.forEach(assignee => {
          if (!assignee) return; // Pomi≈Ñ null/undefined
          const empId = assignee.id || assignee;
            if(!tasksByEmployee.has(empId)) tasksByEmployee.set(empId, []);
            tasksByEmployee.get(empId).push(task);
        });
      }
    });

    const unassigned = allTasks.filter(t=>{
      let a = t.assignees || (t.assignee?[t.assignee]:[]);
      // Support employeeId for assembly/monta≈º tasks
      if ((!Array.isArray(a) || a.length === 0) && t.employeeId) {
        a = [t.employeeId];
      }
      return !a || a.length===0;
    });
    console.log('[gantt] employees=', (state.employees||[]).length, 'withAssignedRows=', tasksByEmployee.size, 'unassigned=', unassigned.length);
    if(!(state.employees||[]).length && unassigned.length){
      // Fallback: sztuczny pracownik aby zobaczyƒá zadania
      console.warn('[gantt] Brak pracownik√≥w ‚Äì renderujƒô wszystkie jako (Niezaplanowane)');
    }

    // Add rows for each employee
    (state.employees || []).forEach(employee => {
      const rowEl = document.createElement('div');
      rowEl.className = 'gantt-row';

      const resourceCell = document.createElement('div');
      resourceCell.className = 'gantt-resource-cell';
      resourceCell.textContent = employee.name;
      rowEl.appendChild(resourceCell);

      const taskCell = document.createElement('div');
      taskCell.className = 'gantt-task-cell';
      taskCell.setAttribute('data-employee-id', employee.id);

      // Add tasks for this employee - time-based positioning
      const employeeTasks = tasksByEmployee.get(employee.id) || [];
      console.log('Employee', employee.name, 'has', employeeTasks.length, 'tasks');

      // Calculate slot width dynamically based on view mode
      const slotWidth = timelineWidth / daysCount;
      console.log('SlotWidth:', slotWidth, 'for', daysCount, 'days, timeline width:', timelineWidth);
      let renderedCount = 0;
      employeeTasks.forEach((task, taskIndex) => {
        if(!task.startPlanned) {
          console.log('Task without startPlanned:', task.id, task.opName);
          return; // Skip if no start time
        }
        renderedCount++;
        const taskEl = document.createElement('div');
        taskEl.className = `gantt-task ${task.status || 'todo'}`;
        taskEl.setAttribute('data-task-id', task.id);
        taskEl.setAttribute('data-task-id', task.id);

        // Smart text formatting for task names
        let displayName = task.opName || 'Zadanie';
        let fontSize = '11px';
        
        // Calculate task duration in days
        let durationDays = 1; // Default to 1 day
        if (task.endPlanned && task.startPlanned) {
          durationDays = Math.max(1, Math.ceil((task.endPlanned - task.startPlanned) / (24 * 3600 * 1000)));
        } else if (task.hours) {
          durationDays = Math.max(1, Math.ceil(task.hours / 8)); // 8h work day
        }
        
        // Calculate task width based on duration and slot width
        let taskWidth = Math.max(slotWidth * durationDays - 10, slotWidth * 0.8);

        // Adjust text based on available width
        if (taskWidth < 60) {
          displayName = displayName.substring(0, 3) + '...';
          fontSize = '9px';
        } else if (displayName.length > 15) {
          displayName = displayName.substring(0, Math.floor(taskWidth / 8)) + '...';
          fontSize = '10px';
        }

        taskEl.textContent = displayName;
        taskEl.style.fontSize = fontSize;
        taskEl.style.width = taskWidth + 'px';
        taskEl.style.position = 'absolute';

        // Calculate position based on start date
        const taskDate = new Date(task.startPlanned);
        const daysDiff = Math.floor((taskDate - startDate) / (24 * 3600 * 1000));
        const leftPos = daysDiff * slotWidth + 5;
        taskEl.style.left = leftPos + 'px';

        console.log('Task:', displayName, 'start:', taskDate.toISOString().slice(0,10), 'startDate:', startDate.toISOString().slice(0,10), 'daysDiff:', daysDiff, 'leftPos:', leftPos);

        // Enhanced tooltip with full name
        taskEl.title = `${task.opName || 'Zadanie'}\nStatus: ${task.status || 'todo'}\nCzas: ${task.estMin || 60}min\nPracownik: ${employee.name}`;

        // Obs≈Çuga zaznaczania zadania
        taskEl.addEventListener('click', (e) => {
          e.stopPropagation();
          selectGanttTask(task.id, task, employee.name);
        });

        taskCell.appendChild(taskEl);
      });
      console.log('Rendered', renderedCount, 'tasks for', employee.name);

      rowEl.appendChild(taskCell);
      bodyEl.appendChild(rowEl);
    });

    // Row for unassigned tasks
  if(unassigned.length){
      const rowEl = document.createElement('div');
      rowEl.className = 'gantt-row';
      const resourceCell = document.createElement('div');
      resourceCell.className = 'gantt-resource-cell';
      resourceCell.textContent = '(Niezaplanowane)';
      rowEl.appendChild(resourceCell);
      const taskCell = document.createElement('div');
      taskCell.className = 'gantt-task-cell';
      // Use dynamic slot width based on view mode
      const slotWidth = timelineWidth / daysCount;
      let renderedUnassigned = 0;
      unassigned.slice(0,250).forEach(task=>{
        if(!task.startPlanned) {
          console.log('Unassigned task without startPlanned:', task.id, task.opName);
          return;
        }
        renderedUnassigned++;
        const taskEl = document.createElement('div');
        taskEl.className = `gantt-task ${task.status || 'todo'} unassigned`;
        taskEl.setAttribute('data-task-id', task.id);
        
        // Calculate task duration in days
        let durationDays = 1;
        let dur = 0;  // Deklaracja tutaj, aby by≈Ça dostƒôpna w ca≈Çej funkcji
        
        if (task.endPlanned && task.startPlanned) {
          durationDays = Math.max(1, Math.ceil((task.endPlanned - task.startPlanned) / (24 * 3600 * 1000)));
          dur = durationDays * 8 * 60;  // Przybli≈ºony czas w minutach
        } else if (task.hours) {
          durationDays = Math.max(1, Math.ceil(task.hours / 8));
          dur = task.hours * 60;  // Godziny na minuty
        } else {
          dur = task.estMin || task.duration || 0;
          durationDays = Math.max(1, Math.ceil(dur / (8 * 60)));
        }
        
        // Calculate task width based on duration and dynamic slot width
        let taskWidth = Math.max(slotWidth * durationDays - 10, slotWidth * 0.8);
        let displayName = (task.opName || task.name || 'Zadanie');
        
        // Adjust text based on width
        if (taskWidth < 60) {
          displayName = displayName.substring(0, 3) + '...';
        } else {
          displayName = displayName.slice(0, Math.floor(taskWidth / 8));
        }
        
        taskEl.textContent = displayName;
        // Calculate position based on start date
        const taskDate = new Date(task.startPlanned);
        const daysDiff = Math.floor((taskDate - startDate) / (24 * 3600 * 1000));
        const leftPos = daysDiff * slotWidth + 5;
        taskEl.style.left = leftPos + 'px';
        taskEl.style.width = taskWidth + 'px';
        taskEl.style.position = 'absolute';
        taskEl.title = `${task.opName||task.name||'Zadanie'}\nStatus: ${task.status||'-'}\nCzas: ${dur} min`;
        
        // Obs≈Çuga zaznaczania zadania
        taskEl.addEventListener('click', (e) => {
          e.stopPropagation();
          selectGanttTask(task.id, task, '(Niezaplanowane)');
        });
        
        console.log('Unassigned task:', displayName, 'start:', taskDate.toISOString().slice(0,10), 'daysDiff:', daysDiff, 'leftPos:', leftPos);
        taskCell.appendChild(taskEl);
      });
      console.log('Rendered', renderedUnassigned, 'unassigned tasks');
      if(unassigned.length>250){
        const more = document.createElement('div');
        more.style.cssText='position:absolute;left:'+(renderedUnassigned * 50 + 10)+'px;font-size:11px;color:#94a3b8;padding:2px';
        more.textContent = '+'+(unassigned.length-250)+' ...';
        taskCell.appendChild(more);
      }
      rowEl.appendChild(taskCell);
      bodyEl.appendChild(rowEl);
    }

    // Remove ALL old current time indicators if exist
    const oldTimeIndicators = document.querySelectorAll('.gantt-current-time');
    console.log('üóëÔ∏è Removing', oldTimeIndicators.length, 'old time indicators');
    oldTimeIndicators.forEach(indicator => indicator.remove());
    
    // Add current time indicator - tylko je≈õli "dzisiaj" jest w widocznym zakresie
    const todayMidnight = new Date(now);
    todayMidnight.setHours(0, 0, 0, 0);
    const daysSinceStart = Math.floor((todayMidnight - startDate) / (24 * 3600 * 1000));
    
    console.log('üìç Checking time indicator: now=', now.toLocaleString('pl-PL'), 'todayMidnight=', todayMidnight.toLocaleDateString('pl-PL'), 'startDate=', startDate.toLocaleDateString('pl-PL'), 'daysSinceStart=', daysSinceStart, 'daysCount=', daysCount);
    
    // Poka≈º liniƒô tylko je≈õli dzisiaj jest w widocznym zakresie
    if (daysSinceStart >= 0 && daysSinceStart < daysCount) {
      const currentTimeEl = document.createElement('div');
      currentTimeEl.className = 'gantt-current-time';
      
      // Oblicz pozycjƒô jako: dzie≈Ñ + procent godzin w dniu
      const hoursFraction = (now.getHours() * 60 + now.getMinutes()) / (24 * 60);
      const slotWidth = timelineWidth / daysCount; // Szeroko≈õƒá jednego dnia
      const currentTimePosition = (daysSinceStart + hoursFraction) * slotWidth;
      
      // 200px dla kolumny zasob√≥w (timeline zaczyna siƒô po tej kolumnie)
      currentTimeEl.style.left = (200 + currentTimePosition) + 'px';
      currentTimeEl.style.height = '100%'; // Pe≈Çna wysoko≈õƒá body
      currentTimeEl.style.pointerEvents = 'none'; // Nie blokuj klikniƒôƒá
      bodyEl.appendChild(currentTimeEl);
      console.log('‚úÖ Current time indicator added at day', daysSinceStart, 'hours:', now.getHours(), 'minutes:', now.getMinutes(), 'hoursFraction:', hoursFraction.toFixed(3), 'position:', (200 + currentTimePosition).toFixed(1) + 'px', 'slotWidth:', slotWidth.toFixed(1));
    } else {
      console.log('‚ùå Current time indicator hidden - today not in view range');
    }

    // Restore visibility if it was hidden
    if(wasHidden) {
      container.style.visibility = '';
      container.style.position = '';
      container.style.display = '';
    }

    if(!(state.employees||[]).length && !unassigned.length){
      bodyEl.innerHTML = '<div style="padding:12px;color:#94a3b8;font-size:13px">Brak pracownik√≥w i brak zada≈Ñ do wy≈õwietlenia.</div>';
    }
    console.log('Gantt chart rendered');

    // Initialize drag & drop functionality
    initGanttDragDrop();

    // Initialize visualization state - ZAWSZE false przy renderowaniu
    // (u≈ºytkownik musi kliknƒÖƒá przycisk ≈ºeby pokazaƒá)
    if (typeof window.ganttShowDependencies === 'undefined') {
      window.ganttShowDependencies = false;
      window.ganttShowCriticalPath = false;
    }

    // Update button states
    updateGanttButtons();

    // Render dependencies if enabled - with delay to ensure DOM is fully laid out
    if (window.ganttShowDependencies) {
      setTimeout(() => renderDependencies(), 50);
    }

    // Klikniƒôcie w t≈Ço Gantta odznacza zadanie
    container.addEventListener('click', (e) => {
      if (e.target === container || e.target.classList.contains('gantt-task-cell') || e.target.classList.contains('gantt-body')) {
        clearGanttTaskSelection();
      }
    });
  }

  // Make functions available globally for event handlers
  window.renderGantt = renderGantt;
  window.autoAssignEmployeesToTasks = autoAssignEmployeesToTasks;

  function generateGanttTestData(){
    // Generate some test data for Gantt chart demonstration (without overwriting existing data)
    console.log('Dodajƒô dane testowe dla harmonogramu...');

    // NIE dodawaj testowych pracownik√≥w - u≈ºytkownik ma swoich prawdziwych

    // Add test orders if none exist
    if((state.orders || []).length === 0){
      state.orders = [
        {id: 'order_test_1', name: 'Drzwi wej≈õciowe dƒÖb', client: 'Firma ABC', model: 'DƒÖb Classic', quantity: 5, startDate: '2025-10-01', endDate: '2025-10-15', processId: 'proc1'},
        {id: 'order_test_2', name: 'Drzwi wewnƒôtrzne sosna', client: 'Dom prywatny', model: 'Sosna Light', quantity: 3, startDate: '2025-09-20', endDate: '2025-10-05', processId: 'proc2'},
        {id: 'order_test_3', name: 'Drzwi balkonowe', client: 'Blok mieszkalny', model: 'Balkon Plus', quantity: 8, startDate: '2025-10-01', endDate: '2025-10-20', processId: 'proc1'}
      ];
    }

    // Add test processes if none exist
    if((state.processes || []).length === 0){
      state.processes = [
        {id: 'proc1', name: 'Proces standardowy', operations: [
          {name: 'Frezowanie na CNC', assignee: null},
          {name: 'Malowanie', assignee: null},
          {name: 'Okuwanie', assignee: null}
        ]},
        {id: 'proc2', name: 'Proces uproszczony', operations: [
          {name: 'Szlifowanie', assignee: null},
          {name: 'Przygotowanie powierzchni do malowania z dodatkowymi zabiegami', assignee: null}
        ]}
      ];
    }

    // Add test tasks (always add, don't overwrite)
    const testTasks = [
      {id: 'task_test_1', orderId: 'order_test_1', opName: 'Frezowanie na CNC (test)', status: 'run', elapsedMin: 30, estMin: 60, assignees: []},
      {id: 'task_test_2', orderId: 'order_test_1', opName: 'Malowanie (test)', status: 'todo', elapsedMin: 0, estMin: 45, assignees: []},
      {id: 'task_test_3', orderId: 'order_test_2', opName: 'Szlifowanie (test)', status: 'done', elapsedMin: 25, estMin: 25, assignees: []},
      {id: 'task_test_4', orderId: 'order_test_2', opName: 'Okuwanie (test)', status: 'run', elapsedMin: 15, estMin: 30, assignees: []},
      {id: 'task_test_5', orderId: 'order_test_3', opName: 'Przygotowanie powierzchni do malowania z dodatkowymi zabiegami', status: 'todo', elapsedMin: 0, estMin: 90, assignees: []}
    ];

    // Add test tasks only if they don't already exist
    testTasks.forEach(testTask => {
      if(!(state.tasks || []).some(t => t.id === testTask.id)){
        state.tasks = state.tasks || [];
        state.tasks.push(testTask);
      }
    });

    save();
    renderGantt();
    console.log('Dodano dane testowe dla harmonogramu! Oryginalne dane zosta≈Çy zachowane.');
  }

  // Function to auto-assign employees to existing tasks based on processes
  function autoAssignEmployeesToTasks(){
    console.log('Auto-assigning employees to existing tasks...');
    let updatedCount = 0;

    (state.tasks || []).forEach(task => {
      // Skip if task already has assignees
      if(task.assignees && task.assignees.length > 0) return;

      // Find the order and its process
      const order = (state.orders || []).find(o => o.id === task.orderId);
      if(!order || !order.processId) return;

      const process = (state.processes || []).find(p => p.id === order.processId);
      if(!process) return;

      // Find the operation in the process
      const operation = (process.operations || []).find(op => op.name === task.opName);
      if(!operation) return;

      // Assign employee from operation
      let assignees = [];
      if(operation.assignee){
        assignees = [operation.assignee];
      } else {
        // Try to find default assignees from catalog
        const catalogOp = (state.operationsCatalog || []).find(co => co.name === operation.name);
        if(catalogOp && catalogOp.defaultAssignees && catalogOp.defaultAssignees.length > 0){
          assignees = catalogOp.defaultAssignees;
        }
      }

      if(assignees.length > 0){
        // Sprawd≈∫ konflikty przed automatycznym przypisaniem
        let assigned = false;
        
        if(window.resourceConflictDetector) {
          // Pr√≥buj przypisaƒá pierwszego pracownika z listy
          for(let i = 0; i < assignees.length; i++) {
            const employeeId = assignees[i].id || assignees[i];
            const conflicts = window.resourceConflictDetector.detectConflicts(task, employeeId, state.tasks);
            
            if(conflicts.length === 0) {
              // Brak konflikt√≥w - przypisz
              task.assignees = [employeeId];
              updatedCount++;
              assigned = true;
              console.log(`‚úÖ Auto-assigned ${assignees[i].name || employeeId} to task ${task.opName} (no conflicts)`);
              break;
            } else {
              console.log(`‚ö†Ô∏è Skipping ${assignees[i].name || employeeId} for ${task.opName} due to conflicts:`, conflicts.length);
            }
          }
          
          // Je≈õli wszystkie majƒÖ konflikty, przypisz z ostrze≈ºeniem
          if(!assigned) {
            const employeeId = assignees[0].id || assignees[0];
            task.assignees = [employeeId];
            task._hasConflicts = true;
            updatedCount++;
            console.warn(`‚ö†Ô∏è Auto-assigned ${assignees[0].name || employeeId} to task ${task.opName} WITH CONFLICTS`);
          }
        } else {
          // Brak detektora - przypisz bez walidacji
          task.assignees = assignees;
          updatedCount++;
          console.log(`Assigned ${assignees.map(a => a.name || a.id).join(', ')} to task ${task.opName}`);
        }
      }
    });

    if(updatedCount > 0){
      save();
      console.log(`Auto-assigned employees to ${updatedCount} tasks`);
      
      // Poka≈º ostrze≈ºenia o konfliktach je≈õli wykryto
      if(window.resourceConflictDetector) {
        setTimeout(() => {
          const conflictedTasks = (state.tasks || []).filter(t => t._hasConflicts);
          if(conflictedTasks.length > 0) {
            console.warn(`‚ö†Ô∏è ${conflictedTasks.length} zada≈Ñ ma konflikty przypisa≈Ñ`);
            // Opcjonalnie: poka≈º raport konflikt√≥w
            const report = window.resourceConflictDetector.getConflictReport();
            if(report.totalConflicts > 0) {
              console.warn('Raport konflikt√≥w:', report);
            }
          }
        }, 500);
      }
    } else {
      console.log('No tasks needed auto-assignment');
    }

    renderGantt();
  }

  function renderCapacityAnalysis(){
    const period = qs('#capacity-period').value || 'week';

    // Calculate resource utilization
    const resourceUtilization = calculateResourceUtilization(period);
    renderResourceUtilization(resourceUtilization);

    // Calculate bottlenecks
    const bottlenecks = calculateBottlenecks();
    renderBottlenecks(bottlenecks);

    // Calculate efficiency metrics
    const efficiency = calculateEfficiencyMetrics(period);
    renderEfficiencyMetrics(efficiency);

    // Calculate optimization suggestions
    const optimization = calculateOptimizationSuggestions();
    renderOptimizationSuggestions(optimization);
    
    // Poka≈º raport konflikt√≥w zasob√≥w
    if(window.resourceConflictDetector && window.resourceConflictDetector.showConflictReport) {
      try {
        window.resourceConflictDetector.showConflictReport('conflict-report');
        console.log('üìä Raport konflikt√≥w zasob√≥w wygenerowany');
      } catch(err) {
        console.error('B≈ÇƒÖd generowania raportu konflikt√≥w:', err);
      }
    }
  }

  function calculateResourceUtilization(period){
    const employees = state.employees || [];
    const tasks = state.tasks || [];
    const utilization = [];

    employees.forEach(emp => {
      const empTasks = tasks.filter(t => t.assignees && t.assignees.some(a => a.id === emp.id));
      const totalTime = empTasks.reduce((sum, t) => sum + (t.estMin || 0), 0);
      const availableTime = period === 'day' ? emp.hoursPerDay * 60 : period === 'week' ? emp.hoursPerDay * 60 * 7 : emp.hoursPerDay * 60 * 30;
      const utilizationPercent = availableTime > 0 ? Math.round((totalTime / availableTime) * 100) : 0;

      utilization.push({
        employee: emp.name,
        totalTasks: empTasks.length,
        totalTime: totalTime,
        availableTime: availableTime,
        utilization: utilizationPercent,
        status: utilizationPercent > 100 ? 'overloaded' : utilizationPercent > 80 ? 'high' : utilizationPercent > 50 ? 'normal' : 'low'
      });
    });

    return utilization;
  }

  function renderResourceUtilization(utilization){
    const container = qs('#capacity-resources');
    container.innerHTML = '';

    if(utilization.length === 0){
      container.innerHTML = '<div class="empty">Brak danych do analizy</div>';
      return;
    }

    utilization.forEach(item => {
      const div = document.createElement('div');
      div.className = 'capacity-item';
      div.innerHTML = `
        <div class="capacity-employee">${item.employee}</div>
        <div class="capacity-metrics">
          <div>Zada≈Ñ: ${item.totalTasks}</div>
          <div>Czas: ${Math.round(item.totalTime / 60 * 10) / 10}h / ${Math.round(item.availableTime / 60 * 10) / 10}h</div>
          <div class="capacity-bar">
            <div class="capacity-fill ${item.status}" style="width: ${Math.min(item.utilization, 100)}%"></div>
            <span>${item.utilization}%</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function calculateOptimizationSuggestions(){
    const employees = state.employees || [];
    const tasks = state.tasks || [];
    const suggestions = [];

    // Calculate current workload for each employee
    const workloads = employees.map(emp => {
      const empTasks = tasks.filter(t => t.assignees && t.assignees.some(a => a.id === emp.id));
      const totalTime = empTasks.reduce((sum, t) => sum + (t.estMin || 0), 0);
      const availableTime = emp.hoursPerDay * 60 * 7; // Weekly available time
      const utilization = availableTime > 0 ? (totalTime / availableTime) * 100 : 0;

      return {
        employee: emp,
        tasks: empTasks,
        totalTime,
        availableTime,
        utilization,
        status: utilization > 100 ? 'overloaded' : utilization > 80 ? 'high' : utilization > 50 ? 'normal' : 'low'
      };
    });

    // Find overloaded employees
    const overloaded = workloads.filter(w => w.status === 'overloaded');
    if(overloaded.length > 0){
      suggestions.push({
        type: 'overload',
        priority: 'high',
        title: 'Prze≈Çadowani pracownicy',
        description: `${overloaded.map(w => w.employee.name).join(', ')} majƒÖ obciƒÖ≈ºenie >100%. Rozwa≈º prze≈Ço≈ºenie zada≈Ñ.`,
        actions: overloaded.map(w => ({
          employee: w.employee.name,
          tasksToMove: w.tasks.filter(t => t.status === 'todo').slice(0, 2)
        }))
      });
    }

    // Find underutilized employees
    const underutilized = workloads.filter(w => w.status === 'low');
    if(underutilized.length > 0){
      suggestions.push({
        type: 'underload',
        priority: 'medium',
        title: 'Niedowykorzystani pracownicy',
        description: `${underutilized.map(w => w.employee.name).join(', ')} majƒÖ obciƒÖ≈ºenie <50%. Mo≈ºna im przypisaƒá wiƒôcej zada≈Ñ.`,
        actions: underutilized.map(w => ({
          employee: w.employee.name,
          availableCapacity: Math.round(w.availableTime - w.totalTime)
        }))
      });
    }

    // Find skill mismatches
    const skillMismatches = [];
    tasks.forEach(task => {
      if(task.assignees && task.assignees.length > 0){
        const operation = (state.operationsCatalog || []).find(op => op.name === task.opName);
        if(operation && operation.skills && operation.skills.length > 0){
          task.assignees.forEach(assignee => {
            // For now, assume all employees can do all tasks
            // In a real system, we'd check employee skills
          });
        }
      }
    });

    // Suggest task redistribution
    const highWorkload = workloads.filter(w => w.utilization > 80);
    const lowWorkload = workloads.filter(w => w.utilization < 60);

    if(highWorkload.length > 0 && lowWorkload.length > 0){
      suggestions.push({
        type: 'redistribution',
        priority: 'medium',
        title: 'Przeniesienie zada≈Ñ',
        description: `Rozwa≈º przeniesienie zada≈Ñ z ${highWorkload.map(w => w.employee.name).join(', ')} do ${lowWorkload.map(w => w.employee.name).join(', ')}`,
        actions: []
      });
    }

    // Suggest parallel processing for bottlenecks
    const bottlenecks = calculateBottlenecks();
    if(bottlenecks.length > 0){
      suggestions.push({
        type: 'parallel',
        priority: 'high',
        title: 'Przetwarzanie r√≥wnoleg≈Çe',
        description: `Operacje ${bottlenecks.map(b => b.operation).join(', ')} sƒÖ wƒÖskimi gard≈Çami. Rozwa≈º zatrudnienie dodatkowych pracownik√≥w.`,
        actions: bottlenecks.map(b => ({
          operation: b.operation,
          currentWorkers: b.countRun + b.countTodo,
          suggestedWorkers: Math.min(b.countRun + b.countTodo + 1, 3)
        }))
      });
    }

    return suggestions;
  }

  function renderOptimizationSuggestions(suggestions){
    const container = qs('#capacity-optimization');
    container.innerHTML = '';

    if(suggestions.length === 0){
      container.innerHTML = '<div class="empty">Brak sugestii optymalizacji - obciƒÖ≈ºenie jest zr√≥wnowa≈ºone! üéâ</div>';
      return;
    }

    suggestions.forEach(suggestion => {
      const div = document.createElement('div');
      div.className = `card ${suggestion.priority === 'high' ? 'err' : suggestion.priority === 'medium' ? 'warn' : ''}`;
      div.style.marginBottom = '8px';

      let actionsHtml = '';
      if(suggestion.actions && suggestion.actions.length > 0){
        actionsHtml = '<div style="margin-top: 8px;"><strong>Sugerowane dzia≈Çania:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
        suggestion.actions.forEach(action => {
          if(action.tasksToMove){
            actionsHtml += `<li>Przenie≈õ zadania: ${action.tasksToMove.map(t => t.opName).join(', ')} od ${action.employee}</li>`;
          } else if(action.availableCapacity){
            actionsHtml += `<li>${action.employee} ma dostƒôpnƒÖ pojemno≈õƒá: ${Math.round(action.availableCapacity/60)}h</li>`;
          } else if(action.suggestedWorkers){
            actionsHtml += `<li>${action.operation}: zwiƒôksz liczbƒô pracownik√≥w do ${action.suggestedWorkers}</li>`;
          }
        });
        actionsHtml += '</ul></div>';
      }

      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <strong>${suggestion.title}</strong>
            <div style="margin-top: 4px; color: #94a3b8;">${suggestion.description}</div>
            ${actionsHtml}
          </div>
          <div style="font-size: 12px; color: ${suggestion.priority === 'high' ? '#ef4444' : suggestion.priority === 'medium' ? '#f59e0b' : '#10b981'}; font-weight: bold;">
            ${suggestion.priority === 'high' ? 'WYSOKI' : suggestion.priority === 'medium' ? '≈öREDNI' : 'NISKI'}
          </div>
        </div>
      `;

      container.appendChild(div);
    });
  }

  function calculateBottlenecks(){
    const bottlenecks = [];
    const operations = state.operations || [];
    const tasks = state.tasks || [];

    operations.forEach(op => {
      const opTasks = tasks.filter(t => t.opName === op.name);
      const totalTime = opTasks.reduce((sum, t) => sum + (t.estMin || 0), 0);
      const workerCount = op.workers || 1;
      const availableTime = workerCount * 8 * 60; // 8 hours per worker per day

      if(totalTime > availableTime * 1.2){ // 20% over capacity
        bottlenecks.push({
          operation: op.name,
          totalTime: totalTime,
          availableTime: availableTime,
          overload: Math.round((totalTime / availableTime - 1) * 100)
        });
      }
    });

    return bottlenecks.sort((a, b) => b.overload - a.overload);
  }

  function renderBottlenecks(bottlenecks){
    const container = qs('#capacity-bottlenecks');
    container.innerHTML = '';

    if(bottlenecks.length === 0){
      container.innerHTML = '<div class="empty">Brak wƒÖskich garde≈Ç</div>';
      return;
    }

    bottlenecks.forEach(item => {
      const div = document.createElement('div');
      div.className = 'bottleneck-item';
      div.innerHTML = `
        <div class="bottleneck-name">${item.operation}</div>
        <div class="bottleneck-metrics">
          <div>PrzeciƒÖ≈ºenie: ${item.overload}%</div>
          <div>Czas: ${Math.round(item.totalTime / 60 * 10) / 10}h / ${Math.round(item.availableTime / 60 * 10) / 10}h</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function calculateEfficiencyMetrics(period){
    const tasks = state.tasks || [];
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.status === 'done').length;
    const runningTasks = tasks.filter(t => t.status === 'run').length;
    const todoTasks = tasks.filter(t => t.status === 'todo').length;

    const totalEstimatedTime = tasks.reduce((sum, t) => sum + (t.estMin || 0), 0);
    const totalActualTime = tasks.reduce((sum, t) => sum + (t.elapsedMin || 0), 0);

    const efficiency = totalEstimatedTime > 0 ? Math.round((totalActualTime / totalEstimatedTime) * 100) : 0;

    return {
      totalTasks,
      completedTasks,
      runningTasks,
      todoTasks,
      totalEstimatedTime,
      totalActualTime,
      efficiency: efficiency > 0 ? efficiency : 0,
      completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
    };
  }

  function renderEfficiencyMetrics(efficiency){
    const container = qs('#capacity-efficiency');
    container.innerHTML = '';

    const metrics = [
      {label: 'Razem zada≈Ñ', value: efficiency.totalTasks},
      {label: 'Uko≈Ñczonych', value: `${efficiency.completedTasks} (${efficiency.completionRate}%)`},
      {label: 'W trakcie', value: efficiency.runningTasks},
      {label: 'Do wykonania', value: efficiency.todoTasks},
      {label: 'Szacowany czas', value: `${Math.round(efficiency.totalEstimatedTime / 60 * 10) / 10}h`},
      {label: 'Rzeczywisty czas', value: `${Math.round(efficiency.totalActualTime / 60 * 10) / 10}h`},
      {label: 'Efektywno≈õƒá', value: `${efficiency.efficiency}%`}
    ];

    metrics.forEach(metric => {
      const div = document.createElement('div');
      div.className = 'efficiency-metric';
      div.innerHTML = `
        <span class="metric-label">${metric.label}:</span>
        <span class="metric-value">${metric.value}</span>
      `;
      container.appendChild(div);
    });
  }

  function exportCapacityAnalysis(){
    const period = qs('#capacity-period').value || 'week';
    const utilization = calculateResourceUtilization(period);
    const bottlenecks = calculateBottlenecks();
    const efficiency = calculateEfficiencyMetrics(period);

    let csv = 'Analiza Przepustowo≈õci Produkcji\n';
    csv += `Okres: ${period === 'day' ? 'Dzie≈Ñ' : period === 'week' ? 'Tydzie≈Ñ' : 'MiesiƒÖc'}\n\n`;

    csv += 'Wykorzystanie Zasob√≥w\n';
    csv += 'Pracownik,Zada≈Ñ,Czas szacowany,Czas dostƒôpny,Wykorzystanie\n';
    utilization.forEach(item => {
      csv += `${item.employee},${item.totalTasks},${Math.round(item.totalTime / 60 * 10) / 10},${Math.round(item.availableTime / 60 * 10) / 10},${item.utilization}%\n`;
    });

    csv += '\nWƒÖskie Gard≈Ça\n';
    csv += 'Operacja,Czas ca≈Çkowity,Czas dostƒôpny,PrzeciƒÖ≈ºenie\n';
    bottlenecks.forEach(item => {
      csv += `${item.operation},${Math.round(item.totalTime / 60 * 10) / 10},${Math.round(item.availableTime / 60 * 10) / 10},${item.overload}%\n`;
    });

    csv += '\nEfektywno≈õƒá Produkcji\n';
    csv += `Razem zada≈Ñ,${efficiency.totalTasks}\n`;
    csv += `Uko≈Ñczonych,${efficiency.completedTasks} (${efficiency.completionRate}%)\n`;
    csv += `W trakcie,${efficiency.runningTasks}\n`;
    csv += `Do wykonania,${efficiency.todoTasks}\n`;
    csv += `Szacowany czas,${Math.round(efficiency.totalEstimatedTime / 60 * 10) / 10}h\n`;
    csv += `Rzeczywisty czas,${Math.round(efficiency.totalActualTime / 60 * 10) / 10}h\n`;
    csv += `Efektywno≈õƒá,${efficiency.efficiency}%\n`;

    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `analiza-przepustowosci-${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
  }

  // === BACKUP SYSTEM ===

  // Backup storage using localStorage with versioning
  const BACKUP_STORAGE_KEY = 'production_planner_backups';
  const MAX_BACKUPS_DEFAULT = 10;

  // Initialize backup system
  function initBackupSystem() {
    if (!localStorage.getItem(BACKUP_STORAGE_KEY)) {
      localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify([]));
    }
    renderBackupList();
    updateBackupStats();
  }

  // Create a new backup
  function createBackup(name = null) {
    try {
      const backupName = name || `Backup ${new Date().toLocaleString('pl-PL')}`;
      const backupData = {
        id: uid(),
        name: backupName,
        timestamp: Date.now(),
        version: '1.0',
        data: JSON.parse(JSON.stringify(state)), // Deep copy
        metadata: {
          employeesCount: (state.employees || []).length,
          operationsCount: (state.operationsCatalog || []).length,
          processesCount: (state.processes || []).length,
          ordersCount: (state.orders || []).length,
          tasksCount: (state.tasks || []).length,
          size: JSON.stringify(state).length
        }
      };

      // Compress if enabled
      if (qs('#backup-compress') && qs('#backup-compress').checked) {
        // Simple compression using LZString if available, otherwise just store as is
        try {
          if (window.LZString) {
            backupData.compressed = true;
            backupData.data = window.LZString.compressToUTF16(JSON.stringify(state));
          }
        } catch (e) {
          console.warn('Compression failed, storing uncompressed:', e);
        }
      }

      const backups = getBackups();
      backups.unshift(backupData); // Add to beginning

      // Apply cleanup policy
      const maxBackups = parseInt(qs('#backup-max-count').value) || MAX_BACKUPS_DEFAULT;
      if (backups.length > maxBackups) {
        backups.splice(maxBackups);
      }

      localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(backups));
      renderBackupList();
      updateBackupStats();

      console.log('Backup created:', backupName);
      return backupData.id;
    } catch (e) {
      console.error('Failed to create backup:', e);
      alert('B≈ÇƒÖd podczas tworzenia backupu: ' + e.message);
      return null;
    }
  }

  // Get all backups
  function getBackups() {
    try {
      return JSON.parse(localStorage.getItem(BACKUP_STORAGE_KEY) || '[]');
    } catch (e) {
      console.error('Failed to load backups:', e);
      return [];
    }
  }

  // Restore from backup
  window.restoreFromBackup = function restoreFromBackup(backupId) {
    try {
      // U≈ºyj BackupManager je≈õli dostƒôpny
      if (typeof window.BackupManager !== 'undefined') {
        const backups = window.BackupManager.list();
        const backup = backups.find(b => b.id === backupId);

        if (!backup) {
          alert('‚ùå Backup nie zosta≈Ç znaleziony!');
          return false;
        }

        const backupName = backup.reason || backup.name || backup.id;
        
        // Confirm restoration
        if (!confirm(`Czy na pewno chcesz przywr√≥ciƒá dane z backupu "${backupName}"?\n\nTo dzia≈Çanie nadpisze wszystkie bie≈ºƒÖce dane!\n\n(Obecny stan zostanie automatycznie zapisany jako backup przed przywr√≥ceniem)`)) {
          return false;
        }

        // BackupManager.restore() automatycznie tworzy backup przed przywr√≥ceniem
        const restored = window.BackupManager.restore(backupId);
        
        if (!restored) {
          alert('‚ùå B≈ÇƒÖd podczas przywracania backupu!');
          return false;
        }

        // Za≈Çaduj przywr√≥cone dane
        loadState();

        // Refresh all views
        renderEmployees();
        renderOps();
        renderProcPage();
        renderOrderPage();
        renderTasks();
        renderGantt();
        renderCapacityAnalysis();
        renderASPage();
        renderDash(window.state || state);

        console.log('‚úì Restored from backup:', backupName);
        alert(`‚úÖ Dane zosta≈Çy przywr√≥cone z backupu "${backupName}"!`);
        
        renderBackupList();
        updateBackupStats();
        
        return true;
      } else {
        // Fallback do starej metody
        const backups = getBackups();
        const backup = backups.find(b => b.id === backupId);

        if (!backup) {
          alert('Backup nie zosta≈Ç znaleziony!');
          return false;
        }

        // Confirm restoration
        if (!confirm(`Czy na pewno chcesz przywr√≥ciƒá dane z backupu "${backup.name}"?\n\nTo dzia≈Çanie nadpisze wszystkie bie≈ºƒÖce dane!`)) {
          return false;
        }

        let backupData = backup.data;

        // Decompress if needed
        if (backup.compressed && window.LZString) {
          try {
            backupData = JSON.parse(window.LZString.decompressFromUTF16(backupData));
          } catch (e) {
            console.error('Failed to decompress backup:', e);
            alert('B≈ÇƒÖd podczas dekompresji backupu!');
            return false;
          }
        }

        // Restore data
        Object.assign(state, backupData);
        save();

        // Refresh all views
        renderEmployees();
        renderOps();
        renderProcPage();
        renderOrderPage();
        renderTasks();
        renderGantt();
        renderCapacityAnalysis();
        renderASPage();
        renderDash(window.state || state);

        console.log('Restored from backup:', backup.name);
        alert(`‚úÖ Dane zosta≈Çy przywr√≥cone z backupu "${backup.name}"!`);

        return true;
      }
    } catch (e) {
      console.error('Failed to restore backup:', e);
      alert('B≈ÇƒÖd podczas przywracania backupu: ' + e.message);
      return false;
    }
  }

  // Delete backup
  window.deleteBackup = function deleteBackup(backupId) {
    try {
      // U≈ºyj BackupManager je≈õli dostƒôpny
      if (typeof window.BackupManager !== 'undefined') {
        const backups = window.BackupManager.list();
        const backup = backups.find(b => b.id === backupId);

        if (!backup) {
          alert('‚ùå Backup nie zosta≈Ç znaleziony!');
          return false;
        }

        const backupName = backup.reason || backup.name || backup.id;
        if (!confirm(`Czy na pewno chcesz usunƒÖƒá backup "${backupName}"?`)) {
          return false;
        }

        const deleted = window.BackupManager.delete(backupId);
        if (deleted) {
          renderBackupList();
          updateBackupStats();
          console.log('‚úì Backup deleted:', backupName);
          return true;
        } else {
          alert('‚ùå B≈ÇƒÖd podczas usuwania backupu!');
          return false;
        }
      } else {
        // Fallback do starej metody
        const backups = getBackups();
        const index = backups.findIndex(b => b.id === backupId);

        if (index === -1) {
          alert('Backup nie zosta≈Ç znaleziony!');
          return false;
        }

        const backup = backups[index];
        if (!confirm(`Czy na pewno chcesz usunƒÖƒá backup "${backup.name}"?`)) {
          return false;
        }

        backups.splice(index, 1);
        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(backups));
        renderBackupList();
        updateBackupStats();

        console.log('Backup deleted:', backup.name);
        return true;
      }
    } catch (e) {
      console.error('Failed to delete backup:', e);
      alert('B≈ÇƒÖd podczas usuwania backupu: ' + e.message);
      return false;
    }
  }

  // Export backup to file
  function exportBackup(backupId) {
    try {
      // U≈ºyj BackupManager je≈õli dostƒôpny
      if (typeof window.BackupManager !== 'undefined') {
        const exported = window.BackupManager.export(backupId);
        if (!exported) {
          alert('‚ùå Backup nie zosta≈Ç znaleziony!');
        }
        // BackupManager.export() automatycznie pobiera plik
        return;
      }

      // Fallback do starej metody
      const backups = getBackups();
      const backup = backups.find(b => b.id === backupId);

      if (!backup) {
        alert('Backup nie zosta≈Ç znaleziony!');
        return;
      }

      const exportData = {
        exportedAt: new Date().toISOString(),
        app: 'Production Planner',
        version: '1.0',
        backup: backup
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_${backup.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date(backup.timestamp).toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log('Backup exported:', backup.name);
    } catch (e) {
      console.error('Failed to export backup:', e);
      alert('B≈ÇƒÖd podczas eksportu backupu: ' + e.message);
    }
  }

  // Import backup from file
  function importBackupFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);

          // Validate backup format
          if (!data.backup || !data.backup.id || !data.backup.data) {
            throw new Error('Nieprawid≈Çowy format pliku backupu');
          }

          const backup = data.backup;
          const backups = getBackups();

          // Check if backup with same ID already exists
          if (backups.some(b => b.id === backup.id)) {
            if (!confirm('Backup o tym samym ID ju≈º istnieje. Czy chcesz go nadpisaƒá?')) {
              resolve(false);
              return;
            }
            // Remove existing backup
            const index = backups.findIndex(b => b.id === backup.id);
            backups.splice(index, 1);
          }

          // Add new backup
          backups.unshift(backup);
          localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(backups));
          renderBackupList();
          updateBackupStats();

          alert(`Backup "${backup.name}" zosta≈Ç zaimportowany!`);
          console.log('Backup imported:', backup.name);
          resolve(true);
        } catch (e) {
          console.error('Failed to import backup:', e);
          alert('B≈ÇƒÖd podczas importu backupu: ' + e.message);
          resolve(false);
        }
      };
      reader.onerror = () => reject(new Error('Failed to read file'));
      reader.readAsText(file);
    });
  }

  // Render backup list
  function renderBackupList() {
    const container = qs('#backup-list');
    if (!container) return;

    // U≈ºyj BackupManager je≈õli dostƒôpny
    const backups = typeof window.BackupManager !== 'undefined' 
      ? window.BackupManager.list() 
      : getBackups();

    if (backups.length === 0) {
      container.innerHTML = '<div class="muted">Brak dostƒôpnych backup√≥w. Utw√≥rz pierwszy backup.</div>';
      return;
    }

    const html = backups.map(backup => {
      const date = new Date(backup.timestamp).toLocaleString('pl-PL');
      
      // BackupManager u≈ºywa data.size, stary format u≈ºywa metadata.size
      const dataSize = backup.data?.size || 0;
      const metadataSize = backup.metadata?.size || 0;
      const size = dataSize || metadataSize;
      const sizeKB = size ? `${Math.round(size / 1024)} KB` : 'N/A';

      // Pobierz dane statystyczne
      const state = backup.data || {};
      const employeesCount = state.employees?.length || backup.metadata?.employeesCount || 0;
      const operationsCount = state.operations?.length || backup.metadata?.operationsCount || 0;
      const processesCount = state.processes?.length || backup.metadata?.processesCount || 0;
      const ordersCount = state.orders?.length || backup.metadata?.ordersCount || 0;
      const tasksCount = state.tasks?.length || backup.metadata?.tasksCount || 0;

      // Nazwa backupu - u≈ºyj reason z BackupManager lub name ze starego formatu
      const backupName = backup.reason || backup.name || backup.id;

      return `
        <div class="backup-item card" style="margin-bottom: 8px;">
          <div class="backup-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div>
              <strong>${backupName}</strong>
              <div class="muted" style="font-size: 12px;">${date}</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              ${sizeKB} ${backup.compressed ? 'üóúÔ∏è' : ''}
            </div>
          </div>

          <div class="backup-meta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px; font-size: 12px;">
            <div>üë• ${employeesCount}</div>
            <div>üîß ${operationsCount}</div>
            <div>üìã ${processesCount}</div>
            <div>üì¶ ${ordersCount}</div>
            <div>‚úÖ ${tasksCount}</div>
          </div>

          <div class="backup-actions" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn" onclick="restoreFromBackup('${backup.id}')" title="Przywr√≥ƒá dane z tego backupu">
              üîÑ Przywr√≥ƒá
            </button>
            <button class="btn" onclick="exportBackup('${backup.id}')" title="Eksportuj backup do pliku">
              üíæ Eksport
            </button>
            <button class="btn red" onclick="deleteBackup('${backup.id}')" title="Usu≈Ñ backup">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
  }

  // Update backup statistics
  function updateBackupStats() {
    // U≈ºyj BackupManager je≈õli dostƒôpny
    const backups = typeof window.BackupManager !== 'undefined' 
      ? window.BackupManager.list() 
      : getBackups();

    // Update counts
    qs('#backup-count').textContent = backups.length;

    // Update latest backup
    if (backups.length > 0) {
      const latest = new Date(backups[0].timestamp);
      qs('#backup-latest').textContent = latest.toLocaleString('pl-PL');
    } else {
      qs('#backup-latest').textContent = '-';
    }

    // Calculate total size - BackupManager u≈ºywa data.size
    const totalSize = backups.reduce((sum, b) => {
      const size = b.data?.size || b.metadata?.size || 0;
      return sum + size;
    }, 0);
    qs('#backup-size').textContent = `${Math.round(totalSize / 1024)} KB`;
  }

  // Auto-backup functionality
  // UWAGA: Stara funkcja setupAutoBackup() zosta≈Ça zastƒÖpiona przez BackupManager
  // BackupManager automatycznie tworzy backupy przed ka≈ºdym zapisem w store.js
  function setupAutoBackup() {
    // Zdezaktywowana - BackupManager zarzƒÖdza auto-backupami
    console.log('‚ÑπÔ∏è Auto-backup jest zarzƒÖdzany przez BackupManager w store.js');
  }

  // Save backup settings
  function saveBackupSettings() {
    const settings = {
      includeSettings: qs('#backup-include-settings').checked,
      includeLogs: qs('#backup-include-logs').checked,
      compress: qs('#backup-compress').checked,
      autoCleanup: qs('#backup-auto-cleanup').checked,
      maxCount: parseInt(qs('#backup-max-count').value) || MAX_BACKUPS_DEFAULT
    };

    localStorage.setItem('backup_settings', JSON.stringify(settings));
    console.log('Backup settings saved');
  }

  // Load backup settings
  function loadBackupSettings() {
    try {
      const settings = JSON.parse(localStorage.getItem('backup_settings') || '{}');

      if (qs('#backup-include-settings')) qs('#backup-include-settings').checked = settings.includeSettings !== false;
      if (qs('#backup-include-logs')) qs('#backup-include-logs').checked = settings.includeLogs !== false;
      if (qs('#backup-compress')) qs('#backup-compress').checked = settings.compress !== false;
      if (qs('#backup-auto-cleanup')) qs('#backup-auto-cleanup').checked = settings.autoCleanup === true;
      if (qs('#backup-max-count')) qs('#backup-max-count').value = settings.maxCount || MAX_BACKUPS_DEFAULT;
    } catch (e) {
      console.warn('Failed to load backup settings:', e);
    }
  }

  // Initialize backup system when page loads
  // Initialize Gantt controls event listeners
  function initGanttControls() {
    // Event listeners for Gantt controls
    const ganttRefreshBtn = qs('#gantt-refresh');
    if(ganttRefreshBtn){ ganttRefreshBtn.addEventListener('click', () => renderGantt()); }
    
    // Nawigacja datami
    const ganttPrevBtn = qs('#gantt-prev-period');
    if(ganttPrevBtn){
      ganttPrevBtn.addEventListener('click', () => {
        const viewMode = qs('#gantt-view').value || 'week';
        const daysToMove = viewMode === 'week' ? 7 : 30;
        state.ganttDateOffset = (state.ganttDateOffset || 0) - daysToMove;
        renderGantt();
      });
    }
    
    const ganttTodayBtn = qs('#gantt-today');
    if(ganttTodayBtn){
      ganttTodayBtn.addEventListener('click', () => {
        state.ganttDateOffset = 0;
        renderGantt();
      });
    }
    
    const ganttNextBtn = qs('#gantt-next-period');
    if(ganttNextBtn){
      ganttNextBtn.addEventListener('click', () => {
        const viewMode = qs('#gantt-view').value || 'week';
        const daysToMove = viewMode === 'week' ? 7 : 30;
        state.ganttDateOffset = (state.ganttDateOffset || 0) + daysToMove;
        renderGantt();
      });
    }
    
    // Przyciski do przesuwania zaznaczonego zadania
    const ganttMoveBackBtn = qs('#gantt-move-task-back');
    if(ganttMoveBackBtn){
      ganttMoveBackBtn.addEventListener('click', () => {
        moveSelectedTask(-1);
      });
    }
    
    const ganttMoveForwardBtn = qs('#gantt-move-task-forward');
    if(ganttMoveForwardBtn){
      ganttMoveForwardBtn.addEventListener('click', () => {
        moveSelectedTask(1);
      });
    }
    
    const ganttClearSelectionBtn = qs('#gantt-clear-selection');
    if(ganttClearSelectionBtn){
      ganttClearSelectionBtn.addEventListener('click', () => {
        clearGanttTaskSelection();
      });
    }
    
    const ganttReplanAll = qs('#gantt-replan-all');
    if(ganttReplanAll){
      ganttReplanAll.addEventListener('click', ()=>{
        console.log('[replan] window.scheduleCore exists:', !!window.scheduleCore);
        if(!window.scheduleCore) return;
        if(typeof updateScheduleConfigFromUI==='function') updateScheduleConfigFromUI();
        if(!confirm('Przeliczyƒá wszystkie zadania od nowa? Spowoduje to reset ich start/end.')) return;
        (window.logDev||console.log)('[replan] starting global replan');
        try{
          window.scheduleCore.generateSchedule(state,{force:true});
          save(); renderGantt(); renderOrderPage();
          (window.logDev||console.log)('[replan] global completed');
        }catch(e){ console.error('[replan] error', e); }
      });
    }

    const ganttAutoAssignBtn = qs('#gantt-auto-assign');
    if(ganttAutoAssignBtn){ ganttAutoAssignBtn.addEventListener('click', () => autoAssignEmployeesToTasks()); }

    const ganttGenerateBtn = qs('#gantt-generate-test');
    if(ganttGenerateBtn){ ganttGenerateBtn.addEventListener('click', () => generateGanttTestData()); }

    const ganttViewSelect = qs('#gantt-view');
    if(ganttViewSelect){ ganttViewSelect.addEventListener('change', () => renderGantt()); }

    const ganttShowDependenciesBtn = qs('#gantt-show-dependencies');
    if(ganttShowDependenciesBtn){ ganttShowDependenciesBtn.addEventListener('click', () => toggleDependencies()); }

    const ganttCreateDependencyBtn = qs('#gantt-create-dependency');
    if(ganttCreateDependencyBtn){ ganttCreateDependencyBtn.addEventListener('click', () => toggleDependencyCreation()); }

    const ganttManageDependenciesBtn = qs('#gantt-manage-dependencies');
    if(ganttManageDependenciesBtn){ ganttManageDependenciesBtn.addEventListener('click', () => showDependencyManager()); }

    const ganttShowCriticalPathBtn = qs('#gantt-show-critical-path');
    if(ganttShowCriticalPathBtn){ ganttShowCriticalPathBtn.addEventListener('click', () => toggleCriticalPath()); }

    // Capacity Analysis event handlers
    const capacityRefreshBtn = qs('#capacity-refresh');
    if(capacityRefreshBtn){ capacityRefreshBtn.addEventListener('click', () => renderCapacityAnalysis()); }

    const capacityPeriodSelect = qs('#capacity-period');
    if(capacityPeriodSelect){ capacityPeriodSelect.addEventListener('change', () => renderCapacityAnalysis()); }

    const capacityExportBtn = qs('#capacity-export');
    if(capacityExportBtn){ capacityExportBtn.addEventListener('click', () => exportCapacityAnalysis()); }

    // Obs≈Çuga formularza dodawania pracownika
    qs('#emp-add').addEventListener('click',()=>{
      const formContainer = qs('#emp-form-container');
      if (formContainer) {
        formContainer.classList.remove('hidden');
        // Wyczy≈õƒá formularz
        qs('#emp-form-name').value = '';
        qs('#emp-form-role').value = '';
        qs('#emp-form-cap').value = '100';
        qs('#emp-form-hours').value = '8';
        qs('#emp-form-phone').value = '';
      }
    });

    // Obs≈Çuga zapisywania formularza pracownika
    const empFormSave = qs('#emp-form-save');
    if (empFormSave) {
      empFormSave.addEventListener('click', () => {
        const id = qs('#emp-form-id').value.trim();
        const name = qs('#emp-form-name').value.trim();
        const role = qs('#emp-form-role').value;
        const cap = parseInt(qs('#emp-form-cap').value) || 100;
        const hours = parseInt(qs('#emp-form-hours').value) || 8;
        const phone = qs('#emp-form-phone').value.trim();

        if (!name || name.length < 2) {
          alert('Imiƒô i nazwisko musi mieƒá co najmniej 2 znaki');
          return;
        }

        if(id){
          // Edycja istniejƒÖcego pracownika
          const existing = state.employees.find(e => e.id === id);
          if(existing){
            existing.name = name;
            existing.role = role || 'Inne';
            existing.phone = phone;
            existing.cap = cap;
            existing.hoursPerDay = hours;
          }
        } else {
          // Dodanie nowego pracownika
          state.employees.push({
            id: uid(),
            name: name,
            role: role || 'Inne',
            phone: phone,
            cap: cap,
            hoursPerDay: hours
          });
        }
        
        save();
        renderEmployees();
        maybeAutoSave('employee-save');
        
        // Wyczy≈õƒá i ukryj formularz
        qs('#emp-form-id').value = '';
        qs('#emp-form-name').value = '';
        qs('#emp-form-role').value = '';
        qs('#emp-form-cap').value = 100;
        qs('#emp-form-hours').value = 8;
        qs('#emp-form-phone').value = '';
        const formTitle = qs('#emp-form-container [style*="font-weight:600"]');
        if(formTitle) formTitle.textContent = '‚ûï Nowy pracownik';
        qs('#emp-form-container').classList.add('hidden');
      });
    }

    // Obs≈Çuga anulowania formularza pracownika
    const empFormCancel = qs('#emp-form-cancel');
    if (empFormCancel) {
      empFormCancel.addEventListener('click', () => {
        // Wyczy≈õƒá formularz
        qs('#emp-form-id').value = '';
        qs('#emp-form-name').value = '';
        qs('#emp-form-role').value = '';
        qs('#emp-form-cap').value = 100;
        qs('#emp-form-hours').value = 8;
        qs('#emp-form-phone').value = '';
        const formTitle = qs('#emp-form-container [style*="font-weight:600"]');
        if(formTitle) formTitle.textContent = '‚ûï Nowy pracownik';
        qs('#emp-form-container').classList.add('hidden');
      });
    }

    // Obs≈Çuga przycisku "ZarzƒÖdzaj PIN"
    const empManagePinBtn = qs('#emp-manage-pin');
    if (empManagePinBtn) {
      empManagePinBtn.addEventListener('click', () => {
        openPINManagementModal();
      });
    }
    
    // === OBS≈ÅUGA ZADA≈É MONTA≈ªOWYCH ===
    
    // Pokazanie formularza nowego zadania monta≈ºowego
    const asAddTaskBtn = qs('#as-add-task');
    if(asAddTaskBtn){
      asAddTaskBtn.addEventListener('click', ()=>{
        const formContainer = qs('#as-task-form-container');
        if(!formContainer) return;
        
        // Wyczy≈õƒá ID edycji
        delete formContainer.dataset.editId;
        
        // Wygeneruj automatyczny numer zadania
        const assemblyTasks = (state.tasks||[]).filter(t => t.isAssemblyTask);
        const nextNumber = assemblyTasks.length + 1;
        const taskNumber = 'ZM-' + String(nextNumber).padStart(4, '0');
        qs('#as-task-number').value = taskNumber;
        
        // Pobierz dane z g≈Ç√≥wnego formularza monta≈ºu
        const mainOrderId = qs('#as-order')?.value || '';
        const orderObj = mainOrderId ? (state.orders||[]).find(o=>o.id===mainOrderId) : null;
        const mainClient = orderObj?.client || '';
        const mainAddress = qs('#as-address')?.value || '';
        const mainPostal = qs('#as-placecode')?.value || '';
        const mainPhone = qs('#as-phone')?.value || '';
        const mainDate = qs('#as-install')?.value || '';
        const mainDepart = qs('#as-go')?.value || '';
        const mainVisit = qs('#as-visit')?.value || '';
        const mainHours = qs('#as-hours')?.value || '2';
        const mainDesc = qs('#as-desc')?.value || '';
        const mainEmployees = Array.from(qs('#as-employees')?.selectedOptions || []).map(opt => opt.value);
        
        // Wype≈Çnij listƒô zlece≈Ñ
        const orderSelect = qs('#as-task-order');
        if(orderSelect){
          orderSelect.innerHTML = '<option value="">‚Äî Brak powiƒÖzania ‚Äî</option>';
          (state.orders||[]).forEach(o=>{
            const opt = document.createElement('option');
            opt.value = o.id;
            opt.textContent = o.name;
            orderSelect.appendChild(opt);
          });
          // Zawsze ustaw na "Brak powiƒÖzania" jako domy≈õlne
          orderSelect.value = '';
        }
        
        // Wype≈Çnij listƒô pracownik√≥w
        const empSelect = qs('#as-task-employees');
        if(empSelect){
          empSelect.innerHTML = '';
          (state.employees||[]).forEach(e=>{
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.name;
            empSelect.appendChild(opt);
          });
          // Ustaw pracownik√≥w z g≈Ç√≥wnego formularza
          mainEmployees.forEach(empId => {
            const option = empSelect.querySelector(`option[value="${empId}"]`);
            if(option) option.selected = true;
          });
        }
        
        // Przepisz dane z g≈Ç√≥wnego formularza
        qs('#as-task-name').value = '';
        qs('#as-task-client').value = mainClient;
        qs('#as-task-address').value = mainAddress;
        qs('#as-task-postal').value = mainPostal;
        qs('#as-task-phone').value = mainPhone;
        qs('#as-task-notes').value = mainDesc;
        qs('#as-task-hours').value = mainHours || 2;
        qs('#as-task-priority').value = 'normal';
        qs('#as-task-depart').value = mainDepart;
        qs('#as-task-visit').value = mainVisit;
        
        // Ustaw datƒô z g≈Ç√≥wnego formularza lub dzi≈õ
        const dateInput = qs('#as-task-date');
        dateInput.value = mainDate || new Date().toISOString().split('T')[0];
        
        // Utw√≥rz backdrop je≈õli nie istnieje
        let backdrop = qs('#as-task-backdrop');
        if(!backdrop) {
          backdrop = document.createElement('div');
          backdrop.id = 'as-task-backdrop';
          backdrop.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9998;display:none';
          document.body.appendChild(backdrop);
          backdrop.addEventListener('click', () => {
            formContainer.classList.add('hidden');
            backdrop.style.display = 'none';
          });
        }
        
        formContainer.classList.remove('hidden');
        backdrop.style.display = 'block';
        qs('#as-task-name')?.focus();
        
        // Obs≈Çuga ESC
        const handleEsc = (e) => {
          if(e.key === 'Escape') {
            formContainer.classList.add('hidden');
            backdrop.style.display = 'none';
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }
    
    // Zapisanie zadania monta≈ºowego
    const asTaskSaveBtn = qs('#as-task-save');
    if(asTaskSaveBtn){
      asTaskSaveBtn.addEventListener('click', ()=>{
        const formContainer = qs('#as-task-form-container');
        const editId = formContainer?.dataset.editId;
        
        const type = qs('#as-task-type').value;
        const name = qs('#as-task-name').value.trim();
        const orderId = qs('#as-task-order').value;
        const date = qs('#as-task-date').value;
        const departTime = qs('#as-task-depart').value;
        const visitTime = qs('#as-task-visit').value;
        const clientName = qs('#as-task-client').value.trim();
        const address = qs('#as-task-address').value.trim();
        const postal = qs('#as-task-postal').value.trim();
        const phone = qs('#as-task-phone').value.trim();
        const hours = parseFloat(qs('#as-task-hours').value) || 2;
        const priority = qs('#as-task-priority').value;
        const notes = qs('#as-task-notes').value.trim();
        
        // Pobierz wybranych pracownik√≥w
        const empSelect = qs('#as-task-employees');
        const selectedEmps = Array.from(empSelect.selectedOptions).map(opt => opt.value);
        const orderObj = orderId ? (state.orders||[]).find(o=>o.id===orderId) : null;
        let startPlanned = null;
        let endPlanned = null;
        if(date){
          const startDate = new Date(date);
          if(departTime){
            const [h, m] = departTime.split(':').map(Number);
            if(!isNaN(h)) startDate.setHours(h, !isNaN(m)?m:0, 0, 0); else startDate.setHours(8,0,0,0);
          }else{
            startDate.setHours(8,0,0,0);
          }
          startPlanned = startDate.getTime();
          endPlanned = startPlanned + (hours * 60 * 60 * 1000);
        }
        
        if(!date){
          alert('Wype≈Çnij wymagane pole: Data realizacji');
          return;
        }
        
        const taskNumber = qs('#as-task-number').value || '';
        
        if(editId){
          // Edycja istniejƒÖcego zadania
          const task = state.tasks.find(t => t.id === editId);
          if(task){
            const icon = type === 'pomiar' ? 'üìè' : type === 'monta≈º' ? 'üîß' : type === 'naprawa' ? 'üî®' : type === 'regulacja' ? '‚öôÔ∏è' : type === 'dostawa' ? 'üöö' : type === 'pr√≥bka-koloru' ? 'üé®' : 'üìã';
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            task.name = name ? `${icon} ${typeLabel} - ${name}` : `${icon} ${typeLabel}`;
            task.opName = name;
            task.type = type;
            task.orderId = orderId || null;
            task.assignees = selectedEmps;
            task.employeeId = selectedEmps[0] || null;
            task.estMin = hours * 60;
            task.priority = priority;
            task.installDate = date;
            task.departTime = departTime;
            task.visitTime = visitTime;
            task.address = address;
            task.postalCode = postal;
            task.phone = phone;
            task.notes = notes;
            task.startPlanned = startPlanned;
            task.endPlanned = endPlanned;
            task.operationId = task.operationId || 'monta≈º-block';
            task.orderNumber = orderObj?.name || orderId || 'Monta≈º';
            task.model = orderObj?.model || '-';
            task.client = clientName || orderObj?.client || '-';
            task.deadline = orderObj?.deadline || date;
            task.assemblyType = type;
            task.assemblyStatus = task.status || 'todo';
            task.assemblyDesc = notes;
            task.hours = hours;
            task.employeeIds = selectedEmps;
            task.assemblyId = task.assemblyId || task.id;
            // Numer pozostaje bez zmian przy edycji
          }
          delete formContainer.dataset.editId;
        } else {
          // Utw√≥rz nowe zadanie
          const icon = type === 'pomiar' ? 'üìè' : type === 'monta≈º' ? 'üîß' : type === 'naprawa' ? 'üî®' : type === 'regulacja' ? '‚öôÔ∏è' : type === 'dostawa' ? 'üöö' : type === 'pr√≥bka-koloru' ? 'üé®' : 'üìã';
          const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
          const task = {
            id: uid('task'),
            taskNumber: taskNumber,
            name: name ? `${icon} ${typeLabel} - ${name}` : `${icon} ${typeLabel}`,
            opName: name,
            type: type,
            orderId: orderId || null,
            status: 'todo',
            assignees: selectedEmps,
            employeeId: selectedEmps[0] || null,
            estMin: hours * 60,
            elapsedMin: 0,
            priority: priority,
            installDate: date,
            departTime: departTime,
            visitTime: visitTime,
            client: clientName || orderObj?.client || '-',
            address: address,
            postalCode: postal,
            phone: phone,
            notes: notes,
            startPlanned: startPlanned,
            endPlanned: endPlanned,
            isAssemblyTask: true,
            createdAt: Date.now(),
            operationId: 'monta≈º-block',
            orderNumber: orderObj?.name || orderId || 'Monta≈º',
            model: orderObj?.model || '-',
            deadline: orderObj?.deadline || date,
            assemblyType: type,
            assemblyStatus: 'todo',
            assemblyDesc: notes,
            hours: hours,
            employeeIds: selectedEmps,
            assemblyId: null
          };
          task.assemblyId = task.id;
          state.tasks = state.tasks || [];
          state.tasks.push(task);
        }
        
        save();
        
        // Przepisz klienta z nowego zadania do g≈Ç√≥wnego formularza monta≈ºu
        if(clientName) {
          qs('#as-client').value = clientName;
        }
        
        // Ukryj formularz i backdrop
        formContainer.classList.add('hidden');
        const backdrop = qs('#as-task-backdrop');
        if(backdrop) backdrop.style.display = 'none';
        
        // Wyczy≈õƒá formularz
        qs('#as-task-name').value = '';
        qs('#as-task-client').value = '';
        qs('#as-task-address').value = '';
        qs('#as-task-postal').value = '';
        qs('#as-task-phone').value = '';
        qs('#as-task-notes').value = '';
        
        // Od≈õwie≈º widoki
        renderASPage();
        if(typeof renderTasks === 'function') renderTasks();
        if(typeof renderGantt === 'function') renderGantt();
      });
    }
    
    // Anulowanie formularza zadania monta≈ºowego
    const asTaskCancelBtn = qs('#as-task-cancel');
    if(asTaskCancelBtn){
      asTaskCancelBtn.addEventListener('click', ()=>{
        qs('#as-task-form-container').classList.add('hidden');
        const backdrop = qs('#as-task-backdrop');
        if(backdrop) backdrop.style.display = 'none';
        // Wyczy≈õƒá formularz
        qs('#as-task-name').value = '';
        qs('#as-task-client').value = '';
        qs('#as-task-address').value = '';
        qs('#as-task-postal').value = '';
        qs('#as-task-phone').value = '';
        qs('#as-task-notes').value = '';
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    initBackupSystem();
    loadBackupSettings();
    setupAutoBackup();

    // Initialize Gantt controls event listeners
    initGanttControls();
  });

  // Event listeners for backup UI
  qs('#backup-create').addEventListener('click', () => {
    const name = prompt('Nazwa backupu (opcjonalnie):');
    if (name === null) return; // Cancelled

    // U≈ºyj BackupManager je≈õli dostƒôpny, w przeciwnym razie fallback
    if (typeof window.BackupManager !== 'undefined') {
      const reason = name.trim() || 'manual-backup';
      const backupId = window.BackupManager.create(reason);
      if (backupId) {
        alert('‚úì Backup zosta≈Ç utworzony pomy≈õlnie!');
        renderBackupList();
        updateBackupStats();
      } else {
        alert('‚ö† B≈ÇƒÖd podczas tworzenia backupu');
      }
    } else {
      // Fallback do starej metody
      const backupId = createBackup(name.trim() || null);
      if (backupId) {
        alert('Backup zosta≈Ç utworzony pomy≈õlnie!');
      }
    }
  });

  qs('#export-data').addEventListener('click', () => {
    if (typeof window.exportDataToFile === 'function') {
      window.exportDataToFile();
    } else {
      // Fallback to old method
      const dataStr = JSON.stringify(state, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `doors-planner-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      alert('Dane zosta≈Çy wyeksportowane do pliku!');
    }
  });

  qs('#import-data').addEventListener('click', () => {
    if (typeof window.importDataFromFile === 'function') {
      window.importDataFromFile();
    } else {
      // Fallback to old method
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            if (confirm('Czy na pewno chcesz zaimportowaƒá dane? To nadpisze obecne dane.')) {
              Object.assign(state, importedData);
              save();
              location.reload(); // Reload to apply changes
            }
          } catch (err) {
            alert('B≈ÇƒÖd podczas importu danych: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
  });

  qs('#backup-refresh').addEventListener('click', () => {
    renderBackupList();
    updateBackupStats();
  });

  qs('#backup-cleanup').addEventListener('click', () => {
    // U≈ºyj BackupManager je≈õli dostƒôpny
    if (typeof window.BackupManager !== 'undefined') {
      const removed = window.BackupManager.cleanup();
      if (removed > 0) {
        alert(`‚úÖ Wyczyszczono ${removed} starych backup√≥w!`);
        renderBackupList();
        updateBackupStats();
      } else {
        alert('‚ÑπÔ∏è Brak starych backup√≥w do wyczyszczenia.');
      }
    } else {
      // Fallback do starej metody
      const removed = cleanupOldBackups();
      if (removed > 0) {
        alert(`Wyczyszczono ${removed} starych backup√≥w!`);
      } else {
        alert('Brak starych backup√≥w do wyczyszczenia.');
      }
    }
  });

  const backupImportEl = qs('#backup-import');
  if (backupImportEl) {
    backupImportEl.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        await importBackupFromFile(file);
      } catch (error) {
        console.error('Import failed:', error);
        alert('B≈ÇƒÖd podczas importu: ' + error.message);
      }

      // Reset input
      e.target.value = '';
    });
  }

  // Cleanup old backups
  function cleanupOldBackups() {
    try {
      const backups = getBackups();
      const maxCount = parseInt(qs('#backup-max-count').value) || MAX_BACKUPS_DEFAULT;

      if (backups.length <= maxCount) {
        console.log('No cleanup needed');
        return 0;
      }

      const removed = backups.splice(maxCount);
      localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(backups));
      renderBackupList();
      updateBackupStats();

      console.log(`Cleaned up ${removed.length} old backups`);
      return removed.length;
    } catch (e) {
      console.error('Failed to cleanup backups:', e);
      return 0;
    }
  }

  function showReportsProgress(show = true, text = 'Generowanie raportu...', percent = 0){
    const progressEl = qs('#reports-progress');
    const textEl = qs('#reports-progress-text');
    const percentEl = qs('#reports-progress-percent');
    const barEl = qs('#reports-progress-bar');
    
    if(show){
      progressEl.classList.remove('hidden');
      textEl.textContent = text;
      percentEl.textContent = percent + '%';
      barEl.style.width = percent + '%';
    } else {
      progressEl.classList.add('hidden');
    }
  }

  function buildEmployeeText(empId){
    const emp = (state.employees||[]).find(e=>e.id===empId) || {id:empId,name:empId};
    const lines = [];
    lines.push(`${emp.name} ‚Äî Zadania`);
    lines.push(`Data: ${new Date().toLocaleDateString()}`);
    lines.push('');
    const tasks = [];
    (state.processes||[]).forEach(proc=>{ (proc.operations||[]).forEach(op=>{ if(op.assignee && (op.assignee.id||op.assignee)===empId){ tasks.push({title:op.name,ctx:proc.name,time:op.time||0}); } }); });
    (state.tasks||[]).forEach(t=>{ const as = t.assignees || (t.assignee ? [t.assignee] : []); if(Array.isArray(as) && as.some(a=> (a.id||a)===empId)){ tasks.push({title:t.opName,ctx:(state.orders||[]).find(o=>o.id===t.orderId)?.name||t.orderId,time:t.estMin||t.elapsedMin||0}); } });
    if(tasks.length===0){ lines.push('Brak przypisanych zada≈Ñ.'); }
    else{ tasks.forEach((tk,i)=>{ lines.push(`${i+1}. ${tk.title} ‚Äî ${tk.ctx} ‚Äî ${tk.time}m`); }); }
    lines.push(''); lines.push('Powodzenia!');
    return lines.join('\n');
  }

  function copyToClipboard(text){ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).catch(()=>{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); } }

  function renderReports(){
    showReportsProgress(true, 'Przygotowywanie danych...', 10);
    
    setTimeout(() => {
      showReportsProgress(true, 'Filtrowanie danych...', 30);
      
      setTimeout(() => {
        showReportsProgress(true, 'Obliczanie statystyk...', 60);
        
        setTimeout(() => {
          showReportsProgress(true, 'Generowanie wykres√≥w...', 80);
          
          setTimeout(() => {
            showReportsProgress(true, 'Finalizowanie...', 100);
            
            setTimeout(() => {
              // Tutaj wykonaj rzeczywistƒÖ logikƒô
              const period = qs('#report-period').value || 'month';
              const now = new Date();
              let startDate, endDate;

              // Oblicz zakres dat na podstawie wybranego okresu
              switch(period){
                case 'week':
                  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  endDate = now;
                  break;
                case 'month':
                  startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                  endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                  break;
                case 'quarter':
                  const quarterStart = Math.floor(now.getMonth() / 3) * 3;
                  startDate = new Date(now.getFullYear(), quarterStart, 1);
                  endDate = new Date(now.getFullYear(), quarterStart + 3, 0);
                  break;
                case 'year':
                  startDate = new Date(now.getFullYear(), 0, 1);
                  endDate = new Date(now.getFullYear(), 11, 31);
                  break;
              }

              // Filtruj dane dla wybranego okresu
              const filteredTasks = state.tasks.filter(task => {
                if(!task.createdAt) return true; // zadania bez daty traktuj jako aktualne
                const taskDate = new Date(task.createdAt);
                return taskDate >= startDate && taskDate <= endDate;
              });

              const filteredOrders = state.orders.filter(order => {
                if(!order.startDate) return true;
                const orderDate = new Date(order.startDate);
                return orderDate >= startDate && orderDate <= endDate;
              });

              // Generuj statystyki
              generateReportStats(filteredTasks, filteredOrders, period);
              generateEmployeePerformance(filteredTasks, period);
              generateCostReport(filteredTasks, period);
              generateDetailedStats(filteredTasks, filteredOrders, period);
              
              showReportsProgress(false);
            }, 200);
          }, 300);
        }, 300);
      }, 300);
    }, 200);
  }

  function generateReportStats(tasks, orders, period){
    const totalOrders = orders.length;
    const completedTasks = tasks.filter(t => t.status === 'done').length;
    const totalTasks = tasks.length;
    const totalEstimatedTime = tasks.reduce((sum, t) => sum + (t.estMin || 0), 0);
    const totalActualTime = tasks.reduce((sum, t) => sum + (t.elapsedMin || 0), 0);
    const efficiency = totalEstimatedTime > 0 ? Math.round((totalActualTime / totalEstimatedTime) * 100) : 0;

    qs('#stat-total-orders').textContent = totalOrders;
    qs('#stat-completed-tasks').textContent = completedTasks;
    qs('#stat-efficiency').textContent = `${efficiency}%`;
  }

  function generateEmployeePerformance(tasks, period){
    const container = qs('#report-employee-performance');
    const employees = state.employees || [];

    if(employees.length === 0){
      container.innerHTML = '<div class="empty">Brak danych o pracownikach</div>';
      return;
    }

    // Oblicz wydajno≈õƒá dla ka≈ºdego pracownika
    const performance = employees.map(emp => {
      const empTasks = tasks.filter(t => t.assignees && t.assignees.some(a => a.id === emp.id));
      const completedTasks = empTasks.filter(t => t.status === 'done').length;
      const totalTasks = empTasks.length;
      const totalTime = empTasks.reduce((sum, t) => sum + (t.elapsedMin || 0), 0);
      const efficiency = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      return {
        name: emp.name,
        completedTasks,
        totalTasks,
        totalTime: Math.round(totalTime / 60 * 10) / 10, // w godzinach
        efficiency
      };
    }).sort((a, b) => b.efficiency - a.efficiency);

    // Generuj HTML
    let html = '<div style="display:flex;flex-direction:column;gap:8px">';
    performance.forEach(emp => {
      const barWidth = Math.min(emp.efficiency, 100);
      html += `
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:120px;font-weight:500">${emp.name}</div>
          <div style="flex:1;background:#e5e7eb;border-radius:4px;height:20px;overflow:hidden">
            <div style="width:${barWidth}%;height:100%;background:${emp.efficiency >= 80 ? 'var(--ok)' : emp.efficiency >= 60 ? 'var(--warn)' : 'var(--err)'};transition:width 0.3s"></div>
          </div>
          <div style="width:80px;text-align:right;font-size:12px;color:#94a3b8">${emp.efficiency}%</div>
          <div style="width:100px;text-align:right;font-size:12px;color:#94a3b8">${emp.completedTasks}/${emp.totalTasks} zada≈Ñ</div>
        </div>
      `;
    });
    html += '</div>';

    container.innerHTML = html;
  }

  function generateCostReport(tasks, period){
    const container = qs('#report-costs');

    // Proste obliczenia koszt√≥w (mo≈ºna rozszerzyƒá o rzeczywiste stawki)
    const hourlyRate = 25; // z≈Ç/h - przyk≈Çadowa stawka
    const totalHours = tasks.reduce((sum, t) => sum + (t.elapsedMin || 0), 0) / 60;
    const totalCost = Math.round(totalHours * hourlyRate);

    const completedTasks = tasks.filter(t => t.status === 'done').length;
    const costPerTask = completedTasks > 0 ? Math.round(totalCost / completedTasks) : 0;

    container.innerHTML = `
      <div class="grid3">
        <div class="card" style="text-align:center">
          <div style="font-size:20px;font-weight:bold;color:var(--acc)">${Math.round(totalHours)}h</div>
          <div style="color:var(--text-secondary)">Ca≈Çkowity czas pracy</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:20px;font-weight:bold;color:var(--ok)">${totalCost} z≈Ç</div>
          <div style="color:var(--text-secondary)">Ca≈Çkowity koszt</div>
        </div>
        <div class="card" style="text-align:center">
          <div style="font-size:20px;font-weight:bold;color:var(--warn)">${costPerTask} z≈Ç</div>
          <div style="color:var(--text-secondary)">≈öredni koszt zadania</div>
        </div>
      </div>
    `;
  }

  function generateDetailedStats(tasks, orders, period){
    const container = qs('#report-details');

    // Grupuj zadania wed≈Çug statusu
    const statusStats = {
      todo: tasks.filter(t => t.status === 'todo').length,
      run: tasks.filter(t => t.status === 'run').length,
      done: tasks.filter(t => t.status === 'done').length
    };

    // Oblicz ≈õrednie czasy
    const completedTasks = tasks.filter(t => t.status === 'done' && t.elapsedMin > 0);
    const avgCompletionTime = completedTasks.length > 0
      ? Math.round(completedTasks.reduce((sum, t) => sum + t.elapsedMin, 0) / completedTasks.length / 60 * 10) / 10
      : 0;

    const html = `
      <table>
        <thead>
          <tr>
            <th>Metryka</th>
            <th>Warto≈õƒá</th>
            <th>Opis</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ca≈Çkowita liczba zlece≈Ñ</td>
            <td>${orders.length}</td>
            <td>Zlecenia w wybranym okresie</td>
          </tr>
          <tr>
            <td>Zadania do wykonania</td>
            <td>${statusStats.todo}</td>
            <td>Zadania oczekujƒÖce</td>
          </tr>
          <tr>
            <td>Zadania w trakcie</td>
            <td>${statusStats.run}</td>
            <td>Zadania aktualnie wykonywane</td>
          </tr>
          <tr>
            <td>Zadania uko≈Ñczone</td>
            <td>${statusStats.done}</td>
            <td>Zadania zako≈Ñczone</td>
          </tr>
          <tr>
            <td>≈öredni czas wykonania</td>
            <td>${avgCompletionTime}h</td>
            <td>≈öredni czas na uko≈Ñczone zadanie</td>
          </tr>
          <tr>
            <td>≈ÅƒÖczny szacowany czas</td>
            <td>${Math.round(tasks.reduce((sum, t) => sum + (t.estMin || 0), 0) / 60)}h</td>
            <td>Ca≈Çkowity planowany czas pracy</td>
          </tr>
        </tbody>
      </table>
    `;

    container.innerHTML = html;
  }

  function exportReportToPDF(){
    showReportsProgress(true, 'Przygotowywanie danych do eksportu...', 20);
    
    setTimeout(() => {
      showReportsProgress(true, 'Generowanie zawarto≈õci PDF...', 60);
      
      setTimeout(() => {
        showReportsProgress(true, 'Otwieranie okna drukowania...', 90);
        
        setTimeout(() => {
          // Prosta implementacja eksportu - otw√≥rz w nowym oknie i u≈ºyj drukowania do PDF
          const reportWindow = window.open('', '_blank');
          const reportContent = qs('#reports-content').innerHTML;
          
          const html = `<html>
            <head>
              <title>Raport produkcyjny - ${new Date().toLocaleDateString('pl-PL')}</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .card { border: 1px solid #ddd; padding: 16px; margin-bottom: 16px; border-radius: 8px; }
                h4 { margin-top: 0; color: #333; }
                table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; }
                .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
                .card { text-align: center; }
                @media print { body { margin: 0; } }
              </style>
              <style>
              /* === High contrast warning callout === */
              .callout-warn{background:#fef3c7;border:1px solid #f59e0b;color:#1f2937;}
              .callout-warn h4{margin-top:0;color:#92400e;}
              .callout-warn strong{color:#92400e;}
              .callout-warn.high-contrast{background:#1e293b;border-color:#fbbf24;color:#f8fafc;}
              .callout-warn.high-contrast h4{color:#fbbf24;}
              .callout-warn.high-contrast strong{color:#fbbf24;}
              .callout-warn.high-contrast a, .callout-warn.high-contrast code{color:#fde68a;}
              #high-contrast-toggle-wrapper{margin:8px 0 16px;}
              #high-contrast-toggle-wrapper label{display:flex;align-items:center;gap:6px;font-size:13px;color:#cbd5e1;cursor:pointer;}
              </style>
            </head>
            <body>
              <h2>Raport produkcyjny</h2>
              <p>Okres: ${qs('#report-period').value} | Data wygenerowania: ${new Date().toLocaleString('pl-PL')}</p>
              ${reportContent}
            </body>
          </html>`;
          
          reportWindow.document.write(html);
          
          reportWindow.document.close();
          reportWindow.print();
          
          showReportsProgress(false);
        }, 300);
      }, 300);
    }, 200);
  }
  
  function renderASPage(){
  const sel=qs('#as-order'); if(sel){ sel.innerHTML=''; (state.orders||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=(o.name?(''+o.name):o.id); sel.appendChild(opt); });
      // populate employee multi-select
      const empSel=qs('#as-employees'); 
      if(empSel){ 
        empSel.innerHTML=''; 
        (state.employees||[]).forEach(e=>{ 
          const opt=document.createElement('option'); 
          opt.value=e.id; 
          opt.textContent=e.name||e.id; 
          empSel.appendChild(opt); 
        }); 
      }
      // when order selection changes, copy phone/placecode automatically
      sel.addEventListener('change',()=>{
        const oid = sel.value; const ord = (state.orders||[]).find(x=>x.id===oid) || {};
        if(ord){
          // automatycznie wype≈Çnij dane monta≈ºu z zlecenia
          qs('#as-client').value = ord.client || '';
          qs('#as-placecode').value = ord.postalCode || ord.post || '';
          qs('#as-phone').value = ord.phone || ord.orderPhone || '';
          qs('#as-address').value = ord.address || '';
          // pozosta≈Çe pola jak wcze≈õniej
          const leadEmp = (state.employees||[]).find(e=>e.id===ord.leadEmployeeId);
          qs('#as-lead').value = leadEmp ? leadEmp.name : '';
          qs('#as-desc').value = ord.notes || '';
          qs('#as-install').value = ord.installDate || '';
          qs('#as-employee').value = '';
        }
      });
    }
    const host=qs('#as-list'); if(!host) return; host.innerHTML='';
    
    // Renderuj wpisy monta≈ºu i zadania monta≈ºowe razem
    const allItems = [];
    
    // Dodaj wpisy z state.after
    (state.after||[]).forEach(a=>{
      const orderObj = (state.orders||[]).find(o=>o.id===a.order) || {};
      const placeCode = a.postalCode || orderObj.postalCode || orderObj.placeCode || orderObj.placecode || '';
      const phoneNumber = a.phone || orderObj.phone || '';
      const address = a.address || orderObj.address || '';
      const clientName = a.client || orderObj.client || '';
      const empIds = a.employeeIds || (a.employeeId ? [a.employeeId] : []);
      const empNames = empIds.length > 0 
        ? empIds.map(eid => (state.employees||[]).find(e=>e.id===eid)?.name || eid).join(', ')
        : 'Nieprzypisane';
      const hoursText = a.hours ? `${a.hours}h` : '-';
      
      allItems.push({
        date: a.installDate || '',
        type: 'after',
        data: a,
        render: ()=>{
          const d=document.createElement('div'); 
          d.className='card';
          const typeIcon = a.type === 'monta≈º' ? 'üîß' : a.type === 'reklamacja' ? '‚ö†Ô∏è' : a.type === 'pomiar' ? 'üìè' : 'üìã';
          const statusBadge = a.status === 'nowe' ? '<span style="padding:2px 8px;border-radius:4px;font-size:11px;background:#94a3b8;color:white">NOWE</span>' :
                              a.status === 'w toku' ? '<span style="padding:2px 8px;border-radius:4px;font-size:11px;background:#f97316;color:white">W TOKU</span>' :
                              '<span style="padding:2px 8px;border-radius:4px;font-size:11px;background:#22c55e;color:white">ZAMKNIƒòTE</span>';
          
          d.innerHTML=`<div class="row" style="justify-content:space-between">
            <div style="flex:1">
              <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
                <b style="font-size:15px">${typeIcon} ${a.type.toUpperCase()}</b>
                ${statusBadge}
                ${orderObj.name ? '<span class="muted">‚Ä¢ '+orderObj.name+'</span>' : ''}
              </div>
              ${clientName ? '<div style="font-weight:600;color:#fff;background:#1e293b;padding:4px 8px;border-radius:4px;display:inline-block;margin-bottom:4px">üë§ Klient: '+clientName+'</div>' : ''}
              <div class="muted">üìÖ Monta≈º: ${a.installDate||'-'} ‚Ä¢ üöó Wyjazd: ${a.departTime||'-'} ‚Ä¢ üè† Wizyta: ${a.visitTime||'-'} ‚Ä¢ ‚è±Ô∏è Czas: ${hoursText}</div>
              <div class="muted">üìç ${address || 'Brak adresu'} ‚Ä¢ ${placeCode ? placeCode+' ‚Ä¢' : ''} üìû ${phoneNumber || '-'}</div>
              <div class="muted">üë∑ ${empNames}</div>
              ${a.desc ? '<div class="muted" style="margin-top:4px">üí¨ '+a.desc+'</div>' : ''}
            </div>
            <div class="row" style="gap:4px">
              <button class="btn" data-as-ed="${a.id}">Edytuj</button>
              <button class="btn red" data-as-del="${a.id}">Usu≈Ñ</button>
            </div>
          </div>`;
          return d;
        }
      });
    });
    
    // Dodaj zadania monta≈ºowe z state.tasks
    const assemblyTasks = (state.tasks||[]).filter(t => t.isAssemblyTask);
    assemblyTasks.forEach(task=>{
      const orderObj = task.orderId ? ((state.orders||[]).find(o=>o.id===task.orderId) || {}) : {};
      const orderName = orderObj.name || (task.orderId ? 'Zlecenie #' + task.orderId.slice(0,8) : '');
      const clientName = (task.client && task.client !== '-') ? task.client : (orderObj.client || '');
      const empIds = task.assignees || (task.employeeId ? [task.employeeId] : []);
      const empNames = empIds.length > 0 
        ? empIds.map(eid => (state.employees||[]).find(e=>e.id===eid)?.name || eid).join(', ')
        : 'Nieprzypisane';
      
      allItems.push({
        date: task.installDate || '',
        type: 'task',
        data: task,
        render: ()=>{
          const d=document.createElement('div'); 
          d.className='card';
          
          const statusColors = {
            'todo': 'background:#94a3b8;color:white',
            'run': 'background:#f97316;color:white',
            'paused': 'background:#eab308;color:white',
            'done': 'background:#22c55e;color:white',
            'blocked': 'background:#ef4444;color:white'
          };
          const statusStyle = statusColors[task.status] || statusColors['todo'];
          const statusText = task.status === 'todo' ? 'NOWE' : task.status === 'run' ? 'W TOKU' : task.status === 'done' ? 'ZAMKNIƒòTE' : task.status.toUpperCase();
          const priorityBadge = task.priority === 'urgent' ? 'üî¥ PILNE' : task.priority === 'high' ? 'üü° Wysoki' : '';
          const taskNumberDisplay = task.taskNumber ? `[${task.taskNumber}] ` : '';
          
          d.innerHTML=`<div class="row" style="justify-content:space-between">
            <div style="flex:1">
              <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
                <b style="font-size:15px">${taskNumberDisplay}${task.name}</b>
                <span style="padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;${statusStyle}">${statusText}</span>
                ${priorityBadge ? '<span style="font-size:12px">'+priorityBadge+'</span>' : ''}
                ${clientName && clientName !== '-' ? '<span style="font-weight:600;color:#fff;background:#1e293b;padding:4px 8px;border-radius:4px">üë§ Klient: '+clientName+'</span>' : ''}
                ${orderName ? '<span class="muted">‚Ä¢ '+orderName+'</span>' : ''}
              </div>
              <div class="muted">üìÖ Data: ${task.installDate||'-'} ‚Ä¢ üöó Wyjazd: ${task.departTime||'-'} ‚Ä¢ üè† Wizyta: ${task.visitTime||'-'} ‚Ä¢ ‚è±Ô∏è Czas: ${(task.estMin/60).toFixed(1)}h</div>
              <div class="muted">üìç ${task.address||'Brak adresu'} ‚Ä¢ ${task.postalCode ? task.postalCode+' ‚Ä¢' : ''} üìû ${task.phone||'-'}</div>
              <div class="muted">üë∑ ${empNames}</div>
              ${task.notes ? '<div class="muted" style="margin-top:4px">üí¨ '+task.notes+'</div>' : ''}
            </div>
            <div class="row" style="gap:4px">
              <button class="btn" data-as-task-ed="${task.id}">Edytuj</button>
              <button class="btn red" data-as-task-del="${task.id}">Usu≈Ñ</button>
            </div>
          </div>`;
          return d;
        }
      });
    });
    
    // Sortuj po dacie (najnowsze na g√≥rze)
    allItems.sort((a, b) => {
      const dateA = a.date ? new Date(a.date).getTime() : 0;
      const dateB = b.date ? new Date(b.date).getTime() : 0;
      return dateB - dateA;
    });
    
    // Renderuj wszystkie wpisy
    if(allItems.length === 0){
      host.innerHTML = '<div class="muted" style="padding:20px;text-align:center">Brak wpis√≥w monta≈ºowych</div>';
    } else {
      allItems.forEach(item => host.appendChild(item.render()));
    }
  }
  qs('#as-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault(); const id=qs('#as-id').value||uid(); const type=qs('#as-type').value; const order=qs('#as-order').value||''; const status=qs('#as-status').value; const desc=qs('#as-desc').value||''; const install=qs('#as-install').value||''; const depart=qs('#as-go').value||''; const visit=qs('#as-visit').value||'';
    // get selected employees from multi-select
    const empSel = qs('#as-employees');
    const selectedEmployees = empSel ? Array.from(empSel.selectedOptions).map(opt => opt.value) : [];
    // get phone, placecode and address from form fields
    const asPhone = qs('#as-phone').value || '';
    const asPlace = qs('#as-placecode').value || '';
    const asAddress = qs('#as-address').value || '';
    const asClient = qs('#as-client').value || '';
    const asHours = parseFloat(qs('#as-hours').value) || 0;
    const orderObj = (state.orders||[]).find(o=>o.id===order);
    const ex=state.after.find(x=>x.id===id); 
    const payload={id,type,order,status,desc,installDate:install,departTime:depart,visitTime:visit,phone:asPhone,postalCode:asPlace,address:asAddress,client:asClient,employeeIds:selectedEmployees,hours:asHours};
    if(ex) Object.assign(ex,payload); else state.after.push(payload);
    
    console.log('üìã Zapisujƒô monta≈º:', {id, type, order, install, asHours, selectedEmployees});
    
    // optional immediate save after AS save
    maybeAutoSave('as-save');
    save(); ev.target.reset(); renderASPage();
    
    // Block time for all selected employees during assembly (or create unassigned task)
    if(install && asHours > 0){
      console.log('üîß Tworzenie zadania monta≈ºowego, pracownicy:', selectedEmployees.length > 0 ? selectedEmployees : 'BRAK (zadanie nieprzypisane)', 'Godziny:', asHours);
      
      // Remove old blocking tasks for this assembly from state
      const oldTasks = (state.tasks||[]).filter(t => t.assemblyId === id);
      state.tasks = (state.tasks||[]).filter(t => t.assemblyId !== id);
      
      // Remove old tasks from Firebase
      if(oldTasks.length > 0 && state.storage.mode==='firebase' && typeof ensureFirebase === 'function'){
        try {
          if(await ensureFirebase()){
            console.log('üóëÔ∏è Usuwam stare zadania monta≈ºowe z Firebase:', oldTasks.length);
            for(const oldTask of oldTasks){
              try{
                await fbRoot().collection('tasks').doc(oldTask.id).delete();
              }catch(e){ console.warn('B≈ÇƒÖd usuwania zadania:', e && e.message); }
            }
          }
        } catch(e) { console.warn('Firebase error:', e); }
      }
      
      const targetEmployees = selectedEmployees.length > 0 ? selectedEmployees : [null];
      
      targetEmployees.forEach(employeeId => {
        const emp = employeeId ? (state.employees||[]).find(e=>e.id===employeeId) : null;
        if(employeeId && !emp) console.warn('Nie znaleziono pracownika:', employeeId);
        
        // Calculate start and end time based on install date and hours
        const installDate = new Date(install);
        // If departure time exists, use it, otherwise default to 7:00
        let startHour = 7, startMin = 0;
        if(depart){
          const [h, m] = depart.split(':').map(Number);
          startHour = h; startMin = m;
        }
        installDate.setHours(startHour, startMin, 0, 0);
        const startTime = installDate.getTime();
        const endTime = startTime + (asHours * 60 * 60 * 1000); // Convert hours to milliseconds
        
        // Create blocking task with full assembly info
        const blockTask = { 
          id: uid(), 
          operationId: 'monta≈º-block', 
          opName: `Monta≈º: ${orderObj?.name || order}`,
          name: `Monta≈º: ${orderObj?.name || order}`,
          title: `Monta≈º: ${orderObj?.name || order}`,
          employeeId: employeeId || null, 
          assignees: employeeId ? [employeeId] : [],
          startPlanned: startTime, 
          endPlanned: endTime, 
          status: 'todo',
          orderId: order,
          orderNumber: orderObj?.name || order || 'Monta≈º 100',
          model: orderObj?.model || '-',
          client: orderObj?.client || '-',
          deadline: orderObj?.deadline || install,
          assemblyId: id,
          hours: asHours,
          estMin: Math.round(asHours * 60),
          estimatedTime: Math.round(asHours * 60),
          quantity: 1,
          unit: 'szt',
          // Dodatkowe informacje z formularza monta≈ºu
          assemblyType: type,
          assemblyStatus: status,
          assemblyDesc: desc,
          installDate: install,
          departTime: depart,
          visitTime: visit,
          address: asAddress,
          postalCode: asPlace,
          phone: asPhone,
          isAssemblyTask: true // Mark as assembly task explicitly
        };
        state.tasks.push(blockTask);
        console.log('‚úÖ Utworzono zadanie monta≈ºowe:', blockTask.name, 'dla pracownika:', employeeId || 'NIEPRZYPISANY');
      });

      console.log('üìä Wszystkie zadania monta≈ºowe:', state.tasks.filter(t => t.operationId === 'monta≈º-block').length);
      console.log('üìä Wszystkie zadania (state.tasks):', state.tasks.length);
      
      // Przesu≈Ñ zadania produkcyjne pracownik√≥w monta≈ºowych
      if(selectedEmployees.length > 0) {
        selectedEmployees.forEach(employeeId => {
          console.log('üîÑ Przesuwam zadania dla pracownika:', employeeId);
          const installDate = new Date(install);
          let startHour = 7, startMin = 0;
          if(depart){
            const [h, m] = depart.split(':').map(Number);
            startHour = h; startMin = m;
          }
          installDate.setHours(startHour, startMin, 0, 0);
          const assemblyStart = installDate.getTime();
          const assemblyEnd = assemblyStart + (asHours * 60 * 60 * 1000);
          
          // Znajd≈∫ zadania produkcyjne tego pracownika kt√≥re kolidujƒÖ z monta≈ºem
          const employeeTasks = state.tasks.filter(t => 
            t.employeeId === employeeId && 
            t.operationId !== 'monta≈º-block' &&
            t.status !== 'done' &&
            t.startPlanned && t.endPlanned
          );
          
          employeeTasks.forEach(task => {
            const taskStart = task.startPlanned;
            const taskEnd = task.endPlanned;
            const taskDuration = taskEnd - taskStart;
            
            // Sprawd≈∫ czy zadanie koliduje z monta≈ºem
            const hasCollision = (taskStart < assemblyEnd && taskEnd > assemblyStart);
            
            if(hasCollision){
              console.log('‚ö†Ô∏è Kolizja zadania:', task.opName || task.name, 'z monta≈ºem');
              // Przesu≈Ñ zadanie po monta≈ºu
              task.startPlanned = assemblyEnd;
              task.endPlanned = assemblyEnd + taskDuration;
              console.log('‚úÖ Przesuniƒôto zadanie na:', new Date(task.startPlanned).toLocaleString('pl-PL'));
            }
          });
        });
      }
      
      save();
      renderTasks();
      renderGantt();
    }
  });

  // ========== MRP / ZAKUPY ==========
  
  // Oblicz niedobory materia≈Ç√≥w na podstawie magazynu i obciƒÖ≈ºe≈Ñ
  function calculateMaterialShortages() {
    const warehouseItems = window.warehouseItems || [];
    const orders = state.orders || [];
    const shortages = [];
    
    // Pobierz obliczenia obciƒÖ≈ºe≈Ñ (ta sama logika co w zak≈Çadce ObciƒÖ≈ºenia)
    const obligationsList = calculateWarehouseObligations();
    // Konwertuj listƒô na Mapƒô dla szybkiego dostƒôpu po ID
    const obligationsMap = new Map(obligationsList.map(o => [o.itemId, o]));
    
    // Dla ka≈ºdej pozycji magazynowej sprawd≈∫ czy jest niedob√≥r
    warehouseItems.forEach(item => {
      const obligation = obligationsMap.get(item.id);
      if (!obligation) return;
      
      const available = obligation.available || 0;
      const reserved = obligation.reserved || 0;
      
      // Niedob√≥r = ilo≈õƒá zarezerwowana przekracza dostƒôpnƒÖ
      if (reserved > available) {
        const shortage = reserved - available;
        
        shortages.push({
          itemId: item.id,
          itemName: item.name,
          category: item.category || 'Inne',
          unit: item.unit || 'szt',
          currentStock: item.quantity || 0,
          reserved: reserved,
          available: available,
          shortage: shortage,
          suggestedOrder: Math.ceil(shortage * 1.5), // +50% buffer
          orders: obligation.orders || []
        });
      }
    });
    
    return shortages.sort((a, b) => b.shortage - a.shortage);
  }
  
  // Renderuj dashboard MRP
  function renderMRPDashboard() {
    const dashboard = qs('#mrp-dashboard');
    if (!dashboard) return;
    
    const shortages = calculateMaterialShortages();
    const totalShortages = shortages.length;
    const totalReserved = shortages.reduce((sum, s) => sum + s.reserved, 0);
    const totalSuggestedValue = shortages.reduce((sum, s) => sum + s.suggestedOrder, 0);
    
    dashboard.innerHTML = `
      <div class="card" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);color:white;padding:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:8px">‚ö†Ô∏è Niedobory materia≈Ç√≥w</div>
        <div style="font-size:36px;font-weight:700;margin-bottom:4px">${totalShortages}</div>
        <div style="font-size:13px;opacity:0.8">pozycji wymaga zam√≥wienia</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üì¶ Zarezerwowane ≈ÇƒÖcznie</div>
        <div style="font-size:36px;font-weight:700;margin-bottom:4px">${totalReserved}</div>
        <div style="font-size:13px;opacity:0.8">jednostek w aktywnych zleceniach</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;padding:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:8px">üõí Sugerowana ilo≈õƒá</div>
        <div style="font-size:36px;font-weight:700;margin-bottom:4px">${totalSuggestedValue}</div>
        <div style="font-size:13px;opacity:0.8">jednostek do zam√≥wienia (z buforem)</div>
      </div>
    `;
  }
  
  // G≈Ç√≥wna funkcja renderowania MRP
  function renderMRPPage(){
    console.log('üõí [MRP] Renderowanie strony MRP');
    
    // Renderuj dashboard
    renderMRPDashboard();
    
    // Renderuj analizƒô niedobor√≥w
    const list = qs('#mrp-list');
    if (!list) return;
    
    const shortages = calculateMaterialShortages();
    
    if (shortages.length === 0) {
      list.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#64748b">
          <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px">Brak niedobor√≥w materia≈Çowych</div>
          <div style="font-size:14px">Wszystkie materia≈Çy sƒÖ dostƒôpne w wystarczajƒÖcych ilo≈õciach</div>
        </div>
      `;
      return;
    }
    
    // Grupuj niedobory po kategoriach
    const byCategory = new Map();
    shortages.forEach(s => {
      const cat = s.category || 'Inne';
      if (!byCategory.has(cat)) byCategory.set(cat, []);
      byCategory.get(cat).push(s);
    });
    
    let html = '';
    
    byCategory.forEach((items, category) => {
      html += `
        <div style="margin-bottom:24px">
          <h4 style="font-size:16px;font-weight:700;color:#0f172a;margin-bottom:12px;padding:8px 12px;background:#f1f5f9;border-left:4px solid #3b82f6">
            üìÅ ${escapeHtml(category)} <span style="color:#64748b;font-weight:400">(${items.length})</span>
          </h4>
          <div class="table">
            <table>
              <thead>
                <tr>
                  <th style="width:30%">Materia≈Ç</th>
                  <th style="width:10%;text-align:center">Stan</th>
                  <th style="width:10%;text-align:center">Zarez.</th>
                  <th style="width:10%;text-align:center">Dostƒôpne</th>
                  <th style="width:10%;text-align:center">Brakuje</th>
                  <th style="width:15%;text-align:center">Sugerowane</th>
                  <th style="width:15%;text-align:center">Akcje</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      items.forEach(item => {
        const ordersInfo = item.orders.length > 0 
          ? `<div style="font-size:12px;color:#64748b;margin-top:4px">üîñ Zlecenia: ${item.orders.map(o => o.name).join(', ')}</div>`
          : '';
        
        html += `
          <tr>
            <td>
              <div style="font-weight:600">${escapeHtml(item.itemName)}</div>
              ${ordersInfo}
            </td>
            <td style="text-align:center">
              <span style="padding:4px 8px;background:#e2e8f0;border-radius:4px;font-weight:600">
                ${item.currentStock} ${escapeHtml(item.unit)}
              </span>
            </td>
            <td style="text-align:center">
              <span style="padding:4px 8px;background:#fef3c7;border-radius:4px;font-weight:600;color:#92400e">
                ${item.reserved} ${escapeHtml(item.unit)}
              </span>
            </td>
            <td style="text-align:center">
              <span style="padding:4px 8px;background:#${item.available > 0 ? 'dcfce7' : 'fee2e2'};border-radius:4px;font-weight:600;color:#${item.available > 0 ? '166534' : '991b1b'}">
                ${item.available} ${escapeHtml(item.unit)}
              </span>
            </td>
            <td style="text-align:center">
              <span style="padding:4px 8px;background:#fee2e2;border-radius:4px;font-weight:700;color:#dc2626">
                ${item.shortage} ${escapeHtml(item.unit)}
              </span>
            </td>
            <td style="text-align:center">
              <span style="padding:4px 8px;background:#dbeafe;border-radius:4px;font-weight:700;color:#1e40af">
                ${item.suggestedOrder} ${escapeHtml(item.unit)}
              </span>
            </td>
            <td style="text-align:center">
              <button class="btn green" onclick="addShortageToShoppingList('${item.itemId}', ${item.suggestedOrder})" style="font-size:12px;padding:6px 12px">
                ‚ûï Do listy zakup√≥w
              </button>
            </td>
          </tr>
        `;
      });
      
      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });
    
    list.innerHTML = html;
  }
  
  // Dodaj niedob√≥r do listy zakup√≥w
  function addShortageToShoppingList(itemId, quantity) {
    const item = (window.warehouseItems || []).find(i => i.id === itemId);
    if (!item) {
      alert('Nie znaleziono pozycji magazynowej');
      return;
    }
    
    // Dodaj do listy zakup√≥w
    if (!window.shoppingList) window.shoppingList = [];
    
    const existing = window.shoppingList.find(s => s.itemId === itemId && s.status === 'pending');
    if (existing) {
      alert(`Materia≈Ç "${item.name}" jest ju≈º na li≈õcie zakup√≥w`);
      return;
    }
    
    window.shoppingList.push({
      id: 'shop-' + Date.now(),
      itemId: itemId,
      itemName: item.name,
      category: item.category,
      quantity: quantity,
      unit: item.unit || 'szt',
      status: 'pending',
      reason: 'Niedob√≥r z analizy MRP',
      addedAt: new Date().toISOString()
    });
    
    localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
    
    showWarehouseToast(`‚úÖ Dodano "${item.name}" (${quantity} ${item.unit}) do listy zakup√≥w`, 'success');
    
    // Od≈õwie≈º badge
    if (typeof updateShoppingListBadge === 'function') {
      updateShoppingListBadge();
    }
  }
  
  // Eksport MRP do CSV
  function exportMRPToCSV() {
    const shortages = calculateMaterialShortages();
    if (shortages.length === 0) {
      alert('Brak niedobor√≥w do eksportu');
      return;
    }
    
    let csv = 'Kategoria;Materia≈Ç;Jednostka;Stan;Zarezerwowane;Dostƒôpne;Brakuje;Sugerowane zam√≥wienie\n';
    
    shortages.forEach(item => {
      csv += `"${item.category}";"${item.itemName}";"${item.unit}";${item.currentStock};${item.reserved};${item.available};${item.shortage};${item.suggestedOrder}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `mrp_niedobory_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showWarehouseToast('üìä Eksport CSV zako≈Ñczony', 'success');
  }
  
  // ========== ZAM√ìWIENIA ZAKUPOWE ==========
  
  // Inicjalizacja struktur danych
  if (!window.purchaseOrders) window.purchaseOrders = [];
  if (!window.suppliers) window.suppliers = [];
  
  let currentMRPTab = 'analysis';
  let currentPOFilter = 'all';
  
  // Prze≈ÇƒÖcz podzak≈Çadkƒô MRP
  function switchMRPTab(tab) {
    currentMRPTab = tab;
    
    // Ukryj wszystkie widoki
    document.querySelectorAll('[id^="mrp-view-"]').forEach(el => el.classList.add('hidden'));
    
    // Poka≈º wybrany widok
    const view = document.getElementById(`mrp-view-${tab}`);
    if (view) view.classList.remove('hidden');
    
    // Zaktualizuj przyciski
    document.querySelectorAll('[id^="mrp-tab-"]').forEach(btn => btn.classList.remove('amber'));
    const activeBtn = document.getElementById(`mrp-tab-${tab}`);
    if (activeBtn) activeBtn.classList.add('amber');
    
    // Zaktualizuj widoczno≈õƒá przycisk√≥w
    const exportBtn = document.getElementById('mrp-export-btn');
    const newOrderBtn = document.getElementById('mrp-new-order-btn');
    
    if (tab === 'analysis') {
      if (exportBtn) exportBtn.style.display = 'block';
      if (newOrderBtn) newOrderBtn.style.display = 'block';
    } else if (tab === 'orders') {
      if (exportBtn) exportBtn.style.display = 'none';
      if (newOrderBtn) newOrderBtn.style.display = 'block';
    } else {
      if (exportBtn) exportBtn.style.display = 'none';
      if (newOrderBtn) newOrderBtn.style.display = 'none';
    }
    
    // Renderuj odpowiedniƒÖ zawarto≈õƒá
    if (tab === 'analysis') {
      renderMRPDashboard();
      const list = document.getElementById('mrp-list');
      if (list && list.innerHTML === '') renderMRPPage();
    } else if (tab === 'orders') {
      renderPurchaseOrders();
    } else if (tab === 'suppliers') {
      renderSuppliers();
      updateTelegramBotStatus();
    }
  }
  
  // Wczytaj dane z localStorage i Firebase
  function loadPurchaseData() {
    try {
      // 1. Wczytaj z localStorage
      const storedOrders = localStorage.getItem('purchaseOrders');
      const storedSuppliers = localStorage.getItem('suppliers');
      
      if (storedOrders) window.purchaseOrders = JSON.parse(storedOrders);
      if (storedSuppliers) window.suppliers = JSON.parse(storedSuppliers);
      
      // 2. Wczytaj z state (Firebase) - Firebase ma priorytet
      if (state && state.purchaseOrders && Array.isArray(state.purchaseOrders)) {
        window.purchaseOrders = state.purchaseOrders;
      }
      if (state && state.suppliers && Array.isArray(state.suppliers)) {
        window.suppliers = state.suppliers;
      }
      
      // Je≈õli brak dostawc√≥w, dodaj przyk≈Çadowych
      if (window.suppliers.length === 0) {
        window.suppliers = [
          {
            id: 'sup-001',
            name: 'Tartak Bieszczady',
            category: 'Drewno',
            nip: '1234567890',
            email: 'zamowienia@tartak-bieszczady.pl',
            phone: '+48 123 456 789',
            address: 'ul. Le≈õna 15, 38-600 Lesko',
            notes: 'Dostawa gratis powy≈ºej 5000 z≈Ç',
            createdAt: new Date().toISOString()
          },
          {
            id: 'sup-002',
            name: 'Akcesoria Meblowe Sp. z o.o.',
            category: 'Okucia',
            nip: '0987654321',
            email: 'biuro@akcesoria-meblowe.com.pl',
            phone: '+48 987 654 321',
            address: 'ul. Przemys≈Çowa 8, 00-450 Warszawa',
            notes: 'Realizacja 3-5 dni roboczych',
            createdAt: new Date().toISOString()
          },
          {
            id: 'sup-003',
            name: 'Lakiery i Farby XYZ',
            category: 'Lakiernia',
            email: 'sprzedaz@lakiery-xyz.pl',
            phone: '+48 555 123 456',
            address: 'ul. Kolorowa 3, 31-100 Krak√≥w',
            createdAt: new Date().toISOString()
          }
        ];
        savePurchaseData();
        console.log('‚úÖ Dodano przyk≈Çadowych dostawc√≥w');
      }
      
      console.log('üì¶ Wczytano dane zakup√≥w:', {
        orders: window.purchaseOrders.length,
        suppliers: window.suppliers.length
      });
    } catch (e) {
      console.error('B≈ÇƒÖd wczytywania danych zakup√≥w:', e);
    }
  }
  
  // Zapisz dane do localStorage
  function savePurchaseData() {
    try {
      // Zapisz do localStorage
      localStorage.setItem('purchaseOrders', JSON.stringify(window.purchaseOrders));
      localStorage.setItem('suppliers', JSON.stringify(window.suppliers));
      
      // Synchronizuj z Firebase
      if (state && state.storage && state.storage.mode === 'firebase') {
        if (window.FirebaseSyncQueue && typeof window.FirebaseSyncQueue.enqueue === 'function') {
          window.FirebaseSyncQueue.enqueue('save', { state: window.state }, 15);
        } else if (typeof maybeAutoSave === 'function' && state.storage.autoSaveAssign) {
          maybeAutoSave('purchase-data');
        }
      }
      
      console.log('üíæ Zapisano dane zakup√≥w (localStorage + Firebase)');
    } catch (e) {
      console.error('B≈ÇƒÖd zapisywania danych zakup√≥w:', e);
    }
  }
  
  // Generuj numer zam√≥wienia
  function generatePONumber() {
    const year = new Date().getFullYear();
    const existing = window.purchaseOrders.filter(po => po.number.startsWith(`ZZ-${year}`));
    const nextNum = existing.length + 1;
    return `ZZ-${year}/${String(nextNum).padStart(4, '0')}`;
  }
  
  // Renderuj dashboard zam√≥wie≈Ñ
  function renderPODashboard() {
    const dashboard = document.getElementById('po-dashboard');
    if (!dashboard) return;
    
    const orders = window.purchaseOrders || [];
    const draft = orders.filter(po => po.status === 'draft').length;
    const sent = orders.filter(po => po.status === 'sent').length;
    const confirmed = orders.filter(po => po.status === 'confirmed').length;
    const received = orders.filter(po => po.status === 'received').length;
    
    const totalValue = orders
      .filter(po => po.status !== 'draft')
      .reduce((sum, po) => sum + (po.totalValue || 0), 0);
    
    dashboard.innerHTML = `
      <div class="card" style="background:linear-gradient(135deg, #94a3b8 0%, #64748b 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">üìù Robocze</div>
        <div style="font-size:28px;font-weight:700">${draft}</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">üì§ Wys≈Çane</div>
        <div style="font-size:28px;font-weight:700">${sent}</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">‚úÖ Potwierdzone</div>
        <div style="font-size:28px;font-weight:700">${confirmed}</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">üì¶ Odebrane</div>
        <div style="font-size:28px;font-weight:700">${received}</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">üí∞ Warto≈õƒá zam√≥wie≈Ñ</div>
        <div style="font-size:24px;font-weight:700">${totalValue.toFixed(2)} z≈Ç</div>
      </div>
      
      <div class="card" style="background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9;margin-bottom:6px">üìä ≈ÅƒÖcznie</div>
        <div style="font-size:28px;font-weight:700">${orders.length}</div>
      </div>
    `;
  }
  
  // Filtruj zam√≥wienia
  function filterPurchaseOrders(filter) {
    currentPOFilter = filter;
    renderPurchaseOrders();
  }
  
  // Renderuj listƒô zam√≥wie≈Ñ
  function renderPurchaseOrders() {
    loadPurchaseData();
    renderPODashboard();
    
    const list = document.getElementById('purchase-orders-list');
    if (!list) return;
    
    let orders = window.purchaseOrders || [];
    
    if (currentPOFilter !== 'all') {
      orders = orders.filter(po => po.status === currentPOFilter);
    }
    
    orders.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (orders.length === 0) {
      list.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#64748b">
          <div style="font-size:64px;margin-bottom:16px">üìù</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px">Brak zam√≥wie≈Ñ</div>
          <div style="font-size:14px;margin-bottom:20px">Utw√≥rz nowe zam√≥wienie zakupowe</div>
          <button class="btn green" onclick="createPurchaseOrderModal()">‚ûï Nowe zam√≥wienie</button>
        </div>
      `;
      return;
    }
    
    let html = '';
    
    orders.forEach(po => {
      const statusColors = {
        draft: {bg: '#f1f5f9', text: '#475569', label: 'üìù Robocze'},
        sent: {bg: '#dbeafe', text: '#1e40af', label: 'üì§ Wys≈Çane'},
        confirmed: {bg: '#d1fae5', text: '#065f46', label: '‚úÖ Potwierdzone'},
        received: {bg: '#e9d5ff', text: '#6b21a8', label: 'üì¶ Odebrane'}
      };
      
      const status = statusColors[po.status] || statusColors.draft;
      const itemsCount = (po.items || []).length;
      
      html += `
        <div class="card" style="margin-bottom:12px;cursor:pointer;transition:all 0.2s" onclick="viewPurchaseOrder('${po.id}')" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow=''">
          <div class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:12px">
            <div>
              <div style="font-size:18px;font-weight:700;color:white;margin-bottom:4px">
                ${escapeHtml(po.number)}
              </div>
              <div style="font-size:14px;color:#64748b">
                ${escapeHtml(po.supplier?.name || 'Brak dostawcy')}
              </div>
            </div>
            <div style="text-align:right">
              <span style="display:inline-block;padding:6px 12px;background:${status.bg};color:${status.text};border-radius:6px;font-size:13px;font-weight:600;margin-bottom:4px">
                ${status.label}
              </span>
              <div style="font-size:14px;color:#64748b">
                ${new Date(po.date).toLocaleDateString('pl-PL')}
              </div>
            </div>
          </div>
          
          <div class="row" style="justify-content:space-between;align-items:center">
            <div style="font-size:14px;color:#64748b">
              üì¶ ${itemsCount} ${itemsCount === 1 ? 'pozycja' : itemsCount < 5 ? 'pozycje' : 'pozycji'}
            </div>
            <div style="font-size:18px;font-weight:700;color:white">
              ${(po.totalValue || 0).toFixed(2)} z≈Ç
            </div>
          </div>
        </div>
      `;
    });
    
    list.innerHTML = html;
  }
  
  // Modal tworzenia/edycji zam√≥wienia
  function createPurchaseOrderModal(orderId = null) {
    const isEdit = !!orderId;
    const order = isEdit ? window.purchaseOrders.find(po => po.id === orderId) : null;
    
    const supplierOptions = (window.suppliers || []).map(s => 
      `<option value="${s.id}" ${order && order.supplier?.id === s.id ? 'selected' : ''}>
        ${escapeHtml(s.name)}
      </option>`
    ).join('');
    
    const content = `
      <form id="po-form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <input type="hidden" id="po-id" value="${order?.id || ''}">
        
        <div>
          <label>Numer zam√≥wienia</label>
          <input type="text" id="po-number" value="${order?.number || generatePONumber()}" readonly style="background:#e2e8f0;cursor:not-allowed">
        </div>
        
        <div>
          <label>Data zam√≥wienia</label>
          <input type="date" id="po-date" value="${order?.date || new Date().toISOString().split('T')[0]}" required>
        </div>
        
        <div style="grid-column:1/-1">
          <label>Dostawca</label>
          <select id="po-supplier" required>
            <option value="">-- Wybierz dostawcƒô --</option>
            ${supplierOptions}
            <option value="__new__">‚ûï Dodaj nowego dostawcƒô</option>
          </select>
        </div>
        
        <div style="grid-column:1/-1">
          <label>Notatki</label>
          <textarea id="po-notes" rows="3">${order?.notes || ''}</textarea>
        </div>
        
        <div style="grid-column:1/-1;border-top:2px solid #e2e8f0;padding-top:16px">
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
            <h4 style="margin:0">Pozycje zam√≥wienia</h4>
            <button type="button" class="btn green" onclick="addPOItem()">‚ûï Dodaj pozycjƒô</button>
          </div>
          <div id="po-items-list"></div>
        </div>
        
        <div style="grid-column:1/-1;text-align:right;border-top:2px solid #e2e8f0;padding-top:16px">
          <div style="font-size:20px;font-weight:700;margin-bottom:16px">
            Warto≈õƒá ca≈Çkowita: <span id="po-total-value">0.00</span> z≈Ç
          </div>
        </div>
      </form>
    `;
    
    const buttons = [
      {
        label: 'üíæ Zapisz',
        className: 'btn green',
        onClick: () => savePurchaseOrder()
      },
      {
        label: '‚úï Anuluj',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal(isEdit ? '‚úèÔ∏è Edycja zam√≥wienia' : '‚ûï Nowe zam√≥wienie zakupowe', content, buttons);
    
    // Za≈Çaduj pozycje je≈õli edycja
    if (order && order.items) {
      order.items.forEach(item => {
        addPOItem(item);
      });
    }
    
    // Obs≈Çuga zmiany dostawcy
    setTimeout(() => {
      const supplierSelect = document.getElementById('po-supplier');
      if (supplierSelect) {
        supplierSelect.addEventListener('change', function() {
          if (this.value === '__new__') {
            closeModal();
            createSupplierModal(true); // true = powr√≥t do PO
          }
        });
      }
    }, 100);
    
    calculatePOTotal();
  }
  
  // Dodaj pozycjƒô do zam√≥wienia
  function addPOItem(item = null) {
    const itemsList = document.getElementById('po-items-list');
    if (!itemsList) return;
    
    const itemId = item?.id || 'item-' + Date.now();
    const warehouseItems = window.warehouseItems || [];
    
    const itemOptions = warehouseItems.map(wi => 
      `<option value="${wi.id}" data-name="${escapeHtml(wi.name)}" data-unit="${wi.unit || 'szt'}" ${item && item.itemId === wi.id ? 'selected' : ''}>
        ${escapeHtml(wi.name)} (${wi.unit || 'szt'})
      </option>`
    ).join('');
    
    const itemHtml = `
      <div class="card" style="margin-bottom:12px;background:#f8fafc" data-item-id="${itemId}">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:start">
          <div>
            <label style="font-size:12px;color:#64748b">Materia≈Ç</label>
            <select class="po-item-select" data-item-id="${itemId}" onchange="updatePOItemName(this)" style="width:100%">
              <option value="">-- Wybierz materia≈Ç --</option>
              ${itemOptions}
            </select>
          </div>
          
          <div>
            <label style="font-size:12px;color:#64748b">Ilo≈õƒá</label>
            <input type="number" class="po-item-quantity" data-item-id="${itemId}" value="${item?.quantity || 1}" min="0.1" step="0.1" onchange="calculatePOTotal()" style="width:100%">
          </div>
          
          <div>
            <label style="font-size:12px;color:#64748b">Cena jedn. (z≈Ç)</label>
            <input type="number" class="po-item-price" data-item-id="${itemId}" value="${item?.unitPrice || 0}" min="0" step="0.01" onchange="calculatePOTotal()" style="width:100%">
          </div>
          
          <div>
            <label style="font-size:12px;color:#64748b">Razem (z≈Ç)</label>
            <div class="po-item-total" data-item-id="${itemId}" style="padding:10px;background:white;border-radius:4px;font-weight:600;text-align:right">
              0.00
            </div>
          </div>
          
          <div style="padding-top:20px">
            <button type="button" class="btn" onclick="removePOItem('${itemId}')" style="background:#dc2626;color:white">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    `;
    
    itemsList.insertAdjacentHTML('beforeend', itemHtml);
    calculatePOTotal();
  }
  
  // Aktualizuj nazwƒô pozycji
  function updatePOItemName(select) {
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.value) {
      // Opcjonalnie: mo≈ºemy dodaƒá wy≈õwietlanie jednostki
    }
    calculatePOTotal();
  }
  
  // Usu≈Ñ pozycjƒô
  function removePOItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
      item.remove();
      calculatePOTotal();
    }
  }
  
  // Przelicz warto≈õƒá zam√≥wienia
  function calculatePOTotal() {
    let total = 0;
    
    document.querySelectorAll('.po-item-select').forEach(select => {
      const itemId = select.dataset.itemId;
      const quantity = parseFloat(document.querySelector(`.po-item-quantity[data-item-id="${itemId}"]`)?.value || 0);
      const price = parseFloat(document.querySelector(`.po-item-price[data-item-id="${itemId}"]`)?.value || 0);
      const itemTotal = quantity * price;
      
      const totalEl = document.querySelector(`.po-item-total[data-item-id="${itemId}"]`);
      if (totalEl) totalEl.textContent = itemTotal.toFixed(2);
      
      total += itemTotal;
    });
    
    const totalValueEl = document.getElementById('po-total-value');
    if (totalValueEl) totalValueEl.textContent = total.toFixed(2);
    
    return total;
  }
  
  // Zapisz zam√≥wienie
  function savePurchaseOrder() {
    const id = document.getElementById('po-id').value || 'po-' + Date.now();
    const number = document.getElementById('po-number').value;
    const date = document.getElementById('po-date').value;
    const supplierId = document.getElementById('po-supplier').value;
    const notes = document.getElementById('po-notes').value;
    
    console.log('üîç savePurchaseOrder - pobrane dane:', {
      id, number, date, supplierId, notes
    });
    
    if (!number) {
      console.error('‚ùå Brak numeru zam√≥wienia!');
      alert('B≈ÇƒÖd: brak numeru zam√≥wienia');
      return;
    }
    
    if (!supplierId || supplierId === '__new__') {
      alert('Wybierz dostawcƒô');
      return;
    }
    
    const supplier = window.suppliers.find(s => s.id === supplierId);
    if (!supplier) {
      alert('Nie znaleziono dostawcy');
      return;
    }
    
    // Zbierz pozycje
    const items = [];
    document.querySelectorAll('.po-item-select').forEach(select => {
      const itemId = select.dataset.itemId;
      const warehouseItemId = select.value;
      
      if (!warehouseItemId) return;
      
      const selectedOption = select.options[select.selectedIndex];
      const quantity = parseFloat(document.querySelector(`.po-item-quantity[data-item-id="${itemId}"]`)?.value || 0);
      const unitPrice = parseFloat(document.querySelector(`.po-item-price[data-item-id="${itemId}"]`)?.value || 0);
      
      if (quantity > 0) {
        items.push({
          id: itemId,
          itemId: warehouseItemId,
          itemName: selectedOption.dataset.name,
          quantity: quantity,
          unit: selectedOption.dataset.unit,
          unitPrice: unitPrice,
          total: quantity * unitPrice
        });
      }
    });
    
    if (items.length === 0) {
      alert('Dodaj przynajmniej jednƒÖ pozycjƒô do zam√≥wienia');
      return;
    }
    
    const totalValue = items.reduce((sum, item) => sum + item.total, 0);
    
    const order = {
      id: id,
      number: number,
      date: date,
      supplier: {
        id: supplier.id,
        name: supplier.name,
        email: supplier.email,
        phone: supplier.phone
      },
      status: 'draft',
      items: items,
      totalValue: totalValue,
      notes: notes,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    console.log('üì¶ Utworzone zam√≥wienie:', order);
    
    const existingIndex = window.purchaseOrders.findIndex(po => po.id === id);
    if (existingIndex >= 0) {
      window.purchaseOrders[existingIndex] = order;
      console.log('‚úèÔ∏è Zaktualizowano zam√≥wienie na pozycji', existingIndex);
      showWarehouseToast('‚úÖ Zam√≥wienie zaktualizowane', 'success');
    } else {
      window.purchaseOrders.push(order);
      console.log('‚ûï Dodano nowe zam√≥wienie. ≈ÅƒÖcznie:', window.purchaseOrders.length);
      showWarehouseToast('‚úÖ Zam√≥wienie utworzone', 'success');
    }
    
    savePurchaseData();
    closeModal();
    renderPurchaseOrders();
  }
  
  // Wy≈õwietl szczeg√≥≈Çy zam√≥wienia
  function viewPurchaseOrder(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    const statusLabels = {
      draft: 'üìù Robocze',
      sent: 'üì§ Wys≈Çane',
      confirmed: '‚úÖ Potwierdzone',
      received: 'üì¶ Odebrane'
    };
    
    const itemsHtml = (order.items || []).map(item => `
      <tr>
        <td>${escapeHtml(item.itemName)}</td>
        <td style="text-align:center">${item.quantity} ${item.unit}</td>
        <td style="text-align:right">${item.unitPrice.toFixed(2)} z≈Ç</td>
        <td style="text-align:right;font-weight:600">${item.total.toFixed(2)} z≈Ç</td>
      </tr>
    `).join('');
    
    const content = `
      <div style="margin-bottom:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div>
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">Numer</div>
            <div style="font-size:18px;font-weight:700">${escapeHtml(order.number)}</div>
          </div>
          <div>
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">Data</div>
            <div style="font-size:18px;font-weight:700">${new Date(order.date).toLocaleDateString('pl-PL')}</div>
          </div>
          <div>
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">Dostawca</div>
            <div style="font-size:16px;font-weight:600">${escapeHtml(order.supplier.name)}</div>
            ${order.supplier.email ? `<div style="font-size:14px;color:#64748b">üìß ${escapeHtml(order.supplier.email)}</div>` : ''}
            ${order.supplier.phone ? `<div style="font-size:14px;color:#64748b">üì± ${escapeHtml(order.supplier.phone)}</div>` : ''}
          </div>
          <div>
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">Status</div>
            <div style="font-size:16px;font-weight:600">${statusLabels[order.status]}</div>
          </div>
        </div>
        
        ${order.notes ? `
          <div style="padding:12px;background:#f8fafc;border-left:4px solid #3b82f6;border-radius:4px;margin-bottom:16px">
            <div style="font-size:12px;color:#64748b;margin-bottom:4px">Notatki</div>
            <div>${escapeHtml(order.notes)}</div>
          </div>
        ` : ''}
        
        <div style="margin-bottom:12px">
          <h4 style="margin:0 0 12px 0">Pozycje zam√≥wienia</h4>
          <div class="table">
            <table>
              <thead>
                <tr>
                  <th>Materia≈Ç</th>
                  <th style="text-align:center">Ilo≈õƒá</th>
                  <th style="text-align:right">Cena jedn.</th>
                  <th style="text-align:right">Razem</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
              <tfoot>
                <tr style="font-weight:700;font-size:16px">
                  <td colspan="3" style="text-align:right;padding-top:12px;border-top:2px solid #e2e8f0">RAZEM:</td>
                  <td style="text-align:right;padding-top:12px;border-top:2px solid #e2e8f0">${order.totalValue.toFixed(2)} z≈Ç</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    `;
    
    const buttons = [];
    
    if (order.status === 'draft') {
      buttons.push({
        label: '‚úèÔ∏è Edytuj',
        className: 'btn blue',
        onClick: () => { closeModal(); createPurchaseOrderModal(orderId); }
      });
      buttons.push({
        label: 'üì§ Wy≈õlij zam√≥wienie',
        className: 'btn green',
        onClick: () => { closeModal(); sendPurchaseOrder(orderId); }
      });
    }
    
    if (order.status === 'sent' || order.status === 'confirmed') {
      buttons.push({
        label: 'üì¶ Potwierd≈∫ odbi√≥r',
        className: 'btn green',
        onClick: () => { closeModal(); receivePurchaseOrder(orderId); }
      });
    }
    
    buttons.push({
      label: 'üóëÔ∏è Usu≈Ñ',
      className: 'btn',
      style: 'background:#dc2626;color:white',
      onClick: () => { 
        if (confirm('Czy na pewno usunƒÖƒá to zam√≥wienie?')) {
          deletePurchaseOrder(orderId);
          closeModal();
        }
      }
    });
    
    buttons.push({
      label: '‚úï Zamknij',
      className: 'btn',
      onClick: () => closeModal()
    });
    
    showModal(`üìã Zam√≥wienie ${order.number}`, content, buttons);
  }
  
  // Usu≈Ñ zam√≥wienie
  function deletePurchaseOrder(orderId) {
    window.purchaseOrders = window.purchaseOrders.filter(po => po.id !== orderId);
    savePurchaseData();
    renderPurchaseOrders();
    showWarehouseToast('üóëÔ∏è Zam√≥wienie usuniƒôte', 'info');
  }
  
  // Wy≈õlij zam√≥wienie
  function sendPurchaseOrder(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    const content = `
      <div style="margin-bottom:20px">
        <p>Wybierz spos√≥b wysy≈Çki zam√≥wienia <strong>${order.number}</strong> do dostawcy <strong>${escapeHtml(order.supplier.name)}</strong>:</p>
      </div>
    `;
    
    const buttons = [
      {
        label: 'üñ®Ô∏è Drukuj',
        className: 'btn blue',
        onClick: () => { printPurchaseOrder(orderId); closeModal(); }
      },
      {
        label: 'üìß Email',
        className: 'btn green',
        onClick: () => { sendPurchaseOrderEmail(orderId); closeModal(); }
      },
      {
        label: 'üì± SMS',
        className: 'btn',
        style: 'background:#f59e0b;color:white',
        onClick: () => { sendPurchaseOrderSMS(orderId); closeModal(); }
      },
      {
        label: 'üí¨ WhatsApp',
        className: 'btn',
        style: 'background:#25D366;color:white',
        onClick: () => { sendPurchaseOrderWhatsApp(orderId); closeModal(); }
      },
      {
        label: '‚úï Anuluj',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal('üì§ Wysy≈Çka zam√≥wienia', content, buttons);
  }
  
  // Drukuj zam√≥wienie
  function printPurchaseOrder(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    const itemsHtml = order.items.map(item => `
      <tr>
        <td>${escapeHtml(item.itemName)}</td>
        <td style="text-align:center">${item.quantity} ${item.unit}</td>
        <td style="text-align:right">${item.unitPrice.toFixed(2)} z≈Ç</td>
        <td style="text-align:right">${item.total.toFixed(2)} z≈Ç</td>
      </tr>
    `).join('');
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Zam√≥wienie ${order.number}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 40px; }
          h1 { color: #0f172a; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
          th { background: #f1f5f9; font-weight: 700; }
          .total { font-size: 18px; font-weight: 700; text-align: right; margin-top: 20px; }
          .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
          .info { margin-bottom: 10px; }
        </style>
      </head>
      <body>
        <div class="header">
          <div>
            <h1>ZAM√ìWIENIE ZAKUPOWE</h1>
            <div class="info"><strong>Numer:</strong> ${order.number}</div>
            <div class="info"><strong>Data:</strong> ${new Date(order.date).toLocaleDateString('pl-PL')}</div>
          </div>
          <div style="text-align:right">
            <h3>Dostawca:</h3>
            <div class="info">${escapeHtml(order.supplier.name)}</div>
            ${order.supplier.email ? `<div class="info">üìß ${escapeHtml(order.supplier.email)}</div>` : ''}
            ${order.supplier.phone ? `<div class="info">üì± ${escapeHtml(order.supplier.phone)}</div>` : ''}
          </div>
        </div>
        
        ${order.notes ? `<div style="padding:12px;background:#f8fafc;border-left:4px solid #3b82f6;margin-bottom:20px"><strong>Notatki:</strong><br>${escapeHtml(order.notes)}</div>` : ''}
        
        <table>
          <thead>
            <tr>
              <th>Materia≈Ç</th>
              <th style="text-align:center">Ilo≈õƒá</th>
              <th style="text-align:right">Cena jedn.</th>
              <th style="text-align:right">Warto≈õƒá</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHtml}
          </tbody>
        </table>
        
        <div class="total">RAZEM: ${order.totalValue.toFixed(2)} z≈Ç</div>
        
        <div style="margin-top:60px;border-top:2px solid #e2e8f0;padding-top:20px">
          <div style="font-size:12px;color:#64748b">
            Wygenerowano: ${new Date().toLocaleString('pl-PL')}
          </div>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
    
    // Zmie≈Ñ status na wys≈Çane
    order.status = 'sent';
    order.sentDate = new Date().toISOString();
    savePurchaseData();
    renderPurchaseOrders();
    showWarehouseToast('üñ®Ô∏è Zam√≥wienie przygotowane do druku', 'success');
  }
  
  // Wy≈õlij email
  function sendPurchaseOrderEmail(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    if (!order.supplier.email) {
      alert('Dostawca nie ma adresu email');
      return;
    }
    
    const itemsList = order.items.map(item => 
      `${item.itemName} - ${item.quantity} ${item.unit} x ${item.unitPrice.toFixed(2)} z≈Ç = ${item.total.toFixed(2)} z≈Ç`
    ).join('\n');
    
    const body = `Dzie≈Ñ dobry,\n\nPrzesy≈Çamy zam√≥wienie nr ${order.number} z dnia ${new Date(order.date).toLocaleDateString('pl-PL')}.\n\nPozycje zam√≥wienia:\n${itemsList}\n\nWarto≈õƒá ca≈Çkowita: ${order.totalValue.toFixed(2)} z≈Ç\n\n${order.notes ? `Uwagi:\n${order.notes}\n\n` : ''}Pozdrawiamy`;
    
    const mailtoLink = `mailto:${order.supplier.email}?subject=Zam√≥wienie ${order.number}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
    
    order.status = 'sent';
    order.sentDate = new Date().toISOString();
    savePurchaseData();
    renderPurchaseOrders();
    showWarehouseToast('üìß Otwarto klienta email', 'success');
  }
  
  // Wy≈õlij SMS
  function sendPurchaseOrderSMS(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    if (!order.supplier.phone) {
      alert('Dostawca nie ma numeru telefonu');
      return;
    }
    
    const message = `Zam√≥wienie ${order.number}: ${order.items.length} poz., ${order.totalValue.toFixed(2)} z≈Ç. Potwierdzenie?`;
    const smsLink = `sms:${order.supplier.phone}?body=${encodeURIComponent(message)}`;
    window.location.href = smsLink;
    
    order.status = 'sent';
    order.sentDate = new Date().toISOString();
    savePurchaseData();
    renderPurchaseOrders();
    showWarehouseToast('üì± Otwarto aplikacjƒô SMS', 'success');
  }
  
  // Wy≈õlij przez WhatsApp
  function sendPurchaseOrderWhatsApp(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    if (!order.supplier.phone) {
      alert('Dostawca nie ma numeru telefonu');
      return;
    }
    
    // Sformatuj numer telefonu (usu≈Ñ spacje, my≈õlniki, nawiasy)
    let phone = order.supplier.phone.replace(/[\s\-\(\)]/g, '');
    
    // Je≈õli numer zaczyna siƒô od +48, zostaw +
    // Je≈õli zaczyna siƒô od 0, zamie≈Ñ na +48
    if (phone.startsWith('0')) {
      phone = '+48' + phone.substring(1);
    } else if (!phone.startsWith('+')) {
      phone = '+48' + phone;
    }
    
    // Formatuj wiadomo≈õƒá
    const itemsList = order.items.map(item => 
      `‚Ä¢ ${item.itemName} - ${item.quantity} ${item.unit} √ó ${item.unitPrice.toFixed(2)} z≈Ç`
    ).join('%0A');
    
    const message = `*Zam√≥wienie ${order.number}*%0A` +
                   `üìÖ ${new Date(order.date).toLocaleDateString('pl-PL')}%0A%0A` +
                   `üì¶ *Pozycje:*%0A${itemsList}%0A%0A` +
                   `üí∞ *Warto≈õƒá: ${order.totalValue.toFixed(2)} z≈Ç*%0A%0A` +
                   (order.notes ? `üìù ${order.notes}%0A%0A` : '') +
                   `‚úÖ Proszƒô o potwierdzenie przyjƒôcia zam√≥wienia.`;
    
    // Link WhatsApp Web lub aplikacja
    const whatsappLink = `https://wa.me/${phone}?text=${message}`;
    window.open(whatsappLink, '_blank');
    
    order.status = 'sent';
    order.sentDate = new Date().toISOString();
    savePurchaseData();
    renderPurchaseOrders();
    showWarehouseToast('üí¨ Otwarto WhatsApp', 'success');
  }
  
  // Wy≈õlij przez Telegram
  async function sendPurchaseOrderTelegram(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    // Pobierz token bota i chat ID dostawcy
    const botToken = localStorage.getItem('telegram_bot_token');
    const supplierTelegramId = order.supplier.telegramChatId;
    
    if (!botToken) {
      const token = prompt('Podaj TOKEN Telegram Bota (otrzymasz go od @BotFather):\n\nInstrukcja:\n1. Otw√≥rz Telegram\n2. Wyszukaj @BotFather\n3. Wy≈õlij /newbot\n4. Skopiuj otrzymany token');
      if (token) {
        localStorage.setItem('telegram_bot_token', token);
        sendPurchaseOrderTelegram(orderId);
      }
      return;
    }
    
    if (!supplierTelegramId) {
      alert(`Dostawca ${order.supplier.name} nie ma przypisanego Telegram ID.\n\nInstrukcja:\n1. Dostawca musi wys≈Çaƒá /start do Twojego bota\n2. Bot automatycznie zapisze jego ID\n3. Lub dodaj rƒôcznie w edycji dostawcy`);
      return;
    }
    
    // Formatuj wiadomo≈õƒá
    const itemsList = order.items.map(item => 
      `‚Ä¢ ${item.itemName} - ${item.quantity} ${item.unit} √ó ${item.unitPrice.toFixed(2)} z≈Ç = ${item.total.toFixed(2)} z≈Ç`
    ).join('\n');
    
    const message = `
üõí *Zam√≥wienie ${order.number}*
üìÖ Data: ${new Date(order.date).toLocaleDateString('pl-PL')}

üì¶ *Pozycje:*
${itemsList}

üí∞ *Warto≈õƒá: ${order.totalValue.toFixed(2)} z≈Ç*

${order.notes ? `üìù Uwagi:\n${order.notes}\n\n` : ''}‚úÖ Proszƒô o potwierdzenie przyjƒôcia zam√≥wienia.
    `.trim();
    
    try {
      const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: supplierTelegramId,
          text: message,
          parse_mode: 'Markdown'
        })
      });
      
      const result = await response.json();
      
      if (result.ok) {
        order.status = 'sent';
        order.sentDate = new Date().toISOString();
        savePurchaseData();
        renderPurchaseOrders();
        showWarehouseToast('‚úÖ Zam√≥wienie wys≈Çane przez Telegram', 'success');
      } else {
        console.error('Telegram API error:', result);
        alert(`B≈ÇƒÖd wysy≈Çki: ${result.description || 'Nieznany b≈ÇƒÖd'}\n\nSprawd≈∫:\n1. Czy token jest poprawny\n2. Czy Chat ID jest prawid≈Çowe\n3. Czy bot nie zosta≈Ç zablokowany przez u≈ºytkownika`);
      }
    } catch (error) {
      console.error('Telegram send error:', error);
      alert('B≈ÇƒÖd po≈ÇƒÖczenia z Telegram. Sprawd≈∫ po≈ÇƒÖczenie internetowe.');
    }
  }
  
  // Potwierd≈∫ odbi√≥r dostawy
  function receivePurchaseOrder(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    const itemsHtml = order.items.map(item => `
      <div class="card" style="margin-bottom:12px;background:#f8fafc">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;align-items:center">
          <div>
            <div style="font-weight:600">${escapeHtml(item.itemName)}</div>
            <div style="font-size:12px;color:#64748b">Zam√≥wiono: ${item.quantity} ${item.unit}</div>
          </div>
          <div>
            <label style="font-size:12px;color:#64748b">Odebrano</label>
            <input type="number" class="receive-quantity" data-item-id="${item.itemId}" value="${item.quantity}" min="0" step="0.1" style="width:100%">
          </div>
          <div>
            <span class="receive-unit">${item.unit}</span>
          </div>
        </div>
      </div>
    `).join('');
    
    const content = `
      <div style="margin-bottom:20px">
        <p>Potwierd≈∫ faktycznie odebrane ilo≈õci materia≈Ç√≥w z zam√≥wienia <strong>${order.number}</strong>:</p>
      </div>
      <div id="receive-items-list">
        ${itemsHtml}
      </div>
      <div style="margin-top:20px;padding:12px;background:#dcfce7;border-left:4px solid #16a34a;border-radius:4px">
        <div style="font-size:14px;color:#166534">
          ‚úÖ Po potwierdzeniu materia≈Çy zostanƒÖ automatycznie dodane do magazynu (transakcja PZ)
        </div>
      </div>
    `;
    
    const buttons = [
      {
        label: '‚úÖ Potwierd≈∫ odbi√≥r',
        className: 'btn green',
        onClick: () => confirmReceivePurchaseOrder(orderId)
      },
      {
        label: '‚úï Anuluj',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal('üì¶ Odbi√≥r dostawy', content, buttons);
  }
  
  // Potwierd≈∫ i dodaj do magazynu
  function confirmReceivePurchaseOrder(orderId) {
    const order = window.purchaseOrders.find(po => po.id === orderId);
    if (!order) return;
    
    const receivedItems = [];
    
    document.querySelectorAll('.receive-quantity').forEach(input => {
      const itemId = input.dataset.itemId;
      const quantity = parseFloat(input.value) || 0;
      
      if (quantity > 0) {
        const orderItem = order.items.find(i => i.itemId === itemId);
        if (orderItem) {
          receivedItems.push({
            itemId: itemId,
            itemName: orderItem.itemName,
            quantity: quantity,
            unit: orderItem.unit
          });
        }
      }
    });
    
    if (receivedItems.length === 0) {
      alert('Wprowad≈∫ odebrane ilo≈õci');
      return;
    }
    
    // Dodaj do magazynu
    const newMaterialsCreated = [];
    receivedItems.forEach(item => {
      const warehouseItem = (window.warehouseItems || []).find(wi => wi.id === item.itemId);
      if (warehouseItem) {
        // Materia≈Ç istnieje - zwiƒôksz ilo≈õƒá
        warehouseItem.quantity = (warehouseItem.quantity || 0) + item.quantity;
        warehouseItem.lastUpdated = new Date().toISOString();
      } else {
        // Materia≈Ç nie istnieje - utw√≥rz nowy
        const newItem = {
          id: item.itemId,
          name: item.itemName,
          quantity: item.quantity,
          unit: item.unit,
          category: 'Surowce',
          minQuantity: 0,
          location: 'Magazyn g≈Ç√≥wny',
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          notes: `Utworzono automatycznie przy odbiorze zam√≥wienia ${order.number}`
        };
        window.warehouseItems.push(newItem);
        newMaterialsCreated.push(item.itemName);
        console.log(`‚úÖ Utworzono nowy materia≈Ç w magazynie: ${item.itemName}`);
      }
    });
    
    // Utw√≥rz transakcjƒô PZ
    if (!window.warehouseTransactions) window.warehouseTransactions = [];
    
    window.warehouseTransactions.push({
      id: 'trans-' + Date.now(),
      type: 'PZ',
      date: new Date().toISOString(),
      documentNumber: order.number,
      items: receivedItems,
      notes: `Odbi√≥r dostawy z zam√≥wienia ${order.number}`,
      createdAt: new Date().toISOString()
    });
    
    // Aktualizuj status zam√≥wienia
    order.status = 'received';
    order.receivedDate = new Date().toISOString();
    order.receivedItems = receivedItems;
    
    // Zapisz
    saveWarehouseToStorage();
    savePurchaseData();
    
    closeModal();
    renderPurchaseOrders();
    
    // Komunikat o sukcesie
    let message = `‚úÖ Odebrano dostawƒô - zaktualizowano ${receivedItems.length} pozycji w magazynie`;
    if (newMaterialsCreated.length > 0) {
      message += `\n\nüÜï Utworzono nowe materia≈Çy:\n‚Ä¢ ${newMaterialsCreated.join('\n‚Ä¢ ')}`;
    }
    showWarehouseToast(message, 'success');
  }
  
  // ========== DOSTAWCY ==========
  
  // Renderuj listƒô dostawc√≥w
  function renderSuppliers() {
    const list = document.getElementById('suppliers-list');
    if (!list) return;
    
    const suppliers = window.suppliers || [];
    
    if (suppliers.length === 0) {
      list.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#64748b">
          <div style="font-size:64px;margin-bottom:16px">üë•</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px">Brak dostawc√≥w</div>
          <div style="font-size:14px;margin-bottom:20px">Dodaj pierwszego dostawcƒô do bazy</div>
          <button class="btn green" onclick="createSupplierModal()">‚ûï Dodaj dostawcƒô</button>
        </div>
      `;
      return;
    }
    
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px">';
    
    suppliers.forEach(supplier => {
      const ordersCount = window.purchaseOrders.filter(po => po.supplier.id === supplier.id).length;
      
      html += `
        <div class="card" style="cursor:pointer;transition:all 0.2s" onclick="viewSupplier('${supplier.id}')" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow=''">
          <div style="margin-bottom:12px">
            <div style="font-size:18px;font-weight:700;color:white;margin-bottom:4px">
              ${escapeHtml(supplier.name)}
            </div>
            ${supplier.category ? `<div style="font-size:12px;color:#64748b">üìÅ ${escapeHtml(supplier.category)}</div>` : ''}
          </div>
          
          ${supplier.email ? `<div style="font-size:14px;color:#64748b;margin-bottom:4px">üìß ${escapeHtml(supplier.email)}</div>` : ''}
          ${supplier.phone ? `<div style="font-size:14px;color:#64748b;margin-bottom:4px">üì± ${escapeHtml(supplier.phone)}</div>` : ''}
          
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:14px;color:#64748b">
            üìù ${ordersCount} ${ordersCount === 1 ? 'zam√≥wienie' : ordersCount < 5 ? 'zam√≥wienia' : 'zam√≥wie≈Ñ'}
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    list.innerHTML = html;
    
    // Aktualizuj badge
    const badge = document.getElementById('mrp-suppliers-badge');
    if (badge) {
      badge.textContent = suppliers.length;
      badge.style.display = suppliers.length > 0 ? 'inline' : 'none';
    }
  }
  
  // Modal tworzenia/edycji dostawcy
  function createSupplierModal(supplierId = null, returnToPO = false) {
    const supplier = supplierId ? window.suppliers.find(s => s.id === supplierId) : null;
    const isEdit = !!supplier;
    
    const content = `
      <form id="supplier-form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div style="grid-column:1/-1">
          <label>Nazwa dostawcy *</label>
          <input type="text" id="supplier-name" value="${supplier?.name || ''}" required>
        </div>
        
        <div>
          <label>Kategoria</label>
          <input type="text" id="supplier-category" value="${supplier?.category || ''}" placeholder="np. Drewno, Akcesoria">
        </div>
        
        <div>
          <label>NIP</label>
          <input type="text" id="supplier-nip" value="${supplier?.nip || ''}">
        </div>
        
        <div>
          <label>Email</label>
          <input type="email" id="supplier-email" value="${supplier?.email || ''}">
        </div>
        
        <div>
          <label>Telefon</label>
          <input type="tel" id="supplier-phone" value="${supplier?.phone || ''}">
        </div>
        
        <div style="grid-column:1/-1">
          <label>üí¨ Telegram Chat ID <span style="font-size:12px;color:#64748b">(opcjonalne - dostawca musi wys≈Çaƒá /start do bota)</span></label>
          <input type="text" id="supplier-telegram" value="${supplier?.telegramChatId || ''}" placeholder="np. 123456789">
        </div>
        
        <div style="grid-column:1/-1">
          <label>Adres</label>
          <textarea id="supplier-address" rows="2">${supplier?.address || ''}</textarea>
        </div>
        
        <div style="grid-column:1/-1">
          <label>Notatki</label>
          <textarea id="supplier-notes" rows="3">${supplier?.notes || ''}</textarea>
        </div>
      </form>
    `;
    
    const buttons = [
      {
        label: 'üíæ Zapisz',
        className: 'btn green',
        onClick: () => saveSupplier(supplierId, returnToPO)
      },
      {
        label: '‚úï Anuluj',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal(isEdit ? '‚úèÔ∏è Edycja dostawcy' : '‚ûï Nowy dostawca', content, buttons);
  }
  
  // Zapisz dostawcƒô
  function saveSupplier(supplierId = null, returnToPO = false) {
    console.log('üîç saveSupplier wywo≈Çane:', { supplierId, returnToPO });
    
    const name = document.getElementById('supplier-name').value.trim();
    const category = document.getElementById('supplier-category').value.trim();
    const nip = document.getElementById('supplier-nip').value.trim();
    const email = document.getElementById('supplier-email').value.trim();
    const phone = document.getElementById('supplier-phone').value.trim();
    const telegramChatId = document.getElementById('supplier-telegram').value.trim();
    const address = document.getElementById('supplier-address').value.trim();
    const notes = document.getElementById('supplier-notes').value.trim();
    
    console.log('üìù Dane formularza:', { name, category, email, phone, telegramChatId });
    
    if (!name) {
      alert('Podaj nazwƒô dostawcy');
      return;
    }
    
    if (supplierId) {
      // Edycja
      const supplier = window.suppliers.find(s => s.id === supplierId);
      if (supplier) {
        supplier.name = name;
        supplier.category = category;
        supplier.nip = nip;
        supplier.email = email;
        supplier.phone = phone;
        supplier.telegramChatId = telegramChatId;
        supplier.address = address;
        supplier.notes = notes;
        supplier.updatedAt = new Date().toISOString();
      }
    } else {
      // Nowy
      const supplier = {
        id: 'sup-' + Date.now(),
        name: name,
        category: category,
        nip: nip,
        email: email,
        phone: phone,
        telegramChatId: telegramChatId,
        address: address,
        notes: notes,
        createdAt: new Date().toISOString()
      };
      console.log('‚ûï Dodawanie nowego dostawcy:', supplier);
      window.suppliers.push(supplier);
      console.log('üì¶ Aktualna lista dostawc√≥w:', window.suppliers.length);
    }
    
    console.log('üíæ Zapisywanie danych...');
    savePurchaseData();
    
    console.log('üö™ Zamykanie modala...');
    closeModal();
    
    if (returnToPO) {
      createPurchaseOrderModal();
    } else {
      renderSuppliers();
    }
    
    showWarehouseToast(`‚úÖ ${supplierId ? 'Zaktualizowano' : 'Dodano'} dostawcƒô: ${name}`, 'success');
  }
  
  // Wy≈õwietl szczeg√≥≈Çy dostawcy
  function viewSupplier(supplierId) {
    const supplier = window.suppliers.find(s => s.id === supplierId);
    if (!supplier) return;
    
    const orders = window.purchaseOrders.filter(po => po.supplier.id === supplierId);
    const totalValue = orders.reduce((sum, po) => sum + (po.totalValue || 0), 0);
    
    const ordersHtml = orders.length > 0 ? `
      <div style="margin-top:20px">
        <h4>Historia zam√≥wie≈Ñ (${orders.length})</h4>
        ${orders.map(po => `
          <div class="card" style="margin-bottom:8px;cursor:pointer" onclick="viewPurchaseOrder('${po.id}')">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:600">${escapeHtml(po.number)}</div>
                <div style="font-size:12px;color:#64748b">${new Date(po.date).toLocaleDateString('pl-PL')}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:600">${po.totalValue.toFixed(2)} z≈Ç</div>
                <div style="font-size:12px;color:#64748b">${po.status}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    ` : '<div style="margin-top:20px;color:#64748b;text-align:center">Brak zam√≥wie≈Ñ</div>';
    
    const content = `
      <div style="margin-bottom:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          ${supplier.category ? `<div><div style="font-size:12px;color:#64748b">Kategoria</div><div>${escapeHtml(supplier.category)}</div></div>` : ''}
          ${supplier.nip ? `<div><div style="font-size:12px;color:#64748b">NIP</div><div>${escapeHtml(supplier.nip)}</div></div>` : ''}
          ${supplier.email ? `<div><div style="font-size:12px;color:#64748b">Email</div><div>${escapeHtml(supplier.email)}</div></div>` : ''}
          ${supplier.phone ? `<div><div style="font-size:12px;color:#64748b">Telefon</div><div>${escapeHtml(supplier.phone)}</div></div>` : ''}
          ${supplier.address ? `<div style="grid-column:1/-1"><div style="font-size:12px;color:#64748b">Adres</div><div>${escapeHtml(supplier.address)}</div></div>` : ''}
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px">
          <div>
            <div style="font-size:12px;color:#64748b">Liczba zam√≥wie≈Ñ</div>
            <div style="font-size:24px;font-weight:700">${orders.length}</div>
          </div>
          <div>
            <div style="font-size:12px;color:#64748b">≈ÅƒÖczna warto≈õƒá</div>
            <div style="font-size:24px;font-weight:700">${totalValue.toFixed(2)} z≈Ç</div>
          </div>
        </div>
        
        ${ordersHtml}
      </div>
    `;
    
    const buttons = [
      {
        label: '‚úèÔ∏è Edytuj',
        className: 'btn blue',
        onClick: () => {
          closeModal();
          createSupplierModal(supplierId);
        }
      },
      {
        label: 'üóëÔ∏è Usu≈Ñ',
        className: 'btn',
        style: 'background:#dc2626;color:white',
        onClick: () => {
          if (orders.length > 0) {
            alert('Nie mo≈ºna usunƒÖƒá dostawcy z istniejƒÖcymi zam√≥wieniami');
            return;
          }
          if (confirm(`Czy na pewno usunƒÖƒá dostawcƒô: ${supplier.name}?`)) {
            deleteSupplier(supplierId);
            closeModal();
          }
        }
      },
      {
        label: '‚úï Zamknij',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal(`üë§ ${supplier.name}`, content, buttons);
  }
  
  // Usu≈Ñ dostawcƒô
  function deleteSupplier(supplierId) {
    window.suppliers = window.suppliers.filter(s => s.id !== supplierId);
    savePurchaseData();
    renderSuppliers();
    showWarehouseToast('üóëÔ∏è Dostawca usuniƒôty', 'info');
  }
  
  // Udostƒôpnij funkcje globalnie
  window.addShortageToShoppingList = addShortageToShoppingList;
  window.exportMRPToCSV = exportMRPToCSV;
  window.switchMRPTab = switchMRPTab;
  window.filterPurchaseOrders = filterPurchaseOrders;
  window.loadPurchaseData = loadPurchaseData;
  window.createPurchaseOrderModal = createPurchaseOrderModal;
  window.viewPurchaseOrder = viewPurchaseOrder;
  window.addPOItem = addPOItem;
  window.removePOItem = removePOItem;
  window.calculatePOTotal = calculatePOTotal;
  window.updatePOItemName = updatePOItemName;
  window.savePurchaseOrder = savePurchaseOrder;
  window.deletePurchaseOrder = deletePurchaseOrder;
  window.sendPurchaseOrder = sendPurchaseOrder;
  window.receivePurchaseOrder = receivePurchaseOrder;
  window.confirmReceivePurchaseOrder = confirmReceivePurchaseOrder;
  window.renderSuppliers = renderSuppliers;
  window.createSupplierModal = createSupplierModal;
  window.saveSupplier = saveSupplier;
  window.viewSupplier = viewSupplier;
  window.deleteSupplier = deleteSupplier;
  window.renderPurchaseOrders = renderPurchaseOrders;
  window.renderPODashboard = renderPODashboard;
  window.savePurchaseData = savePurchaseData;
  window.generatePONumber = generatePONumber;
  window.sendPurchaseOrderTelegram = sendPurchaseOrderTelegram;
  window.sendPurchaseOrderWhatsApp = sendPurchaseOrderWhatsApp;
  
  // Panel zarzƒÖdzania Telegram Bot
  function setupTelegramBot() {
    const currentToken = localStorage.getItem('telegram_bot_token') || '';
    
    const content = `
      <div style="margin-bottom:16px;padding:10px;background:#f8fafc;border-radius:6px">
        <div style="font-size:13px;color:#475569;line-height:1.6">
          üìñ <strong>Szybka instrukcja:</strong> Telegram ‚Üí <code>@BotFather</code> ‚Üí <code>/newbot</code> ‚Üí Skopiuj token
        </div>
      </div>
      
      <div style="margin-bottom:16px">
        <label style="font-weight:600;display:block;margin-bottom:6px">Token Bota:</label>
        <input type="text" id="telegram-token-input" value="${currentToken}" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" style="width:100%;padding:10px;font-family:monospace;font-size:13px;border:2px solid #e2e8f0;border-radius:6px">
      </div>
      
      ${currentToken ? `
        <div style="padding:10px;background:#dcfce7;border-left:4px solid #16a34a;border-radius:4px;margin-bottom:12px;font-size:13px;color:#166534">
          ‚úÖ Bot skonfigurowany! Dostawcy: wy≈õlij <code>/start</code> do bota
        </div>
      ` : `
        <div style="padding:10px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:4px;margin-bottom:12px;font-size:13px;color:#92400e">
          ‚ö†Ô∏è Najpierw wklej token z @BotFather
        </div>
      `}
    `;
    
    const buttons = [
      {
        label: 'üíæ Zapisz token',
        className: 'btn green',
        onClick: () => {
          const token = document.getElementById('telegram-token-input').value.trim();
          if (token) {
            localStorage.setItem('telegram_bot_token', token);
            showWarehouseToast('‚úÖ Token Telegram Bot zapisany', 'success');
            updateTelegramBotStatus();
            closeModal();
          } else {
            alert('Podaj token bota');
          }
        }
      },
      {
        label: 'üóëÔ∏è Usu≈Ñ konfiguracjƒô',
        className: 'btn',
        style: 'background:#dc2626;color:white',
        onClick: () => {
          if (confirm('Czy na pewno usunƒÖƒá konfiguracjƒô Telegram Bot?')) {
            localStorage.removeItem('telegram_bot_token');
            showWarehouseToast('üóëÔ∏è Konfiguracja usuniƒôta', 'info');
            updateTelegramBotStatus();
            closeModal();
          }
        }
      },
      {
        label: '‚úï Anuluj',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal('‚öôÔ∏è Konfiguracja Telegram Bot', content, buttons);
  }
  
  async function testTelegramBot() {
    const token = localStorage.getItem('telegram_bot_token');
    
    if (!token) {
      alert('Najpierw skonfiguruj bota');
      setupTelegramBot();
      return;
    }
    
    try {
      const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
      const result = await response.json();
      
      if (result.ok) {
        const bot = result.result;
        alert(`‚úÖ Bot po≈ÇƒÖczony!\n\nNazwa: ${bot.first_name}\nUsername: @${bot.username}\n\nBot jest gotowy do wysy≈Çania powiadomie≈Ñ!`);
      } else {
        alert(`‚ùå B≈ÇƒÖd po≈ÇƒÖczenia:\n${result.description}\n\nSprawd≈∫ czy token jest poprawny.`);
      }
    } catch (error) {
      alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z Telegram API.\nSprawd≈∫ po≈ÇƒÖczenie internetowe.');
    }
  }
  
  function updateTelegramBotStatus() {
    const statusDiv = document.getElementById('telegram-bot-status');
    if (!statusDiv) return;
    
    const token = localStorage.getItem('telegram_bot_token');
    
    if (token) {
      // Sprawd≈∫ ile dostawc√≥w ma Chat ID
      const suppliersWithTelegram = (window.suppliers || []).filter(s => s.telegramChatId).length;
      const totalSuppliers = (window.suppliers || []).length;
      
      // Sprawd≈∫ ile Chat ID zebrano
      const chatIds = JSON.parse(localStorage.getItem('telegram_chat_ids') || '{}');
      const collectedIds = Object.keys(chatIds).length;
      
      statusDiv.innerHTML = `
        ‚úÖ Bot aktywny | 
        ${suppliersWithTelegram}/${totalSuppliers} dostawc√≥w ma Telegram | 
        üìã ${collectedIds} zebranych Chat ID
      `;
    } else {
      statusDiv.innerHTML = '‚ö†Ô∏è Bot nie jest skonfigurowany - kliknij "Konfiguruj"';
    }
  }
  
  window.setupTelegramBot = setupTelegramBot;
  window.testTelegramBot = testTelegramBot;
  window.updateTelegramBotStatus = updateTelegramBotStatus;
  
  // Automatyczne zbieranie Chat ID - webhook simulator
  let telegramPollingInterval = null;
  
  async function startTelegramPolling() {
    const token = localStorage.getItem('telegram_bot_token');
    if (!token) return;
    
    // Sprawd≈∫ aktualizacje co 5 sekund
    if (telegramPollingInterval) clearInterval(telegramPollingInterval);
    
    let lastUpdateId = parseInt(localStorage.getItem('telegram_last_update_id') || '0');
    
    telegramPollingInterval = setInterval(async () => {
      try {
        const response = await fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${lastUpdateId + 1}&timeout=5`);
        const result = await response.json();
        
        if (result.ok && result.result.length > 0) {
          for (const update of result.result) {
            lastUpdateId = update.update_id;
            
            // Sprawd≈∫ czy to komenda /start
            if (update.message && update.message.text === '/start') {
              const chatId = update.message.chat.id;
              const userName = update.message.chat.first_name || update.message.chat.username || 'U≈ºytkownik';
              
              // Zapisz Chat ID w localStorage
              const chatIds = JSON.parse(localStorage.getItem('telegram_chat_ids') || '{}');
              chatIds[chatId] = {
                chatId: chatId,
                name: userName,
                username: update.message.chat.username,
                firstName: update.message.chat.first_name,
                lastName: update.message.chat.last_name,
                timestamp: new Date().toISOString()
              };
              localStorage.setItem('telegram_chat_ids', JSON.stringify(chatIds));
              
              // Wy≈õlij odpowied≈∫ z Chat ID
              await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  chat_id: chatId,
                  text: `‚úÖ Witaj ${userName}!\n\nüÜî Twoje Chat ID: ${chatId}\n\nüìã Podaj ten numer administratorowi systemu Doors Planner, aby otrzymywaƒá powiadomienia o zam√≥wieniach.`,
                  parse_mode: 'Markdown'
                })
              });
              
              console.log('‚úÖ Nowy u≈ºytkownik Telegram:', userName, chatId);
              showWarehouseToast(`üì± Nowy u≈ºytkownik: ${userName} (${chatId})`, 'success');
              updateTelegramBotStatus();
            }
          }
          
          localStorage.setItem('telegram_last_update_id', lastUpdateId.toString());
        }
      } catch (error) {
        console.error('Telegram polling error:', error);
      }
    }, 5000);
    
    console.log('ü§ñ Telegram Bot nas≈Çuchuje wiadomo≈õci...');
  }
  
  function stopTelegramPolling() {
    if (telegramPollingInterval) {
      clearInterval(telegramPollingInterval);
      telegramPollingInterval = null;
      console.log('üõë Telegram Bot zatrzymany');
    }
  }
  
  // Funkcja do wy≈õwietlenia zebranych Chat ID
  function showTelegramChatIds() {
    const chatIds = JSON.parse(localStorage.getItem('telegram_chat_ids') || '{}');
    const entries = Object.values(chatIds);
    
    if (entries.length === 0) {
      alert('Brak zebranych Chat ID.\n\nU≈ºytkownicy muszƒÖ wys≈Çaƒá /start do bota.');
      return;
    }
    
    const list = entries.map(user => `
      <div class="card" style="margin-bottom:8px;padding:12px">
        <div style="font-weight:600;color:white;margin-bottom:4px">
          ${escapeHtml(user.name || user.username || 'U≈ºytkownik')}
        </div>
        <div style="font-size:13px;color:#64748b">
          üÜî Chat ID: <code style="background:#f1f5f9;padding:2px 6px;border-radius:3px">${user.chatId}</code>
        </div>
        <div style="font-size:12px;color:#94a3b8;margin-top:4px">
          ${new Date(user.timestamp).toLocaleString('pl-PL')}
        </div>
      </div>
    `).join('');
    
    const content = `
      <div style="margin-bottom:16px">
        <p>Znaleziono <strong>${entries.length}</strong> u≈ºytkownik√≥w, kt√≥rzy wys≈Çali /start do bota:</p>
      </div>
      ${list}
      <div style="margin-top:16px;padding:10px;background:#dbeafe;border-left:4px solid #3b82f6;border-radius:4px;font-size:13px;color:#1e40af">
        üí° Skopiuj Chat ID i wklej w formularzu dostawcy
      </div>
    `;
    
    const buttons = [
      {
        label: 'üóëÔ∏è Wyczy≈õƒá listƒô',
        className: 'btn',
        style: 'background:#dc2626;color:white',
        onClick: () => {
          if (confirm('Czy na pewno wyczy≈õciƒá listƒô zebranych Chat ID?')) {
            localStorage.removeItem('telegram_chat_ids');
            showWarehouseToast('üóëÔ∏è Lista wyczyszczona', 'info');
            closeModal();
          }
        }
      },
      {
        label: '‚úï Zamknij',
        className: 'btn',
        onClick: () => closeModal()
      }
    ];
    
    showModal('üì± Zebrane Chat ID z Telegram', content, buttons);
  }
  
  window.startTelegramPolling = startTelegramPolling;
  window.stopTelegramPolling = stopTelegramPolling;
  window.showTelegramChatIds = showTelegramChatIds;
  
  // Auto-start wy≈ÇƒÖczony - uruchom rƒôcznie przez startTelegramPolling() w konsoli
  // if (localStorage.getItem('telegram_bot_token')) {
  //   setTimeout(() => {
  //     startTelegramPolling();
  //   }, 2000);
  // }
  
  // Wczytaj dane przy starcie
  loadPurchaseData();

  // Monitoring: show simple metrics and detect candidate bottlenecks
  function renderMonitor(){
    const host = qs('#p-monitor'); if(!host) return;
    host.innerHTML = '';
  const header = document.createElement('div'); header.className='row'; header.style.justifyContent='space-between';
  const title = document.createElement('div'); title.innerHTML = '<h3>Monitoring postƒôp√≥w</h3>'; header.appendChild(title);
  const ctrl = document.createElement('div'); ctrl.className='row';
  const refreshBtn = document.createElement('button'); refreshBtn.className='btn'; refreshBtn.textContent='Od≈õwie≈º'; refreshBtn.addEventListener('click', ()=>{ renderMonitor(); });
  const exportBtn = document.createElement('button'); exportBtn.className='btn'; exportBtn.textContent='Eksport CSV'; exportBtn.style.marginLeft='6px';
  exportBtn.addEventListener('click', ()=>{ exportMonitorCSV(); });
  const filterInput = document.createElement('input'); filterInput.id='monitor-filter-input'; filterInput.placeholder='Filtruj operacje...'; filterInput.style.width='220px'; filterInput.style.marginLeft='8px';
  filterInput.value = qs('#monitor-filter-input')? qs('#monitor-filter-input').value : '';
  filterInput.addEventListener('input', ()=>{ renderMonitor(); });
  ctrl.appendChild(filterInput); ctrl.appendChild(refreshBtn); ctrl.appendChild(exportBtn);
  header.appendChild(ctrl);
  host.appendChild(header);

    const totalOrders = (state.orders||[]).length;
    const totalTasks = (state.tasks||[]).length;
    const running = (state.tasks||[]).filter(t=>t.status==='run').length;
    const todo = (state.tasks||[]).filter(t=>!t.status || t.status==='todo').length;

    const metrics = document.createElement('div'); metrics.className='grid3'; metrics.style.marginTop='8px';
    metrics.innerHTML = `<div class="card"><div><b>Zlecenia</b></div><div class="pill">${totalOrders}</div></div><div class="card"><div><b>Zadania</b></div><div class="pill">${totalTasks}</div></div><div class="card"><div><b>W toku / oczekujƒÖce</b></div><div class="muted">run: ${running} ‚Ä¢ todo: ${todo}</div></div>`;
    host.appendChild(metrics);

    const opStats = new Map();
    (state.operationsCatalog||[]).forEach(op=>{ opStats.set(op.name, { name: op.name, id: op.id, countTodo:0, countRun:0, totalEst:0, totalElapsed:0, avgElapsed:0 }); });
    (state.tasks||[]).forEach(t=>{
      const key = t.opName || '(unknown)';
      if(!opStats.has(key)) opStats.set(key, { name:key, id:null, countTodo:0, countRun:0, totalEst:0, totalElapsed:0, avgElapsed:0 });
      const s = opStats.get(key);
      if(t.status==='run') s.countRun++; else s.countTodo++;
      s.totalEst += (t.estMin||0);
      s.totalElapsed += (t.elapsedMin||0);
    });
    opStats.forEach(s=>{ const totalCount = s.countRun + s.countTodo; s.avgElapsed = totalCount? Math.round(s.totalElapsed/Math.max(1,totalCount)) : 0; });
    const statArr = Array.from(opStats.values()).filter(s=> (s.countRun + s.countTodo) > 0 );
    statArr.sort((a,b)=> (b.countRun + b.countTodo) - (a.countRun + a.countTodo) || b.avgElapsed - a.avgElapsed);
  const filterVal = (qs('#monitor-filter-input') && qs('#monitor-filter-input').value) ? (qs('#monitor-filter-input').value||'').toLowerCase() : '';
  const filtered = filterVal ? statArr.filter(s=> (s.name||'').toLowerCase().indexOf(filterVal)!==-1) : statArr;
  const top = filtered.slice(0,10);
    const tableWrap = document.createElement('div'); tableWrap.className='table'; tableWrap.style.marginTop='12px';
    const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Operacja</th><th>W kolejce</th><th>W toku</th><th>Est. sum</th><th>≈ör. elapsed [m]</th></tr></thead><tbody></tbody>`;
    const tb = tbl.querySelector('tbody');
    top.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${s.name}</td><td>${s.countTodo}</td><td>${s.countRun}</td><td>${s.totalEst}</td><td>${s.avgElapsed}</td>`; tb.appendChild(tr); });
    tableWrap.appendChild(tbl);
    host.appendChild(tableWrap);
    tableWrap.appendChild(tbl);
    host.appendChild(tableWrap);

    const sugg = document.createElement('div'); sugg.style.marginTop='10px';
    const threshold = (state.storage && state.storage.monitorThreshold) ? Number(state.storage.monitorThreshold) : 5;
    const heavy = statArr.filter(s=> (s.countTodo + s.countRun) >= threshold );
    if(heavy.length){
      sugg.innerHTML = `<div class="card err"><b>Potencjalne wƒÖskie gard≈Ça:</b><div style="margin-top:6px">${heavy.map(s=>`${s.name} ‚Äî ${s.countTodo + s.countRun} zada≈Ñ`).join('<br>')}</div></div>`;
    } else {
      sugg.innerHTML = `<div class="card"><div class="muted">Brak wyra≈∫nych wƒÖskich garde≈Ç (brak operacji z ‚â•${threshold} zadaniami).</div></div>`;
    }
    host.appendChild(sugg);

    // export CSV helper captures current heavy list
    function exportMonitorCSV(){
      const rows = heavy.map(s=>({operation:s.name, count: s.countTodo + s.countRun, totalEst: s.totalEst, avgElapsed: s.avgElapsed}));
      if(rows.length===0){ alert('Brak wƒÖskich garde≈Ç do eksportu.'); return; }
      const csv = ['operation,count,totalEst,avgElapsed'].concat(rows.map(r=>`"${(r.operation||'').replace(/"/g,'""')}",${r.count},${r.totalEst},${r.avgElapsed}`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const pad = n=>String(n).padStart(2,'0');
      const d = new Date();
      const ts = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      const th = state.storage && state.storage.monitorThreshold ? state.storage.monitorThreshold : 'x';
      const filename = `monitor_bottlenecks_${ts}_th${th}.csv`;
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      try{
        const existing = qs('#monitor-export-toast'); if(existing) existing.remove();
  const t = document.createElement('div'); t.id = 'monitor-export-toast'; t.className = 'card'; t.style.position='fixed'; t.style.right='12px'; t.style.top='80px'; t.style.zIndex='99999'; t.style.padding='8px 12px';
  t.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div>Eksport monitoringu utworzony:</div><div style="font-weight:700">${filename}</div><button id="monitor-export-copy" class="btn" style="margin-left:8px">Kopiuj nazwƒô</button></div>`;
  t.setAttribute('data-filename', filename);
  document.body.appendChild(t);
  try{ const copyBtn = qs('#monitor-export-copy'); if(copyBtn){ copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(filename); copyBtn.textContent='Skopiowano'; setTimeout(()=>copyBtn.textContent='Kopiuj nazwƒô',1000); }catch(_){ try{ const ta=document.createElement('textarea'); ta.value = filename; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); copyBtn.textContent='Skopiowano'; setTimeout(()=>copyBtn.textContent='Kopiuj nazwƒô',1000); }catch(__){} } }); } }catch(_){ }
  setTimeout(()=>{ const el = qs('#monitor-export-toast'); if(el) el.remove(); }, 3500);
      }catch(_){ }
      setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){ } }, 2000);
    }

    // alerts banner
    if((state.storage && state.storage.monitorAlertsEnabled) !== false && heavy.length){
      const banner = document.createElement('div'); banner.className='card err'; banner.style.marginTop='8px'; banner.innerHTML = `<b>ALERT:</b> Zidentyfikowano ${heavy.length} operacji przekraczajƒÖcych threshold (${state.storage.monitorThreshold||5}).`;
      host.appendChild(banner);
    }

    // clickable rows: clicking shows detail list for that operation
    tb.querySelectorAll('tr').forEach((tr, idx)=>{
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', ()=>{
        const existing = qs('#monitor-op-detail'); if(existing) existing.remove();
        const op = top[idx];
        const detail = document.createElement('div'); detail.id = 'monitor-op-detail'; detail.className = 'card'; detail.style.marginTop = '8px';
        const tasks = (state.tasks||[]).filter(t=> (t.opName||'') === op.name );
        if(tasks.length===0){ detail.innerHTML = `<div class="muted">Brak konkretnych zada≈Ñ dla operacji: ${op.name}</div>`; }
        else{
          detail.innerHTML = `<div><b>Szczeg√≥≈Çy: ${op.name}</b> ‚Ä¢ zada≈Ñ: ${tasks.length}</div><div style="margin-top:8px">` + tasks.map(t=>`<div>${t.opName} ‚Ä¢ ${ (state.orders||[]).find(o=>o.id===t.orderId)?.name || t.orderId } ‚Ä¢ status: ${t.status||'todo'} ‚Ä¢ est:${t.estMin||0}m ‚Ä¢ elapsed:${Math.round(t.elapsedMin||0)}m</div>`).join('') + '</div>';
        }
        host.appendChild(detail);
      });
    });
  }

  async function loadScript(src){
    return new Promise((res,rej)=>{
      console.log('≈Åadowanie skryptu:', src);
      const s=document.createElement('script');
      s.src=src;
      s.onload=()=>{ console.log('Skrypt za≈Çadowany:', src); res(); };
      s.onerror=(e)=>{ console.error('B≈ÇƒÖd ≈Çadowania skryptu:', src, e); rej(new Error('Load fail '+src)); };
      document.head.appendChild(s);
    });
  }
  async function ensureFirebase(){
    if(window.firebase&&firebase.apps&&firebase.apps.length){return true;}
    try{
      const cfg=state.storage.fbConfig||{}; if(!cfg.apiKey) throw new Error('Brak config');
      
      // Sprawd≈∫ czy jeste≈õmy na localhost - je≈õli tak, ostrze≈º o potencjalnych problemach
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      if(isLocalhost && window.location.protocol !== 'https:'){
        console.warn('Firebase na HTTP localhost - spr√≥bujƒô po≈ÇƒÖczyƒá mimo to.');
        // Nie prze≈ÇƒÖczamy automatycznie - pozw√≥l u≈ºytkownikowi samemu zadecydowaƒá
      }
      
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js');
      if(!firebase.apps.length){firebase.initializeApp(cfg);}
      try {
        const auth = firebase.auth();
        if (!auth.currentUser) {
          await auth.signInAnonymously();
          console.log('[firebase] Zalogowano anonimowo na potrzeby synchronizacji.');
        }
        try {
          await detectUserCollectionName();
        } catch(detectErr) {
          console.warn('[firebase] Nie uda≈Ço siƒô ustaliƒá nazwy kolekcji u≈ºytkownik√≥w:', detectErr && detectErr.message);
        }
      } catch (authErr) {
        console.warn('[firebase] Nie uda≈Ço siƒô przeprowadziƒá logowania anonimowego:', authErr && authErr.message);
      }
      return true;
    }catch(e){
      console.warn('Firebase load/init error:',e.message);
      qs('#set-info').textContent='‚ö†Ô∏è Firebase niedostƒôpny - sprawd≈∫ po≈ÇƒÖczenie lub prze≈ÇƒÖcz na localStorage w ustawieniach';
      
      // Nie prze≈ÇƒÖczamy automatycznie - u≈ºytkownik mo≈ºe chcieƒá spr√≥bowaƒá ponownie
      console.log('Firebase niedostƒôpny - pozostawiam tryb:', state.storage.mode);
      
      return false;
    }
  }
  function fbRoot(){
    const collectionName = getUserCollectionNameSync();
    return firebase.firestore().collection('planner').doc(state.storage.appId).collection(collectionName).doc(state.storage.userId);
  }
  async function saveToDB(customState){
    if(state.storage.mode!=='firebase'){qs('#set-info').textContent='Tryb localStorage (offline)';return;}
    const ok=await ensureFirebase(); if(!ok){return;}
    if(!Array.isArray(window.warehouseItems)){
      try {
        if (typeof loadWarehouseFromStorage === 'function') {
          loadWarehouseFromStorage();
        }
      } catch (warehouseLoadErr) {
        console.warn('[saveToDB] Nie uda≈Ço siƒô do≈Çadowaƒá magazynu przed zapisem:', warehouseLoadErr && warehouseLoadErr.message);
      }
      if(!Array.isArray(window.warehouseItems)){
        window.warehouseItems = [];
      }
    }

    const targetState = customState || state;
    try {
      ensureOperationsCatalogChecklists(targetState.operationsCatalog);
      if(Array.isArray(targetState.operationsCatalog) && targetState.operationsCatalog.length > 1){
        dedupeOperationsCatalog(targetState.operationsCatalog, 'saveToDB()');
      }
      const db=firebase.firestore();
      const batch=db.batch();
      const tasksWritten = [];
      const tasksDeleted = [];
      const deletedProcessIdsRemoved = [];
      const deletedOperationIdsRemoved = [];
      const r=fbRoot();

      const collections = [
        { name: 'employees', items: targetState.employees || [] },
        { name: 'operationsCatalog', items: targetState.operationsCatalog || [] },
        { name: 'processes', items: targetState.processes || [] },
        { name: 'orders', items: targetState.orders || [] },
        { name: 'tasks', items: targetState.tasks || [] },
        { name: 'after', items: targetState.after || [] },
        { name: WAREHOUSE_COLLECTION, items: window.warehouseItems || [] },
        { name: 'materialTemplates', items: window.materialTemplates || [] },
        { name: 'warehouseTasks', items: window.warehouseTasks || [] }
      ];

      // Pobierz aktualne dokumenty zdalne, aby usunƒÖƒá te, kt√≥rych ju≈º nie ma lokalnie
      const snapshots = await Promise.all(
        collections.map(col => r.collection(col.name).get())
      );

      collections.forEach((col, idx) => {
        const remoteDocs = snapshots[idx];
        const localItems = Array.isArray(col.items)
          ? col.items
          : (col.items && typeof col.items === 'object')
            ? Object.values(col.items)
            : [];

        if(col.name === 'operationsCatalog'){
          ensureOperationsCatalogChecklists(localItems);
        }

        const remoteDocMap = col.name === 'tasks' ? new Map() : null;
        if(remoteDocMap){
          remoteDocs.forEach(doc => {
            remoteDocMap.set(doc.id, doc.data());
          });
        }

        const isProcessCollection = col.name === 'processes';
        const processDeletions = isProcessCollection
          ? (Array.isArray(targetState.deletedProcesses) ? targetState.deletedProcesses
            : Array.isArray(state.deletedProcesses) ? state.deletedProcesses
            : [])
          : null;
        const deletedProcessesSet = processDeletions ? new Set(processDeletions) : null;

        const localIds = new Set(
          localItems
            .filter(item => item && typeof item === 'object')
            .map(item => {
              if(!item.id){
                const generatedId = uid();
                if(col.items === state[col.name] || targetState === state){
                  item.id = generatedId;
                } else {
                  item.id = generatedId;
                }
              }
              return item.id;
            })
        );

        // DIAGNOSTYKA dla employees
        if (col.name === 'employees') {
          console.log(`üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:`);
          console.log(`  üì¶ Lokalne items (col.items):`, col.items);
          console.log(`  üìã Przetworzone localItems:`, localItems);
          console.log(`  üîë LocalIds (SET):`, Array.from(localIds));
          console.log(`  üåê Zdalne dokumenty:`, remoteDocs.docs.map(d => ({id: d.id, data: d.data()})));
        }
        
        // DIAGNOSTYKA dla magazynu
        if (col.name === WAREHOUSE_COLLECTION) {
          console.log(`üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:`);
          console.log(`  üì¶ Lokalne pozycje: ${localItems.length}`, localItems);
          console.log(`  üåê Zdalne dokumenty: ${remoteDocs.docs.length}`, remoteDocs.docs.map(d => ({id: d.id, data: d.data()})));
        }

        const toDelete = [];
        remoteDocs.forEach(doc => {
          if(!localIds.has(doc.id)){
            // üîí OCHRONA dla kolekcji: operationsCatalog, processes (nie dla employees!)
            // Pracownicy sƒÖ teraz synchronizowani normalnie - usuwanie dzia≈Ça poprawnie
            if(col.name === 'operationsCatalog'){
              const isTestOp = /^op_test_/.test(doc.id);
              const deletedOperationsSet = new Set(Array.isArray(state.deletedOperations) ? state.deletedOperations : []);
              const isMarkedForDelete = deletedOperationsSet.has(doc.id);
              if(!isTestOp && !isMarkedForDelete){
                console.warn(`‚ö†Ô∏è [saveToDB] NIE USUWAM operacji '${doc.id}' - to dane rzeczywiste (nie oznaczone do usuniƒôcia)`);
                localIds.add(doc.id);
                return;
              }
              if(isMarkedForDelete){
                console.log(`üóëÔ∏è [saveToDB] Usuwam operacjƒô '${doc.id}' - oznaczona do usuniƒôcia`);
              }
            }
            if(col.name === 'processes'){
              const isTestProc = /^proc_test_/.test(doc.id);
              const isMarkedForDelete = deletedProcessesSet ? deletedProcessesSet.has(doc.id) : false;
              if(!isTestProc && !isMarkedForDelete){
                console.warn(`‚ö†Ô∏è [saveToDB] NIE USUWAM procesu '${doc.id}' - to dane rzeczywiste!`);
                localIds.add(doc.id);
                return;
              }
            }
            
            toDelete.push(doc.id);
            batch.delete(r.collection(col.name).doc(doc.id));
            if(col.name === 'tasks'){
              tasksDeleted.push(doc.id);
            }
            if(col.name === 'processes'){
              deletedProcessIdsRemoved.push(doc.id);
            }
            if(col.name === 'operationsCatalog'){
              deletedOperationIdsRemoved.push(doc.id);
            }
          }
        });
        
        if (toDelete.length > 0) {
          console.log(`üóëÔ∏è [saveToDB] Usuwam ${toDelete.length} dokument√≥w z kolekcji '${col.name}':`, toDelete);
          if (col.name === 'employees') {
            console.warn(`‚ö†Ô∏è USUWAM PRACOWNIK√ìW! IDs:`, toDelete);
            console.log(`  Pow√≥d: Nie ma ich w localIds:`, Array.from(localIds));
          }
        }

        localItems.forEach(item => {
          if(!item || typeof item !== 'object') return;
          
          // FILTROWANIE: Nie zapisuj testowych ID
          if(col.name === 'tasks'){
            const isTestTask = /^task\d+$/.test(item.id) || (item.id && item.id.startsWith('task_test_'));
            if(isTestTask){
              console.warn(`  üö´ [saveToDB] BLOKUJƒò testowe zadanie: ${item.id} - nie wysy≈Çam do Firebase!`);
              return;
            }
          }
          
          if(col.name === 'orders'){
            const isTestOrder = item.id === 'order1' || (item.id && item.id.startsWith('order_test_'));
            if(isTestOrder){
              console.warn(`  üö´ [saveToDB] BLOKUJƒò testowe zlecenie: ${item.id} - nie wysy≈Çam do Firebase!`);
              return;
            }
          }
          
          if(col.name === 'employees'){
            const isTestEmployee = /^emp\d+$/.test(item.id) || (item.id && item.id.startsWith('emp_test_'));
            if(isTestEmployee){
              console.warn(`  üö´ [saveToDB] BLOKUJƒò testowego pracownika: ${item.id} - nie wysy≈Çam do Firebase!`);
              return;
            }
          }
          
          let record = item;
          if(col.name === 'tasks' && remoteDocMap){
            const remoteData = remoteDocMap.get(item.id);
            const baselineStatus = taskStatusBaseline.get(item.id);
            const remoteStatus = remoteData ? remoteData.status : undefined;
            if(remoteData && baselineStatus !== undefined && baselineStatus === item.status && remoteStatus !== undefined && remoteStatus !== item.status){
              record = Object.assign({}, item, {
                status: remoteStatus,
                lastStatusChange: remoteData.lastStatusChange || item.lastStatusChange,
                closedAt: remoteData.closedAt || item.closedAt,
                closedBy: remoteData.closedBy || item.closedBy
              });
              if(window.logDev || Math.random() < 0.05){
                console.log('[saveToDB] Preserving remote status for task', item.id, 'remote:', remoteStatus, 'local:', item.status, 'baseline:', baselineStatus);
              }
            }
          }

          const payload = JSON.parse(JSON.stringify(record));
          
          // üîç DIAGNOSTYKA CHECKLIST - zawsze loguj dla tasks
          if (col.name === 'tasks') {
            console.log(`üìã [saveToDB] Zapisujƒô zadanie:`, {
              taskId: item.id,
              opName: record.opName,
              hasChecklist: !!record.checklist,
              checklistType: typeof record.checklist,
              checklistLength: record.checklist?.length,
              checklistValue: record.checklist,
              payloadHasChecklist: !!payload.checklist,
              payloadChecklistLength: payload.checklist?.length
            });
          }
          
          batch.set(r.collection(col.name).doc(item.id), payload, {merge:true});
          if (col.name === 'tasks') {
            tasksWritten.push({id: item.id, status: payload.status});
          }
          if (col.name === 'employees') {
            console.log(`  ‚úçÔ∏è Zapisujƒô pracownika:`, item.id, item.name);
          }
        });
        
        if (col.name === 'employees') {
          console.log(`‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: ${localItems.length}, Usuniƒôtych: ${toDelete.length}`);
        }
      });

      if(LEGACY_WAREHOUSE_COLLECTION !== WAREHOUSE_COLLECTION){
        try{
          const legacySnapshot = await r.collection(LEGACY_WAREHOUSE_COLLECTION).get();
          const legacyIds = [];
          legacySnapshot.forEach(doc => {
            legacyIds.push(doc.id);
            batch.delete(r.collection(LEGACY_WAREHOUSE_COLLECTION).doc(doc.id));
          });
          if(legacyIds.length){
            console.log(`üßπ [saveToDB] Czyszczƒô legacy kolekcjƒô '${LEGACY_WAREHOUSE_COLLECTION}' (usuwam ${legacyIds.length} dokument√≥w)`);
          }
        }catch(cleanErr){
          console.warn(`[saveToDB] Nie uda≈Ço siƒô odczytaƒá legacy kolekcji '${LEGACY_WAREHOUSE_COLLECTION}':`, cleanErr && cleanErr.message);
        }
      }

      // ZAWSZE generuj nowy timestamp przy zapisie (zapobiega problemom z wczytywaniem starych danych)
      const lastModified = Date.now();
      
      // Zaktualizuj lokalny state z nowym timestampem
      state.lastModified = lastModified;
      if (targetState && targetState !== state) {
        targetState.lastModified = lastModified;
      }

      batch.set(r.collection('metadata').doc('sync'), {
        lastModified,
        lastSync: Date.now(),
        source: 'planner'
      }, {merge: true});

      await batch.commit();

      tasksWritten.forEach(entry => {
        if(entry && entry.id){
          taskStatusBaseline.set(entry.id, entry.status);
        }
      });
      tasksDeleted.forEach(id => {
        if(id){
          taskStatusBaseline.delete(id);
        }
      });
      if(deletedProcessIdsRemoved.length){
        const processedProcesses = new Set(deletedProcessIdsRemoved);
        if(Array.isArray(state.deletedProcesses)){
          state.deletedProcesses = state.deletedProcesses.filter(id => !processedProcesses.has(id));
        }
        if(targetState !== state && Array.isArray(targetState.deletedProcesses)){
          targetState.deletedProcesses = targetState.deletedProcesses.filter(id => !processedProcesses.has(id));
        }
      }
      // Wyczy≈õƒá deletedOperations po usuniƒôciu z Firebase
      if(deletedOperationIdsRemoved.length){
        const processedOperations = new Set(deletedOperationIdsRemoved);
        if(Array.isArray(state.deletedOperations)){
          state.deletedOperations = state.deletedOperations.filter(id => !processedOperations.has(id));
        }
        if(targetState !== state && Array.isArray(targetState.deletedOperations)){
          targetState.deletedOperations = targetState.deletedOperations.filter(id => !processedOperations.has(id));
        }
        // üîß Zaktualizuj backup localStorage
        try {
          if(state.deletedOperations && state.deletedOperations.length > 0){
            localStorage.setItem('deletedOperations_backup', JSON.stringify(state.deletedOperations));
          } else {
            localStorage.removeItem('deletedOperations_backup');
          }
        } catch(e) { console.warn('Nie uda≈Ço siƒô zaktualizowaƒá deletedOperations backup:', e); }
        console.log(`üóëÔ∏è Usuniƒôto ${deletedOperationIdsRemoved.length} operacji z Firebase:`, deletedOperationIdsRemoved);
      }
      if(typeof window !== 'undefined' && Array.isArray(window._pendingLegacyWarehouseCleanup)){
        window._pendingLegacyWarehouseCleanup = [];
      }

      state.storage.lastRemoteSync = lastModified;
      try {
        localStorage.setItem(storeKey, safeStringifyState(state));
      } catch(persistErr) {
        console.warn('Nie uda≈Ço siƒô zapisaƒá znacznika lastRemoteSync:', persistErr && persistErr.message);
      }
      console.log('‚úÖ Zapisano do Firebase z timestamp:', new Date(lastModified).toLocaleString('pl-PL'));
      qs('#set-info').textContent='‚úÖ Zapisano kolekcje do DB.';
    } catch(e) {
      console.error('‚ùå B≈ÇƒÖd zapisu do Firebase:', e.message);
      qs('#set-info').textContent='‚ùå B≈ÇƒÖd zapisu do DB: '+e.message;
    }
  }

  async function purgeFirebaseOrders(options = {}) {
    const { dryRun = false } = options;
    if(state.storage.mode !== 'firebase'){
      console.warn('[purgeFirebaseOrders] Tryb offline - brak po≈ÇƒÖczenia z Firebase');
      return {deletedOrders:0, deletedTasks:0};
    }
    const ok = await ensureFirebase();
    if(!ok){ return {deletedOrders:0, deletedTasks:0}; }
    const root = fbRoot();
    const keepIds = new Set((state.orders || []).map(o => o.id));
    const remoteOrders = await root.collection('orders').get();
    let deletedOrders = 0;
    let deletedTasks = 0;

    for(const doc of remoteOrders.docs){
      if(keepIds.has(doc.id)) continue;
      console.warn('[purgeFirebaseOrders] Usuwam zdalne zlecenie spoza lokalnego stanu:', doc.id);
      if(!dryRun){
        await root.collection('orders').doc(doc.id).delete();
        deletedOrders++;
        const orphanTasks = await root.collection('tasks').where('orderId','==',doc.id).get();
        for(const taskDoc of orphanTasks.docs){
          await root.collection('tasks').doc(taskDoc.id).delete();
          deletedTasks++;
        }
      }
    }
    console.log(`[purgeFirebaseOrders] Zako≈Ñczono. Usuniƒôte zlecenia: ${deletedOrders}, zadania: ${deletedTasks}`);
    return {deletedOrders, deletedTasks};
  }
  window.purgeFirebaseOrders = purgeFirebaseOrders;
  try {
    window.saveToDB = saveToDB;
    window.handleSaveToDB = saveToDB; // Alias dla store.js
  } catch(assignErr) {
    console.warn('Nie uda≈Ço siƒô zarejestrowaƒá saveToDB w globalnym oknie:', assignErr && assignErr.message);
  }
  
  // Export saveToDB globally for use in other functions
  window.saveToDB = saveToDB;
  window.handleSaveToDB = saveToDB; // Zapewnia kompatybilno≈õƒá z store.js

  async function purgeOrderFromFirebase(orderId){
    if(!orderId) return;
    if(!state.storage || state.storage.mode !== 'firebase') return;
    const ok = await ensureFirebase();
    if(!ok) return;
    try{
      console.log(`  üîç [purgeOrderFromFirebase] Removing order ${orderId} directly from Firebase...`);
      const db = firebase.firestore();
      const root = fbRoot();

      const targets = [];
      targets.push(root.collection('orders').doc(orderId));

      const taskSnap = await root.collection('tasks').where('orderId','==',orderId).get();
      taskSnap.forEach(doc => targets.push(doc.ref));

      const afterSnap = await root.collection('after').where('order','==',orderId).get();
      afterSnap.forEach(doc => targets.push(doc.ref));

      const chunkSize = 400;
      for(let i=0;i<targets.length;i+=chunkSize){
        const batch = db.batch();
        targets.slice(i, i + chunkSize).forEach(ref => batch.delete(ref));
        await batch.commit();
      }

      console.log(`  ‚úÖ [purgeOrderFromFirebase] Order ${orderId} removed from Firebase`);
    }catch(err){
      console.error(`  ‚ùå [purgeOrderFromFirebase] Failed for ${orderId}:`, err);
      throw err;
    }
  }
  window.purgeOrderFromFirebase = purgeOrderFromFirebase;

  // ================================
  // Funkcja TYLKO DO ODCZYTU operationsCatalog z Firebase
  // ================================
  async function getOperationsFromFirebase() {
    console.log('[getOperationsFromFirebase] üìñ Pobieram operacje z Firebase (tylko odczyt)...');
    
    const ok = await ensureFirebase();
    if (!ok) {
      console.error('[getOperationsFromFirebase] ‚ùå Firebase not ready');
      return { success: false, error: 'Firebase not ready' };
    }
    
    try {
      const root = fbRoot();
      const opsRef = root.collection('operationsCatalog');
      const snapshot = await opsRef.get();
      
      const operations = [];
      const nameCount = {};
      
      snapshot.forEach(doc => {
        const data = doc.data();
        operations.push({
          id: doc.id,
          name: data.name,
          time: data.time,
          category: data.category
        });
        
        // Licz duplikaty po nazwie
        const normName = (data.name || '').trim().toUpperCase();
        nameCount[normName] = (nameCount[normName] || 0) + 1;
      });
      
      // Znajd≈∫ duplikaty
      const duplicates = Object.entries(nameCount)
        .filter(([name, count]) => count > 1)
        .map(([name, count]) => ({ name, count }));
      
      const uniqueNames = Object.keys(nameCount).length;
      
      console.log(`[getOperationsFromFirebase] ‚úÖ Firebase ma ${operations.length} operacji`);
      console.log(`[getOperationsFromFirebase] üìä Unikalne nazwy: ${uniqueNames}`);
      
      if (duplicates.length > 0) {
        console.log(`[getOperationsFromFirebase] ‚ö†Ô∏è Duplikaty (${duplicates.length}):`);
        duplicates.forEach(d => console.log(`   - "${d.name}" x${d.count}`));
      }
      
      // Poka≈º listƒô operacji
      console.log('[getOperationsFromFirebase] üìã Lista operacji:');
      operations.forEach((op, i) => {
        console.log(`   ${i+1}. [${op.id}] ${op.name} (${op.time}min, ${op.category})`);
      });
      
      return {
        success: true,
        total: operations.length,
        uniqueNames: uniqueNames,
        duplicates: duplicates,
        operations: operations
      };
    } catch (err) {
      console.error('[getOperationsFromFirebase] ‚ùå B≈ÇƒÖd:', err);
      return { success: false, error: err.message };
    }
  }
  window.getOperationsFromFirebase = getOperationsFromFirebase;

  // ================================
  // Funkcja do sprawdzenia LOKALNYCH operacji (localStorage + state)
  // ================================
  function getLocalOperations() {
    console.log('[getLocalOperations] üìñ Sprawdzam lokalne operacje...');
    
    // 1. Sprawd≈∫ state.operationsCatalog
    const stateOps = (window.state || state).operationsCatalog || [];
    console.log(`[getLocalOperations] üîπ state.operationsCatalog: ${stateOps.length} operacji`);
    
    // 2. Sprawd≈∫ localStorage
    let localStorageOps = [];
    try {
      const raw = localStorage.getItem('door_v50_state');
      if (raw) {
        const parsed = JSON.parse(raw);
        localStorageOps = parsed.operationsCatalog || [];
        console.log(`[getLocalOperations] üîπ localStorage: ${localStorageOps.length} operacji`);
      } else {
        console.log('[getLocalOperations] üîπ localStorage: BRAK danych door_v50_state');
      }
    } catch (e) {
      console.error('[getLocalOperations] ‚ùå B≈ÇƒÖd parsowania localStorage:', e);
    }
    
    // 3. Analiza duplikat√≥w w state
    const nameCount = {};
    stateOps.forEach(op => {
      const normName = (op.name || '').trim().toUpperCase();
      nameCount[normName] = (nameCount[normName] || 0) + 1;
    });
    
    const duplicates = Object.entries(nameCount)
      .filter(([name, count]) => count > 1)
      .map(([name, count]) => ({ name, count }));
    
    const uniqueNames = Object.keys(nameCount).length;
    
    console.log(`[getLocalOperations] üìä Unikalne nazwy: ${uniqueNames}`);
    
    if (duplicates.length > 0) {
      console.log(`[getLocalOperations] ‚ö†Ô∏è Duplikaty w state (${duplicates.length}):`);
      duplicates.forEach(d => console.log(`   - "${d.name}" x${d.count}`));
    } else {
      console.log('[getLocalOperations] ‚úÖ Brak duplikat√≥w w state');
    }
    
    // 4. Wypisz listƒô operacji
    console.log('[getLocalOperations] üìã Lista operacji w state:');
    stateOps.forEach((op, i) => {
      console.log(`   ${i+1}. [${op.id}] ${op.name} (${op.time}min, ${op.category})`);
    });
    
    return {
      stateCount: stateOps.length,
      localStorageCount: localStorageOps.length,
      uniqueNames: uniqueNames,
      duplicates: duplicates,
      operations: stateOps
    };
  }
  window.getLocalOperations = getLocalOperations;

  // ================================
  // Funkcja do sprawdzenia PROCES√ìW z Firebase
  // ================================
  async function getProcessesFromFirebase() {
    console.log('[getProcessesFromFirebase] üìñ Pobieram procesy z Firebase (tylko odczyt)...');
    
    const ok = await ensureFirebase();
    if (!ok) {
      console.error('[getProcessesFromFirebase] ‚ùå Firebase not ready');
      return { success: false, error: 'Firebase not ready' };
    }
    
    try {
      const root = fbRoot();
      const procRef = root.collection('processes');
      const snapshot = await procRef.get();
      
      const processes = [];
      const nameCount = {};
      
      snapshot.forEach(doc => {
        const data = doc.data();
        processes.push({
          id: doc.id,
          name: data.name,
          operations: data.operations?.length || 0,
          ...data
        });
        
        // Licz duplikaty po nazwie
        const normName = (data.name || '').trim().toUpperCase();
        nameCount[normName] = (nameCount[normName] || 0) + 1;
      });
      
      // Znajd≈∫ duplikaty
      const duplicates = Object.entries(nameCount)
        .filter(([name, count]) => count > 1)
        .map(([name, count]) => ({ name, count }));
      
      const uniqueNames = Object.keys(nameCount).length;
      
      console.log(`[getProcessesFromFirebase] ‚úÖ Firebase ma ${processes.length} proces√≥w`);
      console.log(`[getProcessesFromFirebase] üìä Unikalne nazwy: ${uniqueNames}`);
      
      if (duplicates.length > 0) {
        console.log(`[getProcessesFromFirebase] ‚ö†Ô∏è Duplikaty (${duplicates.length}):`);
        duplicates.forEach(d => console.log(`   - "${d.name}" x${d.count}`));
      }
      
      // Poka≈º listƒô proces√≥w
      console.log('[getProcessesFromFirebase] üìã Lista proces√≥w:');
      processes.forEach((p, i) => {
        console.log(`   ${i+1}. [${p.id}] ${p.name} (${p.operations} operacji)`);
      });
      
      return {
        success: true,
        total: processes.length,
        uniqueNames: uniqueNames,
        duplicates: duplicates,
        processes: processes
      };
    } catch (err) {
      console.error('[getProcessesFromFirebase] ‚ùå B≈ÇƒÖd:', err);
      return { success: false, error: err.message };
    }
  }
  window.getProcessesFromFirebase = getProcessesFromFirebase;

  // ================================
  // Funkcja do sprawdzenia LOKALNYCH proces√≥w
  // ================================
  function getLocalProcesses() {
    console.log('[getLocalProcesses] üìñ Sprawdzam lokalne procesy...');
    
    // 1. Sprawd≈∫ state.processes
    const stateProc = (window.state || state).processes || [];
    console.log(`[getLocalProcesses] üîπ state.processes: ${stateProc.length} proces√≥w`);
    
    // 2. Sprawd≈∫ localStorage
    let localStorageProc = [];
    try {
      const raw = localStorage.getItem('door_v50_state');
      if (raw) {
        const parsed = JSON.parse(raw);
        localStorageProc = parsed.processes || [];
        console.log(`[getLocalProcesses] üîπ localStorage: ${localStorageProc.length} proces√≥w`);
      } else {
        console.log('[getLocalProcesses] üîπ localStorage: BRAK danych door_v50_state');
      }
    } catch (e) {
      console.error('[getLocalProcesses] ‚ùå B≈ÇƒÖd parsowania localStorage:', e);
    }
    
    // 3. Analiza duplikat√≥w w state
    const nameCount = {};
    stateProc.forEach(p => {
      const normName = (p.name || '').trim().toUpperCase();
      nameCount[normName] = (nameCount[normName] || 0) + 1;
    });
    
    const duplicates = Object.entries(nameCount)
      .filter(([name, count]) => count > 1)
      .map(([name, count]) => ({ name, count }));
    
    const uniqueNames = Object.keys(nameCount).length;
    
    console.log(`[getLocalProcesses] üìä Unikalne nazwy: ${uniqueNames}`);
    
    if (duplicates.length > 0) {
      console.log(`[getLocalProcesses] ‚ö†Ô∏è Duplikaty w state (${duplicates.length}):`);
      duplicates.forEach(d => console.log(`   - "${d.name}" x${d.count}`));
    } else {
      console.log('[getLocalProcesses] ‚úÖ Brak duplikat√≥w w state');
    }
    
    // 4. Wypisz listƒô proces√≥w
    console.log('[getLocalProcesses] üìã Lista proces√≥w w state:');
    stateProc.forEach((p, i) => {
      console.log(`   ${i+1}. [${p.id}] ${p.name} (${p.operations?.length || 0} operacji)`);
    });
    
    return {
      stateCount: stateProc.length,
      localStorageCount: localStorageProc.length,
      uniqueNames: uniqueNames,
      duplicates: duplicates,
      processes: stateProc
    };
  }
  window.getLocalProcesses = getLocalProcesses;

  // ================================
  // Funkcja WYMU≈ö pobranie danych TYLKO z Firebase (nadpisuje lokalne)
  // ================================
  async function forceLoadFromFirebase() {
    console.log('[forceLoadFromFirebase] üîÑ Wymuszam pobranie danych z Firebase...');
    
    const ok = await ensureFirebase();
    if (!ok) {
      console.error('[forceLoadFromFirebase] ‚ùå Firebase not ready');
      return { success: false, error: 'Firebase not ready' };
    }
    
    try {
      const root = fbRoot();
      const s = window.state || state;
      
      // Pobierz operationsCatalog
      console.log('[forceLoadFromFirebase] üì• Pobieram operationsCatalog...');
      const opsSnap = await root.collection('operationsCatalog').get();
      const firebaseOps = [];
      opsSnap.forEach(doc => {
        firebaseOps.push({ id: doc.id, ...doc.data() });
      });
      
      // Deduplikuj po nazwie
      const seenNames = new Map();
      const dedupedOps = [];
      for (const op of firebaseOps) {
        const normName = (op.name || '').trim().toUpperCase();
        if (!normName) continue;
        if (!seenNames.has(normName)) {
          seenNames.set(normName, true);
          dedupedOps.push(op);
        }
      }
      
      console.log(`[forceLoadFromFirebase] Firebase: ${firebaseOps.length} ‚Üí po deduplikacji: ${dedupedOps.length}`);
      
      // Pobierz employees
      console.log('[forceLoadFromFirebase] üì• Pobieram employees...');
      const empSnap = await root.collection('employees').get();
      const firebaseEmps = [];
      empSnap.forEach(doc => {
        firebaseEmps.push({ id: doc.id, ...doc.data() });
      });
      console.log(`[forceLoadFromFirebase] Employees: ${firebaseEmps.length}`);
      
      // Pobierz orders
      console.log('[forceLoadFromFirebase] üì• Pobieram orders...');
      const ordSnap = await root.collection('orders').get();
      const firebaseOrders = [];
      ordSnap.forEach(doc => {
        firebaseOrders.push({ id: doc.id, ...doc.data() });
      });
      console.log(`[forceLoadFromFirebase] Orders: ${firebaseOrders.length}`);
      
      // Pobierz tasks
      console.log('[forceLoadFromFirebase] üì• Pobieram tasks...');
      const taskSnap = await root.collection('tasks').get();
      const firebaseTasks = [];
      taskSnap.forEach(doc => {
        firebaseTasks.push({ id: doc.id, ...doc.data() });
      });
      console.log(`[forceLoadFromFirebase] Tasks: ${firebaseTasks.length}`);
      
      // Pobierz processes
      console.log('[forceLoadFromFirebase] üì• Pobieram processes...');
      const procSnap = await root.collection('processes').get();
      const firebaseProc = [];
      procSnap.forEach(doc => {
        firebaseProc.push({ id: doc.id, ...doc.data() });
      });
      // Deduplikuj procesy po nazwie
      const seenProcNames = new Map();
      const dedupedProc = [];
      for (const p of firebaseProc) {
        const normName = (p.name || '').trim().toUpperCase();
        if (!normName) continue;
        if (!seenProcNames.has(normName)) {
          seenProcNames.set(normName, true);
          dedupedProc.push(p);
        }
      }
      console.log(`[forceLoadFromFirebase] Processes: ${firebaseProc.length} ‚Üí po deduplikacji: ${dedupedProc.length}`);
      
      // Nadpisz lokalny state
      s.operationsCatalog = dedupedOps;
      s.employees = firebaseEmps;
      s.orders = firebaseOrders;
      s.tasks = firebaseTasks;
      s.processes = dedupedProc;
      s.lastModified = Date.now();
      
      // Zapisz do localStorage
      save();
      saveLocalSnapshot();
      
      console.log('[forceLoadFromFirebase] ‚úÖ Dane pobrane i zapisane lokalnie!');
      console.log(`   üìã Operacje: ${dedupedOps.length}`);
      console.log(`   üë∑ Pracownicy: ${firebaseEmps.length}`);
      console.log(`   üì¶ Zlecenia: ${firebaseOrders.length}`);
      console.log(`   ‚úÖ Zadania: ${firebaseTasks.length}`);
      console.log(`   üîÑ Procesy: ${dedupedProc.length}`);
      
      // Od≈õwie≈º UI
      if (typeof render === 'function') render();
      if (typeof renderOperationsCatalog === 'function') renderOperationsCatalog();
      if (typeof renderProcesses === 'function') renderProcesses();
      
      return {
        success: true,
        operations: dedupedOps.length,
        employees: firebaseEmps.length,
        orders: firebaseOrders.length,
        tasks: firebaseTasks.length,
        processes: dedupedProc.length
      };
    } catch (err) {
      console.error('[forceLoadFromFirebase] ‚ùå B≈ÇƒÖd:', err);
      return { success: false, error: err.message };
    }
  }
  window.forceLoadFromFirebase = forceLoadFromFirebase;

  // ================================
  // Funkcja czyszczenia operationsCatalog w Firebase
  // ================================
  async function cleanupOperationsCatalogInFirebase() {
    console.log('[cleanupOperationsCatalog] üßπ Rozpoczynam czyszczenie operationsCatalog w Firebase...');
    
    const ok = await ensureFirebase();
    if (!ok) {
      console.error('[cleanupOperationsCatalog] ‚ùå Firebase not ready');
      return { success: false, error: 'Firebase not ready' };
    }
    
    try {
      const db = firebase.firestore();
      const root = fbRoot();
      
      // 1. Pobierz aktualne operacje z Firebase
      const opsRef = root.collection('operationsCatalog');
      const snapshot = await opsRef.get();
      const firebaseOpsCount = snapshot.size;
      console.log(`[cleanupOperationsCatalog] Firebase ma ${firebaseOpsCount} operacji`);
      
      // 2. Usu≈Ñ wszystkie operacje z Firebase
      if (snapshot.size > 0) {
        console.log('[cleanupOperationsCatalog] üóëÔ∏è Usuwam wszystkie operacje z Firebase...');
        const batchSize = 400;
        const refs = [];
        snapshot.forEach(doc => refs.push(doc.ref));
        
        for (let i = 0; i < refs.length; i += batchSize) {
          const batch = db.batch();
          refs.slice(i, i + batchSize).forEach(ref => batch.delete(ref));
          await batch.commit();
          console.log(`[cleanupOperationsCatalog] Usuniƒôto ${Math.min(i + batchSize, refs.length)} / ${refs.length}`);
        }
      }
      
      // 3. Deduplikuj lokalne operacje
      const localOps = state.operationsCatalog || [];
      const seenNames = new Map();
      const dedupedOps = [];
      
      for (const op of localOps) {
        const normName = (op.name || '').trim().toUpperCase();
        if (!normName) continue;
        
        if (!seenNames.has(normName)) {
          seenNames.set(normName, true);
          dedupedOps.push(op);
        }
      }
      
      console.log(`[cleanupOperationsCatalog] Lokalne operacje: ${localOps.length} ‚Üí po deduplikacji: ${dedupedOps.length}`);
      
      // 4. Zapisz tylko unikalne operacje do Firebase
      if (dedupedOps.length > 0) {
        console.log('[cleanupOperationsCatalog] üì§ Zapisujƒô zdeduplikowane operacje do Firebase...');
        const batchSize = 400;
        
        for (let i = 0; i < dedupedOps.length; i += batchSize) {
          const batch = db.batch();
          dedupedOps.slice(i, i + batchSize).forEach(op => {
            const docRef = opsRef.doc(op.id);
            batch.set(docRef, JSON.parse(JSON.stringify(op)));
          });
          await batch.commit();
        }
      }
      
      // 5. Aktualizuj lokalny stan
      state.operationsCatalog = dedupedOps;
      
      // 6. Zapisz do localStorage
      saveLocalSnapshot();
      
      console.log(`[cleanupOperationsCatalog] ‚úÖ Zako≈Ñczono! Firebase ma teraz ${dedupedOps.length} operacji`);
      
      return {
        success: true,
        before: firebaseOpsCount,
        after: dedupedOps.length,
        removed: firebaseOpsCount - dedupedOps.length
      };
    } catch (err) {
      console.error('[cleanupOperationsCatalog] ‚ùå B≈ÇƒÖd:', err);
      return { success: false, error: err.message };
    }
  }
  window.cleanupOperationsCatalogInFirebase = cleanupOperationsCatalogInFirebase;

  // Save single task document to Firestore (merge)
  async function _saveTaskToDB_once(taskId){
    const ok = await ensureFirebase(); if(!ok) throw new Error('Firebase not ready');
    const t = (state.tasks||[]).find(x=>x.id===taskId); if(!t) throw new Error('task not found');
    const payload = JSON.parse(JSON.stringify(t));
    await fbRoot().collection('tasks').doc(taskId).set(payload, { merge: true });
  }

  async function saveTaskToDB(taskId, opts){
    if(!taskId) return;
    if(state.storage.mode !== 'firebase') return;
    const attempts = (opts && opts.attempts) || 3;
    const base = (opts && opts.baseDelayMs) || 500;
    const t = (state.tasks||[]).find(x=>x.id===taskId);
    if(!t) return;
    t._syncPending = true; t._syncError = false; save(); try{ renderTasks(); }catch(_){ }
    let lastErr = null;
    for(let i=0;i<attempts;i++){
      try{ await _saveTaskToDB_once(taskId); t._syncPending = false; t._lastSync = Date.now(); t._syncError = false; save(); try{ renderTasks(); }catch(_){ } (window.logDev||console.log)('[saveTaskToDB] saved', taskId, 'attempt', i+1); return; }
      catch(e){ lastErr = e; (window.logDev||console.warn)('saveTaskToDB attempt failed', i+1, e && e.message); if(i < attempts - 1){ const delay = base * Math.pow(2, i); await new Promise(r=>setTimeout(r, delay)); } }
    }
    try{ t._syncPending = false; t._syncError = true; save(); try{ renderTasks(); }catch(_){ } }catch(_){ }
    console.warn('saveTaskToDB all attempts failed', lastErr && lastErr.message);
    throw lastErr;
  }

  // Subscribe to tasks collection updates from Firestore and merge into local state
  async function subscribeToTaskUpdates(){
    if(state.storage.mode !== 'firebase') return;
    let isInitialLoad = true;
    try{
      const ok = await ensureFirebase(); if(!ok) return;
      if(window._tasksUnsub) try{ window._tasksUnsub(); }catch(_){ }
      const col = fbRoot().collection('tasks');
      window._tasksUnsub = col.onSnapshot(snapshot=>{
        const initialSnapshot = isInitialLoad;
        try{
          const deletedOrdersSet = new Set(Array.isArray(state.deletedOrders) ? state.deletedOrders : []);
          const syncingDelete = !!window._isSyncingDelete;
          const docChanges = snapshot.docChanges();
          if(docChanges.length === 0 && !initialSnapshot){
            return;
          }
          isApplyingRemoteUpdate = true;
          let changed = false;
          docChanges.forEach(ch=>{
            const data = Object.assign({id: ch.doc.id}, ch.doc.data());
            if ((ch.type === 'added' || ch.type === 'modified') && (syncingDelete || (data.orderId && deletedOrdersSet.has(data.orderId)))) {
              console.log('üõ°Ô∏è [subscribeToTaskUpdates] Pomijam aktualizacjƒô zadania powiƒÖzanego ze skasowanym zleceniem', data.id);
              return;
            }
            if(ch.type === 'added' || ch.type === 'modified'){
              console.log(`üîÑ [Firebase] ${ch.type} zadanie:`, data.id, 'status:', data.status);
              const idx = (state.tasks||[]).findIndex(t=>t.id === data.id);
              if(idx >= 0){
                console.log(`‚úèÔ∏è [Firebase] Aktualizujƒô istniejƒÖce zadanie na pozycji ${idx}`);
                state.tasks[idx] = Object.assign({}, state.tasks[idx], data);
              } else {
                console.log('‚ûï [Firebase] Dodajƒô nowe zadanie do listy');
                state.tasks = state.tasks || [];
                state.tasks.push(data);
              }
              taskStatusBaseline.set(data.id, data.status);
              changed = true;
            } else if(ch.type === 'removed'){
              console.log(`üóëÔ∏è [Firebase] Usuwam zadanie:`, data.id);
              state.tasks = (state.tasks||[]).filter(t=>t.id !== data.id);
              taskStatusBaseline.delete(data.id);
              changed = true;
            }
          });

          if(initialSnapshot){
            snapshot.docs.forEach(d=>{
              const docData = Object.assign({id: d.id}, d.data());
              taskStatusBaseline.set(docData.id, docData.status);
            });
          }

          isInitialLoad = false;

          if(changed || initialSnapshot){
            snapshot.docs.forEach(d=>{
              const id = d.id;
              const idx = (state.tasks||[]).findIndex(t=>t.id===id);
              if(idx>=0){
                state.tasks[idx]._lastSync = Date.now();
                state.tasks[idx]._syncPending = false;
                state.tasks[idx]._syncError = false;
              }
            });

            skipAutoSaveUntil = Date.now() + 5000;
            window.skipAutoSaveUntil = skipAutoSaveUntil;
            window._plannerSkipAutoSaveUntil = skipAutoSaveUntil;

            save();
            try{ renderTasks(); renderMonitor && renderMonitor(); }catch(_){ }
          }
        }catch(e){
          console.warn('subscribeToTaskUpdates snapshot error', e && e.message);
        }finally{
          isApplyingRemoteUpdate = false;
        }
      }, err=>{ console.warn('tasks onSnapshot error', err && err.message); });
      (window.logDev||console.log)('[subscribeToTaskUpdates] subscribed');
    }catch(e){ console.warn('subscribeToTaskUpdates error', e && e.message); }
  }

  (async function autoSubscribeIfNeeded(){ 
    try{ 
      if(state.storage && state.storage.mode==='firebase' && state.storage.autoLoadFromDB){ 
        await subscribeToTaskUpdates(); 
        // subscribeToProcessUpdates i subscribeToOperationUpdates sƒÖ wywo≈Çywane p√≥≈∫niej
      } 
    }catch(e){ console.warn('autoSubscribeIfNeeded err', e && e.message); } 
  })();

  // ================================
  // Realtime listener dla PROCES√ìW
  // ================================
  async function subscribeToProcessUpdates(){
    if(state.storage.mode !== 'firebase') return;
    let isInitialLoad = true;
    try{
      const ok = await ensureFirebase(); if(!ok) return;
      if(window._processesUnsub) try{ window._processesUnsub(); }catch(_){ }
      const col = fbRoot().collection('processes');
      
      console.log('üîÑ [subscribeToProcessUpdates] Subskrybujƒô zmiany proces√≥w...');
      
      window._processesUnsub = col.onSnapshot(snapshot=>{
        const initialSnapshot = isInitialLoad;
        try{
          const deletedProcessesSet = new Set(Array.isArray(state.deletedProcesses) ? state.deletedProcesses : []);
          const syncingDelete = !!window._isSyncingDelete;
          const docChanges = snapshot.docChanges();
          
          if(docChanges.length === 0 && !initialSnapshot){
            return;
          }
          
          let changed = false;
          docChanges.forEach(ch=>{
            const data = Object.assign({id: ch.doc.id}, ch.doc.data());
            
            // Pomi≈Ñ je≈õli proces jest na li≈õcie usuniƒôtych
            if ((ch.type === 'added' || ch.type === 'modified') && deletedProcessesSet.has(data.id)) {
              console.log('üõ°Ô∏è [subscribeToProcessUpdates] Pomijam proces na li≈õcie usuniƒôtych:', data.id);
              return;
            }
            
            if(ch.type === 'added' || ch.type === 'modified'){
              console.log(`üîÑ [Firebase Processes] ${ch.type} proces:`, data.id, data.name);
              const idx = (state.processes||[]).findIndex(p=>p.id === data.id);
              if(idx >= 0){
                console.log(`‚úèÔ∏è [Firebase Processes] Aktualizujƒô istniejƒÖcy proces na pozycji ${idx}`);
                state.processes[idx] = Object.assign({}, state.processes[idx], data);
              } else if(!syncingDelete) {
                console.log('‚ûï [Firebase Processes] Dodajƒô nowy proces do listy');
                state.processes = state.processes || [];
                state.processes.push(data);
              }
              changed = true;
            } else if(ch.type === 'removed'){
              console.log(`üóëÔ∏è [Firebase Processes] Usuniƒôto proces:`, data.id, data.name);
              state.processes = (state.processes||[]).filter(p=>p.id !== data.id);
              changed = true;
            }
          });

          isInitialLoad = false;

          if(changed){
            save();
            try{ 
              renderProcList && renderProcList(); 
              // Aktualizuj licznik proces√≥w
              const procCountEl = document.querySelector('#proc-count');
              if(procCountEl) procCountEl.textContent = (state.processes || []).length;
            }catch(_){ }
            console.log(`‚úÖ [subscribeToProcessUpdates] Zaktualizowano - proces√≥w: ${(state.processes||[]).length}`);
          }
        }catch(e){
          console.warn('subscribeToProcessUpdates snapshot error', e && e.message);
        }
      }, err=>{ console.warn('processes onSnapshot error', err && err.message); });
      
      console.log('‚úÖ [subscribeToProcessUpdates] Subskrypcja aktywna');
    }catch(e){ console.warn('subscribeToProcessUpdates error', e && e.message); }
  }
  window.subscribeToProcessUpdates = subscribeToProcessUpdates;

  // ================================
  // Realtime listener dla OPERACJI
  // ================================
  async function subscribeToOperationUpdates(){
    if(state.storage.mode !== 'firebase') return;
    let isInitialLoad = true;
    try{
      const ok = await ensureFirebase(); if(!ok) return;
      if(window._operationsUnsub) try{ window._operationsUnsub(); }catch(_){ }
      const col = fbRoot().collection('operationsCatalog');
      
      console.log('üîÑ [subscribeToOperationUpdates] Subskrybujƒô zmiany operacji...');
      
      window._operationsUnsub = col.onSnapshot(snapshot=>{
        const initialSnapshot = isInitialLoad;
        try{
          const deletedOpsSet = new Set(Array.isArray(state.deletedOperations) ? state.deletedOperations : []);
          const docChanges = snapshot.docChanges();
          
          if(docChanges.length === 0 && !initialSnapshot){
            return;
          }
          
          let changed = false;
          docChanges.forEach(ch=>{
            const data = Object.assign({id: ch.doc.id}, ch.doc.data());
            
            // Pomi≈Ñ je≈õli operacja jest na li≈õcie usuniƒôtych
            if ((ch.type === 'added' || ch.type === 'modified') && deletedOpsSet.has(data.id)) {
              console.log('üõ°Ô∏è [subscribeToOperationUpdates] Pomijam operacjƒô na li≈õcie usuniƒôtych:', data.id);
              return;
            }
            
            if(ch.type === 'added' || ch.type === 'modified'){
              const idx = (state.operationsCatalog||[]).findIndex(o=>o.id === data.id);
              if(idx >= 0){
                state.operationsCatalog[idx] = Object.assign({}, state.operationsCatalog[idx], data);
              } else {
                // Sprawd≈∫ czy nie ma duplikatu po nazwie
                const normName = (data.name || '').trim().toUpperCase();
                const existsByName = (state.operationsCatalog||[]).some(o => 
                  (o.name || '').trim().toUpperCase() === normName
                );
                if(!existsByName){
                  state.operationsCatalog = state.operationsCatalog || [];
                  state.operationsCatalog.push(data);
                }
              }
              changed = true;
            } else if(ch.type === 'removed'){
              console.log(`üóëÔ∏è [Firebase Operations] Usuniƒôto operacjƒô:`, data.id, data.name);
              state.operationsCatalog = (state.operationsCatalog||[]).filter(o=>o.id !== data.id);
              changed = true;
            }
          });

          isInitialLoad = false;

          if(changed){
            save();
            try{ 
              renderOperationsCatalog && renderOperationsCatalog(); 
            }catch(_){ }
          }
        }catch(e){
          console.warn('subscribeToOperationUpdates snapshot error', e && e.message);
        }
      }, err=>{ console.warn('operationsCatalog onSnapshot error', err && err.message); });
      
      console.log('‚úÖ [subscribeToOperationUpdates] Subskrypcja aktywna');
    }catch(e){ console.warn('subscribeToOperationUpdates error', e && e.message); }
  }
  window.subscribeToOperationUpdates = subscribeToOperationUpdates;

  // üîÑ AUTO-SUBSCRIBE dla proces√≥w i operacji (po definicji funkcji)
  (async function autoSubscribeProcessesAndOperations(){ 
    try{ 
      if(state.storage && state.storage.mode==='firebase' && state.storage.autoLoadFromDB){ 
        console.log('üîÑ [Auto-Subscribe] Uruchamiam subskrypcje proces√≥w i operacji...');
        await subscribeToProcessUpdates(); 
        await subscribeToOperationUpdates(); 
        console.log('‚úÖ [Auto-Subscribe] Subskrypcje proces√≥w i operacji aktywne');
      } 
    }catch(e){ console.warn('autoSubscribeProcessesAndOperations err', e && e.message); } 
  })();
  
  // üîÑ NAS≈ÅUCHIWACZ na zmiany z Worker App (cross-tab sync via localStorage)
  (function setupWorkerAppSync() {
    // Nas≈Çuchuj na zmiany storage z innych kart (worker-app)
    window.addEventListener('storage', function(event) {
      // Interesuje nas tylko klucz plannerState (door_v50_state)
      if (event.key !== storeKey && event.key !== 'door_v50_state') return;
      if (!event.newValue) return;
      
      console.log('üì• [Worker Sync] Wykryto zmianƒô w localStorage z innej karty');
      
      try {
        const incomingState = JSON.parse(event.newValue);
        if (!incomingState || !Array.isArray(incomingState.tasks)) {
          console.warn('üì• [Worker Sync] Dane nie zawierajƒÖ poprawnej listy tasks');
          return;
        }
        
        // Merge przychodzƒÖcych zada≈Ñ z lokalnymi
        const incomingTasks = incomingState.tasks || [];
        let changed = false;
        
        incomingTasks.forEach(incomingTask => {
          if (!incomingTask || !incomingTask.id) return;
          
          const idx = (state.tasks || []).findIndex(t => t.id === incomingTask.id);
          if (idx >= 0) {
            const localTask = state.tasks[idx];
            
            // Sprawd≈∫ czy status siƒô zmieni≈Ç - priorytet: done > run > paused > todo
            const statusPriority = { 'done': 4, 'run': 3, 'paused': 2, 'todo': 1 };
            const localPriority = statusPriority[localTask.status] || 1;
            const incomingPriority = statusPriority[incomingTask.status] || 1;
            
            // Aktualizuj je≈õli przychodzƒÖcy status jest wy≈ºszy lub taki sam
            // (worker uko≈Ñczy≈Ç zadanie)
            if (incomingPriority >= localPriority) {
              const prevStatus = localTask.status;
              state.tasks[idx] = Object.assign({}, localTask, {
                status: incomingTask.status,
                startTime: incomingTask.startTime || localTask.startTime,
                endTime: incomingTask.endTime || localTask.endTime,
                actualTime: incomingTask.actualTime || localTask.actualTime,
                checklist: incomingTask.checklist || localTask.checklist
              });
              
              if (prevStatus !== incomingTask.status) {
                console.log(`üì• [Worker Sync] Zadanie ${incomingTask.id}: ${prevStatus} ‚Üí ${incomingTask.status}`);
                changed = true;
              }
            }
          }
        });
        
        if (changed) {
          console.log('üì• [Worker Sync] Zapisujƒô zmiany i od≈õwie≈ºam widok');
          save();
          try { renderTasks(); renderMonitor && renderMonitor(); } catch(_) {}
        }
      } catch(err) {
        console.warn('üì• [Worker Sync] B≈ÇƒÖd parsowania danych:', err);
      }
    });
    
    // Nas≈Çuchuj na CustomEvent plannerStateChanged (ta sama karta)
    window.addEventListener('plannerStateChanged', function(event) {
      console.log('üì• [Worker Sync] Otrzymano plannerStateChanged event');
      const detail = event.detail;
      if (!detail || !detail.taskId) return;
      
      const idx = (state.tasks || []).findIndex(t => t.id === detail.taskId);
      if (idx >= 0 && detail.status) {
        const prevStatus = state.tasks[idx].status;
        state.tasks[idx].status = detail.status;
        if (detail.startTime) state.tasks[idx].startTime = detail.startTime;
        if (detail.endTime) state.tasks[idx].endTime = detail.endTime;
        
        console.log(`üì• [Worker Sync] CustomEvent - zadanie ${detail.taskId}: ${prevStatus} ‚Üí ${detail.status}`);
        save();
        try { renderTasks(); renderMonitor && renderMonitor(); } catch(_) {}
      }
    });
    
    console.log('üîó [Worker Sync] Skonfigurowano nas≈Çuchiwacze na zmiany z worker-app');
  })();

  async function loadFromDB(opts){
    const options = opts || {};
    const forceLoad = options.forceLoad || false;
    const reason = options.reason || 'manual';
    
    // üîß ZACHOWAJ LISTY USUNIƒòTYCH ELEMENT√ìW - nie nadpisuj ich danymi z Firebase!
    // Najpierw spr√≥buj wczytaƒá z backup localStorage (osobny klucz)
    let backupDeletedOperations = [];
    try {
      const backup = localStorage.getItem('deletedOperations_backup');
      if(backup) {
        backupDeletedOperations = JSON.parse(backup);
        console.log('üì¶ [loadFromDB] Wczytano deletedOperations z backup:', backupDeletedOperations);
      }
    } catch(e) { console.warn('Nie uda≈Ço siƒô wczytaƒá deletedOperations backup:', e); }
    
    const preservedDeletedOperations = backupDeletedOperations.length > 0 
      ? backupDeletedOperations 
      : (Array.isArray(state.deletedOperations) ? state.deletedOperations.slice() : []);
    let preservedDeletedProcesses = Array.isArray(state.deletedProcesses) ? state.deletedProcesses.slice() : [];
    const preservedDeletedOrders = Array.isArray(state.deletedOrders) ? state.deletedOrders.slice() : [];
    
    // üîß POBIERZ deletedProcesses z Firebase (aby inne karty/domeny wiedzia≈Çy o usuniƒôciach)
    try {
      const ok = await ensureFirebase();
      if (ok) {
        const deletedProcDoc = await fbRoot().collection('metadata').doc('deletedProcesses').get();
        if (deletedProcDoc.exists) {
          const firebaseDeletedProcesses = deletedProcDoc.data().ids || [];
          console.log('üì¶ [loadFromDB] Pobrano deletedProcesses z Firebase:', firebaseDeletedProcesses);
          // Po≈ÇƒÖcz lokalne i zdalne listy usuniƒôtych proces√≥w
          const mergedDeleted = [...new Set([...preservedDeletedProcesses, ...firebaseDeletedProcesses])];
          if (mergedDeleted.length > preservedDeletedProcesses.length) {
            console.log(`üîÑ [loadFromDB] Po≈ÇƒÖczono deletedProcesses: lokalne ${preservedDeletedProcesses.length} + Firebase ${firebaseDeletedProcesses.length} = ${mergedDeleted.length}`);
            preservedDeletedProcesses = mergedDeleted;
            state.deletedProcesses = mergedDeleted;
          }
        }
      }
    } catch(e) { console.warn('Nie uda≈Ço siƒô wczytaƒá deletedProcesses z Firebase:', e); }
    
    if(preservedDeletedOperations.length > 0){
      console.log('üîí [loadFromDB] Zachowujƒô deletedOperations przed wczytaniem z Firebase:', preservedDeletedOperations);
    }
    if(preservedDeletedProcesses.length > 0){
      console.log('üîí [loadFromDB] Zachowujƒô deletedProcesses przed wczytaniem z Firebase:', preservedDeletedProcesses);
    }
    
    // üîí BLOKADA PODCZAS USUWANIA - Nie wczytuj starych danych gdy usuwamy (TYLKO dla orders/tasks)
    if (window._isSyncingDelete && !options.allowDuringDelete) {
      console.log('üîí [loadFromDB] Pomijam wczytywanie z Firebase (trwa synchronizacja usuniƒôcia)', {
        reason,
        forceLoad,
        lastRemoteSync: state && state.storage ? state.storage.lastRemoteSync : undefined
      });
      const infoEl = qs('#set-info');
      if (infoEl) {
        infoEl.textContent = 'üîí Trwa synchronizacja usuniƒôcia ‚Äì pobieranie odroczone.';
      }
      return { skipped: true, reason: 'sync-delete-in-progress' };
    }
    
    if(state.storage.mode!=='firebase'){qs('#set-info').textContent='Tryb localStorage (offline)';return;}
    const ok=await ensureFirebase(); if(!ok){return;}
    try {
      const r=fbRoot();
      
      // Get metadata with timestamp
      const metadataDoc = await r.collection('metadata').doc('sync').get();
      const remoteTimestamp = metadataDoc.exists ? (metadataDoc.data().lastModified || 0) : 0;
      const localTimestamp = state.lastModified || 0;
      const lastRemoteSync = state.storage.lastRemoteSync || 0;
      const localCollections = {
        employees: state.employees || [],
        operationsCatalog: state.operationsCatalog || [],
        processes: state.processes || [],
        orders: state.orders || [],
        tasks: state.tasks || [],
        after: state.after || []
      };
      const localCountTotal = Object.values(localCollections)
        .reduce((sum, collection)=> sum + (Array.isArray(collection) ? collection.length : (collection && typeof collection === 'object' ? Object.keys(collection).length : 0)), 0);
      
      // Sprawd≈∫ czy dane lokalne by≈Çy niedawno modyfikowane (ostatnie 30 sekund)
      const timeSinceLastModification = Date.now() - localTimestamp;
      const recentlyModified = timeSinceLastModification < 30000; // 30 sekund
      
      console.log('üîÑ Por√≥wnanie timestamp√≥w:', {
        local: new Date(localTimestamp).toLocaleString('pl-PL'),
        remote: new Date(remoteTimestamp).toLocaleString('pl-PL'),
        localNewer: localTimestamp > remoteTimestamp,
        recentlyModified,
        timeSinceLastMod: `${Math.round(timeSinceLastModification / 1000)}s`,
        lastRemoteSync: lastRemoteSync ? new Date(lastRemoteSync).toLocaleString('pl-PL') : null,
        localOrders: (state.orders || []).length,
        localCountTotal,
        forceLoad,
        reason
      });
      
      // OCHRONA: Tylko gdy forceLoad=false I dane lokalne ≈õwie≈ºe (<10s) I jest reason="auto"
      const localOrdersCount = (state.orders || []).length;
      if(!forceLoad && reason === 'auto' && recentlyModified && timeSinceLastModification < 10000 && localCountTotal > 0) {
        console.log('üõ°Ô∏è Auto-sync pominiƒôty (dane ≈õwie≈ºe <10s)');
        console.log('üìä Zachowano lokalne zlecenia:', localOrdersCount);
        qs('#set-info').textContent='üîÑ Auto-sync pominiƒôty (dane ≈õwie≈ºe)';
        return { skipped: true, reason: 'auto-sync-skip', localTimestamp, remoteTimestamp };
      }
      
      if (forceLoad) {
        console.log('üîÑ WYMUSZAM wczytanie z Firebase (reason:', reason, ')');
      }
      
      // DIAGNOSTYKA: Loguj dlaczego wczytujemy z Firebase
      if (remoteTimestamp > 0) {
        console.log('üì• DECYZJA: Wczytam dane z Firebase, poniewa≈º:', {
          condition1_remoteExists: remoteTimestamp > 0,
          condition2_localNotNewer: !(localTimestamp > remoteTimestamp),
          condition3_notSynced: !(lastRemoteSync >= remoteTimestamp),
          condition4_hasLocalData: localCountTotal > 0,
          willLoad: true
        });
      }
      
      const getAll=async(name)=>(await r.collection(name).get()).docs.map(d=>({id:d.id,...d.data()}));
      const [employees,operationsCatalog,processes,orders,tasks,after,warehouseItemsPrimary,warehouseItemsLegacy,materialTemplates,warehouseTasks]=await Promise.all([
        getAll('employees'),
        getAll('operationsCatalog'),
        getAll('processes'),
        getAll('orders'),
        getAll('tasks'),
        getAll('after'),
        getAll(WAREHOUSE_COLLECTION),
        WAREHOUSE_COLLECTION === LEGACY_WAREHOUSE_COLLECTION ? Promise.resolve([]) : getAll(LEGACY_WAREHOUSE_COLLECTION),
        getAll('materialTemplates'),
        getAll('warehouseTasks')
      ]);

      let warehouseItems = warehouseItemsPrimary;
      if((!warehouseItems || warehouseItems.length === 0) && Array.isArray(warehouseItemsLegacy) && warehouseItemsLegacy.length){
        console.warn(`üì¶ [loadFromDB] Wykryto legacy kolekcjƒô '${LEGACY_WAREHOUSE_COLLECTION}' ‚Äì migrujƒô ${warehouseItemsLegacy.length} pozycji do nowej kolekcji '${WAREHOUSE_COLLECTION}'.`);
        warehouseItems = warehouseItemsLegacy.slice();
        window._pendingLegacyWarehouseCleanup = warehouseItemsLegacy.map(item => item && item.id).filter(Boolean);
      } else {
        window._pendingLegacyWarehouseCleanup = [];
      }

      const remoteCollections = { employees, operationsCatalog, processes, orders, tasks, after, warehouseItems, materialTemplates, warehouseTasks };
      const deletedOrdersSet = new Set(preservedDeletedOrders.length > 0 ? preservedDeletedOrders : (Array.isArray(state.deletedOrders) ? state.deletedOrders : []));
      const deletedProcessesSet = new Set(preservedDeletedProcesses.length > 0 ? preservedDeletedProcesses : (Array.isArray(state.deletedProcesses) ? state.deletedProcesses : []));
      const deletedOperationsSet = new Set(preservedDeletedOperations.length > 0 ? preservedDeletedOperations : (Array.isArray(state.deletedOperations) ? state.deletedOperations : []));
      
      // DIAGNOSTYKA - poka≈º ile operacji jest oznaczonych do usuniƒôcia
      if(deletedOperationsSet.size > 0){
        console.log(`üóëÔ∏è [loadFromDB] Mam ${deletedOperationsSet.size} operacji oznaczonych do usuniƒôcia:`, Array.from(deletedOperationsSet));
      }

      const remoteCountTotal = Object.values(remoteCollections)
        .reduce((sum, collection)=> sum + (Array.isArray(collection) ? collection.length : (collection && typeof collection === 'object' ? Object.keys(collection).length : 0)), 0);

      console.log('üì• Pobrano z Firebase:', {
        orders: orders.length,
        tasks: tasks.length,
        employees: employees.length,
        operationsCatalog: operationsCatalog.length,
        processes: processes.length,
        after: after ? Object.keys(after).length : 0,
        remoteCountTotal
      });
      
      // DIAGNOSTYKA SZCZEG√ì≈ÅOWA
      console.log('üîç DIAGNOSTYKA FIREBASE:');
      console.log('  üì¶ Zlecenia (orders):', orders.length, orders.length > 0 ? orders.slice(0, 2) : 'PUSTE');
      console.log('  ‚úÖ Zadania (tasks):', tasks.length, tasks.length > 0 ? tasks.slice(0, 2) : 'PUSTE');
      console.log('  üë∑ Pracownicy (employees):', employees.length, employees.length > 0 ? employees : 'PUSTE');
      console.log('  üìã Katalog operacji (operationsCatalog):', operationsCatalog.length, operationsCatalog.length > 0 ? operationsCatalog.slice(0, 3) : 'PUSTE');
      console.log('  üîÑ Procesy (processes):', processes.length, processes.length > 0 ? processes.slice(0, 2) : 'PUSTE');
      console.log(`  üì¶ Magazyn (${WAREHOUSE_COLLECTION}):`, warehouseItems.length, warehouseItems.length > 0 ? warehouseItems : 'PUSTE');
      console.log('  üìë Szablony materia≈Çowe (materialTemplates):', materialTemplates.length, materialTemplates.length > 0 ? materialTemplates : 'PUSTE');
      console.log('  üìã Zadania magazynowe (warehouseTasks):', warehouseTasks.length, warehouseTasks.length > 0 ? warehouseTasks : 'PUSTE');
      console.log('  üîó After (magazyn/monta≈º):', after ? Object.keys(after) : 'PUSTE', after);

      if(remoteCountTotal === 0 && localCountTotal > 0){
        console.warn('[firebase] loadFromDB: zdalne kolekcje sƒÖ puste ‚Äì pomijam nadpisanie lokalnych danych.');
        qs('#set-info').textContent='‚ö†Ô∏è Brak danych w Firebase ‚Äì zachowano lokalne dane.';
        return { skipped: true, reason: 'empty-remote' };
      }

      const skipped = [];
      const updated = [];
      Object.entries(remoteCollections).forEach(([key, collection])=>{
        const remoteLen = Array.isArray(collection) ? collection.length : (collection && typeof collection === 'object' ? Object.keys(collection).length : 0);
        const localLen = Array.isArray(localCollections[key]) ? localCollections[key].length : (localCollections[key] && typeof localCollections[key] === 'object' ? Object.keys(localCollections[key]).length : 0);

        // üîí BLOKADA PODCZAS USUWANIA - Nie nadpisuj orders/tasks gdy usuwamy
        if (window._isSyncingDelete && (key === 'orders' || key === 'tasks')) {
          console.log(`üîí [loadFromDB] Blokujƒô aktualizacjƒô ${key} (trwa synchronizacja usuniƒôcia)`);
          skipped.push(key);
          return;
        }

        if(remoteLen === 0 && localLen > 0){
          console.log(`‚è≠Ô∏è Pominiƒôto kolekcjƒô '${key}' (zdalna pusta, lokalna ma ${localLen} element√≥w)`);
          skipped.push(key);
          return;
        }

        console.log(`üìù Aktualizujƒô kolekcjƒô '${key}': lokalna=${localLen}, zdalna=${remoteLen}`);
        let dataToLoad = Array.isArray(collection) ? collection.slice() : (collection ? JSON.parse(JSON.stringify(collection)) : Array.isArray(state[key]) ? [] : {});
        
        // FILTROWANIE: Usun testowe ID z ka≈ºdej kolekcji podczas wczytywania z Firebase
        if(key === 'tasks' && Array.isArray(dataToLoad)){
          const testTasksCount = dataToLoad.length;
          dataToLoad = dataToLoad.filter(t => {
            // Odrzuƒá testowe zadania (task1-task6, task_test_*)
            const isTestTask = /^task\d+$/.test(t.id) || (t.id && t.id.startsWith('task_test_'));
            if(isTestTask){
              console.warn(`  üö´ Odrzucam testowe zadanie: ${t.id}`);
            }
            return !isTestTask;
          });
          if(testTasksCount !== dataToLoad.length){
            console.log(`  ‚ö†Ô∏è Odrzucono ${testTasksCount - dataToLoad.length} testowych zada≈Ñ`);
          }
        }
        
        if(key === 'orders' && Array.isArray(dataToLoad)){
          dataToLoad = dataToLoad.filter(o => {
            // Odrzuƒá testowe zlecenia (order1, order_test_*)
            const isTestOrder = o.id === 'order1' || (o.id && o.id.startsWith('order_test_'));
            if(isTestOrder){
              console.warn(`  üö´ Odrzucam testowe zlecenie: ${o.id}`);
            }
            return !isTestOrder;
          });
          if(deletedOrdersSet.size){
            const beforeLen = dataToLoad.length;
            dataToLoad = dataToLoad.filter(o => !deletedOrdersSet.has(o.id));
            const removedLen = beforeLen - dataToLoad.length;
            if(removedLen>0){
              console.log(`  üßπ [loadFromDB] Pomijam ${removedLen} zdalnych zlece≈Ñ oznaczonych jako usuniƒôte lokalnie`);
            }
          }
        }

        if(key === 'processes' && Array.isArray(dataToLoad) && deletedProcessesSet.size){
          const beforeLen = dataToLoad.length;
          dataToLoad = dataToLoad.filter(p => !deletedProcessesSet.has(p.id));
          const removedLen = beforeLen - dataToLoad.length;
          if(removedLen>0){
            console.log(`  üßπ [loadFromDB] Pomijam ${removedLen} zdalnych proces√≥w oznaczonych do usuniƒôcia lokalnie`);
          }
        }

        // üîß FILTROWANIE USUNIƒòTYCH OPERACJI
        if(key === 'operationsCatalog' && Array.isArray(dataToLoad)){
          console.log(`üîç [loadFromDB] operationsCatalog: ${dataToLoad.length} operacji, deletedOperationsSet.size=${deletedOperationsSet.size}`);
          if(deletedOperationsSet.size > 0){
            const beforeLen = dataToLoad.length;
            dataToLoad = dataToLoad.filter(op => !deletedOperationsSet.has(op.id));
            const removedLen = beforeLen - dataToLoad.length;
            if(removedLen>0){
              console.log(`  üßπ [loadFromDB] Pomijam ${removedLen} zdalnych operacji oznaczonych do usuniƒôcia lokalnie`);
            }
          }
          
          // üîß AGRESYWNA DEDUPLIKACJA - usu≈Ñ wszystkie duplikaty po nazwie (zachowaj pierwszy)
          const beforeDedup = dataToLoad.length;
          const seenNames = new Set();
          const dedupedOps = [];
          dataToLoad.forEach(op => {
            const key = (op.name || '').replace(/\s+/g, ' ').trim().toLowerCase();
            if (!key) return; // Pomi≈Ñ operacje bez nazwy
            if (seenNames.has(key)) {
              console.log(`  üóëÔ∏è [loadFromDB] Usuwam duplikat operacji: "${op.name}" (ID: ${op.id})`);
              return;
            }
            seenNames.add(key);
            dedupedOps.push(op);
          });
          
          if (dedupedOps.length !== beforeDedup) {
            console.log(`  ‚ö†Ô∏è [loadFromDB] DEDUPLIKACJA operacji: ${beforeDedup} -> ${dedupedOps.length} (usuniƒôto ${beforeDedup - dedupedOps.length})`);
            dataToLoad = dedupedOps;
          }
          
          // Przenumeruj operacje
          dataToLoad.forEach((op, idx) => { op.no = idx + 1; });
        }
        
        if(key === 'employees' && Array.isArray(dataToLoad)){
          dataToLoad = dataToLoad.filter(e => {
            // Odrzuƒá testowych pracownik√≥w (emp1-emp4, emp_test_*)
            const isTestEmployee = /^emp\d+$/.test(e.id) || (e.id && e.id.startsWith('emp_test_'));
            if(isTestEmployee){
              console.warn(`  üö´ Odrzucam testowego pracownika: ${e.id}`);
            }
            return !isTestEmployee;
          });
          
          // üîÑ DEDUPLIKACJA: Usuniƒôcie duplikat√≥w pracownik√≥w (ten sam imiƒô/nazwisko)
          const seenNames = new Set();
          const dedupedEmployees = [];
          dataToLoad.forEach(emp => {
            const nameKey = `${emp.name}||${emp.role || 'Inne'}`.toLowerCase();
            if(!seenNames.has(nameKey)){
              seenNames.add(nameKey);
              dedupedEmployees.push(emp);
              console.log(`  ‚úÖ Pracownik: ${emp.name} (ID: ${emp.id})`);
            } else {
              console.warn(`  üîÑ [DEDUPLIKACJA] Usuniƒôty duplikat pracownika: ${emp.name} (ID: ${emp.id}) - zachowujƒô pierwszego`);
            }
          });
          
          if(dedupedEmployees.length < dataToLoad.length){
            console.log(`  ‚ö†Ô∏è [DEDUPLIKACJA PRACOWNIK√ìW] Usuniƒôto ${dataToLoad.length - dedupedEmployees.length} duplikat√≥w`);
            dataToLoad = dedupedEmployees;
          }
        }

        if(key === 'tasks' && Array.isArray(dataToLoad) && deletedOrdersSet.size){
          const beforeLen = dataToLoad.length;
          dataToLoad = dataToLoad.filter(t => !deletedOrdersSet.has(t.orderId));
          const removedLen = beforeLen - dataToLoad.length;
          if(removedLen>0){
            console.log(`  üßπ [loadFromDB] Pomijam ${removedLen} zdalnych zada≈Ñ powiƒÖzanych ze skasowanymi zleceniami`);
          }
        }

        if(key === 'after' && Array.isArray(dataToLoad) && deletedOrdersSet.size){
          const beforeLen = dataToLoad.length;
          dataToLoad = dataToLoad.filter(a => !deletedOrdersSet.has(a.order));
          const removedLen = beforeLen - dataToLoad.length;
          if(removedLen>0){
            console.log(`  üßπ [loadFromDB] Pomijam ${removedLen} wpis√≥w monta≈ºowych powiƒÖzanych ze skasowanymi zleceniami`);
          }
        }

        if(key === 'operationsCatalog' && Array.isArray(dataToLoad)){
          const beforeOps = dataToLoad.length;
          dedupeOperationsCatalog(dataToLoad, 'loadFromDB');
          if(dataToLoad.length !== beforeOps){
            console.warn(`  ‚ö†Ô∏è [loadFromDB] Operacje zredukowane z ${beforeOps} do ${dataToLoad.length}`);
          }
          ensureOperationsCatalogChecklists(dataToLoad);
        }
        
        // Specjalna obs≈Çuga dla warehouseItems - przypisz do window.warehouseItems
        if(key === 'warehouseItems' && Array.isArray(dataToLoad)){
          console.log(`üì¶ [loadFromDB] Wczytujƒô magazyn (${WAREHOUSE_COLLECTION}): ${dataToLoad.length} pozycji`);
          window.warehouseItems = dataToLoad;
          try{ localStorage.setItem(WAREHOUSE_LOCAL_KEY, JSON.stringify(dataToLoad)); }catch(e){ console.warn('[loadFromDB] Nie uda≈Ço siƒô zapisaƒá magazynu do nowego klucza localStorage:', e && e.message); }
          try{ localStorage.setItem(LEGACY_WAREHOUSE_LOCAL_KEY, JSON.stringify(dataToLoad)); }catch(e){ console.warn('[loadFromDB] Nie uda≈Ço siƒô zaktualizowaƒá legacy magazynu w localStorage:', e && e.message); }
          console.log(`‚úÖ [loadFromDB] Magazyn zsynchronizowany (${dataToLoad.length} pozycji)`);
        }
        
        // Specjalna obs≈Çuga dla materialTemplates - przypisz do window.materialTemplates
        if(key === 'materialTemplates' && Array.isArray(dataToLoad)){
          console.log(`üìë [loadFromDB] Wczytujƒô szablony materia≈Çowe: ${dataToLoad.length} szablon√≥w`);
          window.materialTemplates = dataToLoad;
          try{ localStorage.setItem('materialTemplates', JSON.stringify(dataToLoad)); }catch(e){ console.warn('[loadFromDB] Nie uda≈Ço siƒô zapisaƒá szablon√≥w do localStorage:', e && e.message); }
          console.log(`‚úÖ [loadFromDB] Szablony zsynchronizowane (${dataToLoad.length} szablon√≥w)`);
        }
        
        // Specjalna obs≈Çuga dla warehouseTasks - przypisz do window.warehouseTasks
        if(key === 'warehouseTasks' && Array.isArray(dataToLoad)){
          console.log(`üìã [loadFromDB] Wczytujƒô zadania magazynowe: ${dataToLoad.length} zada≈Ñ`);
          window.warehouseTasks = dataToLoad;
          try{ localStorage.setItem('warehouseTasks', JSON.stringify(dataToLoad)); }catch(e){ console.warn('[loadFromDB] Nie uda≈Ço siƒô zapisaƒá zada≈Ñ magazynowych do localStorage:', e && e.message); }
          console.log(`‚úÖ [loadFromDB] Zadania magazynowe zsynchronizowane (${dataToLoad.length} zada≈Ñ)`);
        }
        
        if(key === 'operationsCatalog'){
          ensureOperationsCatalogChecklists(dataToLoad);
        }
        state[key] = dataToLoad;
        updated.push(key);
      });

      if(updated.length === 0){
        console.log('[firebase] loadFromDB: brak zmian po wczytaniu danych (wszystkie kolekcje puste).');
        qs('#set-info').textContent = skipped.length ? '‚ö†Ô∏è Czƒô≈õƒá kolekcji w Firebase by≈Ça pusta ‚Äì zachowano lokalne dane.' : '‚ÑπÔ∏è Brak zmian ‚Äì kolekcje Firebase puste.';
        return { skippedCollections: skipped };
      }

      // Update local timestamp to match remote after successful load
      state.lastModified = remoteTimestamp;
  state.storage.lastRemoteSync = remoteTimestamp;
      console.log('‚úÖ Wczytano z Firebase - zaktualizowano lokalny timestamp:', new Date(remoteTimestamp).toLocaleString('pl-PL'));
      
      // üîß PRZYWR√ìƒÜ LISTY USUNIƒòTYCH ELEMENT√ìW - muszƒÖ przetrwaƒá synchronizacjƒô!
      if(preservedDeletedOperations.length > 0){
        state.deletedOperations = preservedDeletedOperations;
        console.log('üîí [loadFromDB] Przywr√≥cono deletedOperations po sync:', state.deletedOperations);
      }
      if(preservedDeletedProcesses.length > 0){
        state.deletedProcesses = preservedDeletedProcesses;
      }
      if(preservedDeletedOrders.length > 0){
        state.deletedOrders = preservedDeletedOrders;
      }
      
      // KRYTYCZNE: Synchronizuj window.state z lokalnƒÖ zmiennƒÖ state
      window.state = state;
      console.log('üîÑ Zsynchronizowano window.state z wczytanymi danymi');
      
      save();
      if(skipped.length){
        console.warn('[firebase] loadFromDB: pominiƒôto puste kolekcje', skipped);
      }
      
      // Poka≈º szczeg√≥≈Çowy komunikat o za≈Çadowanych danych
      const loadSummary = `‚úÖ Wczytano z Firebase: Zlecenia=${orders.length}, Zadania=${tasks.length}, Pracownicy=${employees.length}, Operacje=${operationsCatalog.length}, Procesy=${processes.length}`;
      qs('#set-info').textContent = loadSummary;
      console.log(loadSummary);
      
      // Aktualizuj filtry zada≈Ñ po za≈Çadowaniu danych
      try{ updateTaskFilters(); }catch(e){ console.warn('updateTaskFilters error', e); }
      
      // Od≈õwie≈º magazyn je≈õli u≈ºytkownik jest na stronie magazynu
      if(state.page === 'warehouse') {
        try { 
          renderWarehouse(); 
          console.log('üè™ Od≈õwie≈ºono widok magazynu po za≈Çadowaniu danych z Firebase');
        } catch(e) { 
          console.warn('renderWarehouse error after loadFromDB', e); 
        }
      }
      
      if(state.page==='order') renderOrderPage(); if(state.page==='tasks') renderTasks(); if(state.page==='opcat') renderOps();
  if(state.page==='proc') renderProcPage(); if(state.page==='emp') renderEmployees(); if(state.page==='as') renderASPage(); renderDash(); renderGantt();
      return { updatedCollections: updated, skippedCollections: skipped };
    } catch(e) {
      qs('#set-info').textContent='‚ùå B≈ÇƒÖd wczytywania z DB: '+e.message;
      throw e;
    }
  }
  try {
    window.loadFromDB = loadFromDB;
  } catch(assignErr) {
    console.warn('Nie uda≈Ço siƒô zarejestrowaƒá loadFromDB w globalnym oknie:', assignErr && assignErr.message);
  }
  qs('#set-test').addEventListener('click',async()=>{
    try{
  state.storage.mode=qs('#set-mode').value; state.storage.appId=qs('#set-appid').value.trim(); state.storage.userId=qs('#set-userid').value.trim();
  if(qs('#set-usercollection')){
    const customCollection = qs('#set-usercollection').value.trim();
    if(customCollection){
      state.storage.userCollection = customCollection;
    }else{
      delete state.storage.userCollection;
    }
  }
  window._activeUserCollection = state.storage.userCollection || null;
  window._activeUserCollectionApp = null;
  if(typeof updateScheduleConfigFromUI === 'function'){ updateScheduleConfigFromUI(); }
  try{ if(window.scheduleCore){ window.scheduleCore.generateSchedule(state); } }catch(e){ console.warn('regen schedule', e.message); }
  renderGantt();
      try{state.storage.fbConfig=JSON.parse(qs('#set-fb').value||'{}');}catch(e){qs('#set-info').textContent='B≈Çƒôdny JSON';return;}
      save(); updateConnectionStatus(); if(state.storage.mode!=='firebase'){qs('#set-info').textContent='Tryb localStorage (offline)';return;}
      const ok=await ensureFirebase(); if(!ok) throw new Error('Firebase init failed');
      const cred=await firebase.auth().signInAnonymously(); qs('#set-info').textContent='‚úÖ Po≈ÇƒÖczono. UID: '+(cred.user&&cred.user.uid);
    }catch(e){qs('#set-info').textContent='‚ùå B≈ÇƒÖd: '+e.message;}
  });
  qs('#set-save').addEventListener('click',saveToDB);
  qs('#set-load').addEventListener('click',loadFromDB);

  // Export/import tasks and assignments
  function exportTasks(){
    const payload = { exportedAt: new Date().toISOString(), tasks: state.tasks || [], assignments: (state.tasks||[]).map(t=>({id:t.id,assignees:t.assignees||[]})) };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tasks_export_'+(new Date().toISOString().slice(0,10))+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  async function importTasksFromFile(file){
    try{
      const text = await file.text(); const obj = JSON.parse(text);
      if(!obj || !Array.isArray(obj.tasks)) { alert('Nieprawid≈Çowy plik'); return; }
      // Merge: replace tasks, but preserve employees and orders mapping
      state.tasks = obj.tasks.map(t=>({id:t.id||uid(), orderId:t.orderId||'', opName:t.opName||'', status:t.status||'todo', elapsedMin:t.elapsedMin||0, estMin:t.estMin||0, assignees:t.assignees||[]}));
      save(); renderTasks(); maybeAutoSave('import-tasks');
      alert('Zaimportowano zadania: '+state.tasks.length);
    }catch(e){ alert('B≈ÇƒÖd importu: '+e.message); }
  }
  qs('#export-tasks').addEventListener('click',exportTasks);
  qs('#import-tasks').addEventListener('click',()=>qs('#import-tasks-file').click());
  qs('#import-tasks-file').addEventListener('change',(ev)=>{ const f=ev.target.files&&ev.target.files[0]; if(f) importTasksFromFile(f); });
  qs('#restore-click-delegation').addEventListener('click', () => {
    window.restoreNormalClickDelegation();
    alert('Przywr√≥cono normalnƒÖ obs≈Çugƒô klikniƒôƒá! Spr√≥buj teraz kliknƒÖƒá w inne przyciski.');
  });
  qs('#capacity-refresh').addEventListener('click', () => renderCapacityAnalysis());
  qs('#capacity-optimize').addEventListener('click', () => {
    const suggestions = calculateOptimizationSuggestions();
    if(suggestions.length === 0){
      alert('ObciƒÖ≈ºenie jest ju≈º zoptymalizowane! üéâ');
    } else {
      alert(`Znaleziono ${suggestions.length} sugestii optymalizacji. Sprawd≈∫ sekcjƒô "Sugestie optymalizacji obciƒÖ≈ºenia".`);
      renderOptimizationSuggestions(suggestions);
    }
  });
  qs('#capacity-export').addEventListener('click', () => {
    const utilization = calculateResourceUtilization(qs('#capacity-period').value || 'week');
    if(utilization.length === 0){ alert('Brak danych do eksportu.'); return; }
    const csv = ['employee,totalTasks,totalTimeH,availableTimeH,utilizationPercent,status'].concat(
      utilization.map(u => `"${u.employee}","${u.totalTasks}","${(u.totalTime/60).toFixed(1)}","${(u.availableTime/60).toFixed(1)}","${u.utilization}","${u.status}"`)
    ).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'capacity_analysis_' + new Date().toISOString().slice(0,10) + '.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
  qs('#restore-authentic-data').addEventListener('click', () => {
    if (confirm('Czy na pewno chcesz przywr√≥ciƒá autentyczne dane? To nadpisze wszystkie obecne dane w aplikacji.')) {
      restoreAuthenticData();
    }
  });
  
  // Force load from Firebase
  qs('#force-load-firebase').addEventListener('click', async () => {
    if (!confirm('‚ö†Ô∏è Czy na pewno pobraƒá dane z Firebase?\n\nTo NADPISZE wszystkie lokalne dane!')) return;
    
    try {
      qs('#force-load-firebase').disabled = true;
      qs('#force-load-firebase').textContent = '‚è≥ Pobieram...';
      
      // Wymu≈õ pobranie z Firebase
      const result = await loadFromDB({ forceLoad: true, reason: 'manual-force' });
      
      if (result && result.skipped) {
        alert('‚ùå Pobieranie zablokowane: ' + result.reason);
      } else {
        const summary = `‚úÖ Dane pobrane z Firebase!\n\n` +
          `üì¶ Zlecenia: ${state.orders?.length || 0}\n` +
          `‚úÖ Zadania: ${state.tasks?.length || 0}\n` +
          `üë∑ Pracownicy: ${state.employees?.length || 0}\n` +
          `üìã Operacje: ${state.operationsCatalog?.length || 0}\n` +
          `üîÑ Procesy: ${state.processes?.length || 0}\n` +
          `üè™ Magazyn: ${state.after?.warehouse?.length || 0}\n` +
          `üîß Monta≈º: ${state.after?.assembly?.length || 0}`;
        alert(summary);
        location.reload();
      }
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd pobierania z Firebase:', err);
      alert('‚ùå B≈ÇƒÖd: ' + err.message);
    } finally {
      qs('#force-load-firebase').disabled = false;
      qs('#force-load-firebase').textContent = '‚¨áÔ∏è Pobierz z Firebase';
    }
  });

  // Zapisz wersjƒô - pobiera HTML i zapisuje
  qs('#save-version-btn').addEventListener('click', () => {
    try {
      const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
      const htmlContent = document.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `index_${timestamp}.html`;
      a.click();
      URL.revokeObjectURL(url);
      alert('‚úÖ Wersja zapisana jako: index_' + timestamp + '.html\n\nüìÅ Sprawd≈∫ folder Pobrane');
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd zapisu:', err);
      alert('‚ùå B≈ÇƒÖd zapisu: ' + err.message);
    }
  });

  // Wyczy≈õƒá testowe dane z Firebase
  qs('#clear-test-employees').addEventListener('click', async () => {
    if (!confirm('‚ö†Ô∏è UsunƒÖƒá WSZYSTKIE testowe dane z Firebase?\n\n' +
      'üë∑ Pracownicy: emp1-emp4 (Jan Kowalski, Anna, Piotr, Maria)\n' +
      'üì¶ Zlecenia: order1, order_test_*\n' +
      '‚úÖ Zadania: task1-task6, task_test_*\n\n' +
      'Zostanie tylko Tw√≥j prawdziwy pracownik: PIOTR')) return;
    
    try {
      const ok = await ensureFirebase();
      if (!ok) {
        alert('‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá z Firebase');
        return;
      }
      
      const db = firebase.firestore();
      const r = fbRoot();
      
      console.log('üóëÔ∏è Rozpoczynam usuwanie testowych danych...');
      
      // KROK 1: NAJPIERW USU≈É Z LOCALSTORAGE - ≈ºeby saveToDB() nie zapisa≈Ço z powrotem!
      console.log('üóëÔ∏è KROK 1: Usuwam testowe zadania z localStorage...');
      const s = window.state || state;
      
      // Usu≈Ñ testowe zadania z state.tasks
      const beforeCount = (s.tasks || []).length;
      s.tasks = (s.tasks || []).filter(t => {
        const isTestTask = /^task\d+$/.test(t.id) || t.id.startsWith('task_test_');
        if (isTestTask) {
          console.log(`  üóëÔ∏è Usuwam z localStorage: ${t.id}`);
        }
        return !isTestTask;
      });
      const removedCount = beforeCount - s.tasks.length;
      console.log(`‚úÖ Usuniƒôto ${removedCount} zada≈Ñ z localStorage`);
      
      // Zapisz oczyszczony stan do localStorage
      s.lastModified = Date.now();
      save();
      console.log('‚úÖ KROK 1 zako≈Ñczony: localStorage oczyszczony i zapisany');
      
      // KROK 2: TERAZ USU≈É Z FIREBASE (saveToDB usunie bo nie ma w localStorage)
      console.log('üóëÔ∏è KROK 2: Synchronizujƒô oczyszczony stan z Firebase...');
      if (s.storage && s.storage.mode === 'firebase' && typeof saveToDB === 'function') {
        await saveToDB().catch(err => console.error('‚ùå B≈ÇƒÖd sync:', err));
        console.log('‚úÖ KROK 2 zako≈Ñczony: Firebase zsynchronizowany (usunƒÖ≈Ç task1-6)');
      }
      
      // KROK 2B: WYMU≈ö resetowanie lastRemoteSync aby nastƒôpne loadFromDB pobra≈Ço dane
      console.log('üîÑ KROK 2B: Resetujƒô znacznik lastRemoteSync...');
      s.storage.lastRemoteSync = 0; // Wymu≈õ nastƒôpne wczytanie z Firebase
      save();
      console.log('‚úÖ KROK 2B: lastRemoteSync=0 (nastƒôpne auto-sync pobierze ≈õwie≈ºe dane)');
      
      // KROK 3: SPRAWD≈π co zosta≈Ço w Firebase
      console.log('ÔøΩ KROK 3: Sprawdzam co zosta≈Ço w Firebase...');
      const [employeesSnap, ordersSnap, tasksSnap] = await Promise.all([
        r.collection('employees').get(),
        r.collection('orders').get(),
        r.collection('tasks').get()
      ]);
      
      const deleted = {
        employees: 0,
        orders: 0, 
        tasks: removedCount
      };
      
      console.log(`ÔøΩ Firebase po synchronizacji:`);
      console.log(`  üë∑ Pracownicy: ${employeesSnap.size}`);
      console.log(`  üì¶ Zlecenia: ${ordersSnap.size}`);
      console.log(`  ‚úÖ Zadania: ${tasksSnap.size}`);
      
      // Zapisz oczyszczony stan
      s.lastModified = Date.now();
      save();
      
      // Poczekaj na synchronizacjƒô z Firebase
      if (s.storage && s.storage.mode === 'firebase' && typeof saveToDB === 'function') {
        console.log('‚è≥ Synchronizujƒô oczyszczony stan z Firebase...');
        await saveToDB().catch(err => console.error('‚ùå B≈ÇƒÖd sync:', err));
        console.log('‚úÖ Synchronizacja zako≈Ñczona');
      }
      
      const summary = `‚úÖ Usuniƒôto testowe dane!\n\n` +
        `üë∑ Pracownicy (Firebase): ${deleted.employees}\n` +
        `üì¶ Zlecenia (Firebase): ${deleted.orders}\n` +
        `‚úÖ Zadania (Firebase): ${deleted.tasks}\n` +
        `‚úÖ Zadania (localStorage): ${removedCount}\n\n` +
        `Od≈õwie≈ºam stronƒô...`;
      
      console.log('‚úÖ ' + summary);
      alert(summary);
      
      // Auto-refresh po 1 sekundzie
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd usuwania:', err);
      alert('‚ùå B≈ÇƒÖd: ' + err.message);
    }
  });

  // Wyczy≈õƒá duplikaty operacji w Firebase
  qs('#cleanup-operations').addEventListener('click', async () => {
    const currentCount = (state.operationsCatalog || []).length;
    if (!confirm(`üßπ Wyczy≈õciƒá duplikaty operacji?\n\nAktualnie masz ${currentCount} operacji.\nFunkcja usunie wszystkie duplikaty i zsynchronizuje z Firebase.`)) return;
    
    try {
      const infoEl = qs('#set-info');
      if (infoEl) {
        infoEl.textContent = '‚è≥ Czyszczenie operacji...';
        infoEl.style.background = '#f59e0b';
      }
      
      const result = await cleanupOperationsCatalogInFirebase();
      
      if (result.success) {
        const msg = `‚úÖ Wyczyszczono operacje!\n\nPrzed: ${result.before}\nPo: ${result.after}\nUsuniƒôto: ${result.removed} duplikat√≥w`;
        console.log(msg);
        alert(msg);
        
        if (infoEl) {
          infoEl.textContent = `‚úÖ Operacje: ${result.after} (usuniƒôto ${result.removed} duplikat√≥w)`;
          infoEl.style.background = '#059669';
        }
        
        // Od≈õwie≈º listƒô operacji w UI je≈õli jest widoczna
        if (typeof renderOperationsCatalog === 'function') {
          renderOperationsCatalog();
        }
      } else {
        alert('‚ùå B≈ÇƒÖd: ' + result.error);
        if (infoEl) {
          infoEl.textContent = '‚ùå B≈ÇƒÖd czyszczenia: ' + result.error;
          infoEl.style.background = '#dc2626';
        }
      }
    } catch (err) {
      console.error('‚ùå B≈ÇƒÖd czyszczenia operacji:', err);
      alert('‚ùå B≈ÇƒÖd: ' + err.message);
    }
  });

  // Reports event handlers
  const reportGenerateTestBtn = qs('#report-generate-test');
  if(reportGenerateTestBtn){ 
    reportGenerateTestBtn.addEventListener('click', () => {
      generateGanttTestData(); // U≈ºywa istniejƒÖcej funkcji
      renderReports();
    });
  }
  
  const reportGenerateBtn = qs('#report-generate');
  if(reportGenerateBtn){ 
    reportGenerateBtn.addEventListener('click', () => {
      renderReports();
    });
  }
  
  const reportExportBtn = qs('#report-export');
  if(reportExportBtn){ 
    reportExportBtn.addEventListener('click', () => {
      exportReportToPDF();
    });
  }

  nav(state.page||'dash'); renderDash(); renderGantt();
})();

  // After initial render, optionally auto-load data from Firebase when configured
  (async function autoLoadIfNeeded(){
    try{
      if(state.storage.mode==='firebase' && state.storage.autoLoadFromDB){
        window.logDev && window.logDev('[auto-load] Wczytywanie danych z Firebase...'); busy(true);
        const loadResult = await loadFromDB();
        if(loadResult && loadResult.skipped){
          window.logDev && window.logDev('[auto-load] Pomi≈Ñ auto-load ‚Äì zdalne kolekcje puste.');
        } else if(loadResult && Array.isArray(loadResult.skippedCollections) && loadResult.skippedCollections.length){
          window.logDev && window.logDev('[auto-load] Wczytano dane, pominiƒôto kolekcje:', loadResult.skippedCollections);
        } else {
          window.logDev && window.logDev('[auto-load] Wczytano dane z Firebase.');
        }
      }
    }catch(e){ window.logDev && window.logDev('[auto-load] B≈ÇƒÖd:', e && e.message); }
    finally{ busy(false); }
  })();
  console.log('build v5.6.27');

  // Check if backup functions are available before assigning
  if (typeof createBackup !== 'undefined') {
    // Make backup functions globally available
    window.createBackup = createBackup;
    window.restoreFromBackup = restoreFromBackup;
    window.deleteBackup = deleteBackup;
    window.exportBackup = exportBackup;
    window.importBackupFromFile = importBackupFromFile;
    window.cleanupOldBackups = cleanupOldBackups;
  } else {
    console.warn('Backup functions not available - skipping assignment');
  }

  // === ADVANCED GANTT FEATURES ===

  // Global state for Gantt visualization
  window.ganttShowDependencies = false;
  window.ganttShowCriticalPath = false;
  window.ganttCreatingDependency = false;
  window.ganttDependencyFrom = null;

  // Initialize drag & drop functionality for Gantt tasks
  function initGanttDragDrop() {
    const container = qs('#gantt-container');
    if (!container) return;

    let draggedTask = null;
    let dragOffset = { x: 0, y: 0 };
    let dropZone = null;

    // Add drag event listeners to all tasks
    document.querySelectorAll('.gantt-task').forEach(taskEl => {
      taskEl.draggable = true;
      taskEl.addEventListener('dragstart', handleDragStart);
      taskEl.addEventListener('dragend', handleDragEnd);
      taskEl.addEventListener('click', handleTaskClick);
    });

    // Add drop zones to task cells
    document.querySelectorAll('.gantt-task-cell').forEach(cell => {
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', handleDragLeave);
    });

    function handleDragStart(e) {
      draggedTask = e.target.closest('.gantt-task');
      if (!draggedTask) return;

      draggedTask.classList.add('dragging');

      // Calculate offset for smooth dragging
      const rect = draggedTask.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      // Create drop zone indicator
      createDropZone(e.clientX, e.clientY);
    }

    function handleDragEnd(e) {
      if (draggedTask) {
        draggedTask.classList.remove('dragging');
      }

      // Remove drop zone
      if (dropZone) {
        dropZone.remove();
        dropZone = null;
      }

      draggedTask = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      if (dropZone) {
        updateDropZone(e.clientX, e.clientY);
      }
    }

    function handleDrop(e) {
      e.preventDefault();

      if (!draggedTask || !dropZone) return;

      const taskId = draggedTask.getAttribute('data-task-id');
      const newDate = calculateDropDate(e.clientX);

      console.log('Drop:', taskId, newDate, e.clientX);

      if (newDate && taskId) {
        updateTaskDate(taskId, newDate);
        renderGantt();
      }
    }

    function handleTaskClick(e) {
      // Prevent click when dragging
      if (draggedTask) return;

      const taskId = e.currentTarget.getAttribute('data-task-id');
      if (taskId) {
        handleTaskClickForDependency(taskId);
      }
    }

    function handleDragLeave(e) {
      // Optional: handle drag leave effects
      // This function is required by the event listener but may be empty
    }

    function createDropZone(x, y) {
      const timeline = qs('#gantt-timeline');
      const timelineWidth = timeline.getBoundingClientRect().width;
      const viewMode = qs('#gantt-view').value || 'week';
      const daysCount = viewMode === 'week' ? 7 : 30;
      const slotWidth = timelineWidth / daysCount;

      dropZone = document.createElement('div');
      dropZone.className = 'gantt-drop-zone';
      dropZone.style.width = slotWidth + 'px';
      dropZone.style.height = draggedTask.offsetHeight + 'px';
      dropZone.addEventListener('drop', handleDrop);
      document.body.appendChild(dropZone);
      updateDropZone(x, y);
    }

    function updateDropZone(x, y) {
      if (!dropZone) return;

      const rect = container.getBoundingClientRect();
      const relativeX = x - rect.left - dragOffset.x;
      const relativeY = y - rect.top - dragOffset.y;

      dropZone.style.left = (rect.left + relativeX) + 'px';
      dropZone.style.top = (rect.top + relativeY) + 'px';

      // Validate drop position - always valid for now (show as valid)
      const isValid = true; // Simplified - allow dropping anywhere
      dropZone.className = 'gantt-drop-zone ' + (isValid ? 'valid' : 'invalid');
    }

    function calculateDropDate(clientX) {
      const timeline = qs('#gantt-timeline');
      const container = qs('#gantt-container');
      const rect = container.getBoundingClientRect();
      const timelineRect = timeline.getBoundingClientRect();

      // Calculate relative position in timeline
      const relativeX = clientX - timelineRect.left;
      const timelineWidth = timelineRect.width;

      if (relativeX < 0 || relativeX > timelineWidth) return null;

      // Get timeline start date
      const viewMode = qs('#gantt-view').value || 'week';
      const daysCount = viewMode === 'week' ? 7 : 30;
      const slotWidth = timelineWidth / daysCount;

      // Calculate which day was clicked with snap-to-center
      const positionInSlot = relativeX % slotWidth;
      let dayIndex = Math.floor(relativeX / slotWidth);
      
      // Snap to center of slot for better precision
      if (positionInSlot > slotWidth * 0.5) {
        // If in right half of slot, snap to next day
        dayIndex += 1;
      }
      
      const startDate = getGanttStartDate();

      const newDate = new Date(startDate);
      newDate.setDate(startDate.getDate() + dayIndex);
      // Set to middle of day for consistency
      newDate.setHours(12, 0, 0, 0);

      console.log('CalculateDropDate:', clientX, timelineRect.left, relativeX, slotWidth, dayIndex, 'posInSlot:', positionInSlot, startDate.toISOString(), newDate.toISOString());

      return newDate.getTime();
    }

    function isValidDropPosition(x, y) {
      // More lenient validation - allow dropping anywhere in timeline area
      const timeline = qs('#gantt-timeline');
      const body = qs('#gantt-body');
      if (!timeline || !body) return true; // Allow if elements not found
      
      const timelineRect = timeline.getBoundingClientRect();
      const bodyRect = body.getBoundingClientRect();
      
      // Allow if within reasonable bounds (with some tolerance)
      return x >= -50 && x <= timelineRect.width + 50 && y >= -20 && y <= bodyRect.height + 20;
    }

    function updateTaskDate(taskId, newTimestamp) {
      const task = (state.tasks || []).find(t => t.id === taskId);
      if (!task) return;

      // Update task start date
      task.startPlanned = newTimestamp;

      // Recalculate end date based on duration
      const durationMs = (task.estMin || 60) * 60 * 1000; // Convert minutes to milliseconds
      task.endPlanned = newTimestamp + durationMs;

      console.log('Updated task', taskId, 'to', new Date(newTimestamp).toLocaleDateString('pl-PL'), 'old was', task.startPlanned ? new Date(task.startPlanned).toLocaleDateString('pl-PL') : 'none');

      save();
    }

    function getGanttStartDate() {
      let minDate = new Date();
      (state.tasks || []).forEach(t => {
        if (t.startPlanned && t.startPlanned < minDate.getTime()) {
          minDate = new Date(t.startPlanned);
        }
      });

      const startDate = new Date(minDate);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      startDate.setHours(0, 0, 0, 0);
      return startDate;
    }
  }

  // Update Gantt button states
  function updateGanttButtons() {
    const depBtn = qs('#gantt-show-dependencies');
    const createDepBtn = qs('#gantt-create-dependency');
    const critBtn = qs('#gantt-show-critical-path');

    if (depBtn) {
      depBtn.classList.toggle('primary', window.ganttShowDependencies);
    }
    if (createDepBtn) {
      createDepBtn.classList.toggle('primary', window.ganttCreatingDependency);
    }
    if (critBtn) {
      critBtn.classList.toggle('primary', window.ganttShowCriticalPath);
    }
  }

  // Toggle dependencies visualization
  function toggleDependencies() {
    console.log('üîµ toggleDependencies called! Current state:', window.ganttShowDependencies);
    window.ganttShowDependencies = !window.ganttShowDependencies;
    console.log('üîµ New state:', window.ganttShowDependencies);
    updateGanttButtons();

    if (window.ganttShowDependencies) {
      console.log('üîµ Calling renderDependencies()...');
      renderDependencies();
    } else {
      console.log('üîµ Calling clearDependencies()...');
      clearDependencies();
    }
  }

  // Toggle critical path visualization
  function toggleCriticalPath() {
    window.ganttShowCriticalPath = !window.ganttShowCriticalPath;
    updateGanttButtons();

    if (window.ganttShowCriticalPath) {
      calculateAndShowCriticalPath();
    } else {
      clearCriticalPath();
    }
  }

  // Toggle dependency creation mode
  function toggleDependencyCreation() {
    window.ganttCreatingDependency = !window.ganttCreatingDependency;
    window.ganttDependencyFrom = null;
    updateGanttButtons();

    if (window.ganttCreatingDependency) {
      alert('Tryb tworzenia zale≈ºno≈õci w≈ÇƒÖczony. Kliknij na pierwsze zadanie, a nastƒôpnie na zadanie docelowe.');
    } else {
      alert('Tryb tworzenia zale≈ºno≈õci wy≈ÇƒÖczony.');
    }
  }

  // Handle task click for dependency creation
  function handleTaskClickForDependency(taskId) {
    if (!window.ganttCreatingDependency) return;

    if (!window.ganttDependencyFrom) {
      // First task selected
      window.ganttDependencyFrom = taskId;
      const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
      if (taskEl) {
        taskEl.classList.add('dependency-from');
      }
      alert('Wybrano pierwsze zadanie. Teraz kliknij na zadanie docelowe.');
    } else if (window.ganttDependencyFrom === taskId) {
      // Same task clicked - cancel
      const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
      if (taskEl) {
        taskEl.classList.remove('dependency-from');
      }
      window.ganttDependencyFrom = null;
      alert('Anulowano wyb√≥r. Kliknij ponownie na pierwsze zadanie.');
    } else {
      // Second task selected - create dependency
      createManualDependency(window.ganttDependencyFrom, taskId);

      // Reset state
      const fromEl = document.querySelector(`[data-task-id="${window.ganttDependencyFrom}"]`);
      if (fromEl) {
        fromEl.classList.remove('dependency-from');
      }
      window.ganttDependencyFrom = null;
      window.ganttCreatingDependency = false;
      updateGanttButtons();
    }
  }

  // Create manual dependency between two tasks
  function createManualDependency(fromTaskId, toTaskId) {
    if (!state.taskDependencies) {
      state.taskDependencies = [];
    }

    // Check if dependency already exists
    const existing = state.taskDependencies.find(dep =>
      dep.from === fromTaskId && dep.to === toTaskId
    );

    if (existing) {
      alert('Ta zale≈ºno≈õƒá ju≈º istnieje!');
      return;
    }

    // Add new dependency
    state.taskDependencies.push({
      id: uid(),
      from: fromTaskId,
      to: toTaskId,
      type: 'finish-to-start',
      manual: true
    });

    save();
    renderGantt();
    if (window.ganttShowDependencies) {
      renderDependencies();
    }
    alert('Zale≈ºno≈õƒá zosta≈Ça utworzona!');
  }

  // Delete manual dependency
  function deleteManualDependency(dependencyId) {
    if (!state.taskDependencies) return;

    const index = state.taskDependencies.findIndex(dep => dep.id === dependencyId);
    if (index !== -1) {
      state.taskDependencies.splice(index, 1);
      save();
      renderGantt();
      if (window.ganttShowDependencies) {
        renderDependencies();
      }
    }
  }

  // Show dependency management dialog
  function showDependencyManager() {
    const dependencies = state.taskDependencies || [];
    const tasks = state.tasks || [];

    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    html += '<h4>Rƒôczne zale≈ºno≈õci miƒôdzy zadaniami</h4>';

    if (dependencies.length === 0) {
      html += '<p>Brak rƒôcznych zale≈ºno≈õci. U≈ºyj przycisku "Utw√≥rz zale≈ºno≈õƒá" aby dodaƒá pierwszƒÖ.</p>';
    } else {
      html += '<div style="display: grid; gap: 8px;">';
      dependencies.forEach(dep => {
        const fromTask = tasks.find(t => t.id === dep.from);
        const toTask = tasks.find(t => t.id === dep.to);

        const fromName = fromTask ? (fromTask.opName || fromTask.name || 'Zadanie') : 'Nieznane';
        const toName = toTask ? (toTask.opName || toTask.name || 'Zadanie') : 'Nieznane';

        html += `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid var(--b); border-radius: 4px;">
            <div>
              <strong>${fromName}</strong> ‚Üí <strong>${toName}</strong>
              <div style="font-size: 12px; color: var(--text-secondary);">${dep.type}</div>
            </div>
            <button class="btn red tiny" onclick="deleteManualDependency('${dep.id}')" title="Usu≈Ñ zale≈ºno≈õƒá">üóëÔ∏è</button>
          </div>
        `;
      });
      html += '</div>';
    }

    html += '</div>';

    // Show modal dialog
    showModal('ZarzƒÖdzanie zale≈ºno≈õciami', html, [
      { text: 'Zamknij', action: () => {} }
    ]);
  }

  // Render task dependencies
  function renderDependencies() {
    console.log('üìä renderDependencies() WYWO≈ÅANA!');
    const svg = qs('#gantt-dependencies');
    if (!svg) {
      console.error('‚ùå SVG gantt-dependencies not found!');
      return;
    }
    console.log('‚úÖ SVG element found:', svg);

    // Clear existing dependencies
    svg.innerHTML = '';

    const tasks = state.tasks || [];
    console.log('üìã Total tasks:', tasks.length);
    console.log('üìã Tasks:', tasks.map(t => ({id: t.id, name: t.opName, opIndex: t.opIndex, orderId: t.orderId})));
    
    const dependencies = calculateTaskDependencies(tasks);
    
    console.log('üîó Dependencies found:', dependencies.length);
    console.log('üîó Dependencies:', dependencies);
    console.log('üìÖ Tasks with startPlanned:', tasks.filter(t => t.startPlanned).length);

    dependencies.forEach(dep => {
      const fromTask = tasks.find(t => t.id === dep.from);
      const toTask = tasks.find(t => t.id === dep.to);

      if (fromTask && toTask && fromTask.startPlanned && toTask.startPlanned) {
        console.log('‚úÖ Drawing dependency from', fromTask.opName, 'to', toTask.opName);
        drawDependencyLine(svg, fromTask, toTask, dep.type, dep.manual);
      } else {
        console.log('‚ö†Ô∏è Skipping dependency - missing data:', {
          from: fromTask?.opName || 'NOT FOUND',
          to: toTask?.opName || 'NOT FOUND',
          fromStartPlanned: !!fromTask?.startPlanned,
          toStartPlanned: !!toTask?.startPlanned
        });
      }
    });
  }

  // Calculate task dependencies based on process order and manual dependencies
  function calculateTaskDependencies(tasks) {
    const dependencies = [];

    // Add automatic dependencies based on process order
    const tasksByOrder = {};
    tasks.forEach(task => {
      if (!tasksByOrder[task.orderId]) {
        tasksByOrder[task.orderId] = [];
      }
      tasksByOrder[task.orderId].push(task);
    });

    // For each order, create dependencies based on process operations
    Object.values(tasksByOrder).forEach(orderTasks => {
      // Sort tasks by their position in the process
      orderTasks.sort((a, b) => {
        const orderA = a.opIndex || 0;
        const orderB = b.opIndex || 0;
        return orderA - orderB;
      });

      // Create finish-to-start dependencies
      for (let i = 0; i < orderTasks.length - 1; i++) {
        dependencies.push({
          from: orderTasks[i].id,
          to: orderTasks[i + 1].id,
          type: 'finish-to-start',
          manual: false
        });
      }
    });

    // Add manual dependencies
    if (state.taskDependencies) {
      state.taskDependencies.forEach(dep => {
        dependencies.push({
          from: dep.from,
          to: dep.to,
          type: dep.type || 'finish-to-start',
          manual: true,
          id: dep.id
        });
      });
    }

    return dependencies;
  }

  // Draw dependency line between two tasks
  function drawDependencyLine(svg, fromTask, toTask, type, isManual = false) {
    console.log('drawDependencyLine called for:', fromTask.id, '->', toTask.id);
    
    const ganttContainer = qs('#gantt-container');
    const ganttBody = qs('#gantt-body');
    if (!ganttContainer || !ganttBody) {
      console.log('Gantt containers not found');
      return;
    }

    // Get task elements
    const fromEl = document.querySelector(`[data-task-id="${fromTask.id}"]`);
    const toEl = document.querySelector(`[data-task-id="${toTask.id}"]`);

    if (!fromEl || !toEl) {
      console.log('Task elements not found:', {
        fromEl: !!fromEl,
        toEl: !!toEl,
        fromTaskId: fromTask.id,
        toTaskId: toTask.id
      });
      return;
    }

    // Get the parent task cells (which contain positioning)
    const fromCell = fromEl.closest('.gantt-task-cell');
    const toCell = toEl.closest('.gantt-task-cell');
    
    if (!fromCell || !toCell) {
      console.log('Task cells not found:', {
        fromCell: !!fromCell,
        toCell: !!toCell
      });
      return;
    }

    // Calculate positions using getBoundingClientRect for accurate positioning
    const ganttBodyRect = ganttBody.getBoundingClientRect();
    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();
    
    const fromX = fromRect.right - ganttBodyRect.left;
    const fromY = fromRect.top + fromRect.height / 2 - ganttBodyRect.top;
    const toX = toRect.left - ganttBodyRect.left;
    const toY = toRect.top + toRect.height / 2 - ganttBodyRect.top;

    console.log('Calculated positions:', {
      fromX, fromY, toX, toY
    });

    // Set SVG size to match gantt body
    svg.setAttribute('width', ganttBody.scrollWidth);
    svg.setAttribute('height', ganttBody.scrollHeight);
    svg.style.width = ganttBody.scrollWidth + 'px';
    svg.style.height = ganttBody.scrollHeight + 'px';

    // Create SVG path
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.className = `gantt-dependency-line ${isManual ? 'manual' : ''}`;
    path.setAttribute('stroke', isManual ? '#3b82f6' : '#94a3b8');
    path.setAttribute('stroke-width', isManual ? '3' : '2');
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke-linecap', 'round');

    // Calculate path - use simple elbow connection
    const deltaX = toX - fromX;
    const deltaY = toY - fromY;
    
    let d;
    if (Math.abs(deltaY) < 5) {
      // Same row - direct horizontal line
      d = `M ${fromX} ${fromY} L ${toX} ${toY}`;
    } else if (deltaX > 20) {
      // Forward dependency - elbow connection
      const midX = fromX + Math.max(20, deltaX / 2);
      d = `M ${fromX} ${fromY} L ${midX} ${fromY} L ${midX} ${toY} L ${toX} ${toY}`;
    } else {
      // Backward dependency - curved connection
      const controlX1 = fromX + 40;
      const controlY1 = fromY;
      const controlX2 = toX - 40;
      const controlY2 = toY;
      d = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`;
    }
    
    console.log('SVG path:', d);
    path.setAttribute('d', d);
    svg.appendChild(path);

    // Add arrow
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    arrow.className = `gantt-dependency-arrow ${isManual ? 'manual' : ''}`;
    
    // Arrow pointing to the target task
    const arrowSize = 8;
    let arrowPoints;
    
    if (Math.abs(deltaY) < 5) {
      // Horizontal arrow
      arrowPoints = `${toX-arrowSize},${toY-arrowSize/2} ${toX},${toY} ${toX-arrowSize},${toY+arrowSize/2}`;
    } else {
      // Vertical component exists
      if (deltaX > 20) {
        // Forward dependency - horizontal arrow
        arrowPoints = `${toX-arrowSize},${toY-arrowSize/2} ${toX},${toY} ${toX-arrowSize},${toY+arrowSize/2}`;
      } else {
        // Backward dependency - curved arrow
        const angle = Math.atan2(deltaY, -40); // Direction from control point
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);
        const p1x = toX - arrowSize * cos - (arrowSize/2) * sin;
        const p1y = toY - arrowSize * sin + (arrowSize/2) * cos;
        const p2x = toX - arrowSize * cos + (arrowSize/2) * sin;
        const p2y = toY - arrowSize * sin - (arrowSize/2) * cos;
        arrowPoints = `${p1x},${p1y} ${toX},${toY} ${p2x},${p2y}`;
      }
    }
    
    console.log('Arrow points:', arrowPoints);
    arrow.setAttribute('points', arrowPoints);
    arrow.setAttribute('fill', isManual ? '#3b82f6' : '#94a3b8');
    svg.appendChild(arrow);
    
    console.log('Dependency line added to SVG');
  }

  // Clear dependencies visualization
  function clearDependencies() {
    const svg = qs('#gantt-dependencies');
    if (svg) {
      svg.innerHTML = '';
    }
  }

  // Calculate and show critical path
  function calculateAndShowCriticalPath() {
    const tasks = state.tasks || [];
    const criticalTasks = calculateCriticalPath(tasks);

    // Highlight critical tasks
    criticalTasks.forEach(taskId => {
      const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
      if (taskEl) {
        taskEl.classList.add('critical-path');
      }
    });

    // Show float indicators for non-critical tasks
    tasks.forEach(task => {
      if (!criticalTasks.includes(task.id)) {
        const float = calculateTaskFloat(task, tasks);
        showFloatIndicator(task, float);
      }
    });
  }

  // Calculate critical path using CPM (Critical Path Method)
  function calculateCriticalPath(tasks) {
    if (!tasks || tasks.length === 0) return [];

    // Create task map for easy lookup
    const taskMap = {};
    tasks.forEach(task => {
      taskMap[task.id] = {
        ...task,
        predecessors: [],
        successors: [],
        earlyStart: 0,
        earlyFinish: 0,
        lateStart: Infinity,
        lateFinish: Infinity
      };
    });

    // Build dependency graph
    const dependencies = calculateTaskDependencies(tasks);
    dependencies.forEach(dep => {
      if (taskMap[dep.from] && taskMap[dep.to]) {
        taskMap[dep.from].successors.push(dep.to);
        taskMap[dep.to].predecessors.push(dep.from);
      }
    });

    // Forward pass - calculate early start/finish
    const visited = new Set();
    function forwardPass(taskId) {
      if (visited.has(taskId)) return;
      visited.add(taskId);

      const task = taskMap[taskId];
      const duration = task.estMin || 60; // minutes

      // Process predecessors first
      task.predecessors.forEach(predId => {
        forwardPass(predId);
        const pred = taskMap[predId];
        task.earlyStart = Math.max(task.earlyStart, pred.earlyFinish);
      });

      task.earlyFinish = task.earlyStart + duration;
    }

    // Start from tasks with no predecessors
    Object.values(taskMap).forEach(task => {
      if (task.predecessors.length === 0) {
        forwardPass(task.id);
      }
    });

    // Backward pass - calculate late start/finish
    const reverseVisited = new Set();
    function backwardPass(taskId) {
      if (reverseVisited.has(taskId)) return;
      reverseVisited.add(taskId);

      const task = taskMap[taskId];

      // If no successors, late finish equals early finish
      if (task.successors.length === 0) {
        task.lateFinish = task.earlyFinish;
      } else {
        // Process successors first
        task.successors.forEach(succId => {
          backwardPass(succId);
          const succ = taskMap[succId];
          task.lateFinish = Math.min(task.lateFinish, succ.lateStart);
        });
      }

      task.lateStart = task.lateFinish - (task.estMin || 60);
    }

    // Start from tasks with no successors
    Object.values(taskMap).forEach(task => {
      if (task.successors.length === 0) {
        backwardPass(task.id);
      }
    });

    // Find critical path (tasks with zero float)
    const criticalPath = [];
    Object.values(taskMap).forEach(task => {
      const float = task.lateFinish - task.earlyFinish;
      if (Math.abs(float) < 1) { // Consider float < 1 minute as critical
        criticalPath.push(task.id);
      }
    });

    console.log('Critical path calculated:', criticalPath.length, 'tasks');
    return criticalPath;
  }

  // Calculate float for a task
  function calculateTaskFloat(task, allTasks) {
    // Simplified float calculation
    const duration = task.estMin || 60;
    const successors = findTaskSuccessors(task, allTasks);

    if (successors.length === 0) {
      return 0; // End task has no float
    }

    // Calculate minimum slack to successors
    let minSlack = Infinity;
    successors.forEach(succ => {
      const succStart = succ.startPlanned || Date.now();
      const taskEnd = (task.startPlanned || Date.now()) + (duration * 60 * 1000);
      const slack = succStart - taskEnd;
      minSlack = Math.min(minSlack, slack);
    });

    return minSlack > 0 ? Math.round(minSlack / (60 * 1000)) : 0; // Convert to minutes
  }

  // Find successor tasks
  function findTaskSuccessors(task, allTasks) {
    const successors = [];
    const dependencies = calculateTaskDependencies(allTasks);

    dependencies.forEach(dep => {
      if (dep.from === task.id) {
        const succTask = allTasks.find(t => t.id === dep.to);
        if (succTask) {
          successors.push(succTask);
        }
      }
    });

    return successors;
  }

  // Show float indicator for task
  function showFloatIndicator(task, floatMinutes) {
    const taskEl = document.querySelector(`[data-task-id="${task.id}"]`);
    if (!taskEl) return;

    // Remove existing indicator
    const existing = taskEl.querySelector('.gantt-float-indicator');
    if (existing) existing.remove();

    const indicator = document.createElement('div');
    indicator.className = 'gantt-float-indicator';

    if (floatMinutes > 60) {
      indicator.classList.add('positive');
      indicator.textContent = `+${Math.round(floatMinutes / 60)}h`;
    } else if (floatMinutes > 0) {
      indicator.classList.add('positive');
      indicator.textContent = `+${floatMinutes}m`;
    } else if (floatMinutes === 0) {
      indicator.classList.add('zero');
      indicator.textContent = '0';
    } else {
      indicator.classList.add('negative');
      indicator.textContent = `${floatMinutes}m`;
    }

    taskEl.appendChild(indicator);
  }

  // Clear critical path visualization
  function clearCriticalPath() {
    // Remove critical path highlighting
    document.querySelectorAll('.gantt-task.critical-path').forEach(el => {
      el.classList.remove('critical-path');
    });

    // Remove float indicators
    document.querySelectorAll('.gantt-float-indicator').forEach(el => {
      el.remove();
    });
  }

  // Make advanced Gantt functions globally available
  window.toggleDependencies = toggleDependencies;
  window.toggleCriticalPath = toggleCriticalPath;
  window.renderDependencies = renderDependencies;
  window.calculateAndShowCriticalPath = calculateAndShowCriticalPath;
  window.deleteManualDependency = deleteManualDependency;

  // Add scroll listener to update dependencies when gantt is scrolled
  function initGanttScrollListener() {
    const ganttBody = qs('#gantt-body');
    if (ganttBody) {
      ganttBody.addEventListener('scroll', () => {
        if (window.ganttShowDependencies) {
          // Debounce the rendering to avoid too many updates
          if (window.ganttScrollTimeout) {
            clearTimeout(window.ganttScrollTimeout);
          }
          window.ganttScrollTimeout = setTimeout(() => {
            renderDependencies();
          }, 100);
        }
      });
    }
  }

  // Initialize scroll listener when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGanttScrollListener);
  } else {
    initGanttScrollListener();
  }

  // Simple modal dialog function
  function showModal(title, content, buttons = []) {

    // Ensure we never stack duplicate modal elements
    document.querySelectorAll('#custom-modal').forEach(existing => existing.remove());

    // Create modal elements
    const modal = document.createElement('div');
    modal.id = 'custom-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 10000; display: flex;
      align-items: center; justify-content: center;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: var(--panel); border-radius: 8px; padding: 20px;
      max-width: 800px; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      cursor: default !important;
    `;
    
    // Wymuszenie domy≈õlnego kursora dla wszystkich element√≥w w modalu
    modalContent.addEventListener('DOMNodeInserted', () => {
      const allElements = modalContent.querySelectorAll('*');
      allElements.forEach(el => {
        if (!el.style.cursor || el.style.cursor === 'not-allowed') {
          el.style.cursor = 'default';
        }
      });
    });

    const titleEl = document.createElement('h3');
    titleEl.textContent = title;
    titleEl.style.marginTop = '0';

    const contentEl = document.createElement('div');
    contentEl.innerHTML = content;

    const buttonsEl = document.createElement('div');
    buttonsEl.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;';

    buttons.forEach(btn => {
      const buttonEl = document.createElement('button');
      buttonEl.className = btn.className || 'btn';
      buttonEl.textContent = btn.label || btn.text || '';
      if (btn.style) buttonEl.style.cssText = btn.style;
      buttonEl.addEventListener('click', async () => {
        let shouldClose = true;
        try {
          const handler = btn.onClick || btn.action;
          if (handler) {
            const result = handler();
            if (result instanceof Promise) {
              const awaited = await result;
              if (awaited === false) {
                shouldClose = false;
              }
            } else if (result === false) {
              shouldClose = false;
            }
          }
        } catch (error) {
          console.error('[modal] action error', error);
        } finally {
          if (shouldClose) {
            modal.remove();
          }
        }
      });
      buttonsEl.appendChild(buttonEl);
    });

    modalContent.appendChild(titleEl);
    modalContent.appendChild(contentEl);
    modalContent.appendChild(buttonsEl);
    modal.appendChild(modalContent);

    // Close on background click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });

    document.body.appendChild(modal);
  }
  
  // Zamknij modal
  function closeModal() {
    const modal = document.getElementById('custom-modal');
    if (modal) modal.remove();
  }
  
  window.closeModal = closeModal;

  // Enable/disable browser spellcheck and set language (pl) for user-editable fields
  (function(){
  try{
    const queryFields = () => Array.from(document.querySelectorAll('input:not([type="hidden"]), textarea, [contenteditable]'));

    const enableSpellAndLang = () => {
      queryFields().forEach(el=>{
        try{ el.setAttribute('spellcheck','true'); }catch(_){/* ignore */}
        try{ el.setAttribute('lang','pl'); }catch(_){/* ignore */}
      });
    };

    const disableSpellAndLang = () => {
      Array.from(document.querySelectorAll('input, textarea, [contenteditable]')).forEach(el=>{
        try{ el.removeAttribute('spellcheck'); }catch(_){/* ignore */}
        try{ if(el.getAttribute('lang') === 'pl') el.removeAttribute('lang'); }catch(_){/* ignore */}
      });
    };

    const obsCb = (mutationsList) => {
      try{
        if(!!state.storage.spellcheckEnforce) enableSpellAndLang(); else disableSpellAndLang();
      }catch(_){/* ignore */}
    };

    const obs = new MutationObserver(obsCb);
    obs.observe(document.body, { childList:true, subtree:true });

    if(!!state.storage.spellcheckEnforce) enableSpellAndLang(); else disableSpellAndLang();
  }catch(e){console.warn('spellcheck/lang init error', e);} 
})();

// Kod magazynu przywr√≥cony jako adapter do nowych funkcji

function ensureWarehouseArrays() {
  if (!Array.isArray(window.warehouseItems)) {
    window.warehouseItems = [];
  }
  if (!Array.isArray(window.warehouseTransactions)) {
    window.warehouseTransactions = [];
  }
  if (!Array.isArray(window.warehouseReservations)) {
    window.warehouseReservations = [];
  }
  if (!Array.isArray(window.materialTemplates)) {
    window.materialTemplates = [];
  }
}

function findWarehouseItemIndexById(itemId) {
  ensureWarehouseArrays();
  return window.warehouseItems.findIndex(item => item && item.id === itemId);
}

function findWarehouseItemById(itemId) {
  const index = findWarehouseItemIndexById(itemId);
  return index >= 0 ? { index, item: window.warehouseItems[index] } : { index: -1, item: null };
}

if (!window.simpleWarehouse) {
  window.simpleWarehouse = {
    render() {
      try {
        renderWarehouse();
      } catch (error) {
        console.warn('[warehouse] render fallback error', error);
      }
    },
    showAddItemModal() {
      try {
        showAddWarehouseModal();
      } catch (error) {
        console.warn('[warehouse] add item modal error', error);
      }
    },
    exportData() {
      try {
        exportWarehouseToCSV();
      } catch (error) {
        console.warn('[warehouse] export fallback error', error);
      }
    },
    editItem(itemId) {
      const { index } = findWarehouseItemById(itemId);
      if (index === -1) {
        alert('Nie znaleziono pozycji magazynowej do edycji.');
        return;
      }
      try {
        showEditWarehouseModal(index);
      } catch (error) {
        console.error('[warehouse] edit fallback error', error);
      }
    },
    adjustQuantity(itemId) {
      const { index, item } = findWarehouseItemById(itemId);
      if (index === -1 || !item) {
        alert('Nie znaleziono pozycji magazynowej do korekty.');
        return;
      }
      try {
        showAdjustQuantityModal(index);
      } catch (error) {
        console.error('[warehouse] adjust quantity error', error);
      }
    },
    deleteItem(itemId) {
      const { index } = findWarehouseItemById(itemId);
      if (index === -1) {
        alert('Nie znaleziono pozycji magazynowej do usuniƒôcia.');
        return;
      }
      try {
        deleteWarehouseItem(index);
      } catch (error) {
        console.error('[warehouse] delete fallback error', error);
      }
    }
  };
}

function setupWarehouseButtons() {
  console.log('[warehouse] setupWarehouseButtons invoked');

  ensureWarehouseArrays();

  const addBtn = document.getElementById('wh-add');
  if (addBtn) {
    addBtn.onclick = null;
    addBtn.addEventListener('click', (event) => {
      if (window.disableGlobalClickDelegation) {
        event.preventDefault();
        event.stopPropagation();
      }
      addWarehouseItem();
    });
  } else {
    console.warn('[warehouse] add button not found');
  }

  const searchInput = document.getElementById('wh-search');
  if (searchInput && !searchInput.dataset.whBound) {
    searchInput.dataset.whBound = 'true';
    searchInput.addEventListener('input', () => {
      renderWarehouse();
    });
  }

  const staffForm = document.getElementById('wh-staff-form');
  if (staffForm && !staffForm.dataset.whBound) {
    staffForm.dataset.whBound = 'true';
    staffForm.addEventListener('submit', handleWarehouseStaffSubmit);
  }

  const staffSelect = document.getElementById('wh-staff-select');
  if (staffSelect && !staffSelect.dataset.whBound) {
    staffSelect.dataset.whBound = 'true';
    staffSelect.addEventListener('change', handleWarehouseStaffSelectChange);
  }

  const staffList = document.getElementById('wh-staff-list');
  if (staffList && !staffList.dataset.whBound) {
    staffList.dataset.whBound = 'true';
    staffList.addEventListener('click', handleWarehouseStaffListClick);
  }

  try {
    renderWarehouseStaff();
  } catch (error) {
    console.warn('[warehouse] render staff error', error);
  }

  const staffCancel = document.getElementById('wh-staff-cancel');
  if (staffCancel && !staffCancel.dataset.whBound) {
    staffCancel.dataset.whBound = 'true';
    staffCancel.addEventListener('click', cancelWarehouseStaffEdit);
  }

  handleWarehouseStaffSelectChange();

  updateShoppingListBadge();
}

let currentWarehouseStaffEditId = null;

function ensureEmployeesArray() {
  if (!Array.isArray(state.employees)) {
    state.employees = [];
  }
  return state.employees;
}

// ===== AKTYWNY MAGAZYNIER - SYSTEM PRZYPISYWANIA ZADA≈É =====
let activeWarehousemanId = null; // ID aktywnego magazyniera do przypisywania zada≈Ñ

function setWarehouseStaffFormMode_REMOVED(mode, employee) {
  const saveBtn = document.getElementById('wh-staff-save');
  const saveIcon = document.getElementById('wh-staff-save-icon');
  const saveText = document.getElementById('wh-staff-save-text');
  const cancelBtn = document.getElementById('wh-staff-cancel');
  const formTitle = document.getElementById('wh-staff-form-title');
  const errorContainer = document.getElementById('wh-staff-errors');

  // Czyszczenie b≈Çƒôd√≥w
  if (errorContainer) {
    errorContainer.innerHTML = '';
    errorContainer.style.display = 'none';
  }

  if (mode === 'edit') {
    currentWarehouseStaffEditId = employee ? String(employee.id) : null;
    if (formTitle) {
      formTitle.innerHTML = `‚úèÔ∏è Edytuj magazyniera: <strong>${employee ? employee.name : ''}</strong>`;
    }
    if (saveIcon) saveIcon.textContent = 'üíæ';
    if (saveText) saveText.textContent = 'Zapisz zmiany';
    if (saveBtn) {
      saveBtn.classList.add('amber');
      saveBtn.classList.remove('green');
    }
    if (cancelBtn) {
      cancelBtn.style.display = 'inline-flex';
    }
  } else {
    currentWarehouseStaffEditId = null;
    if (formTitle) {
      formTitle.innerHTML = '‚ûï Dodaj magazyniera';
    }
    if (saveIcon) saveIcon.textContent = '‚ûï';
    if (saveText) saveText.textContent = 'Dodaj magazyniera';
    if (saveBtn) {
      saveBtn.classList.remove('amber');
      saveBtn.classList.add('green');
    }
    if (cancelBtn) {
      cancelBtn.style.display = 'none';
    }
  }
}

function resetWarehouseStaffForm() {
  setWarehouseStaffFormMode('create');
  populateWarehouseStaffSelect();
  const select = document.getElementById('wh-staff-select');
  if (select) {
    select.value = '';
    select.style.borderColor = '';
  }
  const phoneInput = document.getElementById('wh-staff-phone');
  if (phoneInput) {
    phoneInput.value = '';
    phoneInput.style.borderColor = '';
  }
  const capInput = document.getElementById('wh-staff-cap');
  if (capInput) {
    capInput.value = '100';
    capInput.style.borderColor = '';
  }
  const hoursInput = document.getElementById('wh-staff-hours');
  if (hoursInput) {
    hoursInput.value = '8';
    hoursInput.style.borderColor = '';
  }
  const errorContainer = document.getElementById('wh-staff-errors');
  if (errorContainer) {
    errorContainer.innerHTML = '';
    errorContainer.style.display = 'none';
  }
  handleWarehouseStaffSelectChange();
}

function cancelWarehouseStaffEdit() {
  resetWarehouseStaffForm();
}

function handleWarehouseStaffSubmit(event) {
  if (event) {
    event.preventDefault();
  }

  const select = document.getElementById('wh-staff-select');
  const phoneInput = document.getElementById('wh-staff-phone');
  const capInput = document.getElementById('wh-staff-cap');
  const hoursInput = document.getElementById('wh-staff-hours');
  const errorContainer = document.getElementById('wh-staff-errors');

  // Czyszczenie poprzednich b≈Çƒôd√≥w
  if (errorContainer) {
    errorContainer.innerHTML = '';
    errorContainer.style.display = 'none';
  }

  if (!select) {
    return;
  }

  const errors = [];
  const employeeId = currentWarehouseStaffEditId || select.value;
  
  // Walidacja pracownika
  if (!employeeId) {
    errors.push('Wybierz pracownika z listy rozwijanej');
    select.style.borderColor = '#dc2626';
  } else {
    select.style.borderColor = '';
  }

  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(employeeId));
  if (employeeId && !employee) {
    errors.push('Nie znaleziono wybranego pracownika w systemie');
  }

  // Walidacja telefonu (opcjonalna, ale je≈õli podana to sprawdzamy format)
  const phone = phoneInput ? phoneInput.value.trim() : '';
  if (phone && !/^[\d\s\-\+\(\)]+$/.test(phone)) {
    errors.push('Numer telefonu zawiera nieprawid≈Çowe znaki (u≈ºyj cyfr, spacji, +, -, nawias√≥w)');
    if (phoneInput) phoneInput.style.borderColor = '#dc2626';
  } else if (phoneInput) {
    phoneInput.style.borderColor = '';
  }

  // Walidacja cap
  const capRaw = capInput ? toInt(capInput.value, 100) : 100;
  const cap = Math.min(Math.max(Number.isFinite(capRaw) ? capRaw : 100, 0), 100);
  if (capInput && (capInput.value === '' || capRaw < 0 || capRaw > 100)) {
    errors.push('ObciƒÖ≈ºenie (Cap) musi byƒá liczbƒÖ od 0 do 100');
    capInput.style.borderColor = '#dc2626';
  } else if (capInput) {
    capInput.style.borderColor = '';
  }

  // Walidacja godzin
  const hoursRaw = hoursInput ? toInt(hoursInput.value, 8) : 8;
  const hours = Math.min(Math.max(Number.isFinite(hoursRaw) ? hoursRaw : 8, 1), 24);
  if (hoursInput && (hoursInput.value === '' || hoursRaw < 1 || hoursRaw > 24)) {
    errors.push('Godziny dziennie muszƒÖ byƒá liczbƒÖ od 1 do 24');
    hoursInput.style.borderColor = '#dc2626';
  } else if (hoursInput) {
    hoursInput.style.borderColor = '';
  }

  // Wy≈õwietlenie b≈Çƒôd√≥w
  if (errors.length > 0) {
    if (errorContainer) {
      errorContainer.innerHTML = `
        <div style="background:#fee;border:1px solid #dc2626;border-radius:8px;padding:12px;margin-bottom:12px">
          <div style="font-weight:600;color:#dc2626;margin-bottom:8px">‚ö†Ô∏è Popraw nastƒôpujƒÖce b≈Çƒôdy:</div>
          <ul style="margin:0;padding-left:20px;color:#991b1b">
            ${errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
          </ul>
        </div>
      `;
      errorContainer.style.display = 'block';
    } else {
      alert('‚ö†Ô∏è B≈Çƒôdy walidacji:\n\n' + errors.join('\n'));
    }
    return;
  }

  if (!employee) {
    return;
  }

  const wasMagazynier = (employee.role || '').toLowerCase() === 'magazynier';
  if (!wasMagazynier) {
    if (!employee.previousRole || employee.previousRole === 'Magazynier') {
      employee.previousRole = employee.role || 'Pracownik';
    }
  }

  employee.role = 'Magazynier';
  employee.phone = phone;
  employee.cap = cap;
  employee.hoursPerDay = hours;

  save();
  renderEmployees();
  renderWarehouseStaff();
  populateWarehouseStaffSelect(employee.id);
  setWarehouseStaffFormMode('create');
  currentWarehouseStaffEditId = null;
  handleWarehouseStaffSelectChange();
  
  // Toast notification o sukcesie
  showWarehouseToast(`‚úÖ Magazynier ${employee.name} zosta≈Ç ${currentWarehouseStaffEditId ? 'zaktualizowany' : 'dodany'}`, 'success');
}

// ===== AKTYWNY MAGAZYNIER - SYSTEM PRZYPISYWANIA ZADA≈É =====

function populateActiveWarehousemanSelect() {
  const select = document.getElementById('active-warehouseman-select');
  if (!select) return;

  const employees = ensureEmployeesArray();
  const warehousemen = employees.filter(emp => (emp.role || '').toLowerCase() === 'magazynier');

  const options = ['<option value="">‚Äî Wybierz magazyniera ‚Äî</option>'];
  warehousemen.forEach(emp => {
    const selected = activeWarehousemanId && String(emp.id) === String(activeWarehousemanId) ? ' selected' : '';
    options.push(`<option value="${escapeHtml(emp.id)}"${selected}>${escapeHtml(emp.name || '‚Äî')}</option>`);
  });

  select.innerHTML = options.join('');
}

function setActiveWarehouseman() {
  const select = document.getElementById('active-warehouseman-select');
  if (!select) return;

  const employeeId = select.value;
  if (!employeeId) {
    clearActiveWarehouseman();
    return;
  }

  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(employeeId));
  if (!employee) {
    showWarehouseToast('‚ùå Nie znaleziono wybranego pracownika', 'error');
    return;
  }

  activeWarehousemanId = String(employee.id);
  
  // Zapisz w localStorage
  try {
    localStorage.setItem('activeWarehousemanId', activeWarehousemanId);
  } catch (e) {
    console.warn('Nie mo≈ºna zapisaƒá aktywnego magazyniera:', e);
  }

  updateActiveWarehousemanDisplay();
  
  // Od≈õwie≈º listƒô zada≈Ñ
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
  
  showWarehouseToast(`‚úÖ ${employee.name} wybrany jako aktywny magazynier`, 'success');
}

function clearActiveWarehouseman() {
  activeWarehousemanId = null;
  
  try {
    localStorage.removeItem('activeWarehousemanId');
  } catch (e) {
    console.warn('Nie mo≈ºna usunƒÖƒá aktywnego magazyniera:', e);
  }

  const select = document.getElementById('active-warehouseman-select');
  if (select) select.value = '';

  updateActiveWarehousemanDisplay();
  
  // Od≈õwie≈º listƒô zada≈Ñ (poka≈ºe wszystkie)
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
  
  showWarehouseToast('‚ÑπÔ∏è Wyczyszczono aktywnego magazyniera', 'info');
}

function updateActiveWarehousemanDisplay() {
  const nameEl = document.getElementById('active-warehouseman-name');
  const statsEl = document.getElementById('active-warehouseman-stats');
  const assignBtn = document.getElementById('assign-task-btn');

  if (!activeWarehousemanId) {
    if (nameEl) nameEl.textContent = 'Nie wybrano';
    if (statsEl) statsEl.style.display = 'none';
    if (assignBtn) assignBtn.style.display = 'none';
    return;
  }

  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(activeWarehousemanId));
  
  if (!employee) {
    if (nameEl) nameEl.textContent = 'Nie znaleziono';
    if (statsEl) statsEl.style.display = 'none';
    if (assignBtn) assignBtn.style.display = 'none';
    return;
  }

  // Wy≈õwietl nazwƒô
  if (nameEl) {
    nameEl.innerHTML = `<span style="font-size:22px">üë§</span> ${escapeHtml(employee.name || '‚Äî')}`;
  }

  // Poka≈º statystyki
  if (statsEl) {
    statsEl.style.display = 'block';
    
    // Policz zadania przypisane do tego magazyniera
    const tasks = window.warehouseTasks || [];
    const assignedTasks = tasks.filter(t => t.assignedTo === activeWarehousemanId);
    const pendingTasks = assignedTasks.filter(t => t.status !== 'completed');
    const completedTasks = assignedTasks.filter(t => t.status === 'completed');

    const taskCountEl = document.getElementById('active-wh-task-count');
    const pendingCountEl = document.getElementById('active-wh-pending-count');
    const completedCountEl = document.getElementById('active-wh-completed-count');
    const phoneEl = document.getElementById('active-wh-phone');

    if (taskCountEl) taskCountEl.textContent = assignedTasks.length;
    if (pendingCountEl) pendingCountEl.textContent = pendingTasks.length;
    if (completedCountEl) completedCountEl.textContent = completedTasks.length;
    if (phoneEl) phoneEl.textContent = employee.phone || '‚Äî';
  }

  // Poka≈º przycisk przypisywania
  if (assignBtn) {
    assignBtn.style.display = 'inline-flex';
  }
  
  // Renderuj listƒô zada≈Ñ dla tego magazyniera
  renderActiveWarehousemanTasks();
}

function renderActiveWarehousemanTasks() {
  const section = document.getElementById('active-warehouseman-tasks-section');
  const list = document.getElementById('active-warehouseman-tasks-list');
  const nameEl = document.getElementById('tasks-section-warehouseman-name');
  const countEl = document.getElementById('tasks-section-count');
  
  if (!section || !list) {
    console.warn('[renderActiveWarehousemanTasks] Brak element√≥w DOM');
    return;
  }
  
  // Diagnostyka
  const allTasks = window.warehouseTasks || [];
  console.log(`üîç [renderActiveWarehousemanTasks] ≈ÅƒÖcznie zada≈Ñ w pamiƒôci: ${allTasks.length}`, allTasks);
  console.log(`üìã [renderActiveWarehousemanTasks] Aktywny magazynier ID: ${activeWarehousemanId}`);
  
  // Je≈õli nie wybrano magazyniera - poka≈º wszystkie zadania
  if (!activeWarehousemanId) {
    const allValidTasks = allTasks.filter(t => t.status !== 'cancelled');
    console.log(`üëÅÔ∏è [renderActiveWarehousemanTasks] Brak aktywnego magazyniera - pokazujƒô wszystkie zadania: ${allValidTasks.length}`);
    
    if (allValidTasks.length === 0) {
      section.style.display = 'none';
      return;
    }
    
    section.style.display = 'block';
    if (nameEl) nameEl.textContent = 'Wszystkie zadania';
    if (countEl) countEl.textContent = allValidTasks.filter(t => t.status !== 'completed').length;
    
    renderTasksList(list, allValidTasks);
    return;
  }
  
  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(activeWarehousemanId));
  
  if (!employee) {
    console.warn(`[renderActiveWarehousemanTasks] Nie znaleziono magazyniera o ID: ${activeWarehousemanId}`);
    section.style.display = 'none';
    return;
  }
  
  const tasks = allTasks.filter(t => 
    t.assignedTo === activeWarehousemanId && t.status !== 'cancelled'
  );
  
  console.log(`üë§ [renderActiveWarehousemanTasks] Zadania dla ${employee.name}: ${tasks.length}`, tasks);
  
  const activeTasks = tasks.filter(t => t.status !== 'completed');
  
  if (nameEl) nameEl.textContent = employee.name;
  if (countEl) countEl.textContent = activeTasks.length;
  
  if (tasks.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  renderTasksList(list, tasks);
}

function renderTasksList(list, tasks) {
  if (!list) return;
  
  // Sortuj: pilne ‚Üí w trakcie ‚Üí oczekujƒÖce ‚Üí uko≈Ñczone
  tasks.sort((a, b) => {
    const priorityOrder = { urgent: 0, high: 1, normal: 2, low: 3 };
    const statusOrder = { in_progress: 0, pending: 1, completed: 2 };
    
    if (a.status !== b.status) {
      return statusOrder[a.status] - statusOrder[b.status];
    }
    if (a.priority !== b.priority) {
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    }
    return new Date(a.createdAt) - new Date(b.createdAt);
  });
  
  list.innerHTML = tasks.map(task => {
    const assignedToName = task.assignedToName || task.assignedTo || 'Nieprzypisane';
    const priorityColors = {
      urgent: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', icon: 'üî¥' },
      high: { bg: '#fff7ed', border: '#f59e0b', text: '#c2410c', icon: 'üü†' },
      normal: { bg: '#f8fafc', border: '#64748b', text: '#475569', icon: 'üü°' },
      low: { bg: '#f0fdf4', border: '#16a34a', text: '#15803d', icon: 'üü¢' }
    };
    
    const statusStyles = {
      completed: { bg: '#dcfce7', border: '#16a34a', text: '#166534', badge: '‚úÖ Uko≈Ñczone' },
      in_progress: { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af', badge: '‚è≥ W trakcie' },
      pending: { bg: '#f8fafc', border: '#94a3b8', text: '#475569', badge: 'üìã Do zrobienia' }
    };
    
    const priority = priorityColors[task.priority] || priorityColors.normal;
    const status = statusStyles[task.status] || statusStyles.pending;
    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'completed';
    
    return `
      <div class="card" style="margin-bottom:12px;background:${status.bg};border-left:4px solid ${status.border}">
        <div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <span style="font-size:18px">${priority.icon}</span>
              <div style="font-weight:700;font-size:16px;color:#0f172a">${task.title}</div>
              ${isOverdue ? '<span style="background:#dc2626;color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600">PRZETERMINOWANE</span>' : ''}
            </div>
            
            ${task.description ? `<div style="font-size:14px;color:#64748b;margin-bottom:8px;line-height:1.5">${task.description}</div>` : ''}
            
            <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:13px;color:#64748b;margin-top:8px">
              <span style="background:${status.bg};padding:4px 8px;border-radius:4px;border:1px solid ${status.border};color:${status.text};font-weight:600">${status.badge}</span>
              <span>üë§ ${assignedToName}</span>
              <span>üìã ${task.orderName || 'Zadanie og√≥lne'}</span>
              ${task.dueDate ? `<span>üìÖ ${new Date(task.dueDate).toLocaleDateString('pl-PL')}</span>` : ''}
              <span style="opacity:0.7">Utworzono: ${new Date(task.createdAt).toLocaleDateString('pl-PL')}</span>
            </div>
          </div>
          
          <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
            ${task.status === 'pending' ? `
              <button class="btn blue small" onclick="updateTaskStatus('${task.id}', 'in_progress')" style="width:100%;font-size:13px">
                ‚è≥ Rozpocznij
              </button>
            ` : ''}
            ${task.status === 'in_progress' ? `
              <button class="btn green small" onclick="updateTaskStatus('${task.id}', 'completed')" style="width:100%;font-size:13px">
                ‚úÖ Zako≈Ñcz
              </button>
            ` : ''}
            ${task.status !== 'completed' ? `
              <button class="btn small" onclick="editWarehouseTask('${task.id}')" style="width:100%;font-size:13px">
                ‚úèÔ∏è Edytuj
              </button>
              <button class="btn red small" onclick="deleteWarehouseTask('${task.id}')" style="width:100%;font-size:13px">
                üóëÔ∏è Usu≈Ñ
              </button>
            ` : `
              <button class="btn small" onclick="deleteWarehouseTask('${task.id}')" style="width:100%;font-size:13px;opacity:0.7">
                üóëÔ∏è Usu≈Ñ
              </button>
            `}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function assignTaskToActiveWarehouseman() {
  if (!activeWarehousemanId) {
    alert('Najpierw wybierz aktywnego magazyniera!');
    return;
  }

  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(activeWarehousemanId));
  if (!employee) {
    alert('Nie znaleziono wybranego magazyniera!');
    return;
  }

  // Pobierz dostƒôpne zlecenia
  const activeOrders = (state.orders || []).filter(o => 
    o.status !== 'completed' && o.status !== 'cancelled'
  );
  
  const ordersOptions = activeOrders.map(order => 
    `<option value="${order.id}">${order.name} (${order.client || 'Bez klienta'})</option>`
  ).join('');

  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div style="background:#eff6ff;padding:12px;border-left:4px solid #3b82f6;border-radius:4px">
        <div style="font-weight:600;color:#1e40af;margin-bottom:4px">üë§ Przypisane do: ${employee.name}</div>
        <div style="font-size:13px;color:#64748b">Zadanie zostanie automatycznie przypisane do aktywnego magazyniera</div>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Tytu≈Ç zadania: <span style="color:red">*</span></label>
        <input type="text" id="wh-task-title" placeholder="np. Przygotowaƒá materia≈Çy do ciƒôcia" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Opis zadania:</label>
        <textarea id="wh-task-description" placeholder="Szczeg√≥≈Çowy opis zadania (opcjonalnie)..." rows="4" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
      </div>
      
      <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Priorytet:</label>
          <select id="wh-task-priority" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
            <option value="low">üü¢ Niski</option>
            <option value="normal" selected>üü° Normalny</option>
            <option value="high">üü† Wysoki</option>
            <option value="urgent">üî¥ Pilne</option>
          </select>
        </div>
        
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Termin wykonania:</label>
          <input type="date" id="wh-task-duedate" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
        </div>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">PowiƒÖzane zlecenie:</label>
        <select id="wh-task-order" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">
          <option value="">‚Äî Zadanie og√≥lne (bez zlecenia) ‚Äî</option>
          ${ordersOptions}
        </select>
        <small style="color: #64748b; font-size: 12px;">Opcjonalne - wybierz je≈õli zadanie dotyczy konkretnego zlecenia</small>
      </div>
    </div>
  `;

  showModal('‚ûï Nowe zadanie magazynowe', content, [
    {
      text: 'Anuluj',
      action: () => {}
    },
    {
      text: 'Utw√≥rz zadanie',
      action: () => {
        const title = document.getElementById('wh-task-title').value.trim();
        const description = document.getElementById('wh-task-description').value.trim();
        const priority = document.getElementById('wh-task-priority').value;
        const dueDate = document.getElementById('wh-task-duedate').value;
        const orderId = document.getElementById('wh-task-order').value;

        if (!title) {
          alert('Tytu≈Ç zadania jest wymagany!');
          return;
        }

        // Inicjalizuj tablicƒô zada≈Ñ je≈õli nie istnieje
        if (!window.warehouseTasks) {
          window.warehouseTasks = [];
        }

        const selectedOrder = orderId ? activeOrders.find(o => o.id === orderId) : null;

        // Utw√≥rz nowe zadanie
        const newTask = {
          id: 'wh-task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
          title: title,
          description: description,
          assignedTo: activeWarehousemanId,
          assignedToName: employee.name,
          status: 'pending',
          priority: priority,
          createdAt: new Date().toISOString(),
          createdBy: 'system',
          dueDate: dueDate || null,
          orderId: selectedOrder ? selectedOrder.id : 'general',
          orderName: selectedOrder ? selectedOrder.name : 'Zadanie og√≥lne'
        };

        window.warehouseTasks.push(newTask);

        // Zapisz zadania
        try {
          localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
        } catch (e) {
          console.warn('Nie mo≈ºna zapisaƒá zada≈Ñ magazynowych:', e);
        }

        saveWarehouseToStorage();
        renderWarehouseWork();
        updateActiveWarehousemanDisplay();
        renderActiveWarehousemanTasks();
        
        const priorityText = priority === 'urgent' ? 'üî¥ Pilne' : 
                            priority === 'high' ? 'üü† Wysokie' : 
                            priority === 'low' ? 'üü¢ Niskie' : 'üü° Normalne';
        
        alert(`‚úÖ Zadanie "${title}" zosta≈Ço utworzone\n\nPriorytet: ${priorityText}\nPrzypisane do: ${employee.name}\nStatus: Do wykonania`);
      }
    }
  ]);
}

function loadActiveWarehousemanFromStorage() {
  try {
    const savedId = localStorage.getItem('activeWarehousemanId');
    if (savedId) {
      activeWarehousemanId = savedId;
      const select = document.getElementById('active-warehouseman-select');
      if (select) {
        select.value = savedId;
      }
      updateActiveWarehousemanDisplay();
    }
  } catch (e) {
    console.warn('Nie mo≈ºna wczytaƒá aktywnego magazyniera:', e);
  }
}

function loadWarehouseTasksFromStorage() {
  try {
    const saved = localStorage.getItem('warehouseTasks');
    if (saved) {
      window.warehouseTasks = JSON.parse(saved);
    } else {
      window.warehouseTasks = [];
    }
  } catch (e) {
    console.warn('Nie mo≈ºna wczytaƒá zada≈Ñ magazynowych:', e);
    window.warehouseTasks = [];
  }
}

function renderWarehouseStaff_REMOVED() {
  const list = document.getElementById('wh-staff-list');
  const countEl = document.getElementById('wh-staff-count');
  
  if (!list) {
    return;
  }

  const employees = ensureEmployeesArray();
  const staff = employees.filter(emp => (emp.role || '').toLowerCase() === 'magazynier');

  // Aktualizacja licznika
  if (countEl) {
    countEl.textContent = `${staff.length} ${staff.length === 1 ? 'magazynier' : staff.length < 5 ? 'magazynier√≥w' : 'magazynier√≥w'}`;
  }

  // Aktualizacja statystyk
  renderWarehouseStaffStats();

  if (!staff.length) {
    list.innerHTML = `
      <div class="card" style="text-align:center;padding:32px;background:#f8fafc">
        <div style="font-size:48px;margin-bottom:12px;opacity:0.3">üë∑</div>
        <div style="font-weight:600;font-size:16px;color:#0f172a;margin-bottom:8px">Brak magazynier√≥w</div>
        <div style="font-size:14px;color:#64748b">Dodaj pracownika korzystajƒÖc z formularza powy≈ºej</div>
      </div>
    `;
    populateWarehouseStaffSelect();
    setWarehouseStaffFormMode('create');
    return;
  }

  // Sortowanie
  staff.sort((a, b) => {
    let valA, valB;
    if (warehouseStaffSortBy === 'name') {
      valA = (a.name || '').toLowerCase();
      valB = (b.name || '').toLowerCase();
      return warehouseStaffSortDir === 'asc' ? valA.localeCompare(valB, 'pl') : valB.localeCompare(valA, 'pl');
    } else if (warehouseStaffSortBy === 'cap') {
      valA = a.cap != null ? a.cap : 100;
      valB = b.cap != null ? b.cap : 100;
      return warehouseStaffSortDir === 'asc' ? valA - valB : valB - valA;
    } else if (warehouseStaffSortBy === 'hours') {
      valA = a.hoursPerDay != null ? a.hoursPerDay : 8;
      valB = b.hoursPerDay != null ? b.hoursPerDay : 8;
      return warehouseStaffSortDir === 'asc' ? valA - valB : valB - valA;
    }
    return 0;
  });

  const items = staff.map((emp, idx) => {
    const phoneInfo = emp.phone ? 'üìû ' + escapeHtml(emp.phone) : '<span style="color:#94a3b8">Brak telefonu</span>';
    const cap = emp.cap != null ? emp.cap : 100;
    const hours = emp.hoursPerDay != null ? emp.hoursPerDay : 8;
    
    // Kolor wska≈∫nika obciƒÖ≈ºenia
    let capColor = '#10b981'; // zielony
    if (cap < 50) capColor = '#f59e0b'; // pomara≈Ñczowy
    else if (cap < 80) capColor = '#3b82f6'; // niebieski
    
    return `
      <div class="card" style="margin-bottom:10px;padding:14px;transition:all 0.2s;border-left:4px solid ${capColor}" data-wh-staff-id="${escapeHtml(emp.id || '')}">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <div style="font-weight:600;font-size:16px;color:#0f172a">${escapeHtml(emp.name || '‚Äî')}</div>
              <span style="background:${capColor};color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">#${idx + 1}</span>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;font-size:13px;color:#475569">
              <div>${phoneInfo}</div>
              <div>üìä ObciƒÖ≈ºenie: <strong>${cap}%</strong></div>
              <div>‚è∞ Godziny: <strong>${hours} h/d</strong></div>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-shrink:0">
            <button class="btn small blue" data-wh-staff-edit="${escapeHtml(emp.id || '')}" style="padding:8px 14px">‚úèÔ∏è Edytuj</button>
            <button class="btn red small" data-wh-staff-remove="${escapeHtml(emp.id || '')}" style="padding:8px 14px">üóëÔ∏è Usu≈Ñ</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  list.innerHTML = items;
  const selectValue = document.getElementById('wh-staff-select')?.value || '';
  populateWarehouseStaffSelect(selectValue);
}

function showWarehouseToast(message, type = 'info') {
  const toast = document.createElement('div');
  const colors = {
    success: 'background:#10b981;',
    error: 'background:#dc2626;',
    info: 'background:#3b82f6;'
  };
  toast.style.cssText = `
    position:fixed;top:80px;right:20px;z-index:9999;
    ${colors[type] || colors.info}
    color:white;padding:12px 20px;border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    font-size:14px;font-weight:600;
    animation:slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  
  const style = document.createElement('style');
  style.textContent = '@keyframes slideIn { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }';
  document.head.appendChild(style);
  
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in forwards';
    toast.style.animationName = 'slideOut';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function populateWarehouseStaffSelect(preserveId) {
  const select = document.getElementById('wh-staff-select');
  if (!select) {
    return;
  }

  const employees = ensureEmployeesArray();
  const options = ['<option value="">‚Äî Wybierz pracownika ‚Äî</option>'];

  employees.slice().sort((a, b) => (a.name || '').localeCompare(b.name || '', 'pl', { sensitivity: 'base' })).forEach(emp => {
    const idRaw = emp.id != null ? String(emp.id) : '';
    if (!idRaw) {
      return;
    }
    const id = idRaw;
    const isMag = (emp.role || '').toLowerCase() === 'magazynier';
    const badge = isMag ? ' (magazynier)' : '';
    options.push(`<option value="${escapeHtml(id)}">${escapeHtml(emp.name || '‚Äî')}${badge}</option>`);
  });

  const previous = preserveId != null ? preserveId : select.value;
  select.innerHTML = options.join('');
  if (previous) {
    select.value = previous;
    if (select.value !== previous) {
      select.value = '';
    }
  }
}

function handleWarehouseStaffSelectChange() {
  const select = document.getElementById('wh-staff-select');
  if (!select) {
    return;
  }

  const phoneInput = document.getElementById('wh-staff-phone');
  const capInput = document.getElementById('wh-staff-cap');
  const hoursInput = document.getElementById('wh-staff-hours');
  const employees = ensureEmployeesArray();
  const employeeId = select.value;

  if (!employeeId) {
    if (phoneInput) phoneInput.value = '';
    if (capInput) capInput.value = '100';
    if (hoursInput) hoursInput.value = '8';
    return;
  }

  const employee = employees.find(emp => String(emp.id) === String(employeeId));
  if (!employee) {
    return;
  }

  if (phoneInput) phoneInput.value = employee.phone || '';
  if (capInput) capInput.value = employee.cap != null ? employee.cap : 100;
  if (hoursInput) hoursInput.value = employee.hoursPerDay != null ? employee.hoursPerDay : 8;
}

function handleWarehouseStaffListClick(event) {
  const target = event.target;
  if (!target) return;

  const editId = target.dataset.whStaffEdit;
  const removeId = target.dataset.whStaffRemove;

  if (editId) {
    startWarehouseStaffEdit(editId);
    event.preventDefault();
    return;
  }

  if (removeId) {
    removeWarehouseStaff(removeId);
    event.preventDefault();
  }
}

function startWarehouseStaffEdit(employeeId) {
  const select = document.getElementById('wh-staff-select');
  if (!select) return;

  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(employeeId));
  if (!employee) return;

  populateWarehouseStaffSelect(employeeId);
  select.value = String(employee.id);
  handleWarehouseStaffSelectChange();
  setWarehouseStaffFormMode('edit', employee);
  select.focus();
}

function removeWarehouseStaff(employeeId) {
  const employees = ensureEmployeesArray();
  const employee = employees.find(emp => String(emp.id) === String(employeeId));
  if (!employee) return;

  if (!confirm(`UsunƒÖƒá magazyniera ${employee.name || ''}?\n\nPracownik zostanie przeniesiony z powrotem do poprzedniej roli.`)) {
    return;
  }

  const fallbackRole = employee.previousRole || 'Pracownik';
  employee.role = fallbackRole;
  if (employee.role === 'Magazynier') {
    employee.role = 'Pracownik';
  }

  save();
  renderEmployees();
  renderWarehouseStaff();
  populateWarehouseStaffSelect();
  handleWarehouseStaffSelectChange();
  setWarehouseStaffFormMode('create');
  
  showWarehouseToast(`‚úÖ ${employee.name} usuniƒôty z magazynu`, 'success');
}

window.showWarehouseToast = showWarehouseToast;
window.setActiveWarehouseman = setActiveWarehouseman;
window.clearActiveWarehouseman = clearActiveWarehouseman;
window.assignTaskToActiveWarehouseman = assignTaskToActiveWarehouseman;
window.updateActiveWarehousemanDisplay = updateActiveWarehousemanDisplay;
window.populateActiveWarehousemanSelect = populateActiveWarehousemanSelect;

// Automatyczne renderowanie magazynu
setTimeout(() => {
  if (window.simpleWarehouse) {
    console.log('Magazyn: Automatyczne renderowanie listy pozycji');
    window.simpleWarehouse.render();
  }
}, 1500);

// Jednorazowa inicjalizacja przy wej≈õciu na zak≈Çadkƒô magazynu
let __warehouseInitialized = false;
function initWarehouse(){
  if(__warehouseInitialized){
    // Przywracamy normalnƒÖ delegacjƒô klikniƒôƒá przy powrocie
    window.restoreNormalClickDelegation();
    // od≈õwie≈º widok przy powrocie
    if(window.simpleWarehouse){
      try { window.simpleWarehouse.render(); } catch(e){ console.warn('[warehouse] re-render error', e); }
    }
    return;
  }
  console.log('[warehouse] initializing...');
  // Przywracamy normalnƒÖ delegacjƒô klikniƒôƒá przy pierwszej inicjalizacji
  window.restoreNormalClickDelegation();
  
  // Upewnij siƒô, ≈ºe dane magazynu sƒÖ za≈Çadowane
  if (!window.warehouseItems) {
    loadWarehouseFromStorage();
  }
  
  // Wczytaj zadania magazynowe
  loadWarehouseTasksFromStorage();
  
  // Wczytaj aktywnego magazyniera
  loadActiveWarehousemanFromStorage();
  
  // Wype≈Çnij select aktywnego magazyniera
  populateActiveWarehousemanSelect();
  
  // Synchronizuj zadania magazynowe ze zleceniami
  if (typeof window.syncWarehouseTasks === 'function') {
    window.syncWarehouseTasks();
  }
  
  // Aktualizuj badge zada≈Ñ
  if (typeof window.updateTasksBadge === 'function') {
    window.updateTasksBadge();
  }
  
  // Renderuj listƒô zada≈Ñ
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
  
  // upewnij siƒô ≈ºe sekcja jest widoczna (usuwamy ewentualnie hidden dopiero po listenerach)
  const section = document.getElementById('p-wh');
  if(section) section.classList.remove('hidden');
  // konfiguracja przycisk√≥w
  try { setupWarehouseButtons(); } catch(e){ console.warn('[warehouse] setup buttons error', e); }
  // pierwsze renderowanie
  if(window.simpleWarehouse){
    try { window.simpleWarehouse.render(); } catch(e){ console.warn('[warehouse] first render error', e); }
  } else {
    console.warn('[warehouse] simpleWarehouse not yet ready, retry in 500ms');
    setTimeout(()=>{
      if(window.simpleWarehouse){
        try { window.simpleWarehouse.render(); } catch(e){ console.warn('[warehouse] delayed render error', e); }
      }
    },500);
  }
  __warehouseInitialized = true;
  console.log('[warehouse] initialized');
}

// Globalne funkcje pomocnicze dla przycisk√≥w
function showAddItemModal() {
  showAddWarehouseModal();
}

function exportWarehouseData() {
  exportWarehouseToCSV();
}

// Kod DOMContentLoaded dla magazynu usuniƒôty

function saveWarehouseToStorage() {
  const localKey = (typeof WAREHOUSE_LOCAL_KEY !== 'undefined') ? WAREHOUSE_LOCAL_KEY : (window.WAREHOUSE_LOCAL_KEY || 'pozycjeMagazynu');
  const legacyKey = (typeof LEGACY_WAREHOUSE_LOCAL_KEY !== 'undefined') ? LEGACY_WAREHOUSE_LOCAL_KEY : (window.LEGACY_WAREHOUSE_LOCAL_KEY || 'warehouseItems');
  const serializedItems = JSON.stringify(window.warehouseItems);
  try{ localStorage.setItem(localKey, serializedItems); }catch(e){ console.warn('[warehouse] Nie uda≈Ço siƒô zapisaƒá magazynu do nowego klucza localStorage:', e && e.message); }
  try{ localStorage.setItem(legacyKey, serializedItems); }catch(e){ console.warn('[warehouse] Nie uda≈Ço siƒô zaktualizowaƒá legacy magazynu w localStorage:', e && e.message); }
  localStorage.setItem('warehouseTransactions', JSON.stringify(window.warehouseTransactions || []));
  localStorage.setItem('warehouseReservations', JSON.stringify(window.warehouseReservations || []));
  localStorage.setItem('materialTemplates', JSON.stringify(window.materialTemplates || []));

  if(state && typeof state === 'object'){
    try {
      state.warehouseItems = Array.isArray(window.warehouseItems) ? window.warehouseItems.map(item => item ? { ...item } : item) : [];
      state.materialTemplates = Array.isArray(window.materialTemplates) ? window.materialTemplates.map(item => item ? { ...item } : item) : [];
      state.warehouseTasks = Array.isArray(window.warehouseTasks) ? window.warehouseTasks.map(item => item ? { ...item } : item) : [];
      state.purchaseOrders = Array.isArray(window.purchaseOrders) ? window.purchaseOrders.map(item => item ? { ...item } : item) : [];
      state.suppliers = Array.isArray(window.suppliers) ? window.suppliers.map(item => item ? { ...item } : item) : [];
    } catch(copyErr) {
      console.warn('[warehouse] Nie uda≈Ço siƒô zsynchronizowaƒá state:', copyErr && copyErr.message);
    }
  }
  if(typeof window !== 'undefined' && window.state && window.state !== state){
    try {
      window.state.warehouseItems = Array.isArray(window.warehouseItems) ? window.warehouseItems.map(item => item ? { ...item } : item) : [];
      window.state.materialTemplates = Array.isArray(window.materialTemplates) ? window.materialTemplates.map(item => item ? { ...item } : item) : [];
      window.state.warehouseTasks = Array.isArray(window.warehouseTasks) ? window.warehouseTasks.map(item => item ? { ...item } : item) : [];
      window.state.purchaseOrders = Array.isArray(window.purchaseOrders) ? window.purchaseOrders.map(item => item ? { ...item } : item) : [];
      window.state.suppliers = Array.isArray(window.suppliers) ? window.suppliers.map(item => item ? { ...item } : item) : [];
    } catch(globCopyErr) {
      console.warn('[warehouse] Nie uda≈Ço siƒô zsynchronizowaƒá window.state:', globCopyErr && globCopyErr.message);
    }
  }

  if(state && state.storage && state.storage.mode === 'firebase'){
    if(state.storage.autoSaveAssign && typeof maybeAutoSave === 'function'){
      try { maybeAutoSave('warehouse-storage'); } catch(autoErr){ console.warn('[warehouse] maybeAutoSave() nie powiod≈Ço siƒô:', autoErr && autoErr.message); }
    } else if(window.FirebaseSyncQueue && typeof window.FirebaseSyncQueue.enqueue === 'function'){
      window.FirebaseSyncQueue.enqueue('save', { state: window.state }, 15);
    } else if(typeof saveToDB === 'function'){
      try { saveToDB(); } catch(syncErr){ console.warn('[warehouse] saveToDB() nie powiod≈Ço siƒô po zapisie magazynu:', syncErr && syncErr.message); }
    } else {
      console.warn('[warehouse] Brak mechanizmu synchronizacji Firebase ‚Äì auto-save i kolejka sƒÖ niedostƒôpne.');
    }
  }
}

function loadWarehouseFromStorage() {
  const localKey = (typeof WAREHOUSE_LOCAL_KEY !== 'undefined') ? WAREHOUSE_LOCAL_KEY : (window.WAREHOUSE_LOCAL_KEY || 'pozycjeMagazynu');
  const legacyKey = (typeof LEGACY_WAREHOUSE_LOCAL_KEY !== 'undefined') ? LEGACY_WAREHOUSE_LOCAL_KEY : (window.LEGACY_WAREHOUSE_LOCAL_KEY || 'warehouseItems');
  const storedNew = localStorage.getItem(localKey);
  const storedLegacy = storedNew ? null : localStorage.getItem(legacyKey);
  try{
    if(storedNew){
      window.warehouseItems = JSON.parse(storedNew);
    } else if(storedLegacy){
      console.warn(`[warehouse] Wczytujƒô magazyn z legacy klucza localStorage '${legacyKey}'`);
      window.warehouseItems = JSON.parse(storedLegacy);
      localStorage.setItem(localKey, storedLegacy);
    } else {
      window.warehouseItems = [];
    }
  }catch(parseErr){
    console.warn('[warehouse] Nie uda≈Ço siƒô odczytaƒá danych magazynu z localStorage:', parseErr && parseErr.message);
    window.warehouseItems = [];
  }
  
  // Historia transakcji (PZ/WZ)
  const transactions = localStorage.getItem('warehouseTransactions');
  if (transactions) {
    window.warehouseTransactions = JSON.parse(transactions);
  } else {
    window.warehouseTransactions = [];
  }
  
  // Rezerwacje pod zlecenia
  const reservations = localStorage.getItem('warehouseReservations');
  if (reservations) {
    window.warehouseReservations = JSON.parse(reservations);
  } else {
    window.warehouseReservations = [];
  }
  
  // Szablony materia≈Çowe
  const templates = localStorage.getItem('materialTemplates');
  if (templates) {
    window.materialTemplates = JSON.parse(templates);
  } else {
    window.materialTemplates = [];
  }
  
  // Lista zakup√≥w
  const shoppingList = localStorage.getItem('shoppingList');
  if (shoppingList) {
    window.shoppingList = JSON.parse(shoppingList);
  } else {
    window.shoppingList = [];
  }
  
  // Zaktualizuj badge listy zakup√≥w
  updateShoppingListBadge();
  
  // Zaktualizuj licznik magazynu na dashboardzie
  if (typeof renderDash === 'function') {
    renderDash(window.state);
  }
}

// Napraw checklisty w zleceniach - znajd≈∫ itemId po nazwie materia≈Çu
window.fixChecklistItemIds = function() {
  const state = window.state || JSON.parse(localStorage.getItem('door_v50_state') || '{}');
  const orders = state.orders || [];
  
  // Wczytaj magazyn
  const warehouseItemsRaw = localStorage.getItem(WAREHOUSE_LOCAL_KEY) || localStorage.getItem(LEGACY_WAREHOUSE_LOCAL_KEY) || '[]';
  const warehouseItems = JSON.parse(warehouseItemsRaw || '[]');
  
  let fixedCount = 0;
  let totalChecked = 0;
  
  orders.forEach(order => {
    if (!order.materialChecklist) return;
    
    order.materialChecklist.forEach(item => {
      totalChecked++;
      
      // Je≈õli itemId ju≈º istnieje, pomi≈Ñ
      if (item.itemId) return;
      
      // Znajd≈∫ w magazynie po nazwie
      const warehouseItem = warehouseItems.find(w => 
        w.name.toLowerCase().trim() === item.itemName.toLowerCase().trim()
      );
      
      if (warehouseItem) {
        item.itemId = warehouseItem.id;
        fixedCount++;
        console.log(`‚úÖ Naprawiono: ${item.itemName} ‚Üí ${warehouseItem.id}`);
      } else {
        console.warn(`‚ö†Ô∏è Nie znaleziono w magazynie: ${item.itemName}`);
      }
    });
  });
  
  // Zapisz stan
  if (fixedCount > 0) {
    state.orders = orders;
    window.state = state;
    localStorage.setItem('door_v50_state', JSON.stringify(state));
  }
  
  console.log(`üîß Sprawdzono ${totalChecked} pozycji w checklistach, naprawiono ${fixedCount}`);
  alert(`Naprawiono ${fixedCount} pozycji w checklistach zlece≈Ñ.\n\nTeraz uruchom window.cleanupShoppingList() ≈ºeby usunƒÖƒá stare pozycje z listy zakup√≥w.`);
};

// Uruchom wszystkie naprawy ID w systemie
window.fixAllItemIds = function() {
  console.log('üöÄ Rozpoczynam kompleksowƒÖ naprawƒô systemu ID...');
  
  try {
    // 1. Napraw istniejƒÖce pozycje w magazynie
    console.log('\nüì¶ Krok 1: Naprawa ID w magazynie...');
    window.fixWarehouseIds();
    
    // 2. Napraw szablony materia≈Çowe
    console.log('\nüìã Krok 2: Naprawa szablon√≥w materia≈Çowych...');
    window.fixTemplateItemIds();
    
    // 3. Napraw checklisty w zleceniach
    console.log('\n‚úÖ Krok 3: Naprawa checklist w zleceniach...');
    window.fixChecklistItemIds();
    
    // 4. Wyczy≈õƒá nieprawid≈Çowe pozycje z listy zakup√≥w
    console.log('\nüßπ Krok 4: Czyszczenie listy zakup√≥w...');
    window.cleanupShoppingList();
    
    // 5. Sprawd≈∫ diagnozƒô
    console.log('\nüîç Krok 5: Ko≈Ñcowa diagnoza systemu...');
    setTimeout(() => {
      window.diagnoseItemIdProblem();
      console.log('\nüéâ Wszystkie naprawy zosta≈Çy zako≈Ñczone!');
      alert('üéâ Wszystkie naprawy systemu ID zosta≈Çy zako≈Ñczone!\n\nOd≈õwie≈º stronƒô (F5) aby zobaczyƒá efekty.');
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå B≈ÇƒÖd podczas napraw:', error);
    alert('‚ùå WystƒÖpi≈Ç b≈ÇƒÖd podczas napraw: ' + error.message);
  }
};

// Diagnostyka problemu z itemId
window.diagnoseItemIdProblem = function() {
  console.log('üîç DIAGNOZA PROBLEMU Z ITEMID');
  console.log('=====================================');
  
  // 1. Sprawd≈∫ szablony materia≈Çowe
  const templates = window.materialTemplates || [];
  console.log(`üìã SZABLONY (${templates.length}):`);
  templates.forEach((tmpl, idx) => {
    console.log(`  ${idx + 1}. "${tmpl.name}" (${tmpl.materials?.length || 0} materia≈Ç√≥w):`);
    (tmpl.materials || []).forEach((mat, matIdx) => {
      const status = mat.itemId ? '‚úÖ' : '‚ùå';
      console.log(`    ${matIdx + 1}. ${status} ${mat.itemName}: itemId=${mat.itemId}`);
    });
  });
  
  // 2. Sprawd≈∫ checklisty w zleceniach
  const state = window.state || JSON.parse(localStorage.getItem('door_v50_state') || '{}');
  const orders = state.orders || [];
  console.log(`\nüìù CHECKLISTY W ZLECENIACH (${orders.filter(o => o.materialChecklist).length}):`);
  orders.forEach(order => {
    if (!order.materialChecklist) return;
    console.log(`  Zlecenie "${order.name}" (${order.materialChecklist.length} pozycji):`);
    order.materialChecklist.forEach((item, idx) => {
      const status = item.itemId ? '‚úÖ' : '‚ùå';
      console.log(`    ${idx + 1}. ${status} ${item.itemName}: itemId=${item.itemId}`);
    });
  });
  
  // 3. Sprawd≈∫ listƒô zakup√≥w
  const shoppingList = window.shoppingList || [];
  const pending = shoppingList.filter(item => item.status === 'pending');
  console.log(`\nüõí LISTA ZAKUP√ìW (${shoppingList.length} ≈ÇƒÖcznie, ${pending.length} oczekujƒÖcych):`);
  pending.forEach((item, idx) => {
    const status = item.itemId ? '‚úÖ' : '‚ùå';
    console.log(`    ${idx + 1}. ${status} ${item.itemName}: itemId=${item.itemId}, order=${item.orderName}`);
  });
  
  // 4. Sprawd≈∫ magazyn
  const warehouseItems = window.warehouseItems || [];
  console.log(`\nüì¶ MAGAZYN (${warehouseItems.length} pozycji):`);
  warehouseItems.forEach((item, idx) => {
    console.log(`    ${idx + 1}. ${item.name}: id=${item.id}`);
  });
  
  console.log('\n=====================================');
  console.log('üîç KONIEC DIAGNOZY');
};

// Napraw istniejƒÖce pozycje w magazynie - dodaj brakujƒÖce ID
window.fixWarehouseIds = function() {
  const warehouseItems = window.warehouseItems || [];
  let fixedCount = 0;
  
  warehouseItems.forEach(item => {
    if (!item.id) {
      item.id = generateId();
      fixedCount++;
      console.log(`‚úÖ Dodano ID dla: ${item.name} ‚Üí ${item.id}`);
    }
  });
  
  if (fixedCount > 0) {
    if (typeof saveWarehouseToStorage === 'function') {
      try {
        saveWarehouseToStorage();
      } catch (storageErr) {
        console.warn('[fixWarehouseIds] saveWarehouseToStorage() zako≈Ñczone b≈Çƒôdem:', storageErr && storageErr.message);
      }
    } else {
      try {
        const serialized = JSON.stringify(window.warehouseItems);
        localStorage.setItem(WAREHOUSE_LOCAL_KEY, serialized);
        localStorage.setItem(LEGACY_WAREHOUSE_LOCAL_KEY, serialized);
      } catch (storageErr) {
        console.warn('[fixWarehouseIds] Nie uda≈Ço siƒô zapisaƒá magazynu po naprawie ID:', storageErr && storageErr.message);
      }
    }
    console.log(`üîß Naprawiono ${fixedCount} pozycji w magazynie`);
  } else {
    console.log(`‚úÖ Wszystkie pozycje w magazynie majƒÖ ID`);
  }
  
  alert(`Naprawiono ${fixedCount} pozycji w magazynie.\n\nTeraz uruchom window.fixTemplateItemIds() ≈ºeby naprawiƒá szablony.`);
};

// Napraw szablony materia≈Çowe - znajd≈∫ itemId po nazwie materia≈Çu
window.fixTemplateItemIds = function() {
  const templates = window.materialTemplates || [];
  const warehouseItems = window.warehouseItems || [];
  
  let fixedCount = 0;
  let totalChecked = 0;
  
  templates.forEach(template => {
    if (!template.materials) return;
    
    template.materials.forEach(material => {
      totalChecked++;
      
      // Je≈õli itemId ju≈º istnieje i jest prawid≈Çowy, pomi≈Ñ
      if (material.itemId && warehouseItems.find(w => w.id === material.itemId)) return;
      
      // Znajd≈∫ w magazynie po nazwie
      const warehouseItem = warehouseItems.find(w => 
        w.name.toLowerCase().trim() === material.itemName.toLowerCase().trim()
      );
      
      if (warehouseItem) {
        material.itemId = warehouseItem.id;
        fixedCount++;
        console.log(`‚úÖ Naprawiono szablon "${template.name}": ${material.itemName} ‚Üí ${warehouseItem.id}`);
      } else {
        console.warn(`‚ö†Ô∏è Nie znaleziono w magazynie dla szablonu "${template.name}": ${material.itemName}`);
      }
    });
  });
  
  // Zapisz szablony
  if (fixedCount > 0) {
    localStorage.setItem('materialTemplates', JSON.stringify(window.materialTemplates));
  }
  
  console.log(`üîß Sprawdzono ${totalChecked} materia≈Ç√≥w w szablonach, naprawiono ${fixedCount}`);
  alert(`Naprawiono ${fixedCount} materia≈Ç√≥w w szablonach.\n\nTeraz uruchom window.fixChecklistItemIds() ≈ºeby naprawiƒá checklisty w zleceniach.`);
};

// Wyczy≈õƒá nieprawid≈Çowe pozycje z listy zakup√≥w (bez itemId)
window.cleanupShoppingList = function() {
  if (!window.shoppingList) return;
  
  const before = window.shoppingList.length;
  window.shoppingList = window.shoppingList.filter(item => item.itemId);
  const after = window.shoppingList.length;
  
  localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
  updateShoppingListBadge();
  
  console.log(`üßπ Wyczyszczono listƒô zakup√≥w: ${before - after} pozycji bez itemId usuniƒôtych`);
  alert(`Wyczyszczono ${before - after} nieprawid≈Çowych pozycji z listy zakup√≥w.\n\nOd≈õwie≈º stronƒô (F5) aby zobaczyƒá zmiany.`);
};

// Aktualizuj badge listy zakup√≥w
function updateShoppingListBadge() {
  const badge = document.getElementById('shopping-badge');
  if (!badge) return;
  
  if (!window.shoppingList) {
    window.shoppingList = [];
  }
  
  // Zlicz unikalne materia≈Çy (itemId) z statusem pending
  const pending = window.shoppingList.filter(item => item.status === 'pending');
  const uniqueItems = new Set(pending.map(item => item.itemId));
  const pendingCount = uniqueItems.size;
  
  console.log('üî¢ Badge update:', { 
    totalPending: pending.length, 
    uniqueMaterials: pendingCount,
    itemIds: Array.from(uniqueItems)
  });
  
  if (pendingCount > 0) {
    badge.textContent = pendingCount;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Prze≈ÇƒÖczanie zak≈Çadek magazynu
function switchWarehouseTab(tab) {
  // Ukryj wszystkie widoki
  const views = ['items', 'work', 'obligations', 'transactions', 'staff', 'templates'];
  views.forEach(v => {
    const viewEl = document.getElementById(`wh-view-${v}`);
    const tabBtn = document.getElementById(`wh-tab-${v}`);
    if (viewEl) viewEl.classList.add('hidden');
    if (tabBtn) tabBtn.classList.remove('amber');
  });
  
  // Poka≈º wybrany widok
  const activeView = document.getElementById(`wh-view-${tab}`);
  const activeBtn = document.getElementById(`wh-tab-${tab}`);
  if (activeView) activeView.classList.remove('hidden');
  if (activeBtn) activeBtn.classList.add('amber');
  
  // Renderuj odpowiedniƒÖ zawarto≈õƒá
  if (tab === 'items') {
    renderWarehouse();
  } else if (tab === 'work') {
    renderWarehouseWork();
    populateActiveWarehousemanSelect();
    updateActiveWarehousemanDisplay();
    if (typeof renderActiveWarehousemanTasks === 'function') {
      renderActiveWarehousemanTasks();
    }
  } else if (tab === 'obligations') {
    renderWarehouseObligations();
  } else if (tab === 'transactions') {
    renderTransactions();
  } else if (tab === 'templates') {
    renderTemplates();
  }
}

// Udostƒôpnij globalnie
window.switchWarehouseTab = switchWarehouseTab;

// Generowanie unikalnego ID
function generateId() {
  return 'wh_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function showEditWarehouseModal(index) {
  const item = window.warehouseItems[index];
  if (!item) return;

  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Nazwa pozycji:</label>
        <input type="text" id="wh-edit-modal-name" value="${item.name}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Ilo≈õƒá:</label>
          <input type="number" id="wh-edit-modal-quantity" value="${item.quantity}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Jednostka:</label>
          <select id="wh-edit-modal-unit" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="szt" ${item.unit === 'szt' ? 'selected' : ''}>szt</option>
            <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
            <option value="m" ${item.unit === 'm' ? 'selected' : ''}>m</option>
            <option value="m¬≤" ${item.unit === 'm¬≤' ? 'selected' : ''}>m¬≤</option>
            <option value="m¬≥" ${item.unit === 'm¬≥' ? 'selected' : ''}>m¬≥</option>
            <option value="l" ${item.unit === 'l' ? 'selected' : ''}>l</option>
            <option value="opak" ${item.unit === 'opak' ? 'selected' : ''}>opak</option>
          </select>
        </div>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Cena (PLN):</label>
        <input type="number" id="wh-edit-modal-price" value="${item.price}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Stan minimalny:</label>
        <input type="number" id="wh-edit-modal-min-stock" value="${item.minStock || 0}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <small style="color: #666; font-size: 12px;">Poni≈ºej tego poziomu pozycja bƒôdzie oznaczona do zam√≥wienia</small>
      </div>
      <hr style="border:none;border-top:1px solid #e2e8f0;margin:8px 0">
      <div style="display:flex;gap:16px;">
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">üìç Rega≈Ç:</label>
          <input type="text" id="wh-edit-modal-shelf" value="${item.location?.shelf || ''}" placeholder="np. R1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">P√≥≈Çka:</label>
          <input type="text" id="wh-edit-modal-rack" value="${item.location?.rack || ''}" placeholder="np. P3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Sektor:</label>
          <input type="text" id="wh-edit-modal-sector" value="${item.location?.sector || ''}" placeholder="np. A" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
      </div>
    </div>
  `;

  showModal('‚úèÔ∏è Edytuj pozycjƒô', content, [
    {
      text: 'Anuluj',
      action: () => {}
    },
    {
      text: 'Zapisz',
      action: () => {
        const name = document.getElementById('wh-edit-modal-name').value.trim();
        const quantity = parseFloat(document.getElementById('wh-edit-modal-quantity').value);
        const unit = document.getElementById('wh-edit-modal-unit').value;
        const price = parseFloat(document.getElementById('wh-edit-modal-price').value);
        const minStock = parseFloat(document.getElementById('wh-edit-modal-min-stock').value) || 0;

        if (!name) {
          alert('Nazwa pozycji jest wymagana!');
          return;
        }

        if (isNaN(quantity) || quantity < 0) {
          alert('Podaj prawid≈ÇowƒÖ ilo≈õƒá!');
          return;
        }

        if (isNaN(price) || price < 0) {
          alert('Podaj prawid≈ÇowƒÖ cenƒô!');
          return;
        }

        if (isNaN(minStock) || minStock < 0) {
          alert('Podaj prawid≈Çowy stan minimalny!');
          return;
        }

        const shelf = document.getElementById('wh-edit-modal-shelf').value.trim();
        const rack = document.getElementById('wh-edit-modal-rack').value.trim();
        const sector = document.getElementById('wh-edit-modal-sector').value.trim();

        window.warehouseItems[index] = { 
          id: item.id, // Zachowaj ID aby nie zerwaƒá powiƒÖza≈Ñ
          name, 
          quantity, 
          unit, 
          price, 
          minStock,
          location: { shelf, rack, sector }
        };
        saveWarehouseToStorage();
        renderWarehouse();
        renderDash();
        maybeAutoSave('warehouse-edit-item');
      }
    }
  ]);
}

// Rozszerzony magazyn z edycjƒÖ
function editWarehouseItem(index) {
  showEditWarehouseModal(index);
}

function deleteWarehouseItem(index) {
  if (confirm('UsunƒÖƒá pozycjƒô?')) {
    window.warehouseItems.splice(index, 1);
    saveWarehouseToStorage();
    renderWarehouse();
    renderDash();
    maybeAutoSave('warehouse-delete-item');
  }
}

function showAdjustQuantityModal(index) {
  ensureWarehouseArrays();

  const item = window.warehouseItems[index];
  if (!item) {
    alert('Nie znaleziono pozycji magazynowej do korekty.');
    return;
  }

  const modalIds = {
    quantity: `wh-adjust-quantity-${index}`,
    note: `wh-adjust-note-${index}`
  };

  const content = `
    <div style="display:flex;flex-direction:column;gap:16px;">
      <div style="background:#0f172a0d;padding:12px;border-radius:8px;line-height:1.6">
        <div style="font-weight:600;font-size:16px;">${item.name}</div>
        <div style="color:#64748b;font-size:14px;">Aktualny stan: <strong>${item.quantity} ${item.unit}</strong></div>
        <div style="color:#64748b;font-size:14px;">Stan minimalny: ${item.minStock || 0} ${item.unit}</div>
      </div>
      <div>
        <label style="display:block;margin-bottom:4px;font-weight:bold;">Nowy stan magazynowy:</label>
        <input type="number" id="${modalIds.quantity}" value="${item.quantity}" min="0" step="0.01" style="width:100%;padding:8px;border:1px solid #cbd5f5;border-radius:6px;">
        <small style="color:#64748b;font-size:12px;display:block;margin-top:4px;">Podaj stan docelowy po korekcie.</small>
      </div>
      <div>
        <label style="display:block;margin-bottom:4px;font-weight:bold;">Uwagi (opcjonalnie):</label>
        <textarea id="${modalIds.note}" rows="2" placeholder="np. Inwentaryzacja, korekta rƒôczna" style="width:100%;padding:8px;border:1px solid #cbd5f5;border-radius:6px;"></textarea>
      </div>
    </div>
  `;

  showModal('üìä Korekta stanu magazynowego', content, [
    { text: 'Anuluj', action: () => {} },
    {
      text: 'Zapisz korektƒô',
      action: () => {
        const targetValue = parseFloat(document.getElementById(modalIds.quantity).value);
        const note = document.getElementById(modalIds.note).value.trim();

        if (Number.isNaN(targetValue) || targetValue < 0) {
          alert('Podaj poprawny docelowy stan magazynowy (‚â• 0).');
          return;
        }

        const delta = parseFloat((targetValue - item.quantity).toFixed(2));
        if (Math.abs(delta) < 0.0001) {
          alert('Brak zmian ‚Äî stan magazynowy pozostaje bez aktualizacji.');
          return;
        }

        const type = delta > 0 ? 'in' : 'out';
        const quantity = Math.abs(delta);

        item.quantity = targetValue;

        const transaction = {
          id: generateId(),
          type,
          itemId: index,
          itemName: item.name,
          quantity,
          unit: item.unit,
          person: 'System',
          notes: note ? `Korekta: ${note}` : 'Korekta stanu magazynowego',
          date: new Date().toISOString(),
          timestamp: Date.now(),
          correction: true,
          previousQuantity: parseFloat((targetValue - delta).toFixed(2)),
          newQuantity: targetValue
        };

        window.warehouseTransactions.push(transaction);
        saveWarehouseToStorage();
        renderWarehouse();
        renderTransactions();
        maybeAutoSave('warehouse-adjust-quantity');

        alert(`‚úÖ Korekta zapisana. Zmiana: ${delta > 0 ? '+' : '-'}${quantity} ${item.unit}.`);
      }
    }
  ]);
}

function showAddWarehouseModal() {
  ensureWarehouseArrays();
  console.log('üß™ [showAddWarehouseModal] Otwieranie modalu');
  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Nazwa pozycji:</label>
        <input type="text" id="wh-modal-name" placeholder="np. Deska sosnowa 2x4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Ilo≈õƒá:</label>
          <input type="number" id="wh-modal-quantity" placeholder="0" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Jednostka:</label>
          <select id="wh-modal-unit" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="szt">szt</option>
            <option value="kg">kg</option>
            <option value="m">m</option>
            <option value="m¬≤">m¬≤</option>
            <option value="m¬≥">m¬≥</option>
            <option value="l">l</option>
            <option value="opak">opak</option>
          </select>
        </div>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Cena (PLN):</label>
        <input type="number" id="wh-modal-price" placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Stan minimalny:</label>
        <input type="number" id="wh-modal-min-stock" placeholder="0" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <small style="color: #666; font-size: 12px;">Poni≈ºej tego poziomu pozycja bƒôdzie oznaczona do zam√≥wienia</small>
      </div>
      <hr style="border:none;border-top:1px solid #e2e8f0;margin:8px 0">
      <div style="display:flex;gap:16px;">
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">üìç Rega≈Ç:</label>
          <input type="text" id="wh-modal-shelf" placeholder="np. R1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">P√≥≈Çka:</label>
          <input type="text" id="wh-modal-rack" placeholder="np. P3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex:1">
          <label style="display: block; margin-bottom: 4px; font-weight: bold;">Sektor:</label>
          <input type="text" id="wh-modal-sector" placeholder="np. A" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
      </div>
    </div>
  `;

  showModal('‚ûï Dodaj pozycjƒô do magazynu', content, [
    {
      text: 'Anuluj',
      action: () => {}
    },
    {
      text: 'Dodaj',
      action: () => {
        console.log('üß™ [showAddWarehouseModal] Kliknƒôto przycisk "Dodaj"');
        const name = document.getElementById('wh-modal-name').value.trim();
        const quantity = parseFloat(document.getElementById('wh-modal-quantity').value);
        const unit = document.getElementById('wh-modal-unit').value;
        const price = parseFloat(document.getElementById('wh-modal-price').value);
        const minStock = parseFloat(document.getElementById('wh-modal-min-stock').value) || 0;

        console.log('üìù Dane: ', { name, quantity, unit, price, minStock });

        if (!name) {
          alert('Nazwa pozycji jest wymagana!');
          return;
        }

        if (isNaN(quantity) || quantity < 0) {
          alert('Podaj prawid≈ÇowƒÖ ilo≈õƒá!');
          return;
        }

        if (isNaN(price) || price < 0) {
          alert('Podaj prawid≈ÇowƒÖ cenƒô!');
          return;
        }

        if (isNaN(minStock) || minStock < 0) {
          alert('Podaj prawid≈Çowy stan minimalny!');
          return;
        }

        const shelf = document.getElementById('wh-modal-shelf').value.trim();
        const rack = document.getElementById('wh-modal-rack').value.trim();
        const sector = document.getElementById('wh-modal-sector').value.trim();

        const newItem = {
          id: generateId(),
          name, 
          quantity, 
          unit, 
          price, 
          minStock,
          location: { shelf, rack, sector }
        };
        
        console.log('‚úÖ [showAddWarehouseModal] Nowa pozycja:', newItem);
        console.log('üìä [showAddWarehouseModal] Liczba pozycji przed: ', window.warehouseItems.length);
        
        window.warehouseItems.push(newItem);
        
        console.log('üìä [showAddWarehouseModal] Liczba pozycji po: ', window.warehouseItems.length);
        console.log('üíæ [showAddWarehouseModal] Zachowujƒô do localStorage...');
        
        saveWarehouseToStorage();
        
        console.log('üì¢ [showAddWarehouseModal] Renderujƒô magazyn...');
        try {
          renderWarehouse();
        } catch (e) {
          console.error('‚ùå [showAddWarehouseModal] renderWarehouse error:', e);
        }
        
        try {
          renderDash();
        } catch (e) {
          console.error('‚ùå [showAddWarehouseModal] renderDash error:', e);
        }
        
        // Synchronizuj z Firebase
        console.log('‚òÅÔ∏è [showAddWarehouseModal] Synchronizujƒô z Firebase...');
        maybeAutoSave('warehouse-add-item');
        
        console.log('‚úÖ [showAddWarehouseModal] Pozycja dodana - koniec');
      }
    }
  ]);
}

function addWarehouseItem() {
  showAddWarehouseModal();
}

// ===== TRANSAKCJE MAGAZYNOWE (PZ/WZ) =====

function showTransactionModal(type) {
  const title = type === 'in' ? 'üì• Przyjƒôcie towaru (PZ)' : 'üì§ Wydanie towaru (WZ)';
  const action = type === 'in' ? 'Przyjmij' : 'Wydaj';
  
  // Lista pozycji do wyboru
  const itemsOptions = window.warehouseItems.map((item, idx) => 
    `<option value="${idx}">${item.name} (stan: ${item.quantity} ${item.unit})</option>`
  ).join('');
  
  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Pozycja:</label>
        <select id="wh-trans-item" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          ${itemsOptions}
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Ilo≈õƒá:</label>
        <input type="number" id="wh-trans-quantity" min="0.01" step="0.01" placeholder="np. 10" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Osoba odpowiedzialna:</label>
        <input type="text" id="wh-trans-person" placeholder="np. Jan Kowalski" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Uwagi:</label>
        <textarea id="wh-trans-notes" placeholder="Opcjonalne uwagi..." rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
      </div>
    </div>
  `;

  showModal(title, content, [
    { text: 'Anuluj', action: () => {} },
    {
      text: action,
      action: () => {
        const itemIdx = parseInt(document.getElementById('wh-trans-item').value);
        const quantity = parseFloat(document.getElementById('wh-trans-quantity').value);
        const person = document.getElementById('wh-trans-person').value.trim();
        const notes = document.getElementById('wh-trans-notes').value.trim();

        if (isNaN(itemIdx) || isNaN(quantity) || quantity <= 0) {
          alert('Podaj poprawnƒÖ ilo≈õƒá');
          return;
        }

        const item = window.warehouseItems[itemIdx];
        if (!item) {
          alert('Nie znaleziono pozycji');
          return;
        }

        // Dla wydania - sprawd≈∫ czy jest wystarczajƒÖca ilo≈õƒá
        if (type === 'out' && item.quantity < quantity) {
          if (!confirm(`NiewystarczajƒÖcy stan! Dostƒôpne: ${item.quantity} ${item.unit}. Kontynuowaƒá?`)) {
            return;
          }
        }

        // Utw√≥rz transakcjƒô
        const transaction = {
          id: generateId(),
          type: type, // 'in' lub 'out'
          itemId: itemIdx,
          itemName: item.name,
          quantity: quantity,
          unit: item.unit,
          person: person || '‚Äî',
          notes: notes,
          date: new Date().toISOString(),
          timestamp: Date.now()
        };

        // Zaktualizuj stan magazynowy
        if (type === 'in') {
          item.quantity += quantity;
        } else {
          item.quantity -= quantity;
        }

        // Zapisz transakcjƒô
        if (!window.warehouseTransactions) {
          window.warehouseTransactions = [];
        }
        window.warehouseTransactions.push(transaction);

        saveWarehouseToStorage();
        alert(`‚úÖ ${type === 'in' ? 'Przyjƒôto' : 'Wydano'} ${quantity} ${item.unit} - ${item.name}`);
        renderTransactions();
        renderWarehouse(); // Od≈õwie≈º te≈º listƒô pozycji
      }
    }
  ]);
}

function renderTransactions() {
  const list = document.getElementById('wh-transactions-list');
  if (!list) return;

  const filter = document.getElementById('wh-transaction-filter')?.value || '';
  let transactions = (window.warehouseTransactions || []).slice().reverse(); // Najnowsze na g√≥rze

  if (filter) {
    transactions = transactions.filter(t => t.type === filter);
  }

  if (transactions.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak transakcji</div>';
    return;
  }

  list.innerHTML = transactions.map(trans => {
    const date = new Date(trans.date);
    const dateStr = date.toLocaleDateString('pl-PL');
    const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
    const typeIcon = trans.type === 'in' ? 'üì•' : 'üì§';
    const typeLabel = trans.type === 'in' ? 'Przyjƒôcie (PZ)' : 'Wydanie (WZ)';
    const typeColor = trans.type === 'in' ? '#10b981' : '#f59e0b';

    return `
      <div class="card" style="margin-bottom:8px;border-left:4px solid ${typeColor}">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div style="font-weight:600;margin-bottom:4px">
              ${typeIcon} ${typeLabel}
            </div>
            <div style="font-size:14px;color:#64748b">
              <strong>${trans.itemName}</strong> - ${trans.quantity} ${trans.unit}
            </div>
            <div style="font-size:12px;color:#94a3b8;margin-top:4px">
              ${dateStr} ${timeStr} ‚Ä¢ Osoba: ${trans.person}
            </div>
            ${trans.notes ? `<div style="font-size:12px;color:#94a3b8;margin-top:4px;font-style:italic">${trans.notes}</div>` : ''}
          </div>
          <button class="btn red small" onclick="deleteTransaction('${trans.id}')">Usu≈Ñ</button>
        </div>
      </div>
    `;
  }).join('');
}

function deleteTransaction(transId) {
  if (!confirm('UsunƒÖƒá transakcjƒô? To nie cofnie zmian w stanie magazynowym!')) {
    return;
  }
  window.warehouseTransactions = window.warehouseTransactions.filter(t => t.id !== transId);
  saveWarehouseToStorage();
  renderTransactions();
}

// ===== REZERWACJE POD ZLECENIA =====

// Aktualizacja listy materia≈Ç√≥w po wyborze zlecenia
function updateMaterialsForOrder() {
  const orderSelect = document.getElementById('wh-res-order');
  const itemSelect = document.getElementById('wh-res-item');
  const orderId = orderSelect.value;
  
  if (!orderId) {
    itemSelect.innerHTML = '<option value="">‚Äî najpierw wybierz zlecenie ‚Äî</option>';
    return;
  }
  
  const order = (state.orders || []).find(o => o.id === orderId);
  
  if (!order || !order.materialChecklist || order.materialChecklist.length === 0) {
    itemSelect.innerHTML = '<option value="">‚Äî to zlecenie nie ma checklisty materia≈Ç√≥w ‚Äî</option>';
    return;
  }
  
  // Poka≈º tylko materia≈Çy z checklisty zlecenia
  const options = order.materialChecklist.map((item, idx) => {
    const warehouseItem = (window.warehouseItems || []).find(w => w.id === item.itemId);
    const available = warehouseItem ? warehouseItem.quantity : 0;
    const checkMark = item.checked ? '‚úÖ ' : '';
    return `<option value="${item.itemId}">${checkMark}${item.itemName} (dostƒôpne: ${available} ${item.unit})</option>`;
  }).join('');
  
  itemSelect.innerHTML = options;
}

function showReservationModal() {
  const itemsOptions = window.warehouseItems.map((item, idx) => 
    `<option value="${idx}">${item.name} (dostƒôpne: ${item.quantity} ${item.unit})</option>`
  ).join('');

  const ordersOptions = (state.orders || []).map(order =>
    `<option value="${order.id}">${order.name}</option>`
  ).join('');

  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Zlecenie:</label>
        <select id="wh-res-order" onchange="updateMaterialsForOrder()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">‚Äî wybierz zlecenie ‚Äî</option>
          ${ordersOptions}
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Materia≈Ç:</label>
        <select id="wh-res-item" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">‚Äî najpierw wybierz zlecenie ‚Äî</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Ilo≈õƒá do zarezerwowania:</label>
        <input type="number" id="wh-res-quantity" min="0.01" step="0.01" placeholder="np. 5" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Uwagi:</label>
        <textarea id="wh-res-notes" placeholder="Opcjonalne uwagi..." rows="2" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
      </div>
    </div>
  `;

  showModal('üîí Nowa rezerwacja', content, [
    { text: 'Anuluj', action: () => {} },
    {
      text: 'Zarezerwuj',
      action: () => {
        const orderId = document.getElementById('wh-res-order').value;
        const itemId = document.getElementById('wh-res-item').value;
        const quantity = parseFloat(document.getElementById('wh-res-quantity').value);
        const notes = document.getElementById('wh-res-notes').value.trim();

        if (!orderId) {
          alert('Wybierz zlecenie');
          return;
        }

        if (!itemId || isNaN(quantity) || quantity <= 0) {
          alert('Wybierz materia≈Ç i podaj poprawnƒÖ ilo≈õƒá');
          return;
        }

        const item = (window.warehouseItems || []).find(w => w.id === itemId);
        const order = (state.orders || []).find(o => o.id === orderId);
        
        if (!item || !order) {
          alert('Nie znaleziono pozycji lub zlecenia');
          return;
        }

        // Sprawd≈∫ dostƒôpno≈õƒá
        const existingReservations = (window.warehouseReservations || [])
          .filter(r => r.itemId === itemId && r.status === 'active')
          .reduce((sum, r) => sum + r.quantity, 0);
        
        const available = item.quantity - existingReservations;

        if (available < quantity) {
          alert(`NiewystarczajƒÖca ilo≈õƒá! Dostƒôpne: ${available} ${item.unit} (stan: ${item.quantity}, zarezerwowane: ${existingReservations})`);
          return;
        }

        // Utw√≥rz rezerwacjƒô
        const reservation = {
          id: generateId(),
          orderId: order.id,
          orderName: order.name,
          itemId: item.id,
          itemName: item.name,
          quantity: quantity,
          unit: item.unit,
          notes: notes,
          date: new Date().toISOString(),
          timestamp: Date.now(),
          status: 'active' // active, used, cancelled
        };

        if (!window.warehouseReservations) {
          window.warehouseReservations = [];
        }
        window.warehouseReservations.push(reservation);

        saveWarehouseToStorage();
        alert(`‚úÖ Zarezerwowano ${quantity} ${item.unit} - ${item.name} dla zlecenia ${order.name}`);
        renderReservations();
      }
    }
  ]);
}

function getReservedQuantity(itemIdx) {
  if (!window.warehouseReservations) return 0;
  return window.warehouseReservations
    .filter(r => r.itemId === itemIdx && r.status === 'active')
    .reduce((sum, r) => sum + r.quantity, 0);
}

function renderReservations() {
  const list = document.getElementById('wh-reservations-list');
  if (!list) return;

  // Zapamiƒôtaj otwarte szczeg√≥≈Çy PRZED renderowaniem
  const openDetails = [];
  document.querySelectorAll('[id^="details-"]').forEach(el => {
    if (el.style.display !== 'none') {
      openDetails.push(el.id);
    }
  });

  const reservations = (window.warehouseReservations || []).filter(r => r.status === 'active');

  if (reservations.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak aktywnych rezerwacji</div>';
    return;
  }

  // Grupuj rezerwacje po orderId (zleceniu)
  const grouped = {};
  reservations.forEach(res => {
    if (!grouped[res.orderId]) {
      grouped[res.orderId] = {
        orderId: res.orderId,
        orderName: res.orderName,
        materials: []
      };
    }
    grouped[res.orderId].materials.push(res);
  });

  // Renderuj zgrupowane rezerwacje po zleceniu
  list.innerHTML = Object.values(grouped).map(group => {
    const detailsId = `details-${group.orderId}`;
    
    // Sprawd≈∫ status wszystkich materia≈Ç√≥w w zleceniu - na podstawie receivedDate
    let allReceived = true;
    let someReceived = false;
    let allIssued = true;
    
    group.materials.forEach(mat => {
      if (mat.receivedDate) {
        someReceived = true;
      } else {
        allReceived = false;
      }
      
      if (!mat.issuedDate) {
        allIssued = false;
      }
    });
    
    // Okre≈õl kolor ramki i status zlecenia
    let borderColor = '#3b82f6'; // niebieski - zarezerwowane
    let statusBadge = '';
    
    if (allIssued) {
      // Wszystko wydane
      borderColor = '#8b5cf6'; // fioletowy - wydane
      statusBadge = `<span style="display:inline-block;padding:4px 8px;background:#8b5cf6;color:white;border-radius:4px;font-size:12px;font-weight:600;margin-right:6px">üì¶ Wszystko wydane</span>`;
    } else if (allReceived) {
      // Wszystko przyjƒôte do magazynu
      borderColor = '#10b981'; // zielony - przyjƒôte
      statusBadge = `<span style="display:inline-block;padding:4px 8px;background:#10b981;color:white;border-radius:4px;font-size:12px;font-weight:600;margin-right:6px">‚úÖ Wszystko przyjƒôte</span>`;
    } else if (someReceived) {
      // Czƒô≈õciowo przyjƒôte
      borderColor = '#f59e0b'; // pomara≈Ñczowy - czƒô≈õciowo
      statusBadge = `<span style="display:inline-block;padding:4px 8px;background:#f59e0b;color:white;border-radius:4px;font-size:12px;font-weight:600;margin-right:6px">‚ö†Ô∏è Czƒô≈õciowo przyjƒôte</span>`;
    } else {
      // Nic nie przyjƒôte
      borderColor = '#ef4444'; // czerwony - oczekuje
      statusBadge = `<span style="display:inline-block;padding:4px 8px;background:#ef4444;color:white;border-radius:4px;font-size:12px;font-weight:600;margin-right:6px">‚è≥ Oczekuje na przyjƒôcie</span>`;
    }
    
    // Oblicz daty przyjƒôcia i wydania dla ca≈Çego zlecenia
    let earliestReceived = null;
    let latestIssued = null;
    
    group.materials.forEach(mat => {
      if (mat.receivedDate) {
        const rd = new Date(mat.receivedDate);
        if (!earliestReceived || rd < earliestReceived) {
          earliestReceived = rd;
        }
      }
      if (mat.issuedDate) {
        const id = new Date(mat.issuedDate);
        if (!latestIssued || id > latestIssued) {
          latestIssued = id;
        }
      }
    });
    
    // Formatuj daty dla nag≈Ç√≥wka
    let orderDateBadges = '';
    if (earliestReceived) {
      const receivedStr = earliestReceived.toLocaleDateString('pl-PL', { 
        year: 'numeric', month: '2-digit', day: '2-digit', 
        hour: '2-digit', minute: '2-digit' 
      });
      orderDateBadges += `<div style="font-size:14px;margin-bottom:4px;padding:4px 8px;background:#d1fae5;border-left:3px solid #10b981;border-radius:4px">
        <span style="color:#065f46;font-weight:600">‚úÖ Przyjƒôto:</span>
        <span style="color:#000;font-weight:600;margin-left:6px">${receivedStr}</span>
      </div>`;
    }
    if (latestIssued) {
      const issuedStr = latestIssued.toLocaleDateString('pl-PL', { 
        year: 'numeric', month: '2-digit', day: '2-digit', 
        hour: '2-digit', minute: '2-digit' 
      });
      orderDateBadges += `<div style="font-size:14px;margin-bottom:4px;padding:4px 8px;background:#dbeafe;border-left:3px solid #3b82f6;border-radius:4px">
        <span style="color:#1e40af;font-weight:600">üì¶ Wydano:</span>
        <span style="color:#000;font-weight:600;margin-left:6px">${issuedStr}</span>
      </div>`;
    }
    
    return `
      <div class="card" style="margin-bottom:12px;border-left:4px solid ${borderColor}">
        <div style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div style="font-size:16px;margin-bottom:8px;padding:6px 12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:4px">
                <span style="color:#92400e;font-weight:600">üìã Nr zlecenia:</span>
                <span style="color:#000;font-weight:700;font-size:18px;margin-left:8px">${group.orderName}</span>
              </div>
              ${orderDateBadges}
              <div style="margin-bottom:8px">
                ${statusBadge}
                <span style="display:inline-block;padding:4px 8px;background:#e2e8f0;color:#334155;border-radius:4px;font-size:12px;font-weight:600">üì¶ ${group.materials.length} ${group.materials.length === 1 ? 'materia≈Ç' : 'materia≈Ç√≥w'}</span>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;margin-left:12px">
              <button class="btn small blue" onclick="toggleDetails('${detailsId}')">
                Szczeg√≥≈Çy ‚ñº
              </button>
              <button class="btn small" onclick="exportIssuedMaterials('${group.orderId}', '${group.orderName}')" style="background:#10b981;color:white">
                üìÑ Wydano (Excel)
              </button>
              <button class="btn small" onclick="completeOrder('${group.orderId}')" style="background:#8b5cf6;color:white">
                üèÅ Zako≈Ñcz zlecenie
              </button>
            </div>
          </div>
        </div>
        
        <div id="${detailsId}" style="display:none;border-top:1px solid #e2e8f0;padding-top:12px;margin-top:8px">
          ${group.materials.map(mat => {
            // Formatuj daty
            const reservedDate = mat.date ? new Date(mat.date).toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'Brak daty';
            const receivedDateStr = mat.receivedDate ? new Date(mat.receivedDate).toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : null;
            const issuedDateStr = mat.issuedDate ? new Date(mat.issuedDate).toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : null;
            
            // Sprawd≈∫ status materia≈Çu na podstawie dat
            let statusBadge = '';
            let bgColor = '#f8fafc';
            
            if (mat.issuedDate) {
              statusBadge = `<span style="display:inline-block;padding:3px 6px;background:#3b82f6;color:white;border-radius:3px;font-size:11px;font-weight:600;margin-left:8px">üì¶ Wydano</span>`;
              bgColor = '#eff6ff';
            } else if (mat.receivedDate) {
              statusBadge = `<span style="display:inline-block;padding:3px 6px;background:#10b981;color:white;border-radius:3px;font-size:11px;font-weight:600;margin-left:8px">‚úÖ Przyjƒôto</span>`;
              bgColor = '#f0fdf4';
            } else {
              statusBadge = `<span style="display:inline-block;padding:3px 6px;background:#f59e0b;color:white;border-radius:3px;font-size:11px;font-weight:600;margin-left:8px">‚è≥ Oczekuje</span>`;
              bgColor = '#fffbeb';
            }
            
            return `
              <div style="padding:12px;background:${bgColor};border-radius:6px;margin-bottom:8px">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                  <div style="flex:1">
                    <div style="font-size:15px;font-weight:600;color:#334155;margin-bottom:6px">
                      üì¶ ${mat.itemName}
                      ${statusBadge}
                    </div>
                    <div style="font-size:14px;color:#64748b;margin-bottom:6px">
                      Ilo≈õƒá: <strong style="color:#1e293b;font-size:16px">${mat.quantity} ${mat.unit}</strong>
                    </div>
                    <div style="font-size:13px;color:#64748b;line-height:1.6">
                      üìÖ <strong>Zarezerwowano:</strong> ${reservedDate}
                      ${receivedDateStr ? `<br>‚úÖ <strong style="color:#059669">Przyjƒôto:</strong> ${receivedDateStr}` : ''}
                      ${issuedDateStr ? `<br>üì¶ <strong style="color:#2563eb">Wydano:</strong> ${issuedDateStr}` : ''}
                    </div>
                    ${mat.notes ? `<div style="font-size:12px;color:#94a3b8;margin-top:6px;font-style:italic;padding:6px;background:#f8fafc;border-radius:4px">üí¨ ${mat.notes}</div>` : ''}
                  </div>
                  <div style="display:flex;flex-direction:column;gap:6px;min-width:140px">
                    ${!mat.receivedDate ? `<button class="btn small green" onclick="markAsReceived('${mat.id}')" style="width:100%;font-size:13px;padding:8px">
                      Przyjmij
                    </button>` : `<button class="btn small" disabled style="width:100%;font-size:13px;padding:8px;background:#d1fae5;color:#065f46;cursor:not-allowed">
                      ‚úÖ Przyjƒôto
                    </button>`}
                    ${mat.receivedDate && !mat.issuedDate ? `<button class="btn small blue" onclick="markAsIssued('${mat.id}')" style="width:100%;font-size:13px;padding:8px">
                      üì¶ Wydaj
                    </button>` : mat.issuedDate ? `<button class="btn small" disabled style="width:100%;font-size:13px;padding:8px;background:#dbeafe;color:#1e40af;cursor:not-allowed">
                      üì¶ Wydano
                    </button>` : ''}
                    <button class="btn small red" onclick="cancelReservation('${mat.id}')" style="width:100%;font-size:13px;padding:8px">
                      ‚úï Anuluj
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
  
  // Przywr√≥ƒá otwarte szczeg√≥≈Çy PO renderowaniu
  requestAnimationFrame(() => {
    openDetails.forEach(detailsId => {
      const details = document.getElementById(detailsId);
      if (details) {
        details.style.display = 'block';
        // Zmie≈Ñ tekst przycisku
        const button = document.querySelector(`button[onclick="toggleDetails('${detailsId}')"]`);
        if (button) {
          button.textContent = 'Ukryj ‚ñ≤';
        }
      }
    });
  });
}

// Udostƒôpnij globalnie
window.renderReservations = renderReservations;

// Funkcja do prze≈ÇƒÖczania szczeg√≥≈Ç√≥w
window.toggleDetails = function(detailsId) {
  const details = document.getElementById(detailsId);
  if (!details) return;
  
  const isHidden = details.style.display === 'none';
  details.style.display = isHidden ? 'block' : 'none';
  
  // Zmie≈Ñ tekst przycisku
  const button = document.querySelector(`button[onclick="toggleDetails('${detailsId}')"]`);
  if (button) {
    button.textContent = isHidden ? 'Ukryj ‚ñ≤' : 'Szczeg√≥≈Çy ‚ñº';
  }
};

// Oznacz materia≈Ç jako przyjƒôty (dostƒôpny w magazynie)
window.markAsReceived = function(resId) {
  if (!window.warehouseReservations || !Array.isArray(window.warehouseReservations)) {
    alert('B≈ÇƒÖd: Brak danych rezerwacji');
    return;
  }
  
  // Znajd≈∫ dok≈Çadnie tƒô jednƒÖ rezerwacjƒô
  const reservation = window.warehouseReservations.find(r => r.id === resId);
  
  if (!reservation) {
    alert('B≈ÇƒÖd: Nie znaleziono rezerwacji');
    return;
  }
  
  // Sprawd≈∫ czy ju≈º nie jest przyjƒôta
  if (reservation.receivedDate) {
    alert('Ten materia≈Ç jest ju≈º oznaczony jako przyjƒôty');
    return;
  }
  
  if (confirm(`PrzyjƒÖƒá materia≈Ç do magazynu?\n\nüì¶ ${reservation.itemName}\nIlo≈õƒá: ${reservation.quantity} ${reservation.unit}\nZlecenie: ${reservation.orderName}`)) {
    // Oznacz jako przyjƒôty - dodaj datƒô
    reservation.receivedDate = new Date().toISOString();
    
    // Zapisz do localStorage
    saveWarehouseToStorage();
    
    // Od≈õwie≈º widok - NIE zamykaj otwartych szczeg√≥≈Ç√≥w
    alert(`‚úÖ Przyjƒôto: ${reservation.itemName}`);
    
    // Zapamiƒôtaj, kt√≥re szczeg√≥≈Çy sƒÖ otwarte
    window._keepDetailsOpen = true;
    renderReservations();
  }
};

// Oznacz materia≈Ç jako wydany (wydano z magazynu do zlecenia)
window.markAsIssued = function(resId) {
  if (!window.warehouseReservations || !Array.isArray(window.warehouseReservations)) {
    alert('B≈ÇƒÖd: Brak danych rezerwacji');
    return;
  }
  
  // Znajd≈∫ dok≈Çadnie tƒô jednƒÖ rezerwacjƒô
  const reservation = window.warehouseReservations.find(r => r.id === resId);
  
  if (!reservation) {
    alert('B≈ÇƒÖd: Nie znaleziono rezerwacji');
    return;
  }
  
  // Sprawd≈∫ czy materia≈Ç zosta≈Ç przyjƒôty
  if (!reservation.receivedDate) {
    alert('Najpierw oznacz materia≈Ç jako przyjƒôty');
    return;
  }
  
  // Sprawd≈∫ czy ju≈º nie jest wydany
  if (reservation.issuedDate) {
    alert('Ten materia≈Ç jest ju≈º oznaczony jako wydany');
    return;
  }
  
  if (confirm(`Wydaƒá materia≈Ç z magazynu?\n\nüì¶ ${reservation.itemName}\nIlo≈õƒá: ${reservation.quantity} ${reservation.unit}\nZlecenie: ${reservation.orderName}\n\n‚ö†Ô∏è Stan magazynu zostanie zmniejszony`)) {
    // Oznacz jako wydany - dodaj datƒô
    reservation.issuedDate = new Date().toISOString();
    
    // Zmniejsz stan magazynu
    const warehouseItem = (window.warehouseItems || []).find(w => w.id === reservation.itemId);
    if (warehouseItem) {
      warehouseItem.quantity -= reservation.quantity;
      
      // Utw√≥rz transakcjƒô WZ (wydanie zewnƒôtrzne)
      const transaction = {
        id: generateId(),
        type: 'WZ',
        itemId: reservation.itemId,
        itemName: reservation.itemName,
        quantity: reservation.quantity,
        unit: reservation.unit,
        date: new Date().toISOString(),
        notes: `Wydano dla zlecenia: ${reservation.orderName}`,
        orderId: reservation.orderId,
        orderName: reservation.orderName
      };
      
      if (!window.warehouseTransactions) {
        window.warehouseTransactions = [];
      }
      window.warehouseTransactions.push(transaction);
    }
    
    // Zapisz do localStorage
    saveWarehouseToStorage();
    
    // Od≈õwie≈º widok - NIE zamykaj otwartych szczeg√≥≈Ç√≥w
    alert(`üì¶ Wydano: ${reservation.itemName}\n\nStan magazynu: ${warehouseItem ? warehouseItem.quantity : '?'} ${reservation.unit}`);
    
    // Zapamiƒôtaj, kt√≥re szczeg√≥≈Çy sƒÖ otwarte
    window._keepDetailsOpen = true;
    renderReservations();
    if (typeof renderWarehouse === 'function') renderWarehouse();
  }
};

// Anuluj rezerwacjƒô
window.cancelReservation = function(resId) {
  if (!window.warehouseReservations || !Array.isArray(window.warehouseReservations)) {
    alert('B≈ÇƒÖd: Brak danych rezerwacji');
    return;
  }
  
  // Znajd≈∫ dok≈Çadnie tƒô jednƒÖ rezerwacjƒô
  const reservation = window.warehouseReservations.find(r => r.id === resId);
  
  if (!reservation) {
    alert('B≈ÇƒÖd: Nie znaleziono rezerwacji');
    return;
  }
  
  if (confirm(`Anulowaƒá rezerwacjƒô?\n\nüì¶ ${reservation.itemName}\nIlo≈õƒá: ${reservation.quantity} ${reservation.unit}\nZlecenie: ${reservation.orderName}\n\n‚ö†Ô∏è Rezerwacja zostanie usuniƒôta`)) {
    // Zmie≈Ñ status na 'cancelled'
    reservation.status = 'cancelled';
    reservation.cancelledDate = new Date().toISOString();
    
    // Zapisz do localStorage
    saveWarehouseToStorage();
    
    // Od≈õwie≈º widok - NIE zamykaj otwartych szczeg√≥≈Ç√≥w
    alert(`‚úï Anulowano rezerwacjƒô: ${reservation.itemName}`);
    
    // Zapamiƒôtaj, kt√≥re szczeg√≥≈Çy sƒÖ otwarte
    window._keepDetailsOpen = true;
    renderReservations();
  }
};

// Zako≈Ñcz zlecenie - przenie≈õ rezerwacje do archiwum
window.completeOrder = function(orderId) {
  const reservations = (window.warehouseReservations || []).filter(r => r.orderId === orderId && r.status === 'active');
  
  if (reservations.length === 0) {
    alert('Brak aktywnych rezerwacji dla tego zlecenia');
    return;
  }
  
  const orderName = reservations[0].orderName;
  
  if (confirm(`Zako≈Ñczyƒá zlecenie "${orderName}"?\n\n‚úì Wszystkie rezerwacje zostanƒÖ zamkniƒôte\n‚úì Zlecenie przejdzie do archiwum\n‚úì Historia zostanie zachowana\n\nLiczba rezerwacji: ${reservations.length}`)) {
    // Zmie≈Ñ status wszystkich rezerwacji na 'completed'
    reservations.forEach(res => {
      res.status = 'completed';
      res.completedDate = new Date().toISOString();
    });
    
    saveWarehouseToStorage();
    alert(`üèÅ Zlecenie "${orderName}" zako≈Ñczone!\n\n${reservations.length} rezerwacji przeniesiono do archiwum.`);
    renderReservations();
  }
};

// Eksport wydanych materia≈Ç√≥w do Excel/CSV
window.exportIssuedMaterials = function(orderId, orderName) {
  const reservations = (window.warehouseReservations || [])
    .filter(r => r.orderId === orderId && r.status === 'active');
  
  if (reservations.length === 0) {
    alert('Brak materia≈Ç√≥w do eksportu dla tego zlecenia');
    return;
  }
  
  // Przygotuj dane do eksportu
  let csvContent = '\uFEFF'; // BOM dla UTF-8
  csvContent += `KARTA WYDANIA MATERIA≈Å√ìW\n`;
  csvContent += `Zlecenie nr: ${orderName}\n`;
  csvContent += `Data wydruku: ${new Date().toLocaleDateString('pl-PL', { 
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit' 
  })}\n\n`;
  
  // Nag≈Ç√≥wki tabeli
  csvContent += `Lp.;Materia≈Ç;Ilo≈õƒá;Jednostka;Data przyjƒôcia;Data wydania;Status\n`;
  
  // Dane materia≈Ç√≥w
  reservations.forEach((mat, index) => {
    const lp = index + 1;
    const itemName = mat.itemName || '';
    const quantity = mat.quantity || 0;
    const unit = mat.unit || 'szt';
    
    const receivedDate = mat.receivedDate 
      ? new Date(mat.receivedDate).toLocaleDateString('pl-PL', { 
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit' 
        })
      : 'Oczekuje';
    
    const issuedDate = mat.issuedDate 
      ? new Date(mat.issuedDate).toLocaleDateString('pl-PL', { 
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit' 
        })
      : '-';
    
    const status = mat.issuedDate 
      ? 'Wydano' 
      : (mat.receivedDate ? 'Przyjƒôto' : 'Oczekuje');
    
    csvContent += `${lp};${itemName};${quantity};${unit};${receivedDate};${issuedDate};${status}\n`;
  });
  
  // Podsumowanie
  csvContent += `\n`;
  csvContent += `Razem materia≈Ç√≥w: ${reservations.length}\n`;
  csvContent += `Wydanych: ${reservations.filter(r => r.issuedDate).length}\n`;
  csvContent += `OczekujƒÖcych: ${reservations.filter(r => !r.issuedDate).length}\n`;
  
  // Podpisy
  csvContent += `\n\n`;
  csvContent += `Wyda≈Ç: ________________  Data: ________  Podpis: ________________\n`;
  csvContent += `\n`;
  csvContent += `Odebra≈Ç: ________________  Data: ________  Podpis: ________________\n`;
  
  // Utw√≥rz plik i pobierz
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `Wydanie_materialy_zlecenie_${orderName}_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert(`üìÑ Wyeksportowano kartƒô wydania materia≈Ç√≥w\n\nZlecenie: ${orderName}\nMateria≈Ç√≥w: ${reservations.length}\n\nPlik CSV mo≈ºna otworzyƒá w Excel`);
};

// ============ SYSTEM ZADA≈É MAGAZYNIERA ============

// Inicjalizacja zada≈Ñ magazyniera w localStorage
if (!window.warehouseTasks) {
  window.warehouseTasks = JSON.parse(localStorage.getItem('warehouseTasks') || '[]');
}

  // Synchronizuj zadania magazynowe ze zleceniami (wywo≈Çywane po ka≈ºdym zapisie stanu)
window.syncWarehouseTasks = function() {
  if (!window.state || !window.state.orders) return;
  
  // Dla ka≈ºdego aktywnego zlecenia sprawd≈∫ materia≈Çy
  window.state.orders.forEach(order => {
    // Sprawd≈∫ czy checklist ma FAKTYCZNE materia≈Çy (nie puste wpisy)
    const validMaterials = (order.materialChecklist || []).filter(m => 
      m && m.itemName && m.itemName.trim() !== '' && m.quantity > 0
    );
    
    if (validMaterials.length > 0) {
      generateWarehouseTasksForOrder(order);
    }
  });
  
  // Wyczy≈õƒá puste/niewa≈ºne zadania
  cleanupEmptyWarehouseTasks();
  
  // Aktualizuj badge
  if (typeof window.updateTasksBadge === 'function') {
    window.updateTasksBadge();
  }
};

// Wyczy≈õƒá puste i niewa≈ºne zadania magazynowe
window.cleanupEmptyWarehouseTasks = function() {
  if (!window.warehouseTasks) return;
  
  const beforeCount = window.warehouseTasks.length;
  
  // Usu≈Ñ zadania bez itemName lub quantity
  window.warehouseTasks = window.warehouseTasks.filter(task => {
    // Sprawd≈∫ czy zadanie ma wszystkie wymagane pola
    if (!task || !task.itemName || task.itemName.trim() === '') {
      console.warn('üóëÔ∏è Usuwam puste zadanie magazynowe:', task);
      return false;
    }
    
    // Sprawd≈∫ czy zadanie odnosi siƒô do istniejƒÖcego zlecenia
    const orderExists = (state.orders || []).some(o => o.id === task.orderId);
    if (!orderExists) {
      console.warn('üóëÔ∏è Usuwam zadanie dla nieistniejƒÖcego zlecenia:', task.orderId);
      return false;
    }
    
    return true;
  });
  
  const removedCount = beforeCount - window.warehouseTasks.length;
  if (removedCount > 0) {
    console.log(`üßπ Wyczyszczono ${removedCount} pustych/niewa≈ºnych zada≈Ñ magazynowych`);
    localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
  }
  
  return removedCount;
};

// Rƒôczne czyszczenie pustych zada≈Ñ z komunikatem
window.manualCleanupWarehouseTasks = function() {
  const beforeCount = (window.warehouseTasks || []).length;
  
  const removedCount = window.cleanupEmptyWarehouseTasks();
  
  if (removedCount > 0) {
    showToast(`üßπ Usuniƒôto ${removedCount} pustych zada≈Ñ`, 'success');
    
    // Od≈õwie≈º widok
    if (typeof window.renderWarehouseTasks === 'function') {
      window.renderWarehouseTasks();
    }
    if (typeof window.updateTasksBadge === 'function') {
      window.updateTasksBadge();
    }
    if (typeof renderActiveWarehousemanTasks === 'function') {
      renderActiveWarehousemanTasks();
    }
  } else {
    showToast('‚úÖ Brak pustych zada≈Ñ do usuniƒôcia', 'info');
  }
};

// Generuj automatyczne zadania dla zlecenia
window.generateWarehouseTasksForOrder = function(order) {
  if (!order || !order.id) return;
  
  const orderStartDate = order.startDate ? new Date(order.startDate) : null;
  const materialsNeeded = (order.materialChecklist || []).filter(m => 
    m && m.itemName && m.itemName.trim() !== '' && m.quantity > 0
  );
  
  if (materialsNeeded.length === 0) return;
  
  // Oblicz daty ostrze≈ºe≈Ñ (3 dni przed start produkcji)
  const warningDate = orderStartDate ? new Date(orderStartDate) : new Date();
  warningDate.setDate(warningDate.getDate() - 3);
  
  // Sprawd≈∫, czy materia≈Çy sƒÖ w magazynie
  materialsNeeded.forEach(material => {
    // Pomijaj puste materia≈Çy
    if (!material.itemName || material.itemName.trim() === '' || !material.quantity || material.quantity <= 0) {
      console.warn('‚ö†Ô∏è Pomijam pusty materia≈Ç w checkli≈õcie:', material);
      return;
    }
    
    const warehouseItem = (window.warehouseItems || []).find(w => w.id === material.itemId);
    const inStock = warehouseItem ? warehouseItem.quantity : 0;
    const needed = material.quantity || 0;
    
    if (inStock < needed) {
      // Brakuje materia≈Çu - utw√≥rz zadanie zam√≥wienia
      const task = {
        id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        type: 'order_material', // typ: order_material, receive_material, prepare_material, issue_material
        orderId: order.id,
        orderName: order.name,
        itemId: material.itemId,
        itemName: material.itemName,
        unit: material.unit || 'szt.',
        quantityNeeded: needed,
        quantityInStock: inStock,
        quantityToOrder: needed - inStock,
        status: 'pending', // pending, in_progress, completed, cancelled
        priority: 'normal', // normal, urgent
        dueDate: warningDate.toISOString(),
        createdAt: new Date().toISOString(),
        createdBy: 'System',
        assignedTo: 'Magazynier'
      };
      
      // Sprawd≈∫ czy nie ma ju≈º takiego zadania
      const existingTask = window.warehouseTasks.find(t => 
        t.orderId === order.id && 
        t.itemId === material.itemId && 
        t.type === 'order_material' && 
        t.status !== 'cancelled'
      );
      
      if (!existingTask) {
        window.warehouseTasks.push(task);
      }
    }
  });
  
  // Zapisz zadania
  localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
};

// Renderuj zadania magazyniera - NOWA WERSJA z grupowaniem po zleceniach
window.renderWarehouseTasks = function() {
  const list = document.getElementById('wh-tasks-list');
  if (!list) return;
  
  // Zapamiƒôtaj otwarte szczeg√≥≈Çy
  const openDetails = [];
  document.querySelectorAll('[id^="task-details-"]').forEach(el => {
    if (el.style.display !== 'none') {
      openDetails.push(el.id);
    }
  });
  
  const tasks = window.warehouseTasks || [];
  
  // üîç FILTRUJ zadania dla nieistniejƒÖcych zlece≈Ñ
  const existingOrderIds = new Set((state.orders || []).map(o => o.id));
  const validTasks = tasks.filter(t => {
    // Sprawd≈∫ czy zlecenie nadal istnieje
    if (!existingOrderIds.has(t.orderId)) {
      console.warn(`üóëÔ∏è Zadanie magazynowe ${t.id} odnosi siƒô do usuniƒôtego zlecenia ${t.orderId} - pomijam`);
      return false;
    }
    return t.status !== 'cancelled';
  });
  
  // üßπ Usu≈Ñ zadania dla nieistniejƒÖcych zlece≈Ñ z tablicy
  const tasksToRemove = tasks.filter(t => !existingOrderIds.has(t.orderId));
  if (tasksToRemove.length > 0) {
    console.log(`üßπ Usuwam ${tasksToRemove.length} zada≈Ñ magazynowych dla usuniƒôtych zlece≈Ñ`);
    window.warehouseTasks = tasks.filter(t => existingOrderIds.has(t.orderId));
    localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
    maybeAutoSave('cleanup-warehouse-tasks');
  }
  
  if (validTasks.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak zada≈Ñ dla magazyniera</div>';
    return;
  }
  
  // Grupuj zadania po zleceniach
  const grouped = {};
  validTasks.forEach(task => {
    if (!grouped[task.orderId]) {
      grouped[task.orderId] = {
        orderId: task.orderId,
        orderName: task.orderName,
        tasks: []
      };
    }
    grouped[task.orderId].tasks.push(task);
  });
  
  // Sortuj zlecenia: najpilniejsze zadania na g√≥rze
  const orderArray = Object.values(grouped).map(group => {
    const urgentCount = group.tasks.filter(t => t.priority === 'urgent' && t.status !== 'completed').length;
    const pendingCount = group.tasks.filter(t => t.status === 'pending').length;
    const inProgressCount = group.tasks.filter(t => t.status === 'in_progress').length;
    const completedCount = group.tasks.filter(t => t.status === 'completed').length;
    
    // Znajd≈∫ najpilniejszy termin
    const earliestDueDate = group.tasks
      .filter(t => t.status !== 'completed')
      .map(t => new Date(t.dueDate))
      .sort((a, b) => a - b)[0];
    
    return {
      ...group,
      urgentCount,
      pendingCount,
      inProgressCount,
      completedCount,
      earliestDueDate
    };
  }).sort((a, b) => {
    if (a.urgentCount !== b.urgentCount) return b.urgentCount - a.urgentCount;
    if (a.earliestDueDate && b.earliestDueDate) return a.earliestDueDate - b.earliestDueDate;
    return 0;
  });
  
  list.innerHTML = orderArray.map(group => {
    // Badge z liczbami
    let countBadge = '';
    if (group.urgentCount > 0) {
      countBadge = `<span style="background:#dc2626;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">‚ö†Ô∏è ${group.urgentCount} pilne</span>`;
    }
    if (group.inProgressCount > 0) {
      countBadge += `<span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">‚è≥ ${group.inProgressCount} w trakcie</span>`;
    }
    if (group.pendingCount > 0) {
      countBadge += `<span style="background:#6b7280;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">${group.pendingCount} oczekujƒÖce</span>`;
    }
    
    const borderColor = group.urgentCount > 0 ? '#dc2626' : '#3b82f6';
    
    // Sortuj zadania w ramach zlecenia
    const sortedTasks = group.tasks.sort((a, b) => {
      const isUrgentA = new Date(a.dueDate) < new Date();
      const isUrgentB = new Date(b.dueDate) < new Date();
      const statusOrder = { pending: 0, in_progress: 1, completed: 2 };
      
      if (isUrgentA !== isUrgentB) return isUrgentB - isUrgentA;
      if (a.status !== b.status) return statusOrder[a.status] - statusOrder[b.status];
      
      return new Date(a.dueDate) - new Date(b.dueDate);
    });
    
    const taskListHTML = sortedTasks.map(task => {
      const isUrgent = new Date(task.dueDate) < new Date();
      const isCompleted = task.status === 'completed';
      
      let statusBadge = '';
      let borderColor = '#e5e7eb';
      
      if (isCompleted) {
        statusBadge = `<span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px">‚úÖ Zako≈Ñczone</span>`;
      } else if (isUrgent) {
        statusBadge = `<span style="background:#dc2626;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px">‚ö†Ô∏è PILNE</span>`;
        borderColor = '#dc2626';
      } else if (task.status === 'in_progress') {
        statusBadge = `<span style="background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px">‚è≥ W trakcie</span>`;
      } else {
        statusBadge = `<span style="background:#6b7280;color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px">‚è∏Ô∏è OczekujƒÖce</span>`;
      }
      
      const dueDate = new Date(task.dueDate).toLocaleDateString('pl-PL', {
        year: 'numeric', month: '2-digit', day: '2-digit'
      });
      
      let taskIcon = 'üì¶';
      let taskTitle = '';
      let taskDescription = '';
      
      if (task.type === 'order_material') {
        taskIcon = 'üõí';
        taskTitle = `Zam√≥wiƒá materia≈Ç: ${task.itemName}`;
        taskDescription = `Brakuje: ${task.quantityToOrder} ${task.unit || 'szt.'}<br>W magazynie: ${task.quantityInStock} ${task.unit || 'szt.'}, Potrzeba: ${task.quantityNeeded} ${task.unit || 'szt.'}`;
      } else if (task.type === 'receive_material') {
        taskIcon = 'üì•';
        taskTitle = `PrzyjƒÖƒá dostawƒô: ${task.itemName}`;
        taskDescription = `Ilo≈õƒá: ${task.quantity} ${task.unit || 'szt.'}`;
      } else if (task.type === 'prepare_material') {
        taskIcon = 'üì¶';
        taskTitle = `Przygotowaƒá materia≈Çy`;
        taskDescription = `Wszystkie materia≈Çy dla zlecenia`;
      } else if (task.type === 'issue_material') {
        taskIcon = 'üì§';
        taskTitle = `Wydaƒá materia≈Ç: ${task.itemName}`;
        taskDescription = `Ilo≈õƒá: ${task.quantity} ${task.unit || 'szt.'}`;
      }
      
      return `
        <div style="background:#f9fafb;border-left:3px solid ${borderColor};padding:12px;margin-bottom:8px;border-radius:4px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
            <div style="flex:1">
              <div style="font-weight:600;font-size:14px;color:#1f2937">
                ${taskIcon} ${taskTitle}${statusBadge}
              </div>
              <div style="font-size:13px;color:#6b7280;margin-top:6px">
                ${taskDescription}
              </div>
              <div style="font-size:12px;color:#9ca3af;margin-top:6px">
                üìÖ Termin: ${dueDate}
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
              ${!isCompleted ? `
                <button class="btn small green" onclick="completeWarehouseTask('${task.id}')" style="width:100%;font-size:12px;padding:6px 10px">
                  ‚úÖ Zako≈Ñcz
                </button>
                <button class="btn small blue" onclick="startWarehouseTask('${task.id}')" style="width:100%;font-size:12px;padding:6px 10px">
                  ‚ñ∂Ô∏è Rozpocznij
                </button>
              ` : ''}
              <button class="btn small red" onclick="cancelWarehouseTask('${task.id}')" style="width:100%;font-size:12px;padding:6px 10px">
                ‚úï Anuluj
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    return `
      <div style="background:white;border:2px solid ${borderColor};border-radius:8px;padding:16px;margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div>
            <div style="font-weight:700;font-size:18px;color:#1f2937">
              üìã Zlecenie ${group.orderName}
              ${countBadge}
            </div>
            <div style="color:#6b7280;font-size:13px;margin-top:4px">
              ${group.tasks.length} zada≈Ñ (${group.completedCount} zako≈Ñczone)
            </div>
          </div>
          <button onclick="toggleTaskDetails('${group.orderId}')" 
                  id="task-toggle-${group.orderId}"
                  style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px">
            ‚ñº Szczeg√≥≈Çy
          </button>
        </div>
        <div id="task-details-${group.orderId}" style="display:none">
          ${taskListHTML}
        </div>
      </div>
    `;
  }).join('');
  
  // Przywr√≥ƒá stan otwartych szczeg√≥≈Ç√≥w
  requestAnimationFrame(() => {
    openDetails.forEach(detailsId => {
      const details = document.getElementById(detailsId);
      const toggleBtn = document.getElementById(detailsId.replace('task-details-', 'task-toggle-'));
      if (details && toggleBtn) {
        details.style.display = 'block';
        toggleBtn.textContent = '‚ñ≤ Ukryj';
      }
    });
  });
  
  // Aktualizuj badge z liczbƒÖ pilnych zada≈Ñ
  updateTasksBadge();
};

// Toggle szczeg√≥≈Ç√≥w zada≈Ñ dla zlecenia
window.toggleTaskDetails = function(orderId) {
  const details = document.getElementById(`task-details-${orderId}`);
  const toggleBtn = document.getElementById(`task-toggle-${orderId}`);
  
  if (!details || !toggleBtn) return;
  
  const isHidden = details.style.display === 'none';
  details.style.display = isHidden ? 'block' : 'none';
  toggleBtn.textContent = isHidden ? '‚ñ≤ Ukryj' : '‚ñº Szczeg√≥≈Çy';
};

// Aktualizuj badge z liczbƒÖ zada≈Ñ
window.updateTasksBadge = function() {
  const badge = document.getElementById('tasks-badge');
  if (!badge) return;
  
  const tasks = window.warehouseTasks || [];
  const urgentTasks = tasks.filter(t => {
    if (t.status === 'completed' || t.status === 'cancelled') return false;
    const isUrgent = new Date(t.dueDate) < new Date();
    return isUrgent;
  });
  
  if (urgentTasks.length > 0) {
    badge.textContent = urgentTasks.length;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
};

// Zako≈Ñcz zadanie
window.completeWarehouseTask = function(taskId) {
  const task = window.warehouseTasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (confirm(`Oznaczyƒá zadanie jako zako≈Ñczone?\n\n${task.itemName || 'Zadanie'}`)) {
    task.status = 'completed';
    task.completedAt = new Date().toISOString();
    
    localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
    alert(`‚úÖ Zadanie zako≈Ñczone`);
    
    window._keepDetailsOpen = true;
    renderWarehouseTasks();
    updateTasksBadge();
  }
};

// Rozpocznij zadanie
window.startWarehouseTask = function(taskId) {
  const task = window.warehouseTasks.find(t => t.id === taskId);
  if (!task) return;
  
  task.status = 'in_progress';
  task.startedAt = new Date().toISOString();
  
  localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
  alert(`‚ñ∂Ô∏è Zadanie rozpoczƒôte`);
  
  window._keepDetailsOpen = true;
  renderWarehouseTasks();
  updateTasksBadge();
};

// Anuluj zadanie
window.cancelWarehouseTask = function(taskId) {
  const task = window.warehouseTasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (confirm(`Anulowaƒá zadanie?\n\n${task.itemName || 'Zadanie'}`)) {
    task.status = 'cancelled';
    task.cancelledAt = new Date().toISOString();
    
    localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
    alert(`‚úï Zadanie anulowane`);
    
    window._keepDetailsOpen = true;
    renderWarehouseTasks();
    updateTasksBadge();
  }
};

// Filtruj zadania
window.filterWarehouseTasks = function(filter) {
  // TODO: implementacja filtrowania
  renderWarehouseTasks();
};

function useReservation(resId) {
  const res = window.warehouseReservations.find(r => r.id === resId);
  if (!res) return;

  if (confirm(`Oznaczyƒá jako wykorzystanƒÖ? To wyda ${res.quantity} ${res.unit} z magazynu.`)) {
    res.status = 'used';
    
    // Utw√≥rz transakcjƒô wydania
    const item = window.warehouseItems[res.itemId];
    if (item) {
      item.quantity -= res.quantity;
      
      const transaction = {
        id: generateId(),
        type: 'out',
        itemId: res.itemId,
        itemName: res.itemName,
        quantity: res.quantity,
        unit: res.unit,
        person: `Zlecenie: ${res.orderName}`,
        notes: `Wykorzystanie rezerwacji ${resId}`,
        date: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      if (!window.warehouseTransactions) {
        window.warehouseTransactions = [];
      }
      window.warehouseTransactions.push(transaction);
    }
    
    saveWarehouseToStorage();
    renderReservations();
    renderWarehouse();
  }
}

function cancelReservation(resId) {
  if (confirm('Anulowaƒá rezerwacjƒô?')) {
    const res = window.warehouseReservations.find(r => r.id === resId);
    if (res) {
      res.status = 'cancelled';
      saveWarehouseToStorage();
      renderReservations();
    }
  }
}

function deleteReservation(resId) {
  if (confirm('UsunƒÖƒá rezerwacjƒô?')) {
    window.warehouseReservations = window.warehouseReservations.filter(r => r.id !== resId);
    saveWarehouseToStorage();
    renderReservations();
  }
}

function autoReserveForOrders() {
  alert('Funkcja auto-rezerwacji w trakcie budowy. Bƒôdzie automatycznie rezerwowaƒá materia≈Çy na podstawie proces√≥w produkcyjnych przypisanych do zlece≈Ñ.');
}

// ===== SZABLONY MATERIA≈ÅOWE =====

function showTemplateModal(templateId = null) {
  const isEdit = templateId !== null;
  const template = isEdit ? window.materialTemplates.find(t => t.id === templateId) : null;
  
  const materialsHtml = (template?.materials || []).map((mat, idx) => {
    return `
      <div class="row" style="gap:8px;margin-bottom:8px;align-items:center" data-mat-idx="${idx}">
        <select class="template-mat-select" style="flex:2;padding:8px;border:1px solid #ccc;border-radius:4px">
          ${window.warehouseItems.map((item, itemIdx) => 
            `<option value="${itemIdx}" ${mat.itemId === itemIdx ? 'selected' : ''}>${item.name} (${item.unit})</option>`
          ).join('')}
        </select>
        <input type="number" class="template-mat-qty" value="${mat.quantity}" min="0.01" step="0.01" placeholder="Ilo≈õƒá" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px">
        <button class="btn red small" onclick="removeTemplateMaterial(${idx})">‚úï</button>
      </div>
    `;
  }).join('');

  const content = `
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: bold;">Nazwa szablonu:</label>
        <input type="text" id="template-modal-name" value="${template?.name || ''}" placeholder="np. Zestaw drzwi sosnowych" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Materia≈Çy:</label>
        <div id="template-materials-list">
          ${materialsHtml || '<div style="color:#999;text-align:center;padding:20px">Brak materia≈Ç√≥w. Kliknij "Dodaj materia≈Ç"</div>'}
        </div>
        <button class="btn blue small" onclick="addTemplateMaterial()" style="margin-top:8px">+ Dodaj materia≈Ç</button>
      </div>
    </div>
  `;

  showModal(isEdit ? '‚úèÔ∏è Edytuj szablon' : 'üìë Nowy szablon', content, [
    { text: 'Anuluj', action: () => {} },
    {
      text: isEdit ? 'Zapisz' : 'Utw√≥rz',
      action: () => {
        const name = document.getElementById('template-modal-name').value.trim();
        if (!name) {
          alert('Podaj nazwƒô szablonu');
          return;
        }

        // Zbierz materia≈Çy
        const materials = [];
        document.querySelectorAll('#template-materials-list > div[data-mat-idx]').forEach(row => {
          const select = row.querySelector('.template-mat-select');
          const qtyInput = row.querySelector('.template-mat-qty');
          const itemIdx = parseInt(select.value);
          const quantity = parseFloat(qtyInput.value);
          
          if (!isNaN(itemIdx) && !isNaN(quantity) && quantity > 0) {
            const item = window.warehouseItems[itemIdx];
            materials.push({
              itemId: item.id,  // ‚úÖ U≈ºywamy prawdziwego ID z magazynu, nie indeksu!
              itemName: item.name,
              quantity: quantity,
              unit: item.unit
            });
          }
        });

        if (materials.length === 0) {
          alert('Dodaj przynajmniej jeden materia≈Ç');
          return;
        }

        if (isEdit) {
          // Edycja
          const idx = window.materialTemplates.findIndex(t => t.id === templateId);
          window.materialTemplates[idx] = {
            id: templateId,
            name: name,
            materials: materials,
            updatedAt: Date.now()
          };
        } else {
          // Nowy
          window.materialTemplates.push({
            id: generateId(),
            name: name,
            materials: materials,
            createdAt: Date.now()
          });
        }

        saveWarehouseToStorage();
        renderTemplates();
        alert(`‚úÖ Szablon "${name}" zosta≈Ç ${isEdit ? 'zaktualizowany' : 'utworzony'}`);
      }
    }
  ]);
}

function addTemplateMaterial() {
  const list = document.getElementById('template-materials-list');
  if (!list) return;
  
  const emptyMsg = list.querySelector('div[style*="color:#999"]');
  if (emptyMsg) emptyMsg.remove();
  
  const newIdx = list.querySelectorAll('div[data-mat-idx]').length;
  const newRow = document.createElement('div');
  newRow.className = 'row';
  newRow.style = 'gap:8px;margin-bottom:8px;align-items:center';
  newRow.setAttribute('data-mat-idx', newIdx);
  newRow.innerHTML = `
    <select class="template-mat-select" style="flex:2;padding:8px;border:1px solid #ccc;border-radius:4px">
      ${window.warehouseItems.map((item, itemIdx) => 
        `<option value="${itemIdx}">${item.name} (${item.unit})</option>`
      ).join('')}
    </select>
    <input type="number" class="template-mat-qty" value="1" min="0.01" step="0.01" placeholder="Ilo≈õƒá" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px">
    <button class="btn red small" onclick="this.parentElement.remove()">‚úï</button>
  `;
  list.appendChild(newRow);
}

function removeTemplateMaterial(idx) {
  const row = document.querySelector(`#template-materials-list > div[data-mat-idx="${idx}"]`);
  if (row) row.remove();
}

function renderTemplates() {
  const list = document.getElementById('wh-templates-list');
  if (!list) return;

  const templates = window.materialTemplates || [];

  if (templates.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak szablon√≥w materia≈Çowych. Kliknij "Nowy szablon".</div>';
    return;
  }

  list.innerHTML = templates.map(tmpl => {
    const materials = tmpl.materials || [];
    const materialsCount = materials.length;
    
    // Wygeneruj checklistƒô materia≈Ç√≥w
    let checklistHtml = '';
    if (materialsCount === 0) {
      checklistHtml = '<div style="text-align:center;padding:20px;color:#94a3b8">Brak materia≈Ç√≥w</div>';
    } else {
      checklistHtml = materials.map((m, idx) => `
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #e2e8f0;background:white">
          <input type="checkbox" disabled style="cursor:not-allowed;width:16px;height:16px">
          <span style="flex:1;font-size:15px;color:#000000;font-weight:500">${m.itemName || 'Bez nazwy'}</span>
          <span style="font-size:14px;color:#475569;font-weight:600">${m.quantity || 0} ${m.unit || 'szt'}</span>
        </div>
      `).join('');
    }

    return `
      <div class="card" style="margin-bottom:8px">
        <div class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div style="flex:1">
            <div style="font-weight:600;margin-bottom:4px">ÔøΩ ${tmpl.name}</div>
            <div style="font-size:12px;color:#64748b">
              ${materialsCount} ${materialsCount === 1 ? 'pozycja' : materialsCount < 5 ? 'pozycje' : 'pozycji'} do sprawdzenia
            </div>
          </div>
          <div class="row" style="gap:4px">
            <button class="btn small" onclick="showTemplateModal('${tmpl.id}')">Edytuj</button>
            <button class="btn red small" onclick="deleteTemplate('${tmpl.id}')">Usu≈Ñ</button>
          </div>
        </div>
        <div style="background:#f8fafc;padding:12px;border-radius:4px;max-height:200px;overflow-y:auto">
          ${checklistHtml}
        </div>
      </div>
    `;
  }).join('');
}

function deleteTemplate(templateId) {
  const template = window.materialTemplates.find(t => t.id === templateId);
  if (!template) return;
  
  if (confirm(`UsunƒÖƒá szablon "${template.name}"?`)) {
    window.materialTemplates = window.materialTemplates.filter(t => t.id !== templateId);
    saveWarehouseToStorage();
    renderTemplates();
  }
}

// ===== KOMPLETACJA ZLECE≈É (PICKING) =====

window.pickingFilter = 'all'; // Filtr: all, pending, partial, ready, missing (dla starych widok√≥w)
window.warehouseWorkFilter = 'orders'; // Nowy filtr dla zunifikowanego widoku: orders, tasks, all

function filterPickingOrders(filter) {
  window.pickingFilter = filter;
  if (typeof renderPickingOrders === 'function') {
    renderPickingOrders();
  }
}

// ========== ZUNIFIKOWANY WIDOK PRACY MAGAZYNIERA ==========
function renderWarehouseWork() {
  const list = document.getElementById('wh-work-list');
  if (!list) return;
  
  const filterType = window.warehouseWorkFilter || 'orders';
  
  // Renderuj odpowiedni widok
  if (filterType === 'orders') {
    renderWarehouseWorkOrders(list);
  } else if (filterType === 'tasks') {
    renderWarehouseWorkTasks(list);
  } else { // 'all'
    renderWarehouseWorkAll(list);
  }
  
  updateWarehouseWorkBadge();
}

// Renderuj TYLKO zlecenia do kompletacji
function renderWarehouseWorkOrders(list) {
  const orders = (state.orders || []).filter(o => {
    return o.processId && o.status !== 'completed' && o.status !== 'cancelled';
  });
  
  if (orders.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak zlece≈Ñ do skompletowania</div>';
    return;
  }
  
  const ordersWithChecklist = orders.map(order => {
    const process = (state.processes || []).find(p => p.id === order.processId);
    if (!process || !process.materialTemplateId) return null;
    
    const template = (window.materialTemplates || []).find(t => t.id === process.materialTemplateId);
    if (!template) return null;
    
    if (!order.materialChecklist) {
      order.materialChecklist = template.materials.map(m => ({
        itemId: m.itemId,
        itemName: m.itemName,
        quantity: m.quantity,
        unit: m.unit,
        checked: false,
        checkedAt: null,
        checkedBy: null
      }));
      save();
    }
    
    const checkedCount = order.materialChecklist.filter(i => i.checked).length;
    const totalCount = order.materialChecklist.length;
    const progress = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
    
    let missingCount = 0;
    order.materialChecklist.forEach(item => {
      const warehouseItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
      if (!warehouseItem || warehouseItem.quantity < item.quantity) {
        missingCount++;
      }
    });
    
    return {
      order,
      checkedCount,
      totalCount,
      progress,
      missingCount,
      status: missingCount > 0 ? 'missing' : 
              progress === 100 ? 'ready' : 
              progress > 0 ? 'partial' : 'pending'
    };
  }).filter(Boolean);
  
  ordersWithChecklist.sort((a, b) => {
    if (a.status === 'missing' && b.status !== 'missing') return -1;
    if (a.status !== 'missing' && b.status === 'missing') return 1;
    if (a.status === 'ready' && b.status !== 'ready') return -1;
    if (a.status !== 'ready' && b.status === 'ready') return 1;
    return new Date(a.order.deadline) - new Date(b.order.deadline);
  });
  
  list.innerHTML = ordersWithChecklist.map(({ order, checkedCount, totalCount, progress, missingCount, status }) => {
    const statusBadge = status === 'ready' ? '<span style="background:#16a34a;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚úÖ Gotowe</span>' :
      status === 'partial' ? '<span style="background:#3b82f6;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">üì¶ W trakcie</span>' :
      status === 'missing' ? '<span style="background:#dc2626;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚ö†Ô∏è Braki</span>' :
      '<span style="background:#6b7280;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚è≥ Do zrobienia</span>';
    
    const borderColor = status === 'missing' ? '#dc2626' : status === 'ready' ? '#16a34a' : status === 'partial' ? '#3b82f6' : '#cbd5e1';
    const isExpanded = document.getElementById(`work-order-${order.id}`)?.style.display !== 'none';
    
    return `
      <div class="card" style="margin-bottom:12px;border-left:4px solid ${borderColor}">
        <div onclick="toggleWorkOrder('${order.id}')" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:4px 0">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
              <span style="font-size:20px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
              <div>
                <div style="font-weight:700;font-size:18px;color:#ffffff;background:#0f172a;padding:6px 12px;border-radius:6px;display:inline-block">${order.name}</div>
                <div style="font-size:14px;color:#64748b;margin-top:6px">
                  Klient: ${order.client || 'Brak'} | Termin: ${order.deadline ? new Date(order.deadline).toLocaleDateString('pl-PL') : 'Brak'}
                </div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:16px;margin-top:8px">
              ${statusBadge}
              <div style="flex:1;background:#e2e8f0;border-radius:8px;height:8px;max-width:200px">
                <div style="background:${status === 'ready' ? '#16a34a' : status === 'partial' ? '#3b82f6' : '#cbd5e1'};height:100%;border-radius:8px;width:${progress}%;transition:width 0.3s"></div>
              </div>
              <span style="font-size:14px;font-weight:600;color:#475569">${checkedCount}/${totalCount} (${progress}%)</span>
              ${missingCount > 0 ? `<span style="color:#dc2626;font-size:14px;font-weight:600">‚ö†Ô∏è ${missingCount} brak√≥w</span>` : ''}
            </div>
          </div>
        </div>
        
        <div id="work-order-${order.id}" style="display:${isExpanded ? 'block' : 'none'};margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0">
          ${renderPickingChecklist(order)}
          <div class="row" style="gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0">
            <button class="btn green" onclick="issueToProduction('${order.id}')" ${status !== 'ready' ? 'disabled' : ''} style="${status !== 'ready' ? 'opacity:0.5;cursor:not-allowed' : ''}">
              üì§ Wydaj na produkcjƒô
            </button>
            <button class="btn" onclick="window.showMaterialChecklist('${order.id}', { readOnly: false, source: 'warehouse' })">
              üëÅÔ∏è PodglƒÖd pe≈Çny
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Renderuj TYLKO dodatkowe zadania
function renderWarehouseWorkTasks(list) {
  const tasks = window.warehouseTasks || [];
  const existingOrderIds = new Set((state.orders || []).map(o => o.id));
  const validTasks = tasks.filter(t => existingOrderIds.has(t.orderId) && t.status !== 'cancelled');
  
  if (validTasks.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak dodatkowych zada≈Ñ magazynowych</div>';
    return;
  }
  
  const grouped = {};
  validTasks.forEach(task => {
    if (!grouped[task.orderId]) {
      grouped[task.orderId] = {
        orderId: task.orderId,
        orderName: task.orderName,
        tasks: []
      };
    }
    grouped[task.orderId].tasks.push(task);
  });
  
  const orderArray = Object.values(grouped).map(group => {
    const urgentCount = group.tasks.filter(t => t.priority === 'urgent' && t.status !== 'completed').length;
    const pendingCount = group.tasks.filter(t => t.status === 'pending').length;
    const inProgressCount = group.tasks.filter(t => t.status === 'in_progress').length;
    
    return { ...group, urgentCount, pendingCount, inProgressCount };
  }).sort((a, b) => b.urgentCount - a.urgentCount);
  
  list.innerHTML = orderArray.map(group => {
    let countBadge = '';
    if (group.urgentCount > 0) {
      countBadge = `<span style="background:#dc2626;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">‚ö†Ô∏è ${group.urgentCount} pilne</span>`;
    }
    if (group.inProgressCount > 0) {
      countBadge += `<span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">‚è≥ ${group.inProgressCount} w trakcie</span>`;
    }
    if (group.pendingCount > 0) {
      countBadge += `<span style="background:#6b7280;color:white;padding:4px 8px;border-radius:6px;font-size:13px;margin-left:8px">${group.pendingCount} oczekujƒÖce</span>`;
    }
    
    const borderColor = group.urgentCount > 0 ? '#dc2626' : '#3b82f6';
    const isExpanded = document.getElementById(`work-task-group-${group.orderId}`)?.style.display !== 'none';
    
    return `
      <div class="card" style="margin-bottom:12px;border-left:4px solid ${borderColor}">
        <div onclick="toggleWorkTaskGroup('${group.orderId}')" style="cursor:pointer">
          <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:18px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
            <div style="flex:1">
              <div style="font-weight:700;font-size:16px;color:#0f172a">${group.orderName}</div>
              <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
                <span style="font-size:13px;color:#64748b">Zada≈Ñ: ${group.tasks.length}</span>
                ${countBadge}
              </div>
            </div>
          </div>
        </div>
        
        <div id="work-task-group-${group.orderId}" style="display:${isExpanded ? 'block' : 'none'};margin-top:12px">
          ${group.tasks.map(task => {
            const statusStyle = task.status === 'completed' ? 'background:#dcfce7;border-left:3px solid #16a34a' :
              task.status === 'in_progress' ? 'background:#dbeafe;border-left:3px solid #3b82f6' :
              'background:#f8fafc;border-left:3px solid #cbd5e1';
            
            return `
              <div style="padding:12px;margin-bottom:8px;${statusStyle};border-radius:6px">
                <div style="display:flex;justify-content:space-between;align-items:start">
                  <div style="flex:1">
                    <div style="font-weight:600;font-size:14px;color:#0f172a">${task.title}</div>
                    <div style="font-size:13px;color:#64748b;margin-top:4px">${task.description || ''}</div>
                    <div style="font-size:12px;color:#94a3b8;margin-top:6px">
                      üë§ ${task.assignedTo || 'Nie przypisano'} | 
                      üìÖ ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('pl-PL') : 'Brak terminu'}
                    </div>
                  </div>
                  <div style="display:flex;gap:6px">
                    ${task.status !== 'completed' ? `<button class="btn green" style="padding:6px 12px;font-size:13px" onclick="updateTaskStatus('${task.id}', 'completed')">‚úì</button>` : ''}
                    <button class="btn" style="padding:6px 12px;font-size:13px" onclick="editWarehouseTask('${task.id}')">‚úé</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
}

// Renderuj OBA widoki razem
function renderWarehouseWorkAll(list) {
  list.innerHTML = `
    <div style="margin-bottom:24px">
      <h3 style="font-size:18px;font-weight:700;color:white;margin-bottom:12px;padding:8px 0;border-bottom:2px solid #3b82f6">üì¶ Zlecenia do kompletacji</h3>
      <div id="work-orders-section"></div>
    </div>
  `;
  
  const ordersSection = document.getElementById('work-orders-section');
  
  if (ordersSection) renderWarehouseWorkOrders(ordersSection);
  // Zadania magazynowe sƒÖ wy≈õwietlane w osobnej sekcji active-warehouseman-tasks-section
}

// Toggle dla widoku zlece≈Ñ
function toggleWorkOrder(orderId) {
  const el = document.getElementById(`work-order-${orderId}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    renderWarehouseWork(); // Od≈õwie≈º strza≈Çkƒô
  }
}

// Toggle dla grupy zada≈Ñ
function toggleWorkTaskGroup(orderId) {
  const el = document.getElementById(`work-task-group-${orderId}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    renderWarehouseWork(); // Od≈õwie≈º strza≈Çkƒô
  }
}

// Filtry dla zunifikowanego widoku
function filterWarehouseWork(type) {
  window.warehouseWorkFilter = type;
  renderWarehouseWork();
  
  // Od≈õwie≈º listƒô zada≈Ñ magazynowych (jest niezale≈ºna od filtr√≥w)
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
}

// Kombinowany badge
function updateWarehouseWorkBadge() {
  const badge = document.getElementById('work-badge');
  if (!badge) return;
  
  // Zlicz zlecenia do skompletowania
  const orders = (state.orders || []).filter(o => {
    return o.processId && o.status !== 'completed' && o.status !== 'cancelled';
  });
  let pendingOrdersCount = 0;
  orders.forEach(order => {
    if (!order.materialChecklist) pendingOrdersCount++;
    else {
      const checkedCount = order.materialChecklist.filter(i => i.checked).length;
      if (checkedCount < order.materialChecklist.length) pendingOrdersCount++;
    }
  });
  
  // Zlicz zadania do wykonania
  const tasks = window.warehouseTasks || [];
  const pendingTasksCount = tasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length;
  
  const total = pendingOrdersCount + pendingTasksCount;
  
  if (total > 0) {
    badge.textContent = total;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Funkcje obs≈Çugi zada≈Ñ magazynowych dla zunifikowanego widoku
function updateTaskStatus(taskId, newStatus) {
  const task = (window.warehouseTasks || []).find(t => t.id === taskId);
  if (!task) {
    alert('Nie znaleziono zadania');
    return;
  }
  
  task.status = newStatus;
  
  if (newStatus === 'completed') {
    task.completedAt = new Date().toISOString();
    task.completedBy = activeWarehousemanId || 'system';
  } else if (newStatus === 'in_progress') {
    task.startedAt = new Date().toISOString();
    task.startedBy = activeWarehousemanId || 'system';
  }
  
  localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
  saveWarehouseToStorage();
  
  renderWarehouseWork();
  updateActiveWarehousemanDisplay();
  
  // Od≈õwie≈º listƒô zada≈Ñ
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
  
  // Zaktualizuj badge
  if (typeof window.updateTasksBadge === 'function') {
    updateTasksBadge();
  }
  if (typeof window.updateWarehouseWorkBadge === 'function') {
    updateWarehouseWorkBadge();
  }
}

function deleteWarehouseTask(taskId) {
  console.log('[deleteWarehouseTask] Attempting to delete task:', taskId);
  console.log('[deleteWarehouseTask] All tasks:', window.warehouseTasks);
  console.log('[deleteWarehouseTask] Task IDs:', (window.warehouseTasks || []).map(t => t.id));
  
  const task = (window.warehouseTasks || []).find(t => t.id === taskId);
  if (!task) {
    console.error('[deleteWarehouseTask] Task not found!');
    alert('Nie znaleziono zadania');
    return;
  }
  
  console.log('[deleteWarehouseTask] Found task:', task);
  
  if (!confirm(`Czy na pewno usunƒÖƒá zadanie:\n\n"${task.title}"?\n\nTej operacji nie mo≈ºna cofnƒÖƒá.`)) {
    return;
  }
  
  window.warehouseTasks = window.warehouseTasks.filter(t => t.id !== taskId);
  
  localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
  saveWarehouseToStorage();
  
  renderWarehouseWork();
  
  // Od≈õwie≈º listƒô zada≈Ñ
  if (typeof renderActiveWarehousemanTasks === 'function') {
    renderActiveWarehousemanTasks();
  }
  updateActiveWarehousemanDisplay();
  
  alert('‚úÖ Zadanie zosta≈Ço usuniƒôte');
}

function editWarehouseTask(taskId) {
  const task = (window.warehouseTasks || []).find(t => t.id === taskId);
  if (!task) {
    alert('Nie znaleziono zadania');
    return;
  }
  
  const newTitle = prompt('Tytu≈Ç zadania:', task.title);
  if (!newTitle || !newTitle.trim()) return;
  
  const newDescription = prompt('Opis zadania:', task.description || '');
  
  task.title = newTitle.trim();
  task.description = newDescription ? newDescription.trim() : '';
  task.updatedAt = new Date().toISOString();
  
  localStorage.setItem('warehouseTasks', JSON.stringify(window.warehouseTasks));
  save();
  maybeAutoSave('edit-task');
  
  renderWarehouseWork();
}

window.renderWarehouseWork = renderWarehouseWork;
window.filterWarehouseWork = filterWarehouseWork;
window.toggleWorkOrder = toggleWorkOrder;
window.toggleWorkTaskGroup = toggleWorkTaskGroup;
window.updateWarehouseWorkBadge = updateWarehouseWorkBadge;
window.updateTaskStatus = updateTaskStatus;
window.editWarehouseTask = editWarehouseTask;

// ========== OBCIƒÑ≈ªENIA MAGAZYNU I ZAM√ìWIENIA ==========

window.obligationsFilter = 'all'; // Filtr: all, negative, low, ok

function filterObligations(filter) {
  window.obligationsFilter = filter;
  renderWarehouseObligations();
}

// Oblicz rzeczywiste stany magazynowe z uwzglƒôdnieniem obciƒÖ≈ºe≈Ñ ze zlece≈Ñ
function calculateWarehouseObligations() {
  const obligations = {};
  
  // Pobierz aktualne stany magazynowe
  (window.warehouseItems || []).forEach(item => {
    // U≈ºywamy ID jako klucza dla jednoznaczno≈õci
    const key = item.id || item.name;
    obligations[key] = {
      itemId: item.id, // Dodajemy ID do obiektu
      name: item.name,
      unit: item.unit,
      currentStock: item.quantity || 0,
      reserved: 0,
      available: item.quantity || 0,
      orders: [],
      minStock: item.minStock || 0
    };
  });
  
  // Oblicz obciƒÖ≈ºenia z aktywnych zlece≈Ñ
  const activeOrders = (state.orders || []).filter(o => 
    o.status !== 'completed' && 
    o.status !== 'cancelled' && 
    !o.materialsIssued && 
    o.materialChecklist && 
    o.materialChecklist.length > 0
  );
  
  activeOrders.forEach(order => {
    (order.materialChecklist || []).forEach(item => {
      // Pr√≥bujemy znale≈∫ƒá po ID, potem po nazwie (fallback)
      let obligation = null;
      
      if (item.itemId && obligations[item.itemId]) {
        obligation = obligations[item.itemId];
      } else if (item.itemName) {
        // Fallback: szukamy po nazwie w warehouseItems, aby znale≈∫ƒá ID
        const whItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
        if (whItem && obligations[whItem.id]) {
          obligation = obligations[whItem.id];
        } else if (obligations[item.itemName]) {
           // Ostatnia deska ratunku: bezpo≈õrednie dopasowanie nazwy (dla starych danych)
           obligation = obligations[item.itemName];
        }
      }
      
      if (!obligation) return;
      
      obligation.reserved += item.quantity;
      obligation.available -= item.quantity;
      obligation.orders.push({
        orderId: order.id,
        orderName: order.name,
        quantity: item.quantity,
        deadline: order.deadline,
        checked: item.checked || false
      });
    });
  });
  
  return Object.values(obligations);
}

function renderWarehouseObligations() {
  const list = document.getElementById('obligations-list');
  const summary = document.getElementById('obligations-summary');
  if (!list || !summary) return;
  
  const obligations = calculateWarehouseObligations();
  
  if (obligations.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak obciƒÖ≈ºe≈Ñ magazynowych</div>';
    summary.innerHTML = '';
    return;
  }
  
  // Statystyki
  const negative = obligations.filter(o => o.available < 0);
  const low = obligations.filter(o => o.available >= 0 && o.available < o.minStock);
  const ok = obligations.filter(o => o.available >= o.minStock);
  
  // Podsumowanie
  summary.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
      <div class="card" style="background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9">‚ö†Ô∏è Stany ujemne</div>
        <div style="font-size:32px;font-weight:700">${negative.length}</div>
        <div style="font-size:12px;opacity:0.8;margin-top:4px">WymagajƒÖ zam√≥wienia</div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9">üìâ Niskie stany</div>
        <div style="font-size:32px;font-weight:700">${low.length}</div>
        <div style="font-size:12px;opacity:0.8;margin-top:4px">Poni≈ºej minimum</div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,#16a34a 0%,#15803d 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9">‚úÖ Stan OK</div>
        <div style="font-size:32px;font-weight:700">${ok.length}</div>
        <div style="font-size:12px;opacity:0.8;margin-top:4px">WystarczajƒÖce zapasy</div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;padding:16px">
        <div style="font-size:13px;opacity:0.9">üìä ≈ÅƒÖcznie pozycji</div>
        <div style="font-size:32px;font-weight:700">${obligations.length}</div>
        <div style="font-size:12px;opacity:0.8;margin-top:4px">Wszystkie materia≈Çy</div>
      </div>
    </div>
  `;
  
  // Filtruj wed≈Çug wybranego filtru
  let filtered = obligations;
  if (window.obligationsFilter === 'negative') {
    filtered = negative;
  } else if (window.obligationsFilter === 'low') {
    filtered = low;
  } else if (window.obligationsFilter === 'ok') {
    filtered = ok;
  }
  
  if (filtered.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak pozycji w tej kategorii</div>';
    return;
  }
  
  // Sortuj: najpierw ujemne, potem niskie, potem OK
  filtered.sort((a, b) => {
    if (a.available < 0 && b.available >= 0) return -1;
    if (a.available >= 0 && b.available < 0) return 1;
    if (a.available < 0 && b.available < 0) return a.available - b.available;
    return a.available - b.available;
  });
  
  list.innerHTML = filtered.map(item => {
    const isNegative = item.available < 0;
    const isLow = !isNegative && item.available < item.minStock;
    const statusColor = isNegative ? '#dc2626' : isLow ? '#f59e0b' : '#16a34a';
    const statusBg = isNegative ? '#fef2f2' : isLow ? '#fffbeb' : '#f0fdf4';
    const statusIcon = isNegative ? '‚ö†Ô∏è' : isLow ? 'üìâ' : '‚úÖ';
    const statusText = isNegative ? 'BRAK - ZAM√ìW!' : isLow ? 'Niski stan' : 'OK';
    
    const isExpanded = document.getElementById(`obligation-${item.name.replace(/\s+/g, '-')}`)?.style.display !== 'none';
    
    return `
      <div class="card" style="margin-bottom:12px;border-left:4px solid ${statusColor};background:${statusBg}">
        <div onclick="toggleObligation('${item.name.replace(/\s+/g, '-')}')" style="cursor:pointer">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <span style="font-size:18px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                <div style="flex:1">
                  <div style="font-weight:700;font-size:16px;color:#0f172a">${item.name}</div>
                  <div style="font-size:13px;color:#64748b;margin-top:4px">
                    Stan magazynowy: <strong style="color:${item.currentStock < 0 ? '#dc2626' : '#0f172a'}">${item.currentStock} ${item.unit}</strong> | 
                    Zarezerwowane: <strong>${item.reserved} ${item.unit}</strong> | 
                    Dostƒôpne: <strong style="color:${statusColor};font-size:15px">${item.available} ${item.unit}</strong>
                  </div>
                </div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="background:${statusColor};color:white;padding:6px 12px;border-radius:6px;font-size:13px;font-weight:600;white-space:nowrap">
                ${statusIcon} ${statusText}
              </div>
              ${isNegative ? `<div style="margin-top:6px;font-size:12px;color:#dc2626;font-weight:600">Brakuje: ${Math.abs(item.available)} ${item.unit}</div>` : ''}
            </div>
          </div>
        </div>
        
        <div id="obligation-${item.name.replace(/\s+/g, '-')}" style="display:${isExpanded ? 'block' : 'none'};margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0">
          <div style="font-weight:600;font-size:14px;color:#0f172a;margin-bottom:12px">üìã ObciƒÖ≈ºenia ze zlece≈Ñ:</div>
          ${item.orders.map(order => `
            <div style="padding:10px;margin-bottom:8px;background:white;border-radius:6px;border-left:3px solid ${order.checked ? '#16a34a' : '#3b82f6'}">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="flex:1">
                  <div style="font-weight:600;font-size:14px;color:#0f172a">${order.orderName}</div>
                  <div style="font-size:12px;color:#64748b;margin-top:4px">
                    Ilo≈õƒá: <strong>${order.quantity} ${item.unit}</strong> | 
                    Termin: ${order.deadline ? new Date(order.deadline).toLocaleDateString('pl-PL') : 'Brak'}
                  </div>
                </div>
                <div>
                  ${order.checked ? '<span style="color:#16a34a;font-size:20px">‚úì</span>' : '<span style="color:#94a3b8;font-size:20px">‚óã</span>'}
                </div>
              </div>
            </div>
          `).join('')}
          
          ${isNegative || isLow ? `
            <div style="margin-top:16px;padding:12px;background:#fffbeb;border:1px solid #fbbf24;border-radius:6px">
              <div style="font-weight:600;font-size:13px;color:#92400e;margin-bottom:8px">üí° Zalecana akcja:</div>
              <div style="font-size:13px;color:#78350f">
                ${isNegative ? 
                  `Natychmiast zam√≥w minimum <strong>${Math.abs(item.available) + (item.minStock || 10)} ${item.unit}</strong> (brak + zapas)` : 
                  `Uzupe≈Çnij do poziomu minimum: <strong>${item.minStock - item.available} ${item.unit}</strong>`
                }
              </div>
              <button class="btn orange" onclick="createOrderProposal('${item.name}', ${Math.abs(item.available) + (item.minStock || 10)})" style="margin-top:8px;font-size:13px">
                üìù Utw√≥rz propozycjƒô zam√≥wienia
              </button>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  updateObligationsBadge();
}

function toggleObligation(itemKey) {
  const el = document.getElementById(`obligation-${itemKey}`);
  if (el) {
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    renderWarehouseObligations(); // Od≈õwie≈º strza≈Çkƒô
  }
}

function updateObligationsBadge() {
  const badge = document.getElementById('obligations-badge');
  if (!badge) return;
  
  const obligations = calculateWarehouseObligations();
  const negative = obligations.filter(o => o.available < 0).length;
  
  if (negative > 0) {
    badge.textContent = negative;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

function generateOrderProposals() {
  const obligations = calculateWarehouseObligations();
  const toOrder = obligations.filter(o => o.available < 0 || o.available < o.minStock);
  
  if (toOrder.length === 0) {
    alert('‚úÖ Wszystkie pozycje majƒÖ wystarczajƒÖce stany magazynowe!');
    return;
  }
  
  let proposal = 'üìã PROPOZYCJE ZAM√ìWIE≈É\n\n';
  proposal += `Data wygenerowania: ${new Date().toLocaleString('pl-PL')}\n\n`;
  proposal += '‚ïê'.repeat(50) + '\n\n';
  
  toOrder.forEach((item, idx) => {
    const orderQuantity = item.available < 0 ? 
      Math.abs(item.available) + (item.minStock || 10) : 
      item.minStock - item.available;
    
    proposal += `${idx + 1}. ${item.name}\n`;
    proposal += `   Stan: ${item.available} ${item.unit} ${item.available < 0 ? '‚ö†Ô∏è UJEMNY' : 'üìâ Niski'}\n`;
    proposal += `   Zalecane zam√≥wienie: ${Math.ceil(orderQuantity)} ${item.unit}\n`;
    proposal += `   Zarezerwowane w zleceniach: ${item.reserved} ${item.unit}\n`;
    proposal += `   Zlecenia: ${item.orders.map(o => o.orderName).join(', ')}\n`;
    proposal += '\n';
  });
  
  proposal += '‚ïê'.repeat(50) + '\n';
  proposal += `\n≈ÅƒÖcznie pozycji do zam√≥wienia: ${toOrder.length}\n`;
  
  // Poka≈º w oknie modalnym
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center';
  modal.innerHTML = `
    <div style="background:white;padding:24px;border-radius:12px;max-width:800px;max-height:80vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <h2 style="margin:0 0 16px 0;color:#0f172a">üìã Propozycje zam√≥wie≈Ñ</h2>
      <pre style="background:#f8fafc;padding:16px;border-radius:8px;font-size:13px;line-height:1.6;overflow:auto;max-height:400px;color:#000000">${proposal}</pre>
      <div style="display:flex;gap:12px;margin-top:16px">
        <button class="btn blue" onclick="navigator.clipboard.writeText(\`${proposal.replace(/`/g, '\\`')}\`); alert('‚úÖ Skopiowano do schowka!')">üìã Kopiuj do schowka</button>
        <button class="btn green" onclick="downloadOrderProposal(\`${proposal.replace(/`/g, '\\`')}\`)">üíæ Pobierz jako TXT</button>
        <button class="btn" onclick="this.closest('div').parentElement.parentElement.remove()" style="margin-left:auto">Zamknij</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function createOrderProposal(itemName, quantity) {
  const proposal = `üìù Propozycja zam√≥wienia:\n\nMateria≈Ç: ${itemName}\nIlo≈õƒá: ${Math.ceil(quantity)}\nData: ${new Date().toLocaleString('pl-PL')}`;
  
  if (confirm(proposal + '\n\nSkopiowaƒá do schowka?')) {
    navigator.clipboard.writeText(proposal);
    alert('‚úÖ Skopiowano do schowka!');
  }
}

function downloadOrderProposal(text) {
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `propozycje-zamowien-${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

window.renderWarehouseObligations = renderWarehouseObligations;
window.filterObligations = filterObligations;
window.toggleObligation = toggleObligation;
window.updateObligationsBadge = updateObligationsBadge;
window.generateOrderProposals = generateOrderProposals;
window.createOrderProposal = createOrderProposal;
window.downloadOrderProposal = downloadOrderProposal;
window.calculateWarehouseObligations = calculateWarehouseObligations;

// ========== STARE FUNKCJE (zachowane dla kompatybilno≈õci) ==========
function renderPickingOrders() {
  const list = document.getElementById('wh-picking-list');
  if (!list) return;
  
  // Pobierz aktywne zlecenia z przypisanym procesem
  const orders = (state.orders || []).filter(o => {
    return o.processId && o.status !== 'completed' && o.status !== 'cancelled';
  });
  
  if (orders.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak zlece≈Ñ do skompletowania</div>';
    return;
  }
  
  // Dla ka≈ºdego zlecenia pobierz checklistƒô materia≈Ç√≥w
  const ordersWithChecklist = orders.map(order => {
    const process = (state.processes || []).find(p => p.id === order.processId);
    if (!process || !process.materialTemplateId) return null;
    
    const template = (window.materialTemplates || []).find(t => t.id === process.materialTemplateId);
    if (!template) return null;
    
    // Inicjalizuj checklistƒô je≈õli nie istnieje
    if (!order.materialChecklist) {
      order.materialChecklist = template.materials.map(m => ({
        itemId: m.itemId,
        itemName: m.itemName,
        quantity: m.quantity,
        unit: m.unit,
        checked: false,
        checkedAt: null,
        checkedBy: null
      }));
      save();
    }
    
    // Oblicz statystyki
    const checkedCount = order.materialChecklist.filter(i => i.checked).length;
    const totalCount = order.materialChecklist.length;
    const progress = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
    
    // Sprawd≈∫ dostƒôpno≈õƒá w magazynie
    let missingCount = 0;
    order.materialChecklist.forEach(item => {
      const warehouseItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
      if (!warehouseItem || warehouseItem.quantity < item.quantity) {
        missingCount++;
      }
    });
    
    return {
      order,
      checkedCount,
      totalCount,
      progress,
      missingCount,
      status: missingCount > 0 ? 'missing' : 
              progress === 100 ? 'ready' : 
              progress > 0 ? 'partial' : 'pending'
    };
  }).filter(Boolean);
  
  // Filtruj wed≈Çug wybranego statusu
  let filtered = ordersWithChecklist;
  if (window.pickingFilter !== 'all') {
    filtered = ordersWithChecklist.filter(o => o.status === window.pickingFilter);
  }
  
  if (filtered.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Brak zlece≈Ñ w tej kategorii</div>';
    return;
  }
  
  // Sortuj: najpilniejsze na g√≥rze
  filtered.sort((a, b) => {
    if (a.status === 'missing' && b.status !== 'missing') return -1;
    if (a.status !== 'missing' && b.status === 'missing') return 1;
    if (a.status === 'ready' && b.status !== 'ready') return -1;
    if (a.status !== 'ready' && b.status === 'ready') return 1;
    return new Date(a.order.deadline) - new Date(b.order.deadline);
  });
  
  list.innerHTML = filtered.map(({ order, checkedCount, totalCount, progress, missingCount, status }) => {
    const statusBadge = status === 'ready' ? '<span style="background:#16a34a;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚úÖ Gotowe</span>' :
      status === 'partial' ? '<span style="background:#3b82f6;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">üì¶ W trakcie</span>' :
      status === 'missing' ? '<span style="background:#dc2626;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚ö†Ô∏è Braki</span>' :
      '<span style="background:#6b7280;color:white;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:600">‚è≥ Do zrobienia</span>';
    
    const borderColor = status === 'missing' ? '#dc2626' : status === 'ready' ? '#16a34a' : status === 'partial' ? '#3b82f6' : '#cbd5e1';
    const isExpanded = document.getElementById(`picking-${order.id}`)?.style.display !== 'none';
    
    return `
      <div class="card" style="margin-bottom:12px;border-left:4px solid ${borderColor}">
        <div onclick="togglePickingOrder('${order.id}')" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:4px 0">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
              <span style="font-size:20px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
              <div>
                <div style="font-weight:700;font-size:18px;color:#ffffff;background:#0f172a;padding:6px 12px;border-radius:6px;display:inline-block">${order.name}</div>
                <div style="font-size:14px;color:#64748b;margin-top:6px">
                  Klient: ${order.client || 'Brak'} | Termin: ${order.deadline ? new Date(order.deadline).toLocaleDateString('pl-PL') : 'Brak'}
                </div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:16px;margin-top:8px">
              ${statusBadge}
              <div style="flex:1;background:#e2e8f0;border-radius:8px;height:8px;max-width:200px">
                <div style="background:${status === 'ready' ? '#16a34a' : status === 'partial' ? '#3b82f6' : '#cbd5e1'};height:100%;border-radius:8px;width:${progress}%;transition:width 0.3s"></div>
              </div>
              <span style="font-size:14px;font-weight:600;color:#475569">${checkedCount}/${totalCount} (${progress}%)</span>
              ${missingCount > 0 ? `<span style="color:#dc2626;font-size:14px;font-weight:600">‚ö†Ô∏è ${missingCount} brak√≥w</span>` : ''}
            </div>
          </div>
        </div>
        
        <div id="picking-${order.id}" style="display:${isExpanded ? 'block' : 'none'};margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0">
          ${renderPickingChecklist(order)}
          <div class="row" style="gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0">
            <button class="btn green" onclick="issueToProduction('${order.id}')" ${status !== 'ready' ? 'disabled' : ''} style="${status !== 'ready' ? 'opacity:0.5;cursor:not-allowed' : ''}">
              üì§ Wydaj na produkcjƒô
            </button>
            <button class="btn" onclick="window.showMaterialChecklist('${order.id}', { readOnly: false, source: 'warehouse' })">
              üëÅÔ∏è PodglƒÖd pe≈Çny
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  updatePickingBadge();
}

function renderPickingChecklist(order) {
  if (!order.materialChecklist || order.materialChecklist.length === 0) {
    return '<div style="text-align:center;padding:20px;color:#94a3b8">Brak materia≈Ç√≥w do skompletowania</div>';
  }
  
  return order.materialChecklist.map((item, idx) => {
    const warehouseItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
    const available = warehouseItem ? warehouseItem.quantity : 0;
    const needed = item.quantity;
    const isSufficient = available >= needed;
    const isChecked = item.checked;
    
    const checkboxStyle = isChecked 
      ? 'background:#16a34a;border:2px solid #16a34a;color:white' 
      : 'background:#ffffff;border:2px solid #cbd5e1;color:transparent';
    
    const rowStyle = !isSufficient ? 'background:#fef2f2;border-left:3px solid #dc2626' : isChecked ? 'background:#f0fdf4' : 'background:#ffffff';
    
    return `
      <div onclick="togglePickingItem('${order.id}', ${idx})" 
           style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #e2e8f0;${rowStyle};cursor:pointer;transition:all 0.2s"
           onmouseover="this.style.transform='translateX(4px)'" 
           onmouseout="this.style.transform='translateX(0)'">
        <div style="width:24px;height:24px;min-width:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;transition:all 0.2s;${checkboxStyle}">
          ${isChecked ? '‚úì' : ''}
        </div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:15px;color:#0f172a">${item.itemName}</div>
          <div style="font-size:13px;color:#64748b;margin-top:2px">
            Potrzeba: <strong>${needed} ${item.unit}</strong> | 
            Stan: <strong style="color:${isSufficient ? '#16a34a' : '#dc2626'}">${available} ${item.unit}</strong>
            ${!isSufficient ? ` <span style="color:#dc2626;font-weight:600">(brakuje ${needed - available} ${item.unit})</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function togglePickingOrder(orderId) {
  const detailsEl = document.getElementById(`picking-${orderId}`);
  if (!detailsEl) return;
  
  const isHidden = detailsEl.style.display === 'none';
  detailsEl.style.display = isHidden ? 'block' : 'none';
}

function togglePickingItem(orderId, itemIndex) {
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order || !order.materialChecklist || !order.materialChecklist[itemIndex]) return;
  
  const item = order.materialChecklist[itemIndex];
  
  // Je≈õli jest ju≈º zaznaczone - pozw√≥l odznaczyƒá (odznaczanie zawsze dozwolone)
  if (item.checked) {
    item.checked = false;
    item.checkedAt = null;
    item.checkedBy = null;
    
    save();
    maybeAutoSave('picking-uncheck-item');
    
    // Wywo≈Çaj odpowiedniƒÖ funkcjƒô renderujƒÖcƒÖ (stara lub nowa)
    if (typeof window.renderWarehouseWork === 'function') {
      renderWarehouseWork();
    } else if (typeof renderPickingOrders === 'function') {
      renderPickingOrders();
    }
    return;
  }
  
  // Je≈õli NIE jest zaznaczone - sprawd≈∫ dostƒôpno≈õƒá przed zaznaczeniem
  const warehouseItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
  if (!warehouseItem || warehouseItem.quantity < item.quantity) {
    alert(`‚ö†Ô∏è Brak wystarczajƒÖcej ilo≈õci "${item.itemName}" w magazynie!\n\nPotrzeba: ${item.quantity} ${item.unit}\nDostƒôpne: ${warehouseItem ? warehouseItem.quantity : 0} ${item.unit}`);
    return;
  }
  
  // Zaznacz
  item.checked = true;
  item.checkedAt = new Date().toISOString();
  item.checkedBy = 'Magazynier';
  
  save();
  maybeAutoSave('picking-check-item');
  
  // Wywo≈Çaj odpowiedniƒÖ funkcjƒô renderujƒÖcƒÖ (stara lub nowa)
  if (typeof window.renderWarehouseWork === 'function') {
    renderWarehouseWork();
  } else if (typeof renderPickingOrders === 'function') {
    renderPickingOrders();
  }
}

function issueToProduction(orderId) {
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order || !order.materialChecklist) return;
  
  const checkedCount = order.materialChecklist.filter(i => i.checked).length;
  const totalCount = order.materialChecklist.length;
  
  if (checkedCount !== totalCount) {
    alert('‚ö†Ô∏è Nie wszystkie materia≈Çy sƒÖ skompletowane!\n\nSkompletowano: ' + checkedCount + '/' + totalCount);
    return;
  }
  
  if (!confirm(`üì§ Wydaƒá materia≈Çy na produkcjƒô dla zlecenia "${order.name}"?\n\nZo zmniejszy stany magazynowe i utworzy dokument WZ.`)) {
    return;
  }
  
  // Zmniejsz stany magazynowe i utw√≥rz transakcje WZ
  order.materialChecklist.forEach(item => {
    const warehouseItem = (window.warehouseItems || []).find(w => w.name === item.itemName);
    if (warehouseItem) {
      warehouseItem.quantity -= item.quantity;
      
      // Utw√≥rz transakcjƒô WZ
      const transaction = {
        id: generateId(),
        type: 'out',
        itemName: item.itemName,
        quantity: item.quantity,
        unit: item.unit,
        person: 'Magazynier',
        notes: `Wydanie na produkcjƒô - Zlecenie: ${order.name}`,
        date: new Date().toISOString(),
        timestamp: Date.now(),
        orderId: order.id,
        orderName: order.name
      };
      
      if (!window.warehouseTransactions) window.warehouseTransactions = [];
      window.warehouseTransactions.push(transaction);
    }
  });
  
  // Oznacz jako wydane
  order.materialsIssued = true;
  order.materialsIssuedAt = new Date().toISOString();
  
  saveWarehouseToStorage();
  save();
  maybeAutoSave('issue-to-production');
  
  alert(`‚úÖ Materia≈Çy wydane na produkcjƒô!\n\nZlecenie: ${order.name}\nPozycji: ${totalCount}\n\nDokumenty WZ zosta≈Çy utworzone.`);
  
  // Wywo≈Çaj odpowiedniƒÖ funkcjƒô renderujƒÖcƒÖ (stara lub nowa)
  if (typeof window.renderWarehouseWork === 'function') {
    renderWarehouseWork();
  } else if (typeof renderPickingOrders === 'function') {
    renderPickingOrders();
  }
  renderTransactions();
}

function updatePickingBadge() {
  const badge = document.getElementById('picking-badge');
  if (!badge) return;
  
  const orders = (state.orders || []).filter(o => {
    if (!o.processId || o.status === 'completed' || o.status === 'cancelled' || o.materialsIssued) return false;
    return true;
  });
  
  const pendingCount = orders.length;
  
  if (pendingCount > 0) {
    badge.textContent = pendingCount;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// Checklist materia≈Ç√≥w dla zlecenia
function showMaterialChecklist(orderId, opts) {
  const options = (typeof opts === 'object' && opts !== null) ? opts : {};
  const isReadOnly = !!options.readOnly;
  const source = typeof options.source === 'string' ? options.source : 'orders';
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order) {
    alert('Nie znaleziono zlecenia');
    return;
  }

  if (!order.processId) {
    alert('To zlecenie nie ma przypisanego procesu');
    return;
  }

  const process = (state.processes || []).find(p => p.id === order.processId);
  if (!process || !process.materialTemplateId) {
    alert('Proces nie ma przypisanego szablonu materia≈Çowego');
    return;
  }

  const template = (window.materialTemplates || []).find(t => t.id === process.materialTemplateId);
  if (!template) {
    alert('Nie znaleziono szablonu materia≈Çowego');
    return;
  }

  // Inicjalizuj stan checklisty je≈õli nie istnieje
  if (!order.materialChecklist) {
    order.materialChecklist = template.materials.map((m, idx) => ({
      itemId: m.itemId,
      itemName: m.itemName,
      quantity: m.quantity,
      unit: m.unit,
      checked: false,
      checkedAt: null,
      checkedBy: null
    }));
    save();
  }

  // Wygeneruj HTML checklisty (CUSTOM CHECKBOX - bez input)
  const checklistHtml = order.materialChecklist.map((item, idx) => {
    const isChecked = item.checked;
    const checkedStyle = isChecked ? 'text-decoration:line-through;color:#94a3b8' : '';
    const checkInfo = isChecked && item.checkedAt ? 
      `<div style="font-size:10px;color:#94a3b8;margin-top:2px">‚úì ${new Date(item.checkedAt).toLocaleString('pl-PL')}</div>` : '';
    
    const checkboxStyle = isChecked 
      ? 'background:#16a34a;border:2px solid #16a34a;color:white' 
      : 'background:#ffffff;border:2px solid #cbd5e1;color:transparent';
    const rowClickAttr = isReadOnly ? '' : ` onclick="event.stopPropagation(); window.toggleChecklistItem('${orderId}', ${idx})"`;
    const hoverAttrs = isReadOnly ? '' : ' onmouseover="this.style.background=\'#f0fdf4\';this.style.transform=\'translateX(4px)\'" onmouseout="this.style.background=\'#ffffff\';this.style.transform=\'translateX(0)\'"';
    const rowCursor = isReadOnly ? 'cursor:default !important' : 'cursor:pointer !important';
    const contentCursor = isReadOnly ? 'cursor:default !important' : 'cursor:pointer !important';
    
    return `
      <div${rowClickAttr}
           style="display:flex;align-items:flex-start;gap:14px;padding:14px;border-bottom:1px solid #e2e8f0;background:#ffffff;transition:all 0.2s;${rowCursor}"
           ${hoverAttrs}>
        <div style="width:26px;height:26px;min-width:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;transition:all 0.2s;margin-top:2px;flex-shrink:0;${contentCursor};${checkboxStyle}">
          ${isChecked ? '‚úì' : ''}
        </div>
        <div style="flex:1;${contentCursor}">
          <div style="${checkedStyle};font-size:16px;font-weight:600;color:#000000;transition:all 0.2s">${item.itemName}</div>
          <div style="font-size:13px;color:#64748b;margin-top:4px;font-weight:500">${item.quantity} ${item.unit}</div>
          ${checkInfo}
        </div>
      </div>
    `;
  }).join('');

  const checkedCount = order.materialChecklist.filter(i => i.checked).length;
  const totalCount = order.materialChecklist.length;
  const progress = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
  const readOnlyNotice = isReadOnly ? `
    <div style="background:#f8fafc;border:1px solid #cbd5e1;border-radius:8px;padding:12px 16px;margin-bottom:16px">
      <div style="font-size:14px;font-weight:600;color:#0f172a">Zak≈Çadka Zlecenia ma charakter informacyjny</div>
      <div style="font-size:13px;color:#475569;margin-top:6px">üë∑ Obs≈Çuga magazynu</div>
    </div>
  ` : '';

  const content = `
    ${readOnlyNotice}
    <div style="margin-bottom:16px">
      <div style="font-size:14px;color:#64748b;margin-bottom:8px">
        Szablon: <strong>${template.name}</strong>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="flex:1;background:#e2e8f0;border-radius:8px;height:24px;overflow:hidden">
          <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,#16a34a,#a3e635);transition:width 0.3s"></div>
        </div>
        <div style="font-size:14px;font-weight:600;color:#16a34a">${checkedCount}/${totalCount}</div>
      </div>
    </div>
    <div id="checklist-scroll-container" style="max-height:600px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px">
      ${checklistHtml}
    </div>
  `;

  const buttons = isReadOnly ? [
    {
      text: 'Przeka≈º do magazynu',
      action: () => {
        window.checklistScrollPosition = undefined;
        try {
          const now = Date.now();
          const stateObj = window.state = window.state || {};
          if (!Array.isArray(stateObj.tasks)) {
            stateObj.tasks = [];
          }
          let warehouseTask = stateObj.tasks.find(task => task && task.type === 'warehouse-preparation' && task.orderId === order.id);
          if (!warehouseTask) {
            const taskId = `warehouse-${order.id || now}-${Math.random().toString(36).slice(2, 8)}`;
            warehouseTask = {
              id: taskId,
              type: 'warehouse-preparation',
              orderId: order.id,
              orderName: order.name,
              status: 'pending',
              createdAt: now,
              updatedAt: now,
              source,
              materials: (order.materialChecklist || []).map(item => ({
                itemId: item.itemId,
                itemName: item.itemName,
                quantity: item.quantity,
                unit: item.unit,
                checked: !!item.checked
              }))
            };
            stateObj.tasks.push(warehouseTask);
          } else {
            warehouseTask.status = warehouseTask.status || 'pending';
            warehouseTask.updatedAt = now;
          }

          order.warehouseStatus = 'pending';
          order.warehouseTaskId = warehouseTask.id;
          if (!order.timeline) order.timeline = {};
          order.timeline.warehouse = order.timeline.warehouse || [];
          order.timeline.warehouse.push({ status: 'pending', at: now, actor: source });

          if (typeof save === 'function') {
            save();
          }
          if (typeof renderOrderPage === 'function') {
            renderOrderPage();
          }
          if (typeof updateTasksBadge === 'function') {
            updateTasksBadge();
          }
          alert('Przekazano zlecenie do magazynu ‚Äì zadanie magazynowe zosta≈Ço utworzone.');
        } catch (err) {
          console.error('Nie uda≈Ço siƒô utworzyƒá zadania magazynowego', err);
          alert('Nie uda≈Ço siƒô utworzyƒá zadania magazynowego. Spr√≥buj ponownie.');
        }
      }
    },
    {
      text: 'Zamknij',
      action: () => {
        window.checklistScrollPosition = undefined;
        renderOrderPage();
      }
    }
  ] : [
    { 
      text: 'üîí Auto-rezerwuj zaznaczone', 
      action: () => {
        window.checklistScrollPosition = undefined;
        // Zamknij modal przed rezerwacjƒÖ
        const modal = document.getElementById('custom-modal');
        if (modal) {
          modal.remove();
        }
        // Wykonaj rezerwacjƒô
        autoReserveFromChecklist(orderId);
        // Od≈õwie≈º tabelƒô zlece≈Ñ
        if (typeof renderOrderPage === 'function') {
          setTimeout(() => {
            renderOrderPage();
            console.log('‚úÖ Tabela zlece≈Ñ od≈õwie≈ºona po rezerwacji');
          }, 300);
        }
      }
    },
    { 
      text: 'Zamknij', 
      action: () => {
        // Wyczy≈õƒá zapamiƒôtanƒÖ pozycjƒô scrolla przy zamykaniu
        window.checklistScrollPosition = undefined;
        // Od≈õwie≈º tabelƒô zlece≈Ñ aby pokazaƒá zaktualizowany status materia≈Ç√≥w
        renderOrderPage();
      }
    }
  ];

  showModal(`üìã Checklist materia≈Ç√≥w - ${order.name}`, content, buttons);
  
  // Przywr√≥ƒá pozycjƒô scrolla je≈õli by≈Ça zapamiƒôtana
  if (window.checklistScrollPosition !== undefined) {
    setTimeout(() => {
      const scrollContainer = document.getElementById('checklist-scroll-container');
      if (scrollContainer) {
        scrollContainer.scrollTop = window.checklistScrollPosition;
        console.log('üìú Przywr√≥cono scroll na pozycjƒô:', window.checklistScrollPosition);
      }
    }, 50);
  }
}

// Flaga blokujƒÖca wielokrotne wywo≈Çanie
let isTogglingChecklistItem = false;

function toggleChecklistItem(orderId, itemIndex) {
  // Blokada wielokrotnego wywo≈Çania
  if (isTogglingChecklistItem) {
    console.warn('‚ö†Ô∏è toggleChecklistItem ju≈º w trakcie wykonywania, pomijam...');
    return;
  }
  
  isTogglingChecklistItem = true;
  console.log('üîÑ toggleChecklistItem:', orderId, itemIndex);
  
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order || !order.materialChecklist) {
    console.error('‚ùå Nie znaleziono zlecenia lub checklisty');
    isTogglingChecklistItem = false;
    return;
  }

  const item = order.materialChecklist[itemIndex];
  const oldChecked = item.checked;
  item.checked = !item.checked;
  item.checkedAt = item.checked ? Date.now() : null;
  item.checkedBy = item.checked ? 'U≈ºytkownik' : null;

  console.log('‚úÖ Zmieniono stan:', oldChecked, '‚Üí', item.checked, 'dla:', item.itemName);
  
  save();
  console.log('üíæ Stan zapisany, od≈õwie≈ºam modal...');
  
  // Zapamiƒôtaj pozycjƒô scrolla przed usuniƒôciem modalu
  const scrollContainer = document.getElementById('checklist-scroll-container');
  if (scrollContainer) {
    window.checklistScrollPosition = scrollContainer.scrollTop;
    console.log('üìú Zapamiƒôtano pozycjƒô scrolla:', window.checklistScrollPosition);
  }
  
  // Usu≈Ñ stary modal przed utworzeniem nowego
  const oldModal = document.getElementById('custom-modal');
  if (oldModal) {
    oldModal.remove();
  }
  
  // Od≈õwie≈º modal
  showMaterialChecklist(orderId);
  
  // Od≈õwie≈º tabelƒô zlece≈Ñ aby pokazaƒá zaktualizowany status materia≈Ç√≥w
  if (typeof renderOrderPage === 'function') {
    renderOrderPage();
  }
  
  // Odblokuj po kr√≥tkim czasie (pozw√≥l modal siƒô wyrenderowaƒá)
  setTimeout(() => {
    isTogglingChecklistItem = false;
    console.log('‚úÖ toggleChecklistItem odblokowany');
  }, 100);
}

// Wy≈õwietl modal z materia≈Çami zlecenia i opcjƒÖ wydania z magazynu
window.showOrderMaterials = function(orderId) {
  console.log('üì¶ showOrderMaterials:', orderId);
  
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order) {
    alert('Nie znaleziono zlecenia');
    return;
  }
  
  if (!order.materialChecklist || order.materialChecklist.length === 0) {
    alert('To zlecenie nie ma przypisanych materia≈Ç√≥w');
    return;
  }
  
  const warehouseItems = window.warehouseItems || [];
  const reservations = window.warehouseReservations || [];
  
  // Przygotuj listƒô materia≈Ç√≥w z informacjƒÖ o dostƒôpno≈õci
  const materialsHtml = order.materialChecklist.map((item, idx) => {
    const warehouseItem = warehouseItems.find(w => w.id === item.itemId);
    
    if (!warehouseItem) {
      return `
        <div style="padding:16px;background:#fef2f2;border:2px solid #fecaca;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="font-size:32px">‚ùå</div>
            <div style="flex:1">
              <div style="font-size:16px;font-weight:600;color:#dc2626">${item.itemName}</div>
              <div style="font-size:14px;color:#991b1b;margin-top:4px">Potrzebne: ${item.quantity} ${item.unit}</div>
              <div style="font-size:13px;color:#991b1b;margin-top:4px;font-weight:600">‚ö†Ô∏è Materia≈Ç nie znaleziony w magazynie</div>
            </div>
          </div>
        </div>
      `;
    }
    
    const reserved = reservations.filter(r => r.itemId === item.itemId && r.status === 'active').reduce((sum, r) => sum + (r.quantity || 0), 0);
    const available = warehouseItem.quantity - reserved;
    const needed = item.quantity;
    
    let statusIcon = '';
    let statusText = '';
    let statusColor = '';
    let bgColor = '';
    let borderColor = '';
    
    if (available >= needed) {
      statusIcon = '‚úÖ';
      statusText = 'Dostƒôpne';
      statusColor = '#16a34a';
      bgColor = '#f0fdf4';
      borderColor = '#bbf7d0';
    } else if (available > 0) {
      statusIcon = '‚ö†Ô∏è';
      statusText = `Dostƒôpne tylko ${available} ${item.unit} (brakuje ${needed - available})`;
      statusColor = '#f59e0b';
      bgColor = '#fffbeb';
      borderColor = '#fcd34d';
    } else {
      statusIcon = '‚ùå';
      statusText = 'Brak w magazynie';
      statusColor = '#dc2626';
      bgColor = '#fef2f2';
      borderColor = '#fecaca';
    }
    
    return `
      <div style="padding:16px;background:${bgColor};border:2px solid ${borderColor};border-radius:8px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:32px">${statusIcon}</div>
          <div style="flex:1">
            <div style="font-size:16px;font-weight:600;color:#1e293b">${item.itemName}</div>
            <div style="font-size:14px;color:#64748b;margin-top:4px">Potrzebne: <strong>${needed} ${item.unit}</strong></div>
            <div style="font-size:14px;color:#64748b">W magazynie: <strong>${warehouseItem.quantity} ${item.unit}</strong></div>
            ${reserved > 0 ? `<div style="font-size:13px;color:#64748b">Zarezerwowane: <strong>${reserved} ${item.unit}</strong></div>` : ''}
            <div style="font-size:14px;color:${statusColor};margin-top:4px;font-weight:600">${statusText}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Sprawd≈∫ czy mo≈ºna wydaƒá materia≈Çy (wszystkie dostƒôpne lub czƒô≈õciowo dostƒôpne)
  let canIssue = false;
  let allAvailable = true;
  let hasPartial = false;
  let allZero = true; // Czy wszystkie materia≈Çy majƒÖ 0 w magazynie
  
  order.materialChecklist.forEach(item => {
    const warehouseItem = warehouseItems.find(w => w.id === item.itemId);
    if (!warehouseItem) {
      allAvailable = false;
      return;
    }
    const reserved = reservations.filter(r => r.itemId === item.itemId && r.status === 'active').reduce((sum, r) => sum + (r.quantity || 0), 0);
    const available = warehouseItem.quantity - reserved;
    
    if (available > 0) {
      canIssue = true;
      allZero = false;
    }
    if (available < item.quantity) {
      allAvailable = false;
      if (available > 0) {
        hasPartial = true;
      }
    }
  });
  
  // Je≈õli wszystkie materia≈Çy sƒÖ w magazynie (nawet je≈õli quantity=0), pozw√≥l na "obciƒÖ≈ºenie"
  // To spowoduje dodanie wszystkich do listy zakup√≥w
  const allMaterialsExist = order.materialChecklist.every(item => 
    warehouseItems.find(w => w.id === item.itemId)
  );
  
  if (allMaterialsExist && allZero) {
    canIssue = true; // Pozw√≥l dodaƒá wszystko do listy zakup√≥w
  }
  
  const content = `
    <div style="margin-bottom:16px">
      <div style="font-size:14px;color:#64748b">
        Zlecenie: <strong>${order.name}</strong> | Klient: <strong>${order.client || '-'}</strong>
      </div>
    </div>
    <div style="max-height:500px;overflow-y:auto">
      ${materialsHtml}
    </div>
  `;
  
  const buttons = [];
  
  if (canIssue) {
    let issueText = 'üîÑ ObciƒÖ≈º magazyn';
    let buttonStyle = 'background:#16a34a;color:white;font-weight:600';
    
    if (allZero) {
      issueText = 'üõí Dodaj wszystko do listy zakup√≥w';
      buttonStyle = 'background:#f59e0b;color:white;font-weight:600';
    } else if (!allAvailable) {
      issueText = 'üîÑ ObciƒÖ≈º magazyn (czƒô≈õciowo)';
    }
    
    buttons.push({
      text: issueText,
      style: buttonStyle,
      action: () => {
        document.getElementById('custom-modal')?.remove();
        issueOrderMaterials(orderId);
      }
    });
  }
  
  buttons.push({
    text: 'Zamknij',
    action: () => {}
  });
  
  showModal(`üì¶ Materia≈Çy - ${order.name}`, content, buttons);
};

// Blokada wielokrotnego wydawania
let isIssuingMaterials = false;

// Wydanie materia≈Ç√≥w z magazynu dla zlecenia (WZ)
function issueOrderMaterials(orderId) {
  if (isIssuingMaterials) {
    console.warn('‚ö†Ô∏è Wydawanie materia≈Ç√≥w ju≈º w trakcie...');
    return;
  }
  
  isIssuingMaterials = true;
  console.log('üîÑ Rozpoczynam wydawanie materia≈Ç√≥w dla zlecenia:', orderId);
  
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order || !order.materialChecklist) {
    alert('Nie znaleziono zlecenia lub checklisty');
    isIssuingMaterials = false;
    return;
  }
  
  // Sprawd≈∫ czy materia≈Çy nie zosta≈Çy ju≈º wydane
  const alreadyIssued = order.materialChecklist.every(item => item.issued);
  if (alreadyIssued) {
    alert('‚ö†Ô∏è Materia≈Çy dla tego zlecenia zosta≈Çy ju≈º wydane!');
    isIssuingMaterials = false;
    return;
  }
  
  const warehouseItems = window.warehouseItems || [];
  const warehouseTransactions = window.warehouseTransactions || [];
  const reservations = window.warehouseReservations || [];
  
  // Inicjalizacja listy zakup√≥w je≈õli nie istnieje
  if (!window.shoppingList) {
    window.shoppingList = [];
  }
  
  const results = {
    issued: [],        // Wydane materia≈Çy
    partial: [],       // Wydane czƒô≈õciowo
    shortage: [],      // Braki dodane do listy zakup√≥w
    notFound: []       // Materia≈Ç nie istnieje
  };
  
  // Potwierd≈∫ operacjƒô
  const confirmMsg = `Czy na pewno chcesz wydaƒá materia≈Çy z magazynu dla zlecenia "${order.name}"?\n\nOperacja utworzy dokument WZ i zmniejszy stany magazynowe.`;
  if (!confirm(confirmMsg)) {
    isIssuingMaterials = false;
    return;
  }
  
  // Przetwarzaj ka≈ºdy materia≈Ç
  order.materialChecklist.forEach(item => {
    const warehouseItem = warehouseItems.find(w => w.id === item.itemId);
    
    if (!warehouseItem) {
      results.notFound.push(item);
      // Dodaj do listy zakup√≥w
      addToShoppingList(item.itemId, item.itemName, item.quantity, item.unit, orderId, order.name, 'Materia≈Ç nie znaleziony w magazynie');
      results.shortage.push(item);
      return;
    }
    
    const reserved = reservations.filter(r => r.itemId === item.itemId && r.status === 'active').reduce((sum, r) => sum + (r.quantity || 0), 0);
    const available = warehouseItem.quantity - reserved;
    const needed = item.quantity;
    
    if (available <= 0) {
      // Brak w magazynie - dodaj do listy zakup√≥w
      addToShoppingList(item.itemId, item.itemName, needed, item.unit, orderId, order.name, 'Brak w magazynie');
      results.shortage.push(item);
      return;
    }
    
    const issueQty = Math.min(available, needed);
    
    // Utw√≥rz transakcjƒô WZ
    const transaction = {
      id: 'wz-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
      itemId: item.itemId,
      itemName: item.itemName,
      type: 'WZ',
      quantity: -issueQty, // ujemna warto≈õƒá = wydanie
      unit: item.unit,
      date: new Date().toISOString().split('T')[0],
      notes: `Wydanie dla zlecenia: ${order.name}`,
      orderId: orderId,
      createdAt: Date.now()
    };
    
    warehouseTransactions.push(transaction);
    
    // Zmniejsz stan magazynowy
    warehouseItem.quantity -= issueQty;
    
    // Oznacz jako wydane w checkli≈õcie
    item.issued = true;
    item.issuedQty = issueQty;
    item.issuedAt = Date.now();
    
    if (issueQty === needed) {
      results.issued.push({...item, issuedQty: issueQty});
    } else {
      results.partial.push({...item, issuedQty: issueQty, shortageQty: needed - issueQty});
      // Dodaj brakujƒÖcƒÖ ilo≈õƒá do listy zakup√≥w
      addToShoppingList(item.itemId, item.itemName, needed - issueQty, item.unit, orderId, order.name, 'Wydano czƒô≈õciowo');
      results.shortage.push({...item, shortageQty: needed - issueQty});
    }
    
    // Oznacz rezerwacjƒô jako wykorzystanƒÖ (je≈õli by≈Ça)
    const orderReservations = reservations.filter(r => r.itemId === item.itemId && r.orderId === orderId && r.status === 'active');
    orderReservations.forEach(r => {
      r.status = 'used';
      r.usedAt = Date.now();
    });
  });
  
  // Zapisz zmiany
  window.warehouseTransactions = warehouseTransactions;
  window.warehouseReservations = reservations;
  saveWarehouseToStorage();
  save();
  
  console.log('‚úÖ Wydawanie materia≈Ç√≥w zako≈Ñczone:', results);
  
  // Odblokuj
  isIssuingMaterials = false;
  
  // Poka≈º raport (od≈õwie≈ºenie tabeli nastƒÖpi po zamkniƒôciu modalu)
  showIssueReport(orderId, results);
}

// Dodaj materia≈Ç do listy zakup√≥w
function addToShoppingList(itemId, itemName, quantity, unit, orderId, orderName, reason) {
  if (!window.shoppingList) {
    window.shoppingList = [];
  }
  
  // Sprawd≈∫ czy ju≈º jest na li≈õcie (dla tego samego zlecenia i materia≈Çu)
  const existing = window.shoppingList.find(s => 
    s.itemId === itemId && 
    s.orderId === orderId && 
    s.status === 'pending'
  );
  
  if (existing) {
    // Zwiƒôksz ilo≈õƒá
    existing.quantity += quantity;
    existing.updatedAt = Date.now();
    console.log('üìù Zwiƒôkszono ilo≈õƒá na li≈õcie zakup√≥w:', existing);
  } else {
    // Dodaj nowy wpis
    const item = {
      id: 'shop-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
      itemId: itemId,
      itemName: itemName,
      quantity: quantity,
      unit: unit,
      orderId: orderId,
      orderName: orderName,
      reason: reason,
      status: 'pending', // pending | ordered | received
      addedAt: Date.now(),
      updatedAt: Date.now()
    };
    window.shoppingList.push(item);
    console.log('üìù Dodano do listy zakup√≥w:', item);
  }
  
  // Zapisz do localStorage
  localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
  updateShoppingListBadge();
}

// Poka≈º raport wydania materia≈Ç√≥w
function showIssueReport(orderId, results) {
  const order = (state.orders || []).find(o => o.id === orderId);
  const orderName = order ? order.name : orderId;
  
  let html = `<div style="max-height:500px;overflow-y:auto">`;
  
  // Wydane w pe≈Çni
  if (results.issued.length > 0) {
    html += `<div style="margin-bottom:20px">
      <h4 style="color:#16a34a;margin-bottom:12px">‚úÖ Wydane materia≈Çy (${results.issued.length})</h4>`;
    results.issued.forEach(item => {
      html += `<div style="padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#16a34a">Wydano: ${item.issuedQty} ${item.unit}</div>
      </div>`;
    });
    html += `</div>`;
  }
  
  // Wydane czƒô≈õciowo
  if (results.partial.length > 0) {
    html += `<div style="margin-bottom:20px">
      <h4 style="color:#f59e0b;margin-bottom:12px">‚ö†Ô∏è Wydane czƒô≈õciowo (${results.partial.length})</h4>`;
    results.partial.forEach(item => {
      html += `<div style="padding:12px;background:#fffbeb;border:1px solid #fcd34d;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#f59e0b">Wydano: ${item.issuedQty} ${item.unit}</div>
        <div style="font-size:14px;color:#dc2626">Brakuje: ${item.shortageQty} ${item.unit} (dodano do listy zakup√≥w)</div>
      </div>`;
    });
    html += `</div>`;
  }
  
  // Braki
  if (results.shortage.length > 0) {
    html += `<div style="margin-bottom:20px">
      <h4 style="color:#dc2626;margin-bottom:12px">üõí Dodano do listy zakup√≥w (${results.shortage.length})</h4>`;
    results.shortage.forEach(item => {
      const qty = item.shortageQty || item.quantity;
      html += `<div style="padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#dc2626">Do zam√≥wienia: ${qty} ${item.unit}</div>
      </div>`;
    });
    html += `</div>`;
  }
  
  // Nie znaleziono
  if (results.notFound.length > 0) {
    html += `<div style="margin-bottom:20px">
      <h4 style="color:#dc2626;margin-bottom:12px">‚ùå Nie znaleziono (${results.notFound.length})</h4>`;
    results.notFound.forEach(item => {
      html += `<div style="padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#dc2626">Materia≈Ç nie istnieje w magazynie (dodano do listy zakup√≥w)</div>
      </div>`;
    });
    html += `</div>`;
  }
  
  html += `</div>`;
  
  showModal(`üìÑ Raport wydania - ${orderName}`, html, [
    {
      text: 'üõí Poka≈º listƒô zakup√≥w',
      style: 'background:#3b82f6;color:white',
      action: () => {
        document.getElementById('custom-modal')?.remove();
        showShoppingList();
      }
    },
    {
      text: 'Zamknij',
      action: () => {
        // Od≈õwie≈º tabelƒô zlece≈Ñ po zamkniƒôciu raportu
        renderOrderPage();
      }
    }
  ]);
}

// Wy≈õwietl listƒô zakup√≥w
window.showShoppingList = function() {
  console.log('üõí showShoppingList');
  
  // Wczytaj listƒô z localStorage
  if (!window.shoppingList) {
    const stored = localStorage.getItem('shoppingList');
    window.shoppingList = stored ? JSON.parse(stored) : [];
  }
  
  const pending = window.shoppingList.filter(item => item.status === 'pending');
  console.log('üìù Pozycje pending:', pending.length, pending);
  const ordered = window.shoppingList.filter(item => item.status === 'ordered');
  const received = window.shoppingList.filter(item => item.status === 'received');
  
  let html = `<div style="max-height:500px;overflow-y:auto">`;
  
  // OczekujƒÖce zam√≥wienia
  if (pending.length > 0) {
    html += `<div style="margin-bottom:24px">
      <h4 style="color:#f59e0b;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <span>üìù Do zam√≥wienia (${pending.length})</span>
      </h4>`;
    
    // Grupuj po materiale
    const grouped = {};
    pending.forEach(item => {
      // Debug: sprawd≈∫ czy itemId istnieje
      if (!item.itemId) {
        console.warn('‚ö†Ô∏è Pozycja bez itemId:', item);
        return; // Pomi≈Ñ pozycje bez itemId
      }
      
      if (!grouped[item.itemId]) {
        grouped[item.itemId] = {
          itemId: item.itemId,
          itemName: item.itemName,
          unit: item.unit,
          totalQty: 0,
          orders: []
        };
      }
      grouped[item.itemId].totalQty += item.quantity;
      grouped[item.itemId].orders.push(item);
    });
    
    Object.values(grouped).forEach(group => {
      html += `<div style="padding:16px;background:#fffbeb;border:2px solid #fcd34d;border-radius:8px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div>
            <div style="font-size:18px;font-weight:600;color:#1e293b">${group.itemName}</div>
            <div style="font-size:16px;color:#f59e0b;font-weight:600;margin-top:4px">Razem: ${group.totalQty} ${group.unit}</div>
          </div>
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #fcd34d">
          <div style="font-size:13px;color:#64748b;margin-bottom:6px;font-weight:600">Potrzebne dla zlece≈Ñ:</div>`;
      
      group.orders.forEach(order => {
        html += `<div style="font-size:13px;color:#64748b;margin-bottom:4px">
          ‚Ä¢ ${order.orderName}: ${order.quantity} ${order.unit} <span style="color:#94a3b8">(${order.reason})</span>
        </div>`;
      });
      
      html += `</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn primary" onclick="window.markAsOrdered('${group.itemId}')" style="background:#16a34a">‚úÖ Zam√≥wiono</button>
          <button class="btn" onclick="window.removeFromShoppingList('${group.itemId}')" style="background:#dc2626;color:white">üóëÔ∏è Usu≈Ñ</button>
        </div>
      </div>`;
    });
    
    html += `</div>`;
  } else {
    html += `<div style="padding:20px;text-align:center;color:#94a3b8">
      <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
      <div>Brak materia≈Ç√≥w do zam√≥wienia</div>
    </div>`;
  }
  
  // Zam√≥wione
  if (ordered.length > 0) {
    html += `<div style="margin-bottom:24px">
      <h4 style="color:#3b82f6;margin-bottom:12px">üì¶ Zam√≥wione (${ordered.length})</h4>`;
    
    ordered.forEach(item => {
      const orderDate = new Date(item.updatedAt).toLocaleDateString();
      html += `<div style="padding:12px;background:#eff6ff;border:1px solid #93c5fd;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#3b82f6">Ilo≈õƒá: ${item.quantity} ${item.unit}</div>
        <div style="font-size:13px;color:#64748b">Zlecenie: ${item.orderName}</div>
        <div style="font-size:12px;color:#94a3b8">Zam√≥wiono: ${orderDate}</div>
        <div style="margin-top:8px">
          <button class="btn primary" onclick="window.markAsReceivedFromShoppingList('${item.id}')" style="background:#16a34a">‚úÖ Dostarczono</button>
        </div>
      </div>`;
    });
    
    html += `</div>`;
  }
  
  // Dostarczone (ostatnie 10)
  if (received.length > 0) {
    html += `<div style="margin-bottom:24px">
      <h4 style="color:#16a34a;margin-bottom:12px">‚úÖ Dostarczone (ostatnie ${Math.min(10, received.length)})</h4>`;
    
    received.slice(0, 10).forEach(item => {
      const receiveDate = new Date(item.updatedAt).toLocaleDateString();
      html += `<div style="padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;margin-bottom:8px">
        <div style="font-weight:600">${item.itemName}</div>
        <div style="font-size:14px;color:#16a34a">Ilo≈õƒá: ${item.quantity} ${item.unit}</div>
        <div style="font-size:13px;color:#64748b">Zlecenie: ${item.orderName}</div>
        <div style="font-size:12px;color:#94a3b8">Dostarczono: ${receiveDate}</div>
      </div>`;
    });
    
    html += `</div>`;
  }
  
  html += `</div>`;
  
  showModal('üõí Lista zakup√≥w', html, [
    {
      text: 'Od≈õwie≈º',
      action: () => {
        document.getElementById('custom-modal')?.remove();
        window.showShoppingList();
      }
    },
    {
      text: 'Zamknij',
      action: () => {}
    }
  ]);
};

// Oznacz materia≈Ç jako zam√≥wiony (wszystkie oczekujƒÖce pozycje tego materia≈Çu)
window.markAsOrdered = function(itemId) {
  if (!window.shoppingList) return;
  
  let updated = 0;
  window.shoppingList.forEach(item => {
    if (item.itemId === itemId && item.status === 'pending') {
      item.status = 'ordered';
      item.updatedAt = Date.now();
      updated++;
    }
  });
  
  localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
  updateShoppingListBadge();
  console.log(`‚úÖ Oznaczono ${updated} pozycji jako zam√≥wione`);
  
  // Od≈õwie≈º modal
  document.getElementById('custom-modal')?.remove();
  window.showShoppingList();
};

// Oznacz materia≈Ç jako dostarczony (LISTA ZAKUP√ìW - stara funkcja)
window.markAsReceivedFromShoppingList = function(itemId) {
  if (!window.shoppingList) return;
  
  const item = window.shoppingList.find(i => i.id === itemId);
  if (!item) return;
  
  item.status = 'received';
  item.updatedAt = Date.now();
  
  localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
  updateShoppingListBadge();
  console.log('‚úÖ Oznaczono jako dostarczone:', item.itemName);
  
  // Opcjonalnie: dodaj do magazynu (PZ)
  const addToWarehouse = confirm(`Czy chcesz dodaƒá "${item.itemName}" (${item.quantity} ${item.unit}) do magazynu?\n\nZostanie utworzony dokument PZ.`);
  
  if (addToWarehouse) {
    const warehouseItems = window.warehouseItems || [];
    const warehouseItem = warehouseItems.find(w => w.id === item.itemId);
    
    if (warehouseItem) {
      // Zwiƒôksz stan
      warehouseItem.quantity += item.quantity;
      
      // Utw√≥rz transakcjƒô PZ
      const transaction = {
        id: 'pz-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        itemId: item.itemId,
        itemName: item.itemName,
        type: 'PZ',
        quantity: item.quantity,
        unit: item.unit,
        date: new Date().toISOString().split('T')[0],
        notes: `Przyjƒôcie z listy zakup√≥w (zlecenie: ${item.orderName})`,
        orderId: item.orderId,
        createdAt: Date.now()
      };
      
      if (!window.warehouseTransactions) {
        window.warehouseTransactions = [];
      }
      window.warehouseTransactions.push(transaction);
      
      saveWarehouseToStorage();
      console.log('‚úÖ Dodano do magazynu:', item.itemName, '+', item.quantity, item.unit);
      alert(`‚úÖ Dodano ${item.itemName} (+${item.quantity} ${item.unit}) do magazynu`);
    } else {
      alert('‚ö†Ô∏è Materia≈Ç nie istnieje w magazynie. Najpierw dodaj go rƒôcznie.');
    }
  }
  
  // Od≈õwie≈º modal
  document.getElementById('custom-modal')?.remove();
  window.showShoppingList();
};

// Usu≈Ñ z listy zakup√≥w (wszystkie oczekujƒÖce pozycje tego materia≈Çu)
window.removeFromShoppingList = function(itemId) {
  if (!window.shoppingList) return;
  
  const toRemove = window.shoppingList.filter(i => i.itemId === itemId && i.status === 'pending');
  
  if (toRemove.length === 0) return;
  
  const confirmMsg = `Czy na pewno usunƒÖƒá ${toRemove.length} pozycji materia≈Çu "${toRemove[0].itemName}" z listy zakup√≥w?`;
  if (!confirm(confirmMsg)) return;
  
  window.shoppingList = window.shoppingList.filter(i => !(i.itemId === itemId && i.status === 'pending'));
  
  localStorage.setItem('shoppingList', JSON.stringify(window.shoppingList));
  updateShoppingListBadge();
  console.log('üóëÔ∏è Usuniƒôto z listy zakup√≥w:', toRemove.length, 'pozycji');
  
  // Od≈õwie≈º modal
  document.getElementById('custom-modal')?.remove();
  window.showShoppingList();
};

// Auto-rezerwacja materia≈Ç√≥w z checklisty
function autoReserveFromChecklist(orderId) {
  console.log('üîí Rozpoczynam auto-rezerwacjƒô dla zlecenia:', orderId);
  
  const order = (state.orders || []).find(o => o.id === orderId);
  if (!order || !order.materialChecklist) {
    alert('Nie znaleziono zlecenia lub checklisty');
    return;
  }

  // Pobierz tylko zaznaczone materia≈Çy
  const checkedItems = order.materialChecklist.filter(item => item.checked);
  
  if (checkedItems.length === 0) {
    alert('Nie zaznaczono ≈ºadnych materia≈Ç√≥w do rezerwacji');
    return;
  }

  const results = {
    reserved: [],      // Udane rezerwacje
    insufficient: [],  // NiewystarczajƒÖca ilo≈õƒá
    notFound: []       // Materia≈Ç nie istnieje w magazynie
  };

  // Sprawd≈∫ ka≈ºdy zaznaczony materia≈Ç
  checkedItems.forEach(item => {
    const warehouseItem = (window.warehouseItems || []).find(w => w.id === item.itemId);
    
    if (!warehouseItem) {
      results.notFound.push({
        orderId: orderId,
        orderName: order.name,
        name: item.itemName,
        needed: item.quantity,
        unit: item.unit
      });
      return;
    }

    // Oblicz dostƒôpnƒÖ ilo≈õƒá (zapas - ju≈º zarezerwowane)
    const existingReservations = (window.warehouseReservations || [])
      .filter(r => r.itemId === item.itemId && r.status === 'active')
      .reduce((sum, r) => sum + r.quantity, 0);
    
    const available = warehouseItem.quantity - existingReservations;

    if (available < item.quantity) {
      results.insufficient.push({
        orderId: orderId,
        orderName: order.name,
        name: item.itemName,
        needed: item.quantity,
        available: available,
        unit: item.unit
      });
      return;
    }

    // Utw√≥rz rezerwacjƒô
    const reservation = {
      id: generateId(),
      itemId: item.itemId,
      itemName: item.itemName,
      orderId: orderId,
      orderName: order.name,
      quantity: item.quantity,
      unit: item.unit,
      status: 'active',
      createdAt: Date.now(),
      createdBy: 'Auto-rezerwacja'
    };

    if (!window.warehouseReservations) {
      window.warehouseReservations = [];
    }
    window.warehouseReservations.push(reservation);

    results.reserved.push({
      orderId: orderId,
      orderName: order.name,
      name: item.itemName,
      quantity: item.quantity,
      unit: item.unit
    });

    console.log('‚úÖ Zarezerwowano:', item.itemName, item.quantity, item.unit);
  });

  // Zapisz stan magazynu
  saveWarehouseToStorage();
  
  console.log('üíæ Stan zapisany, rezerwacji w localStorage:', window.warehouseReservations.length);
  console.log('üìã Wszystkie rezerwacje:', window.warehouseReservations);
  
  // Prze≈ÇƒÖcz na zak≈Çadkƒô Rezerwacje i od≈õwie≈º widok
  if (typeof switchWarehouseTab === 'function') {
    console.log('üîÑ Prze≈ÇƒÖczam na zak≈Çadkƒô Rezerwacje...');
    switchWarehouseTab('reservations');
  } else if (typeof renderReservations === 'function') {
    console.log('üîÑ Od≈õwie≈ºam widok rezerwacji...');
    renderReservations();
  } else {
    console.warn('‚ö†Ô∏è Brak dostƒôpnych funkcji do od≈õwie≈ºenia!');
  }
  
  // Od≈õwie≈º tabelƒô zlece≈Ñ (je≈õli jest dostƒôpna w tym scope)
  try {
    if (typeof renderOrderPage === 'function') {
      console.log('üîÑ Od≈õwie≈ºam tabelƒô zlece≈Ñ...');
      renderOrderPage();
    }
  } catch (e) {
    console.log('‚ÑπÔ∏è renderOrderPage nie jest dostƒôpna w tym kontek≈õcie (to normalne)');
  }

  // Zmie≈Ñ kolor przycisku na zielony
  const modal = document.getElementById('custom-modal');
  if (modal) {
    const buttons = modal.querySelectorAll('.btn');
    buttons.forEach(btn => {
      if (btn.textContent.includes('Auto-rezerwuj')) {
        btn.style.background = '#16a34a';
        btn.style.color = '#ffffff';
        btn.style.border = '2px solid #16a34a';
        btn.textContent = '‚úÖ Zarezerwowano';
        btn.disabled = true;
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.8';
      }
    });
  }

  // Poka≈º raport
  showReservationReport(results);
}

// Poka≈º raport z rezerwacji
function showReservationReport(results) {
  let html = '<div style="font-family:system-ui,-apple-system,sans-serif">';

  // Sekcja: Zarezerwowano
  if (results.reserved.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#16a34a;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚úÖ</span>
          <span>Zarezerwowano (${results.reserved.length})</span>
        </h4>
        <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:10px">
          ${results.reserved.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #86efac40">
              <strong>${r.name}</strong> - ${r.quantity} ${r.unit}
              ${r.orderId ? `<div style="color:#059669;font-size:11px;margin-top:2px;cursor:pointer;text-decoration:underline" onclick="document.getElementById('custom-modal').remove(); window.showMaterialChecklist('${r.orderId}')">üìã Zlecenie: ${r.orderName}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Sekcja: NiewystarczajƒÖca ilo≈õƒá
  if (results.insufficient.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#f59e0b;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚ö†Ô∏è</span>
          <span>NiewystarczajƒÖca ilo≈õƒá (${results.insufficient.length})</span>
        </h4>
        <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:6px;padding:10px">
          ${results.insufficient.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #fcd34d40">
              <strong>${r.name}</strong><br>
              <span style="font-size:13px;color:#92400e">
                Potrzeba: ${r.needed} ${r.unit} | Dostƒôpne: ${r.available} ${r.unit}
              </span>
              ${r.orderId ? `<div style="color:#b45309;font-size:11px;margin-top:2px;cursor:pointer;text-decoration:underline" onclick="document.getElementById('custom-modal').remove(); window.showMaterialChecklist('${r.orderId}')">üìã Zlecenie: ${r.orderName}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Sekcja: Nie znaleziono
  if (results.notFound.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#dc2626;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚ùå</span>
          <span>Nie znaleziono w magazynie (${results.notFound.length})</span>
        </h4>
        <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:10px">
          ${results.notFound.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #fca5a540">
              <strong>${r.name}</strong> - ${r.needed} ${r.unit}
              ${r.orderId ? `<div style="color:#dc2626;font-size:11px;margin-top:2px;cursor:pointer;text-decoration:underline" onclick="document.getElementById('custom-modal').remove(); window.showMaterialChecklist('${r.orderId}')">üìã Zlecenie: ${r.orderName}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  html += '</div>';

  showModal('üìä Raport rezerwacji', html, [
    { 
      text: 'OK', 
      action: () => {
        // Od≈õwie≈º tabelƒô zlece≈Ñ po zamkniƒôciu raportu
        if (typeof renderOrderPage === 'function') {
          renderOrderPage();
          console.log('‚úÖ Tabela zlece≈Ñ od≈õwie≈ºona po zamkniƒôciu raportu');
        }
      } 
    }
  ]);
}

// Auto-rezerwacja dla wszystkich zlece≈Ñ
function autoReserveForOrders() {
  console.log('‚ö° Rozpoczynam auto-rezerwacjƒô dla wszystkich zlece≈Ñ...');
  
  if (!state.orders || state.orders.length === 0) {
    alert('Brak zlece≈Ñ do przetworzenia');
    return;
  }

  // Zbierz wszystkie zlecenia z procesami i szablonami
  const ordersToProcess = [];
  
  state.orders.forEach(order => {
    if (!order.processId) return;
    
    const process = (state.processes || []).find(p => p.id === order.processId);
    if (!process || !process.materialTemplateId) return;
    
    const template = (window.materialTemplates || []).find(t => t.id === process.materialTemplateId);
    if (!template) return;
    
    ordersToProcess.push({
      order: order,
      process: process,
      template: template
    });
  });

  if (ordersToProcess.length === 0) {
    alert('Nie znaleziono zlece≈Ñ z przypisanymi szablonami materia≈Çowymi');
    return;
  }

  const globalResults = {
    reserved: [],
    insufficient: [],
    notFound: [],
    ordersProcessed: 0
  };

  // Przetw√≥rz ka≈ºde zlecenie
  ordersToProcess.forEach(({ order, process, template }) => {
    console.log(`üìã Przetwarzam zlecenie: ${order.name}`);
    
    // Inicjalizuj checklistƒô je≈õli nie istnieje
    if (!order.materialChecklist) {
      order.materialChecklist = template.materials.map((m) => ({
        itemId: m.itemId,
        itemName: m.itemName,
        quantity: m.quantity,
        unit: m.unit,
        checked: false,
        checkedAt: null,
        checkedBy: null
      }));
    }

    // Przetw√≥rz wszystkie materia≈Çy z szablonu (nie tylko zaznaczone)
    template.materials.forEach(material => {
      const warehouseItem = (window.warehouseItems || []).find(w => w.id === material.itemId);
      
      if (!warehouseItem) {
        globalResults.notFound.push({
          orderId: order.id,
          orderName: order.name,
          name: material.itemName,
          needed: material.quantity,
          unit: material.unit
        });
        return;
      }

      // Oblicz dostƒôpnƒÖ ilo≈õƒá
      const existingReservations = (window.warehouseReservations || [])
        .filter(r => r.itemId === material.itemId && r.status === 'active')
        .reduce((sum, r) => sum + r.quantity, 0);
      
      const available = warehouseItem.quantity - existingReservations;

      // Sprawd≈∫ czy ju≈º jest rezerwacja dla tego zlecenia i materia≈Çu
      const existingReservation = (window.warehouseReservations || [])
        .find(r => r.orderId === order.id && r.itemId === material.itemId && r.status === 'active');

      if (existingReservation) {
        console.log(`‚ÑπÔ∏è Rezerwacja ju≈º istnieje dla ${material.itemName} w zleceniu ${order.name}`);
        return;
      }

      if (available < material.quantity) {
        globalResults.insufficient.push({
          orderId: order.id,
          orderName: order.name,
          name: material.itemName,
          needed: material.quantity,
          available: available,
          unit: material.unit
        });
        return;
      }

      // Utw√≥rz rezerwacjƒô
      const reservation = {
        id: generateId(),
        itemId: material.itemId,
        itemName: material.itemName,
        orderId: order.id,
        orderName: order.name,
        quantity: material.quantity,
        unit: material.unit,
        status: 'active',
        createdAt: Date.now(),
        createdBy: 'Auto-rezerwacja (dla zlece≈Ñ)'
      };

      if (!window.warehouseReservations) {
        window.warehouseReservations = [];
      }
      window.warehouseReservations.push(reservation);

      globalResults.reserved.push({
        orderId: order.id,
        orderName: order.name,
        name: material.itemName,
        quantity: material.quantity,
        unit: material.unit
      });

      console.log(`‚úÖ Zarezerwowano: ${material.itemName} (${material.quantity} ${material.unit}) dla ${order.name}`);
    });

    globalResults.ordersProcessed++;
  });

  // Zapisz stan magazynu
  saveWarehouseToStorage();
  
  console.log('üíæ Stan zapisany, rezerwacji w localStorage:', window.warehouseReservations.length);
  
  // Prze≈ÇƒÖcz na zak≈Çadkƒô Rezerwacje i od≈õwie≈º widok
  if (typeof switchWarehouseTab === 'function') {
    console.log('üîÑ Prze≈ÇƒÖczam na zak≈Çadkƒô Rezerwacje...');
    switchWarehouseTab('reservations');
  } else if (typeof renderReservations === 'function') {
    console.log('üîÑ Od≈õwie≈ºam widok rezerwacji...');
    renderReservations();
  }
  
  // Od≈õwie≈º tabelƒô zlece≈Ñ (je≈õli jest dostƒôpna)
  try {
    if (typeof renderOrderPage === 'function') {
      renderOrderPage();
    }
  } catch (e) {
    // ignoruj b≈Çƒôdy scope
  }

  // Poka≈º globalny raport
  showGlobalReservationReport(globalResults, ordersToProcess.length);
}

// Poka≈º globalny raport z rezerwacji dla wszystkich zlece≈Ñ
function showGlobalReservationReport(results, totalOrders) {
  let html = '<div style="font-family:system-ui,-apple-system,sans-serif">';

  html += `
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px;margin-bottom:20px">
      <strong>Przetworzono zlece≈Ñ:</strong> ${results.ordersProcessed} / ${totalOrders}
    </div>
  `;

  // Sekcja: Zarezerwowano
  if (results.reserved.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#16a34a;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚úÖ</span>
          <span>Zarezerwowano (${results.reserved.length})</span>
        </h4>
        <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:10px;max-height:300px;overflow-y:auto">
          ${results.reserved.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #86efac40;font-size:13px">
              <strong>${r.name}</strong> - ${r.quantity} ${r.unit}
              <div style="color:#059669;font-size:11px">Zlecenie: ${r.orderName}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Sekcja: NiewystarczajƒÖca ilo≈õƒá
  if (results.insufficient.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#f59e0b;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚ö†Ô∏è</span>
          <span>NiewystarczajƒÖca ilo≈õƒá (${results.insufficient.length})</span>
        </h4>
        <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:6px;padding:10px;max-height:300px;overflow-y:auto">
          ${results.insufficient.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #fcd34d40;font-size:13px">
              <strong>${r.name}</strong><br>
              <span style="font-size:12px;color:#92400e">
                Potrzeba: ${r.needed} ${r.unit} | Dostƒôpne: ${r.available} ${r.unit}
              </span>
              <div style="color:#b45309;font-size:11px">Zlecenie: ${r.orderName}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Sekcja: Nie znaleziono
  if (results.notFound.length > 0) {
    html += `
      <div style="margin-bottom:20px">
        <h4 style="color:#dc2626;margin:0 0 10px 0;display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">‚ùå</span>
          <span>Nie znaleziono w magazynie (${results.notFound.length})</span>
        </h4>
        <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:10px;max-height:300px;overflow-y:auto">
          ${results.notFound.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid #fca5a540;font-size:13px">
              <strong>${r.name}</strong> - ${r.needed} ${r.unit}
              <div style="color:#dc2626;font-size:11px">Zlecenie: ${r.orderName}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  html += '</div>';

  showModal('üìä Raport masowej rezerwacji', html, [
    { text: 'OK', action: () => {
      // Od≈õwie≈º widok rezerwacji
      if (typeof renderReservations === 'function') {
        renderReservations();
      }
    }}
  ]);
}

// Migracja starych szablon√≥w (naprawa b≈Çƒôdnych ID)
function migrateTemplateIds() {
  console.log('üîß Rozpoczynam migracjƒô szablon√≥w materia≈Çowych...');
  
  if (!window.materialTemplates || window.materialTemplates.length === 0) {
    console.log('‚ÑπÔ∏è Brak szablon√≥w do migracji');
    return { migrated: 0, failed: 0 };
  }

  let migratedCount = 0;
  let failedCount = 0;

  window.materialTemplates.forEach(template => {
    console.log(`üìã Sprawdzam szablon: ${template.name}`);
    
    let templateChanged = false;

    template.materials.forEach((material, idx) => {
      // Sprawd≈∫ czy itemId to liczba ma≈Ça (prawdopodobnie indeks)
      if (typeof material.itemId === 'number' && material.itemId < 1000) {
        // Spr√≥buj znale≈∫ƒá materia≈Ç po nazwie
        const matchingItem = (window.warehouseItems || []).find(w => w.name === material.itemName);
        
        if (matchingItem) {
          console.log(`‚úÖ Naprawiam: ${material.itemName} (${material.itemId} ‚Üí ${matchingItem.id})`);
          material.itemId = matchingItem.id;
          templateChanged = true;
        } else {
          console.warn(`‚ö†Ô∏è Nie znaleziono materia≈Çu: ${material.itemName}`);
          failedCount++;
        }
      }
    });

    if (templateChanged) {
      migratedCount++;
      template.migratedAt = Date.now();
    }
  });

  if (migratedCount > 0) {
    saveWarehouseToStorage();
    console.log(`‚úÖ Zmigrowano ${migratedCount} szablon√≥w`);
  }

  if (failedCount > 0) {
    console.warn(`‚ö†Ô∏è Nie uda≈Ço siƒô naprawiƒá ${failedCount} materia≈Ç√≥w`);
  }

  return { migrated: migratedCount, failed: failedCount };
}

// Diagnoza szablon√≥w - poka≈º szczeg√≥≈Çy
function diagnoseShablon() {
  let html = '<div style="font-family:monospace;font-size:12px">';
  
  html += '<h3>üìä Diagnoza szablon√≥w materia≈Çowych</h3>';
  
  html += `<p><strong>Liczba szablon√≥w:</strong> ${(window.materialTemplates || []).length}</p>`;
  html += `<p><strong>Liczba pozycji magazynowych:</strong> ${(window.warehouseItems || []).length}</p><hr>`;
  
  (window.materialTemplates || []).forEach((template, idx) => {
    html += `<div style="margin-bottom:20px;padding:10px;background:#f0f0f0;border-radius:6px">`;
    html += `<h4>Szablon #${idx + 1}: "${template.name}"</h4>`;
    html += `<p><strong>ID szablonu:</strong> ${template.id}</p>`;
    html += `<p><strong>Liczba materia≈Ç√≥w:</strong> ${template.materials.length}</p>`;
    
    template.materials.forEach((mat, matIdx) => {
      const warehouseItem = (window.warehouseItems || []).find(w => w.id === mat.itemId);
      const status = warehouseItem ? '‚úÖ OK' : '‚ùå NIE ZNALEZIONO';
      const color = warehouseItem ? '#16a34a' : '#dc2626';
      
      html += `<div style="margin:5px 0;padding:5px;background:white;border-left:3px solid ${color}">`;
      html += `<strong>${matIdx + 1}. ${mat.itemName}</strong><br>`;
      html += `itemId: <code>${mat.itemId}</code> (typ: ${typeof mat.itemId})<br>`;
      html += `ilo≈õƒá: ${mat.quantity} ${mat.unit}<br>`;
      html += `<span style="color:${color}">${status}</span>`;
      
      if (!warehouseItem && typeof mat.itemId === 'number' && mat.itemId < 100) {
        html += `<br><span style="color:#f59e0b">‚ö†Ô∏è To wyglƒÖda na indeks (${mat.itemId}), a nie ID!</span>`;
        
        // Spr√≥buj znale≈∫ƒá po nazwie
        const byName = (window.warehouseItems || []).find(w => w.name === mat.itemName);
        if (byName) {
          html += `<br><span style="color:#059669">üí° Znaleziono w magazynie po nazwie! Prawdziwe ID: ${byName.id}</span>`;
        }
      }
      
      html += '</div>';
    });
    
    html += '</div>';
  });
  
  html += '</div>';
  
  showModal('üîç Diagnoza szablon√≥w', html, [
    { text: 'Zamknij', action: () => {} }
  ]);
}

// Automatyczna migracja przy starcie (je≈õli potrzebna)
function autoMigrateIfNeeded() {
  // Sprawd≈∫ czy sƒÖ szablony do migracji
  const needsMigration = (window.materialTemplates || []).some(template => 
    template.materials.some(m => typeof m.itemId === 'number' && m.itemId < 1000 && !template.migratedAt)
  );

  if (needsMigration) {
    console.log('üîç Wykryto stare szablony, uruchamiam migracjƒô...');
    const result = migrateTemplateIds();
    
    if (result.migrated > 0) {
      alert(`‚úÖ Automatycznie naprawiono ${result.migrated} szablon√≥w materia≈Çowych.\n\nTwoje szablony zosta≈Çy zaktualizowane i teraz u≈ºywajƒÖ poprawnych ID z magazynu.`);
    }
    
    if (result.failed > 0) {
      alert(`‚ö†Ô∏è ${result.failed} materia≈Ç√≥w nie uda≈Ço siƒô naprawiƒá.\n\nNie znaleziono ich w magazynie. Sprawd≈∫ czy wszystkie materia≈Çy z szablon√≥w istniejƒÖ w zak≈Çadce "Pozycje".`);
    }
  }
}

// Przypisz funkcje do window
window.showMaterialChecklist = showMaterialChecklist;
window.toggleChecklistItem = toggleChecklistItem;
window.autoReserveFromChecklist = autoReserveFromChecklist;
window.autoReserveForOrders = autoReserveForOrders;
window.migrateTemplateIds = migrateTemplateIds;
window.diagnoseShablon = diagnoseShablon;

// Od≈õwie≈º wszystkie checklisty zlece≈Ñ z szablon√≥w
function refreshAllChecklists() {
  if (!confirm('‚ö†Ô∏è To usunie wszystkie stare checklisty i wygeneruje je na nowo z aktualnych szablon√≥w.\n\nKontynuowaƒá?')) {
    return;
  }
  
  console.log('‚ôªÔ∏è Od≈õwie≈ºam checklisty dla wszystkich zlece≈Ñ...');
  
  let refreshed = 0;
  let skipped = 0;
  let errors = 0;
  
  (state.orders || []).forEach(order => {
    if (!order.processId) {
      skipped++;
      return;
    }
    
    const process = (state.processes || []).find(p => p.id === order.processId);
    if (!process || !process.materialTemplateId) {
      skipped++;
      return;
    }
    
    const template = (window.materialTemplates || []).find(t => t.id === process.materialTemplateId);
    if (!template) {
      console.warn(`‚ö†Ô∏è Nie znaleziono szablonu ${process.materialTemplateId} dla procesu ${process.name}`);
      errors++;
      return;
    }
    
    // Usu≈Ñ stary checklist i utw√≥rz nowy
    order.materialChecklist = template.materials.map((m) => ({
      itemId: m.itemId,
      itemName: m.itemName,
      quantity: m.quantity,
      unit: m.unit,
      checked: false,
      checkedAt: null,
      checkedBy: null
    }));
    
    refreshed++;
    console.log(`‚úÖ Od≈õwie≈ºono checklist dla zlecenia: ${order.name}`);
  });
  
  if (refreshed > 0) {
    save();
    alert(`‚úÖ Od≈õwie≈ºono ${refreshed} checklist√≥w\n‚è≠Ô∏è Pominiƒôto: ${skipped}\n‚ùå B≈Çƒôdy: ${errors}\n\nChecklisty zosta≈Çy wygenerowane na nowo z aktualnych szablon√≥w.`);
  } else {
    alert(`‚ÑπÔ∏è Nie znaleziono checklist√≥w do od≈õwie≈ºenia.\n‚è≠Ô∏è Pominiƒôto: ${skipped}\n‚ùå B≈Çƒôdy: ${errors}`);
  }
}

window.refreshAllChecklists = refreshAllChecklists;

// Uruchom auto-migracjƒô po za≈Çadowaniu
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(autoMigrateIfNeeded, 1000);
  });
} else {
  setTimeout(autoMigrateIfNeeded, 1000);
}

// Funkcje synchronizacji z aplikacjƒÖ pracownik√≥w
function exportTasksForWorkers() {
  // Przyk≈Çadowe zadania - w rzeczywisto≈õci nale≈ºy zebraƒá z systemu MRP
  const sampleTasks = [
    {
      id: 1,
      title: "Ciƒôcie drzwi #1234",
      model: "DREWNO-001",
      quantity: 5,
      unit: "szt",
      deadline: "14:00",
      status: "pending",
      estimatedTime: 120,
      priority: "high",
      assignedTo: "Jan Kowalski"
    },
    {
      id: 2,
      title: "Monta≈º okuƒá #1235",
      model: "DREWNO-002",
      quantity: 3,
      unit: "szt",
      deadline: "16:00",
      status: "pending",
      estimatedTime: 90,
      priority: "medium",
      assignedTo: "Anna Nowak"
    },
    {
      id: 3,
      title: "Lakierowanie #1236",
      model: "DREWNO-003",
      quantity: 8,
      unit: "szt",
      deadline: "12:00",
      status: "pending",
      estimatedTime: 180,
      priority: "high",
      assignedTo: "Piotr Wi≈õniewski"
    }
  ];

  const exportData = {
    exportDate: new Date().toISOString(),
    tasks: sampleTasks,
    version: "1.0",
    system: "Doors Planner Admin"
  };

  const jsonContent = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'tasks-export.json');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  alert('üì§ Plik tasks-export.json zosta≈Ç pobrany.\n\nPrzenie≈õ go na urzƒÖdzenie pracownika i zaimportuj w aplikacji Worker App.');
}

function importWorkerConfirmations() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';

  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);

        if (data.confirmations && Array.isArray(data.confirmations)) {
          let importedCount = 0;
          let completedCount = 0;

          data.confirmations.forEach(confirmation => {
            console.log('Import potwierdzenia:', confirmation);
            importedCount++;

            if (confirmation.status === 'completed') {
              completedCount++;
            }

            // Tutaj nale≈ºy zaktualizowaƒá zadania w g≈Ç√≥wnym systemie
            // Na razie tylko logujemy
          });

          alert(`‚úÖ Zaimportowano ${importedCount} potwierdze≈Ñ zada≈Ñ\n` +
                `üìä Uko≈Ñczonych zada≈Ñ: ${completedCount}\n\n` +
                `Szczeg√≥≈Çy w konsoli przeglƒÖdarki.`);

        } else if (data.tasks && Array.isArray(data.tasks)) {
          // To mo≈ºe byƒá plik eksportu zada≈Ñ zamiast potwierdze≈Ñ
          alert('To wyglƒÖda na plik eksportu zada≈Ñ, a nie potwierdze≈Ñ.\n\n' +
                'U≈ºyj funkcji "Importuj zadania" w aplikacji Worker App.');
        } else {
          alert('‚ùå Nieprawid≈Çowy format pliku.\n\n' +
                'Oczekiwany format: {"confirmations": [...]}');
        }
      } catch (error) {
        alert('‚ùå B≈ÇƒÖd podczas parsowania pliku:\n' + error.message);
      }
    };

    reader.readAsText(file);
  };

  input.click();
}

function exportWarehouseToCSV() {
  if (!window.warehouseItems || window.warehouseItems.length === 0) {
    alert('Brak pozycji do eksportu');
    return;
  }

  const csvContent = 'Nazwa,Ilo≈õƒá,Jednostka,Cena,Stan minimalny\n' +
    window.warehouseItems.map(item =>
      `"${item.name}",${item.quantity},"${item.unit}",${item.price},${item.minStock || 0}`
    ).join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'magazyn.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function toggleOrderFilter() {
  window.showOnlyLowStock = !window.showOnlyLowStock;
  const button = document.querySelector('button[onclick="toggleOrderFilter()"]');
  if (button) {
    button.textContent = window.showOnlyLowStock ? 'üî¥ Do zam√≥wienia (W≈ÅƒÑCZONE)' : 'üî¥ Do zam√≥wienia';
    button.className = window.showOnlyLowStock ? 'btn red' : 'btn orange';
  }
  renderWarehouse();
}

function renderWarehouse() {
  const list = document.getElementById('wh-list');
  if (!list) return;
  
  const searchTerm = document.getElementById('wh-search')?.value.toLowerCase() || '';
  let filteredItems = window.warehouseItems.filter(item => 
    item.name.toLowerCase().includes(searchTerm)
  );
  
  // Pobierz obciƒÖ≈ºenia dla wszystkich materia≈Ç√≥w
  const obligations = calculateWarehouseObligations();
  const obligationsMap = {};
  obligations.forEach(o => {
    obligationsMap[o.name] = o;
  });
  
  // Dodatkowe filtrowanie dla pozycji do zam√≥wienia
  if (window.showOnlyLowStock) {
    filteredItems = filteredItems.filter(item => {
      const obl = obligationsMap[item.name];
      return obl && (obl.available < 0 || obl.available < obl.minStock);
    });
  }
  
  if (filteredItems.length === 0) {
    const message = window.showOnlyLowStock 
      ? 'Brak pozycji do zam√≥wienia (wszystkie majƒÖ wystarczajƒÖcy stan).'
      : 'Brak pozycji spe≈ÇniajƒÖcych kryteria wyszukiwania.';
    list.innerHTML = `<div style="text-align:center;padding:40px;color:#999">${message}</div>`;
    return;
  }
  
  // TABELA zamiast kart
  const tableHtml = `
    <table style="width:100%;border-collapse:collapse;background:#2c3e50;box-shadow:0 1px 3px rgba(0,0,0,0.3)">
      <thead>
        <tr style="background:#34495e;border-bottom:2px solid #1a252f">
          <th style="padding:12px;text-align:left;font-weight:700;font-size:14px;color:#ffffff !important">Nazwa</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:100px">Stan mag.</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:100px">Zarezerwowane</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:100px">Dostƒôpne</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:80px">Jedn.</th>
          <th style="padding:12px;text-align:right;font-weight:700;font-size:14px;color:#ffffff !important;width:100px">Cena (z≈Ç)</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:80px">Min</th>
          <th style="padding:12px;text-align:left;font-weight:700;font-size:14px;color:#ffffff !important;width:180px">üìç Lokalizacja</th>
          <th style="padding:12px;text-align:center;font-weight:700;font-size:14px;color:#ffffff !important;width:180px">Akcje</th>
        </tr>
      </thead>
      <tbody>
        ${filteredItems.map((item, index) => {
          const qtyValue = typeof item.quantity === 'number' ? item.quantity : Number(item.quantity || 0);
          const priceValue = typeof item.price === 'number' ? item.price : Number(item.price || 0);
          const hasMinStock = item.minStock !== undefined && item.minStock !== null && item.minStock !== '';
          const minStockValue = hasMinStock ? Number(item.minStock) : null;
          
          // Pobierz obciƒÖ≈ºenia dla tej pozycji
          const obl = obligationsMap[item.name] || { reserved: 0, available: qtyValue };
          const availableQty = obl.available;
          const reservedQty = obl.reserved;
          
          // Okre≈õl kolor wiersza na podstawie dostƒôpnych stan√≥w
          const isNegative = availableQty < 0;
          const isLowStock = !isNegative && hasMinStock && availableQty <= minStockValue;
          const rowStyle = isNegative ? 'background:#c0392b' : 
                           isLowStock ? 'background:#e67e22' : 
                           (index % 2 === 0 ? 'background:#34495e' : 'background:#2c3e50');

          const qtyDisplay = Number.isFinite(qtyValue) ? qtyValue : '-';
          const reservedDisplay = Number.isFinite(reservedQty) ? reservedQty : '-';
          const availableDisplay = Number.isFinite(availableQty) ? availableQty : '-';
          const priceDisplay = Number.isFinite(priceValue) ? priceValue.toFixed(2) : '-';
          const minStockDisplay = hasMinStock && Number.isFinite(minStockValue) ? minStockValue : '-';

          const location = item.location || {};
          let locationStr = '-';
          if (location.shelf || location.rack || location.sector) {
            const parts = [];
            if (location.shelf) parts.push(`R:${location.shelf}`);
            if (location.rack) parts.push(`P:${location.rack}`);
            if (location.sector) parts.push(`S:${location.sector}`);
            locationStr = parts.join(' ‚Ä¢ ');
          }
          
          const statusText = isNegative ? '‚ö†Ô∏è BRAK - ZAM√ìW!' : isLowStock ? '‚ö†Ô∏è DO ZAM√ìWIENIA' : '';
          const availableColor = isNegative ? '#ff1744' : isLowStock ? '#ffeb3b' : '#4caf50';
          
          return `
            <tr style="${rowStyle};border-bottom:1px solid #1a252f">
              <td style="padding:12px">
                <div style="font-weight:600;font-size:15px;color:#ffffff !important">${item.name}</div>
                ${statusText ? `<div style="font-size:12px;color:#ffeb3b !important;font-weight:700;margin-top:2px">${statusText}</div>` : ''}
              </td>
              <td style="padding:12px;text-align:center;font-weight:700;font-size:15px;color:#ffffff !important">${qtyDisplay}</td>
              <td style="padding:12px;text-align:center;font-weight:600;font-size:14px;color:#fbbf24 !important">${reservedDisplay}</td>
              <td style="padding:12px;text-align:center;font-weight:700;font-size:16px;color:${availableColor} !important">${availableDisplay}</td>
              <td style="padding:12px;text-align:center;font-size:14px;color:#ffffff !important">${item.unit || '-'}</td>
              <td style="padding:12px;text-align:right;font-weight:600;font-size:14px;color:#ffffff !important">${priceDisplay}</td>
              <td style="padding:12px;text-align:center;font-size:14px;color:#ffffff !important">${minStockDisplay}</td>
              <td style="padding:12px;font-size:14px;color:#ffffff !important">${locationStr}</td>
              <td style="padding:12px;text-align:center">
                <div style="display:flex;gap:4px;justify-content:center">
                  <button class="btn small" onclick="editWarehouseItem(${window.warehouseItems.indexOf(item)})" style="padding:6px 12px;font-size:13px">Edytuj</button>
                  <button class="btn red small" onclick="deleteWarehouseItem(${window.warehouseItems.indexOf(item)})" style="padding:6px 12px;font-size:13px">Usu≈Ñ</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
  
  list.innerHTML = tableHtml;
  
  // Zaktualizuj badge obciƒÖ≈ºe≈Ñ
  if (typeof window.updateObligationsBadge === 'function') {
    updateObligationsBadge();
  }
}

// Dodaj event listener po za≈Çadowaniu DOM
let _warehouseUIBound = false;

function bindWarehouseUIEvents(){
  const addBtn = document.getElementById('wh-add');
  if (addBtn && !addBtn.dataset.whBound) {
    addBtn.addEventListener('click', addWarehouseItem);
    addBtn.dataset.whBound = 'true';
  } else if (!addBtn) {
    console.warn('[warehouse] Nie znaleziono przycisku dodawania (wh-add) podczas wiƒÖzania UI.');
  }

  const searchInput = document.getElementById('wh-search');
  if (searchInput && !searchInput.dataset.whBound) {
    searchInput.addEventListener('input', renderWarehouse);
    searchInput.dataset.whBound = 'true';
  }
}

function initializeWarehouseUI(){
  if (!_warehouseUIBound) {
    try {
      if (typeof loadWarehouseFromStorage === 'function') {
        loadWarehouseFromStorage();
      }
    } catch (warehouseInitErr) {
      console.warn('[warehouse] loadWarehouseFromStorage() zako≈Ñczone b≈Çƒôdem podczas inicjalizacji UI:', warehouseInitErr && warehouseInitErr.message);
    }
    window.showOnlyLowStock = false;
    _warehouseUIBound = true;
  }
  bindWarehouseUIEvents();
}

document.addEventListener('DOMContentLoaded', () => {
  initializeWarehouseUI();
});

if (document.readyState === 'interactive' || document.readyState === 'complete') {
  setTimeout(initializeWarehouseUI, 0);
}

// Automatyczne renderowanie przy wej≈õciu do zak≈Çadki
document.addEventListener('click', (e) => {
  if (e.target.matches('[data-nav="wh"]')) {
    setTimeout(renderWarehouse, 100);
  }
});

// Funkcja do generowania testowych zam√≥wie≈Ñ z terminami
function generateDeadlineTestOrders() {
  const today = new Date();
  const testOrders = [
    {
      id: 'test-order-1',
      name: 'Drzwi wej≈õciowe dƒÖb',
      client: 'Firma ABC Sp. z o.o.',
      model: 'DƒÖb Classic',
      quantity: 5,
      startDate: today.toISOString().slice(0, 10),
      endDate: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), // Za 2 dni
      processId: 'proc1'
    },
    {
      id: 'test-order-2',
      name: 'Drzwi wewnƒôtrzne sosna',
      client: 'Dom prywatny Kowalski',
      model: 'Sosna Light',
      quantity: 3,
      startDate: today.toISOString().slice(0, 10),
      endDate: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), // Za 5 dni
      processId: 'proc2'
    },
    {
      id: 'test-order-3',
      name: 'Drzwi balkonowe',
      client: 'Blok mieszkalny',
      model: 'Balkon Plus',
      quantity: 8,
      startDate: today.toISOString().slice(0, 10),
      endDate: new Date(today.getTime() + 8 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), // Za 8 dni
      processId: 'proc1'
    },
    {
      id: 'test-order-4',
      name: 'Drzwi techniczne',
      client: 'Przedsiƒôbiorstwo XYZ',
      model: 'Techniczne Pro',
      quantity: 2,
      startDate: today.toISOString().slice(0, 10),
      endDate: new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), // Wczoraj (przekroczony termin)
      processId: 'proc2'
    }
  ];

  // Dodaj zam√≥wienia tylko je≈õli nie istniejƒÖ
  testOrders.forEach(order => {
    if (!(state.orders || []).some(o => o.id === order.id)) {
      state.orders = state.orders || [];
      state.orders.push(order);
    }
  });

  save();
  renderOrderPage();
  renderDash(window.state || state);
  renderGantt();

  alert('‚úÖ Dodano testowe zam√≥wienia z r√≥≈ºnymi terminami!\n\nSprawd≈∫ sekcjƒô powiadomie≈Ñ w dashboardzie.');
}

// Dodaj event listener dla przycisku generowania testowych zam√≥wie≈Ñ
document.addEventListener('DOMContentLoaded', () => {
  const genDeadlineBtn = document.getElementById('gen-deadline-test');
  if (genDeadlineBtn) {
    genDeadlineBtn.addEventListener('click', generateDeadlineTestOrders);
  }
  
  // Wykryj port i poka≈º ostrze≈ºenie o osobnych danych
  try {
    const currentPort = window.location.port;
    const banner = document.getElementById('port-warning-banner');
    const portSpan = document.getElementById('current-port');
    const detailSpan = document.getElementById('port-warning-detail');
    const storageKey = window.storeKey || 'door_v50_state';

    if (banner && portSpan && detailSpan) {
      const friendlyPort = currentPort ? currentPort : 'brak (plik lokalny)';
      portSpan.textContent = friendlyPort;

      const storedState = localStorage.getItem(storageKey);
      let dataCount = 0;
      if (storedState) {
        try {
          const parsed = JSON.parse(storedState);
          dataCount = Array.isArray(parsed?.orders) ? parsed.orders.length : 0;
        } catch(parseErr) {
          console.warn('B≈ÇƒÖd parsowania danych magazynu dla banera portu:', parseErr);
        }
      }

      let detailHtml = '';

      if (!currentPort) {
        detailHtml = 'Otwierasz plik lokalny (<strong>brak portu</strong>) ‚Äî dane mogƒÖ siƒô nie synchronizowaƒá. <strong>Uruchom plik przez serwer (np. Five Server), aby u≈ºywaƒá tych samych danych co reszta zespo≈Çu.</strong>';
      } else if (currentPort === '5500') {
        detailHtml = 'Aplikacja dzia≈Ça na domy≈õlnym porcie <strong>5500</strong>. To osobny magazyn danych od innych port√≥w ‚Äî upewnij siƒô, ≈ºe wszyscy korzystajƒÖ z tego samego portu.';
      } else {
        detailHtml = `Aplikacja na porcie <strong>${friendlyPort}</strong> ma <strong>osobne dane</strong> ni≈º instancja na porcie 5500.`;
      }

      if (dataCount === 0) {
        detailHtml += ' <strong style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:3px">‚ö†Ô∏è Brak zlece≈Ñ ‚Äî sprawd≈∫, czy to w≈Ça≈õciwy port lub zaimportuj backup.</strong>';
      }

      detailSpan.innerHTML = detailHtml;
      banner.style.display = 'block';
      console.log('‚ö†Ô∏è OSTRZE≈ªENIE: Port', friendlyPort, '| Zlece≈Ñ:', dataCount);
    }
  } catch(e) {
    console.warn('B≈ÇƒÖd wykrywania portu:', e);
  }
});

// ============================================
// AUTOMATYCZNA SYNCHRONIZACJA Z BAZƒÑ DANYCH
// ============================================
function startAutoSync() {
  // Automatyczna synchronizacja co 30 sekund
  setInterval(() => {
    if (state.storage.mode === 'firebase') {
      const guardValue = resolveSkipAutoSaveGuard();
      if(guardValue && Date.now() < guardValue){
        if(window.logDev || Math.random() < 0.1){ console.log('Auto-sync skipped (recent remote update)'); }
        return;
      }
      const lastRemoteSync = state.storage.lastRemoteSync || 0;
      const lastModifiedLocal = state.lastModified || 0;
      if(lastModifiedLocal <= lastRemoteSync){
        if(window.logDev || Math.random() < 0.1){ console.log('Auto-sync skipped (no pending local changes)'); }
        return;
      }
      console.log('üîÑ Auto-sync: Synchronizujƒô z bazƒÖ danych...');
      saveToDB().then(() => {
        console.log('‚úÖ Auto-sync: Zako≈Ñczono pomy≈õlnie');
      }).catch(err => {
        console.warn('‚ö†Ô∏è Auto-sync: B≈ÇƒÖd synchronizacji:', err);
      });
    }
  }, 30000); // 30 sekund
}

// Uruchom auto-sync po za≈Çadowaniu strony
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(startAutoSync, 5000); // Poczekaj 5s na inicjalizacjƒô
  });
} else {
  setTimeout(startAutoSync, 5000);
}

// ============================================
// GRUPOWANIE ZADA≈É W ZAK≈ÅADCE LISTY
// ============================================
window._taskGroupsCollapsed = window._taskGroupsCollapsed || {};

function renderTasksGrouped(tasks, groupBy) {
  const list = qs('#tasks-list');
  if (!list) return;
  
  // Grupuj zadania z unikalnym identyfikatorem grupy
  const groups = new Map();
  tasks.forEach(t => {
    let groupKey = 'all';
    let groupLabel = 'Wszystkie';

    switch(groupBy) {
      case 'order': {
        const order = (state.orders || []).find(o => o.id === t.orderId);
        const id = order ? order.id : 'none';
        groupKey = `order:${id}`;
        groupLabel = order ? order.name : '(Brak zlecenia)';
        break;
      }
      case 'status': {
        const statusMap = { 'todo': 'Do zrobienia', 'run': 'W realizacji', 'done': 'Zamkniƒôte' };
        const statusKey = t.status || 'todo';
        groupKey = `status:${statusKey}`;
        groupLabel = statusMap[statusKey] || statusKey;
        break;
      }
      case 'assignee': {
        const empId = t.assignee || (Array.isArray(t.assignees) ? t.assignees[0] : null) || 'none';
        const employee = (state.employees || []).find(e => e.id === (empId && empId.id ? empId.id : empId));
        const resolvedId = employee ? employee.id : (empId && empId.id ? empId.id : empId);
        groupKey = `assignee:${resolvedId || 'none'}`;
        groupLabel = employee ? employee.name : '(Nieprzypisane)';
        break;
      }
      default:
        groupKey = 'all';
        groupLabel = 'Wszystkie';
    }

    if (!groups.has(groupKey)) {
      groups.set(groupKey, { label: groupLabel, tasks: [] });
    }
    groups.get(groupKey).tasks.push(t);
  });
  
  // Renderuj grupy
  list.innerHTML = '';
  Array.from(groups.entries())
    .sort((a, b) => a[1].label.localeCompare(b[1].label, 'pl'))
    .forEach(([groupKey, data]) => {
      const { label: groupName, tasks: groupTasks } = data;
      const groupId = ('group-' + groupKey).replace(/[^a-z0-9]/gi, '-');
      const isCollapsed = window._taskGroupsCollapsed[groupId] || false;
    
    // Nag≈Ç√≥wek grupy
    const groupHeader = document.createElement('div');
    groupHeader.className = 'card';
    groupHeader.style.cursor = 'pointer';
    groupHeader.style.marginBottom = '4px';
    groupHeader.style.background = 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)';
    groupHeader.innerHTML = `
      <div class="row" style="justify-content: space-between; align-items: center;">
        <div>
          <span data-group-arrow style="display:inline-block;width:16px">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
          <b>${groupName}</b>
          <span class="muted" style="margin-left: 12px">(${groupTasks.length} zada≈Ñ)</span>
        </div>
      </div>
    `;

    const tasksContainer = document.createElement('div');
    tasksContainer.className = 'group-tasks-container';
    tasksContainer.style.display = isCollapsed ? 'none' : 'block';
    groupTasks.forEach(t => {
      const taskCard = createTaskCard(t);
      tasksContainer.appendChild(taskCard);
    });

    groupHeader.addEventListener('click', (e) => {
      e.stopPropagation();
      const current = !!window._taskGroupsCollapsed[groupId];
      const next = !current;
      window._taskGroupsCollapsed[groupId] = next;
      const arrowEl = groupHeader.querySelector('[data-group-arrow]');
      if(arrowEl){ arrowEl.textContent = next ? '‚ñ∂' : '‚ñº'; }
      tasksContainer.style.display = next ? 'none' : 'block';
    });

    list.appendChild(groupHeader);
    list.appendChild(tasksContainer);
  });
}

function createTaskCard(t) {
  const d = document.createElement('div');
  d.className = 'card';
  d.style.marginLeft = '20px';
  
  const syncBadge = (tt)=>{ try{ if(tt._syncPending) return `<span class="task-sync-status pending" title="Czekaj na synchronizacjƒô">‚è≥</span>`; if(tt._syncError) return `<span class="task-sync-status error" title="B≈ÇƒÖd synchronizacji">‚ö†Ô∏è</span>`; if(tt._lastSync) return `<span class="task-sync-status ok" title="Ostatnia synchronizacja: ${new Date(tt._lastSync).toLocaleString()}">‚úîÔ∏è</span>`; return `<span class="task-sync-status unknown" title="Brak synchronizacji">‚Äî</span>`; }catch(e){return''} };
  
  const sb = syncBadge(t);
  const startP = t.startPlanned ? new Date(t.startPlanned).toLocaleString() : '-';
  const endP = t.endPlanned ? new Date(t.endPlanned).toLocaleString() : '-';
  const plannedDur = (t.startPlanned && t.endPlanned) ? Math.round((t.endPlanned - t.startPlanned)/60000)+'m' : '-';
  const orderName = (state.orders || []).find(o => o.id === t.orderId)?.name || '-';
  const fallbackAssignmentInfo = (task)=>{
    try {
      let assignees = task.assignees;
      if (!Array.isArray(assignees) || assignees.length === 0) {
        if (task.assignee) assignees = [task.assignee];
        else if (task.employeeId) assignees = [task.employeeId];
        else assignees = [];
      }
      if (!assignees.length) {
        return `<span class="muted" style="font-size:12px">‚ö†Ô∏è Nieprzypisane</span>`;
      }
      const first = assignees[0];
      const employeeId = typeof first === 'object' ? first.id || first.employeeId : first;
      const employee = (state.employees || []).find(e => e.id === employeeId);
      const empName = employee ? employee.name : employeeId;
      return `<span style="font-size:12px">üë§ ${empName}</span>`;
    } catch(err){
      console.warn('[createTaskCard] fallback assignment error', err);
      return '';
    }
  };
  const assignmentFormatter = (typeof formatTaskAssignmentInfo === 'function')
    ? formatTaskAssignmentInfo
    : (typeof window !== 'undefined' && typeof window.formatTaskAssignmentInfo === 'function')
      ? window.formatTaskAssignmentInfo
      : fallbackAssignmentInfo;
  let assignmentHtml = '';
  try {
    assignmentHtml = assignmentFormatter(t);
  } catch(err){
    console.warn('[createTaskCard] assignment formatter error', err && err.message);
    assignmentHtml = fallbackAssignmentInfo(t);
  }
  d.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>${t.opName || t.name || '(zadanie)'} ${sb}</b> 
        <span class="muted">
          ${orderName}
          ${t.processName ? ` ‚Ä¢ Proces: ${t.processName} (${t.opIndex + 1}/${(state.processes.find(p=>p.id===t.processId)?.operations||[]).length})` : ''}
        </span>
        <div>${assignmentHtml}</div>
        <div class="muted">Status: ${t.status || 'todo'} ‚Ä¢ Plan: ${plannedDur} ‚Ä¢ Real: ${Math.round(t.elapsedMin || 0)}m ${typeof t.slackMs==='number'?('‚Ä¢ Slack: '+Math.round(t.slackMs/60000)+'m'):''} ${t.critical?'‚Ä¢ CRITICAL':''}</div>
        <div class="muted">StartP: ${startP} ‚Ä¢ EndP: ${endP}</div>
        <div class="muted">${t.startedBy?('RozpoczƒÖ≈Ç: '+t.startedBy):''} ${t.closedBy?('ZamknƒÖ≈Ç: '+t.closedBy):''} ${t.startedAt?(' ‚Ä¢ start: '+(new Date(t.startedAt)).toLocaleTimeString()):''}</div>
      </div>
      <div class="row">
        <button class="${t.status === 'run' ? 'btn green' : 'btn gray'}" data-task-start="${t.id}" ${t.status === 'run' ? 'disabled' : ''}>Start</button>
        <button class="btn" data-task-pause="${t.id}" ${t.status !== 'run' ? 'disabled' : ''}>Pauza</button>
        <button class="btn amber" data-task-repeat="${t.id}">Powt√≥rz</button>
        <button class="${t.status === 'done' ? 'btn green' : 'btn gray'}" data-task-done="${t.id}" ${t.status === 'done' ? 'disabled' : ''}>Zamknij</button>
        ${t._syncError?`<button class="btn amber" data-task-retry="${t.id}" title="Pon√≥w synchronizacjƒô">Retry</button>`:''}
      </div>
    </div>
  `;
  
  return d;
}

console.log('‚úÖ Zainicjalizowano: Auto-sync + Grupowanie zada≈Ñ');
</script>

<!-- ============================================================================ -->
<!-- FIREBASE SYNC QUEUE - Niezawodna synchronizacja -->
<!-- ============================================================================ -->
<script src="js/firebase-sync-queue.js"></script>

<!-- ============================================================================ -->
<!-- DEVLOG PANEL FOR DEVELOPERS -->
<!-- ============================================================================ -->
<script src="js/devlog-panel.js"></script>
<script>
(function(){
  if(typeof DevLogPanel === 'undefined') {
    console.warn('DevLogPanel script missing');
    return;
  }

  const devLogConfig = {
    maxEntries: 100,
    captureConsole: true,
    sendLogsUrl: (window.state && window.state.settings && window.state.settings.devlogEndpoint) || null,
    sendLogsHeaders: {
      'Content-Type': 'application/json'
    },
    autoErrorWebhookUrl: (window.state && window.state.settings && window.state.settings.devlogWebhook) || null,
    autoErrorLevels: ['error'],
    autoErrorSampleRate: 1,
    autoSendCooldownMs: 2000,
    sentry: window.Sentry || null,
    sentryLevelMap: { info: 'info', warning: 'warning', error: 'error' },
    monitoringAdapter(entry) {
      if(entry.level === 'error' && window.state && window.state.storage && window.state.storage.mode === 'firebase') {
        if(window.FirebaseSyncQueue && typeof window.FirebaseSyncQueue.enqueue === 'function') {
          window.FirebaseSyncQueue.enqueue('save', { state: window.state }, 5);
        }
      }
    }
  };

  window.devLogPanel = new DevLogPanel(devLogConfig).init();

  const previousLogDev = typeof window.logDev === 'function' ? window.logDev : null;
  window.logDev = function(...args){
    const message = args.map(arg => typeof arg === 'string' ? arg : JSON.stringify(arg)).join(' ');
    window.devLogPanel.info(message, { source: 'logDev', timestamp: Date.now() });
    if(previousLogDev) {
      try { previousLogDev.apply(window, args); } catch(registerErr) {
        console.warn('logDev delegacja nie powiod≈Ça siƒô', registerErr);
      }
    }
  };

  const previousLogWarn = typeof window.logWarn === 'function' ? window.logWarn : null;
  window.logWarn = function(...args){
    const message = args.map(arg => typeof arg === 'string' ? arg : JSON.stringify(arg)).join(' ');
    window.devLogPanel.warning(message, { source: 'logWarn', timestamp: Date.now() });
    if(previousLogWarn) {
      try { previousLogWarn.apply(window, args); } catch(registerErr) {
        console.warn('logWarn delegacja nie powiod≈Ça siƒô', registerErr);
      }
    }
  };

  const previousLogError = typeof window.logError === 'function' ? window.logError : null;
  window.logError = function(...args){
    const message = args.map(arg => typeof arg === 'string' ? arg : JSON.stringify(arg)).join(' ');
    window.devLogPanel.error(message, { source: 'logError', timestamp: Date.now() });
    if(previousLogError) {
      try { previousLogError.apply(window, args); } catch(registerErr) {
        console.warn('logError delegacja nie powiod≈Ça siƒô', registerErr);
      }
    }
  };

  window.devLogPanel.info('DevLog panel zainicjalizowany', {
    build: window.APP_BUILD_VERSION || 'v5.6.27',
    mode: window.state && window.state.storage ? window.state.storage.mode : 'localStorage',
    firebaseEnabled: window.state && window.state.storage ? window.state.storage.mode === 'firebase' : false
  });
})();
</script>

<!-- ============================================================================ -->
<!-- FIREBASE REAL-TIME SYNC MODULE -->
<!-- ============================================================================ -->
<script src="js/firebase-realtime-sync.js"></script>

<!-- ============================================================================ -->
<!-- RESOURCE CONFLICT DETECTOR MODULE -->
<!-- ============================================================================ -->
<script src="js/resource-conflict-detector.js"></script>

<!-- ============================================================================ -->
<!-- AUTO-ASSIGN ALGORITHM MODULE -->
<!-- ============================================================================ -->
<script src="js/auto-assign-algorithm.js"></script>

<!-- ============================================================================ -->
<!-- E2E TEST SUITE -->
<!-- ============================================================================ -->
<script src="tests/e2e-test-suite.js"></script>

<script>
// ============================================================================
// INICJALIZACJA REAL-TIME SYNC
// ============================================================================

document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ [App] Inicjalizacja Real-time Sync...');
  
  // Poczekaj na za≈Çadowanie Firebase
  await new Promise(resolve => {
    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
      resolve();
    } else {
      const checkFirebase = setInterval(() => {
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
          clearInterval(checkFirebase);
          resolve();
        }
      }, 100);
      
      // Timeout po 5s
      setTimeout(() => {
        clearInterval(checkFirebase);
        console.warn('‚ö†Ô∏è [App] Firebase initialization timeout');
        resolve();
      }, 5000);
    }
  });
  
  // Sprawd≈∫ czy Firebase jest dostƒôpny
  if (typeof firebase === 'undefined') {
    console.error('‚ùå [App] Firebase nie jest za≈Çadowany');
    return;
  }
  
  // Sprawd≈∫ czy Firebase jest zainicjalizowany
  if (!firebase.apps.length) {
    console.warn('‚ö†Ô∏è [App] Firebase nie jest zainicjalizowany');
    return;
  }
  
  // Sprawd≈∫ czy tryb Firebase jest w≈ÇƒÖczony
  const state = window.store ? window.store.get() : window.state;
  if (state.settings && state.settings.mode !== 'firebase') {
    console.log('‚ÑπÔ∏è [App] Firebase mode wy≈ÇƒÖczony, pomijam real-time sync');
    return;
  }
  
  // Inicjalizuj real-time sync
  try {
    await window.firebaseRealtimeSync.init({
      enableRealtime: true,
      enableOffline: true,
      conflictStrategy: 'last-write-wins', // lub 'merge'
      retryAttempts: 3,
      retryDelay: 1000,
      syncDebug: true // Wy≈ÇƒÖcz w produkcji
    });
    
    console.log('‚úÖ [App] Real-time Sync zainicjalizowany');
    
    // Update UI status co 5 sekund
    setInterval(() => {
      if (window.firebaseRealtimeSync) {
        window.firebaseRealtimeSync.updateSyncStatus();
      }
    }, 5000);
    
  } catch (error) {
    console.error('‚ùå [App] B≈ÇƒÖd inicjalizacji Real-time Sync:', error);
  }
});

// ============================================================================
// MONITORING SYNC STATUS
// ============================================================================

// Log sync status co 30 sekund
setInterval(() => {
  if (window.firebaseRealtimeSync) {
    const status = window.firebaseRealtimeSync.getStatus();
    console.log('üìä [App] Sync Status:', status);
    
    // Alert je≈õli pending writes > 10
    if (status.pendingWrites > 10) {
      console.warn('‚ö†Ô∏è [App] Too many pending writes:', status.pendingWrites);
    }
    
    // Alert je≈õli errors > 0
    if (status.errors > 0) {
      console.warn('‚ö†Ô∏è [App] Sync errors detected:', status.errors);
    }
  }
}, 30000);

// ============================================================================
// RETRY PENDING WRITES ON RECONNECT
// ============================================================================

window.addEventListener('online', () => {
  console.log('üåê [App] Connection restored, retrying pending writes...');
  
  if (window.firebaseRealtimeSync) {
    window.firebaseRealtimeSync.retryPendingWrites()
      .then(() => {
        console.log('‚úÖ [App] Pending writes retry completed');
      })
      .catch(error => {
        console.error('‚ùå [App] Retry failed:', error);
      });
  }
});

window.addEventListener('offline', () => {
  console.log('üîå [App] Connection lost, entering offline mode');
});

console.log('‚úÖ [App] Real-time Sync integration loaded');
</script>

<!-- Debug Console Panel -->
<div id="debug-console-panel" class="hidden">
  <div id="debug-console-header">
    <div class="title">
      <span>üîç</span>
      <span>Konsola Debugowania</span>
    </div>
    <div class="controls">
      <button id="console-minimize" title="Zwi≈Ñ">‚àí</button>
      <button id="console-close" title="Zamknij">√ó</button>
    </div>
  </div>
  <div id="debug-console-content">
    <div id="debug-console-logs">
      <div class="console-log info">
        <span class="timestamp">12:18:31,846</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "name": "zawias",
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "minStock": 5,
      "price": 100,
      "quantity": 8
    }
  },
  {
    "id": "undefined",
    "data": {
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "minStock": 0,
      "quantity": 32,
      "name": "zawias",
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "minStock": 3,
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "quantity": 6,
      "price": 1,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "name": "LISTWA ZACZEPOWA"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "minStock": 3,
      "price": 1,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt",
      "quantity": 11,
      "name": "ELEKTRO ZACZEP"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:31,866</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,026</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:31</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,551</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,553</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,556</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,557</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,559</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "name": "PIOTR",
      "role": "Inne",
      "id": "id-mhqk06bsnq8n",
      "hoursPerDay": 8,
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "id": "id-mhqmea04frcw",
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100,
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "name": "BOGDAN",
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "hoursPerDay": 8,
      "role": "Inne",
      "cap": 100
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "id": "id-mhqnp31ihfrw",
      "cap": 100,
      "phone": "",
      "name": "MALINA"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,562</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,564</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,566</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,568</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,569</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,572</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,574</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,576</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "quantity": 8,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "price": 100,
      "minStock": 5,
      "name": "zawias",
      "id": "id-mhqt7n654ija",
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "unit": "szt",
      "quantity": 32,
      "name": "zawias",
      "lastUpdated": 1762209773643,
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "unit": "szt",
      "name": "LISTWA ZACZEPOWA",
      "quantity": 6,
      "price": 1,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "minStock": 3
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "quantity": 11,
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt",
      "minStock": 3
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,594</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:32,744</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:32</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,294</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,296</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,298</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,301</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,302</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "phone": "",
      "hoursPerDay": 8,
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "role": "Inne",
      "name": "TOMASZ",
      "phone": "",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "name": "BOGDAN",
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "cap": 100,
      "role": "Inne",
      "phone": "",
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,304</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,307</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,308</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,310</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,312</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,315</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,316</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,318</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "quantity": 8,
      "minStock": 5,
      "price": 100,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "name": "zawias",
      "id": "id-mhqt7n654ija",
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "unit": "szt",
      "id": "undefined",
      "quantity": 32,
      "lastUpdated": 1762209773643,
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "id": "wh_1761552551094_cd9u2uaa0",
      "minStock": 3,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "quantity": 11,
      "minStock": 3,
      "unit": "szt",
      "id": "wh_1761552686271_e3hehgdd9",
      "name": "ELEKTRO ZACZEP",
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      }
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,332</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,490</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:33</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,981</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,983</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,986</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,988</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,990</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "hoursPerDay": 8,
      "name": "PIOTR",
      "phone": "",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "phone": "",
      "hoursPerDay": 8,
      "role": "Inne",
      "cap": 100,
      "id": "id-mhqmea04frcw"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "phone": "",
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "name": "BOGDAN",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "id": "id-mhqnp31ihfrw",
      "name": "MALINA",
      "phone": "",
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,993</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,995</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,997</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:33,999</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,001</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,004</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,007</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,009</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "quantity": 8,
      "price": 100,
      "name": "zawias",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "id": "id-mhqt7n654ija",
      "minStock": 5,
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "id": "undefined",
      "name": "zawias",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "quantity": 6,
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1,
      "minStock": 3,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "minStock": 3,
      "name": "ELEKTRO ZACZEP",
      "unit": "szt",
      "quantity": 11,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "price": 1,
      "id": "wh_1761552686271_e3hehgdd9"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,028</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,183</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:34</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,750</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,753</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,756</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,760</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,763</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "role": "Inne",
      "hoursPerDay": 8,
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "id": "id-mhqmea04frcw",
      "role": "Inne",
      "phone": "",
      "hoursPerDay": 8,
      "cap": 100
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "name": "BOGDAN",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "cap": 100,
      "phone": "",
      "hoursPerDay": 8,
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,766</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,769</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,772</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,776</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,779</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,784</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,785</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,788</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "price": 100,
      "quantity": 8,
      "name": "zawias",
      "minStock": 5,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "unit": "szt",
      "id": "undefined",
      "minStock": 0,
      "lastUpdated": 1762209773643,
      "name": "zawias",
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "name": "LISTWA ZACZEPOWA",
      "price": 1,
      "id": "wh_1761552551094_cd9u2uaa0",
      "minStock": 3,
      "quantity": 6,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "price": 1,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "name": "ELEKTRO ZACZEP",
      "minStock": 3,
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,805</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:34,960</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:34</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,499</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,501</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,504</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,506</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,507</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "hoursPerDay": 8,
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "phone": "",
      "role": "Inne",
      "name": "BOGDAN",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "role": "Inne",
      "cap": 100,
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "phone": "",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,510</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,512</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,514</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,517</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,519</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,522</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,524</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,527</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "quantity": 8,
      "name": "zawias",
      "minStock": 5,
      "unit": "szt",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "id": "id-mhqt7n654ija",
      "price": 100
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "name": "zawias",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "id": "undefined",
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "minStock": 3,
      "quantity": 6,
      "price": 1,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "unit": "szt"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "name": "ELEKTRO ZACZEP",
      "quantity": 11,
      "unit": "szt",
      "minStock": 3,
      "id": "wh_1761552686271_e3hehgdd9"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,542</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:35,705</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:35</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,232</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,239</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,243</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,246</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,247</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,250</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "hoursPerDay": 8,
      "phone": "",
      "role": "Inne",
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "role": "Inne",
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "cap": 100,
      "name": "BOGDAN",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "name": "MALINA",
      "role": "Inne",
      "phone": "",
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,254</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,256</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,258</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,261</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,264</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,269</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,271</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,274</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "quantity": 8,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "name": "zawias",
      "price": 100
    }
  },
  {
    "id": "undefined",
    "data": {
      "unit": "szt",
      "id": "undefined",
      "quantity": 32,
      "name": "zawias",
      "lastUpdated": 1762209773643,
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA",
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "minStock": 3,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "name": "ELEKTRO ZACZEP",
      "minStock": 3,
      "quantity": 11,
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "price": 1,
      "unit": "szt"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,293</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,440</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:36</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,971</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,973</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,975</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,977</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,980</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqk06bsnq8n",
      "cap": 100,
      "name": "PIOTR",
      "role": "Inne",
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "hoursPerDay": 8,
      "name": "TOMASZ",
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "name": "BOGDAN",
      "hoursPerDay": 8,
      "phone": "",
      "role": "Inne",
      "id": "id-mhqnovqwkchl",
      "cap": 100
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "phone": "",
      "role": "Inne",
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "name": "MALINA"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,982</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,984</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,986</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,988</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,990</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,993</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,995</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:36,997</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "unit": "szt",
      "name": "zawias",
      "quantity": 8,
      "minStock": 5,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "price": 100,
      "id": "id-mhqt7n654ija"
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "quantity": 32,
      "unit": "szt",
      "minStock": 0,
      "name": "zawias",
      "lastUpdated": 1762209773643
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "minStock": 3,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "quantity": 6,
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "quantity": 11,
      "minStock": 3,
      "name": "ELEKTRO ZACZEP",
      "unit": "szt",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "id": "wh_1761552686271_e3hehgdd9"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,016</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,175</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:36</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,704</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,707</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,709</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,710</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,714</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "cap": 100,
      "hoursPerDay": 8,
      "role": "Inne",
      "name": "PIOTR",
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "id": "id-mhqmea04frcw",
      "name": "TOMASZ",
      "phone": "",
      "role": "Inne",
      "cap": 100,
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "phone": "",
      "name": "BOGDAN",
      "role": "Inne",
      "id": "id-mhqnovqwkchl",
      "hoursPerDay": 8,
      "cap": 100
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "role": "Inne",
      "phone": "",
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,716</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,717</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,720</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,722</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,723</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,726</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,728</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,731</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "price": 100,
      "id": "id-mhqt7n654ija",
      "name": "zawias",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "quantity": 8,
      "unit": "szt",
      "minStock": 5
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "unit": "szt",
      "name": "zawias",
      "id": "undefined",
      "quantity": 32,
      "lastUpdated": 1762209773643
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "name": "LISTWA ZACZEPOWA",
      "price": 1,
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "unit": "szt",
      "minStock": 3,
      "quantity": 6
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "minStock": 3,
      "quantity": 11,
      "price": 1,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "name": "ELEKTRO ZACZEP",
      "id": "wh_1761552686271_e3hehgdd9"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,747</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:37"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,749</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,752</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13393 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,754</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,756</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:37,908</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:37</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,439</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,442</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,444</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,446</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,449</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "id": "id-mhqk06bsnq8n",
      "hoursPerDay": 8,
      "phone": "",
      "name": "PIOTR",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "phone": "",
      "cap": 100,
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "role": "Inne",
      "id": "id-mhqmea04frcw"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "name": "BOGDAN",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "phone": "",
      "role": "Inne",
      "name": "MALINA",
      "hoursPerDay": 8,
      "id": "id-mhqnp31ihfrw",
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,451</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,453</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,455</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,457</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,459</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,462</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,464</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,466</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "price": 100,
      "minStock": 5,
      "id": "id-mhqt7n654ija",
      "name": "zawias",
      "unit": "szt",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "quantity": 8
    }
  },
  {
    "id": "undefined",
    "data": {
      "lastUpdated": 1762209773643,
      "quantity": 32,
      "unit": "szt",
      "minStock": 0,
      "name": "zawias",
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "name": "LISTWA ZACZEPOWA",
      "minStock": 3,
      "quantity": 6,
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "price": 1,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "name": "ELEKTRO ZACZEP",
      "quantity": 11,
      "minStock": 3
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,484</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:38"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,487</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,489</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13393 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,492</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,495</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:38,633</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:38</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,934</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,937</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,939</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,942</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,944</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "hoursPerDay": 8,
      "id": "id-mhqk06bsnq8n",
      "phone": "",
      "name": "PIOTR",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "id": "id-mhqmea04frcw",
      "cap": 100,
      "phone": "",
      "name": "TOMASZ",
      "role": "Inne",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "role": "Inne",
      "cap": 100,
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "name": "BOGDAN",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "role": "Inne",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "cap": 100,
      "phone": "",
      "name": "MALINA"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,946</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,950</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,952</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,955</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,958</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,964</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,966</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,968</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "price": 100,
      "quantity": 8,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "name": "zawias",
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "minStock": 5
    }
  },
  {
    "id": "undefined",
    "data": {
      "unit": "szt",
      "id": "undefined",
      "minStock": 0,
      "lastUpdated": 1762209773643,
      "name": "zawias",
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "quantity": 6,
      "price": 1,
      "name": "LISTWA ZACZEPOWA",
      "unit": "szt",
      "minStock": 3,
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "price": 1,
      "unit": "szt",
      "name": "ELEKTRO ZACZEP",
      "quantity": 11,
      "minStock": 3
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,987</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:39"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,991</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,993</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13393 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,995</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:39,997</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,127</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:39</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,981</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,985</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,988</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,990</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,992</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "PIOTR",
      "phone": "",
      "id": "id-mhqk06bsnq8n"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "id": "id-mhqmea04frcw",
      "phone": "",
      "cap": 100,
      "name": "TOMASZ",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "role": "Inne",
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "hoursPerDay": 8,
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "cap": 100,
      "role": "Inne",
      "phone": "",
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,995</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:40,997</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,000</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,003</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,005</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,011</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,013</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,016</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "price": 100,
      "name": "zawias",
      "quantity": 8,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "lastUpdated": 1762209773643,
      "minStock": 0,
      "quantity": 32,
      "unit": "szt",
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "name": "LISTWA ZACZEPOWA",
      "price": 1,
      "quantity": 6,
      "id": "wh_1761552551094_cd9u2uaa0",
      "unit": "szt",
      "minStock": 3,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt",
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "minStock": 3,
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,037</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,219</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:41</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,245</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,739</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,742</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,744</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,746</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,748</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "name": "PIOTR",
      "cap": 100,
      "role": "Inne",
      "phone": "",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "role": "Inne",
      "id": "id-mhqmea04frcw",
      "name": "TOMASZ",
      "phone": "",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "id": "id-mhqnovqwkchl",
      "name": "BOGDAN",
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100,
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqnp31ihfrw",
      "cap": 100,
      "phone": "",
      "name": "MALINA",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,751</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,754</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,756</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,758</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,760</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,763</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,765</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,769</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "name": "zawias",
      "quantity": 8,
      "minStock": 5,
      "unit": "szt",
      "price": 100,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "quantity": 32,
      "unit": "szt",
      "id": "undefined",
      "name": "zawias",
      "lastUpdated": 1762209773643,
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "price": 1,
      "minStock": 3,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "name": "LISTWA ZACZEPOWA",
      "quantity": 6,
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "minStock": 3,
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,786</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:41,988</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:41</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,470</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,472</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,474</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,477</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,479</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "phone": "",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "PIOTR"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "name": "TOMASZ",
      "cap": 100,
      "phone": "",
      "id": "id-mhqmea04frcw"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "name": "BOGDAN",
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "name": "MALINA",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,481</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,485</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,486</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,488</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,491</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,494</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,495</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,498</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "quantity": 8,
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "name": "zawias",
      "price": 100,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "name": "zawias",
      "id": "undefined",
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA",
      "price": 1,
      "minStock": 3,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "id": "wh_1761552551094_cd9u2uaa0"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "minStock": 3,
      "quantity": 11,
      "name": "ELEKTRO ZACZEP",
      "id": "wh_1761552686271_e3hehgdd9",
      "price": 1
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,513</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:42,697</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:42</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,200</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,202</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,205</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,208</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,211</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "phone": "",
      "name": "PIOTR",
      "hoursPerDay": 8,
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "phone": "",
      "role": "Inne",
      "id": "id-mhqmea04frcw",
      "cap": 100,
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "name": "BOGDAN",
      "cap": 100,
      "role": "Inne",
      "phone": "",
      "id": "id-mhqnovqwkchl",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "cap": 100,
      "phone": "",
      "id": "id-mhqnp31ihfrw",
      "role": "Inne",
      "name": "MALINA",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,213</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,215</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,217</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,220</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,222</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,226</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,229</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,232</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "name": "zawias",
      "quantity": 8,
      "minStock": 5,
      "unit": "szt",
      "price": 100,
      "id": "id-mhqt7n654ija",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "name": "zawias",
      "quantity": 32,
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1,
      "minStock": 3,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "unit": "szt",
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "minStock": 3,
      "unit": "szt",
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,250</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,430</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:43</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,912</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,917</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,920</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,922</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,924</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "hoursPerDay": 8,
      "name": "PIOTR",
      "role": "Inne",
      "phone": "",
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "id": "id-mhqmea04frcw",
      "role": "Inne",
      "cap": 100,
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "cap": 100,
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "name": "MALINA",
      "role": "Inne",
      "phone": "",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,927</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,929</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,931</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,934</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,936</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,940</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,943</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,945</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "quantity": 8,
      "unit": "szt",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "id": "id-mhqt7n654ija",
      "name": "zawias",
      "price": 100
    }
  },
  {
    "id": "undefined",
    "data": {
      "name": "zawias",
      "minStock": 0,
      "quantity": 32,
      "unit": "szt",
      "id": "undefined",
      "lastUpdated": 1762209773643
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "minStock": 3,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "unit": "szt",
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA",
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "minStock": 3,
      "id": "wh_1761552686271_e3hehgdd9",
      "price": 1,
      "quantity": 11,
      "name": "ELEKTRO ZACZEP",
      "unit": "szt"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:43,961</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,129</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:43</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,633</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,635</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,638</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,640</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,643</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "name": "PIOTR",
      "hoursPerDay": 8,
      "role": "Inne",
      "cap": 100,
      "phone": ""
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "id": "id-mhqmea04frcw",
      "phone": "",
      "role": "Inne",
      "name": "TOMASZ",
      "cap": 100,
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "id": "id-mhqnovqwkchl",
      "name": "BOGDAN",
      "phone": "",
      "role": "Inne",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "id": "id-mhqnp31ihfrw",
      "cap": 100,
      "phone": "",
      "role": "Inne",
      "hoursPerDay": 8,
      "name": "MALINA"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,645</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,648</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,650</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,652</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,655</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,658</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,660</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,663</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "quantity": 8,
      "id": "id-mhqt7n654ija",
      "minStock": 5,
      "price": 100,
      "name": "zawias",
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "quantity": 32,
      "id": "undefined",
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "minStock": 0,
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "minStock": 3,
      "price": 1,
      "unit": "szt",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA",
      "id": "wh_1761552551094_cd9u2uaa0"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "quantity": 11,
      "minStock": 3,
      "unit": "szt",
      "name": "ELEKTRO ZACZEP",
      "price": 1,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      }
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:44,677</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,090</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:44</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,336</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,339</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,341</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,343</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,346</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "name": "PIOTR",
      "phone": "",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "cap": 100,
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "phone": "",
      "cap": 100,
      "hoursPerDay": 8,
      "role": "Inne",
      "name": "TOMASZ",
      "id": "id-mhqmea04frcw"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "name": "BOGDAN",
      "role": "Inne",
      "cap": 100,
      "id": "id-mhqnovqwkchl",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,350</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,354</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,356</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,358</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,362</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,367</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,369</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,372</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "price": 100,
      "unit": "szt",
      "name": "zawias",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "quantity": 8,
      "id": "id-mhqt7n654ija"
    }
  },
  {
    "id": "undefined",
    "data": {
      "unit": "szt",
      "name": "zawias",
      "minStock": 0,
      "id": "undefined",
      "lastUpdated": 1762209773643,
      "quantity": 32
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "price": 1,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "id": "wh_1761552551094_cd9u2uaa0",
      "unit": "szt",
      "quantity": 6,
      "minStock": 3
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt",
      "minStock": 3,
      "quantity": 11,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      }
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,389</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:45,578</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:45</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,085</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,088</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,090</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,094</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,096</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "phone": "",
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "phone": "",
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "id": "id-mhqmea04frcw",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "name": "BOGDAN",
      "phone": "",
      "id": "id-mhqnovqwkchl",
      "cap": 100
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100,
      "phone": ""
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,099</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,101</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,103</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,106</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,108</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,112</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,115</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,117</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "price": 100,
      "minStock": 5,
      "name": "zawias",
      "unit": "szt",
      "quantity": 8,
      "id": "id-mhqt7n654ija",
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "lastUpdated": 1762209773643,
      "minStock": 0,
      "id": "undefined",
      "quantity": 32,
      "name": "zawias",
      "unit": "szt"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "minStock": 3,
      "quantity": 6,
      "unit": "szt",
      "price": 1,
      "name": "LISTWA ZACZEPOWA"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "price": 1,
      "unit": "szt",
      "quantity": 11,
      "name": "ELEKTRO ZACZEP",
      "minStock": 3
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,134</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,200</span>
        <span>üîÑ Auto-sync: Synchronizujƒô z bazƒÖ danych...</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,247</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,362</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:46</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,442</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,445</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,447</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,450</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,452</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "hoursPerDay": 8,
      "cap": 100,
      "phone": "",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "name": "PIOTR"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "name": "TOMASZ",
      "cap": 100,
      "phone": "",
      "id": "id-mhqmea04frcw",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "phone": "",
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "BOGDAN",
      "id": "id-mhqnovqwkchl"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "role": "Inne",
      "name": "MALINA",
      "phone": "",
      "hoursPerDay": 8,
      "cap": 100,
      "id": "id-mhqnp31ihfrw"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,454</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,456</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,459</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,461</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,463</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,466</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,468</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,470</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "unit": "szt",
      "minStock": 5,
      "name": "zawias",
      "price": 100,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "quantity": 8
    }
  },
  {
    "id": "undefined",
    "data": {
      "name": "zawias",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "id": "undefined",
      "quantity": 32,
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "price": 1,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "minStock": 3,
      "quantity": 6,
      "name": "LISTWA ZACZEPOWA"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "name": "ELEKTRO ZACZEP",
      "id": "wh_1761552686271_e3hehgdd9",
      "minStock": 3,
      "price": 1,
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "unit": "szt",
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,488</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:46"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,491</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,493</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13393 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,496</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,499</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,684</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:46</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:46,691</span>
        <span>‚úÖ Auto-sync: Zako≈Ñczono pomy≈õlnie</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,198</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,201</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,203</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,205</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,208</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "role": "Inne",
      "phone": "",
      "id": "id-mhqk06bsnq8n",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "PIOTR"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "role": "Inne",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "name": "BOGDAN",
      "cap": 100,
      "phone": "",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "role": "Inne",
      "phone": "",
      "name": "MALINA",
      "cap": 100,
      "hoursPerDay": 8,
      "id": "id-mhqnp31ihfrw"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,211</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,212</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,215</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,217</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,219</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,222</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,224</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,226</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "name": "zawias",
      "quantity": 8,
      "price": 100,
      "unit": "szt",
      "id": "id-mhqt7n654ija"
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "name": "zawias",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "quantity": 32,
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "unit": "szt",
      "minStock": 3,
      "name": "LISTWA ZACZEPOWA",
      "quantity": 6,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "quantity": 11,
      "name": "ELEKTRO ZACZEP",
      "minStock": 3,
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,244</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,427</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:47</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,874</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,876</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,880</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,882</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,884</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "cap": 100,
      "name": "PIOTR",
      "hoursPerDay": 8,
      "phone": "",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "phone": "",
      "id": "id-mhqmea04frcw",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "TOMASZ",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "cap": 100,
      "name": "BOGDAN",
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "hoursPerDay": 8,
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "name": "MALINA",
      "cap": 100,
      "phone": "",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,887</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,890</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,892</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,895</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,897</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,901</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,903</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,906</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "unit": "szt",
      "id": "id-mhqt7n654ija",
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "price": 100,
      "minStock": 5,
      "name": "zawias",
      "quantity": 8
    }
  },
  {
    "id": "undefined",
    "data": {
      "name": "zawias",
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "id": "undefined",
      "quantity": 32,
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "quantity": 6,
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1,
      "unit": "szt",
      "minStock": 3
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "price": 1,
      "quantity": 11,
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "id": "wh_1761552686271_e3hehgdd9",
      "minStock": 3,
      "name": "ELEKTRO ZACZEP",
      "unit": "szt"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:47,922</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,110</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:47</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,607</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,610</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,612</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,617</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,619</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "cap": 100,
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "phone": "",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "phone": "",
      "name": "TOMASZ",
      "cap": 100,
      "hoursPerDay": 8,
      "id": "id-mhqmea04frcw",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "role": "Inne",
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100,
      "id": "id-mhqnovqwkchl",
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "name": "MALINA",
      "phone": "",
      "role": "Inne",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,622</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,624</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,627</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,629</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,631</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,634</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,636</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,639</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "minStock": 5,
      "name": "zawias",
      "price": 100,
      "quantity": 8,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "minStock": 0,
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "quantity": 32,
      "name": "zawias",
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "name": "LISTWA ZACZEPOWA",
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "minStock": 3,
      "quantity": 6,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "name": "ELEKTRO ZACZEP",
      "quantity": 11,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "minStock": 3,
      "unit": "szt",
      "id": "wh_1761552686271_e3hehgdd9",
      "price": 1
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,655</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:48,858</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:48</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,319</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,323</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,325</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,327</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,331</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "phone": "",
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "hoursPerDay": 8,
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "name": "TOMASZ",
      "hoursPerDay": 8,
      "id": "id-mhqmea04frcw",
      "role": "Inne",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "role": "Inne",
      "cap": 100,
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "phone": "",
      "name": "MALINA",
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqnp31ihfrw",
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,333</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,336</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,338</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,340</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,344</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,348</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,351</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,354</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "minStock": 5,
      "unit": "szt",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "name": "zawias",
      "id": "id-mhqt7n654ija",
      "price": 100,
      "quantity": 8
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "quantity": 32,
      "minStock": 0,
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "id": "wh_1761552551094_cd9u2uaa0",
      "price": 1,
      "minStock": 3,
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      },
      "unit": "szt",
      "quantity": 6
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "unit": "szt",
      "quantity": 11,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "minStock": 3,
      "name": "ELEKTRO ZACZEP",
      "price": 1
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,433</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:49,672</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:49</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,269</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,272</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,274</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,278</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,282</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqk06bsnq8n",
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "name": "PIOTR"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "phone": "",
      "name": "TOMASZ",
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "name": "BOGDAN",
      "cap": 100,
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "name": "MALINA",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,286</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,308</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,312</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,319</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,324</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,331</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,335</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,339</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "minStock": 5,
      "unit": "szt",
      "name": "zawias",
      "quantity": 8,
      "price": 100,
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "quantity": 32,
      "name": "zawias",
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "id": "undefined",
      "minStock": 0
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "price": 1,
      "minStock": 3,
      "name": "LISTWA ZACZEPOWA",
      "quantity": 6,
      "id": "wh_1761552551094_cd9u2uaa0",
      "location": {
        "sector": "",
        "shelf": "",
        "rack": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "quantity": 11,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "unit": "szt",
      "minStock": 3,
      "price": 1,
      "id": "wh_1761552686271_e3hehgdd9",
      "name": "ELEKTRO ZACZEP"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,368</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:50,542</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:50</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,033</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,036</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,038</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,041</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,043</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "id": "id-mhqk06bsnq8n",
      "role": "Inne",
      "hoursPerDay": 8,
      "name": "PIOTR",
      "phone": "",
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "hoursPerDay": 8,
      "role": "Inne",
      "id": "id-mhqmea04frcw",
      "phone": "",
      "cap": 100,
      "name": "TOMASZ"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "hoursPerDay": 8,
      "phone": "",
      "role": "Inne",
      "id": "id-mhqnovqwkchl",
      "cap": 100,
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "cap": 100,
      "name": "MALINA",
      "phone": "",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,045</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,048</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,050</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,053</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,055</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,058</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,061</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,065</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "name": "zawias",
      "minStock": 5,
      "id": "id-mhqt7n654ija",
      "price": 100,
      "quantity": 8,
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "name": "zawias",
      "unit": "szt",
      "quantity": 32,
      "minStock": 0,
      "lastUpdated": 1762209773643
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "name": "LISTWA ZACZEPOWA",
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "quantity": 6,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "minStock": 3,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "unit": "szt",
      "minStock": 3,
      "quantity": 11,
      "name": "ELEKTRO ZACZEP",
      "price": 1
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,084</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:51"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,086</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,089</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13393 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,092</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,095</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,164</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,168</span>
        <span>[auto-save] Stan zapisany automatycznie {
  "force": false
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,254</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:51</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,261</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,561</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,567</span>
        <span>üé® Rendering Gantt chart...</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,570</span>
        <span>Gantt: baseDate: 2025-11-08 offset: 0 startDate: 2025-11-08</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,573</span>
        <span>Container width: 1000 Timeline width: 800</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,576</span>
        <span>[gantt] state.tasks total= 9</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,579</span>
        <span>[gantt] employees= 4 withAssignedRows= 4 unassigned= 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,582</span>
        <span>Employee PIOTR has 3 tasks</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,583</span>
        <span>SlotWidth: 114.28571428571429 for 7 days, timeline width: 800</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,586</span>
        <span>Task: Monta≈º: 5003 start: 2025-11-23 startDate: 2025-11-08 daysDiff: 14 leftPos: 1605</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,588</span>
        <span>Task: Szczotkowanie... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,590</span>
        <span>Task: Frezowanie na... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,593</span>
        <span>Rendered 3 tasks for PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,595</span>
        <span>Employee TOMASZ has 3 tasks</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,598</span>
        <span>SlotWidth: 114.28571428571429 for 7 days, timeline width: 800</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,600</span>
        <span>Task: Monta≈º: 5003 start: 2025-11-23 startDate: 2025-11-08 daysDiff: 14 leftPos: 1605</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,603</span>
        <span>Task: Malowanie (fu... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,606</span>
        <span>Task: Sklejanie bel... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,607</span>
        <span>Rendered 3 tasks for TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,610</span>
        <span>Employee BOGDAN has 2 tasks</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,613</span>
        <span>SlotWidth: 114.28571428571429 for 7 days, timeline width: 800</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,615</span>
        <span>Task: Kontrola wymi... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,617</span>
        <span>Task: Okuwanie (fut... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,621</span>
        <span>Rendered 2 tasks for BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,623</span>
        <span>Employee MALINA has 1 tasks</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,626</span>
        <span>SlotWidth: 114.28571428571429 for 7 days, timeline width: 800</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,629</span>
        <span>Task: Szlifowanie (... start: 2025-11-09 startDate: 2025-11-08 daysDiff: 0 leftPos: 5</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,632</span>
        <span>Rendered 1 tasks for MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,635</span>
        <span>üóëÔ∏è Removing 0 old time indicators</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,637</span>
        <span>üìç Checking time indicator: now= 9.11.2025, 12:18:51 todayMidnight= 9.11.2025 startDate= 9.11.2025 daysSinceStart= 0 daysCount= 7</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,640</span>
        <span>‚úÖ Current time indicator added at day 0 hours: 12 minutes: 18 hoursFraction: 0.512 position: 258.6px slotWidth: 114.3</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:51,642</span>
        <span>Gantt chart rendered</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,213</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,216</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,218</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,221</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,224</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "hoursPerDay": 8,
      "cap": 100,
      "phone": "",
      "name": "PIOTR",
      "id": "id-mhqk06bsnq8n",
      "role": "Inne"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "cap": 100,
      "phone": "",
      "hoursPerDay": 8,
      "id": "id-mhqmea04frcw",
      "role": "Inne",
      "name": "TOMASZ"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "phone": "",
      "id": "id-mhqnovqwkchl",
      "cap": 100,
      "name": "BOGDAN",
      "role": "Inne",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "cap": 100,
      "phone": "",
      "name": "MALINA",
      "role": "Inne"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,226</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,228</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,231</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,234</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,237</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,241</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,243</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,246</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "name": "zawias",
      "price": 100,
      "unit": "szt",
      "quantity": 8,
      "minStock": 5,
      "id": "id-mhqt7n654ija",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      }
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "quantity": 32,
      "lastUpdated": 1762209773643,
      "name": "zawias",
      "minStock": 0,
      "unit": "szt"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "price": 1,
      "quantity": 6,
      "minStock": 3,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "id": "wh_1761552551094_cd9u2uaa0",
      "unit": "szt",
      "name": "LISTWA ZACZEPOWA"
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "id": "wh_1761552686271_e3hehgdd9",
      "quantity": 11,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "price": 1,
      "unit": "szt",
      "name": "ELEKTRO ZACZEP",
      "minStock": 3
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,262</span>
        <span>üíæ SAVE: Zapisujƒô dane... {
  "employees": 4,
  "operations": 44,
  "processes": 3,
  "orders": 1,
  "tasks": 9,
  "timestamp": "9.11.2025, 12:18:52"
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,264</span>
        <span>üë∑ PRACOWNICY w state.employees: [
  {
    "id": "id-mhqk06bsnq8n",
    "name": "PIOTR"
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ"
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN"
  },
  {
    "id": "id-mhqnp31ihfrw",
    "name": "MALINA"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,267</span>
        <span>üíæ SAVE: Klucz: door_v50_state | Wielko≈õƒá: 13396 znak√≥w</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,269</span>
        <span>‚úÖ SAVE: Dane zapisane i zweryfikowane! Zlece≈Ñ w localStorage: 1</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,272</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,423</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:52</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,933</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,935</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,937</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,940</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,942</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "name": "PIOTR",
      "role": "Inne",
      "phone": "",
      "hoursPerDay": 8,
      "id": "id-mhqk06bsnq8n",
      "cap": 100
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "role": "Inne",
      "cap": 100,
      "id": "id-mhqmea04frcw",
      "phone": "",
      "name": "TOMASZ",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "id": "id-mhqnovqwkchl",
      "phone": "",
      "role": "Inne",
      "name": "BOGDAN",
      "cap": 100,
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "name": "MALINA"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,945</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,947</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,949</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,951</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,953</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,956</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,959</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,962</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "id": "id-mhqt7n654ija",
      "unit": "szt",
      "price": 100,
      "quantity": 8,
      "name": "zawias",
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "minStock": 5
    }
  },
  {
    "id": "undefined",
    "data": {
      "lastUpdated": 1762209773643,
      "name": "zawias",
      "minStock": 0,
      "unit": "szt",
      "quantity": 32,
      "id": "undefined"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "price": 1,
      "minStock": 3,
      "id": "wh_1761552551094_cd9u2uaa0",
      "name": "LISTWA ZACZEPOWA",
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "unit": "szt",
      "quantity": 6
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "location": {
        "rack": "",
        "shelf": "",
        "sector": ""
      },
      "minStock": 3,
      "quantity": 11,
      "price": 1,
      "id": "wh_1761552686271_e3hehgdd9",
      "name": "ELEKTRO ZACZEP",
      "unit": "szt"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:52,976</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,126</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:52</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,712</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,714</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,719</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,722</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,726</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "phone": "",
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqk06bsnq8n",
      "cap": 100,
      "name": "PIOTR"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "id": "id-mhqmea04frcw",
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "hoursPerDay": 8
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "id": "id-mhqnovqwkchl",
      "role": "Inne",
      "cap": 100,
      "hoursPerDay": 8,
      "phone": "",
      "name": "BOGDAN"
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "phone": "",
      "role": "Inne",
      "name": "MALINA",
      "cap": 100,
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,730</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,733</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,736</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,739</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,741</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,747</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,749</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,752</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "name": "zawias",
      "quantity": 8,
      "unit": "szt",
      "minStock": 5,
      "price": 100,
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "id": "id-mhqt7n654ija"
    }
  },
  {
    "id": "undefined",
    "data": {
      "id": "undefined",
      "unit": "szt",
      "lastUpdated": 1762209773643,
      "minStock": 0,
      "quantity": 32,
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "unit": "szt",
      "id": "wh_1761552551094_cd9u2uaa0",
      "name": "LISTWA ZACZEPOWA",
      "minStock": 3,
      "location": {
        "sector": "",
        "rack": "",
        "shelf": ""
      },
      "quantity": 6,
      "price": 1
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "minStock": 3,
      "id": "wh_1761552686271_e3hehgdd9",
      "price": 1,
      "name": "ELEKTRO ZACZEP",
      "location": {
        "rack": "",
        "sector": "",
        "shelf": ""
      },
      "quantity": 11
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,772</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:53,982</span>
        <span>‚úÖ Zapisano do Firebase z timestamp: 9.11.2025, 12:18:53</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,426</span>
        <span>üîç [saveToDB] DIAGNOSTYKA PRACOWNIK√ìW:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,428</span>
        <span>  üì¶ Lokalne items (col.items): [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,429</span>
        <span>  üìã Przetworzone localItems: [
  {
    "id": "id-mhqk06bsnq8n",
    "hoursPerDay": 8,
    "phone": "",
    "role": "Inne",
    "name": "PIOTR",
    "cap": 100
  },
  {
    "id": "id-mhqmea04frcw",
    "name": "TOMASZ",
    "hoursPerDay": 8,
    "role": "Inne",
    "phone": "",
    "cap": 100
  },
  {
    "id": "id-mhqnovqwkchl",
    "name": "BOGDAN",
    "role": "Inne",
    "cap": 100,
    "phone": "",
    "hoursPerDay": 8
  },
  {
    "id": "id-mhqnp31ihfrw",
    "phone": "",
    "role": "Inne",
    "name": "MALINA",
    "hoursPerDay": 8,
    "cap": 100
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,432</span>
        <span>  üîë LocalIds (SET): [
  "id-mhqk06bsnq8n",
  "id-mhqmea04frcw",
  "id-mhqnovqwkchl",
  "id-mhqnp31ihfrw"
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,434</span>
        <span>  üåê Zdalne dokumenty: [
  {
    "id": "id-mhqk06bsnq8n",
    "data": {
      "role": "Inne",
      "hoursPerDay": 8,
      "phone": "",
      "name": "PIOTR",
      "cap": 100,
      "id": "id-mhqk06bsnq8n"
    }
  },
  {
    "id": "id-mhqmea04frcw",
    "data": {
      "name": "TOMASZ",
      "phone": "",
      "cap": 100,
      "role": "Inne",
      "hoursPerDay": 8,
      "id": "id-mhqmea04frcw"
    }
  },
  {
    "id": "id-mhqnovqwkchl",
    "data": {
      "id": "id-mhqnovqwkchl",
      "hoursPerDay": 8,
      "cap": 100,
      "role": "Inne",
      "name": "BOGDAN",
      "phone": ""
    }
  },
  {
    "id": "id-mhqnp31ihfrw",
    "data": {
      "role": "Inne",
      "name": "MALINA",
      "id": "id-mhqnp31ihfrw",
      "hoursPerDay": 8,
      "phone": "",
      "cap": 100
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,436</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqk06bsnq8n PIOTR</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,439</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqmea04frcw TOMASZ</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,441</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnovqwkchl BOGDAN</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,444</span>
        <span>  ‚úçÔ∏è Zapisujƒô pracownika: id-mhqnp31ihfrw MALINA</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,446</span>
        <span>‚úÖ [saveToDB] Zako≈Ñczono przetwarzanie pracownik√≥w. Zapisanych: 4, Usuniƒôtych: 0</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,449</span>
        <span>üîç [saveToDB] DIAGNOSTYKA MAGAZYNU:</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,453</span>
        <span>  üì¶ Lokalne pozycje: 4 [
  {
    "id": "id-mhqt7n654ija",
    "location": {
      "rack": "",
      "sector": "",
      "shelf": ""
    },
    "name": "zawias",
    "quantity": 8,
    "minStock": 5,
    "price": 100,
    "unit": "szt"
  },
  {
    "id": "undefined",
    "name": "zawias",
    "minStock": 0,
    "lastUpdated": 1762209773643,
    "unit": "szt",
    "quantity": 32
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "LISTWA ZACZEPOWA",
    "unit": "szt",
    "quantity": 6,
    "price": 1
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "unit": "szt",
    "price": 1,
    "quantity": 11,
    "minStock": 3,
    "location": {
      "shelf": "",
      "sector": "",
      "rack": ""
    },
    "name": "ELEKTRO ZACZEP"
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,454</span>
        <span>  üåê Zdalne dokumenty: 4 [
  {
    "id": "id-mhqt7n654ija",
    "data": {
      "price": 100,
      "minStock": 5,
      "quantity": 8,
      "name": "zawias",
      "id": "id-mhqt7n654ija",
      "location": {
        "shelf": "",
        "sector": "",
        "rack": ""
      },
      "unit": "szt"
    }
  },
  {
    "id": "undefined",
    "data": {
      "quantity": 32,
      "id": "undefined",
      "minStock": 0,
      "lastUpdated": 1762209773643,
      "unit": "szt",
      "name": "zawias"
    }
  },
  {
    "id": "wh_1761552551094_cd9u2uaa0",
    "data": {
      "quantity": 6,
      "price": 1,
      "id": "wh_1761552551094_cd9u2uaa0",
      "unit": "szt",
      "name": "LISTWA ZACZEPOWA",
      "minStock": 3,
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      }
    }
  },
  {
    "id": "wh_1761552686271_e3hehgdd9",
    "data": {
      "unit": "szt",
      "minStock": 3,
      "quantity": 11,
      "id": "wh_1761552686271_e3hehgdd9",
      "location": {
        "shelf": "",
        "rack": "",
        "sector": ""
      },
      "price": 1,
      "name": "ELEKTRO ZACZEP"
    }
  }
]</span>
      </div>
    
      <div class="console-log info">
        <span class="timestamp">12:18:54,471</span>
        <span>Stan zapisany: {
  "tasksLength": 9,
  "ordersLength": 1
}</span>
      </div>
    </div>
  </div>
  <div id="debug-console-footer">
    <button id="console-copy" class="primary">üìã Kopiuj wszystko</button>
    <button id="console-clear">üóëÔ∏è Wyczy≈õƒá</button>
    <button id="console-export">üíæ Eksport</button>
  </div>
</div>

<!-- Toggle Button -->
<button id="debug-console-toggle" title="Poka≈º konsolƒô">
  üîç
</button>

<script>
// Debug Console System
(function() {
  const maxLogs = 500;
  const logs = [];
  
  const panel = document.getElementById('debug-console-panel');
  const toggle = document.getElementById('debug-console-toggle');
  const logsContainer = document.getElementById('debug-console-logs');
  const closeBtn = document.getElementById('console-close');
  const minimizeBtn = document.getElementById('console-minimize');
  const copyBtn = document.getElementById('console-copy');
  const clearBtn = document.getElementById('console-clear');
  const exportBtn = document.getElementById('console-export');
  
  let isMinimized = false;
  let dragOffset = { x: 0, y: 0 };
  let isDragging = false;
  
  // Funkcja dodawania logu
  function addLog(type, message, ...args) {
    const timestamp = new Date().toLocaleTimeString('pl-PL', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
    const fullMessage = [message, ...args].map(arg => {
      if (typeof arg === 'object') {
        try {
          return JSON.stringify(arg, null, 2);
        } catch(e) {
          return String(arg);
        }
      }
      return String(arg);
    }).join(' ');
    
    const log = {
      type,
      message: fullMessage,
      timestamp
    };
    
    logs.push(log);
    if (logs.length > maxLogs) {
      logs.shift();
    }
    
    renderLogs();
  }
  
  // Renderowanie log√≥w
  function renderLogs() {
    logsContainer.innerHTML = logs.map(log => `
      <div class="console-log ${log.type}">
        <span class="timestamp">${log.timestamp}</span>
        <span>${log.message}</span>
      </div>
    `).join('');
    
    // Auto-scroll do ko≈Ñca
    logsContainer.scrollTop = logsContainer.scrollHeight;
  }
  
  // Przechwytywanie console.log, warn, error
  const originalLog = console.log;
  const originalWarn = console.warn;
  const originalError = console.error;
  
  console.log = function(...args) {
    originalLog.apply(console, args);
    addLog('info', ...args);
  };
  
  console.warn = function(...args) {
    originalWarn.apply(console, args);
    addLog('warn', ...args);
  };
  
  console.error = function(...args) {
    originalError.apply(console, args);
    addLog('error', ...args);
  };
  
  // Dodaj custom log success
  window.logSuccess = function(...args) {
    originalLog.apply(console, args);
    addLog('success', ...args);
  };
  
  // Toggle panel
  toggle.addEventListener('click', () => {
    panel.classList.toggle('hidden');
    toggle.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
      renderLogs();
    }
  });
  
  // Close panel
  closeBtn.addEventListener('click', () => {
    panel.classList.add('hidden');
    toggle.classList.remove('hidden');
  });
  
  // Minimize panel
  minimizeBtn.addEventListener('click', () => {
    isMinimized = !isMinimized;
    const content = document.getElementById('debug-console-content');
    const footer = document.getElementById('debug-console-footer');
    
    if (isMinimized) {
      content.style.display = 'none';
      footer.style.display = 'none';
      panel.style.maxHeight = 'auto';
      minimizeBtn.textContent = '+';
    } else {
      content.style.display = 'block';
      footer.style.display = 'flex';
      panel.style.maxHeight = '400px';
      minimizeBtn.textContent = '‚àí';
    }
  });
  
  // Copy all logs
  copyBtn.addEventListener('click', () => {
    const text = logs.map(log => `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      const originalText = copyBtn.textContent;
      copyBtn.textContent = '‚úÖ Skopiowano!';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 2000);
    }).catch(err => {
      alert('B≈ÇƒÖd kopiowania: ' + err.message);
    });
  });
  
  // Clear logs
  clearBtn.addEventListener('click', () => {
    logs.length = 0;
    renderLogs();
  });
  
  // Export logs to file
  exportBtn.addEventListener('click', () => {
    const text = logs.map(log => `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`).join('\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `console-logs-${new Date().toISOString().split('T')[0]}-${new Date().getTime()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  
  // Dragging functionality
  const header = document.getElementById('debug-console-header');
  
  header.addEventListener('mousedown', (e) => {
    if (e.target.tagName === 'BUTTON') return;
    isDragging = true;
    dragOffset.x = e.clientX - panel.offsetLeft;
    dragOffset.y = e.clientY - panel.offsetTop;
    panel.style.cursor = 'grabbing';
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    const newLeft = e.clientX - dragOffset.x;
    const newTop = e.clientY - dragOffset.y;
    
    // Keep panel within viewport
    const maxLeft = window.innerWidth - panel.offsetWidth;
    const maxTop = window.innerHeight - panel.offsetHeight;
    
    panel.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
    panel.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
    panel.style.right = 'auto';
    panel.style.bottom = 'auto';
  });
  
  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      panel.style.cursor = 'default';
    }
  });
  
  // Initial log
  console.log('üîç Konsola debugowania uruchomiona');
  console.log('üìã U≈ºyj przycisku "Kopiuj wszystko" aby skopiowaƒá logi');
})();

// === FUNKCJA DIAGNOSTYCZNA: WSZYSTKIE KLUCZE LOCALSTORAGE ===
function diagnostyka_kluczy_storage() {
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üîç DIAGNOSTYKA KLUCZY LOCALSTORAGE');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  
  const wszystkie_klucze = [];
  for(let i = 0; i < localStorage.length; i++) {
    wszystkie_klucze.push(localStorage.key(i));
  }
  
  console.log(`üìä Znaleziono ${wszystkie_klucze.length} kluczy w localStorage:`);
  wszystkie_klucze.sort().forEach(klucz => {
    const dane = localStorage.getItem(klucz);
    const rozmiar = new Blob([dane]).size;
    const rozmiar_kb = (rozmiar / 1024).toFixed(2);
    
    let podglad = '';
    try {
      const parsed = JSON.parse(dane);
      if(parsed && typeof parsed === 'object') {
        const keys = Object.keys(parsed);
        podglad = `{${keys.slice(0,5).join(', ')}${keys.length > 5 ? '...' : ''}}`;
      } else {
        podglad = String(dane).substring(0, 50);
      }
    } catch(e) {
      podglad = String(dane).substring(0, 50);
    }
    
    console.log(`  üì¶ "${klucz}" ‚Üí ${rozmiar_kb} KB ‚Üí ${podglad}`);
  });
  
  console.log('');
  console.log('üéØ G≈Å√ìWNY KLUCZ APLIKACJI:');
  console.log(`  window.storeKey = "${window.storeKey}"`);
  
  console.log('');
  console.log('üìã ZAWARTO≈öƒÜ G≈Å√ìWNEGO KLUCZA:');
  const glowne_dane = localStorage.getItem(window.storeKey);
  if(glowne_dane) {
    try {
      const parsed = JSON.parse(glowne_dane);
      const keys = Object.keys(parsed);
      console.log(`  W≈Ça≈õciwo≈õci (${keys.length}): ${keys.join(', ')}`);
      
      if(parsed.orders) {
        console.log(`  üì¶ orders: ${parsed.orders.length} zlece≈Ñ`);
        if(parsed.orders.length > 0) {
          console.log(`     Pierwsze zlecenie: ${parsed.orders[0].clientName} (ID: ${parsed.orders[0].id})`);
        }
      }
    } catch(e) {
      console.error('  ‚ùå B≈ÇƒÖd parsowania:', e);
    }
  } else {
    console.log('  ‚ö†Ô∏è BRAK DANYCH!');
  }
  
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}

// Uruchom diagnostykƒô przy starcie
setTimeout(() => {
  diagnostyka_kluczy_storage();
}, 1000);

console.log('üí° Wpisz: diagnostyka_kluczy_storage() aby uruchomiƒá ponownie');
</script>





<button type="button" id="dev-log-toggle" style="position: fixed; right: 12px; bottom: 12px; z-index: 100000; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.2); background: rgb(245, 158, 11); color: rgb(7, 16, 25); font-weight: 700; cursor: pointer; box-shadow: rgba(245, 158, 11, 0.12) 0px 6px 18px;">DevLog</button><div id="dev-log" style="position: fixed; right: 12px; bottom: 48px; max-width: 420px; max-height: 40vh; overflow: auto; background: rgba(8, 8, 12, 0.95); color: rgb(203, 213, 225); padding: 8px; border-radius: 8px; font-size: 12px; z-index: 99999; box-shadow: rgba(0, 0, 0, 0.5) 0px 6px 18px; border: 1px solid rgba(255, 255, 255, 0.04);"><b style="display:block;margin-bottom:6px">Dev log</b><div>[subscribeToTaskUpdates] subscribed</div><div>[auto-load] Wczytano dane z Firebase.</div></div></body></html>