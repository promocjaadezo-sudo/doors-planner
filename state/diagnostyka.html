<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostyka - Centralny Magazyn Stanu</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { 
      font-size: 32px; 
      margin-bottom: 8px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
    .status-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(51, 65, 85, 0.6);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .status-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-icon { font-size: 24px; }
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge.success { background: #10b981; color: white; }
    .badge.warning { background: #f59e0b; color: white; }
    .badge.error { background: #ef4444; color: white; }
    .badge.idle { background: #6b7280; color: white; }
    .badge.processing { background: #3b82f6; color: white; animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .param-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .param-item {
      background: rgba(15, 23, 42, 0.6);
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }
    .param-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .param-value {
      font-size: 18px;
      font-weight: 600;
      color: #e2e8f0;
      word-break: break-all;
    }
    .param-value.null { color: #6b7280; font-style: italic; }
    .param-value.number { color: #10b981; }
    .param-value.string { color: #3b82f6; }
    
    .history-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }
    .history-item {
      background: rgba(15, 23, 42, 0.6);
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 3px solid #06b6d4;
      font-size: 14px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .history-index {
      background: #06b6d4;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
      min-width: 30px;
      text-align: center;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    }
    
    pre {
      background: #000;
      color: #0f0;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      margin-top: 12px;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    
    .timestamp {
      font-size: 11px;
      color: #6b7280;
      margin-top: 16px;
      text-align: right;
    }
    
    .error-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      color: #fca5a5;
    }
    .error-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagnostyka Centralnego Magazynu Stanu</h1>
    <div class="subtitle">Realtime monitoring ‚Ä¢ doors-planner v5.6.27</div>

    <!-- Status og√≥lny -->
    <div class="status-card">
      <div class="status-header">
        <div class="status-title">
          <span class="status-icon">üéõÔ∏è</span>
          Status Systemu
        </div>
        <span class="badge" id="system-status">‚è≥ ≈Åadowanie...</span>
      </div>
      <div class="param-grid">
        <div class="param-item">
          <div class="param-label">Status AI</div>
          <div class="param-value" id="ai-status">-</div>
        </div>
        <div class="param-item">
          <div class="param-label">ID Aktywnej Sesji</div>
          <div class="param-value" id="session-id">-</div>
        </div>
        <div class="param-item">
          <div class="param-label">Liczba Wiadomo≈õci</div>
          <div class="param-value number" id="message-count">0</div>
        </div>
        <div class="param-item">
          <div class="param-label">Ostatni B≈ÇƒÖd</div>
          <div class="param-value" id="last-error">-</div>
        </div>
      </div>
    </div>

    <!-- Historia komunikacji -->
    <div class="status-card">
      <div class="status-header">
        <div class="status-title">
          <span class="status-icon">üí¨</span>
          Historia Komunikacji
        </div>
        <span class="badge secondary" id="history-badge">0 wiadomo≈õci</span>
      </div>
      <div class="history-list" id="history-list">
        <div class="empty-state">Brak wiadomo≈õci w historii</div>
      </div>
    </div>

    <!-- Stan JSON -->
    <div class="status-card">
      <div class="status-header">
        <div class="status-title">
          <span class="status-icon">üìä</span>
          Pe≈Çny Stan (JSON)
        </div>
      </div>
      <pre id="full-state">{ }</pre>
      <div class="action-buttons">
        <button onclick="copyToClipboard()">üìã Kopiuj JSON</button>
        <button onclick="refreshState()">üîÑ Od≈õwie≈º</button>
        <button onclick="exportState()" class="secondary">üíæ Eksportuj</button>
      </div>
    </div>

    <!-- B≈Çƒôdy -->
    <div id="error-container"></div>

    <div class="timestamp" id="timestamp">Ostatnia aktualizacja: -</div>
  </div>

  <script src="CentralnyMagazynStanu.js"></script>
  <script>
    let magazyn;
    let errors = [];

    function init() {
      try {
        magazyn = CentralnyMagazynStanu.getInstance();
        console.log('‚úÖ Magazyn zainicjalizowany:', magazyn);
        updateDisplay();
        
        // Auto-refresh co 2 sekundy
        setInterval(updateDisplay, 2000);
      } catch (error) {
        console.error('‚ùå B≈ÇƒÖd inicjalizacji:', error);
        showError('B≈ÇƒÖd inicjalizacji magazynu', error.message);
      }
    }

    function updateDisplay() {
      try {
        if (!magazyn) {
          throw new Error('Magazyn nie zosta≈Ç zainicjalizowany');
        }

        const stan = magazyn.getStan();
        
        // Status systemu
        const systemStatus = document.getElementById('system-status');
        systemStatus.className = 'badge success';
        systemStatus.textContent = '‚úì Aktywny';

        // Status AI
        const aiStatus = document.getElementById('ai-status');
        aiStatus.textContent = stan.statusAI;
        aiStatus.className = 'param-value ' + (stan.statusAI === 'idle' ? 'idle' : stan.statusAI);

        // Sesja
        const sessionId = document.getElementById('session-id');
        if (stan.aktywnaSesjaId) {
          sessionId.textContent = stan.aktywnaSesjaId;
          sessionId.className = 'param-value string';
        } else {
          sessionId.textContent = 'Brak aktywnej sesji';
          sessionId.className = 'param-value null';
        }

        // Liczba wiadomo≈õci
        document.getElementById('message-count').textContent = stan.historiaCzatu.length;

        // Ostatni b≈ÇƒÖd
        const lastError = document.getElementById('last-error');
        if (stan.ostatniBlad) {
          lastError.textContent = stan.ostatniBlad;
          lastError.className = 'param-value';
          lastError.style.color = '#ef4444';
        } else {
          lastError.textContent = 'Brak b≈Çƒôd√≥w';
          lastError.className = 'param-value null';
        }

        // Historia
        const historyList = document.getElementById('history-list');
        const historyBadge = document.getElementById('history-badge');
        
        if (stan.historiaCzatu.length === 0) {
          historyList.innerHTML = '<div class="empty-state">Brak wiadomo≈õci w historii</div>';
          historyBadge.textContent = '0 wiadomo≈õci';
        } else {
          historyBadge.textContent = `${stan.historiaCzatu.length} wiadomo≈õci`;
          historyList.innerHTML = stan.historiaCzatu.map((msg, index) => {
            // Obs≈Çuga nowej struktury { tekst, timestamp }
            const tekst = typeof msg === 'object' && msg.tekst ? msg.tekst : msg;
            const timestamp = typeof msg === 'object' && msg.timestamp 
              ? `<small style="color: #94a3b8; margin-left: 8px;">${new Date(msg.timestamp).toLocaleString('pl-PL')}</small>` 
              : '';
            
            return `
              <div class="history-item">
                <span class="history-index">${index + 1}</span>
                <span>${tekst}${timestamp}</span>
              </div>
            `;
          }).join('');
        }

        // Pe≈Çny stan JSON
        document.getElementById('full-state').textContent = JSON.stringify(stan, null, 2);

        // Timestamp
        document.getElementById('timestamp').textContent = 
          `Ostatnia aktualizacja: ${new Date().toLocaleString('pl-PL')}`;

        // Wyczy≈õƒá b≈Çƒôdy je≈õli wszystko OK
        if (errors.length > 0 && stan.statusAI !== 'error') {
          document.getElementById('error-container').innerHTML = '';
          errors = [];
        }

      } catch (error) {
        console.error('‚ùå B≈ÇƒÖd aktualizacji widoku:', error);
        showError('B≈ÇƒÖd aktualizacji widoku', error.message);
      }
    }

    function showError(title, message) {
      errors.push({ title, message, time: new Date() });
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = `
        <div class="status-card">
          <div class="error-box">
            <div class="error-title">‚ö†Ô∏è ${title}</div>
            <div>${message}</div>
            <div style="font-size: 11px; margin-top: 8px; opacity: 0.7;">
              ${new Date().toLocaleString('pl-PL')}
            </div>
          </div>
        </div>
      `;
      
      const systemStatus = document.getElementById('system-status');
      systemStatus.className = 'badge error';
      systemStatus.textContent = '‚úï B≈ÇƒÖd';
    }

    function refreshState() {
      console.log('üîÑ Od≈õwie≈ºam stan...');
      updateDisplay();
    }

    function copyToClipboard() {
      const json = document.getElementById('full-state').textContent;
      navigator.clipboard.writeText(json).then(() => {
        alert('‚úÖ JSON skopiowany do schowka!');
      }).catch(err => {
        console.error('B≈ÇƒÖd kopiowania:', err);
        alert('‚ùå B≈ÇƒÖd kopiowania do schowka');
      });
    }

    function exportState() {
      if (!magazyn) return;
      const json = magazyn.exportujDoJSON();
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `magazyn-stanu-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      console.log('‚úÖ Stan wyeksportowany do pliku');
    }

    // Inicjalizacja
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
